---
layout: post
title: "Javaé”"
date: 2020-12-04 22:41:16 +0800--
categories: [Java, å¹¶å‘ç¼–ç¨‹, ]
tags: [Java, JUC, é”, ]  

---

# Javaé”ä¹‹å…¬å¹³é”å’Œéå…¬å¹³é”

## æ¦‚å¿µ

### å…¬å¹³é”

æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”ï¼Œç±»ä¼¼äºæ’é˜Ÿä¹°é¥­ï¼Œå…ˆæ¥ååˆ°ï¼Œå…ˆæ¥å…ˆæœåŠ¡ï¼Œå°±æ˜¯å…¬å¹³çš„ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—

### éå…¬å¹³é”

æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹è·å–é”çš„é¡ºåºï¼Œå¹¶ä¸æ˜¯æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºï¼Œæœ‰å¯èƒ½ç”³è¯·çš„çº¿ç¨‹æ¯”å…ˆç”³è¯·çš„çº¿ç¨‹ä¼˜å…ˆè·å–é”ï¼Œåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œæœ‰å¯èƒ½é€ æˆä¼˜å…ˆçº§ç¿»è½¬ï¼Œæˆ–è€…é¥¥é¥¿çš„çº¿ç¨‹ï¼ˆä¹Ÿå°±æ˜¯æŸä¸ªçº¿ç¨‹ä¸€ç›´å¾—ä¸åˆ°é”ï¼‰

## å¦‚ä½•åˆ›å»º

å¹¶å‘åŒ…ä¸­ReentrantLockçš„åˆ›å»ºå¯ä»¥æŒ‡å®šææ„å‡½æ•°çš„booleanç±»å‹æ¥å¾—åˆ°å…¬å¹³é”æˆ–è€…éå…¬å¹³é”ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”

```
/**
* åˆ›å»ºä¸€ä¸ªå¯é‡å…¥é”ï¼Œtrue è¡¨ç¤ºå…¬å¹³é”ï¼Œfalse è¡¨ç¤ºéå…¬å¹³é”ã€‚é»˜è®¤éå…¬å¹³é”
*/
Lock lock = new ReentrantLock(true);
```

## ä¸¤è€…åŒºåˆ«

**å…¬å¹³é”**ï¼šå°±æ˜¯å¾ˆå…¬å¹³ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨è·å–é”æ—¶ä¼šå…ˆæŸ¥çœ‹æ­¤é”ç»´æŠ¤çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœä¸ºç©ºï¼Œæˆ–è€…å½“å‰çº¿ç¨‹æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªï¼Œå°±å ç”¨é”ï¼Œå¦è€…å°±ä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œä»¥åå®‰è£…FIFOçš„è§„åˆ™ä»é˜Ÿåˆ—ä¸­å–åˆ°è‡ªå·±

**éå…¬å¹³é”ï¼š** éå…¬å¹³é”æ¯”è¾ƒç²—é²ï¼Œä¸Šæ¥å°±ç›´æ¥å°è¯•å æœ‰é”ï¼Œå¦‚æœå°è¯•å¤±è´¥ï¼Œå°±å†é‡‡ç”¨ç±»ä¼¼å…¬å¹³é”é‚£ç§æ–¹å¼ã€‚

é¢˜å¤–è¯ï¼š

Java ReenttrantLocké€šè¿‡æ„é€ å‡½æ•°æŒ‡å®šè¯¥é”æ˜¯å¦å…¬å¹³ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œ**å› ä¸ºéå…¬å¹³é”çš„ä¼˜ç‚¹åœ¨äºååé‡æ¯”å…¬å¹³é”**å¤§ï¼Œ`å¯¹äºsynchronizedè€Œè¨€ï¼Œä¹Ÿæ˜¯ä¸€ç§éå…¬å¹³é”`



# å¯é‡å…¥é”å’Œé€’å½’é”ReentrantLock

## æ¦‚å¿µ

å¯é‡å…¥é”å°±æ˜¯é€’å½’é”

æŒ‡çš„æ˜¯åŒä¸€çº¿ç¨‹å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹åï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶èƒ½è·å–åˆ°è¯¥é”çš„ä»£ç ï¼Œåœ¨åŒä¸€çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”

ä¹Ÿå°±æ˜¯è¯´ï¼š`çº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥çš„ä»£ç å—`

ReentrantLock / Synchronized å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å¯é‡å…¥é”

## ä»£ç 

å¯é‡å…¥é”å°±æ˜¯ï¼Œåœ¨ä¸€ä¸ªmethod1æ–¹æ³•ä¸­åŠ å…¥ä¸€æŠŠé”ï¼Œæ–¹æ³•2ä¹ŸåŠ é”äº†ï¼Œ**é‚£ä¹ˆä»–ä»¬æ‹¥æœ‰çš„æ˜¯åŒä¸€æŠŠé”**

```java
public synchronized void method1() {
	method2();
}

public synchronized void method2() {

}
```

ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªéœ€è¦è¿›å…¥method1åï¼Œé‚£ä¹ˆå®ƒä¹Ÿèƒ½ç›´æ¥è¿›å…¥method2æ–¹æ³•ï¼Œå› ä¸ºä»–ä»¬æ‰€æ‹¥æœ‰çš„é”ï¼Œæ˜¯åŒä¸€æŠŠã€‚

## ä½œç”¨

**å¯é‡å…¥é”çš„æœ€å¤§ä½œç”¨å°±æ˜¯é¿å…æ­»é”**

## å¯é‡å…¥é”éªŒè¯

### è¯æ˜Synchronized

```java
/**
 * å¯é‡å…¥é”ï¼ˆä¹Ÿå«é€’å½’é”ï¼‰
 * æŒ‡çš„æ˜¯åŒä¸€çº¿ç¨‹å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹åï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶èƒ½è·å–åˆ°è¯¥é”çš„ä»£ç ï¼Œåœ¨åŒä¸€çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”
 *
 * ä¹Ÿå°±æ˜¯è¯´ï¼š`çº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥çš„ä»£ç å—`
 */

/**
 * èµ„æºç±»
 */
class Phone {

    /**
     * å‘é€çŸ­ä¿¡
     * @throws Exception
     */
    public synchronized void sendSMS() throws Exception{
        System.out.println(Thread.currentThread().getName() + "\t invoked sendSMS()");

        // åœ¨åŒæ­¥æ–¹æ³•ä¸­ï¼Œè°ƒç”¨å¦å¤–ä¸€ä¸ªåŒæ­¥æ–¹æ³•
        sendEmail();
    }

    /**
     * å‘é‚®ä»¶
     * @throws Exception
     */
    public synchronized void sendEmail() throws Exception{
        System.out.println(Thread.currentThread().getId() + "\t invoked sendEmail()");
    }
}
public class ReenterLockDemo {


    public static void main(String[] args) {
        Phone phone = new Phone();

        // ä¸¤ä¸ªçº¿ç¨‹æ“ä½œèµ„æºåˆ—
        new Thread(() -> {
            try {
                phone.sendSMS();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }, "t1").start();

        new Thread(() -> {
            try {
                phone.sendSMS();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }, "t2").start();
    }
}
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªèµ„æºç±»phoneï¼Œæ‹¥æœ‰ä¸¤ä¸ªåŠ äº†synchronizedçš„åŒæ­¥æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯sendSMS å’Œ sendEmailï¼Œæˆ‘ä»¬åœ¨sendSMSæ–¹æ³•ä¸­ï¼Œè°ƒç”¨sendEmailã€‚æœ€ååœ¨ä¸»çº¿ç¨‹åŒæ—¶å¼€å¯äº†ä¸¤ä¸ªçº¿ç¨‹è¿›è¡Œæµ‹è¯•ï¼Œæœ€åå¾—åˆ°çš„ç»“æœä¸ºï¼š

```java
t1	 invoked sendSMS()
t1	 invoked sendEmail()
t2	 invoked sendSMS()
t2	 invoked sendEmail()
```

**è¿™å°±è¯´æ˜å½“ t1 çº¿ç¨‹è¿›å…¥sendSMSçš„æ—¶å€™ï¼Œæ‹¥æœ‰äº†ä¸€æŠŠé”ï¼ŒåŒæ—¶t2çº¿ç¨‹æ— æ³•è¿›å…¥ï¼Œç›´åˆ°t1çº¿ç¨‹æ‹¿ç€é”ï¼Œæ‰§è¡Œäº†sendEmail æ–¹æ³•åï¼Œæ‰é‡Šæ”¾é”ï¼Œè¿™æ ·t2æ‰èƒ½å¤Ÿè¿›å…¥**

```java
t1	 invoked sendSMS()      t1çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™
t1	 invoked sendEmail()    t1åœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”

t2	 invoked sendSMS()      t2çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™
t2	 invoked sendEmail()    t2åœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”
```

### è¯æ˜ReentrantLock

```java
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

/**
 * èµ„æºç±»
 */
class Phone implements Runnable{

    Lock lock = new ReentrantLock();

    /**
     * setè¿›å»çš„æ—¶å€™ï¼Œå°±åŠ é”ï¼Œè°ƒç”¨setæ–¹æ³•çš„æ—¶å€™ï¼Œèƒ½å¦è®¿é—®å¦å¤–ä¸€ä¸ªåŠ é”çš„setæ–¹æ³•
     */
    public void getLock() {
        lock.lock();
        try {
            System.out.println(Thread.currentThread().getName() + "\t get Lock");
            setLock();
        } finally {
            lock.unlock();
        }
    }

    public void setLock() {
        lock.lock();
        try {
            System.out.println(Thread.currentThread().getName() + "\t set Lock");
        } finally {
            lock.unlock();
        }
    }

    @Override
    public void run() {
        getLock();
    }
}

public class ReenterLockDemo {


    public static void main(String[] args) {
        Phone phone = new Phone();

        /**
         * å› ä¸ºPhoneå®ç°äº†Runnableæ¥å£
         */
        Thread t3 = new Thread(phone, "t3");
        Thread t4 = new Thread(phone, "t4");
        t3.start();
        t4.start();
    }
}

```

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ReentrantLockè¿›è¡ŒéªŒè¯ï¼Œé¦–å…ˆèµ„æºç±»å®ç°äº†Runnableæ¥å£ï¼Œé‡å†™Runæ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨getæ–¹æ³•ï¼Œgetæ–¹æ³•åœ¨è¿›å…¥çš„æ—¶å€™ï¼Œå°±åŠ äº†é”

```java
public void getLock() {
  lock.lock();
  try {
    System.out.println(Thread.currentThread().getName() + "\t get Lock");
    setLock();
  } finally {
    lock.unlock();
  }
}
```

ç„¶ååœ¨æ–¹æ³•é‡Œé¢ï¼Œåˆè°ƒç”¨å¦å¤–ä¸€ä¸ªåŠ äº†é”çš„setLockæ–¹æ³•

```java
public void setLock() {
  lock.lock();
  try {
    System.out.println(Thread.currentThread().getName() + "\t set Lock");
  } finally {
    lock.unlock();
  }
}
```

**æœ€åè¾“å‡ºç»“æœæˆ‘ä»¬èƒ½å‘ç°ï¼Œç»“æœå’ŒåŠ synchronizedæ–¹æ³•æ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ˜¯åœ¨å¤–å±‚çš„æ–¹æ³•è·å–é”ä¹‹åï¼Œçº¿ç¨‹èƒ½å¤Ÿç›´æ¥è¿›å…¥é‡Œå±‚**

```java
t3	 get Lock
t3	 set Lock
t4	 get Lock
t4	 set Lock
```

ğŸ¤” **å½“æˆ‘ä»¬åœ¨getLockæ–¹æ³•åŠ ä¸¤æŠŠé”ä¼šæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ**  (é˜¿é‡Œé¢è¯•)

æœ€åå¾—åˆ°çš„ç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºé‡Œé¢ä¸ç®¡æœ‰å‡ æŠŠé”ï¼Œå…¶å®ƒä»–ä»¬éƒ½æ˜¯åŒä¸€æŠŠé”ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨åŒä¸€ä¸ªé’¥åŒ™éƒ½èƒ½å¤Ÿæ‰“å¼€

```java
    public void getLock() {
        lock.lock();
        lock.lock();
        try {
            System.out.println(Thread.currentThread().getName() + "\t get Lock");
            setLock();
        } finally {
            lock.unlock();
            lock.unlock();
        }
    }
```

**å½“æˆ‘ä»¬åœ¨getLockæ–¹æ³•åŠ ä¸¤æŠŠé”ï¼Œä½†æ˜¯åªè§£ä¸€æŠŠé”ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ**

```java
public void getLock() {
    lock.lock();
    lock.lock();
    try {
        System.out.println(Thread.currentThread().getName() + "\t get Lock");
        setLock();
    } finally {
        lock.unlock();
    }
}
```

å¾—åˆ°ç»“æœï¼šä¹Ÿå°±æ˜¯è¯´ç¨‹åºç›´æ¥å¡æ­»ï¼Œçº¿ç¨‹ä¸èƒ½å‡ºæ¥ï¼Œä¹Ÿå°±è¯´æ˜æˆ‘ä»¬ç”³è¯·å‡ æŠŠé”ï¼Œæœ€åéœ€è¦è§£é™¤å‡ æŠŠé”

```java
t3	 get Lock
t3	 set Lock
```

**å½“æˆ‘ä»¬åªåŠ ä¸€æŠŠé”ï¼Œä½†æ˜¯ç”¨ä¸¤æŠŠé”æ¥è§£é”çš„æ—¶å€™ï¼Œåˆä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ**

```java
public void getLock() {
  lock.lock();
  try {
    System.out.println(Thread.currentThread().getName() + "\t get Lock");
    setLock();
  } finally {
    lock.unlock();
    lock.unlock();
  }
}
```

***è¿™ä¸ªæ—¶å€™ï¼Œè¿è¡Œç¨‹åºä¼šç›´æ¥æŠ¥é”™***

```java
t3	 get Lock
t3	 set Lock
t4	 get Lock
t4	 set Lock
Exception in thread "t3" Exception in thread "t4" java.lang.IllegalMonitorStateException
	at java.util.concurrent.locks.ReentrantLock$Sync.tryRelease(ReentrantLock.java:151)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.release(AbstractQueuedSynchronizer.java:1261)
	at java.util.concurrent.locks.ReentrantLock.unlock(ReentrantLock.java:457)
	at com.moxi.interview.study.thread.Phone.getLock(ReenterLockDemo.java:52)
	at com.moxi.interview.study.thread.Phone.run(ReenterLockDemo.java:67)
	at java.lang.Thread.run(Thread.java:745)
java.lang.IllegalMonitorStateException
	at java.util.concurrent.locks.ReentrantLock$Sync.tryRelease(ReentrantLock.java:151)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.release(AbstractQueuedSynchronizer.java:1261)
	at java.util.concurrent.locks.ReentrantLock.unlock(ReentrantLock.java:457)
	at com.moxi.interview.study.thread.Phone.getLock(ReenterLockDemo.java:52)
	at com.moxi.interview.study.thread.Phone.run(ReenterLockDemo.java:67)
	at java.lang.Thread.run(Thread.java:745)
```

# Javaé”ä¹‹è‡ªæ—‹é”

è‡ªæ—‹é”ï¼šspinlockï¼Œæ˜¯æŒ‡å°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPU

åŸæ¥æåˆ°çš„æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œåº•å±‚ä½¿ç”¨çš„å°±æ˜¯è‡ªæ—‹ï¼Œè‡ªæ—‹å°±æ˜¯å¤šæ¬¡å°è¯•ï¼Œå¤šæ¬¡è®¿é—®ï¼Œä¸ä¼šé˜»å¡çš„çŠ¶æ€å°±æ˜¯è‡ªæ—‹ã€‚

![image-20200315154143781](/Users/silince/Pictures/Typora/image-20200315154143781.png)

## ä¼˜ç¼ºç‚¹

ä¼˜ç‚¹ï¼šå¾ªç¯æ¯”è¾ƒè·å–ç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼Œæ²¡æœ‰ç±»ä¼¼äºwaitçš„é˜»å¡

ç¼ºç‚¹ï¼šå½“ä¸æ–­è‡ªæ—‹çš„çº¿ç¨‹è¶Šæ¥è¶Šå¤šçš„æ—¶å€™ï¼Œä¼šå› ä¸ºæ‰§è¡Œwhileå¾ªç¯ä¸æ–­çš„æ¶ˆè€—CPUèµ„æº

## æ‰‹å†™è‡ªæ—‹é”

é€šè¿‡CASæ“ä½œå®Œæˆè‡ªæ—‹é”ï¼ŒAçº¿ç¨‹å…ˆè¿›æ¥è°ƒç”¨myLockæ–¹æ³•è‡ªå·±æŒæœ‰é”5ç§’ï¼ŒBéšåè¿›æ¥å‘ç°å½“å‰æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œä¸æ˜¯nullï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ°Aé‡Šæ”¾é”åBéšåæŠ¢åˆ°

```java
/**
 * æ‰‹å†™ä¸€ä¸ªè‡ªæ—‹é”
 *
 * å¾ªç¯æ¯”è¾ƒè·å–ç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼Œæ²¡æœ‰ç±»ä¼¼äºwaitçš„é˜»å¡
 *
 * é€šè¿‡CASæ“ä½œå®Œæˆè‡ªæ—‹é”ï¼ŒAçº¿ç¨‹å…ˆè¿›æ¥è°ƒç”¨myLockæ–¹æ³•è‡ªå·±æŒæœ‰é”5ç§’ï¼ŒBéšåè¿›æ¥å‘ç°å½“å‰æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œä¸æ˜¯nullï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ°Aé‡Šæ”¾é”åBéšåæŠ¢åˆ°
 */
public class SpinLockDemo {

    // ç°åœ¨çš„æ³›å‹è£…çš„æ˜¯Threadï¼ŒåŸå­å¼•ç”¨çº¿ç¨‹
    AtomicReference<Thread>  atomicReference = new AtomicReference<>();

    public void myLock() {
        // è·å–å½“å‰è¿›æ¥çš„çº¿ç¨‹
        Thread thread = Thread.currentThread();
        System.out.println(Thread.currentThread().getName() + "\t come in ");

        // å¼€å§‹è‡ªæ—‹ï¼ŒæœŸæœ›å€¼æ˜¯nullï¼Œæ›´æ–°å€¼æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™æ›´æ–°ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦è€…è‡ªæ—‹
        while(!atomicReference.compareAndSet(null, thread)) {

        }
    }

    /**
     * è§£é”
     */
    public void myUnLock() {

        // è·å–å½“å‰è¿›æ¥çš„çº¿ç¨‹
        Thread thread = Thread.currentThread();

        // è‡ªå·±ç”¨å®Œäº†åï¼ŒæŠŠatomicReferenceå˜æˆnull
        atomicReference.compareAndSet(thread, null);

        System.out.println(Thread.currentThread().getName() + "\t invoked myUnlock()");
    }

    public static void main(String[] args) {

        SpinLockDemo spinLockDemo = new SpinLockDemo();

        // å¯åŠ¨t1çº¿ç¨‹ï¼Œå¼€å§‹æ“ä½œ
        new Thread(() -> {

            // å¼€å§‹å æœ‰é”
            spinLockDemo.myLock();


            try {
                TimeUnit.SECONDS.sleep(5);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

            // å¼€å§‹é‡Šæ”¾é”
            spinLockDemo.myUnLock();

        }, "t1").start();


        // è®©mainçº¿ç¨‹æš‚åœ1ç§’ï¼Œä½¿å¾—t1çº¿ç¨‹ï¼Œå…ˆæ‰§è¡Œ
        try {
            TimeUnit.SECONDS.sleep(5);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        // 1ç§’åï¼Œå¯åŠ¨t2çº¿ç¨‹ï¼Œå¼€å§‹å ç”¨è¿™ä¸ªé”
        new Thread(() -> {

            // å¼€å§‹å æœ‰é”
            spinLockDemo.myLock();
            // å¼€å§‹é‡Šæ”¾é”
            spinLockDemo.myUnLock();

        }, "t2").start();

    }
}
```

æœ€åè¾“å‡ºç»“æœ

```java
t1	 come in 
.....äº”ç§’å.....
t1	 invoked myUnlock()
t2	 come in 
t2	 invoked myUnlock()
```

é¦–å…ˆè¾“å‡ºçš„æ˜¯ t1	 come in 

ç„¶å1ç§’åï¼Œt2çº¿ç¨‹å¯åŠ¨ï¼Œå‘ç°é”è¢«t1å æœ‰ï¼Œæ‰€æœ‰ä¸æ–­çš„æ‰§è¡Œ compareAndSetæ–¹æ³•ï¼Œæ¥è¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ°t1é‡Šæ”¾é”åï¼Œä¹Ÿå°±æ˜¯5ç§’åï¼Œt2æˆåŠŸè·å–åˆ°é”ï¼Œç„¶åé‡Šæ”¾



# ç‹¬å é”ï¼ˆå†™é”ï¼‰ / å…±äº«é”ï¼ˆè¯»é”ï¼‰ / äº’æ–¥é”

## æ¦‚å¿µ

ç‹¬å é”ï¼šæŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚å¯¹ReentrantLockå’ŒSynchronizedè€Œè¨€éƒ½æ˜¯ç‹¬å é”

å…±äº«é”ï¼šæŒ‡è¯¥é”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹é”æŒæœ‰

å¯¹ReentrantReadWriteLockå…¶è¯»é”æ˜¯å…±äº«ï¼Œå…¶å†™é”æ˜¯ç‹¬å 

å†™çš„æ—¶å€™åªèƒ½ä¸€ä¸ªäººå†™ï¼Œä½†æ˜¯è¯»çš„æ—¶å€™ï¼Œå¯ä»¥å¤šä¸ªäººåŒæ—¶è¯»

## ä¸ºä»€ä¹ˆä¼šæœ‰å†™é”å’Œè¯»é”

åŸæ¥æˆ‘ä»¬ä½¿ç”¨ReentrantLockåˆ›å»ºé”çš„æ—¶å€™ï¼Œæ˜¯ç‹¬å é”ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªè¯»å†™åˆ†ç¦»åœºæ™¯ï¼Œè¯»çš„æ—¶å€™æƒ³åŒæ—¶è¿›è¡Œï¼Œå› æ­¤åŸæ¥ç‹¬å é”çš„å¹¶å‘æ€§å°±æ²¡è¿™ä¹ˆå¥½äº†ï¼Œå› ä¸ºè¯»é”å¹¶ä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå› æ­¤å¯ä»¥å¤šä¸ªäººå…±äº«è¯»

**å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥ä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥å¯ä»¥åŒæ—¶è¿›è¡Œï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™**

è¯»-è¯»ï¼šèƒ½å…±å­˜

è¯»-å†™ï¼šä¸èƒ½å…±å­˜

å†™-å†™ï¼šä¸èƒ½å…±å­˜

## ä»£ç å®ç°

å®ç°ä¸€ä¸ªè¯»å†™ç¼“å­˜çš„æ“ä½œï¼Œå‡è®¾å¼€å§‹æ²¡æœ‰åŠ é”çš„æ—¶å€™ï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µ

```java
/**
 * è¯»å†™é”
 * å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥ä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥å¯ä»¥åŒæ—¶è¿›è¡Œ
 * ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™
 */

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Lock;

/**
 * èµ„æºç±»
 */
class MyCache {

    private volatile Map<String, Object> map = new HashMap<>();
    // private Lock lock = null;

    /**
     * å®šä¹‰å†™æ“ä½œ
     * æ»¡è¶³ï¼šåŸå­ + ç‹¬å 
     * @param key
     * @param value
     */
    public void put(String key, Object value) {
        System.out.println(Thread.currentThread().getName() + "\t æ­£åœ¨å†™å…¥ï¼š" + key);
        try {
            // æ¨¡æ‹Ÿç½‘ç»œæ‹¥å µï¼Œå»¶è¿Ÿ0.3ç§’
            TimeUnit.MILLISECONDS.sleep(300);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        map.put(key, value);
        System.out.println(Thread.currentThread().getName() + "\t å†™å…¥å®Œæˆ");
    }

    public void get(String key) {
        System.out.println(Thread.currentThread().getName() + "\t æ­£åœ¨è¯»å–:");
        try {
            // æ¨¡æ‹Ÿç½‘ç»œæ‹¥å µï¼Œå»¶è¿Ÿ0.3ç§’
            TimeUnit.MILLISECONDS.sleep(300);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        Object value = map.get(key);
        System.out.println(Thread.currentThread().getName() + "\t è¯»å–å®Œæˆï¼š" + value);
    }


}
public class ReadWriteLockDemo {

    public static void main(String[] args) {

        MyCache myCache = new MyCache();
        // çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ5ä¸ªçº¿ç¨‹å†™
        for (int i = 0; i < 5; i++) {
            // lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final
            final int tempInt = i;
            new Thread(() -> {
                myCache.put(tempInt + "", tempInt +  "");
            }, String.valueOf(i)).start();
        }
        // çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ 5ä¸ªçº¿ç¨‹è¯»
        for (int i = 0; i < 5; i++) {
            // lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final
            final int tempInt = i;
            new Thread(() -> {
                myCache.get(tempInt + "");
            }, String.valueOf(i)).start();
        }
    }
}
```

æˆ‘ä»¬åˆ†åˆ«åˆ›å»º5ä¸ªçº¿ç¨‹å†™å…¥ç¼“å­˜

```java
// çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ5ä¸ªçº¿ç¨‹å†™
for (int i = 0; i < 5; i++) {
  // lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final
  final int tempInt = i;
  new Thread(() -> {
    myCache.put(tempInt + "", tempInt +  "");
  }, String.valueOf(i)).start();
}
```

5ä¸ªçº¿ç¨‹è¯»å–ç¼“å­˜ï¼Œ

```java
// çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ 5ä¸ªçº¿ç¨‹è¯»
for (int i = 0; i < 5; i++) {
  // lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final
  final int tempInt = i;
  new Thread(() -> {
    myCache.get(tempInt + "");
  }, String.valueOf(i)).start();
}
```

æœ€åè¿è¡Œç»“æœï¼š

```java
0	 æ­£åœ¨å†™å…¥ï¼š0
4	 æ­£åœ¨å†™å…¥ï¼š4
3	 æ­£åœ¨å†™å…¥ï¼š3
1	 æ­£åœ¨å†™å…¥ï¼š1
2	 æ­£åœ¨å†™å…¥ï¼š2
0	 æ­£åœ¨è¯»å–:
1	 æ­£åœ¨è¯»å–:
2	 æ­£åœ¨è¯»å–:
3	 æ­£åœ¨è¯»å–:
4	 æ­£åœ¨è¯»å–:
2	 å†™å…¥å®Œæˆ
4	 å†™å…¥å®Œæˆ
4	 è¯»å–å®Œæˆï¼šnull
0	 å†™å…¥å®Œæˆ
3	 è¯»å–å®Œæˆï¼šnull
0	 è¯»å–å®Œæˆï¼šnull
1	 å†™å…¥å®Œæˆ
3	 å†™å…¥å®Œæˆ
1	 è¯»å–å®Œæˆï¼šnull
2	 è¯»å–å®Œæˆï¼šnull
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å†™å…¥çš„æ—¶å€™ï¼Œå†™æ“ä½œéƒ½æ²¡å…¶å®ƒçº¿ç¨‹æ‰“æ–­äº†ï¼Œè¿™å°±é€ æˆäº†ï¼Œè¿˜æ²¡å†™å®Œï¼Œå…¶å®ƒçº¿ç¨‹åˆå¼€å§‹å†™ï¼Œè¿™æ ·å°±é€ æˆæ•°æ®ä¸ä¸€è‡´

## è§£å†³æ–¹æ³•

**ä¸Šé¢çš„ä»£ç æ˜¯æ²¡æœ‰åŠ é”çš„ï¼Œè¿™æ ·å°±ä¼šé€ æˆçº¿ç¨‹åœ¨è¿›è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼Œè¢«å…¶å®ƒçº¿ç¨‹é¢‘ç¹æ‰“æ–­ï¼Œä»è€Œä¸å…·å¤‡åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°è¯»å†™é”æ¥è§£å†³äº†**

```java
/**
* åˆ›å»ºä¸€ä¸ªè¯»å†™é”
* å®ƒæ˜¯ä¸€ä¸ªè¯»å†™èä¸ºä¸€ä½“çš„é”ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦è½¬æ¢
*/
private ReentrantReadWriteLock rwLock = new ReentrantReadWriteLock();
```

å½“æˆ‘ä»¬åœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œå°±éœ€è¦è½¬æ¢æˆå†™é”

```java
// åˆ›å»ºä¸€ä¸ªå†™é”
rwLock.writeLock().lock();

// å†™é” é‡Šæ”¾
rwLock.writeLock().unlock();
```

å½“ä»¬åœ¨è¿›è¡Œè¯»æ“ä½œçš„æ—¶å€™ï¼Œåœ¨è½¬æ¢æˆè¯»é”

```java
// åˆ›å»ºä¸€ä¸ªè¯»é”
rwLock.readLock().lock();

// è¯»é” é‡Šæ”¾
rwLock.readLock().unlock();
```

è¿™é‡Œçš„è¯»é”å’Œå†™é”çš„åŒºåˆ«åœ¨äºï¼Œå†™é”ä¸€æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œæ‰§è¡Œå†™æ“ä½œï¼Œè€Œè¯»é”æ˜¯å¤šä¸ªçº¿ç¨‹èƒ½å¤ŸåŒæ—¶è¿›å…¥ï¼Œè¿›è¡Œè¯»å–çš„æ“ä½œ

å®Œæ•´ä»£ç ï¼š

```java
/**
 * è¯»å†™é”
 * å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥ä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥å¯ä»¥åŒæ—¶è¿›è¡Œ
 * ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™
 */

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.concurrent.locks.ReentrantReadWriteLock;

/**
 * èµ„æºç±»
 */
class MyCache {

    /**
     * ç¼“å­˜ä¸­çš„ä¸œè¥¿ï¼Œå¿…é¡»ä¿æŒå¯è§æ€§ï¼Œå› æ­¤ä½¿ç”¨volatileä¿®é¥°
     */
    private volatile Map<String, Object> map = new HashMap<>();

    /**
     * åˆ›å»ºä¸€ä¸ªè¯»å†™é”
     * å®ƒæ˜¯ä¸€ä¸ªè¯»å†™èä¸ºä¸€ä½“çš„é”ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦è½¬æ¢
     */
    private ReentrantReadWriteLock rwLock = new ReentrantReadWriteLock();

    /**
     * å®šä¹‰å†™æ“ä½œ
     * æ»¡è¶³ï¼šåŸå­ + ç‹¬å 
     * @param key
     * @param value
     */
    public void put(String key, Object value) {

        // åˆ›å»ºä¸€ä¸ªå†™é”
        rwLock.writeLock().lock();

        try {

            System.out.println(Thread.currentThread().getName() + "\t æ­£åœ¨å†™å…¥ï¼š" + key);

            try {
                // æ¨¡æ‹Ÿç½‘ç»œæ‹¥å µï¼Œå»¶è¿Ÿ0.3ç§’
                TimeUnit.MILLISECONDS.sleep(300);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

            map.put(key, value);

            System.out.println(Thread.currentThread().getName() + "\t å†™å…¥å®Œæˆ");

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // å†™é” é‡Šæ”¾
            rwLock.writeLock().unlock();
        }
    }

    /**
     * è·å–
     * @param key
     */
    public void get(String key) {

        // è¯»é”
        rwLock.readLock().lock();
        try {

            System.out.println(Thread.currentThread().getName() + "\t æ­£åœ¨è¯»å–:");

            try {
                // æ¨¡æ‹Ÿç½‘ç»œæ‹¥å µï¼Œå»¶è¿Ÿ0.3ç§’
                TimeUnit.MILLISECONDS.sleep(300);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

            Object value = map.get(key);

            System.out.println(Thread.currentThread().getName() + "\t è¯»å–å®Œæˆï¼š" + value);

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // è¯»é”é‡Šæ”¾
            rwLock.readLock().unlock();
        }
    }

    /**
     * æ¸…ç©ºç¼“å­˜
     */
    public void clean() {
        map.clear();
    }


}
public class ReadWriteLockDemo {

    public static void main(String[] args) {

        MyCache myCache = new MyCache();

        // çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ5ä¸ªçº¿ç¨‹å†™
        for (int i = 1; i <= 5; i++) {
            // lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final
            final int tempInt = i;
            new Thread(() -> {
                myCache.put(tempInt + "", tempInt +  "");
            }, String.valueOf(i)).start();
        }

        // çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œ 5ä¸ªçº¿ç¨‹è¯»
        for (int i = 1; i <= 5; i++) {
            // lambdaè¡¨è¾¾å¼å†…éƒ¨å¿…é¡»æ˜¯final
            final int tempInt = i;
            new Thread(() -> {
                myCache.get(tempInt + "");
            }, String.valueOf(i)).start();
        }
    }
}
```

è¿è¡Œç»“æœï¼š

ä»è¿è¡Œç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå†™å…¥æ“ä½œæ˜¯ä¸€ä¸ªä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ‰§è¡Œçš„ï¼Œå¹¶ä¸”ä¸­é—´ä¸ä¼šè¢«æ‰“æ–­ï¼Œè€Œè¯»æ“ä½œçš„æ—¶å€™ï¼Œæ˜¯åŒæ—¶5ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œç„¶åå¹¶å‘è¯»å–æ“ä½œ

```java
1	 æ­£åœ¨å†™å…¥ï¼š1
1	 å†™å…¥å®Œæˆ
2	 æ­£åœ¨å†™å…¥ï¼š2
2	 å†™å…¥å®Œæˆ
3	 æ­£åœ¨å†™å…¥ï¼š3
3	 å†™å…¥å®Œæˆ
4	 æ­£åœ¨å†™å…¥ï¼š4
4	 å†™å…¥å®Œæˆ
5	 æ­£åœ¨å†™å…¥ï¼š5
5	 å†™å…¥å®Œæˆ
2	 æ­£åœ¨è¯»å–:
3	 æ­£åœ¨è¯»å–:
1	 æ­£åœ¨è¯»å–:
4	 æ­£åœ¨è¯»å–:
5	 æ­£åœ¨è¯»å–:
2	 è¯»å–å®Œæˆï¼š2
1	 è¯»å–å®Œæˆï¼š1
4	 è¯»å–å®Œæˆï¼š4
3	 è¯»å–å®Œæˆï¼š3
5	 è¯»å–å®Œæˆï¼š5
```

