---
scrolllayout: post
title:  "Javaé«˜å¹¶å‘ç¼–ç¨‹"
date:   2020-08-26 11:02:06 +0800--
categories: [Java]
tags: [é«˜å¹¶å‘,JUC ]  
---

# Javaé«˜å¹¶å‘ç¼–ç¨‹

## JUCæ˜¯ä»€ä¹ˆ

java.util.concurrent åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ä½¿ç”¨çš„å·¥å…·ç±»

## è¿›ç¨‹ä¸çº¿ç¨‹

**è¿›ç¨‹**

- ç¨‹åºç”±**æŒ‡ä»¤å’Œæ•°æ®**ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»**å°†æŒ‡ä»¤åŠ è½½è‡³ CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜**ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡ã€‚**è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ã€ç®¡ç†å†…å­˜ã€ç®¡ç† IO çš„**ã€‚
- å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œ**ä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹**ã€‚
  **è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹**ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚è®°äº‹æœ¬ã€ç”»å›¾ã€æµè§ˆå™¨ç­‰ï¼‰ï¼Œä¹Ÿæœ‰çš„ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚ç½‘æ˜“äº‘éŸ³ä¹ã€360 å®‰å…¨å«å£«ç­‰ï¼‰ã€‚

**çº¿ç¨‹**

- é€šå¸¸åœ¨**ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åŒ…å«è‹¥å¹²ä¸ªçº¿ç¨‹**ï¼Œå½“ç„¶ä¸€ä¸ªè¿›ç¨‹ä¸­è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ç„¶æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰ã€‚
- çº¿ç¨‹å¯ä»¥åˆ©ç”¨è¿›ç¨‹æ‰€æ‹¥æœ‰çš„èµ„æºï¼Œåœ¨å¼•å…¥çº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œé€šå¸¸éƒ½æ˜¯æŠŠè¿›ç¨‹ä½œä¸ºåˆ†é…èµ„æºçš„åŸºæœ¬å•ä½ï¼Œè€ŒæŠŠ**çº¿ç¨‹ä½œä¸ºç‹¬ç«‹è¿è¡Œå’Œç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œç”±äºçº¿ç¨‹æ¯”è¿›ç¨‹æ›´å°ï¼ŒåŸºæœ¬ä¸Šä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æºï¼Œæ•…å¯¹å®ƒçš„è°ƒåº¦æ‰€ä»˜å‡ºçš„å¼€é”€å°±ä¼šå°å¾—å¤šï¼Œèƒ½æ›´é«˜æ•ˆçš„æé«˜ç³»ç»Ÿå¤šä¸ªç¨‹åºé—´å¹¶å‘æ‰§è¡Œçš„ç¨‹åº¦**ã€‚

### çº¿ç¨‹çŠ¶æ€

```java
NEW,RUNNABLE,BLOCKED,WAITING,TIMED_WAITING,TERMINATED;
```

![image-20200830104045416](/assets/imgs/image-20200830104045416.png)

### wait/sleep

åŠŸèƒ½éƒ½æ˜¯å½“å‰çº¿ç¨‹æš‚åœï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿwaitæ”¾å¼€æ‰‹å»ç¡ï¼Œæ”¾å¼€æ‰‹é‡Œçš„é”sleepæ¡ç´§æ‰‹å»ç¡ï¼Œé†’äº†æ‰‹é‡Œè¿˜æœ‰é”ã€‚

### å¹¶å‘å’Œå¹¶è¡Œ

**å¹¶å‘**ï¼šåŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®åŒä¸€ä¸ªèµ„æºï¼Œå¤šä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªç‚¹   ä¾‹å­ï¼šå°ç±³9ä»Šå¤©ä¸Šåˆ10ç‚¹ï¼Œé™é‡æŠ¢è´­      æ˜¥è¿æŠ¢ç¥¨      ç”µå•†ç§’æ€...

**å¹¶è¡Œï¼š**å¤šé¡¹å·¥ä½œä¸€èµ·æ‰§è¡Œï¼Œä¹‹åå†æ±‡æ€»   ä¾‹å­ï¼šæ³¡æ–¹ä¾¿é¢ï¼Œç”µæ°´å£¶çƒ§æ°´ï¼Œä¸€è¾¹æ’•è°ƒæ–™å€’å…¥æ¡¶ä¸­



### Java çº¿ç¨‹åˆ›å»ºæ–¹å¼ ğŸ¤”

**æ–¹æ³•ä¸€ï¼Œç›´æ¥ä½¿ç”¨ Thread**

```java
// åˆ›å»ºçº¿ç¨‹å¯¹è±¡
Thread t = new Thread() {
// é‡å†™runæ–¹æ³•ä¸ºä¸šåŠ¡é€»è¾‘
public void run() {
 		System.out.println("Hello MyThread!");
 }
};
// å¯åŠ¨çº¿ç¨‹
t.start();
```

**æ–¹æ³•äºŒï¼Œä½¿ç”¨ Runnable é…åˆ Thread**

```java
Runnable runnable = new Runnable() {
public void run(){
 		System.out.println("Hello MyRun!");
 }
};
// åˆ›å»ºçº¿ç¨‹å¯¹è±¡
Thread t = new Thread( runnable );
// å¯åŠ¨çº¿ç¨‹
t.start();
```

**æ–¹æ³•ä¸‰ï¼ŒFutureTask é…åˆ Thread**

```java
FutureTask<Integer> task3 = new FutureTask<>(() -> {
 System.out.println("Hello");
 return 100;
});
// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è
new Thread(task3, "t3").start();
// ä¸»çº¿ç¨‹é˜»å¡ï¼ŒåŒæ­¥ç­‰å¾… task æ‰§è¡Œå®Œæ¯•çš„ç»“æœ
Integer result = task3.get();
System.out.println("ç»“æœæ˜¯: " + result);
```

**Java 8 ä»¥åå¯ä»¥ä½¿ç”¨ lambda ç²¾ç®€ä»£ç (æ¨è)**

```java
new Thread(()->{
    System.out.println("Hello MyThread!");
},"t").start();
```

## Lockæ¥å£

é”å®ç°æä¾›äº†æ¯”ä½¿ç”¨åŒæ­¥æ–¹æ³•å’Œè¯­å¥å¯ä»¥è·å¾—çš„æ›´å¹¿æ³›çš„é”æ“ä½œã€‚å®ƒä»¬å…è®¸æ›´çµæ´»çš„ç»“æ„ï¼Œå¯èƒ½å…·æœ‰éå¸¸ä¸åŒçš„å±æ€§ï¼Œå¹¶ä¸”å¯èƒ½æ”¯æŒå¤šä¸ªå…³è”çš„æ¡ä»¶å¯¹è±¡ã€‚

### Lockæ¥å£çš„å®ç°

**ReentrantLockå¯é‡å…¥é”**ï¼Œå¦‚ä½•ä½¿ç”¨ï¼š

```java
class X {
  private final ReentrantLock lock = new ReentrantLock();
  // ...
  public void m() {
   lock.lock(); // block until condition holds
   try {
â€‹    // ... method body
   } finally {
â€‹    lock.unlock()
   }
  }
 }
```

### **synchronizedä¸Lockçš„åŒºåˆ«** 

1. é¦–å…ˆsynchronizedæ˜¯javaå†…ç½®å…³é”®å­—ï¼Œåœ¨jvmå±‚é¢ï¼ŒLockæ˜¯ä¸ªjavaç±»ï¼›

2. synchronizedæ— æ³•åˆ¤æ–­æ˜¯å¦è·å–é”çš„çŠ¶æ€ï¼ŒLockå¯ä»¥åˆ¤æ–­æ˜¯å¦è·å–åˆ°é”ï¼›

3. synchronizedä¼šè‡ªåŠ¨é‡Šæ”¾é”(a çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç ä¼šé‡Šæ”¾é” ï¼›b çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ä¼šé‡Šæ”¾é”)ï¼ŒLockéœ€åœ¨finallyä¸­æ‰‹å·¥é‡Šæ”¾é”ï¼ˆunlock()æ–¹æ³•é‡Šæ”¾é”ï¼‰ï¼Œå¦åˆ™å®¹æ˜“é€ æˆçº¿ç¨‹æ­»é”ï¼›

4. ç”¨synchronizedå…³é”®å­—çš„ä¸¤ä¸ªçº¿ç¨‹1å’Œçº¿ç¨‹2ï¼Œå¦‚æœå½“å‰çº¿ç¨‹1è·å¾—é”ï¼Œçº¿ç¨‹2çº¿ç¨‹ç­‰å¾…ã€‚å¦‚æœçº¿ç¨‹1é˜»å¡ï¼Œçº¿ç¨‹2åˆ™ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œè€ŒLocké”å°±ä¸ä¸€å®šä¼šç­‰å¾…ä¸‹å»ï¼Œå¦‚æœå°è¯•è·å–ä¸åˆ°é”ï¼Œçº¿ç¨‹å¯ä»¥ä¸ç”¨ä¸€ç›´ç­‰å¾…å°±ç»“æŸäº†ï¼›

5. synchronizedçš„é”å¯é‡å…¥ã€ä¸å¯ä¸­æ–­ã€éå…¬å¹³ï¼Œè€ŒLocké”å¯é‡å…¥ã€å¯åˆ¤æ–­ã€å¯å…¬å¹³ï¼ˆä¸¤è€…çš†å¯ï¼‰

6. Locké”é€‚åˆå¤§é‡åŒæ­¥çš„ä»£ç çš„åŒæ­¥é—®é¢˜ï¼Œsynchronizedé”é€‚åˆä»£ç å°‘é‡çš„åŒæ­¥é—®é¢˜ã€‚



### æ¥å£é‡Œæ˜¯å¦èƒ½æœ‰å®ç°æ–¹æ³•

- defaultæ–¹æ³•

- é™æ€æ–¹æ³•å®ç°ï¼šæ¥å£æ–°å¢ 

## çº¿ç¨‹é—´é€šä¿¡ ğŸ¤”

### é¢è¯•é¢˜ï¼šå››ä¸ªçº¿ç¨‹æ‰“å°

> ç°åœ¨4ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æ“ä½œåˆå§‹å€¼ä¸º0çš„ä¸€ä¸ªå˜é‡ã€‚å®ç°ä¸¤ä¸ªçº¿ç¨‹å¯¹è¯¥å˜é‡åŠ 1ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹è¯¥å˜é‡å‡1ï¼Œå®ç°äº¤æ›¿åŠ å‡10è½®ã€‚
>
> 1.é«˜å†…èšä½è€¦åˆå‰æä¸‹ï¼Œçº¿ç¨‹æ“ä½œèµ„æºç±»
>
> 2.åˆ¤æ–­/å¹²æ´»/é€šçŸ¥
>
> 3.å¤šçº¿ç¨‹äº¤äº’ä¸­ï¼Œå¿…é¡»è¦é˜²æ­¢å¤šçº¿ç¨‹çš„è™šå‡å”¤é†’ï¼Œä¹Ÿå³(åˆ¤æ–­åªç”¨whileï¼Œä¸èƒ½ç”¨if)

#### synchronizedç‰ˆ

![image-20200830172609995](/assets/imgs/image-20200830172609995.png) 

âš ï¸ï¼šif æƒ…å†µä¸‹ï¼ŒåŒæ—¶å”¤é†’äº†ä¸¤ä¸ª+1çš„çº¿ç¨‹ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«æ‹‰å›å†æ¬¡åˆ¤æ–­å¯¼è‡´shareData+1+1ã€‚ [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/ThreadWaitNotifyDemo.java)

```java
public class ThreadWaitNotifyDemo {
    public static void main(String[] args) {
        ShareData shareData = new ShareData();
        new Thread(() -> {
            // method
            for (int i = 0; i < 10; i++) {
                try {
                    shareData.increment();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "A").start();
        new Thread(() -> {
            // method
            for (int i = 0; i < 10; i++) {
                try {
                    shareData.decrement();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "B").start();
        new Thread(() -> {
            // method
            for (int i = 0; i < 10; i++) {
                try {
                    shareData.increment();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "C").start();
        new Thread(() -> {
            // method
            for (int i = 0; i < 10; i++) {
                try {
                    shareData.decrement();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "D").start();
    }

}

class ShareData {
    private int number = 0;

    public synchronized void increment() throws InterruptedException {
        //1 åˆ¤æ–­
        while (number != 0) {
            this.wait();
        }
        //2 å¹²æ´»
        number++;
        System.out.println(Thread.currentThread().getName() + ": " + number);
        //3 é€šçŸ¥
        this.notifyAll();
    }

    public synchronized void decrement() throws InterruptedException {
        //1 åˆ¤æ–­
        while (number == 0) {
            this.wait();
        }
        //2 å¹²æ´»
        number--;
        System.out.println(Thread.currentThread().getName() + ": " + number);
        //3 é€šçŸ¥
        this.notifyAll();
    }
}
```

#### lockç‰ˆ

![image-20200830173333135](/assets/imgs/image-20200830173333135.png)

[code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/ThreadWaitNotifyDemo2.java)

```java
class ShareData {
    private int number = 0;
    private Lock lock = new ReentrantLock();
    private Condition condition = lock.newCondition();

    public void increment() throws InterruptedException {
        lock.lock();
        try {
            //1 åˆ¤æ–­
            while (number != 0) {
                condition.await();
            }
            //2 å¹²æ´»
            number++;
            System.out.println(Thread.currentThread().getName() + ": " + number);
            //3 é€šçŸ¥
            condition.signalAll();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
    public void decrement() throws InterruptedException {
        lock.lock();
        try {
            //1 åˆ¤æ–­
            while (number == 0) {
                condition.await();
            }
            //2 å¹²æ´»
            number--;
            System.out.println(Thread.currentThread().getName() + ": " + number);
            //3 é€šçŸ¥
            condition.signalAll();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
}
```



### é¢è¯•é¢˜ï¼šçº¿ç¨‹é—´å®šåˆ¶åŒ–è°ƒç”¨é€šä¿¡

> lockçš„æ–°ç‰¹æ€§ï¼šé€šè¿‡è®¾ç½®å¤šä¸ªconditionå¯ä»¥å®ç°  ***ç²¾å‡†é€šçŸ¥ ç²¾å‡†å”¤é†’***    [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/ThreadOrderAccess.java)
>
> å¹¶å‘ç¼–ç¨‹å£è¯€ï¼š
>
> 1.é«˜å†…èšä½è€¦åˆå‰æä¸‹ï¼Œçº¿ç¨‹æ“ä½œèµ„æºç±»
>
> 2.åˆ¤æ–­/å¹²æ´»/é€šçŸ¥
>
> 3.å¤šçº¿ç¨‹äº¤äº’ä¸­ï¼Œå¿…é¡»è¦é˜²æ­¢å¤šçº¿ç¨‹çš„è™šå‡å”¤é†’ï¼Œä¹Ÿå³(åˆ¤æ–­åªç”¨whileï¼Œä¸èƒ½ç”¨if)
>
> 4.æ³¨æ„æ ‡å¿—ä½çš„ä¿®æ”¹å’Œå®šä½

é¢˜ç›®ï¼šå¤šçº¿ç¨‹ä¹‹é—´æŒ‰é¡ºåºè°ƒç”¨ï¼Œå®ç°A->B->Cã€‚ä¸‰ä¸ªçº¿ç¨‹å¯åŠ¨ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š

1. AAæ‰“å°5æ¬¡ï¼ŒBBæ‰“å°10æ¬¡ï¼ŒCCæ‰“å°15æ¬¡
2. æŒ‰æ­¤é¡ºåºæ‰“å°10è½®

### é¢è¯•é¢˜ï¼šå¤šçº¿ç¨‹é”

[code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/Lock8.java)

```
1. æ ‡å‡†è®¿é—®ï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - é‚®ä»¶
2. åœ4ç§’åœ¨çŸ­ä¿¡æ–¹æ³•å†…ï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - é‚®ä»¶
3.  æ™®é€šçš„helloæ–¹æ³•ï¼Œæ˜¯å…ˆæ‰“çŸ­ä¿¡è¿˜æ˜¯hello
   - Hello
4.  ç°åœ¨æœ‰ä¸¤éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - çŸ­ä¿¡
5.  ä¸¤ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œ1éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - é‚®ä»¶
6.  ä¸¤ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œ2éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - é‚®ä»¶
7. 1ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œ1ä¸ªæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œ1éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - çŸ­ä¿¡(ä¹Ÿä¸æ˜¯åŒä¸€ä¸ªé”ï¼Œä¸€ä¸ªæ˜¯ç±»ä¸€ä¸ªæ˜¯å®ä¾‹)
8. 1ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œ1ä¸ªæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œ2éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - çŸ­ä¿¡
```

#### **synchronizedå®ç°åŒæ­¥çš„åŸºç¡€**

Javaä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ã€‚å…·ä½“è¡¨ç°ä¸ºä»¥ä¸‹3ç§å½¢å¼ï¼š

1. å¯¹äºæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ã€‚
2. å¯¹äºé™æ€åŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰ç±»çš„Classå¯¹è±¡ã€‚
3. å¯¹äºåŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯Synchonizedæ‹¬å·é‡Œé…ç½®çš„å¯¹è±¡ã€‚

#### è¯¦ç»†åˆ†æ

1. **é”çš„æ˜¯å½“å‰å¯¹è±¡thisï¼Œè¢«é”å®šåï¼Œå…¶å®ƒçš„çº¿ç¨‹éƒ½ä¸èƒ½è¿›å…¥åˆ°å½“å‰å¯¹è±¡çš„å…¶å®ƒçš„synchronizedæ–¹æ³•ã€‚**
   - ä¸€ä¸ªå¯¹è±¡é‡Œé¢å¦‚æœæœ‰å¤šä¸ª**synchronizedæ–¹æ³•**ï¼ŒæŸä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªè¦ä¸€ä¸ªçº¿ç¨‹å»è°ƒç”¨å…¶ä¸­çš„ä¸€ä¸ªsynchronizedæ–¹æ³•äº†ï¼Œå…¶å®ƒçš„çº¿ç¨‹éƒ½åªèƒ½ç­‰å¾…ï¼Œæ¢å¥è¯è¯´ï¼Œ**æŸä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªèƒ½æœ‰å”¯ä¸€ä¸€ä¸ªçº¿ç¨‹å»è®¿é—®è¿™äº›synchronizedæ–¹æ³•ã€‚**

2. **åŠ ä¸ªæ™®é€šæ–¹æ³•Hello()åå‘ç°å’ŒåŒæ­¥é”æ— å…³ã€‚**

3. **æ¢æˆä¸¤ä¸ªå¯¹è±¡åï¼Œä¸æ˜¯åŒä¸€æŠŠé”äº†ï¼Œæƒ…å†µç«‹åˆ»å˜åŒ–ã€‚è¿™ä¸¤æŠŠé”æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œæ‰€ä»¥é™æ€åŒæ­¥æ–¹æ³•ä¸éé™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´æ˜¯ä¸ä¼šæœ‰ç«æ€æ¡ä»¶çš„ã€‚**
   - ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•è·å–é”åï¼Œè¯¥å®ä¾‹å¯¹è±¡çš„å…¶ä»–éé™æ€åŒæ­¥æ–¹æ³•å¿…é¡»ç­‰å¾…è·å–é”çš„æ–¹æ³•é‡Šæ”¾é”åæ‰èƒ½è·å–é”ï¼Œå¯æ˜¯åˆ«çš„å®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•å› ä¸ºè·Ÿè¯¥å®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•ç”¨çš„æ˜¯ä¸åŒçš„é”ï¼Œæ‰€ä»¥æ— é¡»ç­‰å¾…è¯¥å®ä¾‹å¯¹è±¡å·²è·å–é”çš„éé™æ€åŒæ­¥æ–¹æ³•é‡Šæ”¾é”å°±å¯ä»¥è·å–ä»–ä»¬è‡ªå·±çš„é”ã€‚

4. **æ‰€æœ‰çš„é™æ€åŒæ­¥æ–¹æ³•ç”¨çš„ä¹Ÿæ˜¯åŒä¸€æŠŠé”â€”â€”ç±»å¯¹è±¡æœ¬èº«**
   - ä¸€æ—¦ä¸€ä¸ªé™æ€åŒæ­¥æ–¹æ³•è·å–é”åï¼Œå…¶ä»–çš„é™æ€åŒæ­¥æ–¹æ³•éƒ½å¿…é¡»ç­‰å¾…è¯¥æ–¹æ³•é‡Šæ”¾é”åæ‰èƒ½è·å–é”ï¼Œè€Œä¸ç®¡æ˜¯åŒä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„é™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´ï¼Œè¿˜æ˜¯ä¸åŒçš„å®ä¾‹å¯¹è±¡çš„é™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´ï¼Œåªè¦å®ƒä»¬åŒä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡ï¼

5. **å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è®¿é—®åŒæ­¥ä»£ç å—æ—¶ï¼Œå®ƒé¦–å…ˆå¿…é¡»å¾—åˆ°é”ï¼Œé€€å‡ºæˆ–æŠ›å‡ºå¼‚å¸¸æ—¶å¿…é¡»é‡Šæ”¾é”ã€‚**



## é›†åˆç±»ä¸å®‰å…¨

### listä¸å®‰å…¨

è¯·ä¸¾ä¾‹è¯´æ˜listé›†åˆç±»æ˜¯ä¸å®‰å…¨çš„ [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/NotSafeDemo.java)

```java
public class NotSafeDemo {
    public static void main(String[] args) {
        List<String> list = new ArrayList<>(); // ArrayListçº¿ç¨‹ä¸å®‰å…¨

        for (int i = 0; i < 10; i++) {
            new Thread(() -> {
                // method
                list.add(UUID.randomUUID().toString().substring(0,8));
                System.out.println(list);
            }, String.valueOf(i)).start();
}}}
è¿è¡Œç»“æœï¼šâš ï¸ java.util.ConcurrentModificationException
[139dc871, 59b54246, c2feb94e]
[139dc871, 59b54246, c2feb94e, 022e001a, 7038fae8, d2f4a59e, d1458001]
[139dc871, 59b54246, c2feb94e, 022e001a, 7038fae8, d2f4a59e, d1458001, 7ea4371f, 7690e39c, ac2b872f]
[139dc871, 59b54246, c2feb94e, 022e001a, 7038fae8, d2f4a59e]
Exception in thread "6" [139dc871, 59b54246, c2feb94e]
Exception in thread "9" [139dc871, 59b54246, c2feb94e, 022e001a, 7038fae8]
[139dc871, 59b54246, c2feb94e, 022e001a]java.util.ConcurrentModificationException
[139dc871, 59b54246, c2feb94e]
	at java.base/java.util.ArrayList$Itr.checkForComodification(ArrayList.java:1042)
	at java.base/java.util.ArrayList$Itr.next(ArrayList.java:996)
	at java.base/java.util.AbstractCollection.toString(AbstractCollection.java:472)
	at java.base/java.lang.String.valueOf(String.java:2951)
	at java.base/java.io.PrintStream.println(PrintStream.java:897)
	at main.java.com.silince.juc.NotSafeDemo.lambda$main$0(NotSafeDemo.java:22)
	at java.base/java.lang.Thread.run(Thread.java:834)
```

#### åˆ†æ

1ï¼‰æ•…éšœç°è±¡

java.util.ConcurrentModificationException

2ï¼‰å¯¼è‡´åŸå› 

ArrayListåœ¨è¿­ä»£çš„æ—¶å€™***å¦‚æœåŒæ—¶å¯¹å…¶è¿›è¡Œä¿®æ”¹***å°±ä¼šæŠ›å‡ºjava.util.ConcurrentModificationException(å¹¶å‘ä¿®æ”¹å¼‚å¸¸)ã€‚

3ï¼‰è§£å†³æ–¹æ¡ˆ

1. æŠŠArrayListæ”¹ä¸ºVector

2. å°æ•°æ®é‡æ—¶å€™ï¼Œä½¿ç”¨Collectionså·¥å…·ç±»

   ```java
   // è§£å†³æ–¹æ¡ˆ
   List<Object> list = Collections.synchronizedList(new ArrayList<>());
   Map<String, String> map = Collections.synchronizedMap(new HashMap<String, String>());
   Set<Object> set = Collections.synchronizedSet(new HashSet<>());
   ```

3. ***ä½¿ç”¨java.util.concurrent.CopyOnWriteArrayList***     âš ï¸æ¨èï¼Œåº•å±‚ç”¨çš„æ˜¯locké”

   ```java
   // CopyOnWriteArrayList åº•å±‚ç”¨çš„æ˜¯locké”
   List<String> list = new CopyOnWriteArrayList<>();  
   ```

   åŸç†ï¼šå†™æ—¶å¤åˆ¶ï¼Œè¯»å†™åˆ†ç¦»ã€‚ ğŸ¤”

   ```java
   // CopyOnWriteArrayList
   public class CopyOnWriteArrayList<E>
       implements List<E>, RandomAccess, Cloneable, java.io.Serializable {
       private static final long serialVersionUID = 8673264195747942595L;
   
       /** The lock protecting all mutators */
       final transient ReentrantLock lock = new ReentrantLock();
   
       /** The array, accessed only via getArray/setArray. */
       private transient volatile Object[] array; // âš ï¸ åº•å±‚æ˜¯ä¸€ä¸ªObjectç±»çš„æ•°ç»„
     	...
       // addæ–¹æ³•åº•å±‚æºç 
       public boolean add(E e) {
         final ReentrantLock lock = this.lock;
         lock.lock(); // é”å®šèµ„æºç±»
         try {
           Object[] elements = getArray();// å…ˆè·å–ä¸€ä»½åŸæ¥çš„æ•°æ®ï¼Œä¹‹åå†å¼€å§‹æ·»åŠ 
           int len = elements.length;
           Object[] newElements = Arrays.copyOf(elements, len + 1); // âš ï¸æ‰©å®¹æ–¹å¼ Arrays.copyOf()ï¼Œæ¯æ¬¡æ‰© 1 ä¸ª
           newElements[len] = e; 
           setArray(newElements); // æ·»åŠ å®Œæˆåæ›¿æ¢åŸæ¥çš„Object[]
           return true;
         } finally {
           lock.unlock();
         }
       }
   }
   ```

4ï¼‰ä¼˜åŒ–å»ºè®® (åŒæ ·çš„é”™è¯¯ï¼Œä¸èƒ½å‡ºç°ç¬¬2æ¬¡)





### setä¸å®‰å…¨

### mapä¸å®‰å…¨