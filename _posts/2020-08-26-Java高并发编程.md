---
scrolllayout: post
title:  "Javaé«˜å¹¶å‘ç¼–ç¨‹"
date:   2020-08-26 11:02:06 +0800--
categories: [Java]
tags: [é«˜å¹¶å‘,JUC ]  
---

# Javaé«˜å¹¶å‘ç¼–ç¨‹

## JUCæ˜¯ä»€ä¹ˆ

java.util.concurrent åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ä½¿ç”¨çš„å·¥å…·ç±»

## è¿›ç¨‹ä¸çº¿ç¨‹

**è¿›ç¨‹**

- ç¨‹åºç”±**æŒ‡ä»¤å’Œæ•°æ®**ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»**å°†æŒ‡ä»¤åŠ è½½è‡³ CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜**ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡ã€‚**è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ã€ç®¡ç†å†…å­˜ã€ç®¡ç† IO çš„**ã€‚
- å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œ**ä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹**ã€‚
  **è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹**ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚è®°äº‹æœ¬ã€ç”»å›¾ã€æµè§ˆå™¨ç­‰ï¼‰ï¼Œä¹Ÿæœ‰çš„ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚ç½‘æ˜“äº‘éŸ³ä¹ã€360 å®‰å…¨å«å£«ç­‰ï¼‰ã€‚

**çº¿ç¨‹**

- é€šå¸¸åœ¨**ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åŒ…å«è‹¥å¹²ä¸ªçº¿ç¨‹**ï¼Œå½“ç„¶ä¸€ä¸ªè¿›ç¨‹ä¸­è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ç„¶æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰ã€‚
- çº¿ç¨‹å¯ä»¥åˆ©ç”¨è¿›ç¨‹æ‰€æ‹¥æœ‰çš„èµ„æºï¼Œåœ¨å¼•å…¥çº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œé€šå¸¸éƒ½æ˜¯æŠŠè¿›ç¨‹ä½œä¸ºåˆ†é…èµ„æºçš„åŸºæœ¬å•ä½ï¼Œè€ŒæŠŠ**çº¿ç¨‹ä½œä¸ºç‹¬ç«‹è¿è¡Œå’Œç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œç”±äºçº¿ç¨‹æ¯”è¿›ç¨‹æ›´å°ï¼ŒåŸºæœ¬ä¸Šä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æºï¼Œæ•…å¯¹å®ƒçš„è°ƒåº¦æ‰€ä»˜å‡ºçš„å¼€é”€å°±ä¼šå°å¾—å¤šï¼Œèƒ½æ›´é«˜æ•ˆçš„æé«˜ç³»ç»Ÿå¤šä¸ªç¨‹åºé—´å¹¶å‘æ‰§è¡Œçš„ç¨‹åº¦**ã€‚

### çº¿ç¨‹çŠ¶æ€

```java
NEW,RUNNABLE,BLOCKED,WAITING,TIMED_WAITING,TERMINATED;
```

![image-20200830104045416](/assets/imgs/image-20200830104045416.png)

### wait/sleep

åŠŸèƒ½éƒ½æ˜¯å½“å‰çº¿ç¨‹æš‚åœï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿwaitæ”¾å¼€æ‰‹å»ç¡ï¼Œæ”¾å¼€æ‰‹é‡Œçš„é”sleepæ¡ç´§æ‰‹å»ç¡ï¼Œé†’äº†æ‰‹é‡Œè¿˜æœ‰é”ã€‚

### å¹¶å‘å’Œå¹¶è¡Œ

**å¹¶å‘**ï¼šåŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®åŒä¸€ä¸ªèµ„æºï¼Œå¤šä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªç‚¹   ä¾‹å­ï¼šå°ç±³9ä»Šå¤©ä¸Šåˆ10ç‚¹ï¼Œé™é‡æŠ¢è´­      æ˜¥è¿æŠ¢ç¥¨      ç”µå•†ç§’æ€...

**å¹¶è¡Œï¼š**å¤šé¡¹å·¥ä½œä¸€èµ·æ‰§è¡Œï¼Œä¹‹åå†æ±‡æ€»   ä¾‹å­ï¼šæ³¡æ–¹ä¾¿é¢ï¼Œç”µæ°´å£¶çƒ§æ°´ï¼Œä¸€è¾¹æ’•è°ƒæ–™å€’å…¥æ¡¶ä¸­



### Java çº¿ç¨‹åˆ›å»ºæ–¹å¼ ğŸ¤”

#### **ç»§æ‰¿ Thread**

```java
// åˆ›å»ºçº¿ç¨‹å¯¹è±¡
Thread t = new Thread() {
// é‡å†™runæ–¹æ³•ä¸ºä¸šåŠ¡é€»è¾‘
public void run() {
 		System.out.println("Hello MyThread!");
 }
};
// å¯åŠ¨çº¿ç¨‹
t.start();
```

#### **å®ç° Runnable æ¥å£é…åˆ Thread**

```java
Runnable runnable = new Runnable() {
public void run(){
 		System.out.println("Hello MyRun!");
 }
};
// åˆ›å»ºçº¿ç¨‹å¯¹è±¡
Thread t = new Thread( runnable );
// å¯åŠ¨çº¿ç¨‹
t.start();

// âš ï¸Java 8 ä»¥åå¯ä»¥ä½¿ç”¨ lambda ç²¾ç®€ä»£ç (æ¨è)
new Thread(()->{
    System.out.println("Hello MyThread!");
},"t").start();
```

#### **FutureTask é…åˆ Thread** ğŸ¤”

```java
// FutureTaskæ˜¯Runnableçš„å®ç°ç±»ï¼Œå¹¶æœ‰Callableçš„æ„é€ å‡½æ•°
FutureTask<Integer> futureTask = new FutureTask<>(() -> {
 System.out.println("Hello");
 return 100;
});
// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è
new Thread(futureTask, "t3").start();
// ä¸»çº¿ç¨‹é˜»å¡ï¼ŒåŒæ­¥ç­‰å¾… task æ‰§è¡Œå®Œæ¯•çš„ç»“æœ
System.out.println("ç»“æœæ˜¯: " + futureTask.get());
```

***ä»€ä¹ˆæ˜¯FutureTaskï¼Ÿ***

æœªæ¥çš„ä»»åŠ¡ï¼Œç”¨å®ƒå°±å¹²ä¸€ä»¶äº‹ï¼Œå¼‚æ­¥è°ƒç”¨ã€‚mainæ–¹æ³•å°±åƒä¸€ä¸ªå†°ç³–è‘«èŠ¦ï¼Œä¸€ä¸ªä¸ªæ–¹æ³•ç”±mainä¸²èµ·æ¥ã€‚ä½†è§£å†³ä¸äº†ä¸€ä¸ªé—®é¢˜ï¼šæ­£å¸¸è°ƒç”¨æŒ‚èµ·å µå¡é—®é¢˜ã€‚ä¾‹å­ï¼šè€å¸ˆä¸Šç€è¯¾ï¼Œå£æ¸´äº†ï¼Œå»ä¹°æ°´ä¸åˆé€‚ï¼Œè®²è¯¾çº¿ç¨‹ç»§ç»­ï¼Œæˆ‘å¯ä»¥å•èµ·ä¸ªçº¿ç¨‹æ‰¾ç­é•¿å¸®å¿™ä¹°æ°´ï¼Œæ°´ä¹°å›æ¥äº†æ”¾æ¡Œä¸Šï¼Œæˆ‘éœ€è¦çš„æ—¶å€™å†å»getã€‚

***ä¸€äº›ç»†èŠ‚*** ğŸ¤”

- get()æ–¹æ³•ä¸€èˆ¬æ”¾åœ¨æœ€åä¸€è¡Œ
- åªè®¡ç®—ä¸€æ¬¡

ä¸€èˆ¬FutureTaskå¤šç”¨äºè€—æ—¶çš„è®¡ç®—ï¼Œä¸»çº¿ç¨‹å¯ä»¥åœ¨å®Œæˆè‡ªå·±çš„ä»»åŠ¡åï¼Œå†å»è·å–ç»“æœã€‚ä»…åœ¨è®¡ç®—å®Œæˆæ—¶æ‰èƒ½æ£€ç´¢ç»“æœï¼›***ä¸€æ—¦è®¡ç®—å®Œæˆï¼Œå°±ä¸èƒ½å†é‡æ–°å¼€å§‹æˆ–å–æ¶ˆè®¡ç®—***ã€‚***getæ–¹æ³•è€Œè·å–ç»“æœåªæœ‰åœ¨è®¡ç®—å®Œæˆæ—¶è·å–ï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡ç›´åˆ°ä»»åŠ¡è½¬å…¥å®ŒæˆçŠ¶æ€ï¼Œ***



## Lockæ¥å£

é”å®ç°æä¾›äº†æ¯”ä½¿ç”¨åŒæ­¥æ–¹æ³•å’Œè¯­å¥å¯ä»¥è·å¾—çš„æ›´å¹¿æ³›çš„é”æ“ä½œã€‚å®ƒä»¬å…è®¸æ›´çµæ´»çš„ç»“æ„ï¼Œå¯èƒ½å…·æœ‰éå¸¸ä¸åŒçš„å±æ€§ï¼Œå¹¶ä¸”å¯èƒ½æ”¯æŒå¤šä¸ªå…³è”çš„æ¡ä»¶å¯¹è±¡ã€‚

### ReentrantLockå®ç°ç±»

> lockçš„æ–°ç‰¹æ€§ï¼šé€šè¿‡è®¾ç½®å¤šä¸ªconditionå¯ä»¥å®ç°  ***ç²¾å‡†é€šçŸ¥ ç²¾å‡†å”¤é†’***

**ReentrantLockå¯é‡å…¥é”**ï¼Œå¦‚ä½•ä½¿ç”¨ï¼š

```java
class X {
  private final ReentrantLock lock = new ReentrantLock();
  // ...
  public void m() {
   lock.lock(); // block until condition holds
   try {
â€‹    // ... method body
   } finally {
â€‹    lock.unlock()
   }
  }
 }
```

### **synchronizedä¸Lockçš„åŒºåˆ«** 

1. é¦–å…ˆsynchronizedæ˜¯javaå†…ç½®å…³é”®å­—ï¼Œåœ¨jvmå±‚é¢ï¼ŒLockæ˜¯ä¸ªjavaç±»ï¼›

2. synchronizedæ— æ³•åˆ¤æ–­æ˜¯å¦è·å–é”çš„çŠ¶æ€ï¼ŒLockå¯ä»¥åˆ¤æ–­æ˜¯å¦è·å–åˆ°é”ï¼›

3. synchronizedä¼šè‡ªåŠ¨é‡Šæ”¾é”(a çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç ä¼šé‡Šæ”¾é” ï¼›b çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ä¼šé‡Šæ”¾é”)ï¼ŒLockéœ€åœ¨finallyä¸­æ‰‹å·¥é‡Šæ”¾é”ï¼ˆunlock()æ–¹æ³•é‡Šæ”¾é”ï¼‰ï¼Œå¦åˆ™å®¹æ˜“é€ æˆçº¿ç¨‹æ­»é”ï¼›

4. ç”¨synchronizedå…³é”®å­—çš„ä¸¤ä¸ªçº¿ç¨‹1å’Œçº¿ç¨‹2ï¼Œå¦‚æœå½“å‰çº¿ç¨‹1è·å¾—é”ï¼Œçº¿ç¨‹2çº¿ç¨‹ç­‰å¾…ã€‚å¦‚æœçº¿ç¨‹1é˜»å¡ï¼Œçº¿ç¨‹2åˆ™ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œè€ŒLocké”å°±ä¸ä¸€å®šä¼šç­‰å¾…ä¸‹å»ï¼Œå¦‚æœå°è¯•è·å–ä¸åˆ°é”ï¼Œçº¿ç¨‹å¯ä»¥ä¸ç”¨ä¸€ç›´ç­‰å¾…å°±ç»“æŸäº†ï¼›

5. synchronizedçš„é”å¯é‡å…¥ã€ä¸å¯ä¸­æ–­ã€éå…¬å¹³ï¼Œè€ŒLocké”å¯é‡å…¥ã€å¯åˆ¤æ–­ã€å¯å…¬å¹³ï¼ˆä¸¤è€…çš†å¯ï¼‰

6. åœ¨é«˜äº‰ç”¨ é«˜è€—æ—¶çš„ç¯å¢ƒä¸‹synchronizedæ•ˆç‡æ›´é«˜ï¼Œåœ¨ä½äº‰ç”¨ ä½è€—æ—¶çš„ç¯å¢ƒä¸‹Lock (CAS)æ•ˆç‡æ›´é«˜

   - ***synchronizedåˆ°é‡é‡çº§ä¹‹åæ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼ˆä¸æ¶ˆè€—CPUï¼‰, è€ŒCASï¼ˆç­‰å¾…æœŸé—´æ¶ˆè€—CPUï¼‰***
   -  ***ä¸€åˆ‡ä»¥å®æµ‹ä¸ºå‡†***



### æ¥å£é‡Œæ˜¯å¦èƒ½æœ‰å®ç°æ–¹æ³•

- defaultæ–¹æ³•

- é™æ€æ–¹æ³•å®ç°ï¼šæ¥å£æ–°å¢ 

## çº¿ç¨‹é—´é€šä¿¡ ğŸ¤”

### é¢è¯•é¢˜ï¼šå››ä¸ªçº¿ç¨‹æ‰“å°

> ç°åœ¨4ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æ“ä½œåˆå§‹å€¼ä¸º0çš„ä¸€ä¸ªå˜é‡ã€‚å®ç°ä¸¤ä¸ªçº¿ç¨‹å¯¹è¯¥å˜é‡åŠ 1ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹è¯¥å˜é‡å‡1ï¼Œå®ç°äº¤æ›¿åŠ å‡10è½®ã€‚
>
> 1.é«˜å†…èšä½è€¦åˆå‰æä¸‹ï¼Œçº¿ç¨‹æ“ä½œèµ„æºç±»
>
> 2.åˆ¤æ–­/å¹²æ´»/é€šçŸ¥
>
> 3.å¤šçº¿ç¨‹äº¤äº’ä¸­ï¼Œå¿…é¡»è¦é˜²æ­¢å¤šçº¿ç¨‹çš„è™šå‡å”¤é†’ï¼Œä¹Ÿå³(åˆ¤æ–­åªç”¨whileï¼Œä¸èƒ½ç”¨if)

#### synchronizedç‰ˆ

![image-20200830172609995](/assets/imgs/image-20200830172609995.png) 

âš ï¸ï¼šif æƒ…å†µä¸‹ï¼ŒåŒæ—¶å”¤é†’äº†ä¸¤ä¸ª+1çš„çº¿ç¨‹ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«æ‹‰å›å†æ¬¡åˆ¤æ–­å¯¼è‡´shareData+1+1ã€‚ [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/ThreadWaitNotifyDemo.java)

```java
public class ThreadWaitNotifyDemo {
    public static void main(String[] args) {
        ShareData shareData = new ShareData();
        new Thread(() -> {
            // method
            for (int i = 0; i < 10; i++) {
                try {
                    shareData.increment();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "A").start();
        new Thread(() -> {
            // method
            for (int i = 0; i < 10; i++) {
                try {
                    shareData.decrement();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "B").start();
        new Thread(() -> {
            // method
            for (int i = 0; i < 10; i++) {
                try {
                    shareData.increment();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "C").start();
        new Thread(() -> {
            // method
            for (int i = 0; i < 10; i++) {
                try {
                    shareData.decrement();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "D").start();
    }

}

class ShareData {
    private int number = 0;

    public synchronized void increment() throws InterruptedException {
        //1 åˆ¤æ–­
        while (number != 0) {
            this.wait();
        }
        //2 å¹²æ´»
        number++;
        System.out.println(Thread.currentThread().getName() + ": " + number);
        //3 é€šçŸ¥
        this.notifyAll();
    }

    public synchronized void decrement() throws InterruptedException {
        //1 åˆ¤æ–­
        while (number == 0) {
            this.wait();
        }
        //2 å¹²æ´»
        number--;
        System.out.println(Thread.currentThread().getName() + ": " + number);
        //3 é€šçŸ¥
        this.notifyAll();
    }
}
```

#### lockç‰ˆ ğŸ¤”

![image-20200830173333135](/assets/imgs/image-20200830173333135.png)

[code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/ThreadWaitNotifyDemo2.java)

```java
class ShareData {
    private int number = 0;
    private Lock lock = new ReentrantLock();
    private Condition condition = lock.newCondition();

    public void increment() throws InterruptedException {
        lock.lock();
        try {
            //1 åˆ¤æ–­
            while (number != 0) {
                condition.await();
            }
            //2 å¹²æ´»
            number++;
            System.out.println(Thread.currentThread().getName() + ": " + number);
            //3 é€šçŸ¥
            condition.signalAll();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
    public void decrement() throws InterruptedException {
        lock.lock();
        try {
            //1 åˆ¤æ–­
            while (number == 0) {
                condition.await();
            }
            //2 å¹²æ´»
            number--;
            System.out.println(Thread.currentThread().getName() + ": " + number);
            //3 é€šçŸ¥
            condition.signalAll();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
}
```



### é¢è¯•é¢˜ï¼šçº¿ç¨‹é—´å®šåˆ¶åŒ–è°ƒç”¨é€šä¿¡ 

> lockçš„æ–°ç‰¹æ€§ï¼šé€šè¿‡è®¾ç½®å¤šä¸ªconditionå¯ä»¥å®ç°  ***ç²¾å‡†é€šçŸ¥ ç²¾å‡†å”¤é†’***    [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/ThreadOrderAccess.java)
>
> å¹¶å‘ç¼–ç¨‹å£è¯€ï¼š
>
> 1.é«˜å†…èšä½è€¦åˆå‰æä¸‹ï¼Œçº¿ç¨‹æ“ä½œèµ„æºç±»
>
> 2.åˆ¤æ–­/å¹²æ´»/é€šçŸ¥
>
> 3.å¤šçº¿ç¨‹äº¤äº’ä¸­ï¼Œå¿…é¡»è¦é˜²æ­¢å¤šçº¿ç¨‹çš„è™šå‡å”¤é†’ï¼Œä¹Ÿå³(åˆ¤æ–­åªç”¨whileï¼Œä¸èƒ½ç”¨if)
>
> 4.æ³¨æ„æ ‡å¿—ä½çš„ä¿®æ”¹å’Œå®šä½

é¢˜ç›®ï¼šå¤šçº¿ç¨‹ä¹‹é—´æŒ‰é¡ºåºè°ƒç”¨ï¼Œå®ç°A->B->Cã€‚ä¸‰ä¸ªçº¿ç¨‹å¯åŠ¨ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š

1. AAæ‰“å°5æ¬¡ï¼ŒBBæ‰“å°10æ¬¡ï¼ŒCCæ‰“å°15æ¬¡
2. æŒ‰æ­¤é¡ºåºæ‰“å°10è½®

### é¢è¯•é¢˜ï¼šå¤šçº¿ç¨‹é”

[code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/Lock8.java)

```
1. æ ‡å‡†è®¿é—®ï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - é‚®ä»¶
2. åœ4ç§’åœ¨çŸ­ä¿¡æ–¹æ³•å†…ï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - é‚®ä»¶
3.  æ™®é€šçš„helloæ–¹æ³•ï¼Œæ˜¯å…ˆæ‰“çŸ­ä¿¡è¿˜æ˜¯hello
   - Hello
4.  ç°åœ¨æœ‰ä¸¤éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - çŸ­ä¿¡
5.  ä¸¤ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œ1éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - é‚®ä»¶
6.  ä¸¤ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œ2éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - é‚®ä»¶
7. 1ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œ1ä¸ªæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œ1éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - çŸ­ä¿¡(ä¹Ÿä¸æ˜¯åŒä¸€ä¸ªé”ï¼Œä¸€ä¸ªæ˜¯ç±»ä¸€ä¸ªæ˜¯å®ä¾‹)
8. 1ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œ1ä¸ªæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œ2éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°çŸ­ä¿¡è¿˜æ˜¯é‚®ä»¶
   - çŸ­ä¿¡
```

#### **synchronizedå®ç°åŒæ­¥çš„åŸºç¡€**

Javaä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ã€‚å…·ä½“è¡¨ç°ä¸ºä»¥ä¸‹3ç§å½¢å¼ï¼š

1. å¯¹äºæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ã€‚
2. å¯¹äºé™æ€åŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰ç±»çš„Classå¯¹è±¡ã€‚
3. å¯¹äºåŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯Synchonizedæ‹¬å·é‡Œé…ç½®çš„å¯¹è±¡ã€‚

#### è¯¦ç»†åˆ†æ

1. **é”çš„æ˜¯å½“å‰å¯¹è±¡thisï¼Œè¢«é”å®šåï¼Œå…¶å®ƒçš„çº¿ç¨‹éƒ½ä¸èƒ½è¿›å…¥åˆ°å½“å‰å¯¹è±¡çš„å…¶å®ƒçš„synchronizedæ–¹æ³•ã€‚**
   - ä¸€ä¸ªå¯¹è±¡é‡Œé¢å¦‚æœæœ‰å¤šä¸ª**synchronizedæ–¹æ³•**ï¼ŒæŸä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªè¦ä¸€ä¸ªçº¿ç¨‹å»è°ƒç”¨å…¶ä¸­çš„ä¸€ä¸ªsynchronizedæ–¹æ³•äº†ï¼Œå…¶å®ƒçš„çº¿ç¨‹éƒ½åªèƒ½ç­‰å¾…ï¼Œæ¢å¥è¯è¯´ï¼Œ**æŸä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªèƒ½æœ‰å”¯ä¸€ä¸€ä¸ªçº¿ç¨‹å»è®¿é—®è¿™äº›synchronizedæ–¹æ³•ã€‚**

2. **åŠ ä¸ªæ™®é€šæ–¹æ³•Hello()åå‘ç°å’ŒåŒæ­¥é”æ— å…³ã€‚**

3. **æ¢æˆä¸¤ä¸ªå¯¹è±¡åï¼Œä¸æ˜¯åŒä¸€æŠŠé”äº†ï¼Œæƒ…å†µç«‹åˆ»å˜åŒ–ã€‚è¿™ä¸¤æŠŠé”æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œæ‰€ä»¥é™æ€åŒæ­¥æ–¹æ³•ä¸éé™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´æ˜¯ä¸ä¼šæœ‰ç«æ€æ¡ä»¶çš„ã€‚**
   - ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•è·å–é”åï¼Œè¯¥å®ä¾‹å¯¹è±¡çš„å…¶ä»–éé™æ€åŒæ­¥æ–¹æ³•å¿…é¡»ç­‰å¾…è·å–é”çš„æ–¹æ³•é‡Šæ”¾é”åæ‰èƒ½è·å–é”ï¼Œå¯æ˜¯åˆ«çš„å®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•å› ä¸ºè·Ÿè¯¥å®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•ç”¨çš„æ˜¯ä¸åŒçš„é”ï¼Œæ‰€ä»¥æ— é¡»ç­‰å¾…è¯¥å®ä¾‹å¯¹è±¡å·²è·å–é”çš„éé™æ€åŒæ­¥æ–¹æ³•é‡Šæ”¾é”å°±å¯ä»¥è·å–ä»–ä»¬è‡ªå·±çš„é”ã€‚

4. **æ‰€æœ‰çš„é™æ€åŒæ­¥æ–¹æ³•ç”¨çš„ä¹Ÿæ˜¯åŒä¸€æŠŠé”â€”â€”ç±»å¯¹è±¡æœ¬èº«**
   - ä¸€æ—¦ä¸€ä¸ªé™æ€åŒæ­¥æ–¹æ³•è·å–é”åï¼Œå…¶ä»–çš„é™æ€åŒæ­¥æ–¹æ³•éƒ½å¿…é¡»ç­‰å¾…è¯¥æ–¹æ³•é‡Šæ”¾é”åæ‰èƒ½è·å–é”ï¼Œè€Œä¸ç®¡æ˜¯åŒä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„é™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´ï¼Œè¿˜æ˜¯ä¸åŒçš„å®ä¾‹å¯¹è±¡çš„é™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´ï¼Œåªè¦å®ƒä»¬åŒä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡ï¼

5. **å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è®¿é—®åŒæ­¥ä»£ç å—æ—¶ï¼Œå®ƒé¦–å…ˆå¿…é¡»å¾—åˆ°é”ï¼Œé€€å‡ºæˆ–æŠ›å‡ºå¼‚å¸¸æ—¶å¿…é¡»é‡Šæ”¾é”ã€‚**



## é›†åˆç±»ä¸å®‰å…¨

### listä¸å®‰å…¨

è¯·ä¸¾ä¾‹è¯´æ˜listé›†åˆç±»æ˜¯ä¸å®‰å…¨çš„ [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/NotSafeDemo.java)

```java
public class NotSafeDemo {
    public static void main(String[] args) {
        List<String> list = new ArrayList<>(); // ArrayListçº¿ç¨‹ä¸å®‰å…¨

        for (int i = 0; i < 10; i++) {
            new Thread(() -> {
                // method
                list.add(UUID.randomUUID().toString().substring(0,8));
                System.out.println(list);
            }, String.valueOf(i)).start();
}}}
è¿è¡Œç»“æœï¼šâš ï¸ java.util.ConcurrentModificationException
[139dc871, 59b54246, c2feb94e]
[139dc871, 59b54246, c2feb94e, 022e001a, 7038fae8, d2f4a59e, d1458001]
[139dc871, 59b54246, c2feb94e, 022e001a, 7038fae8, d2f4a59e, d1458001, 7ea4371f, 7690e39c, ac2b872f]
[139dc871, 59b54246, c2feb94e, 022e001a, 7038fae8, d2f4a59e]
Exception in thread "6" [139dc871, 59b54246, c2feb94e]
Exception in thread "9" [139dc871, 59b54246, c2feb94e, 022e001a, 7038fae8]
[139dc871, 59b54246, c2feb94e, 022e001a]java.util.ConcurrentModificationException
[139dc871, 59b54246, c2feb94e]
	at java.base/java.util.ArrayList$Itr.checkForComodification(ArrayList.java:1042)
	at java.base/java.util.ArrayList$Itr.next(ArrayList.java:996)
	at java.base/java.util.AbstractCollection.toString(AbstractCollection.java:472)
	at java.base/java.lang.String.valueOf(String.java:2951)
	at java.base/java.io.PrintStream.println(PrintStream.java:897)
	at main.java.com.silince.juc.NotSafeDemo.lambda$main$0(NotSafeDemo.java:22)
	at java.base/java.lang.Thread.run(Thread.java:834)
```

#### åˆ†æ

1ï¼‰æ•…éšœç°è±¡

java.util.ConcurrentModificationException

2ï¼‰å¯¼è‡´åŸå› 

ArrayListåœ¨è¿­ä»£çš„æ—¶å€™***å¦‚æœåŒæ—¶å¯¹å…¶è¿›è¡Œä¿®æ”¹***å°±ä¼šæŠ›å‡ºjava.util.ConcurrentModificationException(å¹¶å‘ä¿®æ”¹å¼‚å¸¸)ã€‚

3ï¼‰è§£å†³æ–¹æ¡ˆ

1. æŠŠArrayListæ”¹ä¸ºVector

2. å°æ•°æ®é‡æ—¶å€™ï¼Œä½¿ç”¨Collectionså·¥å…·ç±»

   ```java
   // è§£å†³æ–¹æ¡ˆ
   List<Object> list = Collections.synchronizedList(new ArrayList<>());
   Map<String, String> map = Collections.synchronizedMap(new HashMap<String, String>());
   Set<Object> set = Collections.synchronizedSet(new HashSet<>());
   ```

3. ***ä½¿ç”¨java.util.concurrent.CopyOnWriteArrayList***     âš ï¸æ¨èï¼Œåº•å±‚ç”¨çš„æ˜¯locké”

   ```java
   // CopyOnWriteArrayList åº•å±‚ç”¨çš„æ˜¯locké”
   List<String> list = new CopyOnWriteArrayList<>();  
   ```

   åŸç†ï¼šå†™æ—¶å¤åˆ¶ï¼Œè¯»å†™åˆ†ç¦»ã€‚ ğŸ¤”

   CopyOnWriteå®¹å™¨å³å†™æ—¶å¤åˆ¶çš„å®¹å™¨ã€‚***å¾€ä¸€ä¸ªå®¹å™¨æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¾€å½“å‰å®¹å™¨Object[]æ·»åŠ ï¼Œè€Œæ˜¯å…ˆå°†å½“å‰å®¹å™¨Object[]è¿›è¡ŒCopyï¼Œå¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„å®¹å™¨Object[] newElementsï¼Œç„¶åå‘æ–°çš„å®¹å™¨Object[] newElementsé‡Œæ·»åŠ å…ƒç´ ã€‚******æ·»åŠ å…ƒç´ åï¼Œå†å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„å®¹å™¨setArray(newElements)ã€‚***è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥å¯¹CopyOnWriteå®¹å™¨è¿›è¡Œ***å¹¶å‘çš„è¯»ï¼Œè€Œä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºå½“å‰å®¹å™¨ä¸ä¼šæ·»åŠ ä»»ä½•å…ƒç´ ã€‚***æ‰€ä»¥CopyOnWriteå®¹å™¨ä¹Ÿæ˜¯ä¸€ç§è¯»å†™åˆ†ç¦»çš„æ€æƒ³ï¼Œè¯»å’Œå†™ä¸åŒçš„å®¹å™¨ã€‚

   ```java
   // CopyOnWriteArrayList
   public class CopyOnWriteArrayList<E>
       implements List<E>, RandomAccess, Cloneable, java.io.Serializable {
       private static final long serialVersionUID = 8673264195747942595L;
   
       /** The lock protecting all mutators */
       final transient ReentrantLock lock = new ReentrantLock();
   
       /** The array, accessed only via getArray/setArray. */
       private transient volatile Object[] array; // âš ï¸ åº•å±‚æ˜¯ä¸€ä¸ªObjectç±»çš„æ•°ç»„
     	...
       // addæ–¹æ³•åº•å±‚æºç 
       public boolean add(E e) {
         final ReentrantLock lock = this.lock;
         lock.lock(); // é”å®šèµ„æºç±»
         try {
           Object[] elements = getArray();// å…ˆè·å–ä¸€ä»½åŸæ¥çš„æ•°æ®ï¼Œä¹‹åå†å¼€å§‹æ·»åŠ 
           int len = elements.length;
           Object[] newElements = Arrays.copyOf(elements, len + 1); // âš ï¸æ‰©å®¹æ–¹å¼ Arrays.copyOf()ï¼Œæ¯æ¬¡æ‰© 1 ä¸ª
           newElements[len] = e; 
           setArray(newElements); // æ·»åŠ å®Œæˆåæ›¿æ¢åŸæ¥çš„Object[]
           return true;
         } finally {
           lock.unlock();
         }
       }
   }
   ```

### setä¸å®‰å…¨

```java
Set set = new HashSet();//çº¿ç¨‹ä¸å®‰å…¨ 
Set set = new CopyOnWriteArraySet();//çº¿ç¨‹å®‰å…¨ 
```

***HashSetåº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ***

ANSWERï¼šHashMapã€‚ ä½†HashSetçš„addæ˜¯æ”¾ä¸€ä¸ªå€¼ï¼Œè€ŒHashMapæ˜¯æ”¾Kã€Vé”®å€¼å¯¹ã€‚

```java
// æºç è§£æ
// HashSetåº•å±‚å°±æ˜¯HashMap
public HashSet() {    
  map = new HashMap();
} 
// âš ï¸ HashSetçš„add()æ–¹æ³•è°ƒçš„å°±æ˜¯HashMapçš„put()æ–¹æ³•ï¼Œåªæ˜¯valueé»˜è®¤ä¸ºä¸Šé¢å®šä¹‰çš„å¸¸é‡Object
private static final Object PRESENT = new Object();
public boolean add(E e) {    return map.put(e, PRESENT)==null;}
```

### mapä¸å®‰å…¨ ğŸ¤”

```java
Map map = new HashMap();//çº¿ç¨‹ä¸å®‰å…¨ 
Map map = new ConcurrentHashMap();//çº¿ç¨‹å®‰å…¨ âš ï¸ æ¢äº†ä¸ªå‘½åæ–¹å¼	
```

***java8ä¸­HashMapåº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ***

- nodeç±»å‹çš„æ•°ç»„ + nodeç±»å‹çš„å•å‘é“¾è¡¨(å°¾æ’æ³•) + çº¢é»‘æ ‘(é“¾è¡¨é•¿åº¦>8æ—¶å˜ä¸ºçº¢é»‘æ ‘)

- HashMapçš„åˆå§‹é•¿åº¦ä¸º16ï¼Œè´Ÿè½½å› å­ä¸º0.75ï¼›ä¹Ÿå¯ä»¥è‡ªå·±è®¾å®šã€‚

  - ***é•¿åº¦è¶…è¿‡16\*0.75=12çš„æ—¶å€™æ‰©å®¹***
  - ***ArrayListæ‰©å®¹åŸé•¿åº¦çš„ä¸€åŠï¼ŒHashMapæ‰©å®¹è‡³åŸæ¥çš„ä¸¤å€***
  - ä¼˜åŒ–ï¼šæŠŠåˆå§‹å€¼è®¾çš„å¤§ä¸€ç‚¹

  ![image-20200831205042601](/assets/imgs/image-20200831205042601.png)



## JUCå¼ºå¤§çš„è¾…åŠ©ç±»è®²è§£

### CountDownLatchå‡å°‘è®¡æ•°

> ä¾‹å­(åšå‡æ³•)ï¼š6ä¸ªåŒå­¦å„ä¸Šå„çš„è‡ªä¹ ï¼Œä¸­é—´æ²¡æœ‰äº¤äº’ã€‚éƒ½èµ°å®Œäº†ç­é•¿æ‰èƒ½å…³é—¨  [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/CountDownLatchDemo.java)

-  CountDownLatchä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå½“ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•æ—¶ï¼Œè¿™äº›çº¿ç¨‹ä¼šé˜»å¡ã€‚
-  å…¶å®ƒçº¿ç¨‹è°ƒç”¨countDownæ–¹æ³•ä¼šå°†è®¡æ•°å™¨å‡1(è°ƒç”¨countDownæ–¹æ³•çš„çº¿ç¨‹ä¸ä¼šé˜»å¡)ï¼Œ
- å½“è®¡æ•°å™¨çš„å€¼å˜ä¸º0æ—¶ï¼Œå› awaitæ–¹æ³•é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œã€‚

### CyclicBarrierå¾ªç¯æ …æ 

> ä¾‹å­(åšåŠ æ³•)ï¼šé›†é½ä¸ƒé¢—é¾™ç å°±èƒ½å¬å”¤ç¥é¾™  [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/CyclicBarrierDemo.java)

- CyclicBarrieçš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ï¼ˆCyclicï¼‰ä½¿ç”¨çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œ ç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚
- çº¿ç¨‹è¿›å…¥å±éšœé€šè¿‡CyclicBarrierçš„await()æ–¹æ³•ã€‚

### Semaphoreä¿¡å·é‡

> ä¾‹å­ï¼šæŠ¢è½¦ä½ï¼Œ7ä¸ªè½¦çº¿ç¨‹æŠ¢4ä¸ªè½¦ä½ï¼Œç„¶åæŒæœ‰3ç§’ï¼Œèµ°ä¸€ä¸ªè¿›ä¸€ä¸ªç›´åˆ°æ¯ä¸ªè½¦éƒ½æŠ¢åˆ°ä¸€æ¬¡ã€‚  [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/SemaphoreDemo.java)

åœ¨ä¿¡å·é‡ä¸Šæˆ‘ä»¬å®šä¹‰ä¸¤ç§æ“ä½œï¼š

-  acquireï¼ˆè·å–ï¼‰ å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨acquireæ“ä½œæ—¶ï¼Œå®ƒè¦ä¹ˆé€šè¿‡æˆåŠŸè·å–ä¿¡å·é‡ï¼ˆä¿¡å·é‡å‡1ï¼‰ï¼Œè¦ä¹ˆä¸€ç›´ç­‰ä¸‹å»ï¼Œç›´åˆ°æœ‰çº¿ç¨‹é‡Šæ”¾ä¿¡å·é‡ï¼Œæˆ–è¶…æ—¶ã€‚

- releaseï¼ˆé‡Šæ”¾ï¼‰å®é™…ä¸Šä¼šå°†ä¿¡å·é‡çš„å€¼åŠ 1ï¼Œç„¶åå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚
-  ***ä¿¡å·é‡ä¸»è¦ç”¨äºä¸¤ä¸ªç›®çš„ï¼Œä¸€ä¸ªæ˜¯ç”¨äºå¤šä¸ªå…±äº«èµ„æºçš„äº’æ–¥ä½¿ç”¨ï¼Œå¦ä¸€ä¸ªç”¨äºå¹¶å‘çº¿ç¨‹æ•°çš„æ§åˆ¶ã€‚***

### LockSupport

> ç”¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªè¾“å‡ºå­—æ¯ï¼Œä¸€ä¸ªè¾“å‡ºæ•°å­—ï¼Œäº¤æ›¿è¾“å‡º1A2B3C...26Z  [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/interview/OutputByTurns.java)

LockSupport å’Œ CAS æ˜¯Javaå¹¶å‘åŒ…ä¸­å¾ˆå¤šå¹¶å‘å·¥å…·æ§åˆ¶æœºåˆ¶çš„åŸºç¡€ï¼Œå®ƒä»¬åº•å±‚å…¶å®éƒ½æ˜¯ä¾èµ–Unsafeå®ç°ã€‚

LockSupportç±»çš„æ ¸å¿ƒæ–¹æ³•å…¶å®å°±ä¸¤ä¸ªï¼š

- park() æ–¹æ³•ç”¨æ¥é˜»å¡å½“å‰è°ƒç”¨çº¿ç¨‹ã€‚
- unpark() æ–¹æ³•ç”¨äºå”¤é†’æŒ‡å®šçº¿ç¨‹ã€‚ âš ï¸ ***å¯ä»¥å…ˆå”¤é†’ï¼Œé‚£ä¹ˆä¸‹æ¬¡çš„park()å°±ä¸é˜»å¡ï¼›notify()åˆ™ä¸è¡Œã€‚***

***è¿™å…¶å®å’ŒObjectç±»çš„wait()å’Œnotify()æ–¹æ³•æœ‰äº›ç±»ä¼¼ï¼Œä½†æ˜¯LockSupportçš„è¿™ä¸¤ç§æ–¹æ³•ä»è¯­æ„ä¸Šè®²æ¯”Objectç±»çš„æ–¹æ³•æ›´æ¸…æ™°ï¼Œè€Œä¸”å¯ä»¥é’ˆå¯¹æŒ‡å®šçº¿ç¨‹è¿›è¡Œé˜»å¡å’Œå”¤é†’ã€‚***



## è¯»å†™é”ReentrantReadWriteLock

> æºç åˆ†æï¼šhttps://blog.csdn.net/fxkcsdn/article/details/82217760

å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥ä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥å¯ä»¥åŒæ—¶è¿›è¡Œã€‚ä½†æ˜¯å¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™ã€‚ [code]()

æ€»ç»“ï¼š

- ä¸Šé”å’Œé‡Šæ”¾é”éƒ½æ˜¯é€šè¿‡AQSæ¥å®ç°çš„

- çº¿ç¨‹è¿›å…¥è¯»é”çš„å‰ææ¡ä»¶ï¼š
  - æ²¡æœ‰å…¶ä»–çº¿ç¨‹çš„å†™é”
  - æ²¡æœ‰å†™è¯·æ±‚æˆ–è€…**æœ‰å†™è¯·æ±‚ï¼Œä½†è°ƒç”¨çº¿ç¨‹å’ŒæŒæœ‰é”çš„çº¿ç¨‹æ˜¯åŒä¸€ä¸ª**
- çº¿ç¨‹è¿›å…¥å†™é”çš„å‰ææ¡ä»¶ï¼š
  - æ²¡æœ‰å…¶ä»–çº¿ç¨‹çš„è¯»é”
  - æ²¡æœ‰å…¶ä»–çº¿ç¨‹çš„å†™é”

- è€Œè¯»å†™é”æœ‰ä»¥ä¸‹ä¸‰ä¸ªé‡è¦çš„ç‰¹æ€§ï¼š
  - å…¬å¹³é€‰æ‹©æ€§ï¼šæ”¯æŒéå…¬å¹³ï¼ˆé»˜è®¤ï¼‰å’Œå…¬å¹³çš„é”è·å–æ–¹å¼ï¼Œååé‡è¿˜æ˜¯éå…¬å¹³ä¼˜äºå…¬å¹³ã€‚
    - å¦‚æœæ–°æ¥çš„çº¿ç¨‹å¿…é¡»å…ˆå…¥é˜Ÿæ‰èƒ½è·å–é”å°±æ˜¯å…¬å¹³çš„ï¼Œå¦åˆ™å°±æ˜¯éå…¬å¹³çš„ã€‚
  - è¯»é”å’Œå†™é”éƒ½æ”¯æŒçº¿ç¨‹é‡è¿›å…¥ã€‚å¯é‡å…¥å°±æ˜¯è¯´æŸä¸ªçº¿ç¨‹å·²ç»è·å¾—æŸä¸ªé”ï¼Œå¯ä»¥å†æ¬¡è·å–é”è€Œä¸ä¼šå‡ºç°æ­»é”
  - é”é™çº§ï¼šéµå¾ªè·å–å†™é”ã€è·å–è¯»é”å†é‡Šæ”¾å†™é”çš„æ¬¡åºï¼Œå†™é”èƒ½å¤Ÿé™çº§æˆä¸ºè¯»é”ã€‚



## é˜»å¡é˜Ÿåˆ—BlockingQueue

é˜»å¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œåœ¨æ•°æ®ç»“æ„ä¸­èµ·çš„ä½œç”¨å¦‚ä¸‹å›¾ï¼š

![image-20200901130348078](/assets/imgs/image-20200901130348078.png)

- çº¿ç¨‹1å¾€é˜»å¡é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ ï¼Œçº¿ç¨‹2ä»é˜»å¡é˜Ÿåˆ—é‡Œç§»é™¤å…ƒç´  
- è¯•å›¾ä»ç©ºçš„é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„çº¿ç¨‹å°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹å¾€ç©ºçš„é˜Ÿåˆ—æ’å…¥æ–°çš„å…ƒç´ 
- è¯•å›¾å‘å·²æ»¡çš„é˜Ÿåˆ—ä¸­æ·»åŠ æ–°å…ƒç´ çš„çº¿ç¨‹å°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ æˆ–è€…å®Œå…¨æ¸…ç©ºï¼Œä½¿é˜Ÿåˆ—å˜å¾—ç©ºé—²èµ·æ¥å¹¶åç»­æ–°å¢

### é˜»å¡é˜Ÿåˆ—çš„ç”¨å¤„

åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼šæ‰€è°“é˜»å¡ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šæŒ‚èµ·çº¿ç¨‹ï¼ˆå³é˜»å¡ï¼‰ï¼Œä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œè¢«æŒ‚èµ·çš„çº¿ç¨‹åˆä¼šè‡ªåŠ¨è¢«å”¤èµ·ã€‚

***å¥½å¤„æ˜¯æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä»€ä¹ˆæ—¶å€™éœ€è¦é˜»å¡çº¿ç¨‹***ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å”¤é†’çº¿ç¨‹ï¼Œå› ä¸ºè¿™ä¸€åˆ‡BlockingQueueéƒ½ç»™ä½ ä¸€æ‰‹åŒ…åŠäº†ã€‚åœ¨concurrentåŒ…å‘å¸ƒä»¥å‰ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬æ¯ä¸ªç¨‹åºå‘˜éƒ½å¿…é¡»å»è‡ªå·±æ§åˆ¶è¿™äº›ç»†èŠ‚ï¼Œå°¤å…¶è¿˜è¦å…¼é¡¾æ•ˆç‡å’Œçº¿ç¨‹å®‰å…¨ï¼Œè€Œè¿™ä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸å°çš„å¤æ‚åº¦ã€‚

### æ¶æ„æ¢³ç†ã€ç§ç±»åˆ†æ

- ***ArrayBlockingQueueï¼šç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚***
- ***LinkedBlockingQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œï¼ˆä½†å¤§å°é»˜è®¤å€¼ä¸ºinteger.MAX_VALUEï¼‰é˜»å¡é˜Ÿåˆ—ã€‚***
- PriorityBlockingQueueï¼šæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚
- DelayQueueï¼šä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚
- ***SynchronousQueueï¼šä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¹Ÿå³å•ä¸ªå…ƒç´ çš„é˜Ÿåˆ—ã€‚***
- LinkedTransferQueueï¼šç”±é“¾è¡¨ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚
- LinkedBlocking**Deque**ï¼šç”±é“¾è¡¨ç»„æˆçš„**åŒå‘**é˜»å¡é˜Ÿåˆ—ã€‚

### BlockingQueueæ ¸å¿ƒæ–¹æ³•

![image-20200901131722246](/assets/imgs/image-20200901131722246.png)

**æŠ›å‡ºå¼‚å¸¸**

- å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå†å¾€é˜Ÿåˆ—é‡Œaddæ’å…¥å…ƒç´ ä¼šæŠ›IllegalStateException:Queue full
- å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œå†å¾€é˜Ÿåˆ—é‡Œremoveç§»é™¤å…ƒç´ ä¼šæŠ›NoSuchElementException

**ç‰¹æ®Šå€¼**

- æ’å…¥æ–¹æ³•ï¼ŒæˆåŠŸtureå¤±è´¥false
- ç§»é™¤æ–¹æ³•ï¼ŒæˆåŠŸè¿”å›å‡ºé˜Ÿåˆ—çš„å…ƒç´ ï¼Œé˜Ÿåˆ—é‡Œæ²¡æœ‰å°±è¿”å›null

**ä¸€ç›´é˜»å¡**

- å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹ç»§ç»­å¾€é˜Ÿåˆ—é‡Œputå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ç›´åˆ°putæ•°æ®æˆ–å“åº”ä¸­æ–­é€€å‡º
- å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œtakeå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—å¯ç”¨

**è¶…æ—¶é€€å‡º**

- å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œè¶…è¿‡é™æ—¶åç”Ÿäº§è€…çº¿ç¨‹ä¼šé€€å‡º

---



## ThreadPoolçº¿ç¨‹æ±  ğŸ¤”

> çº¿ç¨‹æ±  = ä¸€å †çº¿ç¨‹+ ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—

### **ä¸ºä»€ä¹ˆç”¨çº¿ç¨‹æ± ï¼Ÿ**

ä¾‹å­ï¼š10å¹´å‰å•æ ¸CPUç”µè„‘ï¼Œå‡çš„å¤šçº¿ç¨‹ï¼Œåƒé©¬æˆå›¢å°ä¸‘ç©å¤šä¸ªçƒï¼ŒCPUéœ€è¦æ¥å›åˆ‡æ¢ã€‚ç°åœ¨æ˜¯å¤šæ ¸ç”µè„‘ï¼Œå¤šä¸ªçº¿ç¨‹å„è‡ªè·‘åœ¨ç‹¬ç«‹çš„CPUä¸Šï¼Œä¸ç”¨åˆ‡æ¢æ•ˆç‡é«˜ã€‚ [code](https://github.com/Silincee/-/blob/master/src/main/java/com/silince/juc/MyThreadPoolDemo.java)

**çº¿ç¨‹æ± çš„ä¼˜åŠ¿ï¼š**

çº¿ç¨‹æ± åšçš„å·¥ä½œåªè¦æ˜¯æ§åˆ¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ï¼Œ***å¤„ç†è¿‡ç¨‹ä¸­å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—***ï¼Œç„¶ååœ¨çº¿ç¨‹åˆ›å»ºåå¯åŠ¨è¿™äº›ä»»åŠ¡ï¼Œ***å¦‚æœçº¿ç¨‹æ•°é‡è¶…è¿‡äº†æœ€å¤§æ•°é‡ï¼Œè¶…å‡ºæ•°é‡çš„çº¿ç¨‹æ’é˜Ÿç­‰å€™***ï¼Œç­‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå†ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚

**å®ƒçš„ä¸»è¦ç‰¹ç‚¹ä¸ºï¼šçº¿ç¨‹å¤ç”¨;æ§åˆ¶æœ€å¤§å¹¶å‘æ•°;ç®¡ç†çº¿ç¨‹ã€‚**

ç¬¬ä¸€ï¼šé™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„é”€è€—ã€‚

ç¬¬äºŒï¼šæé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰å¾…çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚

ç¬¬ä¸‰ï¼šæé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šé”€è€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚



### çº¿ç¨‹æ± å¦‚ä½•ä½¿ç”¨

***Javaä¸­çš„çº¿ç¨‹æ± æ˜¯é€šè¿‡Executoræ¡†æ¶å®ç°çš„ï¼Œè¯¥æ¡†æ¶ä¸­ç”¨åˆ°äº†Executorï¼ŒExecutors(å·¥å…·ç±»)ï¼ŒExecutorServiceï¼ŒThreadPoolExecutorè¿™å‡ ä¸ªç±»***ã€‚

![image-20200901144207635](/assets/imgs/image-20200901144207635.png)

- **Executors.newFixedThreadPool(int)**
  - æ‰§è¡Œé•¿æœŸä»»åŠ¡æ€§èƒ½å¥½ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¸€æ± æœ‰Nä¸ªå›ºå®šçš„çº¿ç¨‹ï¼Œæœ‰å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹
- **Executors.newSingleThreadExecutor()**
  - ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œï¼Œä¸€æ± ä¸€çº¿ç¨‹
- **Executors.newCachedThreadPool()**
  - æ‰§è¡Œå¾ˆå¤šçŸ­æœŸå¼‚æ­¥ä»»åŠ¡ï¼Œçº¿ç¨‹æ± æ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹ï¼Œä½†åœ¨å…ˆå‰æ„å»ºçš„çº¿ç¨‹å¯ç”¨æ—¶å°†é‡ç”¨å®ƒä»¬ã€‚å¯æ‰©å®¹ï¼Œé‡å¼ºåˆ™å¼ºã€‚
- Executors.newScheduledThread(int corePoolSize)
  - è¿”å›çš„æ˜¯ScheduledExecutorService å¯¹è±¡ï¼Œå¯ä»¥æŒ‡å®šçº¿ç¨‹æ•°é‡ã€‚å’ŒFixedXxx ä¸åŒçš„æ˜¯ï¼Œè¯¥å¯¹è±¡å¯ä»¥æ ¹æ®æ—¶é—´éœ€è¦å¯¹çº¿ç¨‹è¿›è¡Œè°ƒåº¦
- Executors.SingleThreadScheduledExecutor()
  - å’Œä¸Šè¿°ç±»ä¼¼ï¼Œåªä¸è¿‡å•æ± å•çº¿ç¨‹ï¼Œä¾æ—§å¯ä»¥è¿›è¡Œæ—¶é—´è°ƒåº¦ï¼›ï¼ˆåœ¨æŸä¸ªå›ºå®šçš„å»¶æ—¶è¿‡åè¿›è¡Œæ‰§è¡Œï¼Œæˆ–è€…å‘¨æœŸæ€§æ‰§è¡Œï¼‰



### çº¿ç¨‹æ± åº•å±‚å·¥ä½œåŸç†

#### **çº¿ç¨‹æ± çš„åº•å±‚å®ç°**

***newFixedThreadPool(int)ã€newSingleThreadExecutor()ã€newCachedThreadPool()åº•å±‚å®ç°éƒ½æ˜¯newFixedThreadPoolã€‚***

![image-20200901152207257](/assets/imgs/image-20200901152207257.png)

#### çº¿ç¨‹æ± å‡ ä¸ªé‡è¦å‚æ•°

1. ***corePoolSize***ï¼šçº¿ç¨‹æ± ä¸­çš„å¸¸é©»***æ ¸å¿ƒçº¿ç¨‹æ•°***
2. ***maximumPoolSize***ï¼šçº¿ç¨‹æ± ä¸­èƒ½å¤Ÿå®¹çº³åŒæ—¶æ‰§è¡Œçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ­¤å€¼å¿…é¡»å¤§äºç­‰äº1
   -  âš ï¸ CPUå¯†é›†å‹ï¼šè®¾ä¸º CPUå†…æ ¸æ•° + 1ï¼›Runtime.getRuntime().availableProcessors()+1
   - IOå¯†é›†å‹ï¼šè®¾ä¸ºCPUæ ¸æ•°/é˜»å¡ç³»æ•°
3. ***keepAliveTime***ï¼šå¤šä½™çš„ç©ºé—²çº¿ç¨‹çš„å­˜æ´»æ—¶é—´å½“å‰æ± ä¸­çº¿ç¨‹æ•°é‡è¶…è¿‡corePoolSizeæ—¶ï¼Œå½“ç©ºé—²æ—¶é—´è¾¾åˆ°keepAliveTimeæ—¶ï¼Œå¤šä½™çº¿ç¨‹ä¼šè¢«é”€æ¯ç›´åˆ°åªå‰©ä¸‹corePoolSizeä¸ªçº¿ç¨‹ä¸ºæ­¢
4. ***unit***ï¼škeepAliveTimeçš„å•ä½
5. ***workQueue***ï¼šä»»åŠ¡é˜Ÿåˆ—ï¼Œè¢«æäº¤ä½†å°šæœªè¢«æ‰§è¡Œçš„ä»»åŠ¡
6. ***threadFactory***ï¼šè¡¨ç¤ºç”Ÿæˆçº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹ï¼Œ***ä¸€èˆ¬é»˜è®¤çš„å³å¯***
7. ***handler***ï¼šæ‹’ç»ç­–ç•¥ï¼Œè¡¨ç¤ºå½“é˜Ÿåˆ—æ»¡äº†ï¼Œå¹¶ä¸”å·¥ä½œçº¿ç¨‹å¤§äºç­‰äºçº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°ï¼ˆmaximumPoolSizeï¼‰æ—¶å¦‚ä½•æ¥æ‹’ç»è¯·æ±‚æ‰§è¡Œçš„runnableçš„ç­–ç•¥

```java
// ThreadPoolExecutor æ„é€ æ–¹æ³•    
public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue<Runnable> workQueue,
                              ThreadFactory threadFactory,
                              RejectedExecutionHandler handler) {
        if (corePoolSize < 0 ||
            maximumPoolSize <= 0 ||
            maximumPoolSize < corePoolSize ||
            keepAliveTime < 0)
            throw new IllegalArgumentException();
        if (workQueue == null || threadFactory == null || handler == null)
            throw new NullPointerException();
        this.acc = System.getSecurityManager() == null ?
                null :
                AccessController.getContext();
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.workQueue = workQueue;
        this.keepAliveTime = unit.toNanos(keepAliveTime);
        this.threadFactory = threadFactory;
        this.handler = handler;
    }
```

#### åº•å±‚åŸç† ğŸ¤”

1. åœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œå¼€å§‹ç­‰å¾…è¯·æ±‚ã€‚
2. å½“è°ƒç”¨execute()æ–¹æ³•æ·»åŠ ä¸€ä¸ªè¯·æ±‚ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå‡ºå¦‚ä¸‹åˆ¤æ–­ï¼š
   - å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å°äºcorePoolSizeï¼Œé‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼›
   - å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºcorePoolSizeï¼Œé‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼›
   - **å¦‚æœè¿™ä¸ªæ—¶å€™é˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¿˜å°äºmaximumPoolSize**ï¼Œé‚£ä¹ˆè¿˜æ˜¯è¦åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ç«‹åˆ»è¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼›
   - **å¦‚æœé˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºmaximumPoolSize**ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šå¯åŠ¨é¥±å’Œæ‹’ç»ç­–ç•¥æ¥æ‰§è¡Œã€‚
3. å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚
4. å½“ä¸€ä¸ªçº¿ç¨‹æ— äº‹å¯åšè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼ˆkeepAliveTimeï¼‰æ—¶ï¼Œçº¿ç¨‹ä¼šåˆ¤æ–­ï¼š
   - å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äºcorePoolSizeï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¢«åœæ‰ã€‚
   - ***æ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œå®ƒæœ€ç»ˆä¼šæ”¶ç¼©åˆ°corePoolSizeçš„å¤§å°***

![image-20200901164445912](/assets/imgs/image-20200901164445912.png)

![image-20200901164926612](/assets/imgs/image-20200901164926612.png)



### çº¿ç¨‹æ± ç”¨å“ªä¸ªï¼Ÿç”Ÿäº§ä¸­å¦‚è®¾ç½®åˆç†å‚æ•° ğŸ¤”

#### çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥

- ***AbortPolicy(é»˜è®¤)***ï¼šç›´æ¥æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸é˜»æ­¢ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
- ***CallerRunsPolicy***ï¼šâ€œè°ƒç”¨è€…è¿è¡Œâ€ä¸€ç§è°ƒèŠ‚æœºåˆ¶ï¼Œè¯¥ç­–ç•¥æ—¢ä¸ä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯å°†æŸäº›ä»»åŠ¡å›é€€åˆ°è°ƒç”¨è€…(æ¯”å¦‚mainçº¿ç¨‹)ï¼Œä»è€Œé™ä½æ–°ä»»åŠ¡çš„æµé‡ã€‚
- ***DiscardOldestPolicy***ï¼š***æŠ›å¼ƒé˜Ÿåˆ—ä¸­ç­‰å¾…æœ€ä¹…çš„ä»»åŠ¡***ï¼Œç„¶åæŠŠå½“å‰ä»»åŠ¡åŠ äººé˜Ÿåˆ—ä¸­å°è¯•å†æ¬¡æäº¤å½“å‰ä»»åŠ¡ã€‚
- ***DiscardPolicy***ï¼šè¯¥ç­–ç•¥å·å·åœ°***ä¸¢å¼ƒæ— æ³•å¤„ç†çš„ä»»åŠ¡***ï¼Œä¸äºˆä»»ä½•å¤„ç†ä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœå…è®¸ä»»åŠ¡ä¸¢å¤±ï¼Œè¿™æ˜¯æœ€å¥½çš„ä¸€ç§ç­–ç•¥ã€‚



#### åœ¨å·¥ä½œä¸­å•ä¸€çš„/å›ºå®šæ•°çš„/å¯å˜çš„ä¸‰ç§åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹æ³•å“ªä¸ªç”¨çš„å¤šï¼Ÿè¶…çº§å¤§å‘ ğŸ¤”

ASNSWERï¼šç­”æ¡ˆæ˜¯ä¸€ä¸ªéƒ½ä¸ç”¨ï¼Œæˆ‘ä»¬å·¥ä½œä¸­åªèƒ½ä½¿ç”¨è‡ªå®šä¹‰çš„.

![image-20200901172248771](/assets/imgs/image-20200901172248771.png)

**newFixedThreadPool()çš„è¯¦ç»†è¯´æ˜ï¼š**
å¯é‡ç”¨å›ºå®šä¸ªæ•°çš„çº¿ç¨‹æ± ï¼Œå½“å½“å‰çº¿ç¨‹æ•°å¤§äºæ€»çº¿ç¨‹æ•°æ—¶ä¼šè¿›è¡Œç­‰å¾…ï¼Œç­‰å¾…çº¿ç¨‹æ± å†…çš„çº¿ç¨‹æ‰§è¡Œå®Œï¼Œç›¸å¯¹æ¥è¯´å ç”¨å†…å­˜å°‘ï¼Œå› ä¸ºå¦‚æœç­‰å¾…çº¿ç¨‹æ•°é‡è¿‡å¤šï¼Œä¹Ÿæ˜¯ç›¸å¯¹è€—åºŸèµ„æºçš„ã€‚

```java
// newFixedThreadPool æ„é€ æ–¹æ³•
public static ExecutorService newFixedThreadPool(int nThreads) {
        return new ThreadPoolExecutor(nThreads, nThreads,
                                      0L, TimeUnit.MILLISECONDS,
                                      new LinkedBlockingQueue<Runnable>());
    }
// å…¶ä¸­newçš„é˜»å¡é˜Ÿåˆ—ï¼Œ âš ï¸ é»˜è®¤å…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUEï¼
public LinkedBlockingQueue() {
        this(Integer.MAX_VALUE);
    }   
```





#### åœ¨å·¥ä½œä¸­å¦‚ä½•ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæ˜¯å¦è‡ªå®šä¹‰è¿‡çº¿ç¨‹æ± 

```java
public class MyThreadPoolDemo2 {
    public static void main(String[] args) {
        ExecutorService threadPool = new ThreadPoolExecutor(2,
                Runtime.getRuntime().availableProcessors()+1, // âš ï¸ CPUå¯†é›†å‹ï¼šCPUå†…æ ¸æ•° + 1ï¼›IOå¯†é›†å‹ï¼šCPUæ ¸æ•°/é˜»å¡ç³»æ•°
                2L, TimeUnit.SECONDS,
                new LinkedBlockingQueue<>(3), //é˜»å¡é˜Ÿåˆ—é•¿åº¦ä¸º3ï¼Œé»˜è®¤çš„æ˜¯Integer.MAX_VALUE
                Executors.defaultThreadFactory(),
                new ThreadPoolExecutor.AbortPolicy());

        try {
            // âš ï¸ å¯æ‰§è¡Œæœ€å¤§çº¿ç¨‹æ•°= maximumPoolSize + capacity
            for (int i = 0; i < 9; i++) {
                threadPool.execute(() -> {
                    System.out.println(Thread.currentThread().getName() + "\tåŠç†ä¸šåŠ¡");
                });
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            threadPool.shutdown();
        }
    }
}

Error:java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2063)
```



## åˆ†æ”¯åˆå¹¶æ¡†æ¶

### åŸç†ï¼š

- Forkï¼šæŠŠä¸€ä¸ªå¤æ‚ä»»åŠ¡è¿›è¡Œåˆ†æ‹†ï¼Œå¤§äº‹åŒ–å°

- Joinï¼šæŠŠåˆ†æ‹†ä»»åŠ¡çš„ç»“æœè¿›è¡Œåˆå¹¶

### ç›¸å…³ç±»

- ForkJoinPoolï¼šåˆ†æ”¯åˆå¹¶æ±   ç±»æ¯”=>  çº¿ç¨‹æ± 
- ForkJoinTaskï¼šForkJoinTask  ç±»æ¯”=>  FutureTask
- RecursiveTaskï¼šé€’å½’ä»»åŠ¡ï¼šç»§æ‰¿åå¯ä»¥å®ç°é€’å½’(è‡ªå·±è°ƒè‡ªå·±)è°ƒç”¨çš„ä»»åŠ¡

### ä¾‹å­

```java
// å®ç°1+2+...+100 çš„åˆ†æ²»è®¡ç®—
public class ForkJoinDemo {
    public static void main(String[] args) throws Exception {
        MyTask myTask = new MyTask(0, 100);
        ForkJoinPool threadPool = new ForkJoinPool();

        // å‘æ± å­é€’äº¤ä»»åŠ¡
        ForkJoinTask<Integer> forkJoinTask = threadPool.submit(myTask);
        System.out.println(forkJoinTask.get());

        threadPool.shutdown();
    }
}

class MyTask extends RecursiveTask<Integer> {
    private static final Integer ADJUST_VALUE = 10;
    private int begin;
    private int end;
    private int result;

    public MyTask(int begin, int end) {
        this.begin = begin;
        this.end = end;
    }

    @Override
    protected Integer compute() {
        // è®¡ç®—å°æ—¶ä¸è§¦å‘åˆ†æ²»
        if ((end - begin) <= ADJUST_VALUE) {
            for (int i = begin; i <= end; i++) {
                result = result + i;
            }
        } else {
            int middle = (end + begin) / 2;
            MyTask task01 = new MyTask(begin, middle);
            MyTask task02 = new MyTask(middle + 1, end);
            task01.fork(); // è°ƒå®Œforkè¿˜æ˜¯å›æ¥è°ƒç”¨compute()
            task02.fork();
            result = task01.join() + task02.join();
        }
        return result;
    }
}
```



## å¼‚æ­¥å›è°ƒ

### åŸç†

åŒæ­¥ã€å¼‚æ­¥ã€å¼‚æ­¥å›è°ƒ

```java
public class CompletableFutureDemo {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        // å¼‚æ­¥å›è°ƒ æ— è¿”å›å€¼
        CompletableFuture<Void> completableFuture = CompletableFuture.runAsync(() -> {
            System.out.println(Thread.currentThread().getName() + "æ²¡æœ‰è¿”å›, update mysql ok");
        });
        System.out.println(completableFuture.get());

        // å¼‚æ­¥å›è°ƒ æœ‰è¿”å›å€¼
        CompletableFuture<Integer> completableFuture1 = CompletableFuture.supplyAsync(() -> {
            System.out.println(Thread.currentThread().getName() + "æœ‰è¿”å›, insert mysql ok");
            int age=10/0;
            return 1024;
        });
        completableFuture1.whenComplete((t,u)->{
            System.out.println("***t: "+t);
            System.out.println("***u: "+u);
        }).exceptionally(f->{  //å¼‚å¸¸åˆ†æ”¯
            System.out.println("***exception: "+f.getMessage());
            return 4444;
        }).get();
    }
}
```

**æ­£å¸¸å›è°ƒç»“æœï¼š**

ForkJoinPool.commonPool-worker-1æ²¡æœ‰è¿”å›, update mysql ok
null
ForkJoinPool.commonPool-worker-1æœ‰è¿”å›, insert mysql ok
***t: 1024
***u: null

**å¼‚å¸¸å›è°ƒç»“æœï¼š**

ForkJoinPool.commonPool-worker-1æ²¡æœ‰è¿”å›, update mysql ok
null
ForkJoinPool.commonPool-worker-1æœ‰è¿”å›, insert mysql ok
***t: null
***u: java.util.concurrent.CompletionException: java.lang.ArithmeticException: / by zero
***exception: java.lang.ArithmeticException: / by zero

