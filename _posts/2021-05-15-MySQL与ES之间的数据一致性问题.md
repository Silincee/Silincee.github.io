---
layout: post
title: "MySQL与ES之间的数据一致性问题"
date: 2021-05-15 11:23:16 +0800--
categories: [Java, 数据库, ]
tags: [Elasticsearch, Mysql,]  
---

# 前言

为什么我们要将数据从 MySQL 实时同步到 ES ，本质是什么？相对于数据去规范化的其他几种方案，数据迁移同步方式存在以下几个优点，也是其成为目前业界主流方式的原因：

- **稳定性好**：迁移同步对主数据库的操作主要是进行数据和日志的顺序读取，同时并发小，对主数据库稳定性影响较小(较多的下游订阅可能在网络层面存在影响，一般用消息解决)。另外日志(Binlog/WAL/Redo 等)可重放特质，让下游丢数据的可能性大大减小(处理好幂等的情况下)
- **业务解耦**：一般而言主数据库更多承载事务型操作，而下游数据系统承载运营等层面的业务, 典型如电商的买家侧和卖家侧业务
- **业务侵入小**：数据迁移同步对业务无侵入，双端对接标准数据库(源)，可以便利地找到开源、商业、云等各个方向的成熟解决方案或产品
- **业务适配性好**：某些数据迁移同步产品能够嵌入业务逻辑，让下游获取到更加贴近业务的数据，从而让数据服务更加有效和便捷

# 数据迁移同步模型

## 订阅消费



![image-20210517155636453](/Users/silince/Develop/博客/blog_to_git/assets/imgs/image-20210517155636453.png)

优点：

- **堆积能力**：由于引入了消息队列，所以整个链路是具备变更数据的堆积能力的。假设变更数据消费的比较慢，MySQL 本地较老的 binlog 文件由于磁盘空间的不足而被删除时，消息队列中的数据仍然存在，数据同步仍然可以正常进行
- **数据分发能力**：引入消息队列后可以支持多方订阅。如果下游多个应用都依赖源端的变更数据，可以订阅同一份 topic 即可
- **数据加工能力**：由于变更数据是由下游消费者订阅，因此订阅后可以灵活的做一些数据加工。例如从外部调用微服务接口或者反查一些数据来做数据加工都是比较方便的

缺点：

- **运维成本相对较高**：包含了较多的组件和应用，运维保障相对复杂。
- **稳定性风险较高**：一环出问题会导致整个数据同步链路的稳定性受到影响。而且排查和定位问题也会比较困难。



## 端到端直连

![image-20210517155816368](/Users/silince/Develop/博客/blog_to_git/assets/imgs/image-20210517155816368.png)

优点：

- **低延迟**：端到端的直接同步，链路较短，延迟低
- **稳定性好**：链路组件少，出问题概率较低，定位排查均比较容易。适合对数据精确性高的严苛场景。
- **功能拓展性强**：对端写入消息系统，模拟订阅模式，可扩展性强
- **运维部署简单**：链路组件少，部署运维更简单



## 如何选择

如果没有众多的下游数据订阅，**建议采用直连模式**。数据同步链路往往置于在线业务中，随着业务规模以及重要性逐渐加大，链路 **稳定性** 更为重要些。另外 **端到端模式** 只要支持对端数据源为消息中间件，可立刻实现订阅模式，数据加工能力在某些数据迁移同步产品上可通过上传业务代码运行的方式解决。

数据架构在满足业务需求的同时，**简洁**和**清晰**能够让系统更加易于维护和排查，当遇到链路每天同步几千万条上亿条数据、偶发丢几条需要排查，或同步链路卡住不同步等情况，端到端方式往往体现出相当大的优势。



参考：

[MySQL 数据实时同步到 Elasticsearch 的技术方案选型和思考](https://www.infoq.cn/article/1afyz3b6hnhprrg12833)

