---
layout: post
title:  "å †"
date:   2020-08-02 08:10:06 +0800--
categories: [Java]
tags: [JVM, ]  
---

# å †

> æ¥æºï¼šå°šç¡…è°·å®‹çº¢åº·JVMæ•™ç¨‹

## å †çš„æ ¸å¿ƒæ¦‚å¿µ

***å †é’ˆå¯¹ä¸€ä¸ªJVMè¿›ç¨‹æ¥è¯´æ˜¯å”¯ä¸€çš„ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªJVMï¼Œä½†æ˜¯è¿›ç¨‹åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œä»–ä»¬æ˜¯å…±äº«åŒä¸€å †ç©ºé—´çš„ã€‚***

![image-20200706195127740](/assets/imgs/image-20200706195127740.png)

***ä¸€ä¸ªJVMå®ä¾‹åªå­˜åœ¨ä¸€ä¸ªå †å†…å­˜ï¼Œå †ä¹Ÿæ˜¯Javaå†…å­˜ç®¡ç†çš„æ ¸å¿ƒåŒºåŸŸã€‚***

Javaå †åŒºåœ¨JVMå¯åŠ¨çš„æ—¶å€™å³è¢«åˆ›å»ºï¼Œå…¶ç©ºé—´å¤§å°ä¹Ÿå°±ç¡®å®šäº†ã€‚æ˜¯JVMç®¡ç†çš„æœ€å¤§ä¸€å—å†…å­˜ç©ºé—´ã€‚

- å †å†…å­˜çš„å¤§å°æ˜¯å¯ä»¥è°ƒèŠ‚çš„ã€‚

***ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹è§„å®šï¼Œå †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œä½†åœ¨é€»è¾‘ä¸Šå®ƒåº”è¯¥è¢«è§†ä¸ºè¿ç»­çš„ã€‚***

æ‰€æœ‰çš„çº¿ç¨‹å…±äº«Javaå †ï¼Œåœ¨è¿™é‡Œè¿˜å¯ä»¥åˆ’åˆ†çº¿ç¨‹ç§æœ‰çš„ç¼“å†²åŒºï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰ã€‚

> -Xms10mï¼šæœ€å°å †å†…å­˜
>
> -Xmx10mï¼šæœ€å¤§å †å†…å­˜

ä¸‹å›¾å°±æ˜¯ä½¿ç”¨ï¼šJava VisualVMæŸ¥çœ‹å †ç©ºé—´çš„å†…å®¹ï¼Œé€šè¿‡ jdk binæä¾›çš„æ’ä»¶

![image-20200706200739392](/assets/imgs/image-20200706200739392.png)

ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å¯¹Javaå †çš„æè¿°æ˜¯ï¼šæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½åº”å½“åœ¨è¿è¡Œæ—¶åˆ†é…åœ¨å †ä¸Šã€‚ï¼ˆThe heap is the run-time data area from which memory for all class instances and arrays is allocatedï¼‰

***æˆ‘è¦è¯´çš„æ˜¯ï¼šâ€œå‡ ä¹â€æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚â€”â€”â€”ä»å®é™…ä½¿ç”¨è§’åº¦çœ‹çš„ã€‚***

- ***å› ä¸ºè¿˜æœ‰ä¸€äº›å¯¹è±¡æ˜¯åœ¨æ ˆä¸Šåˆ†é…çš„***

æ•°ç»„å’Œå¯¹è±¡å¯èƒ½æ°¸è¿œä¸ä¼šå­˜å‚¨åœ¨æ ˆä¸Šï¼Œå› ä¸ºæ ˆå¸§ä¸­ä¿å­˜å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æŒ‡å‘å¯¹è±¡æˆ–è€…æ•°ç»„åœ¨å †ä¸­çš„ä½ç½®ã€‚

åœ¨æ–¹æ³•ç»“æŸåï¼Œå †ä¸­çš„å¯¹è±¡ä¸ä¼šé©¬ä¸Šè¢«ç§»é™¤ï¼Œä»…ä»…åœ¨åƒåœ¾æ”¶é›†çš„æ—¶å€™æ‰ä¼šè¢«ç§»é™¤ã€‚

- ä¹Ÿå°±æ˜¯è§¦å‘äº†GCçš„æ—¶å€™ï¼Œæ‰ä¼šè¿›è¡Œå›æ”¶
- å¦‚æœå †ä¸­å¯¹è±¡é©¬ä¸Šè¢«å›æ”¶ï¼Œå¯¼è‡´gcçº¿ç¨‹è¿‡äºé¢‘ç¹ï¼Œé‚£ä¹ˆç”¨æˆ·çº¿ç¨‹å°±ä¼šæ”¶åˆ°å½±å“ï¼Œå› ä¸ºæœ‰stop-the-word

***å †ï¼Œæ˜¯GCï¼ˆGarbage Collectionï¼Œåƒåœ¾æ”¶é›†å™¨ï¼‰æ‰§è¡Œåƒåœ¾å›æ”¶çš„é‡ç‚¹åŒºåŸŸã€‚***

![image-20200706201904057](/assets/imgs/image-20200706201904057.png)

### å †å†…å­˜ç»†åˆ†

***Java 7åŠä¹‹å‰å †å†…å­˜é€»è¾‘ä¸Šåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šæ–°ç”ŸåŒº+å…»è€åŒº+æ°¸ä¹…åŒº***

- Young Generation Space æ–°ç”ŸåŒº  Young/New   åˆè¢«åˆ’åˆ†ä¸ºEdenåŒºå’ŒSurvivoråŒº
- Tenure generation space å…»è€åŒº Old/Tenure
- Permanent Spaceæ°¸ä¹…åŒº   Perm

***Java 8åŠä¹‹åå †å†…å­˜é€»è¾‘ä¸Šåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šæ–°ç”ŸåŒºå…»è€åŒº+å…ƒç©ºé—´***

- Young Generation Spaceæ–°ç”ŸåŒº  Young/New  åˆè¢«åˆ’åˆ†ä¸ºEdenåŒºå’ŒSurvivoråŒº
- Tenure generation space å…»è€åŒº  Old/Tenure
- Meta Space  å…ƒç©ºé—´   Meta

***çº¦å®šï¼šæ–°ç”ŸåŒº = æ–°ç”Ÿä»£ = å¹´è½»ä»£   ã€  å…»è€åŒº = è€å¹´åŒº = è€å¹´ä»£ã€ æ°¸ä¹…åŒº = æ°¸ä¹…ä»£***

![image-20200706203419496](/assets/imgs/image-20200706203419496.png)

å †ç©ºé—´å†…éƒ¨ç»“æ„ï¼ŒJDK1.8ä¹‹å‰ä»æ°¸ä¹…ä»£  æ›¿æ¢æˆ å…ƒç©ºé—´

![image-20200706203835403](/assets/imgs/image-20200706203835403.png)





## è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM

Javaå †åŒºç”¨äºå­˜å‚¨Javaå¯¹è±¡å®ä¾‹ï¼Œé‚£ä¹ˆå †çš„å¤§å°åœ¨JVMå¯åŠ¨æ—¶å°±å·²ç»è®¾å®šå¥½äº†ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡é€‰é¡¹"-Xmx"å’Œ"-Xms"æ¥è¿›è¡Œè®¾ç½®ã€‚

- â€œ-Xms"ç”¨äºè¡¨ç¤ºå †åŒºçš„èµ·å§‹å†…å­˜ï¼Œç­‰ä»·äº-xx:InitialHeapSize
- â€œ-Xmx"åˆ™ç”¨äºè¡¨ç¤ºå †åŒºçš„æœ€å¤§å†…å­˜ï¼Œç­‰ä»·äº-XX:MaxHeapSize

ä¸€æ—¦å †åŒºä¸­çš„å†…å­˜å¤§å°è¶…è¿‡â€œ-xmx"æ‰€æŒ‡å®šçš„æœ€å¤§å†…å­˜æ—¶ï¼Œå°†ä¼šæŠ›å‡ºoutofMemoryErrorå¼‚å¸¸ã€‚

é€šå¸¸ä¼šå°†-Xmså’Œ-Xmxä¸¤ä¸ªå‚æ•°é…ç½®ç›¸åŒçš„å€¼ï¼Œå…¶ç›®çš„æ˜¯**ä¸ºäº†èƒ½å¤Ÿåœ¨avaåƒåœ¾å›æ”¶æœºåˆ¶æ¸…ç†å®Œå †åŒºåä¸éœ€è¦é‡æ–°åˆ†éš”è®¡ç®—å †åŒºçš„å¤§å°ï¼Œä»è€Œæé«˜æ€§èƒ½**ã€‚

é»˜è®¤æƒ…å†µä¸‹

- åˆå§‹å†…å­˜å¤§å°ï¼šç‰©ç†ç”µè„‘å†…å­˜å¤§å°/64
- æœ€å¤§å†…å­˜å¤§å°ï¼šç‰©ç†ç”µè„‘å†…å­˜å¤§å°/4

***å¼€å‘ä¸­å»ºè®®å°†åˆå§‹å †å†…å­˜å’Œæœ€å¤§çš„å †å†…å­˜è®¾ç½®æˆç›¸åŒçš„å€¼ã€‚***

```java
/**
 * -Xms ç”¨æ¥è®¾ç½®å †ç©ºé—´ï¼ˆå¹´è½»ä»£+è€å¹´ä»£ï¼‰çš„åˆå§‹å†…å­˜å¤§å°
 *  -Xï¼šæ˜¯jvmè¿è¡Œå‚æ•°
 *  msï¼šmemory start
 * -Xmxï¼šç”¨æ¥è®¾ç½®å †ç©ºé—´ï¼ˆå¹´è½»ä»£+è€å¹´ä»£ï¼‰çš„æœ€å¤§å†…å­˜å¤§å°
 */
public class HeapSpaceInitial {
    public static void main(String[] args) {
        // è¿”å›Javaè™šæ‹Ÿæœºä¸­çš„å †å†…å­˜æ€»é‡
        long initialMemory = Runtime.getRuntime().totalMemory() / 1024 / 1024;
        // è¿”å›Javaè™šæ‹Ÿæœºè¯•å›¾ä½¿ç”¨çš„æœ€å¤§å †å†…å­˜
        long maxMemory = Runtime.getRuntime().maxMemory() / 1024 / 1024;
        System.out.println("-Xms:" + initialMemory + "M");
        System.out.println("-Xmx:" + maxMemory + "M");
    }
}
```

è¾“å‡ºç»“æœ

```
-Xms:245M
-Xmx:3614M
```

å¦‚ä½•æŸ¥çœ‹å †å†…å­˜çš„å†…å­˜åˆ†é…æƒ…å†µ

```
jps  ->  jstat -gc  è¿›ç¨‹id
```

![image-20200706205756045](/assets/imgs/image-20200706205756045.png)

```
-XX:+PrintGCDetails  # æ‰“å°gcç»†èŠ‚ä¿¡æ¯
```

![image-20200706205821919](/assets/imgs/image-20200706205821919.png)

### OutOfMemoryä¸¾ä¾‹

![image-20200706205947535](/assets/imgs/image-20200706205947535.png)

![image-20200706210000461](/assets/imgs/image-20200706210000461.png)

æˆ‘ä»¬ç®€å•çš„å†™ä¸€ä¸ªOOMä¾‹å­

```java
/**
 * OOMæµ‹è¯•
 */
public class OOMTest {
    public static void main(String[] args) {
        List<Integer> list = new ArrayList<>();
        while(true) {
            list.add(999999999);
        }
    }
}

```

ç„¶åè®¾ç½®å¯åŠ¨å‚æ•°

```
-Xms10m -Xmx:10m
```

è¿è¡Œåï¼Œå°±å‡ºç°OOMäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ VisualVMè¿™ä¸ªå·¥å…·æŸ¥çœ‹å…·ä½“æ˜¯ä»€ä¹ˆå‚æ•°é€ æˆçš„OOM

![image-20200706211652779](/assets/imgs/image-20200706211652779.png)

### ğŸ§  å¹´è½»ä»£ä¸è€å¹´ä»£

å­˜å‚¨åœ¨JVMä¸­çš„Javaå¯¹è±¡å¯ä»¥è¢«åˆ’åˆ†ä¸ºä¸¤ç±»ï¼š
- ***ä¸€ç±»æ˜¯ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ç¬æ—¶å¯¹è±¡ï¼Œè¿™ç±»å¯¹è±¡çš„åˆ›å»ºå’Œæ¶ˆäº¡éƒ½éå¸¸è¿…é€Ÿ***
  - ***ç”Ÿå‘½å‘¨æœŸçŸ­çš„ï¼ŒåŠæ—¶å›æ”¶å³å¯***
- ***å¦å¤–ä¸€ç±»å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå´éå¸¸é•¿ï¼Œåœ¨æŸäº›æç«¯çš„æƒ…å†µä¸‹è¿˜èƒ½å¤Ÿä¸JVMçš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´***

Javaå †åŒºè¿›ä¸€æ­¥ç»†åˆ†çš„è¯ï¼Œå¯ä»¥åˆ’åˆ†ä¸ºå¹´è½»ä»£ï¼ˆYoungGenï¼‰å’Œè€å¹´ä»£ï¼ˆoldGenï¼‰

***å…¶ä¸­å¹´è½»ä»£åˆå¯ä»¥åˆ’åˆ†ä¸ºEdenç©ºé—´ã€Survivor0ç©ºé—´å’ŒSurvivor1ç©ºé—´ï¼ˆæœ‰æ—¶ä¹Ÿå«åšfromåŒºã€toåŒºï¼‰***

![image-20200707075847954](/assets/imgs/image-20200707075847954.png)

ä¸‹é¢è¿™å‚æ•°å¼€å‘ä¸­ä¸€èˆ¬ä¸ä¼šè°ƒï¼š

![image-20200707080154039](/assets/imgs/image-20200707080154039.png)

- Edenï¼šFromï¼što ->  8:1:1
- æ–°ç”Ÿä»£ï¼šè€å¹´ä»£  ->  1 : 2

é…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”ã€‚

- é»˜è®¤-XX:NewRatio=2ï¼Œè¡¨ç¤ºæ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£å 2ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †çš„1/3

- å¯ä»¥ä¿®æ”¹-XX:NewRatio=4ï¼Œè¡¨ç¤ºæ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£å 4ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †çš„1/5

> å½“å‘ç°åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ï¼Œç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡åå¤šï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è°ƒæ•´ è€å¹´ä»£çš„å¤§å°ï¼Œæ¥è¿›è¡Œè°ƒä¼˜

ğŸ§ åœ¨HotSpotä¸­ï¼ŒEdenç©ºé—´å’Œå¦å¤–ä¸¤ä¸ªsurvivorç©ºé—´ç¼ºçœæ‰€å çš„æ¯”ä¾‹æ˜¯8ï¼š1ï¼š1ã€‚***å½“ç„¶å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰é¡¹â€œ-xx:SurvivorRatioâ€è°ƒæ•´è¿™ä¸ªç©ºé—´æ¯”ä¾‹ã€‚æ¯”å¦‚-xx:SurvivorRatio=8***

***å‡ ä¹æ‰€æœ‰çš„ Javaå¯¹è±¡éƒ½æ˜¯åœ¨ EdenåŒºè¢«newå‡ºæ¥çš„ã€‚ç»å¤§éƒ¨åˆ†çš„ Javaå¯¹è±¡çš„é”€æ¯éƒ½åœ¨æ–°ç”Ÿä»£è¿›è¡Œäº†ã€‚ï¼ˆæœ‰äº›å¤§çš„å¯¹è±¡åœ¨EdenåŒºæ— æ³•å­˜å‚¨æ—¶å€™ï¼Œå°†ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼‰***

>IBMå…¬å¸çš„ä¸“é—¨ç ”ç©¶è¡¨æ˜ï¼Œæ–°ç”Ÿä»£ä¸­80%çš„å¯¹è±¡éƒ½æ˜¯â€œæœç”Ÿå¤•æ­»â€çš„ã€‚
>
>å¯ä»¥ä½¿ç”¨é€‰é¡¹"-Xmn"è®¾ç½®æ–°ç”Ÿä»£æœ€å¤§å†…å­˜å¤§å°ï¼ˆä¸€èˆ¬ä¸è®¾ç½®ï¼‰
>

![image-20200707084208115](/assets/imgs/image-20200707084208115.png)

## å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹

### æ¦‚å¿µ

ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜æ˜¯ä¸€ä»¶éå¸¸ä¸¥è°¨å’Œå¤æ‚çš„ä»»åŠ¡ï¼ŒJMçš„è®¾è®¡è€…ä»¬ä¸ä»…éœ€è¦è€ƒè™‘å†…å­˜å¦‚ä½•åˆ†é…ã€åœ¨å“ªé‡Œåˆ†é…ç­‰é—®é¢˜ï¼Œå¹¶ä¸”ç”±äºå†…å­˜åˆ†é…ç®—æ³•ä¸å†…å­˜å›æ”¶ç®—æ³•å¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥è¿˜éœ€è¦è€ƒè™‘GCæ‰§è¡Œå®Œå†…å­˜å›æ”¶åæ˜¯å¦ä¼šåœ¨å†…å­˜ç©ºé—´ä¸­äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚

- newçš„å¯¹è±¡å…ˆæ”¾ä¼Šç”¸å›­åŒºã€‚æ­¤åŒºæœ‰å¤§å°é™åˆ¶ã€‚
- å½“ä¼Šç”¸å›­çš„ç©ºé—´å¡«æ»¡æ—¶ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVMçš„åƒåœ¾å›æ”¶å™¨å°†å¯¹ä¼Šç”¸å›­åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆMinorGCï¼‰ï¼Œå°†ä¼Šç”¸å›­åŒºä¸­çš„ä¸å†è¢«å…¶ä»–å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚å†åŠ è½½æ–°çš„å¯¹è±¡æ”¾åˆ°ä¼Šç”¸å›­åŒº
- ç„¶åå°†ä¼Šç”¸å›­ä¸­çš„å‰©ä½™å¯¹è±¡ç§»åŠ¨åˆ°å¹¸å­˜è€…0åŒºã€‚
- å¦‚æœå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¸Šæ¬¡å¹¸å­˜ä¸‹æ¥çš„æ”¾åˆ°å¹¸å­˜è€…0åŒºçš„ï¼Œå¦‚æœæ²¡æœ‰å›æ”¶ï¼Œå°±ä¼šæ”¾åˆ°å¹¸å­˜è€…1åŒºã€‚
- å¦‚æœå†æ¬¡ç»å†åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¼šé‡æ–°æ”¾å›å¹¸å­˜è€…0åŒºï¼Œæ¥ç€å†å»å¹¸å­˜è€…1åŒºã€‚
- å•¥æ—¶å€™èƒ½å»å…»è€åŒºå‘¢ï¼Ÿå¯ä»¥è®¾ç½®æ¬¡æ•°ã€‚é»˜è®¤æ˜¯15æ¬¡ã€‚
  - ***å¯ä»¥è®¾ç½®å‚æ•°ï¼š-Xx:MaxTenuringThreshold=< N >è¿›è¡Œè®¾ç½®***
- åœ¨å…»è€åŒºï¼Œç›¸å¯¹æ‚ é—²ã€‚å½“å…»è€åŒºå†…å­˜ä¸è¶³æ—¶ï¼Œå†æ¬¡è§¦å‘GCï¼šMajor GCï¼Œè¿›è¡Œå…»è€åŒºçš„å†…å­˜æ¸…ç†
- è‹¥å…»è€åŒºæ‰§è¡Œäº†Major GCä¹‹åï¼Œå‘ç°ä¾ç„¶æ— æ³•è¿›è¡Œå¯¹è±¡çš„ä¿å­˜ï¼Œå°±ä¼šäº§ç”ŸOOMå¼‚å¸¸ã€‚

### å›¾è§£è¿‡ç¨‹

æˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡ï¼Œä¸€èˆ¬éƒ½æ˜¯å­˜æ”¾åœ¨EdenåŒºçš„ï¼Œå½“æˆ‘ä»¬EdenåŒºæ»¡äº†åï¼Œå°±ä¼šè§¦å‘GCæ“ä½œï¼Œä¸€èˆ¬è¢«ç§°ä¸º YGC / Minor GCæ“ä½œ

![image-20200707084714886](/assets/imgs/image-20200707084714886.png)

å½“æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†åï¼Œçº¢è‰²çš„å°†ä¼šè¢«å›æ”¶ï¼Œè€Œç»¿è‰²çš„è¿˜ä¼šè¢«å ç”¨ç€ï¼Œå­˜æ”¾åœ¨S0(Survivor From)åŒºã€‚åŒæ—¶æˆ‘ä»¬ç»™æ¯ä¸ªå¯¹è±¡è®¾ç½®äº†ä¸€ä¸ªå¹´é¾„è®¡æ•°å™¨ï¼Œä¸€æ¬¡å›æ”¶åå°±æ˜¯1ã€‚

åŒæ—¶EdenåŒºç»§ç»­å­˜æ”¾å¯¹è±¡ï¼Œå½“EdenåŒºå†æ¬¡å­˜æ»¡çš„æ—¶å€™ï¼Œåˆä¼šè§¦å‘ä¸€ä¸ªMinorGCæ“ä½œï¼Œæ­¤æ—¶GCå°†ä¼šæŠŠ Edenå’ŒSurvivor Fromä¸­çš„å¯¹è±¡ è¿›è¡Œä¸€æ¬¡æ”¶é›†ï¼ŒæŠŠå­˜æ´»çš„å¯¹è±¡æ”¾åˆ° Survivor ToåŒºï¼ŒåŒæ—¶è®©å¹´é¾„ + 1

![image-20200707085232646](/assets/imgs/image-20200707085232646.png)

æˆ‘ä»¬ç»§ç»­ä¸æ–­çš„è¿›è¡Œå¯¹è±¡ç”Ÿæˆ å’Œ åƒåœ¾å›æ”¶ï¼Œ***å½“Survivorä¸­çš„å¯¹è±¡çš„å¹´é¾„è¾¾åˆ°15çš„æ—¶å€™ï¼Œå°†ä¼šè§¦å‘ä¸€æ¬¡ Promotionæ™‹å‡çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯å°†å¹´è½»ä»£ä¸­çš„å¯¹è±¡  æ™‹å‡åˆ° è€å¹´ä»£ä¸­***

![image-20200707085737207](/assets/imgs/image-20200707085737207.png)

### ğŸ§  æ€è€ƒï¼šå¹¸å­˜è€…åŒºåŒºæ»¡äº†åï¼Ÿ

***ç‰¹åˆ«æ³¨æ„ï¼Œåœ¨EdenåŒºæ»¡äº†çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘MinorGCï¼Œè€Œå¹¸å­˜è€…åŒºæ»¡äº†åï¼Œä¸ä¼šè§¦å‘MinorGCæ“ä½œ***

***å¦‚æœSurvivoråŒºæ»¡äº†åï¼Œå°†ä¼šè§¦å‘ä¸€äº›ç‰¹æ®Šçš„è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½ç›´æ¥æ™‹å‡è€å¹´ä»£***

> ä¸¾ä¾‹ï¼šä»¥å½“å…µä¸ºä¾‹ï¼Œæ­£å¸¸äººçš„æ™‹å‡å¯èƒ½æ˜¯ ï¼š  æ–°å…µ -> ç­é•¿ -> æ’é•¿ -> è¿é•¿
>
> ä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½æœ‰äº›äººå› ä¸ºåšäº†éå¸¸å¤§çš„è´¡çŒ®ï¼Œç›´æ¥ä»  æ–°å…µ -> æ’é•¿

### å¯¹è±¡åˆ†é…çš„ç‰¹æ®Šæƒ…å†µ

![image-20200707091058346](/assets/imgs/image-20200707091058346.png)

### ä»£ç æ¼”ç¤ºå¯¹è±¡åˆ†é…è¿‡ç¨‹

æˆ‘ä»¬ä¸æ–­çš„åˆ›å»ºå¤§å¯¹è±¡

```java
/**
 * ä»£ç æ¼”ç¤ºå¯¹è±¡åˆ›å»ºè¿‡ç¨‹
 */
public class HeapInstanceTest {
    byte [] buffer = new byte[new Random().nextInt(1024 * 200)];
    public static void main(String[] args) throws InterruptedException {
        ArrayList<HeapInstanceTest> list = new ArrayList<>();
        while (true) {
            list.add(new HeapInstanceTest());
            Thread.sleep(10);
        }
    }
}
```

ç„¶åè®¾ç½®JVMå‚æ•°

```bash
-Xms600m -Xmx600m
```

ç„¶åcmdè¾“å…¥ä¸‹é¢å‘½ä»¤ï¼Œæ‰“å¼€VisualVMå›¾å½¢åŒ–ç•Œé¢

```
jvisualvm
```

ç„¶åé€šè¿‡æ‰§è¡Œä¸Šé¢ä»£ç ï¼Œé€šè¿‡VisualGCè¿›è¡ŒåŠ¨æ€åŒ–æŸ¥çœ‹

![åƒåœ¾å›æ”¶](/assets/imgs/åƒåœ¾å›æ”¶.gif)

æœ€ç»ˆï¼Œåœ¨è€å¹´ä»£å’Œæ–°ç”Ÿä»£éƒ½æ»¡äº†ï¼Œå°±å‡ºç°OOM

```
Exception in thread "main" java.lang.OutOfMemoryError: Java heap space
	at com.atguigu.java.chapter08.HeapInstanceTest.<init>(HeapInstanceTest.java:13)
	at com.atguigu.java.chapter08.HeapInstanceTest.main(HeapInstanceTest.java:17)
```

### å¸¸ç”¨çš„è°ƒä¼˜å·¥å…·

- JDKå‘½ä»¤è¡Œ
- Eclipseï¼šMemory Analyzer Tool
- Jconsole
- Visual VMï¼ˆå®æ—¶ç›‘æ§  æ¨è~ï¼‰
- Jprofilerï¼ˆæ¨è~ï¼‰
- Java Flight Recorderï¼ˆå®æ—¶ç›‘æ§ï¼‰
- GCViewer
- GCEasy

### æ€»ç»“

- ***é’ˆå¯¹å¹¸å­˜è€…s0ï¼Œs1åŒºçš„æ€»ç»“ï¼šå¤åˆ¶ä¹‹åæœ‰äº¤æ¢ï¼Œè°ç©ºè°æ˜¯to***
- ***å…³äºåƒåœ¾å›æ”¶ï¼šé¢‘ç¹åœ¨æ–°ç”ŸåŒºæ”¶é›†ï¼Œå¾ˆå°‘åœ¨è€å¹´ä»£æ”¶é›†ï¼Œå‡ ä¹ä¸å†æ°¸ä¹…ä»£å’Œå…ƒç©ºé—´è¿›è¡Œæ”¶é›†***
- ***æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•çš„ç›®çš„ï¼šæ˜¯ä¸ºäº†å‡å°‘å†…ç¢ç‰‡***

## ğŸ§ Minor GCï¼ŒMajorGCã€Full GC

- Minor GCï¼šæ–°ç”Ÿä»£çš„GC
- Major GCï¼šè€å¹´ä»£çš„GC
- Full GCï¼šæ•´å †æ”¶é›†ï¼Œæ”¶é›†æ•´ä¸ª Javaå †å’Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†

>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒJVMçš„è°ƒä¼˜çš„ä¸€ä¸ªç¯èŠ‚ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾æ”¶é›†ï¼Œæˆ‘ä»¬éœ€è¦å°½é‡çš„é¿å…åƒåœ¾å›æ”¶ï¼Œå› ä¸ºåœ¨åƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œå®¹æ˜“å‡ºç°STWçš„é—®é¢˜
>
>è€Œ Major GC å’Œ Full GCå‡ºç°STWçš„æ—¶é—´ï¼Œæ˜¯Minor GCçš„10å€ä»¥ä¸Š

JVMåœ¨è¿›è¡ŒGCæ—¶ï¼Œå¹¶éæ¯æ¬¡éƒ½å¯¹ä¸Šé¢ä¸‰ä¸ªå†…å­˜åŒºåŸŸï¼ˆæ–°ç”Ÿä»£ã€è€å¹´ä»£ï¼›æ–¹æ³•åŒºï¼‰ä¸€èµ·å›æ”¶çš„ï¼Œå¤§éƒ¨åˆ†æ—¶å€™å›æ”¶çš„éƒ½æ˜¯æŒ‡æ–°ç”Ÿä»£ã€‚***é’ˆå¯¹Hotspot VMçš„å®ç°ï¼Œå®ƒé‡Œé¢çš„GCæŒ‰ç…§å›æ”¶åŒºåŸŸåˆåˆ†ä¸ºä¸¤å¤§ç§ç±»å‹ï¼šä¸€ç§æ˜¯éƒ¨åˆ†æ”¶é›†ï¼ˆPartial GCï¼‰ï¼Œä¸€ç§æ˜¯æ•´å †æ”¶é›†ï¼ˆFullGCï¼‰***ã€‚

éƒ¨åˆ†æ”¶é›†ï¼šä¸æ˜¯å®Œæ•´æ”¶é›†æ•´ä¸ªJavaå †çš„åƒåœ¾æ”¶é›†ã€‚å…¶ä¸­åˆåˆ†ä¸ºï¼š

- æ–°ç”Ÿä»£æ”¶é›†ï¼ˆMinor GC/Young GCï¼‰ï¼šåªæ˜¯æ–°ç”Ÿä»£ï¼ˆEden\S0,S1ï¼‰çš„åƒåœ¾æ”¶é›†
- è€å¹´ä»£æ”¶é›†ï¼ˆMajor GC/old GCï¼‰ï¼šåªæ˜¯è€å¹´ä»£çš„åœ¾æ”¶é›†ã€‚
  - ç›®å‰ï¼Œåªæœ‰ ***CMS GC*** ä¼šæœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸ºã€‚
  - ***æ³¨æ„ï¼Œå¾ˆå¤šæ—¶å€™ Major GCä¼šå’Œ FullGCæ··æ·†ä½¿ç”¨ï¼Œéœ€è¦å…·ä½“åˆ†è¾¨æ˜¯è€å¹´ä»£å›æ”¶è¿˜æ˜¯æ•´å †å›æ”¶ã€‚***
- æ··åˆæ”¶é›†ï¼ˆMixed GCï¼‰ï¼šæ”¶é›†æ•´ä¸ªæ–°ç”Ÿä»£ä»¥åŠéƒ¨åˆ†è€å¹´ä»£çš„åƒåœ¾æ”¶é›†ã€‚
  - ç›®å‰ï¼Œåªæœ‰G1 GCä¼šæœ‰è¿™ç§è¡Œä¸º

æ•´å †æ”¶é›†ï¼ˆFull GCï¼‰ï¼šæ”¶é›†æ•´ä¸ªjavaå †å’Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ã€‚

### Minor GC è§¦å‘æœºåˆ¶

å½“å¹´è½»ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œå°±ä¼šè§¦å‘MinorGCï¼Œè¿™é‡Œçš„å¹´è½»ä»£æ»¡æŒ‡çš„æ˜¯Edenä»£æ»¡ï¼Œ***Survivoræ»¡ä¸ä¼šå¼•å‘GCã€‚***ï¼ˆæ¯æ¬¡Minor GCä¼šæ¸…ç†å¹´è½»ä»£çš„å†…å­˜ã€‚ï¼‰

***å› ä¸º Javaå¯¹è±¡å¤§å¤šéƒ½å…·å¤‡ æœç”Ÿå¤•ç­ çš„ç‰¹æ€§ï¼Œæ‰€ä»¥Minor GCéå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚***è¿™ä¸€å®šä¹‰æ—¢æ¸…æ™°åˆæ˜“äºç†è§£ã€‚

Minor GCä¼šå¼•å‘STWï¼Œæš‚åœå…¶å®ƒç”¨æˆ·çš„çº¿ç¨‹ï¼Œç­‰åƒåœ¾å›æ”¶ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¢å¤è¿è¡Œ

> STWï¼šstop the word  ç ¸ç“¦é²å¤šï¼

![image-20200707095606813](/assets/imgs/image-20200707095606813.png)

### Major GC è§¦å‘æœºåˆ¶

æŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„GCï¼Œå¯¹è±¡ä»è€å¹´ä»£æ¶ˆå¤±æ—¶ï¼Œæˆ‘ä»¬è¯´ â€œMajor GCâ€ æˆ– â€œFull GCâ€ å‘ç”Ÿäº†

å‡ºç°äº†Major GCï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„Minor GCï¼ˆä½†éç»å¯¹çš„ï¼Œåœ¨Parallel Scavengeæ”¶é›†å™¨çš„æ”¶é›†ç­–ç•¥é‡Œå°±æœ‰ç›´æ¥è¿›è¡ŒMajor GCçš„ç­–ç•¥é€‰æ‹©è¿‡ç¨‹ï¼‰

- ä¹Ÿå°±æ˜¯åœ¨è€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šå…ˆå°è¯•è§¦å‘Minor Gcã€‚å¦‚æœä¹‹åç©ºé—´è¿˜ä¸è¶³ï¼Œåˆ™è§¦å‘Major GC

***Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10å€ä»¥ä¸Šï¼ŒSTWçš„æ—¶é—´æ›´é•¿ï¼Œå¦‚æœMajor GCåï¼Œå†…å­˜è¿˜ä¸è¶³ï¼Œå°±æŠ¥OOMäº†***

### Full GC è§¦å‘æœºåˆ¶

è§¦å‘Full GCæ‰§è¡Œçš„æƒ…å†µæœ‰å¦‚ä¸‹äº”ç§ï¼š

- è°ƒç”¨ `System.gc()` æ—¶ï¼Œç³»ç»Ÿå»ºè®®æ‰§è¡ŒFull GCï¼Œä½†æ˜¯ä¸å¿…ç„¶æ‰§è¡Œ
- è€å¹´ä»£ç©ºé—´ä¸è¶³
- æ–¹æ³•åŒºç©ºé—´ä¸è¶³
- é€šè¿‡Minor GCåè¿›å…¥è€å¹´ä»£çš„å¹³å‡å¤§å°å¤§äºè€å¹´ä»£çš„å¯ç”¨å†…å­˜
- ç”±EdenåŒºã€survivor spaceeï¼ˆFrom Spaceï¼‰åŒºå‘survivor spacelï¼ˆTo Spaceï¼‰åŒºå¤åˆ¶æ—¶ï¼Œå¯¹è±¡å¤§å°å¤§äºTo Spaceå¯ç”¨å†…å­˜ï¼Œåˆ™æŠŠè¯¥å¯¹è±¡è½¬å­˜åˆ°è€å¹´ä»£ï¼Œä¸”è€å¹´ä»£çš„å¯ç”¨å†…å­˜å°äºè¯¥å¯¹è±¡å¤§å°

***è¯´æ˜ï¼šFull GC æ˜¯å¼€å‘æˆ–è°ƒä¼˜ä¸­å°½é‡è¦é¿å…çš„ã€‚è¿™æ ·æš‚æ—¶æ—¶é—´ä¼šçŸ­ä¸€äº›***



### GC ä¸¾ä¾‹

æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªOOMçš„å¼‚å¸¸ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸æ–­çš„åˆ›å»ºå­—ç¬¦ä¸²ï¼Œæ˜¯å­˜æ”¾åœ¨å…ƒç©ºé—´çš„

```java
/**
 * GCæµ‹è¯•
 */
public class GCTest {
    public static void main(String[] args) {
        int i = 0;
        try {
            List<String> list = new ArrayList<>();
            String a = "mogu blog";
            while(true) {
                list.add(a);
                a = a + a;
                i++;
            }
        }catch (Exception e) {
            e.getStackTrace();
        }
    }
}
```

è®¾ç½®JVMå¯åŠ¨å‚æ•°

```bash
-Xms10m -Xmx10m -XX:+PrintGCDetails
```

æ‰“å°å‡ºçš„æ—¥å¿—

```verilog
[GC (Allocation Failure) [PSYoungGen: 2038K->500K(2560K)] 2038K->797K(9728K), 0.3532002 secs] [Times: user=0.01 sys=0.00, real=0.36 secs] 
[GC (Allocation Failure) [PSYoungGen: 2108K->480K(2560K)] 2405K->1565K(9728K), 0.0014069 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[Full GC (Ergonomics) [PSYoungGen: 2288K->0K(2560K)] [ParOldGen: 6845K->5281K(7168K)] 9133K->5281K(9728K), [Metaspace: 3482K->3482K(1056768K)], 0.0058675 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 0K->0K(2560K)] 5281K->5281K(9728K), 0.0002857 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[Full GC (Allocation Failure) [PSYoungGen: 0K->0K(2560K)] [ParOldGen: 5281K->5263K(7168K)] 5281K->5263K(9728K), [Metaspace: 3482K->3482K(1056768K)], 0.0058564 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
Heap
 PSYoungGen      total 2560K, used 60K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)
  eden space 2048K, 2% used [0x00000000ffd00000,0x00000000ffd0f138,0x00000000fff00000)
  from space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)
  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)
 ParOldGen       total 7168K, used 5263K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)
  object space 7168K, 73% used [0x00000000ff600000,0x00000000ffb23cf0,0x00000000ffd00000)
 Metaspace       used 3514K, capacity 4498K, committed 4864K, reserved 1056768K
  class space    used 388K, capacity 390K, committed 512K, reserved 1048576K
  
  Exception in thread "main" java.lang.OutOfMemoryError: Java heap space
	at java.util.Arrays.copyOfRange(Arrays.java:3664)
	at java.lang.String.<init>(String.java:207)
	at java.lang.StringBuilder.toString(StringBuilder.java:407)
	at com.atguigu.java.chapter08.GCTest.main(GCTest.java:20)
```

è§¦å‘OOMçš„æ—¶å€™ï¼Œä¸€å®šæ˜¯è¿›è¡Œäº†ä¸€æ¬¡Full GCï¼Œå› ä¸ºåªæœ‰åœ¨è€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶å€™ï¼Œæ‰ä¼šçˆ†å‡ºOOMå¼‚å¸¸

## å †ç©ºé—´åˆ†ä»£æ€æƒ³

 ä¸ºä»€ä¹ˆè¦æŠŠJavaå †åˆ†ä»£ï¼Ÿä¸åˆ†ä»£å°±ä¸èƒ½æ­£å¸¸å·¥ä½œäº†å—ï¼Ÿç»ç ”ç©¶ï¼Œä¸åŒå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸åŒã€‚70%-99%çš„å¯¹è±¡æ˜¯ä¸´æ—¶å¯¹è±¡ã€‚

>æ–°ç”Ÿä»£ï¼šæœ‰Edenã€ä¸¤å—å¤§å°ç›¸åŒçš„survivorï¼ˆåˆç§°ä¸ºfrom/toï¼Œs0/s1ï¼‰æ„æˆï¼Œtoæ€»ä¸ºç©ºã€‚
>è€å¹´ä»£ï¼šå­˜æ”¾æ–°ç”Ÿä»£ä¸­ç»å†å¤šæ¬¡GCä»ç„¶å­˜æ´»çš„å¯¹è±¡ã€‚

![image-20200707101511025](/assets/imgs/image-20200707101511025.png)

***å…¶å®ä¸åˆ†ä»£å®Œå…¨å¯ä»¥ï¼Œåˆ†ä»£çš„å”¯ä¸€ç†ç”±å°±æ˜¯ä¼˜åŒ–GCæ€§èƒ½ã€‚***å¦‚æœæ²¡æœ‰åˆ†ä»£ï¼Œé‚£æ‰€æœ‰çš„å¯¹è±¡éƒ½åœ¨ä¸€å—ï¼Œå°±å¦‚åŒæŠŠä¸€ä¸ªå­¦æ ¡çš„äººéƒ½å…³åœ¨ä¸€ä¸ªæ•™å®¤ã€‚GCçš„æ—¶å€™è¦æ‰¾åˆ°å“ªäº›å¯¹è±¡æ²¡ç”¨ï¼Œè¿™æ ·å°±ä¼šå¯¹å †çš„æ‰€æœ‰åŒºåŸŸè¿›è¡Œæ‰«æã€‚è€Œå¾ˆå¤šå¯¹è±¡éƒ½æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œå¦‚æœåˆ†ä»£çš„è¯ï¼ŒæŠŠæ–°åˆ›å»ºçš„å¯¹è±¡æ”¾åˆ°æŸä¸€åœ°æ–¹ï¼Œå½“GCçš„æ—¶å€™å…ˆæŠŠè¿™å—å­˜å‚¨â€œæœç”Ÿå¤•æ­»â€å¯¹è±¡çš„åŒºåŸŸè¿›è¡Œå›æ”¶ï¼Œè¿™æ ·å°±ä¼šè…¾å‡ºå¾ˆå¤§çš„ç©ºé—´å‡ºæ¥ã€‚

![image-20200707101543871](/assets/imgs/image-20200707101543871.png)



## ğŸ§ å†…å­˜åˆ†é…ç­–ç•¥

å¦‚æœå¯¹è±¡åœ¨Edenå‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡MinorGCåä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢«Survivorå®¹çº³çš„è¯ï¼Œå°†è¢«ç§»åŠ¨åˆ°survivorç©ºé—´ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º1ã€‚å¯¹è±¡åœ¨survivoråŒºä¸­æ¯ç†¬è¿‡ä¸€æ¬¡MinorGCï¼Œå¹´é¾„å°±å¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º15å²ï¼Œå…¶å®æ¯ä¸ªJVMã€æ¯ä¸ªGCéƒ½æœ‰æ‰€ä¸åŒï¼‰æ—¶ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ã€‚

å¯¹è±¡æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜€å€¼ï¼Œå¯ä»¥é€šè¿‡é€‰é¡¹-xx:MaxTenuringThresholdæ¥è®¾ç½®

***é’ˆå¯¹ä¸åŒå¹´é¾„æ®µçš„å¯¹è±¡åˆ†é…åŸåˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š***

- ä¼˜å…ˆåˆ†é…åˆ°Eden
  - å¼€å‘ä¸­æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æˆ–è€…æ•°ç»„ï¼Œä¼šç›´æ¥å­˜åœ¨è€å¹´ä»£ï¼Œä½†æ˜¯å› ä¸ºæ–°åˆ›å»ºçš„å¯¹è±¡ éƒ½æ˜¯ æœç”Ÿå¤•æ­»çš„ï¼Œæ‰€ä»¥è¿™ä¸ªå¤§å¯¹è±¡å¯èƒ½ä¹Ÿå¾ˆå¿«è¢«å›æ”¶ï¼Œä½†æ˜¯å› ä¸ºè€å¹´ä»£è§¦å‘Major GCçš„æ¬¡æ•°æ¯” Minor GCè¦æ›´å°‘ï¼Œå› æ­¤å¯èƒ½å›æ”¶èµ·æ¥å°±ä¼šæ¯”è¾ƒæ…¢
- ***å¤§å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£***
  - ***å°½é‡é¿å…ç¨‹åºä¸­å‡ºç°è¿‡å¤šçš„å¤§å¯¹è±¡***
- é•¿æœŸå­˜æ´»çš„å¯¹è±¡åˆ†é…åˆ°è€å¹´ä»£
- ***åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤æ–­***
  - ***å¦‚æœsurvivoråŒºä¸­ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œæ— é¡»ç­‰åˆ°MaxTenuringThreshold ä¸­è¦æ±‚çš„å¹´é¾„ã€‚***

ç©ºé—´åˆ†é…æ‹…ä¿ï¼š -Xx:HandlePromotionFailure

## ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼šTLAB

### é—®é¢˜ï¼šå †ç©ºé—´éƒ½æ˜¯å…±äº«çš„ä¹ˆï¼Ÿ

ä¸ä¸€å®šï¼Œå› ä¸ºè¿˜æœ‰TLABè¿™ä¸ªæ¦‚å¿µï¼Œåœ¨å †ä¸­åˆ’åˆ†å‡ºä¸€å—åŒºåŸŸï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹æ‰€ç‹¬å 

### ä¸ºä»€ä¹ˆæœ‰TLABï¼Ÿ

TLABï¼šThread Local Allocation Bufferï¼Œä¹Ÿå°±æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹å•ç‹¬åˆ†é…äº†ä¸€ä¸ªç¼“å†²åŒº

1. å †åŒºæ˜¯çº¿ç¨‹å…±äº«åŒºåŸŸï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®åˆ°å †åŒºä¸­çš„å…±äº«æ•°æ®

2. ç”±äºå¯¹è±¡å®ä¾‹çš„åˆ›å»ºåœ¨JVMä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä»å †åŒºä¸­åˆ’åˆ†å†…å­˜ç©ºé—´æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„

3. ä¸ºé¿å…å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€åœ°å€ï¼Œéœ€è¦ä½¿ç”¨åŠ é”ç­‰æœºåˆ¶ï¼Œè¿›è€Œå½±å“åˆ†é…é€Ÿåº¦ã€‚

### ä»€ä¹ˆæ˜¯TLAB

***ä»å†…å­˜æ¨¡å‹è€Œä¸æ˜¯åƒåœ¾æ”¶é›†çš„è§’åº¦ï¼Œå¯¹EdenåŒºåŸŸç»§ç»­è¿›è¡Œåˆ’åˆ†ï¼ŒJVMä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œå®ƒåŒ…å«åœ¨Edenç©ºé—´å†…ã€‚***

å¤šçº¿ç¨‹åŒæ—¶åˆ†é…å†…å­˜æ—¶ï¼Œä½¿ç”¨TLABå¯ä»¥é¿å…ä¸€ç³»åˆ—çš„éçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿæå‡å†…å­˜åˆ†é…çš„ååé‡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¿™ç§å†…å­˜åˆ†é…æ–¹å¼ç§°ä¹‹ä¸º***å¿«é€Ÿåˆ†é…ç­–ç•¥ã€‚***

æ®æˆ‘æ‰€çŸ¥æ‰€æœ‰OpenJDKè¡ç”Ÿå‡ºæ¥çš„JVMéƒ½æä¾›äº†TLABçš„è®¾è®¡ã€‚

![image-20200707103547712](/assets/imgs/image-20200707103547712.png)

#### è¡¥å……è¯´æ˜ï¼š

- å°½ç®¡ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½èƒ½å¤Ÿåœ¨TLABä¸­æˆåŠŸåˆ†é…å†…å­˜ï¼Œä½† ***JVMç¡®å®æ˜¯å°†TLABä½œä¸ºå†…å­˜åˆ†é…çš„é¦–é€‰ã€‚***

- åœ¨ç¨‹åºä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰é¡¹â€œ-Xx:UseTLABâ€è®¾ç½®æ˜¯å¦å¼€å¯TLABç©ºé—´ã€‚

- ***é»˜è®¤æƒ…å†µä¸‹ï¼ŒTLABç©ºé—´çš„å†…å­˜éå¸¸å°ï¼Œä»…å æœ‰æ•´ä¸ªEdenç©ºé—´çš„1%ï¼Œ***å½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡é€‰é¡¹â€œ-Xx:TLABWasteTargetPercentâ€è®¾ç½®TLABç©ºé—´æ‰€å ç”¨Edenç©ºé—´çš„ç™¾åˆ†æ¯”å¤§å°ã€‚

- ä¸€æ—¦å¯¹è±¡åœ¨TLABç©ºé—´åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼ŒJVMå°±ä¼šå°è¯•ç€é€šè¿‡ ***ä½¿ç”¨åŠ é”æœºåˆ¶***  ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§ï¼Œä»è€Œç›´æ¥åœ¨Edenç©ºé—´ä¸­åˆ†é…å†…å­˜ã€‚

### TLABåˆ†é…è¿‡ç¨‹

å¯¹è±¡é¦–å…ˆæ˜¯é€šè¿‡TLABå¼€è¾Ÿç©ºé—´ï¼Œå¦‚æœä¸èƒ½æ”¾å…¥ï¼Œé‚£ä¹ˆéœ€è¦é€šè¿‡Edenæ¥è¿›è¡Œåˆ†é…

![image-20200707104253530](/assets/imgs/image-20200707104253530.png)

## ğŸ§ å°ç»“ï¼šå †ç©ºé—´çš„å‚æ•°è®¾ç½®

- -XXï¼š+PrintFlagsInitialï¼šæŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°çš„é»˜è®¤åˆå§‹å€¼

- -XXï¼š+PrintFlagsFinalï¼šæŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°çš„æœ€ç»ˆå€¼ï¼ˆå¯èƒ½ä¼šå­˜åœ¨ä¿®æ”¹ï¼Œä¸å†æ˜¯åˆå§‹å€¼ï¼‰

  - å…·ä½“æŸ¥çœ‹æŸä¸ªå‚æ•°çš„æŒ‡ä»¤ï¼š 

    1. jpsï¼šæŸ¥çœ‹å½“å‰è¿è¡Œä¸­çš„è¿›ç¨‹

    2. jinfo -flag SurvivorRatio  è¿›ç¨‹id

- -Xmsï¼šåˆå§‹å †ç©ºé—´å†…å­˜ï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/64ï¼‰

- -Xmxï¼šæœ€å¤§å †ç©ºé—´å†…å­˜ï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/4ï¼‰

- -Xmnï¼šè®¾ç½®æ–°ç”Ÿä»£çš„å¤§å°ã€‚ï¼ˆåˆå§‹å€¼åŠæœ€å¤§å€¼ï¼‰

- -XX:NewRatioï¼šé…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”

- -XX:SurvivorRatioï¼šè®¾ç½®æ–°ç”Ÿä»£ä¸­Edenå’ŒS0/S1ç©ºé—´çš„æ¯”ä¾‹

- -XX:MaxTenuringThresholdï¼šè®¾ç½®æ–°ç”Ÿä»£åƒåœ¾çš„æœ€å¤§å¹´é¾„

- -XXï¼š+PrintGCDetailsï¼šè¾“å‡ºè¯¦ç»†çš„GCå¤„ç†æ—¥å¿—
  
  - æ‰“å°gcç®€è¦ä¿¡æ¯ï¼šâ‘ -Xxï¼š+PrintGC  â‘¡ - verbose:gc
  
- -XX:HandlePromotionFalilureï¼šæ˜¯å¦è®¾ç½®ç©ºé—´åˆ†é…æ‹…ä¿

***-XX:HandlePromotionFalilure***ï¼š

***åœ¨å‘ç”ŸMinor GCä¹‹å‰ï¼Œè™šæ‹Ÿæœºä¼šæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡çš„æ€»ç©ºé—´ã€‚***

- å¦‚æœå¤§äºï¼Œåˆ™æ­¤æ¬¡Minor GCæ˜¯å®‰å…¨çš„
- å¦‚æœå°äºï¼Œåˆ™è™šæ‹Ÿæœºä¼šæŸ¥çœ‹-xx:HandlePromotionFailureè®¾ç½®å€¼æ˜¯å¦å…æ‹…ä¿å¤±è´¥ã€‚
  - ***å¦‚æœHandlePromotionFailure=trueï¼Œé‚£ä¹ˆä¼šç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¯¹è±¡çš„å¹³å‡å¤§å°ã€‚***
  - å¦‚æœå¤§äºï¼Œåˆ™å°è¯•è¿›è¡Œä¸€æ¬¡Minor GCï¼Œä½†è¿™æ¬¡Minor GCä¾ç„¶æ˜¯æœ‰é£é™©çš„ï¼›
  - å¦‚æœå°äºï¼Œåˆ™æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡FullGCã€‚
  - å¦‚æœHandlePromotionFailure=falseï¼Œåˆ™æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡Ful1 Gcã€‚

***åœ¨JDK6 Update24ä¹‹åï¼ˆJDK7ï¼‰ï¼ŒHandlePromotionFailureå‚æ•°ä¸ä¼šå†å½±å“åˆ°è™šæ‹Ÿæœºçš„ç©ºé—´åˆ†é…æ‹…ä¿ç­–ç•¥***ï¼Œè§‚å¯ŸopenJDKä¸­çš„æºç å˜åŒ–ï¼Œè™½ç„¶æºç ä¸­è¿˜å®šä¹‰äº†HandlePromotionFailureå‚æ•°ï¼Œä½†æ˜¯åœ¨ä»£ç ä¸­å·²ç»ä¸ä¼šå†ä½¿ç”¨å®ƒã€‚JDK6 Update 24ä¹‹åçš„***è§„åˆ™å˜ä¸ºåªè¦è€å¹´ä»£çš„è¿ç»­ç©ºé—´å¤§äºæ–°ç”Ÿä»£å¯¹è±¡æ€»å¤§å°æˆ–è€…å†æ¬¡æ™‹å‡çš„å¹³å‡å¤§å°å°±ä¼šè¿›è¡ŒMinor GCï¼Œå¦åˆ™å°†è¿›è¡ŒFullGCã€‚***

## å †æ˜¯åˆ†é…å¯¹è±¡çš„å”¯ä¸€é€‰æ‹©ä¹ˆï¼Ÿ

### é€ƒé€¸åˆ†æ

åœ¨ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­å…³äºJavaå †å†…å­˜æœ‰è¿™æ ·ä¸€æ®µæè¿°ï¼š

éšç€JITç¼–è¯‘æœŸçš„å‘å±•ä¸***é€ƒé€¸åˆ†ææŠ€æœ¯***é€æ¸æˆç†Ÿï¼Œ***æ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢ä¼˜åŒ–æŠ€æœ¯å°†ä¼šå¯¼è‡´ä¸€äº›å¾®å¦™çš„å˜åŒ–ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½åˆ†é…åˆ°å †ä¸Šä¹Ÿæ¸æ¸å˜å¾—ä¸é‚£ä¹ˆâ€œç»å¯¹â€äº†ã€‚***

åœ¨Javaè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡æ˜¯åœ¨Javaå †ä¸­åˆ†é…å†…å­˜çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæ™®éçš„å¸¸è¯†ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œ***é‚£å°±æ˜¯å¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰åå‘ç°ï¼Œä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œé‚£ä¹ˆå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚***è¿™æ ·å°±æ— éœ€åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œä¹Ÿæ— é¡»è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚è¿™ä¹Ÿæ˜¯æœ€å¸¸è§çš„å †å¤–å­˜å‚¨æŠ€æœ¯ã€‚

æ­¤å¤–ï¼Œå‰é¢æåˆ°çš„åŸºäºopenJDkæ·±åº¦å®šåˆ¶çš„TaoBaojvmï¼Œå…¶ä¸­åˆ›æ–°çš„GCIHï¼ˆGC invisible heapï¼‰æŠ€æœ¯å®ç°off-heapï¼Œå°†ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„Javaå¯¹è±¡ä»heapä¸­ç§»è‡³heapå¤–ï¼Œå¹¶ä¸”GCä¸èƒ½ç®¡ç†GCIHå†…éƒ¨çš„Javaå¯¹è±¡ï¼Œä»¥æ­¤è¾¾åˆ°é™ä½GCçš„å›æ”¶é¢‘ç‡å’Œæå‡GCçš„å›æ”¶æ•ˆç‡çš„ç›®çš„ã€‚

å¦‚ä½•å°†å †ä¸Šçš„å¯¹è±¡åˆ†é…åˆ°æ ˆï¼Œéœ€è¦ä½¿ç”¨é€ƒé€¸åˆ†ææ‰‹æ®µã€‚

è¿™æ˜¯ä¸€ç§å¯ä»¥æœ‰æ•ˆå‡å°‘Javaç¨‹åºä¸­åŒæ­¥è´Ÿè½½å’Œå†…å­˜å †åˆ†é…å‹åŠ›çš„è·¨å‡½æ•°å…¨å±€æ•°æ®æµåˆ†æç®—æ³•ã€‚é€šè¿‡é€ƒé€¸åˆ†æï¼ŒJava Hotspotç¼–è¯‘å™¨èƒ½å¤Ÿåˆ†æå‡ºä¸€ä¸ªæ–°çš„å¯¹è±¡çš„å¼•ç”¨çš„ä½¿ç”¨èŒƒå›´ä»è€Œå†³å®šæ˜¯å¦è¦å°†è¿™ä¸ªå¯¹è±¡åˆ†é…åˆ°å †ä¸Šã€‚é€ƒé€¸åˆ†æçš„åŸºæœ¬è¡Œä¸ºå°±æ˜¯åˆ†æå¯¹è±¡åŠ¨æ€ä½œç”¨åŸŸï¼š

- å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­è¢«å®šä¹‰åï¼Œå¯¹è±¡åªåœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œåˆ™è®¤ä¸ºæ²¡æœ‰å‘ç”Ÿé€ƒé€¸ã€‚
- å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­è¢«å®šä¹‰åï¼Œå®ƒè¢«å¤–éƒ¨æ–¹æ³•æ‰€å¼•ç”¨ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿé€ƒé€¸ã€‚ä¾‹å¦‚ä½œä¸ºè°ƒç”¨å‚æ•°ä¼ é€’åˆ°å…¶ä»–åœ°æ–¹ä¸­ã€‚

#### é€ƒé€¸åˆ†æä¸¾ä¾‹

æ²¡æœ‰å‘ç”Ÿé€ƒé€¸çš„å¯¹è±¡ï¼Œåˆ™å¯ä»¥åˆ†é…åˆ°æ ˆä¸Šï¼Œéšç€æ–¹æ³•æ‰§è¡Œçš„ç»“æŸï¼Œæ ˆç©ºé—´å°±è¢«ç§»é™¤ï¼Œæ¯ä¸ªæ ˆé‡Œé¢åŒ…å«äº†å¾ˆå¤šæ ˆå¸§ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿé€ƒé€¸åˆ†æ

```java
public void my_method() {
    V v = new V();
    // use v
    // ....
    v = null;
}
```

é’ˆå¯¹ä¸‹é¢çš„ä»£ç 

```java
public static StringBuffer createStringBuffer(String s1, String s2) {
    StringBuffer sb = new StringBuffer();
    sb.append(s1);
    sb.append(s2);
    return sb;
}
```

å¦‚æœæƒ³è¦StringBuffer sbä¸å‘ç”Ÿé€ƒé€¸ï¼Œå¯ä»¥è¿™æ ·å†™

```java
public static String createStringBuffer(String s1, String s2) {
    StringBuffer sb = new StringBuffer();
    sb.append(s1);
    sb.append(s2);
    return sb.toString();
}
```

å®Œæ•´çš„é€ƒé€¸åˆ†æä»£ç ä¸¾ä¾‹

```java
/**
 * é€ƒé€¸åˆ†æ
 * å¦‚ä½•å¿«é€Ÿçš„åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†é€ƒé€¸åˆ†æï¼Œå¤§å®¶å°±çœ‹newçš„å¯¹è±¡æ˜¯å¦åœ¨æ–¹æ³•å¤–è¢«è°ƒç”¨ã€‚
 */
public class EscapeAnalysis {

    public EscapeAnalysis obj;

    /**
     * æ–¹æ³•è¿”å›EscapeAnalysiså¯¹è±¡ï¼Œå‘ç”Ÿé€ƒé€¸
     * @return
     */
    public EscapeAnalysis getInstance() {
        return obj == null ? new EscapeAnalysis():obj;
    }

    /**
     * ä¸ºæˆå‘˜å±æ€§èµ‹å€¼ï¼Œå‘ç”Ÿé€ƒé€¸
     */
    public void setObj() {
        this.obj = new EscapeAnalysis();
    }

    /**
     * å¯¹è±¡çš„ä½œç”¨äºä»…åœ¨å½“å‰æ–¹æ³•ä¸­æœ‰æ•ˆï¼Œæ²¡æœ‰å‘ç”Ÿé€ƒé€¸
     */
    public void useEscapeAnalysis() {
        EscapeAnalysis e = new EscapeAnalysis();
    }

    /**
     * å¼•ç”¨æˆå‘˜å˜é‡çš„å€¼ï¼Œå‘ç”Ÿé€ƒé€¸
     */
    public void useEscapeAnalysis2() {
        EscapeAnalysis e = getInstance();
        // getInstance().XXX  å‘ç”Ÿé€ƒé€¸
    }
}
```

#### å‚æ•°è®¾ç½®

***åœ¨JDK 1.7 ç‰ˆæœ¬ä¹‹åï¼ŒHotSpotä¸­é»˜è®¤å°±å·²ç»å¼€å¯äº†é€ƒé€¸åˆ†æ***

å¦‚æœä½¿ç”¨çš„æ˜¯è¾ƒæ—©çš„ç‰ˆæœ¬ï¼Œå¼€å‘äººå‘˜åˆ™å¯ä»¥é€šè¿‡ï¼š

- é€‰é¡¹â€œ-xxï¼š+DoEscapeAnalysis"æ˜¾å¼å¼€å¯é€ƒé€¸åˆ†æ
- é€šè¿‡é€‰é¡¹â€œ-xxï¼š+PrintEscapeAnalysis"æŸ¥çœ‹é€ƒé€¸åˆ†æçš„ç­›é€‰ç»“æœ

#### ğŸ§ ç»“è®º

***å¼€å‘ä¸­èƒ½ä½¿ç”¨å±€éƒ¨å˜é‡çš„ï¼Œå°±ä¸è¦ä½¿ç”¨åœ¨æ–¹æ³•å¤–å®šä¹‰ã€‚***

ä½¿ç”¨é€ƒé€¸åˆ†æï¼Œç¼–è¯‘å™¨å¯ä»¥å¯¹ä»£ç åšå¦‚ä¸‹ä¼˜åŒ–ï¼š

- ***æ ˆä¸Šåˆ†é…***ï¼šå°†å †åˆ†é…è½¬åŒ–ä¸ºæ ˆåˆ†é…ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨å­ç¨‹åºä¸­è¢«åˆ†é…ï¼Œè¦ä½¿æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆæ°¸è¿œä¸ä¼šå‘ç”Ÿé€ƒé€¸ï¼Œå¯¹è±¡å¯èƒ½æ˜¯æ ˆä¸Šåˆ†é…çš„å€™é€‰ï¼Œè€Œä¸æ˜¯å †ä¸Šåˆ†é…
- ***åŒæ­¥çœç•¥***ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è¢«å‘ç°åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªå¯¹è±¡çš„æ“ä½œå¯ä»¥ä¸è€ƒè™‘åŒæ­¥ã€‚
- ***åˆ†ç¦»å¯¹è±¡æˆ–æ ‡é‡æ›¿æ¢***ï¼šæœ‰çš„å¯¹è±¡å¯èƒ½ä¸éœ€è¦ä½œä¸ºä¸€ä¸ªè¿ç»­çš„å†…å­˜ç»“æ„å­˜åœ¨ä¹Ÿå¯ä»¥è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹è±¡çš„éƒ¨åˆ†ï¼ˆæˆ–å…¨éƒ¨ï¼‰å¯ä»¥ä¸å­˜å‚¨åœ¨å†…å­˜ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨CPUå¯„å­˜å™¨ä¸­ã€‚

### æ ˆä¸Šåˆ†é…

JITç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®é€ƒé€¸åˆ†æçš„ç»“æœï¼Œå‘ç°å¦‚æœä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚åˆ†é…å®Œæˆåï¼Œç»§ç»­åœ¨è°ƒç”¨æ ˆå†…æ‰§è¡Œï¼Œæœ€åçº¿ç¨‹ç»“æŸï¼Œæ ˆç©ºé—´è¢«å›æ”¶ï¼Œå±€éƒ¨å˜é‡å¯¹è±¡ä¹Ÿè¢«å›æ”¶ã€‚è¿™æ ·å°±æ— é¡»è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚

***å¸¸è§çš„æ ˆä¸Šåˆ†é…çš„åœºæ™¯***

> åœ¨é€ƒé€¸åˆ†æä¸­ï¼Œå·²ç»è¯´æ˜äº†ã€‚åˆ†åˆ«æ˜¯ç»™æˆå‘˜å˜é‡èµ‹å€¼ã€æ–¹æ³•è¿”å›å€¼ã€å®ä¾‹å¼•ç”¨ä¼ é€’ã€‚

æˆ‘ä»¬é€šè¿‡ä¸¾ä¾‹æ¥è¯´æ˜ å¼€å¯é€ƒé€¸åˆ†æ å’Œ æœªå¼€å¯é€ƒé€¸åˆ†ææ—¶å€™çš„æƒ…å†µ

```java
/**
 * æ ˆä¸Šåˆ†é…
 * -Xmx1G -Xms1G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails
 */
class User {
    private String name;
    private String age;
    private String gender;
    private String phone;
}
public class StackAllocation {
    public static void main(String[] args) throws InterruptedException {
        long start = System.currentTimeMillis();
        for (int i = 0; i < 100000000; i++) {
            alloc();
        }
        long end = System.currentTimeMillis();
        System.out.println("èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š" + (end - start) + " ms");

        // ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹å †å†…å­˜ä¸­å¯¹è±¡ä¸ªæ•°ï¼Œçº¿ç¨‹sleep
        Thread.sleep(10000000);
    }

    private static void alloc() {
        User user = new User();
    }
}
```

è®¾ç½®JVMå‚æ•°ï¼Œè¡¨ç¤ºæœªå¼€å¯é€ƒé€¸åˆ†æ

```
-Xmx1G -Xms1G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails
```

è¿è¡Œç»“æœï¼ŒåŒæ—¶è¿˜è§¦å‘äº†GCæ“ä½œ

```
èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š664 ms
```

ç„¶åæŸ¥çœ‹å†…å­˜çš„æƒ…å†µï¼Œå‘ç°æœ‰å¤§é‡çš„Userå­˜å‚¨åœ¨å †ä¸­

![image-20200707203038615](/assets/imgs/image-20200707203038615.png)



æˆ‘ä»¬åœ¨å¼€å¯é€ƒé€¸åˆ†æ

```
-Xmx1G -Xms1G -XX:+DoEscapeAnalysis -XX:+PrintGCDetails
```

ç„¶åæŸ¥çœ‹è¿è¡Œæ—¶é—´ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå‘ç°èŠ±è´¹çš„æ—¶é—´å¿«é€Ÿå‡å°‘ï¼ŒåŒæ—¶ä¸ä¼šå‘ç”ŸGCæ“ä½œ

```
èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š5 ms
```

ç„¶ååœ¨çœ‹å†…å­˜æƒ…å†µï¼Œæˆ‘ä»¬å‘ç°åªæœ‰å¾ˆå°‘çš„Userå¯¹è±¡ï¼Œè¯´æ˜Userå‘ç”Ÿäº†é€ƒé€¸ï¼Œå› ä¸ºä»–ä»¬å­˜å‚¨åœ¨æ ˆä¸­ï¼Œéšç€æ ˆçš„é”€æ¯è€Œæ¶ˆå¤±

![image-20200707203441718](/assets/imgs/image-20200707203441718.png)



### åŒæ­¥çœç•¥/é”æ¶ˆé™¤ 

çº¿ç¨‹åŒæ­¥çš„ä»£ä»·æ˜¯ç›¸å½“é«˜çš„ï¼ŒåŒæ­¥çš„åæœæ˜¯é™ä½å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚

åœ¨åŠ¨æ€ç¼–è¯‘åŒæ­¥å—çš„æ—¶å€™ï¼ŒJITç¼–è¯‘å™¨å¯ä»¥å€ŸåŠ©é€ƒé€¸åˆ†ææ¥åˆ¤æ–­åŒæ­¥å—æ‰€ä½¿ç”¨çš„é”å¯¹è±¡æ˜¯å¦åªèƒ½å¤Ÿè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®è€Œæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶ä»–çº¿ç¨‹ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆJITç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿™ä¸ªåŒæ­¥å—çš„æ—¶å€™å°±ä¼šå–æ¶ˆå¯¹è¿™éƒ¨åˆ†ä»£ç çš„åŒæ­¥ã€‚è¿™æ ·å°±èƒ½å¤§å¤§æé«˜å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚è¿™ä¸ªå–æ¶ˆåŒæ­¥çš„è¿‡ç¨‹å°±å«åŒæ­¥çœç•¥ï¼Œä¹Ÿå«é”æ¶ˆé™¤ã€‚

ä¾‹å¦‚ä¸‹é¢çš„ä»£ç 

```java
public void f() {
    Object hellis = new Object();
    synchronized(hellis) {
        System.out.println(hellis);
    }
}
```

ä»£ç ä¸­å¯¹hellisè¿™ä¸ªå¯¹è±¡åŠ é”ï¼Œä½†æ˜¯helliså¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåªåœ¨f()æ–¹æ³•ä¸­ï¼Œå¹¶ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰€è®¿é—®åˆ°ï¼Œæ‰€ä»¥åœ¨JITç¼–è¯‘é˜¶æ®µå°±ä¼šè¢«ä¼˜åŒ–æ‰ï¼Œä¼˜åŒ–æˆï¼š

```java
public void f() {
    Object hellis = new Object();
	System.out.println(hellis);
}
```

æˆ‘ä»¬å°†å…¶è½¬æ¢æˆå­—èŠ‚ç 

![image-20200707205634266](/assets/imgs/image-20200707205634266.png)



### åˆ†ç¦»å¯¹è±¡å’Œæ ‡é‡æ›¿æ¢

***æ ‡é‡ï¼ˆscalarï¼‰***æ˜¯æŒ‡ä¸€ä¸ªæ— æ³•å†åˆ†è§£æˆæ›´å°çš„æ•°æ®çš„æ•°æ®ã€‚Javaä¸­çš„åŸå§‹æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ã€‚

ç›¸å¯¹çš„ï¼Œé‚£äº›è¿˜å¯ä»¥åˆ†è§£çš„æ•°æ®å«åš***èšåˆé‡ï¼ˆAggregateï¼‰***ï¼ŒJavaä¸­çš„å¯¹è±¡å°±æ˜¯èšåˆé‡ï¼Œå› ä¸ºä»–å¯ä»¥åˆ†è§£æˆå…¶ä»–èšåˆé‡å’Œæ ‡é‡ã€‚

åœ¨JITé˜¶æ®µï¼Œå¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼Œå‘ç°ä¸€ä¸ªå¯¹è±¡ä¸ä¼šè¢«å¤–ç•Œè®¿é—®çš„è¯ï¼Œé‚£ä¹ˆç»è¿‡Jå·¥Tä¼˜åŒ–ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå¯¹è±¡æ‹†è§£æˆè‹¥å¹²ä¸ªå…¶ä¸­åŒ…å«çš„è‹¥å¹²ä¸ªæˆå‘˜å˜é‡æ¥ä»£æ›¿ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯***æ ‡é‡æ›¿æ¢***ã€‚

```java
public static void main(String args[]) {
    alloc();
}
class Point {
    private int x;
    private int y;
}
private static void alloc() {
    Point point = new Point(1,2);
    System.out.println("point.x" + point.x + ";point.y" + point.y);
}
```

ä»¥ä¸Šä»£ç ï¼Œç»è¿‡æ ‡é‡æ›¿æ¢åï¼Œå°±ä¼šå˜æˆ

```java
private static void alloc() {
    int x = 1;
    int y = 2;
    System.out.println("point.x = " + x + "; point.y=" + y);
}
```

å¯ä»¥çœ‹åˆ°ï¼ŒPointè¿™ä¸ªèšåˆé‡ç»è¿‡é€ƒé€¸åˆ†æåï¼Œå‘ç°ä»–å¹¶æ²¡æœ‰é€ƒé€¸ï¼Œå°±è¢«æ›¿æ¢æˆä¸¤ä¸ªèšåˆé‡äº†ã€‚é‚£ä¹ˆæ ‡é‡æ›¿æ¢æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿå°±æ˜¯å¯ä»¥å¤§å¤§å‡å°‘å †å†…å­˜çš„å ç”¨ã€‚å› ä¸ºä¸€æ—¦ä¸éœ€è¦åˆ›å»ºå¯¹è±¡äº†ï¼Œé‚£ä¹ˆå°±ä¸å†éœ€è¦åˆ†é…å †å†…å­˜äº†ã€‚
æ ‡é‡æ›¿æ¢ä¸ºæ ˆä¸Šåˆ†é…æä¾›äº†å¾ˆå¥½çš„åŸºç¡€ã€‚

### ä»£ç ä¼˜åŒ–ä¹‹æ ‡é‡æ›¿æ¢

ä¸Šè¿°ä»£ç åœ¨ä¸»å‡½æ•°ä¸­è¿›è¡Œäº†1äº¿æ¬¡allocã€‚è°ƒç”¨è¿›è¡Œå¯¹è±¡åˆ›å»ºï¼Œç”±äºUserå¯¹è±¡å®ä¾‹éœ€è¦å æ®çº¦16å­—èŠ‚çš„ç©ºé—´ï¼Œå› æ­¤ç´¯è®¡åˆ†é…ç©ºé—´è¾¾åˆ°å°†è¿‘1.5GBã€‚å¦‚æœå †ç©ºé—´å°äºè¿™ä¸ªå€¼ï¼Œå°±å¿…ç„¶ä¼šå‘ç”ŸGCã€‚ä½¿ç”¨å¦‚ä¸‹å‚æ•°è¿è¡Œä¸Šè¿°ä»£ç ï¼š

```bash
-server -Xmx100m -Xms100m -XX:+DoEscapeAnalysis -XX:+PrintGC -XX:+EliminateAllocations
```

è¿™é‡Œè®¾ç½®å‚æ•°å¦‚ä¸‹ï¼š

- å‚æ•°-serverï¼šå¯åŠ¨Serveræ¨¡å¼ï¼Œå› ä¸ºåœ¨serveræ¨¡å¼ä¸‹ï¼Œæ‰å¯ä»¥å¯ç”¨é€ƒé€¸åˆ†æã€‚
- å‚æ•°-XX:+DoEscapeAnalysisï¼šå¯ç”¨é€ƒé€¸åˆ†æ
- å‚æ•°-Xmx10mï¼šæŒ‡å®šäº†å †ç©ºé—´æœ€å¤§ä¸º10MB
- å‚æ•°-XX:+PrintGCï¼šå°†æ‰“å°Gcæ—¥å¿—ã€‚
- å‚æ•°ä¸€xxï¼š+EliminateAllocationsï¼šå¼€å¯äº†æ ‡é‡æ›¿æ¢ï¼ˆé»˜è®¤æ‰“å¼€ï¼‰ï¼Œå…è®¸å°†å¯¹è±¡æ‰“æ•£åˆ†é…åœ¨æ ˆä¸Šï¼Œæ¯”å¦‚å¯¹è±¡æ‹¥æœ‰idå’Œnameä¸¤ä¸ªå­—æ®µï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå­—æ®µå°†ä¼šè¢«è§†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å±€éƒ¨å˜é‡è¿›è¡Œåˆ†é…

### é€ƒé€¸åˆ†æçš„ä¸è¶³

1. å…³äºé€ƒé€¸åˆ†æçš„è®ºæ–‡åœ¨1999å¹´å°±å·²ç»å‘è¡¨äº†ï¼Œä½†ç›´åˆ°JDK1.6æ‰æœ‰å®ç°ï¼Œè€Œä¸”***è¿™é¡¹æŠ€æœ¯åˆ°å¦‚ä»Šä¹Ÿå¹¶ä¸æ˜¯ååˆ†æˆç†Ÿçš„ã€‚***

2. å…¶æ ¹æœ¬åŸå› å°±æ˜¯***æ— æ³•ä¿è¯é€ƒé€¸åˆ†æçš„æ€§èƒ½æ¶ˆè€—ä¸€å®šèƒ½é«˜äºä»–çš„æ¶ˆè€—ã€‚è™½ç„¶ç»è¿‡é€ƒé€¸åˆ†æå¯ä»¥åšæ ‡é‡æ›¿æ¢ã€æ ˆä¸Šåˆ†é…ã€å’Œé”æ¶ˆé™¤ã€‚ä½†æ˜¯é€ƒé€¸åˆ†æè‡ªèº«ä¹Ÿæ˜¯éœ€è¦è¿›è¡Œä¸€ç³»åˆ—å¤æ‚çš„åˆ†æçš„ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹è€—æ—¶çš„è¿‡ç¨‹ã€‚***
3. ***ä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼Œå°±æ˜¯ç»è¿‡é€ƒé€¸åˆ†æä¹‹åï¼Œå‘ç°æ²¡æœ‰ä¸€ä¸ªå¯¹è±¡æ˜¯ä¸é€ƒé€¸çš„ã€‚é‚£è¿™ä¸ªé€ƒé€¸åˆ†æçš„è¿‡ç¨‹å°±ç™½ç™½æµªè´¹æ‰äº†ã€‚***

4. ***è™½ç„¶è¿™é¡¹æŠ€æœ¯å¹¶ä¸ååˆ†æˆç†Ÿï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯å³æ—¶ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ä¸­ä¸€ä¸ªååˆ†é‡è¦çš„æ‰‹æ®µã€‚***
5. æ³¨æ„åˆ°æœ‰ä¸€äº›è§‚ç‚¹ï¼Œè®¤ä¸ºé€šè¿‡é€ƒé€¸åˆ†æï¼ŒJVMä¼šåœ¨æ ˆä¸Šåˆ†é…é‚£äº›ä¸ä¼šé€ƒé€¸çš„å¯¹è±¡ï¼Œè¿™åœ¨ç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å–å†³äº JVM è®¾è®¡è€…çš„é€‰æ‹©ã€‚æ®æˆ‘æ‰€çŸ¥ï¼Œ***oracle Hotspot JVMä¸­å¹¶æœªè¿™ä¹ˆåš(ä½†ä½¿ç”¨äº†æ ‡é‡æ›¿æ¢)ï¼Œè¿™ä¸€ç‚¹åœ¨é€ƒé€¸åˆ†æç›¸å…³çš„æ–‡æ¡£é‡Œå·²ç»è¯´æ˜ï¼Œæ‰€ä»¥å¯ä»¥æ˜ç¡®æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ›å»ºåœ¨å †ä¸Šã€‚***

6. ç›®å‰å¾ˆå¤šä¹¦ç±è¿˜æ˜¯åŸºäºJDK7ä»¥å‰çš„ç‰ˆæœ¬ï¼ŒJDKå·²ç»å‘ç”Ÿäº†å¾ˆå¤§å˜åŒ–ï¼Œinternå­—ç¬¦ä¸²çš„ç¼“å­˜å’Œé™æ€å˜é‡æ›¾ç»éƒ½è¢«åˆ†é…åœ¨æ°¸ä¹…ä»£ä¸Šï¼Œè€Œæ°¸ä¹…ä»£å·²ç»è¢«å…ƒæ•°æ®åŒºå–ä»£ã€‚ä½†æ˜¯ï¼Œinternå­—ç¬¦ä¸²ç¼“å­˜å’Œé™æ€å˜é‡å¹¶ä¸æ˜¯è¢«è½¬ç§»åˆ°å…ƒæ•°æ®åŒºï¼Œè€Œæ˜¯ç›´æ¥åœ¨å †ä¸Šåˆ†é…ï¼Œ***æ‰€ä»¥è¿™ä¸€ç‚¹åŒæ ·ç¬¦åˆå‰é¢ä¸€ç‚¹çš„ç»“è®ºï¼šå¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ†é…åœ¨å †ä¸Šã€‚***

## å°ç»“

å¹´è½»ä»£æ˜¯å¯¹è±¡çš„è¯ç”Ÿã€æˆé•¿ã€æ¶ˆäº¡çš„åŒºåŸŸï¼Œä¸€ä¸ªå¯¹è±¡åœ¨è¿™é‡Œäº§ç”Ÿã€åº”ç”¨ï¼Œæœ€åè¢«åƒåœ¾å›æ”¶å™¨æ”¶é›†ã€ç»“æŸç”Ÿå‘½ã€‚

è€å¹´ä»£æ”¾ç½®é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼Œé€šå¸¸éƒ½æ˜¯ä»survivoråŒºåŸŸç­›é€‰æ‹·è´è¿‡æ¥çš„Javaå¯¹è±¡ã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰ç‰¹æ®Šæƒ…å†µï¼Œæˆ‘ä»¬çŸ¥é“æ™®é€šçš„å¯¹è±¡ä¼šè¢«åˆ†é…åœ¨TLABä¸Šï¼›å¦‚æœå¯¹è±¡è¾ƒå¤§ï¼ŒJVMä¼šè¯•å›¾ç›´æ¥åˆ†é…åœ¨Edenå…¶ä»–ä½ç½®ä¸Šï¼›å¦‚æœå¯¹è±¡å¤ªå¤§ï¼Œå®Œå…¨æ— æ³•åœ¨æ–°ç”Ÿä»£æ‰¾åˆ°è¶³å¤Ÿé•¿çš„è¿ç»­ç©ºé—²ç©ºé—´ï¼ŒJVMå°±ä¼šç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ã€‚å½“GCåªå‘ç”Ÿåœ¨å¹´è½»ä»£ä¸­ï¼Œå›æ”¶å¹´è½»ä»£å¯¹è±¡çš„è¡Œä¸ºè¢«ç§°ä¸ºMinorGcã€‚

å½“GCå‘ç”Ÿåœ¨è€å¹´ä»£æ—¶åˆ™è¢«ç§°ä¸ºMajorGcæˆ–è€…FullGCã€‚ä¸€èˆ¬çš„ï¼ŒMinorGcçš„å‘ç”Ÿé¢‘ç‡è¦æ¯”MajorGCé«˜å¾ˆå¤šï¼Œå³è€å¹´ä»£ä¸­åƒåœ¾å›æ”¶å‘ç”Ÿçš„é¢‘ç‡å°†å¤§å¤§ä½äºå¹´è½»ä»£ã€‚