---
layout: post
title:  "é˜»å¡é˜Ÿåˆ—ä¸çº¿ç¨‹æ± "
date:   2020-12-23 14:10:06 +0800--
categories: [å¹¶å‘ç¼–ç¨‹]
tags: [å¹¶å‘ç¼–ç¨‹, ]  

---

# é˜»å¡é˜Ÿåˆ—

## æ¦‚å¿µ

### é˜Ÿåˆ—

é˜Ÿåˆ—å°±å¯ä»¥æƒ³æˆæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä»ä¸€å¤´è¿›å…¥ï¼Œä¸€å¤´å‡ºå»ï¼Œæ’é˜Ÿä¹°é¥­

### é˜»å¡é˜Ÿåˆ—

BlockingQueue   é˜»å¡é˜Ÿåˆ—ï¼Œæ’é˜Ÿæ‹¥å µï¼Œé¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œä¸€ä¸ªé˜»å¡é˜Ÿåˆ—åœ¨æ•°æ®ç»“æ„ä¸­æ‰€èµ·çš„ä½œç”¨å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20200316152120272](/assets/imgs/image-20200316152120272.png)

çº¿ç¨‹1å¾€é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ ï¼Œè€Œçº¿ç¨‹2ä»é˜»å¡é˜Ÿåˆ—ä¸­ç§»é™¤å…ƒç´ 

- `å½“é˜»å¡é˜Ÿåˆ—æ˜¯ç©ºæ—¶ï¼Œä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡`
  - å½“è›‹ç³•åº—çš„æŸœå­ç©ºçš„æ—¶å€™ï¼Œæ— æ³•ä»æŸœå­é‡Œé¢è·å–è›‹ç³•

- `å½“é˜»å¡é˜Ÿåˆ—æ˜¯æ»¡æ—¶ï¼Œä»é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡`
  - å½“è›‹ç³•åº—çš„æŸœå­æ»¡çš„æ—¶å€™ï¼Œæ— æ³•ç»§ç»­å‘æŸœå­é‡Œé¢æ·»åŠ è›‹ç³•äº†

ä¹Ÿå°±æ˜¯è¯´ è¯•å›¾ä»ç©ºçš„é˜»å¡é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„çº¿ç¨‹å°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å…¶å®ƒçº¿ç¨‹å¾€ç©ºçš„é˜Ÿåˆ—æ’å…¥æ–°çš„å…ƒç´ 

åŒç†ï¼Œè¯•å›¾å¾€å·²ç»æ»¡çš„é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ æ–°å…ƒç´ çš„çº¿ç¨‹ï¼Œç›´åˆ°å…¶å®ƒçº¿ç¨‹å¾€æ»¡çš„é˜Ÿåˆ—ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œæˆ–è€…å®Œå…¨æ¸…ç©ºé˜Ÿåˆ—åï¼Œä½¿é˜Ÿåˆ—é‡æ–°å˜å¾—ç©ºé—²èµ·æ¥ï¼Œå¹¶åç»­æ–°å¢

## ä¸ºä»€ä¹ˆè¦ç”¨ï¼Ÿ

å»æµ·åº•æåƒé¥­ï¼Œå¤§å…æ»¡äº†ï¼Œéœ€è¦è¿›å€™å…ç­‰å¾…ï¼Œä½†æ˜¯è¿™äº›ç­‰å¾…çš„å®¢æˆ·èƒ½å¤Ÿå¯¹å•†å®¶å¸¦æ¥åˆ©æ¶¦ï¼Œå› æ­¤æˆ‘ä»¬éå¸¸æ¬¢è¿ä»–ä»¬é˜»å¡

åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼šæ‰€è°“çš„é˜»å¡ï¼Œåœ¨æŸäº›æ¸…ç©ºä¸‹ä¼š**æŒ‚èµ·**çº¿ç¨‹ï¼ˆå³é˜»å¡ï¼‰ï¼Œä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œè¢«æŒ‚èµ·çš„çº¿ç¨‹åˆä¼š**è‡ªåŠ¨å”¤é†’**

### ä¸ºä»€ä¹ˆéœ€è¦BlockingQueue

**å¥½å¤„æ˜¯æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä»€ä¹ˆæ—¶å€™éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å”¤é†’çº¿ç¨‹ï¼Œå› ä¸ºè¿™ä¸€åˆ‡BlockingQueueéƒ½å¸®ä½ ä¸€æ‰‹åŒ…åŠäº†**

åœ¨concurrentåŒ…å‘å¸ƒä»¥å‰ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ**æˆ‘ä»¬æ¯ä¸ªç¨‹åºå‘˜éƒ½å¿…é¡»è‡ªå·±å–æ§åˆ¶è¿™äº›ç»†èŠ‚ï¼Œå°¤å…¶è¿˜è¦å…¼é¡¾æ•ˆç‡å’Œçº¿ç¨‹å®‰å…¨ï¼Œè€Œè¿™ä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸å°çš„å¤æ‚åº¦ã€‚**

## æ¶æ„

```java
// ä½ ç”¨è¿‡Listé›†åˆç±»

// ArrayListé›†åˆç±»ç†Ÿæ‚‰ä¹ˆï¼Ÿ

// è¿˜ç”¨è¿‡ CopyOnWriteList  å’Œ BlockingQueue
```

**BlockingQueueé˜»å¡é˜Ÿåˆ—æ˜¯å±äºä¸€ä¸ªæ¥å£ï¼Œåº•ä¸‹æœ‰ä¸ƒä¸ªå®ç°ç±»:**

- **ArrayBlockQueueï¼šç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—**
- **LinkedBlockingQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œï¼ˆä½†æ˜¯é»˜è®¤å¤§å° Integer.MAX_VALUEï¼‰çš„é˜»å¡é˜Ÿåˆ—**
  - æœ‰ç•Œï¼Œä½†æ˜¯ç•Œé™éå¸¸å¤§ï¼Œç›¸å½“äºæ— ç•Œï¼Œå¯ä»¥å½“æˆæ— ç•Œ
- PriorityBlockQueueï¼šæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—
- DelayQueueï¼šä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—
- **SynchronousQueueï¼šä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¹Ÿå³å•ä¸ªå…ƒç´ çš„é˜Ÿåˆ—**
  - ç”Ÿäº§ä¸€ä¸ªï¼Œæ¶ˆè´¹ä¸€ä¸ªï¼Œä¸å­˜å‚¨å…ƒç´ ï¼Œä¸æ¶ˆè´¹ä¸ç”Ÿäº§
- LinkedTransferQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—
- LinkedBlocking**Deque**ï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—



è¿™é‡Œéœ€è¦æŒæ¡çš„æ˜¯ï¼šArrayBlockQueueã€LinkedBlockingQueueã€SynchronousQueue



## BlockingQueueæ ¸å¿ƒæ–¹æ³•

âš ï¸ æ£€æŸ¥ï¼šæŸ¥çœ‹é˜Ÿåˆ—ç©ºä¸ç©ºï¼Œå¹¶ä¸”è¿”å›é˜Ÿé¦–å…ƒç´ 

![image-20200316154442756](/assets/imgs/image-20200316154442756.png)



| æŠ›å‡ºå¼‚å¸¸ | å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼šåœ¨å¾€é˜Ÿåˆ—ä¸­addæ’å…¥å…ƒç´ ä¼šæŠ›å‡º IIIegalStateExceptionï¼šQueue full                                                                     å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼šå†å¾€é˜Ÿåˆ—ä¸­removeç§»é™¤å…ƒç´ ï¼Œä¼šæŠ›å‡ºNoSuchException |
| -------- | ------------------------------------------------------------ |
| ç‰¹æ®Šæ€§   | æ’å…¥æ–¹æ³•ï¼ŒæˆåŠŸtrueï¼Œå¤±è´¥false       ç§»é™¤æ–¹æ³•ï¼šæˆåŠŸè¿”å›å‡ºé˜Ÿåˆ—å…ƒç´ ï¼Œé˜Ÿåˆ—æ²¡æœ‰å°±è¿”å›ç©º |
| ä¸€ç›´é˜»å¡ | å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”Ÿäº§è€…ç»§ç»­å¾€é˜Ÿåˆ—é‡Œputå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§çº¿ç¨‹ç›´åˆ°putæ•°æ®orå“åº”ä¸­æ–­é€€å‡ºï¼Œ å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œtakeå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—å¯ç”¨ã€‚ |
| è¶…æ—¶é€€å‡º | å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿé‡Œä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œè¶…è¿‡é™æ—¶åç”Ÿäº§è€…çº¿ç¨‹ä¼šé€€å‡º |



### æŠ›å‡ºå¼‚å¸¸ç»„

**ä½†æ‰§è¡Œaddæ–¹æ³•ï¼Œå‘å·²ç»æ»¡çš„ArrayBlockingQueueä¸­æ·»åŠ å…ƒç´ æ—¶å€™ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸**

```java
// é˜»å¡é˜Ÿåˆ—ï¼Œéœ€è¦å¡«å…¥é»˜è®¤å€¼
BlockingQueue<String> blockingQueue = new ArrayBlockingQueue<>(3);

System.out.println(blockingQueue.add("a"));
System.out.println(blockingQueue.add("b"));
System.out.println(blockingQueue.add("c"));

System.out.println(blockingQueue.add("XXX"));
```

è¿è¡Œåï¼š

```java
true
true
true
Exception in thread "main" java.lang.IllegalStateException: Queue full
	at java.util.AbstractQueue.add(AbstractQueue.java:98)
	at java.util.concurrent.ArrayBlockingQueue.add(ArrayBlockingQueue.java:312)
	at com.moxi.interview.study.queue.BlockingQueueDemo.main(BlockingQueueDemo.java:25)
```

**åŒæ—¶å¦‚æœæˆ‘ä»¬å¤šå–å‡ºå…ƒç´ çš„æ—¶å€™ï¼Œä¹Ÿä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæˆ‘ä»¬å‡è®¾åªå­˜å‚¨äº†3ä¸ªå€¼ï¼Œä½†æ˜¯å–çš„æ—¶å€™ï¼Œå–äº†å››æ¬¡**

```java
// é˜»å¡é˜Ÿåˆ—ï¼Œéœ€è¦å¡«å…¥é»˜è®¤å€¼
BlockingQueue<String> blockingQueue = new ArrayBlockingQueue<>(3);
System.out.println(blockingQueue.add("a"));
System.out.println(blockingQueue.add("b"));
System.out.println(blockingQueue.add("c"));

System.out.println(blockingQueue.remove());
System.out.println(blockingQueue.remove());
System.out.println(blockingQueue.remove());
System.out.println(blockingQueue.remove());
```

é‚£ä¹ˆå‡ºç°å¼‚å¸¸

```java
true
true
true
a
b
c
Exception in thread "main" java.util.NoSuchElementException
	at java.util.AbstractQueue.remove(AbstractQueue.java:117)
	at com.moxi.interview.study.queue.BlockingQueueDemo.main(BlockingQueueDemo.java:30)
```

### å¸ƒå°”ç±»å‹ç»„

æˆ‘ä»¬ä½¿ç”¨ offerçš„æ–¹æ³•ï¼Œæ·»åŠ å…ƒç´ æ—¶å€™ï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—æ»¡äº†åï¼Œä¼šè¿”å›falseï¼Œå¦è€…è¿”å›true

åŒæ—¶åœ¨å–çš„æ—¶å€™ï¼Œå¦‚æœé˜Ÿåˆ—å·²ç©ºï¼Œé‚£ä¹ˆä¼šè¿”å›null

```java
BlockingQueue blockingQueue = new ArrayBlockingQueue(3);

System.out.println(blockingQueue.offer("a"));
System.out.println(blockingQueue.offer("b"));
System.out.println(blockingQueue.offer("c"));
System.out.println(blockingQueue.offer("d"));

System.out.println(blockingQueue.poll());
System.out.println(blockingQueue.poll());
System.out.println(blockingQueue.poll());
System.out.println(blockingQueue.poll());
```

è¿è¡Œç»“æœ

```java
true
true
true
false
a
b
c
null
```

### é˜»å¡é˜Ÿåˆ—ç»„

æˆ‘ä»¬ä½¿ç”¨ putçš„æ–¹æ³•ï¼Œæ·»åŠ å…ƒç´ æ—¶å€™ï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—æ»¡äº†åï¼Œæ·»åŠ æ¶ˆæ¯çš„çº¿ç¨‹ï¼Œä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—å…ƒç´ å‡å°‘ï¼Œä¼šè¢«æ¸…ç©ºï¼Œæ‰ä¼šå”¤é†’

ä¸€èˆ¬åœ¨æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ¯”å¦‚RabbitMQä¸­ä¼šä½¿ç”¨åˆ°ï¼Œå› ä¸ºéœ€è¦ä¿è¯æ¶ˆæ¯ç™¾åˆ†ç™¾ä¸ä¸¢å¤±ï¼Œå› æ­¤åªæœ‰è®©å®ƒé˜»å¡

```java
BlockingQueue<String> blockingQueue = new ArrayBlockingQueue<>(3);
blockingQueue.put("a");
blockingQueue.put("b");
blockingQueue.put("c");
System.out.println("================");

blockingQueue.take();
blockingQueue.take();
blockingQueue.take();
blockingQueue.take();
```

åŒæ—¶ä½¿ç”¨takeå–æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¦‚æœå†…å®¹ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œä¹Ÿä¼šè¢«é˜»å¡



### ä¸è§ä¸æ•£ç»„

offer( )  ï¼Œ poll åŠ æ—¶é—´

ä½¿ç”¨offeræ’å…¥çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šæ—¶é—´ï¼Œå¦‚æœ2ç§’è¿˜æ²¡æœ‰æ’å…¥ï¼Œé‚£ä¹ˆå°±æ”¾å¼ƒæ’å…¥

```java
BlockingQueue<String> blockingQueue = new ArrayBlockingQueue<>(3);
System.out.println(blockingQueue.offer("a", 2L, TimeUnit.SECONDS));
System.out.println(blockingQueue.offer("b", 2L, TimeUnit.SECONDS));
System.out.println(blockingQueue.offer("c", 2L, TimeUnit.SECONDS));
System.out.println(blockingQueue.offer("d", 2L, TimeUnit.SECONDS));
```

åŒæ—¶å–çš„æ—¶å€™ä¹Ÿè¿›è¡Œåˆ¤æ–­

```java
System.out.println(blockingQueue.poll(2L, TimeUnit.SECONDS));
System.out.println(blockingQueue.poll(2L, TimeUnit.SECONDS));
System.out.println(blockingQueue.poll(2L, TimeUnit.SECONDS));
System.out.println(blockingQueue.poll(2L, TimeUnit.SECONDS));
```

å¦‚æœ2ç§’å†…å–ä¸å‡ºæ¥ï¼Œé‚£ä¹ˆå°±è¿”å›null

## SynchronousQueue

**SynchronousQueueæ²¡æœ‰å®¹é‡ï¼Œä¸å…¶ä»–BlockingQueueä¸åŒï¼ŒSynchronousQueueæ˜¯ä¸€ä¸ªä¸å­˜å‚¨çš„BlockingQueueï¼ˆ0åº“å­˜ï¼‰ï¼Œæ¯ä¸€ä¸ªputæ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œå¦è€…ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ **

ä¸‹é¢æˆ‘ä»¬æµ‹è¯•SynchronousQueueæ·»åŠ å…ƒç´ çš„è¿‡ç¨‹

é¦–å…ˆæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹ç”¨äºç”Ÿäº§ï¼Œä¸€ä¸ªçº¿ç¨‹ç”¨äºæ¶ˆè´¹

ç”Ÿäº§çš„çº¿ç¨‹åˆ†åˆ«putäº† Aã€Bã€Cè¿™ä¸‰ä¸ªå­—æ®µ

```java
BlockingQueue<String> blockingQueue = new SynchronousQueue<>();

new Thread(() -> {
    try {       
        System.out.println(Thread.currentThread().getName() + "\t put A ");
        blockingQueue.put("A");
       
        System.out.println(Thread.currentThread().getName() + "\t put B ");
        blockingQueue.put("B");        
        
        System.out.println(Thread.currentThread().getName() + "\t put C ");
        blockingQueue.put("C");        
        
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}, "t1").start();
```

æ¶ˆè´¹çº¿ç¨‹ä½¿ç”¨takeï¼Œæ¶ˆè´¹é˜»å¡é˜Ÿåˆ—ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”æ¯æ¬¡æ¶ˆè´¹å‰ï¼Œéƒ½ç­‰å¾…5ç§’

```java
new Thread(() -> {
  try {

    try {
      TimeUnit.SECONDS.sleep(5);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    blockingQueue.take();
    System.out.println(Thread.currentThread().getName() + "\t take A ");

    try {
      TimeUnit.SECONDS.sleep(5);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    blockingQueue.take();
    System.out.println(Thread.currentThread().getName() + "\t take B ");

    try {
      TimeUnit.SECONDS.sleep(5);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    blockingQueue.take();
    System.out.println(Thread.currentThread().getName() + "\t take C ");

  } catch (InterruptedException e) {
    e.printStackTrace();
  }
}, "t2").start();
```

æœ€åç»“æœè¾“å‡ºä¸ºï¼š

```java
t1	 put A 
t2	 take A 

5ç§’å...

t1	 put B 
t2	 take B 

5ç§’å...

t1	 put C 
t2	 take C 
```

æˆ‘ä»¬ä»æœ€åçš„è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ¯æ¬¡t1çº¿ç¨‹å‘é˜Ÿåˆ—ä¸­æ·»åŠ é˜»å¡é˜Ÿåˆ—æ·»åŠ å…ƒç´ åï¼Œt1è¾“å…¥çº¿ç¨‹å°±ä¼šç­‰å¾… t2æ¶ˆè´¹çº¿ç¨‹ï¼Œt2æ¶ˆè´¹åï¼Œt2å¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œç­‰å¾…t1åœ¨å­˜å…¥ï¼Œä»è€Œå‘¨è€Œå¤å§‹ï¼Œå½¢æˆå­˜ä¸€å–ä¸€çš„çŠ¶æ€

## é˜»å¡é˜Ÿåˆ—çš„ç”¨å¤„

## ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼

ä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„å˜é‡ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹å…¶äº¤æ›¿æ“ä½œï¼Œä¸€ä¸ªåŠ 1ï¼Œä¸€ä¸ªå‡1ï¼Œæ¥5è½®

å…³äºå¤šçº¿ç¨‹çš„æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦è®°ä½ä¸‹é¢å‡ å¥

- **çº¿ç¨‹ æ“ä½œ(æ–¹æ³•) èµ„æºç±»**
- **åˆ¤æ–­(while) å¹²æ´» é€šçŸ¥**
- **é˜²æ­¢è™šå‡å”¤é†’æœºåˆ¶**

æˆ‘ä»¬ä¸‹é¢å®ç°ä¸€ä¸ªç®€å•çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼Œé¦–å…ˆæœ‰èµ„æºç±»ShareData

```java
/**
 * èµ„æºç±»
 */
class ShareData {

    private int number = 0;

    private Lock lock = new ReentrantLock();

    private Condition condition = lock.newCondition();

    public void increment() throws Exception{
        // åŒæ­¥ä»£ç å—ï¼ŒåŠ é”
        lock.lock();
        try {
            // åˆ¤æ–­
            while(number != 0) {
                // ç­‰å¾…ä¸èƒ½ç”Ÿäº§
                condition.await();
            }

            // å¹²æ´»
            number++;

            System.out.println(Thread.currentThread().getName() + "\t " + number);

            // é€šçŸ¥ å”¤é†’
            condition.signalAll();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

    public void decrement() throws Exception{
        // åŒæ­¥ä»£ç å—ï¼ŒåŠ é”
        lock.lock();
        try {
            // åˆ¤æ–­
            while(number == 0) {
                // ç­‰å¾…ä¸èƒ½æ¶ˆè´¹
                condition.await();
            }

            // å¹²æ´»
            number--;

            System.out.println(Thread.currentThread().getName() + "\t " + number);

            // é€šçŸ¥ å”¤é†’
            condition.signalAll();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

}
```

é‡Œé¢æœ‰ä¸€ä¸ªnumberå˜é‡ï¼ŒåŒæ—¶æä¾›äº†increment å’Œ decrementçš„æ–¹æ³•ï¼Œåˆ†åˆ«è®©number åŠ 1å’Œå‡1

âš ï¸ **ä½†æ˜¯æˆ‘ä»¬åœ¨è¿›è¡Œåˆ¤æ–­çš„æ—¶å€™ï¼Œä¸ºäº†é˜²æ­¢å‡ºç°è™šå‡å”¤é†’æœºåˆ¶ï¼Œä¸èƒ½ä½¿ç”¨ifæ¥è¿›è¡Œåˆ¤æ–­ï¼Œè€Œåº”è¯¥ä½¿ç”¨while**

```java
// åˆ¤æ–­
while(number != 0) {
    // ç­‰å¾…ä¸èƒ½ç”Ÿäº§
    condition.await();
}
```

ä¸èƒ½ä½¿ç”¨ ifåˆ¤æ–­

```java
// åˆ¤æ–­
if(number != 0) {
    // ç­‰å¾…ä¸èƒ½ç”Ÿäº§
    condition.await();
}
```

å®Œæ•´ä»£ç 

```java
/**
 * ç”Ÿäº§è€…æ¶ˆè´¹è€… ä¼ ç»Ÿç‰ˆ
 * é¢˜ç›®ï¼šä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„å˜é‡ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹å…¶äº¤æ›¿æ“ä½œï¼Œä¸€ä¸ªåŠ 1ï¼Œä¸€ä¸ªå‡1ï¼Œæ¥5è½®
 */
/**
 * çº¿ç¨‹ æ“ä½œ èµ„æºç±»
 * åˆ¤æ–­ å¹²æ´» é€šçŸ¥
 * é˜²æ­¢è™šå‡å”¤é†’æœºåˆ¶
 */

/**
 * èµ„æºç±»
 */
class ShareData {

    private int number = 0;

    private Lock lock = new ReentrantLock();

    private Condition condition = lock.newCondition();

    public void increment() throws Exception{
        // åŒæ­¥ä»£ç å—ï¼ŒåŠ é”
        lock.lock();
        try {
            // åˆ¤æ–­
            while(number != 0) {
                // ç­‰å¾…ä¸èƒ½ç”Ÿäº§
                condition.await();
            }

            // å¹²æ´»
            number++;

            System.out.println(Thread.currentThread().getName() + "\t " + number);

            // é€šçŸ¥ å”¤é†’
            condition.signalAll();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

    public void decrement() throws Exception{
        // åŒæ­¥ä»£ç å—ï¼ŒåŠ é”
        lock.lock();
        try {
            // åˆ¤æ–­
            while(number == 0) {
                // ç­‰å¾…ä¸èƒ½æ¶ˆè´¹
                condition.await();
            }

            // å¹²æ´»
            number--;

            System.out.println(Thread.currentThread().getName() + "\t " + number);

            // é€šçŸ¥ å”¤é†’
            condition.signalAll();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

}
public class ProdConsumerTraditionDemo {

    public static void main(String[] args) {

        // é«˜å†…èšï¼Œä½è€¦åˆ    å†…èšæŒ‡çš„æ˜¯ï¼Œä¸€ä¸ªç©ºè°ƒï¼Œè‡ªèº«å¸¦æœ‰è°ƒèŠ‚æ¸©åº¦é«˜ä½çš„æ–¹æ³•

        ShareData shareData = new ShareData();

        // t1çº¿ç¨‹ï¼Œç”Ÿäº§
        new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                try {
                    shareData.increment();
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }, "t1").start();

        // t2çº¿ç¨‹ï¼Œæ¶ˆè´¹
        new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                try {
                    shareData.decrement();
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }, "t2").start();
    }
}
```

æœ€åè¿è¡ŒæˆåŠŸåï¼Œæˆ‘ä»¬ä¸€ä¸ªè¿›è¡Œç”Ÿäº§ï¼Œä¸€ä¸ªè¿›è¡Œæ¶ˆè´¹

```java
t1	 1
t2	 0
t1	 1
t2	 0
t1	 1
t2	 0
t1	 1
t2	 0
t1	 1
t2	 0
```

## ç”Ÿæˆè€…å’Œæ¶ˆè´¹è€…3.0

åœ¨concurrentåŒ…å‘å¸ƒä»¥å‰ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬æ¯ä¸ªç¨‹åºå‘˜éƒ½å¿…é¡»è‡ªå·±å»æ§åˆ¶è¿™äº›ç»†èŠ‚ï¼Œå°¤å…¶è¿˜è¦å…¼é¡¾æ•ˆç‡å’Œçº¿ç¨‹å®‰å…¨ï¼Œåˆ™è¿™ä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸å°çš„æ—¶é—´å¤æ‚åº¦

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨æ–°ç‰ˆçš„é˜»å¡é˜Ÿåˆ—ç‰ˆç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œä½¿ç”¨ï¼švolatileã€CASã€atomicIntegerã€BlockQueueã€çº¿ç¨‹äº¤äº’ã€åŸå­å¼•ç”¨

```java
/**
 * ç”Ÿäº§è€…æ¶ˆè´¹è€…  é˜»å¡é˜Ÿåˆ—ç‰ˆ
 * ä½¿ç”¨ï¼švolatileã€CASã€atomicIntegerã€BlockQueueã€çº¿ç¨‹äº¤äº’ã€åŸå­å¼•ç”¨
 */

class MyResource {
    // é»˜è®¤å¼€å¯ï¼Œè¿›è¡Œç”Ÿäº§æ¶ˆè´¹
    // è¿™é‡Œç”¨åˆ°äº†volatileæ˜¯ä¸ºäº†ä¿æŒæ•°æ®çš„å¯è§æ€§ï¼Œä¹Ÿå°±æ˜¯å½“TLAGä¿®æ”¹æ—¶ï¼Œè¦é©¬ä¸Šé€šçŸ¥å…¶å®ƒçº¿ç¨‹è¿›è¡Œä¿®æ”¹
    private volatile boolean FLAG = true;

    // ä½¿ç”¨åŸå­åŒ…è£…ç±»ï¼Œè€Œä¸ç”¨number++
    private AtomicInteger atomicInteger = new AtomicInteger();

    // è¿™é‡Œä¸èƒ½ä¸ºäº†æ»¡è¶³æ¡ä»¶ï¼Œè€Œå®ä¾‹åŒ–ä¸€ä¸ªå…·ä½“çš„SynchronousBlockingQueue
    BlockingQueue<String> blockingQueue = null;

    // è€Œåº”è¯¥é‡‡ç”¨ä¾èµ–æ³¨å…¥é‡Œé¢çš„ï¼Œæ„é€ æ³¨å…¥æ–¹æ³•ä¼ å…¥
    public MyResource(BlockingQueue<String> blockingQueue) {
        this.blockingQueue = blockingQueue;
        // æŸ¥è¯¢å‡ºä¼ å…¥çš„classæ˜¯ä»€ä¹ˆ
        System.out.println(blockingQueue.getClass().getName());
    }

    /**
     * ç”Ÿäº§
     * @throws Exception
     */
    public void myProd() throws Exception{
        String data = null;
        boolean retValue;
        // å¤šçº¿ç¨‹ç¯å¢ƒçš„åˆ¤æ–­ï¼Œä¸€å®šè¦ä½¿ç”¨whileè¿›è¡Œï¼Œé˜²æ­¢å‡ºç°è™šå‡å”¤é†’
        // å½“FLAGä¸ºtrueçš„æ—¶å€™ï¼Œå¼€å§‹ç”Ÿäº§
        while(FLAG) {
            data = atomicInteger.incrementAndGet() + "";

            // 2ç§’å­˜å…¥1ä¸ªdata
            retValue = blockingQueue.offer(data, 2L, TimeUnit.SECONDS);
            if(retValue) {
                System.out.println(Thread.currentThread().getName() + "\t æ’å…¥é˜Ÿåˆ—:" + data  + "æˆåŠŸ" );
            } else {
                System.out.println(Thread.currentThread().getName() + "\t æ’å…¥é˜Ÿåˆ—:" + data  + "å¤±è´¥" );
            }

            try {
                TimeUnit.SECONDS.sleep(1);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }

        System.out.println(Thread.currentThread().getName() + "\t åœæ­¢ç”Ÿäº§ï¼Œè¡¨ç¤ºFLAG=falseï¼Œç”Ÿäº§ç»“æŸ");
    }

    /**
     * æ¶ˆè´¹
     * @throws Exception
     */
    public void myConsumer() throws Exception{
        String retValue;
        // å¤šçº¿ç¨‹ç¯å¢ƒçš„åˆ¤æ–­ï¼Œä¸€å®šè¦ä½¿ç”¨whileè¿›è¡Œï¼Œé˜²æ­¢å‡ºç°è™šå‡å”¤é†’
        // å½“FLAGä¸ºtrueçš„æ—¶å€™ï¼Œå¼€å§‹ç”Ÿäº§
        while(FLAG) {
            // 2ç§’å­˜å…¥1ä¸ªdata
            retValue = blockingQueue.poll(2L, TimeUnit.SECONDS);
            if(retValue != null && retValue != "") {
                System.out.println(Thread.currentThread().getName() + "\t æ¶ˆè´¹é˜Ÿåˆ—:" + retValue  + "æˆåŠŸ" );
            } else {
                FLAG = false;
                System.out.println(Thread.currentThread().getName() + "\t æ¶ˆè´¹å¤±è´¥ï¼Œé˜Ÿåˆ—ä¸­å·²ä¸ºç©ºï¼Œé€€å‡º" );

                // é€€å‡ºæ¶ˆè´¹é˜Ÿåˆ—
                return;
            }
        }
    }

    /**
     * åœæ­¢ç”Ÿäº§çš„åˆ¤æ–­
     */
    public void stop() {
        this.FLAG = false;
    }

}
public class ProdConsumerBlockingQueueDemo {

    public static void main(String[] args) {
        // ä¼ å…¥å…·ä½“çš„å®ç°ç±»ï¼Œ ArrayBlockingQueue
        MyResource myResource = new MyResource(new ArrayBlockingQueue<String>(10));

        new Thread(() -> {
            System.out.println(Thread.currentThread().getName() + "\t ç”Ÿäº§çº¿ç¨‹å¯åŠ¨");
            System.out.println("");
            System.out.println("");
            try {
                myResource.myProd();
                System.out.println("");
                System.out.println("");
            } catch (Exception e) {
                e.printStackTrace();
            }
        }, "prod").start();


        new Thread(() -> {
            System.out.println(Thread.currentThread().getName() + "\t æ¶ˆè´¹çº¿ç¨‹å¯åŠ¨");

            try {
                myResource.myConsumer();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }, "consumer").start();

        // 5ç§’åï¼Œåœæ­¢ç”Ÿäº§å’Œæ¶ˆè´¹
        try {
            TimeUnit.SECONDS.sleep(5);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        System.out.println("");
        System.out.println("");
        System.out.println("5ç§’ä¸­åï¼Œç”Ÿäº§å’Œæ¶ˆè´¹çº¿ç¨‹åœæ­¢ï¼Œçº¿ç¨‹ç»“æŸ");
        myResource.stop();
    }
}
```

æœ€åè¿è¡Œç»“æœ

```java
java.util.concurrent.ArrayBlockingQueue
prod	 ç”Ÿäº§çº¿ç¨‹å¯åŠ¨


consumer	 æ¶ˆè´¹çº¿ç¨‹å¯åŠ¨
prod	 æ’å…¥é˜Ÿåˆ—:1æˆåŠŸ
consumer	 æ¶ˆè´¹é˜Ÿåˆ—:1æˆåŠŸ
prod	 æ’å…¥é˜Ÿåˆ—:2æˆåŠŸ
consumer	 æ¶ˆè´¹é˜Ÿåˆ—:2æˆåŠŸ
prod	 æ’å…¥é˜Ÿåˆ—:3æˆåŠŸ
consumer	 æ¶ˆè´¹é˜Ÿåˆ—:3æˆåŠŸ
prod	 æ’å…¥é˜Ÿåˆ—:4æˆåŠŸ
consumer	 æ¶ˆè´¹é˜Ÿåˆ—:4æˆåŠŸ
prod	 æ’å…¥é˜Ÿåˆ—:5æˆåŠŸ
consumer	 æ¶ˆè´¹é˜Ÿåˆ—:5æˆåŠŸ


5ç§’ä¸­åï¼Œç”Ÿäº§å’Œæ¶ˆè´¹çº¿ç¨‹åœæ­¢ï¼Œçº¿ç¨‹ç»“æŸ
prod	 åœæ­¢ç”Ÿäº§ï¼Œè¡¨ç¤ºFLAG=falseï¼Œç”Ÿäº§ä»‹ç»
```







# çº¿ç¨‹æ± ï¼ˆJavaä¸­æœ‰å“ªäº›æ–¹æ³•è·å–å¤šçº¿ç¨‹ï¼‰

## å‰è¨€

è·å–å¤šçº¿ç¨‹çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æœ‰ä¸‰ç§ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯å®ç°Callableæ¥å£

- å®ç°Runnableæ¥å£
- å®ç°Callableæ¥å£
- å®ä¾‹åŒ–Threadç±»
- ä½¿ç”¨çº¿ç¨‹æ± è·å–

## Callableæ¥å£

Callableæ¥å£ï¼Œæ˜¯ä¸€ç§è®©çº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼Œèƒ½å¤Ÿè¿”å›ç»“æœçš„

åœ¨è¯´åˆ°Callableæ¥å£çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æåˆ°Runnableæ¥å£

```java
/**
 * å®ç°Runnableæ¥å£
 */
class MyThread implements Runnable {

    @Override
    public void run() {

    }
}
```

æˆ‘ä»¬çŸ¥é“ï¼Œå®ç°Runnableæ¥å£çš„æ—¶å€™ï¼Œéœ€è¦é‡å†™runæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨çš„æ–¹æ³•

åŒç†ï¼Œæˆ‘ä»¬å®ç°Callableæ¥å£ï¼Œä¹Ÿéœ€è¦å®ç°callæ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦æœ‰è¿”å›å€¼ï¼Œè¿™ä¸ªCallableæ¥å£çš„åº”ç”¨åœºæ™¯ä¸€èˆ¬å°±åœ¨äºæ‰¹å¤„ç†ä¸šåŠ¡ï¼Œæ¯”å¦‚è½¬è´¦çš„æ—¶å€™ï¼Œéœ€è¦ç»™ä¸€ä¼šè¿”å›ç»“æœçš„çŠ¶æ€ç å›æ¥ï¼Œä»£è¡¨æœ¬æ¬¡æ“ä½œæˆåŠŸè¿˜æ˜¯å¤±è´¥

```java
/**
 * Callableæœ‰è¿”å›å€¼
 * æ‰¹é‡å¤„ç†çš„æ—¶å€™ï¼Œéœ€è¦å¸¦è¿”å›å€¼çš„æ¥å£ï¼ˆä¾‹å¦‚æ”¯ä»˜å¤±è´¥çš„æ—¶å€™ï¼Œéœ€è¦è¿”å›é”™è¯¯çŠ¶æ€ï¼‰
 *
 */
class MyThread2 implements Callable<Integer> {

    @Override
    public Integer call() throws Exception {
        System.out.println("come in Callable");
        return 1024;
    }
}
```

æœ€åæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯é€šè¿‡Threadçº¿ç¨‹ï¼Œ å°†MyThread2å®ç°Callableæ¥å£çš„ç±»åŒ…è£…èµ·æ¥

â­ï¸ **è¿™é‡Œéœ€è¦ç”¨åˆ°çš„æ˜¯FutureTaskç±»ï¼Œä»–å®ç°äº†Runnableæ¥å£ï¼Œå¹¶ä¸”è¿˜éœ€è¦ä¼ é€’ä¸€ä¸ªå®ç°Callableæ¥å£çš„ç±»ä½œä¸ºæ„é€ å‡½æ•°**

```java
// FutureTaskï¼šå®ç°äº†Runnableæ¥å£ï¼Œæ„é€ å‡½æ•°åˆéœ€è¦ä¼ å…¥ Callableæ¥å£
// è¿™é‡Œé€šè¿‡äº†FutureTaskæ¥è§¦äº†Callableæ¥å£
FutureTask<Integer> futureTask = new FutureTask<>(new MyThread2());
```

ç„¶ååœ¨ç”¨Threadè¿›è¡Œå®ä¾‹åŒ–ï¼Œä¼ å…¥å®ç°Runnabnleæ¥å£çš„FutureTaskçš„ç±»

```java
Thread t1 = new Thread(futureTask, "aaa");
t1.start();
```

æœ€åé€šè¿‡ futureTask.get() è·å–åˆ°è¿”å›å€¼

```java
// è¾“å‡ºFutureTaskçš„è¿”å›å€¼
System.out.println("result FutureTask " + futureTask.get());
```

è¿™å°±ç›¸å½“äºåŸæ¥æˆ‘ä»¬çš„æ–¹å¼æ˜¯mainæ–¹æ³•ä¸€æ¡é¾™ä¹‹å¿ƒï¼Œåé¢åœ¨å¼•å…¥Callableåï¼Œå¯¹äºæ‰§è¡Œæ¯”è¾ƒä¹…çš„çº¿ç¨‹ï¼Œå¯ä»¥å•ç‹¬æ–°å¼€ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ‰§è¡Œï¼Œæœ€ååœ¨è¿›è¡Œæ±‡æ€»è¾“å‡º

### ä¸ºä»€ä¹ˆä¼šå‡ºç°Callableæ¥å£

ä¸ºäº† å¹¶å‘å’Œå¼‚æ­¥ ï¼

**æœ€åéœ€è¦æ³¨æ„çš„æ˜¯: è¦æ±‚è·å¾—Callableçº¿ç¨‹çš„è®¡ç®—ç»“æœï¼Œå¦‚æœæ²¡æœ‰è®¡ç®—å®Œæˆå°±è¦å»å¼ºæ±‚ï¼Œä¼šå¯¼è‡´é˜»å¡ï¼Œç›´åˆ°è®¡ç®—å®Œæˆ**

![image-20200317152541284](/assets/imgs/image-20200317152541284.png)

**ä¹Ÿå°±æ˜¯è¯´ futureTask.get() éœ€è¦æ”¾åœ¨æœ€åæ‰§è¡Œï¼Œè¿™æ ·ä¸ä¼šå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡**

ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢ç®—æ³•ï¼Œä½¿ç”¨ç±»ä¼¼äºè‡ªæ—‹é”çš„æ–¹å¼æ¥è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¿è¡Œå®Œæ¯•

```java
// åˆ¤æ–­futureTaskæ˜¯å¦è®¡ç®—å®Œæˆ
while(!futureTask.isDone()) {

}
```

### ä»»åŠ¡å¤šæ¬¡è®¡ç®—é—®é¢˜

***å¤šä¸ªçº¿ç¨‹æ‰§è¡Œ ä¸€ä¸ªFutureTaskçš„æ—¶å€™ï¼Œåªä¼šè®¡ç®—ä¸€æ¬¡***

```java
FutureTask<Integer> futureTask = new FutureTask<>(new MyThread2());

// å¼€å¯ä¸¤ä¸ªçº¿ç¨‹è®¡ç®—futureTask
new Thread(futureTask, "AAA").start();
new Thread(futureTask, "BBB").start();
```

å¦‚æœæˆ‘ä»¬è¦ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¡ç®—ä»»åŠ¡çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦è¿™æ ·å†™ï¼Œéœ€è¦å®šä¹‰ä¸¤ä¸ªfutureTask

```java
FutureTask<Integer> futureTask = new FutureTask<>(new MyThread2());
FutureTask<Integer> futureTask2 = new FutureTask<>(new MyThread2());

// å¼€å¯ä¸¤ä¸ªçº¿ç¨‹è®¡ç®—futureTask
new Thread(futureTask, "AAA").start();

new Thread(futureTask2, "BBB").start();
```

## ThreadPoolExecutor

### ä¸ºä»€ä¹ˆç”¨çº¿ç¨‹æ± 

çº¿ç¨‹æ± åšçš„ä¸»è¦å·¥ä½œå°±æ˜¯æ§åˆ¶è¿è¡Œçš„çº¿ç¨‹çš„æ•°é‡ï¼Œå¤„ç†è¿‡ç¨‹ä¸­ï¼Œ**å°†ä»»åŠ¡æ”¾å…¥åˆ°é˜Ÿåˆ—ä¸­**ï¼Œç„¶åçº¿ç¨‹åˆ›å»ºåï¼Œå¯åŠ¨è¿™äº›ä»»åŠ¡ï¼Œ**å¦‚æœçº¿ç¨‹æ•°é‡è¶…è¿‡äº†æœ€å¤§æ•°é‡çš„çº¿ç¨‹æ’é˜Ÿç­‰å€™**ï¼Œç­‰å…¶å®ƒçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå†ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚

å®ƒçš„ä¸»è¦ç‰¹ç‚¹ä¸ºï¼š**çº¿ç¨‹å¤ç”¨ã€æ§åˆ¶æœ€å¤§å¹¶å‘æ•°ã€ç®¡ç†çº¿ç¨‹**

çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æ˜¯æ”¾å…¥åˆ°**é˜»å¡é˜Ÿåˆ—**ä¸­çš„

### çº¿ç¨‹æ± çš„å¥½å¤„

**å¤šæ ¸å¤„ç†çš„å¥½å¤„æ˜¯ï¼šçœç•¥çš„ä¸Šä¸‹æ–‡çš„åˆ‡æ¢å¼€é”€**

åŸæ¥æˆ‘ä»¬å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œæ˜¯ä½¿ç”¨ newå…³é”®å­—è¿›è¡Œåˆ›å»ºï¼Œåˆ°äº†Springåï¼Œæˆ‘ä»¬å­¦äº†IOCä¾èµ–æ³¨å…¥ï¼Œå‘ç°Springå¸®æˆ‘ä»¬å°†å¯¹è±¡å·²ç»åŠ è½½åˆ°äº†Springå®¹å™¨ä¸­ï¼Œåªéœ€è¦é€šè¿‡@Autowriteæ³¨è§£ï¼Œå°±èƒ½å¤Ÿè‡ªåŠ¨æ³¨å…¥ï¼Œä»è€Œä½¿ç”¨

å› æ­¤ä½¿ç”¨å¤šçº¿ç¨‹æœ‰ä¸‹åˆ—çš„å¥½å¤„

- é™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹ï¼Œé™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—
- æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±ç«‹å³æ‰§è¡Œ
- æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— çº¿åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§

### æ¶æ„è¯´æ˜

Javaä¸­çº¿ç¨‹æ± æ˜¯é€šè¿‡Executoræ¡†æ¶å®ç°çš„ï¼Œè¯¥æ¡†æ¶ä¸­ç”¨åˆ°äº†Executorï¼ŒExecutorsï¼ˆä»£è¡¨å·¥å…·ç±»ï¼‰ï¼ŒExecutorServiceï¼ŒThreadPoolExecutorè¿™å‡ ä¸ªç±»ã€‚

![image-20200317175202647](/assets/imgs/image-20200317175202647.png)

![image-20200317175241007](/assets/imgs/image-20200317175241007.png)



### åˆ›å»ºçº¿ç¨‹æ± 

- Executors.newFixedThreadPool(int i) ï¼šåˆ›å»ºä¸€ä¸ªæ‹¥æœ‰ i ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
  - æ‰§è¡Œé•¿æœŸçš„ä»»åŠ¡ï¼Œæ€§èƒ½å¥½å¾ˆå¤š
  - åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œå¯æ§åˆ¶çº¿ç¨‹æ•°æœ€å¤§å¹¶å‘æ•°ï¼Œè¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…
- Executors.newSingleThreadExecutorï¼šåˆ›å»ºä¸€ä¸ªåªæœ‰1ä¸ªçº¿ç¨‹çš„ å•çº¿ç¨‹æ± 
  - ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œçš„åœºæ™¯
  - åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåºæ‰§è¡Œ
- Executors.newCacheThreadPool();  **åˆ›å»ºä¸€ä¸ªå¯æ‰©å®¹çš„çº¿ç¨‹æ± **
  - æ‰§è¡Œå¾ˆå¤šçŸ­æœŸå¼‚æ­¥çš„å°ç¨‹åºæˆ–è€…è´Ÿè½½æ•™è½»çš„æœåŠ¡å™¨
  - åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦ï¼Œå¯çµæ´»å›æ”¶ç©ºé—²çº¿ç¨‹ï¼Œå¦‚æ— å¯å›æ”¶ï¼Œåˆ™æ–°å»ºæ–°çº¿ç¨‹

å…·ä½“ä½¿ç”¨ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨Executorså·¥å…·ç±»ï¼Œè¿›è¡Œåˆ›å»ºçº¿ç¨‹æ± ï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªæ‹¥æœ‰5ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 

```java
// ä¸€æ± 5ä¸ªå¤„ç†çº¿ç¨‹ï¼ˆç”¨æ± åŒ–æŠ€æœ¯ï¼Œä¸€å®šè¦è®°å¾—å…³é—­ï¼‰
ExecutorService threadPool = Executors.newFixedThreadPool(5);

// åˆ›å»ºä¸€ä¸ªåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
ExecutorService threadPool = Executors.newSingleThreadExecutor();

// åˆ›å»ºä¸€ä¸ªæ‹¥æœ‰Nä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œæ ¹æ®è°ƒåº¦åˆ›å»ºåˆé€‚çš„çº¿ç¨‹
ExecutorService threadPool = Executors.newCacheThreadPool();
```

ç„¶åæˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„çš„åº”ç”¨åœºæ™¯

```java
æ¨¡æ‹Ÿ10ä¸ªç”¨æˆ·æ¥åŠç†ä¸šåŠ¡ï¼Œæ¯ä¸ªç”¨æˆ·å°±æ˜¯ä¸€ä¸ªæ¥è‡ªå¤–éƒ¨è¯·æ±‚çº¿ç¨‹
```

æˆ‘ä»¬éœ€è¦ä½¿ç”¨ threadPool.executeæ‰§è¡Œä¸šåŠ¡ï¼Œexecuteéœ€è¦ä¼ å…¥ä¸€ä¸ªå®ç°äº†Runnableæ¥å£çš„çº¿ç¨‹

```java
threadPool.execute(() -> {
	System.out.println(Thread.currentThread().getName() + "\t ç»™ç”¨æˆ·åŠç†ä¸šåŠ¡");
});
```

ç„¶åæˆ‘ä»¬ä½¿ç”¨å®Œæ¯•åå…³é—­çº¿ç¨‹æ± 

```java
threadPool.shutdown();
```

å®Œæ•´ä»£ç ä¸ºï¼š

```java
/**
 * ç¬¬å››ç§è·å– / ä½¿ç”¨ Javaå¤šçº¿ç¨‹çš„æ–¹å¼ï¼Œé€šè¿‡çº¿ç¨‹æ± 
 */
public class MyThreadPoolDemo {
    public static void main(String[] args) {

        // Array  Arrays(è¾…åŠ©å·¥å…·ç±»)
        // Collection Collections(è¾…åŠ©å·¥å…·ç±»)
        // Executor Executors(è¾…åŠ©å·¥å…·ç±»)


        // ä¸€æ± 5ä¸ªå¤„ç†çº¿ç¨‹ï¼ˆç”¨æ± åŒ–æŠ€æœ¯ï¼Œä¸€å®šè¦è®°å¾—å…³é—­ï¼‰
        ExecutorService threadPool = Executors.newFixedThreadPool(5);

        // æ¨¡æ‹Ÿ10ä¸ªç”¨æˆ·æ¥åŠç†ä¸šåŠ¡ï¼Œæ¯ä¸ªç”¨æˆ·å°±æ˜¯ä¸€ä¸ªæ¥è‡ªå¤–éƒ¨è¯·æ±‚çº¿ç¨‹
        try {

            // å¾ªç¯åæ¬¡ï¼Œæ¨¡æ‹Ÿä¸šåŠ¡åŠç†ï¼Œè®©5ä¸ªçº¿ç¨‹å¤„ç†è¿™10ä¸ªè¯·æ±‚
            for (int i = 0; i < 10; i++) {
                final int tempInt = i;
                threadPool.execute(() -> {
                    System.out.println(Thread.currentThread().getName() + "\t ç»™ç”¨æˆ·:" + tempInt + " åŠç†ä¸šåŠ¡");
                });
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            threadPool.shutdown();
        }

    }
}
```

æœ€åç»“æœï¼š

```java
pool-1-thread-1	 ç»™ç”¨æˆ·:0 åŠç†ä¸šåŠ¡
pool-1-thread-5	 ç»™ç”¨æˆ·:4 åŠç†ä¸šåŠ¡
pool-1-thread-1	 ç»™ç”¨æˆ·:5 åŠç†ä¸šåŠ¡
pool-1-thread-4	 ç»™ç”¨æˆ·:3 åŠç†ä¸šåŠ¡
pool-1-thread-2	 ç»™ç”¨æˆ·:1 åŠç†ä¸šåŠ¡
pool-1-thread-3	 ç»™ç”¨æˆ·:2 åŠç†ä¸šåŠ¡
pool-1-thread-2	 ç»™ç”¨æˆ·:9 åŠç†ä¸šåŠ¡
pool-1-thread-4	 ç»™ç”¨æˆ·:8 åŠç†ä¸šåŠ¡
pool-1-thread-1	 ç»™ç”¨æˆ·:7 åŠç†ä¸šåŠ¡
pool-1-thread-5	 ç»™ç”¨æˆ·:6 åŠç†ä¸šåŠ¡
```

æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ï¼Œä¸€å…±æœ‰5ä¸ªçº¿ç¨‹ï¼Œåœ¨ç»™10ä¸ªç”¨æˆ·åŠç†ä¸šåŠ¡

## åº•å±‚å®ç° ğŸ¤”

æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹æºç ï¼Œç‚¹å‡»äº†**Executors.newSingleThreadExecutor å’Œ Executors.newFixedThreadPool**èƒ½å¤Ÿå‘ç°åº•å±‚éƒ½æ˜¯ä½¿ç”¨äº†**ThreadPoolExecutor**

![image-20200317182004293](/assets/imgs/image-20200317182004293.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°çº¿ç¨‹æ± çš„å†…éƒ¨ï¼Œè¿˜ä½¿ç”¨åˆ°äº†LinkedBlockingQueue é“¾è¡¨é˜»å¡é˜Ÿåˆ—

âš ï¸ **åŒæ—¶åœ¨æŸ¥çœ‹Executors.newCacheThreadPool çœ‹åˆ°åº•å±‚ç”¨çš„æ˜¯ SynchronousBlockingQueueé˜»å¡é˜Ÿåˆ—**

æœ€åæŸ¥çœ‹ä¸€ä¸‹ï¼Œå®Œæ•´çš„ä¸‰ä¸ªåˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•

![image-20200317183202992](/assets/imgs/image-20200317183202992.png)



## çº¿ç¨‹æ± çš„é‡è¦å‚æ•°

![image-20200317183600957](/assets/imgs/image-20200317183600957.png)

çº¿ç¨‹æ± åœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œä¸€å…±æœ‰7å¤§å‚æ•°

- **corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± ä¸­çš„å¸¸é©»æ ¸å¿ƒçº¿ç¨‹æ•°**
  - åœ¨åˆ›å»ºçº¿ç¨‹æ± åï¼Œå½“æœ‰è¯·æ±‚ä»»åŠ¡æ¥ä¹‹åï¼Œå°±ä¼šå®‰æ’æ± ä¸­çš„çº¿ç¨‹å»æ‰§è¡Œè¯·æ±‚ä»»åŠ¡ï¼Œè¿‘ä¼¼ç†è§£ä¸ºä»Šæ—¥å½“å€¼çº¿ç¨‹
  - å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ°corePoolSizeåï¼Œå°±ä¼šæŠŠåˆ°è¾¾çš„é˜Ÿåˆ—æ”¾åˆ°ç¼“å­˜é˜Ÿåˆ—ä¸­
- **maximumPoolSizeï¼šçº¿ç¨‹æ± èƒ½å¤Ÿå®¹çº³åŒæ—¶æ‰§è¡Œçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ­¤å€¼å¿…é¡»å¤§äºç­‰äº1**
  - ç›¸å½“æœ‰æ‰©å®¹åçš„çº¿ç¨‹æ•°ï¼Œè¿™ä¸ªçº¿ç¨‹æ± èƒ½å®¹çº³çš„æœ€å¤šçº¿ç¨‹æ•°
- **keepAliveTimeï¼šå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´**
  - å½“çº¿ç¨‹æ± æ•°é‡è¶…è¿‡corePoolSizeæ—¶ï¼Œå½“ç©ºé—²æ—¶é—´è¾¾åˆ°keepAliveTimeå€¼æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹ä¼šè¢«é”€æ¯ï¼Œç›´åˆ°åªå‰©ä¸‹corePoolSizeä¸ªçº¿ç¨‹ä¸ºæ­¢
  - é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äºcorePoolSizeæ—¶ï¼ŒkeepAliveTimeæ‰ä¼šèµ·ä½œç”¨
- **unitï¼škeepAliveTimeçš„å•ä½**
- **workQueueï¼šä»»åŠ¡é˜Ÿåˆ—ï¼Œè¢«æäº¤çš„ä½†æœªè¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆç±»ä¼¼äºé“¶è¡Œé‡Œé¢çš„å€™å®¢åŒºï¼‰**
  - LinkedBlockingQueueï¼šé“¾è¡¨é˜»å¡é˜Ÿåˆ—
  - SynchronousBlockingQueueï¼šåŒæ­¥é˜»å¡é˜Ÿåˆ—
- **threadFactoryï¼šè¡¨ç¤ºç”Ÿæˆçº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹æ±  ä¸€èˆ¬ç”¨é»˜è®¤å³å¯**
- **handlerï¼šæ‹’ç»ç­–ç•¥ï¼Œè¡¨ç¤ºå½“é˜Ÿåˆ—æ»¡äº†å¹¶ä¸”å·¥ä½œçº¿ç¨‹å¤§äºçº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°ï¼ˆmaximumPoolSize3ï¼‰æ—¶ï¼Œå¦‚ä½•æ¥æ‹’ç»è¯·æ±‚æ‰§è¡Œçš„Runnableçš„ç­–ç•¥**

å½“è¥ä¸šçª—å£å’Œé˜»å¡é˜Ÿåˆ—ä¸­éƒ½æ»¡äº†æ—¶å€™ï¼Œå°±éœ€è¦è®¾ç½®æ‹’ç»ç­–ç•¥

![image-20200317201150197](/assets/imgs/image-20200317201150197.png)



## çº¿ç¨‹æ± åº•å±‚å·¥ä½œåŸç†

### çº¿ç¨‹æ± è¿è¡Œæ¶æ„å›¾

![image-20200318154414717](/assets/imgs/image-20200318154414717.png)

**æ–‡å­—è¯´æ˜**

1. **åœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œç­‰å¾…æäº¤è¿‡æ¥çš„ä»»åŠ¡è¯·æ±‚**

2. **å½“è°ƒç”¨execute()æ–¹æ³•æ·»åŠ ä¸€ä¸ªè¯·æ±‚ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå‡ºå¦‚ä¸‹åˆ¤æ–­**

   1. **å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ± æ•°é‡å°äºcorePoolSizeï¼Œé‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡**
   2. **å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºcorePoolSizeï¼Œé‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—**
   3. **å¦‚æœè¿™æ—¶å€™é˜Ÿåˆ—æ»¡äº†ï¼Œå¹¶ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¿˜å°äºmaximumPoolSizeï¼Œé‚£ä¹ˆè¿˜æ˜¯åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹likeè¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼›**
   4. **å¦‚æœé˜Ÿåˆ—æ»¡äº†å¹¶ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºmaximumPoolSizeï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šå¯åŠ¨é¥±å’Œæ‹’ç»ç­–ç•¥æ¥æ‰§è¡Œ**

3. **å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œ**

4. **å½“ä¸€ä¸ªçº¿ç¨‹æ— äº‹å¯åšæ“ä½œä¸€å®šçš„æ—¶é—´(keepAliveTime)æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ¤æ–­ï¼š**

   1. **å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äºcorePoolSizeï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¢«åœæ‰**
   2. **æ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œå®ƒä¼šæœ€ç»ˆæ”¶ç¼©åˆ°corePoolSizeçš„å¤§å°**

   

ä»¥é¡¾å®¢å»é“¶è¡ŒåŠç†ä¸šåŠ¡ä¸ºä¾‹ï¼Œè°ˆè°ˆçº¿ç¨‹æ± çš„åº•å±‚å·¥ä½œåŸç†

1. æœ€å¼€å§‹å‡è®¾æ¥äº†ä¸¤ä¸ªé¡¾å®¢ï¼Œå› ä¸ºcorePoolSizeä¸º2ï¼Œå› æ­¤è¿™ä¸¤ä¸ªé¡¾å®¢ç›´æ¥èƒ½å¤Ÿå»çª—å£åŠç†
2. åé¢åˆæ¥äº†ä¸‰ä¸ªé¡¾å®¢ï¼Œå› ä¸ºcorePoolå·²ç»è¢«é¡¾å®¢å ç”¨äº†ï¼Œå› æ­¤åªæœ‰å»å€™å®¢åŒºï¼Œä¹Ÿå°±æ˜¯é˜»å¡é˜Ÿåˆ—ä¸­ç­‰å¾…
3. åé¢çš„äººåˆé™†é™†ç»­ç»­æ¥äº†ï¼Œå€™å®¢åŒºå¯èƒ½ä¸å¤Ÿç”¨äº†ï¼Œå› æ­¤éœ€è¦ç”³è¯·å¢åŠ å¤„ç†è¯·æ±‚çš„çª—å£ï¼Œè¿™é‡Œçš„çª—å£æŒ‡çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ï¼Œä»¥æ­¤æ¥è§£å†³çº¿ç¨‹ä¸å¤Ÿç”¨çš„é—®é¢˜
4. å‡è®¾å—ç†çª—å£å·²ç»è¾¾åˆ°æœ€å¤§æ•°ï¼Œå¹¶ä¸”è¯·æ±‚æ•°è¿˜æ˜¯ä¸æ–­é€’å¢ï¼Œæ­¤æ—¶å€™å®¢åŒºå’Œçº¿ç¨‹æ± éƒ½å·²ç»æ»¡äº†ï¼Œä¸ºäº†é˜²æ­¢å¤§é‡è¯·æ±‚å†²å®çº¿ç¨‹æ± ï¼Œå·²ç»éœ€è¦å¼€å¯æ‹’ç»ç­–ç•¥
5. ä¸´æ—¶å¢åŠ çš„çº¿ç¨‹ä¼šå› ä¸ºè¶…è¿‡äº†æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œå°±ä¼šé”€æ¯ï¼Œæœ€åä»æœ€å¤§æ•°å‰Šå‡åˆ°æ ¸å¿ƒæ•°



## æ‹’ç»ç­–ç•¥

> ç­‰å¾…é˜Ÿåˆ—ä¹Ÿå·²ç»æ’æ»¡äº†ï¼Œå†ä¹Ÿå¡ä¸ä¸‹æ–°ä»»åŠ¡äº†; åŒæ—¶ï¼Œçº¿ç¨‹æ± ä¸­çš„maxçº¿ç¨‹ä¹Ÿè¾¾åˆ°äº†ï¼Œæ— æ³•ç»§ç»­ä¸ºæ–°ä»»åŠ¡æœåŠ¡ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦æ‹’ç»ç­–ç•¥æœºåˆ¶åˆç†çš„å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚

ä»¥ä¸‹æ‰€æœ‰æ‹’ç»ç­–ç•¥éƒ½å®ç°äº†RejectedExecutionHandleræ¥å£ï¼š

- AbortPolicyï¼šé»˜è®¤ï¼Œç›´æ¥æŠ›å‡ºRejectedExcutionExceptionå¼‚å¸¸ï¼Œé˜»æ­¢ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
- DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸äºˆä»»ä½•å¤„ç†ä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœè¿è¡Œä»»åŠ¡ä¸¢å¤±ï¼Œè¿™æ˜¯ä¸€ç§å¥½æ–¹æ¡ˆ
- CallerRunsPolicyï¼šè¯¥ç­–ç•¥æ—¢ä¸ä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯å°†æŸäº›ä»»åŠ¡å›é€€åˆ°è°ƒç”¨è€…
- DiscardOldestPolicyï¼šæŠ›å¼ƒé˜Ÿåˆ—ä¸­ç­‰å¾…æœ€ä¹…çš„ä»»åŠ¡ï¼Œç„¶åæŠŠå½“å‰ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ä¸­å°è¯•å†æ¬¡æäº¤å½“å‰ä»»åŠ¡



## æ‰‹å†™çº¿ç¨‹æ± 

### é‡‡ç”¨é»˜è®¤æ‹’ç»ç­–ç•¥

ä»ä¸Šé¢æˆ‘ä»¬çŸ¥é“ï¼Œå› ä¸ºé»˜è®¤çš„Executorsåˆ›å»ºçš„çº¿ç¨‹æ± ï¼Œåº•å±‚éƒ½æ˜¯ä½¿ç”¨LinkBlockingQueueä½œä¸ºé˜»å¡é˜Ÿåˆ—çš„ï¼Œè€ŒLinkBlockingQueueè™½ç„¶æ˜¯æœ‰ç•Œçš„ï¼Œä½†æ˜¯å®ƒçš„ç•Œé™æ˜¯ Integer.MAX_VALUE å¤§æ¦‚æœ‰20å¤šäº¿ï¼Œå¯ä»¥ç›¸å½“æ˜¯æ— ç•Œçš„äº†ï¼Œå› æ­¤æˆ‘ä»¬è¦ä½¿ç”¨ThreadPoolExecutorè‡ªå·±æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± ï¼Œç„¶åæŒ‡å®šé˜»å¡é˜Ÿåˆ—çš„å¤§å°

ä¸‹é¢æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º2ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º5ï¼Œå¹¶ä¸”é˜»å¡é˜Ÿåˆ—æ•°ä¸º3çš„çº¿ç¨‹æ± 

```java
// æ‰‹å†™çº¿ç¨‹æ± 
final Integer corePoolSize = 2;
final Integer maximumPoolSize = 5;
final Long keepAliveTime = 1L;

// è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œåªæ”¹å˜äº†LinkBlockingQueueçš„é˜Ÿåˆ—å¤§å°
ExecutorService executorService = new ThreadPoolExecutor(
  corePoolSize,
  maximumPoolSize,
  keepAliveTime,
  TimeUnit.SECONDS,
  new LinkedBlockingQueue<>(3),
  Executors.defaultThreadFactory(),
  new ThreadPoolExecutor.AbortPolicy());
```

ç„¶åä½¿ç”¨forå¾ªç¯ï¼Œæ¨¡æ‹Ÿ10ä¸ªç”¨æˆ·æ¥è¿›è¡Œè¯·æ±‚

```java
// æ¨¡æ‹Ÿ10ä¸ªç”¨æˆ·æ¥åŠç†ä¸šåŠ¡ï¼Œæ¯ä¸ªç”¨æˆ·å°±æ˜¯ä¸€ä¸ªæ¥è‡ªå¤–éƒ¨è¯·æ±‚çº¿ç¨‹
try {

  // å¾ªç¯åæ¬¡ï¼Œæ¨¡æ‹Ÿä¸šåŠ¡åŠç†ï¼Œè®©5ä¸ªçº¿ç¨‹å¤„ç†è¿™10ä¸ªè¯·æ±‚
  for (int i = 0; i < 10; i++) {
    final int tempInt = i;
    executorService.execute(() -> {
      System.out.println(Thread.currentThread().getName() + "\t ç»™ç”¨æˆ·:" + tempInt + " åŠç†ä¸šåŠ¡");
    });
  }
} catch (Exception e) {
  e.printStackTrace();
} finally {
  executorService.shutdown();
}
```

ä½†æ˜¯åœ¨ç”¨æˆ·æ‰§è¡Œåˆ°ç¬¬ä¹ä¸ªçš„æ—¶å€™ï¼Œè§¦å‘äº†å¼‚å¸¸ï¼Œç¨‹åºä¸­æ–­

```java
pool-1-thread-1	 ç»™ç”¨æˆ·:0 åŠç†ä¸šåŠ¡
pool-1-thread-4	 ç»™ç”¨æˆ·:6 åŠç†ä¸šåŠ¡
pool-1-thread-3	 ç»™ç”¨æˆ·:5 åŠç†ä¸šåŠ¡
pool-1-thread-2	 ç»™ç”¨æˆ·:1 åŠç†ä¸šåŠ¡
pool-1-thread-2	 ç»™ç”¨æˆ·:4 åŠç†ä¸šåŠ¡
pool-1-thread-5	 ç»™ç”¨æˆ·:7 åŠç†ä¸šåŠ¡
pool-1-thread-4	 ç»™ç”¨æˆ·:2 åŠç†ä¸šåŠ¡
pool-1-thread-3	 ç»™ç”¨æˆ·:3 åŠç†ä¸šåŠ¡
java.util.concurrent.RejectedExecutionException: Task com.moxi.interview.study.thread.MyThreadPoolDemo$$Lambda$1/1747585824@4dd8dc3 rejected from java.util.concurrent.ThreadPoolExecutor@6d03e736[Running, pool size = 5, active threads = 3, queued tasks = 0, completed tasks = 5]
	at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2047)
	at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:823)
	at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1369)
	at com.moxi.interview.study.thread.MyThreadPoolDemo.main(MyThreadPoolDemo.java:34)
```

è¿™æ˜¯å› ä¸ºè§¦å‘äº†æ‹’ç»ç­–ç•¥ï¼Œè€Œæˆ‘ä»¬è®¾ç½®çš„æ‹’ç»ç­–ç•¥æ˜¯é»˜è®¤çš„AbortPolicyï¼Œä¹Ÿå°±æ˜¯æŠ›å¼‚å¸¸çš„

è§¦å‘æ¡ä»¶æ˜¯ï¼Œè¯·æ±‚çš„çº¿ç¨‹å¤§äº é˜»å¡é˜Ÿåˆ—å¤§å° + æœ€å¤§çº¿ç¨‹æ•° = 8 çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬9ä¸ªçº¿ç¨‹æ¥è·å–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ—¶ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ä»è€ŒæŠ¥é”™é€€å‡ºã€‚

### é‡‡ç”¨CallerRunsPolicyæ‹’ç»ç­–ç•¥

å½“æˆ‘ä»¬æ›´å¥½å…¶å®ƒçš„æ‹’ç»ç­–ç•¥æ—¶ï¼Œé‡‡ç”¨CallerRunsPolicyæ‹’ç»ç­–ç•¥ï¼Œ**ä¹Ÿç§°ä¸ºå›é€€ç­–ç•¥ï¼Œ**å°±æ˜¯æŠŠä»»åŠ¡ä¸¢å›åŸæ¥çš„è¯·æ±‚å¼€å¯çº¿ç¨‹ç€ï¼Œæˆ‘ä»¬çœ‹è¿è¡Œç»“æœ

```java
pool-1-thread-1	 ç»™ç”¨æˆ·:0 åŠç†ä¸šåŠ¡
pool-1-thread-5	 ç»™ç”¨æˆ·:7 åŠç†ä¸šåŠ¡
pool-1-thread-4	 ç»™ç”¨æˆ·:6 åŠç†ä¸šåŠ¡
main	 ç»™ç”¨æˆ·:8 åŠç†ä¸šåŠ¡
pool-1-thread-3	 ç»™ç”¨æˆ·:5 åŠç†ä¸šåŠ¡
pool-1-thread-2	 ç»™ç”¨æˆ·:1 åŠç†ä¸šåŠ¡
pool-1-thread-3	 ç»™ç”¨æˆ·:9 åŠç†ä¸šåŠ¡
pool-1-thread-4	 ç»™ç”¨æˆ·:4 åŠç†ä¸šåŠ¡
pool-1-thread-5	 ç»™ç”¨æˆ·:3 åŠç†ä¸šåŠ¡
pool-1-thread-1	 ç»™ç”¨æˆ·:2 åŠç†ä¸šåŠ¡
```

**æˆ‘ä»¬å‘ç°ï¼Œè¾“å‡ºçš„ç»“æœé‡Œé¢å‡ºç°äº†mainçº¿ç¨‹ï¼Œå› ä¸ºçº¿ç¨‹æ± å‡ºå‘äº†æ‹’ç»ç­–ç•¥ï¼ŒæŠŠä»»åŠ¡å›é€€åˆ°mainçº¿ç¨‹ï¼Œç„¶åmainçº¿ç¨‹å¯¹ä»»åŠ¡è¿›è¡Œå¤„ç†**

### é‡‡ç”¨ DiscardPolicy æ‹’ç»ç­–ç•¥

é‡‡ç”¨DiscardPolicyæ‹’ç»ç­–ç•¥ä¼šï¼Œçº¿ç¨‹æ± ä¼šè‡ªåŠ¨æŠŠåé¢çš„ä»»åŠ¡éƒ½ç›´æ¥ä¸¢å¼ƒï¼Œä¹Ÿä¸æŠ¥å¼‚å¸¸ï¼Œå½“ä»»åŠ¡æ— å…³ç´§è¦çš„æ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨è¿™ä¸ªæ–¹å¼

```java
pool-1-thread-1	 ç»™ç”¨æˆ·:0 åŠç†ä¸šåŠ¡
pool-1-thread-3	 ç»™ç”¨æˆ·:5 åŠç†ä¸šåŠ¡
pool-1-thread-1	 ç»™ç”¨æˆ·:2 åŠç†ä¸šåŠ¡
pool-1-thread-2	 ç»™ç”¨æˆ·:1 åŠç†ä¸šåŠ¡
pool-1-thread-1	 ç»™ç”¨æˆ·:4 åŠç†ä¸šåŠ¡
pool-1-thread-5	 ç»™ç”¨æˆ·:7 åŠç†ä¸šåŠ¡
pool-1-thread-4	 ç»™ç”¨æˆ·:6 åŠç†ä¸šåŠ¡
pool-1-thread-3	 ç»™ç”¨æˆ·:3 åŠç†ä¸šåŠ¡
```

### é‡‡ç”¨DiscardOldestPolicyæ‹’ç»ç­–ç•¥

è¿™ä¸ªç­–ç•¥å’Œåˆšåˆšå·®ä¸å¤šï¼Œä¼šæŠŠæœ€ä¹…çš„é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ›¿æ¢æ‰

```java
pool-1-thread-1	 ç»™ç”¨æˆ·:0 åŠç†ä¸šåŠ¡
pool-1-thread-4	 ç»™ç”¨æˆ·:6 åŠç†ä¸šåŠ¡
pool-1-thread-1	 ç»™ç”¨æˆ·:4 åŠç†ä¸šåŠ¡
pool-1-thread-3	 ç»™ç”¨æˆ·:5 åŠç†ä¸šåŠ¡
pool-1-thread-2	 ç»™ç”¨æˆ·:1 åŠç†ä¸šåŠ¡
pool-1-thread-1	 ç»™ç”¨æˆ·:9 åŠç†ä¸šåŠ¡
pool-1-thread-4	 ç»™ç”¨æˆ·:8 åŠç†ä¸šåŠ¡
pool-1-thread-5	 ç»™ç”¨æˆ·:7 åŠç†ä¸šåŠ¡
```





## ä¸ºä»€ä¹ˆä¸ç”¨é»˜è®¤åˆ›å»ºçš„çº¿ç¨‹æ± ï¼Ÿ ğŸ¤”

çº¿ç¨‹æ± åˆ›å»ºçš„æ–¹æ³•æœ‰ï¼šå›ºå®šæ•°çš„ï¼Œå•ä¸€çš„ï¼Œå¯å˜çš„ï¼Œé‚£ä¹ˆåœ¨å®é™…å¼€å‘ä¸­ï¼Œåº”è¯¥ä½¿ç”¨å“ªä¸ªï¼Ÿ

**æˆ‘ä»¬ä¸€ä¸ªéƒ½ä¸ç”¨ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯ä½¿ç”¨è‡ªå·±è‡ªå®šä¹‰çš„**

ä¸ºä»€ä¹ˆä¸ç”¨Executorsä¸­JDKæä¾›çš„ï¼Ÿ

â­ï¸ **æ ¹æ®é˜¿é‡Œå·´å·´æ‰‹å†Œï¼šå¹¶å‘æ§åˆ¶è¿™ç« **

- **çº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹**
  - **ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºçš„å¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜ï¼Œå¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½é€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜**
- **çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨Executorså»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ThreadToolExecutorsçš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©**
  - **Executorsè¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡å¼Šç«¯å¦‚ä¸‹ï¼š**
    - **FixedThreadPoolå’ŒSingleThreadPoolï¼š**
      - **è¿è¡Œçš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸ºï¼šInteger.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´OOM**
    - **CacheThreadPoolå’ŒScheduledThreadPool**
      - **è¿è¡Œçš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸ºï¼šInteger.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´OOM**

![image-20201213163542591](/assets/imgs/image-20201213163542591-1056791.png)



## çº¿ç¨‹æ± çš„å‚æ•°å¦‚ä½•åˆç†é…ç½®

ç”Ÿäº§ç¯å¢ƒä¸­å¦‚ä½•é…ç½® corePoolSize å’Œ maximumPoolSize

è¿™ä¸ªæ˜¯æ ¹æ®å…·ä½“ä¸šåŠ¡æ¥é…ç½®çš„ï¼Œåˆ†ä¸ºCPUå¯†é›†å‹å’ŒIOå¯†é›†å‹

å¦‚ä½•è·å¾—CPUæ ¸æ•°ï¼š`Runtime.getRuntime().availableProcessors()`

### CPUå¯†é›†å‹

CPUå¯†é›†çš„æ„æ€æ˜¯è¯¥ä»»åŠ¡éœ€è¦å¤§é‡çš„è¿ç®—ï¼Œè€Œæ²¡æœ‰é˜»å¡ï¼ŒCPUä¸€ç›´å…¨é€Ÿè¿è¡Œ

CPUå¯†é›†ä»»åŠ¡åªæœ‰åœ¨çœŸæ­£çš„å¤šæ ¸CPUä¸Šæ‰å¯èƒ½å¾—åˆ°åŠ é€Ÿï¼ˆé€šè¿‡å¤šçº¿ç¨‹ï¼‰

è€Œåœ¨å•æ ¸CPUä¸Šï¼Œæ— è®ºä½ å¼€å‡ ä¸ªæ¨¡æ‹Ÿçš„å¤šçº¿ç¨‹è¯¥ä»»åŠ¡éƒ½ä¸å¯èƒ½å¾—åˆ°åŠ é€Ÿï¼Œå› ä¸ºCPUæ€»çš„è¿ç®—èƒ½åŠ›å°±é‚£äº›

CPUå¯†é›†å‹ä»»åŠ¡é…ç½®å°½å¯èƒ½å°‘çš„çº¿ç¨‹æ•°é‡ï¼š

ä¸€èˆ¬å…¬å¼ï¼šCPUæ ¸æ•° + 1ä¸ªçº¿ç¨‹æ•°



### IOå¯†é›†å‹

æ–¹å¼ä¸€ï¼šç”±äºIOå¯†é›†å‹ä»»åŠ¡çº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™å¯èƒ½å¤šçš„çº¿ç¨‹ï¼Œå¦‚`CPUæ ¸æ•° * 2`



æ–¹å¼äºŒï¼š

IOå¯†é›†å‹ï¼Œå³è¯¥ä»»åŠ¡éœ€è¦å¤§é‡çš„IOæ“ä½œï¼Œå³å¤§é‡çš„é˜»å¡

åœ¨å•çº¿ç¨‹ä¸Šè¿è¡ŒIOå¯†é›†å‹çš„ä»»åŠ¡ä¼šå¯¼è‡´æµªè´¹å¤§é‡çš„CPUè¿ç®—èƒ½åŠ›èŠ±è´¹åœ¨ç­‰å¾…ä¸Š

æ‰€ä»¥IOå¯†é›†å‹ä»»åŠ¡ä¸­ä½¿ç”¨å¤šçº¿ç¨‹å¯ä»¥å¤§å¤§çš„åŠ é€Ÿç¨‹åºçš„è¿è¡Œï¼Œå³ä½¿åœ¨å•æ ¸CPUä¸Šï¼Œè¿™ç§åŠ é€Ÿä¸»è¦å°±æ˜¯åˆ©ç”¨äº†è¢«æµªè´¹æ‰çš„é˜»å¡æ—¶é—´ã€‚



IOå¯†é›†æ—¶ï¼Œå¤§éƒ¨åˆ†çº¿ç¨‹éƒ½è¢«é˜»å¡ï¼Œæ•…éœ€è¦å¤šé…ç½®çº¿ç¨‹æ•°ï¼š

å‚è€ƒå…¬å¼ï¼š`CPUæ ¸æ•° / (1 - é˜»å¡ç³»æ•°)`      é˜»å¡ç³»æ•°åœ¨0.8 ~ 0.9å·¦å³

ä¾‹å¦‚ï¼š8æ ¸CPUï¼š`8/ (1 - 0.9) = 80`ä¸ªçº¿ç¨‹æ•°



