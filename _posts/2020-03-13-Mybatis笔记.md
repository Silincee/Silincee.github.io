---
layout: post
title:  "Mybatisç¬”è®°"
date:   2020-03-13 12:48:06 +0800--
categories: [Java]
tags: [JavaEE, Mybatis, ]  
---

# Mybatisæ¡†æ¶æ¦‚è¿°

mybatisæ˜¯ä¸€ä¸ªåŸºäºjavaçš„æŒä¹…æˆæ¡†æ¶ï¼Œ***å†…éƒ¨å°è£…äº†jdbcï¼Œä½¿å¼€å‘è€…åªéœ€è¦å…³æ³¨sqlè¯­å¥æœ¬èº«ï¼Œè€Œä¸éœ€è¦èŠ±è´¹ç²¾åŠ›å»å¤„ç†åŠ è½½é©±åŠ¨ã€åˆ›å»ºè¿æ¥ã€åˆ›å»ºstatementç­‰ç¹æ‚çš„è¿‡ç¨‹ï¼Œä½¿ç”¨äº†ORMæ€æƒ³å®ç°äº†ç»“æœé›†çš„å°è£…ã€‚***

mybatisé€šè¿‡xmlæˆ–æ³¨è§£çš„æ–¹å¼æŠŠå°†è¦æ‰§è¡Œçš„å„ç§statementé…ç½®èµ·æ¥ï¼Œå¹¶é€šè¿‡javaå¯¹è±¡å’Œstatementä¸­çš„sqlçš„åŠ¨æ€å‚æ•°è¿›è¡Œæ˜ å°„ç”Ÿæˆæœ€ç»ˆæ‰§è¡Œçš„sqlè¯­å¥ï¼Œæœ€åæœ‰mybatisæ¡†æ¶æ‰§è¡Œsqlå¹¶å°†ç»“æœæ˜ å°„ä¸ºjavaå¯¹è±¡å¹¶è¿”å›ã€‚

**ORM**ï¼šObject Relational Mapping å¯¹è±¡å…³ç³»æ˜ å°„ï¼ˆæŠŠæ•°æ®åº“è¡¨å’Œå®ä½“ç±»åŠå®ä½“ç±»çš„å±æ€§å¯¹åº”èµ·æ¥ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ“ä½œå®ä½“ç±»å°±å®ç°æ“ä½œæ•°æ®åº“è¡¨ï¼‰



# Mybatisçš„å…¥é—¨

## mybatisçš„ç¯å¢ƒæ­å»º

> [day01_01mybatis](https://github.com/Silincee/Mybatis/tree/main/day01_01mybatis)

1) åˆ›å»ºmavenå·¥ç¨‹å¹¶å¯¼å…¥åæ ‡

```xml
    <dependencies>
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.4.5</version>
        </dependency>

        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.6</version>
            <scope>runtime</scope>
        </dependency>

        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>1.2.12</version>
        </dependency>

        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.12</version>
            <scope>test</scope>
        </dependency>
      
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.12</version>
            <scope>provided</scope>
        </dependency>
    </dependencies>
```

2) åˆ›å»ºå®ä½“ç±»å’Œdaoçš„æ¥å£

cn.itcast.domain.User

```java
@Data
public class User implements Serializable {
    private  Integer id;
    private String username;
    private Date birthday;
    private String sex;
    private String address;
}
```

cn.itcast.dao.UserDao

```java
public interface UserDao {
    
    /** 
    * @description: æŸ¥è¯¢æ‰€æœ‰æ“ä½œ 
    * @param: [] 
    * @return: java.util.List<cn.itcast.domain.User> 
    * @author: Silince 
    * @date: 2020-03-10 
    */ 
    List<User> findAll();
}
```



3) åˆ›å»ºmybatisçš„ä¸»é…ç½®æ–‡ä»¶ `SqlMapConfig.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<!--mybatisçš„ä¸»é…ç½®æ–‡ä»¶-->
<configuration>
    <!--    é…ç½®ç¯å¢ƒ-->
    <environments default="mysql">
        <!--        é…ç½®mysqlçš„ç¯å¢ƒ-->
        <environment id="mysql">
            <!--            é…ç½®äº‹åŠ¡çš„ç±»å‹-->
            <transactionManager type="JDBC"></transactionManager>
            <!--            é…ç½®æ•°æ®æº/è¿æ¥æ± -->
            <dataSource type="POOLED">
                <!--                é…ç½®é“¾æ¥æ•°æ®åº“çš„4ä¸ªåŸºæœ¬ä¿¡æ¯-->
                <property name="driver" value="com.mysql.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/mybatis"/>
                <property name="username" value="root"/>
                <property name="password" value="*******"/>
            </dataSource>
        </environment>
    </environments>

    <!--    æŒ‡å®šæ˜ å°„é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œæ˜ å°„é…ç½®æ–‡ä»¶æŒ‡çš„æ˜¯æ¯ä¸ªdaoç‹¬ç«‹çš„é…ç½®æ–‡ä»¶-->
    <mappers>
        <mapper resource="cn/itcast/dao/UserDao.xml"/>
    </mappers>

</configuration>
```



4) åˆ›å»ºæ˜ å°„é…ç½®æ–‡ä»¶ `UserDao.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.itcast.dao.UserDao">
<!--    é…ç½®æŸ¥è¯¢æ‰€æœ‰-->
    <select id="findAll" resultType="cn.itcast.domain.User">
        select * from user
    </select>
</mapper>
```



5) ç¼–å†™æµ‹è¯•ç±»

![å…¥é—¨æ¡ˆä¾‹çš„åˆ†æ](/assets/imgs/å…¥é—¨æ¡ˆä¾‹çš„åˆ†æ-3700116.png)

```java
public class MybatisTest {
    public static void main(String[] args) throws IOException {
        //1 è¯»å–é…ç½®æ–‡ä»¶
        InputStream in = Resources.getResourceAsStream("SqlMapConfig.xml");
        //2 åˆ›å»ºSqlSessionFactoryå·¥å‚
        SqlSessionFactoryBuilder builder = new SqlSessionFactoryBuilder();
        SqlSessionFactory factory = builder.build(in);
        //3 ä½¿ç”¨å·¥å‚ç”Ÿäº§ä¸€ä¸ªSqlSessionå¯¹è±¡
        SqlSession session = factory.openSession();
        //4 ä½¿ç”¨SqlSessionåˆ›å»ºDaoæ¥å£çš„ä»£ç†å¯¹è±¡
        UserDao userDao=session.getMapper(UserDao.class);
        //5 ä½¿ç”¨ä»£ç†å¯¹è±¡æ‰§è¡Œdaoä¸­çš„æ–¹æ³•
        List<User> users = userDao.findAll();
        for (User user : users) {
            System.out.println(user);
        }
        //6 é‡Šæ”¾èµ„æº
        session.close();
        in.close();
    }
}
```



## ç¯å¢ƒæ­å»ºçš„æ³¨æ„äº‹é¡¹

> å½“æˆ‘ä»¬éµä»äº†3ï¼Œ4ï¼Œ5ç‚¹ä¹‹åï¼Œæˆ‘ä»¬åœ¨å¼€å‘ä¸­å°±æ— é¡»å†å†™daoçš„å®ç°ç±»

1. åˆ›å»ºUserDao.xmlå’ŒUserDao.javaæ—¶åç§°æ˜¯ä¸ºäº†å’Œä¹‹å‰çš„çŸ¥è¯†ä¿æŒä¸€è‡´ã€‚åœ¨Mybatisä¸­å®ƒæŠŠæŒä¹…æˆçš„æ“ä½œæ¥å£åç§°å’Œæ˜ å°„æ–‡ä»¶å«åšMapperï¼Œæ‰€ä»¥UserDaoå’ŒUserMapperæ˜¯ä¸€æ ·çš„ã€‚

2. åœ¨Ideaä¸­åˆ›å»ºç›®å½•çš„æ—¶å€™ï¼Œå®ƒå’ŒåŒ…æ˜¯ä¸ä¸€æ ·çš„ã€‚

   åŒ…åœ¨åˆ›å»ºæ—¶ï¼š cn.silince.dao æ˜¯ä¸‰çº§ç»“æ„

   ç›®å½•åœ¨åˆ›å»ºæ—¶ï¼š cn.silince.dao æ˜¯ä¸€çº§ç›®å½•

3.   mybatisçš„æ˜ å°„é…ç½®æ–‡ä»¶ä½ç½®å¿…é¡»å’Œdaoæ¥å£çš„åŒ…ç»“æ„ç›¸åŒ
4. æ˜ å°„é…ç½®æ–‡ä»¶çš„mapperæ ‡ç­¾namespaceå±æ€§çš„å€¼å¿…é¡»æ˜¯daoæ¥å£çš„å…¨é™å®šç±»å
5. æ˜ å°„é…ç½®æ–‡ä»¶çš„æ“ä½œé…ç½®ï¼ˆselectï¼‰ï¼Œidå±æ€§çš„å€¼å¿…é¡»æ˜¯daoæ¥å£çš„æ–¹æ³•å



## åŸºäºæ³¨è§£çš„å…¥é—¨æ¡ˆä¾‹ ğŸ¤”

æŠŠUserDao.xmlç§»é™¤ï¼Œåœ¨daoæ¥å£çš„æ–¹æ³•ä¸Šä½¿ç”¨@Selectæ³¨è§£ï¼Œå¹¶æŒ‡å®šsqlè¯­å¥ï¼ŒåŒæ—¶éœ€è¦åœ¨SqlMapConfig.xmlä¸­çš„mapperé…ç½®æ—¶å€™ï¼Œä½¿ç”¨classå±æ€§æŒ‡å®šåˆ°daoæ¥å£çš„å…¨é™å®šç±»åã€‚

åœ¨å®é™…å¼€å‘ä¸­ï¼Œéƒ½æ˜¯è¶Šç®€ä¾¿è¶Šå¥½ï¼Œæ‰€ä»¥éƒ½æ˜¯é‡‡ç”¨ä¸å†™daoå®ç°ç±»çš„æ–¹å¼ï¼Œä¸ç®¡ä½¿ç”¨xmlè¿˜æ˜¯æ³¨è§£é…ç½®ï¼Œä½†æ˜¯mybatisä»–æ˜¯æ”¯æŒå†™daoå®ç°ç±»çš„ã€‚

UserDao:

```java
public interface UserDao {
    @Select("select * from user")
    List<User> findAll();
}
```

SqlMapConfig.xml:

```xml
<!--    æŒ‡å®šæ˜ å°„é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œæ˜ å°„é…ç½®æ–‡ä»¶æŒ‡çš„æ˜¯æ¯ä¸ªdaoç‹¬ç«‹çš„é…ç½®æ–‡ä»¶
  å¦‚æœæ˜¯ä½¿ç”¨æ³¨è§£æ¥é…ç½®çš„è¯ï¼Œæ­¤å¤„åº”è¯¥ä½¿ç”¨classå±æ€§æŒ‡å®šè¢«æ³¨è§£çš„daoå…¨é™å®šç±»å
  -->
<mappers>
  <mapper class="cn.itcast.dao.UserDao"/>
</mappers>
```



# è‡ªå®šä¹‰ Mybatis æ¡†æ¶

## è‡ªå®šä¹‰mybatisæµç¨‹åˆ†æ



![è‡ªå®šä¹‰Mybatisåˆ†æ](/assets/imgs/è‡ªå®šä¹‰Mybatisåˆ†æ.png)

![è‡ªå®šä¹‰mybatiså¼€å‘æµç¨‹å›¾](/assets/imgs/è‡ªå®šä¹‰mybatiså¼€å‘æµç¨‹å›¾.png)

# åŸºäºä»£ç† Dao å®ç° CRUD æ“ä½œ

> [é…ç½®æ–‡ä»¶å®ç°](https://github.com/Silincee/Mybatis/tree/main/day02_eesy_02mybatsiDAO)   [æ³¨è§£å®ç°](https://github.com/Silincee/Mybatis/tree/main/day02_mybatisCRUD)

## OGNLè¡¨è¾¾å¼

ä»–æ˜¯é€šè¿‡å¯¹è±¡çš„å–å€¼æ–¹æ³•æ¥è·å–æ•°æ®ï¼Œåœ¨å†™æ³•ä¸ŠæŠŠgetçœç•¥äº†ï¼Œè¯­æ³•æ ¼å¼å°±æ˜¯ä½¿ç”¨ #{å¯¹è±¡.å¯¹è±¡}çš„æ–¹å¼ã€‚

æ¯”å¦‚æˆ‘ä»¬è·å–ç”¨æˆ·çš„åç§°

- ç±»ä¸­çš„å†™æ³•ï¼š user.getUsername()ï¼›
- OGNLè¡¨è¾¾å¼å†™æ³•ï¼š user.username
- mybatisä¸­ä¸ºä»€ä¹ˆèƒ½ç›´æ¥å†™`username`ï¼Œè€Œä¸ç”¨ `user.` å‘¢ï¼Ÿ
  - ANSWERï¼šå› ä¸ºåœ¨parameterTypeä¸­å·²ç»æä¾›äº†å±æ€§æ‰€å±çš„ç±»ï¼Œæ‰€ä»¥ä¸éœ€è¦å†™å¯¹è±¡åã€‚

```java
/**
  * @description: æ ¹æ®QueryVOæŸ¥è¯¢ä¸­çš„æŸ¥è¯¢æ¡ä»¶æŸ¥è¯¢ç”¨æˆ·  QueryVoä¸ºæŸ¥è¯¢æ¡ä»¶å¯¹è±¡
  */
@Select("select * from user where username like #{user.username}")
int findUserByVo(QueryVo vo);
```



## CRUDæ“ä½œçš„å®ç°

### æ ¹æ® ID æŸ¥è¯¢

1ï¼‰åœ¨æŒä¹…å±‚æ¥å£ä¸­æ·»åŠ findByIdæ–¹æ³•

```java
public interface IUserDao {
/**
     * æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     * @param userId
     * @return
     */
    User findById(Integer userId);
}
```

2ï¼‰åœ¨ç”¨æˆ·çš„æ˜ å°„é…ç½®æ–‡ä»¶ä¸­é…ç½®

- `resultType` å±æ€§ï¼šç”¨äºæŒ‡å®šç»“æœé›†çš„ç±»å‹ã€‚
- `parameterType` å±æ€§ï¼šç”¨äºæŒ‡å®šä¼ å…¥å‚æ•°çš„ç±»å‹ã€‚
- `#{}`ä¸­å†…å®¹çš„å†™æ³•ï¼šç”±äº***æ•°æ®ç±»å‹æ˜¯åŸºæœ¬ç±»å‹ï¼Œæ‰€ä»¥æ­¤å¤„å¯ä»¥éšæ„å†™ã€‚***
- sql è¯­å¥ä¸­ä½¿ç”¨`#{}`å­—ç¬¦ï¼š
  - å®ƒä»£è¡¨å ä½ç¬¦ï¼Œç›¸å½“äºåŸæ¥ jdbc éƒ¨åˆ†æ‰€å­¦çš„ `?`ï¼Œéƒ½æ˜¯ç”¨äºæ‰§è¡Œè¯­å¥æ—¶æ›¿æ¢å®é™…çš„æ•°æ®ã€‚
  - å…·ä½“çš„æ•°æ®æ˜¯ç”± `#{}` é‡Œé¢çš„å†…å®¹å†³å®šçš„ã€‚

```xml
<!-- æ ¹æ®idæŸ¥è¯¢ç”¨æˆ· -->
<select id="findById" parameterType="INT" resultType="com.itheima.domain.User">
  select * from user where id = #{uid}
</select>
```

3ï¼‰åœ¨æµ‹è¯•ç±»æ·»åŠ æµ‹è¯•

```java
public class MybatisTest {

    private InputStream in;
    private IUserDao userDao;

    @Before//ç”¨äºåœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œ
    public void init()throws Exception{
        //1.è¯»å–é…ç½®æ–‡ä»¶ï¼Œç”Ÿæˆå­—èŠ‚è¾“å…¥æµ
        in = Resources.getResourceAsStream("SqlMapConfig.xml");
        //2.è·å–SqlSessionFactory
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(in);
        //3.ä½¿ç”¨å·¥å‚å¯¹è±¡ï¼Œåˆ›å»ºdaoå¯¹è±¡
        userDao = new UserDaoImpl(factory);
    }

    @After//ç”¨äºåœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œ
    public void destroy()throws Exception{
        //6.é‡Šæ”¾èµ„æº
        in.close();
    }
  
 
   /**
     * æµ‹è¯•æŸ¥è¯¢æ“ä½œ
     */
  	@Test
    public void testFindOne(){
        //5.æ‰§è¡ŒæŸ¥è¯¢ä¸€ä¸ªæ–¹æ³•
        User  user = userDao.findById(50);
        System.out.println(user);
    }
  
}
```



### ä¿å­˜æ“ä½œ

åœ¨ç”¨æˆ·çš„æ˜ å°„é…ç½®æ–‡ä»¶ä¸­é…ç½®

- `#{}`ä¸­å†…å®¹çš„å†™æ³•
  - ç”±äºæˆ‘ä»¬ä¿å­˜æ–¹æ³•çš„å‚æ•°æ˜¯ ä¸€ä¸ª User å¯¹è±¡ï¼Œæ­¤å¤„è¦å†™ User å¯¹è±¡ä¸­çš„å±æ€§åç§°ã€‚
  - å®ƒç”¨çš„æ˜¯ ognl è¡¨è¾¾å¼
  - `#{user.username}`å®ƒä¼šå…ˆå»æ‰¾ user å¯¹è±¡ï¼Œç„¶ååœ¨ user å¯¹è±¡ä¸­æ‰¾åˆ° username å±æ€§ï¼Œå¹¶è°ƒç”¨ getUsername()æ–¹æ³•æŠŠå€¼å–å‡ºæ¥ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨ parameterType å±æ€§ä¸ŠæŒ‡å®šäº†å®ä½“ç±»åç§°ï¼Œæ‰€ä»¥å¯ä»¥çœç•¥ user. è€Œç›´æ¥å†™ usernameã€‚

```xml
<!-- ä¿å­˜ç”¨æˆ· -->
<insert id="saveUser" parameterType="com.itheima.domain.User">
  insert into user(username,address,sex,birthday)values(#{username},#{address},#{sex},#{birthday});
</insert>
```

#### é—®é¢˜æ‰©å±•:æ–°å¢ç”¨æˆ·idçš„è¿”å›å€¼

æ–°å¢ç”¨æˆ·åï¼ŒåŒæ—¶è¿˜è¦è¿”å›å½“å‰æ–°å¢ç”¨æˆ·çš„ id å€¼ï¼Œå› ä¸º id æ˜¯ç”±æ•°æ®åº“çš„è‡ªåŠ¨å¢é•¿æ¥å®ç°çš„ï¼Œæ‰€ä»¥å°±ç›¸å½“äºæˆ‘ä»¬è¦åœ¨æ–°å¢åå°†è‡ªåŠ¨å¢é•¿ auto_increment çš„å€¼è¿”å›ã€‚

```xml
<insert id="saveUser" parameterType="com.itheima.domain.User">
  <!-- é…ç½®æ’å…¥æ“ä½œåï¼Œè·å–æ’å…¥æ•°æ®çš„id -->
  <selectKey keyProperty="id" keyColumn="id" resultType="int" order="AFTER">
    select last_insert_id();
  </selectKey>
  insert into user(username,address,sex,birthday)values(#{username},#{address},#{sex},#{birthday});
</insert>
```

### ç”¨æˆ·æ›´æ–°

```java
<!-- æ›´æ–°ç”¨æˆ· -->
<update id="updateUser" parameterType="com.itheima.domain.User">
  update user set username=#{username},address=#{address},sex=#{sex},birthday=#{birthday} where id=#{id}
</update>
```



### ç”¨æˆ·åˆ é™¤

```xml
<!-- åˆ é™¤ç”¨æˆ·-->
<delete id="deleteUser" parameterType="java.lang.Integer">
  delete from user where id = #{uid}
</delete>
```



### æŸ¥è¯¢ä½¿ç”¨èšåˆå‡½æ•°

```xml
<!-- æŸ¥è¯¢æ€»è®°å½•æ¡æ•° -->
<select id="findTotal" resultType="int"> select count(*) from user;
</select>
```



### ç”¨æˆ·æ¨¡ç³ŠæŸ¥è¯¢

1ï¼‰åœ¨ç”¨æˆ·çš„æ˜ å°„é…ç½®æ–‡ä»¶ä¸­é…ç½®

```xml
<!-- æ ¹æ®åç§°æ¨¡ç³ŠæŸ¥è¯¢ -->
<select id="findByName" parameterType="string" resultType="com.itheima.domain.User">
  select * from user where username like #{name}
</select>
```

2ï¼‰æµ‹è¯•æ–¹æ³•

```java
@Test
public void testFindByName(){
	List<User> users = userDao.findByName("%ç‹%"); for(User user : users){
	System.out.println(user); 
}
}
```

æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰åŠ å…¥%æ¥ä½œä¸ºæ¨¡ç³ŠæŸ¥è¯¢çš„æ¡ä»¶ï¼Œ***æ‰€ä»¥åœ¨ä¼ å…¥å­—ç¬¦ä¸²å®å‚æ—¶ï¼Œå°±éœ€è¦ç»™å®šæ¨¡ç³ŠæŸ¥è¯¢çš„æ ‡è¯†%ã€‚***é…ç½®æ–‡ä»¶ä¸­çš„#{username}ä¹Ÿåªæ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œæ‰€ä»¥ SQL è¯­å¥æ˜¾ç¤ºä¸º`â€œ?â€`ã€‚

åœ¨æ§åˆ¶å°è¾“å‡ºçš„æ‰§è¡Œ SQL è¯­å¥å¦‚ä¸‹:

![image-20201026175427656](/assets/imgs/image-20201026175427656.png)



### æ¨¡ç³ŠæŸ¥è¯¢çš„å¦ä¸€ç§é…ç½®æ–¹å¼

æˆ‘ä»¬åœ¨ä¸Šé¢å°†åŸæ¥çš„`#{}`å ä½ç¬¦ï¼Œæ”¹æˆäº†`${value}`ã€‚æ³¨æ„å¦‚æœç”¨æ¨¡ç³ŠæŸ¥è¯¢çš„è¿™ç§å†™æ³•ï¼Œé‚£ä¹ˆ`${value}`çš„å†™æ³•å°±æ˜¯å›ºå®šçš„ï¼Œä¸èƒ½å†™æˆå…¶å®ƒåå­—ã€‚

```xml
<!-- æ ¹æ®åç§°æ¨¡ç³ŠæŸ¥è¯¢ -->
<select id="findByName" parameterType="string" resultType="com.itheima.domain.User">
	select * from user where username like '%${value}%'
</select>
```

åœ¨æ§åˆ¶å°è¾“å‡ºçš„æ‰§è¡Œ SQL è¯­å¥å¦‚ä¸‹:

![image-20201026181540134](/assets/imgs/image-20201026181540134.png)



## `#{}`ä¸`${}`çš„åŒºåˆ«

- `#{}`è¡¨ç¤ºä¸€ä¸ªå ä½ç¬¦å·

  é€šè¿‡#{}å¯ä»¥å®ç° preparedStatement å‘å ä½ç¬¦ä¸­è®¾ç½®å€¼ï¼Œ***è‡ªåŠ¨è¿›è¡Œ java ç±»å‹å’Œ jdbc ç±»å‹è½¬æ¢***ï¼Œ\#{}å¯ä»¥æœ‰æ•ˆé˜²æ­¢ sql æ³¨å…¥ã€‚ #{}å¯ä»¥æ¥æ”¶ç®€å•ç±»å‹å€¼æˆ– pojo å±æ€§å€¼ã€‚ å¦‚æœ parameterType ä¼ è¾“å•ä¸ªç®€å•ç±»å‹å€¼ï¼Œ#{}æ‹¬å·ä¸­å¯ä»¥æ˜¯ value æˆ–å…¶å®ƒåç§°ã€‚

- `${}`è¡¨ç¤ºæ‹¼æ¥ sql ä¸²

  é€šè¿‡`${}`å¯ä»¥å°†parameterType ä¼ å…¥çš„å†…å®¹æ‹¼æ¥åœ¨sqlä¸­ä¸”ä¸è¿›è¡Œjdbcç±»å‹è½¬æ¢ï¼Œ `${}`å¯ä»¥æ¥æ”¶ç®€å•ç±»å‹å€¼æˆ– pojo å±æ€§å€¼ï¼Œå¦‚æœ parameterType ä¼ è¾“å•ä¸ªç®€å•ç±»å‹å€¼ï¼Œ`${}`æ‹¬å·ä¸­åªèƒ½æ˜¯ valueã€‚



## æ³¨æ„äº‹é¡¹

1. æŒä¹…å±‚æ¥å£å’ŒæŒä¹…å±‚æ¥å£çš„æ˜ å°„é…ç½®å¿…é¡»åœ¨ç›¸åŒçš„åŒ…ä¸‹
2. æŒä¹…å±‚æ˜ å°„é…ç½®ä¸­ mapper æ ‡ç­¾çš„ namespace å±æ€§å–å€¼å¿…é¡»æ˜¯æŒä¹…å±‚æ¥å£çš„å…¨é™å®šç±»å
3. SQL è¯­å¥çš„é…ç½®æ ‡ç­¾`<select>,<insert>,<delete>,<update>`çš„ id å±æ€§å¿…é¡»å’ŒæŒä¹…å±‚æ¥å£çš„æ–¹æ³•åç›¸åŒã€‚

---

# Mybatis çš„å‚æ•°æ·±å…¥

## parameterType é…ç½®å‚æ•°

SQL è¯­å¥ä¼ å‚ï¼Œä½¿ç”¨æ ‡ç­¾çš„ parameterType å±æ€§æ¥è®¾å®šã€‚è¯¥å±æ€§çš„å–å€¼å¯ä»¥æ˜¯åŸºæœ¬ç±»å‹ï¼Œå¼•ç”¨ç±»å‹(ä¾‹å¦‚:String ç±»å‹)ï¼Œè¿˜å¯ä»¥æ˜¯å®ä½“ç±»ç±»å‹(POJO ç±»)ã€‚åŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨å®ä½“ç±»çš„åŒ…è£…ç±»ï¼Œæœ¬ç« èŠ‚å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨å®ä½“ç±»çš„åŒ…è£…ç±»ä½œä¸ºå‚æ•°ä¼ é€’ã€‚  							 

***âš ï¸æ³¨æ„äº‹é¡¹:***

- åŸºæœ¬ç±»å‹å’Œ String æˆ‘ä»¬å¯ä»¥ç›´æ¥å†™ç±»å‹åç§°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŒ…å.ç±»åçš„æ–¹å¼ï¼Œä¾‹å¦‚:java.lang.Stringã€‚
- å®ä½“ç±»ç±»å‹ï¼Œç›®å‰æˆ‘ä»¬åªèƒ½ä½¿ç”¨å…¨é™å®šç±»åã€‚
- ç©¶å…¶åŸå› ï¼Œæ˜¯ mybaits åœ¨åŠ è½½æ—¶å·²ç»æŠŠå¸¸ç”¨çš„æ•°æ®ç±»å‹æ³¨å†Œäº†åˆ«åï¼Œä»è€Œæˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶å¯ä»¥ä¸å†™åŒ…åï¼Œè€Œæˆ‘ä»¬çš„æ˜¯å®ä½“ç±»å¹¶æ²¡æœ‰æ³¨å†Œåˆ«åï¼Œæ‰€ä»¥å¿…é¡»å†™å…¨é™å®šç±»åã€‚

è¿™äº›éƒ½æ˜¯æ”¯æŒçš„é»˜è®¤åˆ«å:

![image-20201026182624638](/assets/imgs/image-20201026182624638.png)

## ä¼ é€’ pojo åŒ…è£…å¯¹è±¡

å¼€å‘ä¸­é€šè¿‡ pojo ä¼ é€’æŸ¥è¯¢æ¡ä»¶ ï¼ŒæŸ¥è¯¢æ¡ä»¶æ˜¯ç»¼åˆçš„æŸ¥è¯¢æ¡ä»¶ï¼Œä¸ä»…åŒ…æ‹¬ç”¨æˆ·æŸ¥è¯¢æ¡ä»¶è¿˜åŒ…æ‹¬å…¶å®ƒçš„æŸ¥è¯¢æ¡ä»¶(æ¯”å¦‚å°†ç”¨æˆ·è´­ä¹°å•†å“ä¿¡æ¯ä¹Ÿä½œä¸ºæŸ¥è¯¢æ¡ä»¶)ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨åŒ…è£…å¯¹è±¡ä¼ é€’è¾“å…¥å‚æ•°ã€‚

Pojo ç±»ä¸­åŒ…å« pojoã€‚

éœ€æ±‚:æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒæŸ¥è¯¢æ¡ä»¶æ”¾åˆ° QueryVo çš„ user å±æ€§ä¸­ã€‚

### ç¼–å†™QueryVo

```java
/**
 * @program: day02_mybatisCRUD
 * @description: æŸ¥è¯¢æ¡ä»¶å¯¹è±¡
 * @author: Silince
 **/
public class QueryVo {
    private User user;

    public User getUser() {
        return user;
    }

    public void setUser(User user) {
        this.user = user;
    }
}
```

### ç¼–å†™æŒä¹…å±‚æ¥å£

```java
public interface UserDao {
   /**
     * @description: æ ¹æ®QueryVOæŸ¥è¯¢ä¸­çš„æŸ¥è¯¢æ¡ä»¶æŸ¥è¯¢ç”¨æˆ·
     */
    //@Select("select * from user where username like #{user.username}")
    List<User> findUserByVo(QueryVo vo);
}
```

### æŒä¹…å±‚æ¥å£çš„æ˜ å°„æ–‡ä»¶

```xml
<!-- æ ¹æ®ç”¨æˆ·åç§°æ¨¡ç³ŠæŸ¥è¯¢ï¼Œå‚æ•°å˜æˆä¸€ä¸ª QueryVo å¯¹è±¡äº† -->
<select id="findByVo" resultType="com.itheima.domain.User"
        parameterType="com.itheima.domain.QueryVo"> select * from user where username like #{user.username};
</select>
```

### æµ‹è¯•åŒ…è£…ç±»

```java
@Test
public void testFindByQueryVo() { 
  QueryVo vo = new QueryVo(); 
  User user = new User();
	user.setUserName("%ç‹%"); 
  vo.setUser(user);
	List<User> users = userDao.findByVo(vo);
	for(User u : users) { 
    System.out.println(u);
	}
}
```





# Mybatis çš„è¾“å‡ºç»“æœå°è£…

## resultType é…ç½®ç»“æœç±»å‹

resultType å±æ€§å¯ä»¥æŒ‡å®šç»“æœé›†çš„ç±»å‹ï¼Œå®ƒæ”¯æŒåŸºæœ¬ç±»å‹å’Œå®ä½“ç±»ç±»å‹ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒå’Œ parameterType ä¸€æ ·ï¼Œå¦‚æœæ³¨å†Œè¿‡ç±»å‹åˆ«åçš„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨åˆ«åã€‚æ²¡æœ‰æ³¨å†Œè¿‡çš„å¿…é¡»ä½¿ç”¨å…¨é™å®šç±»åã€‚

åŒæ—¶ï¼Œå½“æ˜¯å®ä½“ç±»åç§°æ˜¯ï¼Œè¿˜æœ‰ä¸€ä¸ªè¦æ±‚ï¼Œå®ä½“ç±»ä¸­çš„å±æ€§åç§°å¿…é¡»å’ŒæŸ¥è¯¢è¯­å¥ä¸­çš„åˆ—åä¿æŒä¸€è‡´ï¼Œå¦åˆ™æ— æ³•å®ç°å°è£…ã€‚

## ä¿®æ”¹æ˜ å°„é…ç½®

ä½¿ç”¨åˆ«åæŸ¥è¯¢

```xml
<!-- é…ç½®æŸ¥è¯¢æ‰€æœ‰æ“ä½œ -->
<select id="findAll" resultType="com.itheima.domain.User">
  select id as userId,username as userName,birthday as userBirthday, sex as userSex,address as userAddress from user
</select>
```

å¦‚æœæˆ‘ä»¬çš„æŸ¥è¯¢å¾ˆå¤šï¼Œéƒ½ä½¿ç”¨åˆ«åçš„è¯å†™èµ·æ¥å²‚ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Œæœ‰æ²¡æœ‰åˆ«çš„è§£å†³åŠæ³•å‘¢?

## resultMap ç»“æœç±»å‹

resultMap æ ‡ç­¾å¯ä»¥å»ºç«‹æŸ¥è¯¢çš„åˆ—åå’Œå®ä½“ç±»çš„å±æ€§åç§°ä¸ä¸€è‡´æ—¶å»ºç«‹å¯¹åº”å…³ç³»ã€‚ä»è€Œå®ç°å°è£…ã€‚

åœ¨ select æ ‡ç­¾ä¸­ä½¿ç”¨ resultMap å±æ€§æŒ‡å®šå¼•ç”¨å³å¯ã€‚åŒæ—¶ resultMap å¯ä»¥å®ç°å°†æŸ¥è¯¢ç»“æœæ˜ å°„ä¸ºå¤æ‚ç±»å‹çš„ pojoï¼Œæ¯”å¦‚åœ¨æŸ¥è¯¢ç»“æœæ˜ å°„å¯¹è±¡ä¸­åŒ…æ‹¬ pojo å’Œ list å®ç°ä¸€å¯¹ä¸€æŸ¥è¯¢å’Œä¸€å¯¹å¤šæŸ¥è¯¢ã€‚

### å®šä¹‰resultMap

- id æ ‡ç­¾:ç”¨äºæŒ‡å®šä¸»é”®å­—æ®µ
- result æ ‡ç­¾:ç”¨äºæŒ‡å®šéä¸»é”®å­—æ®µ
- column å±æ€§:ç”¨äºæŒ‡å®šæ•°æ®åº“åˆ—å
- property å±æ€§:ç”¨äºæŒ‡å®šå®ä½“ç±»å±æ€§åç§°

```xml
<!-- å»ºç«‹ User å®ä½“å’Œæ•°æ®åº“è¡¨çš„å¯¹åº”å…³ç³»
			type å±æ€§:æŒ‡å®šå®ä½“ç±»çš„å…¨é™å®šç±»å
			id å±æ€§:ç»™å®šä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œæ˜¯ç»™æŸ¥è¯¢ select æ ‡ç­¾å¼•ç”¨ç”¨çš„ã€‚ -->
<resultMap type="com.itheima.domain.User" id="userMap"> <id column="id" property="userId"/>
  <result column="username" property="userName"/>
  <result column="sex" property="userSex"/>
  <result column="address" property="userAddress"/>
  <result column="birthday" property="userBirthday"/> 
</resultMap>
```

### æ˜ å°„é…ç½®

```xml
<!-- é…ç½®æŸ¥è¯¢æ‰€æœ‰æ“ä½œ -->
<select id="findAll" resultMap="userMap"> 
  select * from user
</select>
```





# SqlMapConfig.xmlé…ç½®æ–‡ä»¶

## SqlMapConfig.xmlä¸­é…ç½®çš„å†…å®¹å’Œé¡ºåº

```xml
-properties(å±æ€§) 
	--property
-settings(å…¨å±€é…ç½®å‚æ•°) 
	--setting
-typeAliases(ç±»å‹åˆ«å) 
	--typeAliase
	--package
-typeHandlers(ç±»å‹å¤„ç†å™¨)
-objectFactory(å¯¹è±¡å·¥å‚) 
-plugins(æ’ä»¶) 
-environments(ç¯å¢ƒé›†åˆå±æ€§å¯¹è±¡)
	--environment(ç¯å¢ƒå­å±æ€§å¯¹è±¡)
		---transactionManager(äº‹åŠ¡ç®¡ç†) 
		---dataSource(æ•°æ®æº)
-mappers(æ˜ å°„å™¨) 
	--mapper
	--package
```

## properties(å±æ€§)

åœ¨ä½¿ç”¨ properties æ ‡ç­¾é…ç½®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸¤ç§æ–¹å¼æŒ‡å®šå±æ€§é…ç½®ã€‚

```xml
<properties>
  <property name="jdbc.driver" value="com.mysql.jdbc.Driver"/> <property name="jdbc.url" value="jdbc:mysql://localhost:3306/eesy"/>
  <property name="jdbc.username" value="root"/>
  <property name="jdbc.password" value="1234"/> 
</properties>
```

æˆ–åœ¨ classpath ä¸‹å®šä¹‰ db.properties 

```properties
jdbc.driver=com.mysql.jdbc.Driver 
jdbc.url=jdbc:mysql://localhost:3306/eesy 
jdbc.username=root
jdbc.password=1234
```

## typeAliases(ç±»å‹åˆ«å)

åœ¨å‰é¢æˆ‘ä»¬è®²çš„ Mybatis æ”¯æŒçš„é»˜è®¤åˆ«åï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨è‡ªå®šä¹‰åˆ«åæ–¹å¼æ¥å¼€å‘ã€‚

åœ¨ SqlMapConfig.xml ä¸­é…ç½®:

```xml
</typeAliases>
	<!-- å•ä¸ªåˆ«åå®šä¹‰ -->
	<typeAlias alias="user" type="com.itheima.domain.User"/>
	<!-- æ‰¹é‡åˆ«åå®šä¹‰ï¼Œæ‰«ææ•´ä¸ªåŒ…ä¸‹çš„ç±»ï¼Œåˆ«åä¸ºç±»å(é¦–å­—æ¯å¤§å†™æˆ–å°å†™éƒ½å¯ä»¥) -->
	<package name="com.itheima.domain"/> 
	<package name="å…¶å®ƒåŒ…"/>
</typeAliases>
```

## mappers(æ˜ å°„å™¨)

- `<mapperresource=""/>`
  - ä½¿ç”¨ç›¸å¯¹äºç±»è·¯å¾„çš„èµ„æº
  - å¦‚:`<mapper resource="com/itheima/dao/IUserDao.xml" />`
- `<mapperclass=""/>`
  - ä½¿ç”¨ mapper æ¥å£ç±»è·¯å¾„
  - å¦‚:`<mapper class="com.itheima.dao.UserDao"/>`
  - æ³¨æ„:æ­¤ç§æ–¹æ³•è¦æ±‚ mapper æ¥å£åç§°å’Œ mapper æ˜ å°„æ–‡ä»¶åç§°ç›¸åŒï¼Œä¸”æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸­ã€‚

- `<package name=""/>`
  - æ³¨å†ŒæŒ‡å®šåŒ…ä¸‹çš„æ‰€æœ‰ mapper æ¥å£
  - å¦‚:`<package name="cn.itcast.mybatis.mapper"/>`
  - æ³¨æ„:æ­¤ç§æ–¹æ³•è¦æ±‚ mapper æ¥å£åç§°å’Œ mapper æ˜ å°„æ–‡ä»¶åç§°ç›¸åŒï¼Œä¸”æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸­ã€‚



# Mybatisè¿æ¥æ± ä¸äº‹åŠ¡

## è¿æ¥æ± 

åœ¨å®é™…å¼€å‘ä¸­éƒ½ä¼šä½¿ç”¨è¿æ¥æ± ï¼Œå› ä¸ºä»–å¯ä»¥å‡å°‘æˆ‘ä»¬è·å–é“¾æ¥æ‰€æ¶ˆè€—çš„æ—¶é—´ã€‚

- è¿æ¥æ± å°±æ˜¯ç”¨äºå­˜å‚¨è¿æ¥çš„ä¸€ä¸ªå®¹å™¨
- å®¹å™¨å…¶å®å°±æ˜¯ä¸€ä¸ªé›†åˆå¯¹è±¡ï¼Œè¯¥é›†åˆå¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸èƒ½è®©ä¸¤ä¸ªçº¿ç¨‹æ‹¿åˆ°åŒä¸€ä¸ªè¿æ¥
- è¯¥é›†åˆè¿˜å¿…é¡»å®ç°é˜Ÿåˆ—çš„ç‰¹æ€§:å…ˆè¿›å…ˆå‡º

### Mybatisä¸­çš„è¿æ¥æ± 

mybatisæä¾›äº†3ç§æ–¹å¼çš„é…ç½®

é…ç½®çš„ä½ç½®ï¼šä¸»é…ç½®æ–‡ä»¶SqlMapConfig.xmlä¸­çš„dataSourceæ ‡ç­¾ï¼Œtypeå±æ€§å°±æ˜¯è¡¨ç¤ºé‡‡ç”¨ä½•ç§è¿æ¥æ± æ–¹å¼ã€‚

typeå±æ€§çš„å–å€¼ï¼š

- â­ï¸POOLED   é‡‡ç”¨ä¼ ç»Ÿçš„javax.sql.DataSourceè§„èŒƒä¸­çš„è¿æ¥æ± ï¼Œmybatisæœ‰è¯¥è§„èŒƒçš„å®ç°
- UNPOOLED  é‡‡ç”¨ä¼ ç»Ÿè·å–è¿æ¥çš„æ–¹å¼ï¼Œä¹Ÿå®ç°äº†javax.sql.DataSourceæ¥å£ï¼Œä½†æ˜¯æ²¡æœ‰ä½¿ç”¨æ± çš„æ€æƒ³
- JNDI  é‡‡ç”¨æœåŠ¡å™¨æä¾›çš„æŠ€æœ¯JNDIæŠ€æœ¯å®ç°ï¼Œæ¥è·å–DataSourceå¯¹è±¡ï¼Œä¸åŒçš„æœåŠ¡å™¨èƒ½æ‹¿åˆ°çš„DataSourceå¯¹è±¡æ˜¯ä¸ä¸€æ ·çš„ã€‚psï¼šå¦‚æœä¸æ˜¯webæˆ–è€…mavençš„warå·¥ç¨‹ï¼Œä¸èƒ½ä½¿ç”¨ã€‚(tomcatæœåŠ¡å™¨é‡‡ç”¨çš„æ˜¯dbcpè¿æ¥æ± )

![æ— æ ‡é¢˜2](/assets/imgs/æ— æ ‡é¢˜2.png)

## Mybatisä¸­çš„äº‹åŠ¡

Mybatisä¸­æ˜¯é€šè¿‡SqlSessionå¯¹è±¡çš„commitæ–¹æ³•å’Œrollbackæ–¹æ³•å®ç°äº‹åŠ¡çš„æäº¤å’Œå›æ»šï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ JDBC çš„ setAutoCommit()æ¥å®ç°äº‹åŠ¡æ§åˆ¶ã€‚

### Mybatisè‡ªåŠ¨æäº¤äº‹åŠ¡çš„è®¾ç½®

ä¸ºä»€ä¹ˆ CUD è¿‡ç¨‹ä¸­å¿…é¡»ä½¿ç”¨ sqlSession.commit()æäº¤äº‹åŠ¡?ä¸»è¦åŸå› å°±æ˜¯åœ¨è¿æ¥æ± ä¸­å–å‡ºçš„è¿æ¥ï¼Œéƒ½ä¼šå°†è°ƒç”¨ connection.setAutoCommit(false)æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¿…é¡»ä½¿ç”¨ sqlSession.commit()æ–¹æ³•ï¼Œç›¸å½“äºä½¿ç”¨äº† JDBC ä¸­çš„ connection.commit()æ–¹æ³•å®ç°äº‹åŠ¡æäº¤ã€‚ 				

```java
// åˆ›å»º SqlSession å¯¹è±¡
session = factory.openSession(true);// è‡ªåŠ¨æäº¤äº‹åŠ¡		
session = factory.openSession(); // æ‰‹åŠ¨æäº¤äº‹åŠ¡
```

âš ï¸***å°±ç¼–ç¨‹è€Œè¨€ï¼Œè®¾ç½®ä¸ºè‡ªåŠ¨æäº¤æ–¹å¼ä¸º false å†æ ¹æ®æƒ…å†µå†³å®šæ˜¯å¦è¿›è¡Œæäº¤ï¼Œè¿™ç§æ–¹å¼æ›´å¸¸ç”¨ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸šåŠ¡ æƒ…å†µæ¥å†³å®šæäº¤æ˜¯å¦è¿›è¡Œæäº¤ã€‚*** 



# Mybatis çš„åŠ¨æ€ SQL è¯­å¥

> [code](https://github.com/Silincee/Mybatis/tree/main/day03_dynamicSQL)

Mybatis çš„æ˜ å°„æ–‡ä»¶ä¸­ï¼Œå‰é¢æˆ‘ä»¬çš„ SQL éƒ½æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæœ‰äº›æ—¶å€™ä¸šåŠ¡é€»è¾‘å¤æ‚æ—¶ï¼Œæˆ‘ä»¬çš„ SQL æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ­¤æ—¶åœ¨å‰é¢çš„å­¦ä¹ ä¸­æˆ‘ä»¬çš„ SQL å°±ä¸èƒ½æ»¡è¶³è¦æ±‚äº†ã€‚

## `<if>`æ ‡ç­¾

æˆ‘ä»¬æ ¹æ®å®ä½“ç±»çš„ä¸åŒå–å€¼ï¼Œä½¿ç”¨ä¸åŒçš„ SQL è¯­å¥æ¥è¿›è¡ŒæŸ¥è¯¢ã€‚æ¯”å¦‚åœ¨ id å¦‚æœä¸ä¸ºç©ºæ—¶å¯ä»¥æ ¹æ® id æŸ¥è¯¢ï¼Œå¦‚æœ username ä¸åŒç©ºæ—¶è¿˜è¦åŠ å…¥ç”¨æˆ·åä½œä¸ºæ¡ä»¶ã€‚

æŒä¹…å±‚Daoæ˜ å°„é…ç½®:

- `<if>`æ ‡ç­¾çš„ test å±æ€§ä¸­å†™çš„æ˜¯å¯¹è±¡çš„å±æ€§åï¼Œå¦‚æœæ˜¯åŒ…è£…ç±»çš„å¯¹è±¡è¦ä½¿ç”¨ OGNL è¡¨è¾¾å¼çš„å†™æ³•ã€‚
-  åœ¨æŸ¥è¯¢æ¡ä»¶æ•°é‡ä¸ç¡®å®šçš„æ¡ä»¶æƒ…å†µä¸‹ï¼Œä½¿ç”¨ where 1=1å¯ä»¥å¾ˆæ–¹ä¾¿çš„è§„èŒƒè¯­å¥;åªæ˜¯ä¸ºäº†æ»¡è¶³å¤šæ¡ä»¶æŸ¥è¯¢é¡µé¢ä¸­ä¸ç¡®å®šçš„å„ç§å› ç´ è€Œé‡‡ç”¨çš„ä¸€ç§æ„é€ ä¸€æ¡æ­£ç¡®èƒ½è¿è¡Œçš„åŠ¨æ€SQLè¯­å¥çš„ä¸€ç§æ–¹æ³•ã€‚

```java
@Select({"<script> " +
  "select * from user where  1=1 " +
  "<if test='username!=null'> and username = #{username}</if> " +
  "<if test='sex!=null'> and sex = #{sex}</if> " +
  "</script>"})
List<User> findUserByCondition(User user);
```

## `<where>`æ ‡ç­¾

ä¸ºäº†ç®€åŒ–ä¸Šé¢where 1=1çš„æ¡ä»¶æ‹¼è£…ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨<where>æ ‡ç­¾æ¥ç®€åŒ–å¼€å‘ã€‚

```java
@Select({"<script> " +
  "select * from user " +
  "<where>"+
  "<if test='username!=null'> and username = #{username}</if> " +
  "<if test='sex!=null'> and sex = #{sex}</if> " +
  "</where>"+
  "</script>"})
List<User> findUserByCondition(User user);
```

## `<foreach>`æ ‡ç­¾

ä¼ å…¥å¤šä¸ª id æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨ä¸‹è¾¹ä¸¤ä¸ª sql å®ç°:

- `SELECT * FROM USERS WHERE username LIKE '%å¼ %' AND (id =10 OR id =89 OR id=16)`
- `SELECT * FROM USERS WHERE username LIKE '%å¼ %' AND id IN (10,89,16)`

è¿™æ ·æˆ‘ä»¬åœ¨è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå°±è¦å°†ä¸€ä¸ªé›†åˆä¸­çš„å€¼ï¼Œä½œä¸ºå‚æ•°åŠ¨æ€æ·»åŠ è¿›æ¥ã€‚

åœ¨ QueryVo ä¸­åŠ å…¥ä¸€ä¸ª List é›†åˆç”¨äºå°è£…å‚æ•°:

SQL è¯­å¥:`select å­—æ®µ from user where id in (?)`

`<foreach>`æ ‡ç­¾ç”¨äºéå†é›†åˆï¼Œå®ƒçš„å±æ€§:

- collection:ä»£è¡¨è¦éå†çš„é›†åˆå…ƒç´ ï¼Œæ³¨æ„ç¼–å†™æ—¶ä¸è¦å†™#{}
- open:ä»£è¡¨è¯­å¥çš„å¼€å§‹éƒ¨åˆ†
- close:ä»£è¡¨ç»“æŸéƒ¨åˆ†
- item:ä»£è¡¨éå†é›†åˆçš„æ¯ä¸ªå…ƒç´ ï¼Œç”Ÿæˆçš„å˜é‡å
- sperator:ä»£è¡¨åˆ†éš”ç¬¦

```java
/**
  * @description: æ ¹æ®queryvoä¸­æä¾›çš„idé›†åˆï¼ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
  */
@Select({"<script> " +
  "select * from user " +
  "<where>" +
  "<if test='ids!=null and ids.size()>0'>" +
  "<foreach collection='ids' open='and id in (' close=')' item='id' separator=','> " +
  "#{id}" +
  " </foreach>" +
  "</if>" +
  "</where>"  +
  "</script>"})
List<User> findUserInIds(QueryVo vo);
```

ç¼–å†™æµ‹è¯•æ–¹æ³•

```java
@Test
public void testFindInIds(){
  QueryVo vo = new QueryVo();
  List<Integer> list = new ArrayList<>();
  list.add(41);
  list.add(42);
  list.add(43);
  vo.setIds(list);

  List<User> users = userDao.findUserInIds(vo);
  for (User user : users) {
    System.out.println(user);
  }

}
```







# Mybatisä¸­çš„å¤šè¡¨æŸ¥è¯¢

## ä¸€å¯¹å¤šç¤ºä¾‹ï¼šç”¨æˆ·å’Œè´¦æˆ·

> [ä¸€å¯¹å¤š](https://github.com/Silincee/Mybatis/tree/main/day03_one2many)

- ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè´¦æˆ·

- ä¸€ä¸ªè´¦æˆ·åªèƒ½å±äºä¸€ä¸ªç”¨æˆ·ï¼ˆå¤šä¸ªè´¦æˆ·ä¹Ÿå¯ä»¥å±äºä¸€ä¸ªç”¨æˆ·ï¼‰

æ­¥éª¤ï¼š

1. å»ºç«‹ä¸¤å¼ è¡¨ï¼šç”¨æˆ·è¡¨ï¼Œè´¦æˆ·è¡¨ï¼Œè®©ç”¨æˆ·è¡¨å’Œè´¦æˆ·è¡¨ä¹‹é—´å…·å¤‡ä¸€å¯¹å¤šçš„å…³ç³»ï¼ˆéœ€è¦ä½¿ç”¨å¤–é”®åœ¨è´¦æˆ·è¡¨æ·»åŠ ï¼‰
2. å»ºç«‹ä¸¤ä¸ªå®ä½“ç±»ï¼šç”¨æˆ·å®ä½“ç±»å’Œè´¦æˆ·å®ä½“ç±»ï¼Œè®©ç”¨æˆ·å’Œå®ä½“ç±»èƒ½å¤Ÿä½“ç°å‡ºä¸€å¯¹å¤šçš„å…³ç³»
3. å»ºç«‹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ 
   - ç”¨æˆ·çš„é…ç½®æ–‡ä»¶
   - è´¦æˆ·çš„é…ç½®æ–‡ä»¶
4. å®ç°é…ç½®ï¼š
   - å½“æˆ‘ä»¬æŸ¥è¯¢ç”¨æˆ·æ—¶ï¼Œå¯ä»¥åŒæ—¶å¾—åˆ°ç”¨æˆ·ä¸‹åŒ…å«çš„è´¦æˆ·ä¿¡æ¯
   - å½“æˆ‘ä»¬æŸ¥è¯¢è´¦æˆ·æ—¶ï¼Œå¯ä»¥åŒæ—¶å¾—åˆ°è´¦æˆ·çš„æ‰€å±ç”¨æˆ·ä¿¡æ¯  

## å¤šå¯¹å¤šç¤ºä¾‹ï¼šç”¨æˆ·å’Œè§’è‰²

> [å¤šå¯¹å¤š](https://github.com/Silincee/Mybatis/tree/main/day03_many2many)

- ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²
- ä¸€ä¸ªè§’è‰²å¯ä»¥èµ‹äºˆå¤šä¸ªç”¨æˆ·

æ­¥éª¤ï¼š

1. å»ºç«‹ä¸¤å¼ è¡¨ï¼šç”¨æˆ·è¡¨ï¼Œè§’è‰²è¡¨ï¼Œè®©ç”¨æˆ·è¡¨å’Œè§’è‰²è¡¨ä¹‹é—´å…·å¤‡å¤šå¯¹å¤šçš„å…³ç³»ã€‚ï¼ˆéœ€è¦ä½¿ç”¨ä¸­é—´è¡¨ï¼Œä¸­é—´è¡¨åŒ…å«å„è‡ªçš„ä¸»é”®ï¼Œåœ¨ä¸­é—´è¡¨ä¸­æ˜¯å¤–é”®ï¼‰
2. å»ºç«‹ä¸¤ä¸ªå®ä½“ç±»ï¼šç”¨æˆ·å®ä½“ç±»å’Œè§’è‰²å®ä½“ç±»ï¼Œè®©ç”¨æˆ·å’Œè§’è‰²ç±»èƒ½å¤Ÿä½“ç°å‡ºå¤šå¯¹å¤šçš„å…³ç³»ï¼ˆå„è‡ªåŒ…å«å¯¹æ–¹ä¸€ä¸ªé›†åˆå¼•ç”¨ï¼‰
3. å»ºç«‹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ 
   - ç”¨æˆ·çš„é…ç½®æ–‡ä»¶
   - è§’è‰²çš„é…ç½®æ–‡ä»¶
4. å®ç°é…ç½®ï¼š
   - å½“æˆ‘ä»¬æŸ¥è¯¢ç”¨æˆ·æ—¶ï¼Œå¯ä»¥åŒæ—¶å¾—åˆ°ç”¨æˆ·ä¸‹åŒ…å«çš„è§’è‰²ä¿¡æ¯
   - å½“æˆ‘ä»¬æŸ¥è¯¢è§’è‰²æ—¶ï¼Œå¯ä»¥åŒæ—¶å¾—åˆ°è§’è‰²æ‰€èµ‹äºˆçš„ç”¨æˆ·



# Mybatisä¸­çš„å»¶è¿ŸåŠ è½½

> [å»¶è¿ŸåŠ è½½](https://github.com/Silincee/Mybatis/tree/main/day04_eesy_01lazy)

## ä½•ä¸ºå»¶è¿ŸåŠ è½½

å®é™…å¼€å‘è¿‡ç¨‹ä¸­å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¹¶ä¸éœ€è¦æ€»æ˜¯åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯æ—¶å°±ä¸€å®šè¦åŠ è½½ä»–çš„è´¦æˆ·ä¿¡æ¯ã€‚æ­¤æ—¶å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å»¶è¿ŸåŠ è½½ã€‚

```
é—®é¢˜ï¼šåœ¨ä¸€å¯¹å¤šç§ï¼Œå½“æˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨æˆ·ï¼Œä»–æœ‰100ä¸ªè´¦æˆ·
	åœ¨æŸ¥è¯¢ç”¨æˆ·çš„æ—¶å€™ï¼Œè¦ä¸è¦æŠŠå…³è”çš„è´¦æˆ·æŸ¥å‡ºæ¥ï¼Ÿ
	åœ¨æŸ¥è¯¢è´¦æˆ·çš„æ—¶å€™ï¼Œè¦ä¸è¦æŠŠå…³è”çš„ç”¨æˆ·æŸ¥å‡ºæ¥ï¼Ÿ
	
	åœ¨æŸ¥è¯¢ç”¨æˆ·æ—¶ï¼Œç”¨æˆ·ä¸‹çš„è´¦æˆ·ä¿¡æ¯åº”è¯¥ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ï¼Œä»€ä¹ˆæ—¶å€™æŸ¥è¯¢å‡ºæ¥
	åœ¨æŸ¥è¯¢è´¦æˆ·æ—¶ï¼Œè´¦æˆ·æ‰€å±çš„ç”¨æˆ·ä¿¡æ¯åº”è¯¥æ˜¯éšç€è´¦æˆ·æŸ¥è¯¢æ—¶ä¸€èµ·æŸ¥è¯¢å‡ºæ¥çš„ã€‚
```

## å»¶è¿ŸåŠ è½½ä¸ç«‹å³åŠ è½½

- åœ¨çœŸæ­£ä½¿ç”¨æ•°æ®æ—¶æ‰å‘èµ·æŸ¥è¯¢ï¼Œä¸ç”¨çš„æ—¶å€™ä¸æŸ¥è¯¢ã€‚æŒ‰éœ€åŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰
- å¥½å¤„:å…ˆä»å•è¡¨æŸ¥è¯¢ï¼Œéœ€è¦æ—¶å†ä»å…³è”è¡¨å»å…³è”æŸ¥è¯¢ï¼Œå¤§å¤§æé«˜æ•°æ®åº“æ€§èƒ½ï¼Œå› ä¸ºæŸ¥è¯¢å•è¡¨è¦æ¯”å…³è”æŸ¥è¯¢å¤šå¼ è¡¨é€Ÿåº¦è¦å¿«ã€‚

ä»€ä¹ˆæ˜¯ç«‹å³åŠ è½½

- ä¸ç®¡ç”¨ä¸ç”¨ï¼Œåªè¦ä¸€è°ƒç”¨æ–¹æ³•é©¬ä¸Šå‘èµ·æŸ¥è¯¢

åœ¨å¯¹åº”çš„å››ç§è¡¨å…³ç³»ä¸­ï¼š

- ä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤š ï¼šé€šå¸¸æƒ…å†µä¸‹é‡‡ç”¨å»¶è¿ŸåŠ è½½ `@One`
- å¤šå¯¹ä¸€ï¼Œä¸€å¯¹ä¸€ï¼šåŒæƒ…æƒ…å†µä¸‹é‡‡ç”¨ç«‹å³åŠ è½½ `@Many`

## ä½¿ç”¨ assocation å®ç°å»¶è¿ŸåŠ è½½

åœ¨ Mybatis çš„é…ç½®æ–‡ä»¶ SqlMapConfig.xml æ–‡ä»¶ä¸­æ·»åŠ å»¶è¿ŸåŠ è½½çš„é…ç½®

```xml
<!--é…ç½®å‚æ•°-->
<settings>
  <!--å¼€å¯Mybatisæ”¯æŒå»¶è¿ŸåŠ è½½-->
  <setting name="lazyLoadingEnabled" value="true"/>
  <setting name="aggressiveLazyLoading" value="false"></setting>
</settings>
```



## ä½¿ç”¨ Collection å®ç°å»¶è¿ŸåŠ è½½

åŒæ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ä¸€å¯¹å¤šå…³ç³»é…ç½®çš„`<collection>`ç»“ç‚¹ä¸­é…ç½®å»¶è¿ŸåŠ è½½ç­–ç•¥ã€‚

`<collection>`ç»“ç‚¹ä¸­ä¹Ÿæœ‰ select å±æ€§ï¼Œcolumn å±æ€§ã€‚

1ï¼‰ç¼–å†™ç”¨æˆ·æŒä¹…å±‚æ˜ å°„é…ç½®

- `<collection>æ ‡ç­¾:`ä¸»è¦ç”¨äºåŠ è½½å…³è”çš„é›†åˆå¯¹è±¡
- select å±æ€§:ç”¨äºæŒ‡å®šæŸ¥è¯¢ account åˆ—è¡¨çš„ sql è¯­å¥ï¼Œæ‰€ä»¥å¡«å†™çš„æ˜¯è¯¥ sql æ˜ å°„çš„ id
- column å±æ€§:ç”¨äºæŒ‡å®š select å±æ€§çš„ sql è¯­å¥çš„å‚æ•°æ¥æºï¼Œä¸Šé¢çš„å‚æ•°æ¥è‡ªäº user çš„ id åˆ—ï¼Œæ‰€ä»¥å°±å†™æˆ id è¿™ä¸€ä¸ªå­—æ®µåäº†

```xml
<!-- å®šä¹‰Userçš„resultMap-->
<resultMap id="userAccountMap" type="user">
  <id property="id" column="id"></id>
  <result property="username" column="username"></result>
  <result property="address" column="address"></result>
  <result property="sex" column="sex"></result>
  <result property="birthday" column="birthday"></result>
  <!-- é…ç½®userå¯¹è±¡ä¸­accountsé›†åˆçš„æ˜ å°„ -->
  <collection property="accounts" ofType="account" select="com.itheima.dao.IAccountDao.findAccountByUid" column="id"></collection>
</resultMap>
```

2ï¼‰ç¼–å†™è´¦æˆ·æŒä¹…å±‚æ˜ å°„é…ç½®

```xml
<!-- æ ¹æ®idæŸ¥è¯¢ç”¨æˆ· -->
<select id="findById" parameterType="INT" resultType="user">
  select * from user where id = #{uid}
</select>
```





# Mybatisç¼“å­˜

## Mybatisä¸­çš„ç¼“å­˜

1. ä»€ä¹ˆæ˜¯ç¼“å­˜:å­˜åœ¨å†…å­˜ä¸­çš„ä¸´æ—¶æ•°æ®
2. ä¸ºä»€ä¹ˆä½¿ç”¨ç¼“å­˜ï¼šå‡å°‘å’Œæ•°æ®åº“çš„äº¤äº’æ¬¡æ•°ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚
3. ä»€ä¹ˆæ ·çš„æ•°æ®èƒ½ä½¿ç”¨ç¼“å­˜ï¼Œä»€ä¹ˆè¦çš„æ•°æ®ä¸èƒ½ï¼Ÿ
   - é€‚ç”¨äºç¼“å­˜ï¼šç»å¸¸æŸ¥è¯¢å¹¶ä¸”ä¸ç»å¸¸æ”¹å˜çš„ï¼Œæ•°æ®çš„æ­£ç¡®ä¸å¦å¯¹æœ€ç»ˆç»“æœå½±å“ä¸å¤§çš„ï¼Œ
   - ä¸é€‚ç”¨äºç¼“å­˜ï¼šç»å¸¸æ”¹å˜çš„æ•°æ®ï¼Œæ•°æ®çš„æ­£ç¡®ä¸å¦å¯¹æœ€ç»ˆç»“æœå½±å“å¾ˆå¤§ï¼ˆå•†å“çš„åº“å­˜ï¼Œé“¶è¡Œçš„æ±‡ç‡ç­‰ï¼‰
4. Myabitsä¸­çš„ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜
   - ä¸€çº§ç¼“å­˜ï¼š
     - æŒ‡çš„æ˜¯Mybatisä¸­SqlSessionå¯¹è±¡çš„ç¼“å­˜ã€‚å½“æˆ‘ä»¬æ‰§è¡ŒæŸ¥è¯¢ä¹‹åï¼ŒæŸ¥è¯¢çš„ç»“æœä¼šåŒæ—¶å­˜å…¥åˆ°SqlSessionä¸ºæˆ‘ä»¬æä¾›çš„ä¸€å—åŒºåŸŸä¸­ã€‚
     - è¯¥åŒºåŸŸçš„ç»“æ„æ˜¯ä¸€ä¸ªMapï¼Œä½†æˆ‘ä»¬å†æ¬¡æŸ¥è¯¢åŒæ ·çš„æ•°æ®ï¼Œmybatisä¼šæƒ³å»sqlsessionä¸­æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ï¼Œæœ‰çš„è¯ç›´æ¥ä½¿ç”¨ã€‚
     - å½“SqlSessionå¯¹è±¡æ¶ˆå¤±æ—¶ï¼Œmybatisçš„ä¸€çº§ç¼“å­˜ä¹Ÿå°±æ¶ˆå¤±äº†ã€‚
   
   ![image-20201026195136085](/assets/imgs/image-20201026195136085.png)
   
   - äºŒçº§ç¼“å­˜ï¼š
     - æŒ‡çš„æ˜¯Mybatisä¸­SqlSessionFactoryå¯¹è±¡çš„ç¼“å­˜ã€‚
     - ç”±åŒä¸€ä¸ªSqlSessionFactoryå¯¹è±¡åˆ›å»ºçš„SqlSessionå…±äº«å…¶ç¼“å­˜
     - âš ï¸***é’ˆå¯¹æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦æœ€æ–°çš„æ•°æ® sqlï¼Œè¦è®¾ç½®æˆ useCache=falseï¼Œç¦ç”¨äºŒçº§ç¼“å­˜ã€‚***
     
     ![image-20201026195218060](/assets/imgs/image-20201026195218060.png)
     
     - å­˜æ”¾çš„å†…å®¹æ˜¯æ•°æ®ï¼Œè€Œä¸æ˜¯å¯¹è±¡ã€‚
     
     - ä½¿ç”¨æ­¥éª¤ï¼š
       1. è®©Mybatisæ¡†æ¶æ”¯æŒäºŒçº§ç¼“å­˜ï¼ˆåœ¨SqlMapConfig.xmlä¸­é…ç½®ï¼‰
       
          ```xml
          <settings>
            <!-- å¼€å¯äºŒçº§ç¼“å­˜çš„æ”¯æŒ -->
            <setting name="cacheEnabled" value="true"/>
          </settings>
          ```
       
       2. è®©å½“å‰çš„æ˜ å°„æ–‡ä»¶æ”¯æŒäºŒçº§ç¼“å­˜ï¼ˆåœ¨IUserDao.xmlä¸­é…ç½®ï¼‰
       
          ```xml
          <!-- <cache>æ ‡ç­¾è¡¨ç¤ºå½“å‰è¿™ä¸ª mapper æ˜ å°„å°†ä½¿ç”¨äºŒçº§ç¼“å­˜ï¼ŒåŒºåˆ†çš„æ ‡å‡†å°±çœ‹ mapper çš„ namespace å€¼ã€‚ -->
          <mapper namespace="com.itheima.dao.IUserDao">
            <!-- å¼€å¯äºŒçº§ç¼“å­˜çš„æ”¯æŒ -->
            <cache></cache>
          </mapper>
          ```
       
       3. è®©å½“å‰çš„æ“ä½œæ”¯æŒäºŒçº§ç¼“å­˜ï¼ˆåœ¨selectæ ‡ç­¾ä¸­é…ç½®ï¼‰
       
          ```xml
          <!-- æ ¹æ® id æŸ¥è¯¢ -->
          <select id="findById" resultType="user" parameterType="int" useCache="true"> 		select * from user where id = #{uid}
          </select>
          ```
       
          

# Mybatisä¸­çš„æ³¨è§£å¼€å‘

> [Mybatisæ³¨è§£å¼€å‘](https://github.com/Silincee/Mybatis/tree/main/day04_eesy_04annoOne2Many)

## mybatis çš„å¸¸ç”¨æ³¨è§£è¯´æ˜

- @Insert:å®ç°æ–°å¢
- @Update:å®ç°æ›´æ–°
- @Delete:å®ç°åˆ é™¤
- @Select:å®ç°æŸ¥è¯¢
- @Result:å®ç°ç»“æœé›†å°è£…
- @Results:å¯ä»¥ä¸@Result ä¸€èµ·ä½¿ç”¨ï¼Œå°è£…å¤šä¸ªç»“æœé›†
- @ResultMap:å®ç°å¼•ç”¨@Results å®šä¹‰çš„å°è£…
- @One:å®ç°ä¸€å¯¹ä¸€ç»“æœé›†å°è£…
- @Many:å®ç°ä¸€å¯¹å¤šç»“æœé›†å°è£…
- @SelectProvider: å®ç°åŠ¨æ€SQLæ˜ å°„
- @CacheNamespace:å®ç°æ³¨è§£äºŒçº§ç¼“å­˜çš„ä½¿ç”¨
- @Param
  - åœ¨æ–¹æ³•å‚æ•°çš„å‰é¢å†™ä¸Š@Param("å‚æ•°å")ï¼Œè¡¨ç¤ºç»™å‚æ•°å‘½åï¼Œåç§°å°±æ˜¯æ‹¬å·ä¸­çš„å†…å®¹
  - `public Student select(@Param("aaaa") String name,@Param("bbbb")int class_id);`
  - ç»™å…¥å‚ String name å‘½åä¸ºaaaaï¼Œç„¶åsqlè¯­å¥`....where  s_name= #{aaaa} `ä¸­å°±å¯ä»¥æ ¹æ®aaaaå¾—åˆ°å‚æ•°å€¼äº†ã€‚



## ä½¿ç”¨ Mybatis æ³¨è§£å®ç°åŸºæœ¬ CRUD

1ï¼‰ç¼–å†™å®ä½“ç±» æ­¤å¤„æˆ‘ä»¬æ•…æ„å’Œæ•°æ®åº“è¡¨çš„åˆ—åä¸ä¸€è‡´ã€‚

```java
@Data
public class User implements Serializable{

    private Integer userId;
    private String userName;
    private String userAddress;
    private String userSex;
    private Date userBirthday;

    //ä¸€å¯¹å¤šå…³ç³»æ˜ å°„ï¼šä¸€ä¸ªç”¨æˆ·å¯¹åº”å¤šä¸ªè´¦æˆ·
    private List<Account> accounts;
}
```

2ï¼‰ä½¿ç”¨æ³¨è§£æ–¹å¼å¼€å‘æŒä¹…å±‚æ¥å£

é€šè¿‡æ³¨è§£æ–¹å¼ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦å†å»ç¼–å†™ UserDao.xml æ˜ å°„æ–‡ä»¶äº†

```java
//å¼€å¯äºŒçº§ç¼“å­˜
@CacheNamespace(blocking = true)
public interface IUserDao {

    /**
     * æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
     * @return
     */
    @Select("select * from user")
    @Results(id="userMap",value={
            @Result(id=true,column = "id",property = "userId"),
            @Result(column = "username",property = "userName"),
            @Result(column = "address",property = "userAddress"),
            @Result(column = "sex",property = "userSex"),
            @Result(column = "birthday",property = "userBirthday"),
            @Result(column = "id",property = "accounts",
                    many = @Many(select = "com.itheima.dao.IAccountDao.findAccountByUid",
                                fetchType = FetchType.LAZY))
    })
    List<User> findAll();

    /**
     * æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·
     * @param userId
     * @return
     */
    @Select("select * from user  where id=#{id} ")
    @ResultMap("userMap")
    User findById(Integer userId);

    /**
     * æ ¹æ®ç”¨æˆ·åç§°æ¨¡ç³ŠæŸ¥è¯¢
     * @param username
     * @return
     */
    @Select("select * from user where username like #{username} ")
    @ResultMap("userMap")
    List<User> findUserByName(String username);

  	/**
		* ä¿å­˜æ“ä½œ
		*/
   @Insert("insert into
          user(username,sex,birthday,address)values(#{username},#{sex},#{birthday},#{address} )")
   @SelectKey(keyColumn="id",keyProperty="id",resultType=Integer.class,before = false, statement = { "select last_insert_id()" })
   int saveUser(User user);
           
    /**
    * @description: æ ¹æ®idåˆ é™¤ç”¨æˆ·
    */
    @Delete("delete from user where id=#{id}")
    void deleteUser(Integer userId);
  
     /**
     * @description: æŸ¥è¯¢æ€»ç”¨æˆ·æ•°
     */
    @Select("select count(id) from user")
    int findTotal();

    /**
    * @description: æ›´æ–°ç”¨æˆ·
    */
    @Update("update user set username=#{username},address=#{address},sex=#{sex},birthday=#{birthday} where id=#{id}")
    void updateUser(User user);
}
```

3ï¼‰ç¼–å†™ SqlMapConfig é…ç½®æ–‡ä»¶

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <!-- å¼•å…¥å¤–éƒ¨é…ç½®æ–‡ä»¶-->
    <properties resource="jdbcConfig.properties"></properties>
    <!--é…ç½®å¼€å¯äºŒçº§ç¼“å­˜-->
    <settings>
        <setting name="cacheEnabled" value="true"/>
    </settings>

    <!--é…ç½®åˆ«å-->
    <typeAliases>
        <package name="com.itheima.domain"></package>
    </typeAliases>
    <!-- é…ç½®ç¯å¢ƒ-->
    <environments default="mysql">
        <environment id="mysql">
            <transactionManager type="JDBC"></transactionManager>
            <dataSource type="POOLED">
                <property name="driver" value="${jdbc.driver}"></property>
                <property name="url" value="${jdbc.url}"></property>
                <property name="username" value="${jdbc.username}"></property>
                <property name="password" value="${jdbc.password}"></property>
            </dataSource>
        </environment>
    </environments>
    <!-- æŒ‡å®šå¸¦æœ‰æ³¨è§£çš„daoæ¥å£æ‰€åœ¨ä½ç½® -->
    <mappers>
       <package name="com.itheima.dao"></package>
    </mappers>
</configuration>
```



## ä½¿ç”¨æ³¨è§£å®ç°å¤æ‚å…³ç³»æ˜ å°„å¼€å‘

å®ç°å¤æ‚å…³ç³»æ˜ å°„ä¹‹å‰æˆ‘ä»¬å¯ä»¥åœ¨æ˜ å°„æ–‡ä»¶ä¸­é€šè¿‡é…ç½®`<resultMap>`æ¥å®ç°ï¼Œåœ¨ä½¿ç”¨æ³¨è§£å¼€å‘æ—¶æˆ‘ä»¬éœ€è¦å€ŸåŠ©@Results æ³¨è§£ï¼Œ@Result æ³¨è§£ï¼Œ@One æ³¨è§£ï¼Œ@Many æ³¨è§£ã€‚

### å¤æ‚å…³ç³»æ˜ å°„çš„æ³¨è§£è¯´æ˜

![image-20201026200952201](/assets/imgs/image-20201026200952201.png)

### ä½¿ç”¨æ³¨è§£å®ç°ä¸€å¯¹ä¸€å¤æ‚å…³ç³»æ˜ å°„åŠå»¶è¿ŸåŠ è½½

åŠ è½½è´¦æˆ·ä¿¡æ¯æ—¶å¹¶ä¸”åŠ è½½è¯¥è´¦æˆ·çš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ ¹æ®æƒ…å†µå¯å®ç°å»¶è¿ŸåŠ è½½ã€‚(æ³¨è§£æ–¹å¼å®ç°)

```java
public interface IAccountDao {  
		 /**
     * æŸ¥è¯¢æ‰€æœ‰è´¦æˆ·ï¼Œå¹¶ä¸”è·å–æ¯ä¸ªè´¦æˆ·æ‰€å±çš„ç”¨æˆ·ä¿¡æ¯ id=true è¡¨ç¤ºidä¸ºä¸»é”®  fetchType= FetchType.EAGER ç«‹å³åŠ è½½
     */
    @Select("select * from account")
    @Results(id="accountMap",value = {
            @Result(id=true,column = "id",property = "id"),
            @Result(column = "uid",property = "uid"),
            @Result(column = "money",property = "money"),
            @Result(property = "user",column = "uid",one=@One(select="com.itheima.dao.IUserDao.findById",fetchType= FetchType.EAGER))
    })
    List<Account> findAll();
}
```



### ä½¿ç”¨æ³¨è§£å®ç°ä¸€å¯¹å¤šå¤æ‚å…³ç³»æ˜ å°„

æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œä¹Ÿè¦æŸ¥è¯¢ä»–çš„è´¦æˆ·åˆ—è¡¨ã€‚ä½¿ç”¨æ³¨è§£æ–¹å¼å®ç°ã€‚

ä¸€ä¸ªç”¨æˆ·å…·æœ‰å¤šä¸ªè´¦æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥å½¢æˆäº†ç”¨æˆ·(User)ä¸è´¦æˆ·(Account)ä¹‹é—´çš„ä¸€å¯¹å¤šå…³ç³»ã€‚

@Many:

- ç›¸å½“äº`<collection>`çš„é…ç½®
- select å±æ€§:ä»£è¡¨å°†è¦æ‰§è¡Œçš„ sql è¯­å¥
- fetchType å±æ€§:ä»£è¡¨åŠ è½½æ–¹å¼ï¼Œä¸€èˆ¬å¦‚æœè¦å»¶è¿ŸåŠ è½½éƒ½è®¾ç½®ä¸º LAZY çš„å€¼

```java
//å¼€å¯äºŒçº§ç¼“å­˜
@CacheNamespace(blocking = true)
public interface IUserDao {

  	 /**
     * æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
     * @return
     */
  @Select("select * from user")
  @Results(id="userMap",value={
    @Result(id=true,column = "id",property = "userId"),
    @Result(column = "username",property = "userName"),
    @Result(column = "address",property = "userAddress"),
    @Result(column = "sex",property = "userSex"),
    @Result(column = "birthday",property = "userBirthday"),
    @Result(column = "id",property = "accounts",
            many = @Many(select = "com.itheima.dao.IAccountDao.findAccountByUid",
                         fetchType = FetchType.LAZY))
  })
  List<User> findAll();
}
```





## mybatis åŸºäºæ³¨è§£çš„äºŒçº§ç¼“å­˜

```java
@CacheNamespace(blocking=true)//mybatis åŸºäºæ³¨è§£æ–¹å¼å®ç°é…ç½®äºŒçº§ç¼“å­˜ 
public interface IUserDao {}
```

