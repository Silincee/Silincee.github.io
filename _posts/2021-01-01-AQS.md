---
layout: post
title:  "AQS"
date:   2021-01-01 19:39:06 +0800--
categories: [å¹¶å‘ç¼–ç¨‹]
tags: [å¹¶å‘ç¼–ç¨‹, ]  

---

# å¯é‡å…¥é”å’Œé€’å½’é”ReentrantLock

## æ¦‚å¿µ

å¯é‡å…¥é”å°±æ˜¯é€’å½’é”

æŒ‡çš„æ˜¯åŒä¸€çº¿ç¨‹å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹åï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶èƒ½è·å–åˆ°è¯¥é”çš„ä»£ç ï¼Œåœ¨åŒä¸€çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”**(å‰æï¼šé”å¯¹è±¡å¾—æ˜¯åŒä¸€ä¸ªå¯¹è±¡)**

ä¹Ÿå°±æ˜¯è¯´ï¼š`çº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥çš„ä»£ç å—`

ReentrantLock / Synchronized å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å¯é‡å…¥é”ï¼Œå¯é‡å…¥é”çš„ä¸€ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä¸€å®šç¨‹åº¦é¿å…æ­»é”ã€‚

## ä»£ç 

å¯é‡å…¥é”å°±æ˜¯ï¼Œåœ¨ä¸€ä¸ªmethod1æ–¹æ³•ä¸­åŠ å…¥ä¸€æŠŠé”ï¼Œæ–¹æ³•2ä¹ŸåŠ é”äº†ï¼Œ**é‚£ä¹ˆä»–ä»¬æ‹¥æœ‰çš„æ˜¯åŒä¸€æŠŠé”**

```java
public synchronized void method1() {
	method2();
}

public synchronized void method2() {

}
```

ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªéœ€è¦è¿›å…¥method1åï¼Œé‚£ä¹ˆå®ƒä¹Ÿèƒ½ç›´æ¥è¿›å…¥method2æ–¹æ³•ï¼Œå› ä¸ºä»–ä»¬æ‰€æ‹¥æœ‰çš„é”ï¼Œæ˜¯åŒä¸€æŠŠã€‚

## ä½œç”¨

**å¯é‡å…¥é”çš„æœ€å¤§ä½œç”¨å°±æ˜¯é¿å…æ­»é”**

## å¯é‡å…¥é”éªŒè¯

### è¯æ˜Synchronized

```java
/**
 * å¯é‡å…¥é”ï¼ˆä¹Ÿå«é€’å½’é”ï¼‰
 * æŒ‡çš„æ˜¯åŒä¸€çº¿ç¨‹å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹åï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶èƒ½è·å–åˆ°è¯¥é”çš„ä»£ç ï¼Œåœ¨åŒä¸€çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”
 *
 * ä¹Ÿå°±æ˜¯è¯´ï¼š`çº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥çš„ä»£ç å—`
 */

/**
 * èµ„æºç±»
 */
class Phone {

    /**
     * å‘é€çŸ­ä¿¡
     * @throws Exception
     */
    public synchronized void sendSMS() throws Exception{
        System.out.println(Thread.currentThread().getName() + "\t invoked sendSMS()");

        // åœ¨åŒæ­¥æ–¹æ³•ä¸­ï¼Œè°ƒç”¨å¦å¤–ä¸€ä¸ªåŒæ­¥æ–¹æ³•
        sendEmail();
    }

    /**
     * å‘é‚®ä»¶
     * @throws Exception
     */
    public synchronized void sendEmail() throws Exception{
        System.out.println(Thread.currentThread().getId() + "\t invoked sendEmail()");
    }
}
public class ReenterLockDemo {


    public static void main(String[] args) {
        Phone phone = new Phone();

        // ä¸¤ä¸ªçº¿ç¨‹æ“ä½œèµ„æºåˆ—
        new Thread(() -> {
            try {
                phone.sendSMS();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }, "t1").start();

        new Thread(() -> {
            try {
                phone.sendSMS();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }, "t2").start();
    }
}
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªèµ„æºç±»phoneï¼Œæ‹¥æœ‰ä¸¤ä¸ªåŠ äº†synchronizedçš„åŒæ­¥æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯sendSMS å’Œ sendEmailï¼Œæˆ‘ä»¬åœ¨sendSMSæ–¹æ³•ä¸­ï¼Œè°ƒç”¨sendEmailã€‚æœ€ååœ¨ä¸»çº¿ç¨‹åŒæ—¶å¼€å¯äº†ä¸¤ä¸ªçº¿ç¨‹è¿›è¡Œæµ‹è¯•ï¼Œæœ€åå¾—åˆ°çš„ç»“æœä¸ºï¼š

```java
t1	 invoked sendSMS()
t1	 invoked sendEmail()
t2	 invoked sendSMS()
t2	 invoked sendEmail()
```

**è¿™å°±è¯´æ˜å½“ t1 çº¿ç¨‹è¿›å…¥sendSMSçš„æ—¶å€™ï¼Œæ‹¥æœ‰äº†ä¸€æŠŠé”ï¼ŒåŒæ—¶t2çº¿ç¨‹æ— æ³•è¿›å…¥ï¼Œç›´åˆ°t1çº¿ç¨‹æ‹¿ç€é”ï¼Œæ‰§è¡Œäº†sendEmail æ–¹æ³•åï¼Œæ‰é‡Šæ”¾é”ï¼Œè¿™æ ·t2æ‰èƒ½å¤Ÿè¿›å…¥**

```java
t1	 invoked sendSMS()      t1çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™
t1	 invoked sendEmail()    t1åœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”

t2	 invoked sendSMS()      t2çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™
t2	 invoked sendEmail()    t2åœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”
```

### è¯æ˜ReentrantLock

```java
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

/**
 * èµ„æºç±»
 */
class Phone implements Runnable{

    Lock lock = new ReentrantLock();

    /**
     * setè¿›å»çš„æ—¶å€™ï¼Œå°±åŠ é”ï¼Œè°ƒç”¨setæ–¹æ³•çš„æ—¶å€™ï¼Œèƒ½å¦è®¿é—®å¦å¤–ä¸€ä¸ªåŠ é”çš„setæ–¹æ³•
     */
    public void getLock() {
        lock.lock();
        try {
            System.out.println(Thread.currentThread().getName() + "\t get Lock");
            setLock();
        } finally {
            lock.unlock();
        }
    }

    public void setLock() {
        lock.lock();
        try {
            System.out.println(Thread.currentThread().getName() + "\t set Lock");
        } finally {
            lock.unlock();
        }
    }

    @Override
    public void run() {
        getLock();
    }
}

public class ReenterLockDemo {


    public static void main(String[] args) {
        Phone phone = new Phone();

        /**
         * å› ä¸ºPhoneå®ç°äº†Runnableæ¥å£
         */
        Thread t3 = new Thread(phone, "t3");
        Thread t4 = new Thread(phone, "t4");
        t3.start();
        t4.start();
    }
}

```

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ReentrantLockè¿›è¡ŒéªŒè¯ï¼Œé¦–å…ˆèµ„æºç±»å®ç°äº†Runnableæ¥å£ï¼Œé‡å†™Runæ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨getæ–¹æ³•ï¼Œgetæ–¹æ³•åœ¨è¿›å…¥çš„æ—¶å€™ï¼Œå°±åŠ äº†é”

```java
public void getLock() {
  lock.lock();
  try {
    System.out.println(Thread.currentThread().getName() + "\t get Lock");
    setLock();
  } finally {
    lock.unlock();
  }
}
```

ç„¶ååœ¨æ–¹æ³•é‡Œé¢ï¼Œåˆè°ƒç”¨å¦å¤–ä¸€ä¸ªåŠ äº†é”çš„setLockæ–¹æ³•

```java
public void setLock() {
  lock.lock();
  try {
    System.out.println(Thread.currentThread().getName() + "\t set Lock");
  } finally {
    lock.unlock();
  }
}
```

**æœ€åè¾“å‡ºç»“æœæˆ‘ä»¬èƒ½å‘ç°ï¼Œç»“æœå’ŒåŠ synchronizedæ–¹æ³•æ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ˜¯åœ¨å¤–å±‚çš„æ–¹æ³•è·å–é”ä¹‹åï¼Œçº¿ç¨‹èƒ½å¤Ÿç›´æ¥è¿›å…¥é‡Œå±‚**

```java
t3	 get Lock
t3	 set Lock
t4	 get Lock
t4	 set Lock
```

ğŸ¤” **å½“æˆ‘ä»¬åœ¨getLockæ–¹æ³•åŠ ä¸¤æŠŠé”ä¼šæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ**  (é˜¿é‡Œé¢è¯•)

æœ€åå¾—åˆ°çš„ç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºé‡Œé¢ä¸ç®¡æœ‰å‡ æŠŠé”ï¼Œå…¶å®ƒä»–ä»¬éƒ½æ˜¯åŒä¸€æŠŠé”ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨åŒä¸€ä¸ªé’¥åŒ™éƒ½èƒ½å¤Ÿæ‰“å¼€

```java
    public void getLock() {
        lock.lock();
        lock.lock();
        try {
            System.out.println(Thread.currentThread().getName() + "\t get Lock");
            setLock();
        } finally {
            lock.unlock();
            lock.unlock();
        }
    }
```

**å½“æˆ‘ä»¬åœ¨getLockæ–¹æ³•åŠ ä¸¤æŠŠé”ï¼Œä½†æ˜¯åªè§£ä¸€æŠŠé”ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ**

```java
public void getLock() {
    lock.lock();
    lock.lock();
    try {
        System.out.println(Thread.currentThread().getName() + "\t get Lock");
        setLock();
    } finally {
        lock.unlock();
    }
}
```

å¾—åˆ°ç»“æœï¼šä¹Ÿå°±æ˜¯è¯´ç¨‹åºç›´æ¥å¡æ­»ï¼Œçº¿ç¨‹ä¸èƒ½å‡ºæ¥ï¼Œä¹Ÿå°±è¯´æ˜æˆ‘ä»¬ç”³è¯·å‡ æŠŠé”ï¼Œæœ€åéœ€è¦è§£é™¤å‡ æŠŠé”

```java
t3	 get Lock
t3	 set Lock
```

**å½“æˆ‘ä»¬åªåŠ ä¸€æŠŠé”ï¼Œä½†æ˜¯ç”¨ä¸¤æŠŠé”æ¥è§£é”çš„æ—¶å€™ï¼Œåˆä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ**

```java
public void getLock() {
  lock.lock();
  try {
    System.out.println(Thread.currentThread().getName() + "\t get Lock");
    setLock();
  } finally {
    lock.unlock();
    lock.unlock();
  }
}
```

***è¿™ä¸ªæ—¶å€™ï¼Œè¿è¡Œç¨‹åºä¼šç›´æ¥æŠ¥é”™***

```java
t3	 get Lock
t3	 set Lock
t4	 get Lock
t4	 set Lock
Exception in thread "t3" Exception in thread "t4" java.lang.IllegalMonitorStateException
	at java.util.concurrent.locks.ReentrantLock$Sync.tryRelease(ReentrantLock.java:151)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.release(AbstractQueuedSynchronizer.java:1261)
	at java.util.concurrent.locks.ReentrantLock.unlock(ReentrantLock.java:457)
	at com.moxi.interview.study.thread.Phone.getLock(ReenterLockDemo.java:52)
	at com.moxi.interview.study.thread.Phone.run(ReenterLockDemo.java:67)
	at java.lang.Thread.run(Thread.java:745)
java.lang.IllegalMonitorStateException
	at java.util.concurrent.locks.ReentrantLock$Sync.tryRelease(ReentrantLock.java:151)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.release(AbstractQueuedSynchronizer.java:1261)
	at java.util.concurrent.locks.ReentrantLock.unlock(ReentrantLock.java:457)
	at com.moxi.interview.study.thread.Phone.getLock(ReenterLockDemo.java:52)
	at com.moxi.interview.study.thread.Phone.run(ReenterLockDemo.java:67)
	at java.lang.Thread.run(Thread.java:745)
```

### Synchronizedçš„é‡å…¥å®ç°æœºç†

**æ¯ä¸ªé”å¯¹è±¡æ‹¥æœ‰ä¸€ä¸ªé”è®¡æ•°å™¨å’Œä¸€ä¸ªæŒ‡å‘æŒæœ‰è¯¥é”çš„çº¿ç¨‹çš„æŒ‡é’ˆã€‚**

å½“æ‰§è¡Œmonitorenteræ—¶ï¼Œ å¦‚æœç›®æ ‡é”å¯¹è±¡çš„è®¡æ•°å™¨ä¸ºé›¶ï¼Œé‚£ä¹ˆè¯´æ˜å®ƒæ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹æ‰€æŒæœ‰ï¼ŒJavaè™šæ‹Ÿæœºä¼šå°†è¯¥é”å¯¹è±¡çš„æŒæœ‰çº¿ç¨‹è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…¶è®¡æ•°å™¨åŠ 1ã€‚

åœ¨ç›®æ ‡é”å¯¹è±¡çš„è®¡æ•°å™¨ä¸ä¸ºé›¶çš„æƒ…å†µä¸‹ï¼Œå¦‚æœé”å¯¹è±¡çš„æŒæœ‰çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ï¼Œé‚£ä¹ˆJavaè™šæ‹Ÿæœºå¯ä»¥å°†å…¶è®¡æ•°å™¨åŠ 1ï¼Œå¦åˆ™éœ€è¦ç­‰å¾…ç›´è‡³æŒæœ‰çº¿ç¨‹é‡Šæ”¾è¯¥é”ã€‚

å½“æ‰§è¡Œmonitorexitæ—¶ï¼Œ Javaè™›æ‹Ÿæœºåˆ™éœ€å°†é”å¯¹è±¡çš„è®¡æ•°å™¨å‡1ã€‚è®¡æ•°å™¨ä¸ºé›¶ä»£è¡¨é”å·±è¢«é‡Šæ”¾ã€‚



# LockSupport

## æ¦‚è¿°

Javaæä¾›äº†ä¸€ä¸ªè¾ƒä¸ºåº•å±‚çš„å¹¶å‘å·¥å…·ç±»ï¼š**LockSupport**ï¼Œå¯ä»¥è®©çº¿ç¨‹åœæ­¢ä¸‹æ¥(**é˜»å¡**)ï¼Œè¿˜å¯ä»¥å”¤é†’çº¿ç¨‹ã€‚

LockSupportæ˜¯ç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚



## ä¸‰ç§è®©çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’çš„æ–¹æ³•

### ä¼ ç»Ÿçš„synchronizedå’ŒLockå®ç°ç­‰å¾…å”¤é†’é€šçŸ¥çš„çº¦æŸ

1.ä½¿ç”¨Objectä¸­çš„`wait()`æ–¹æ³•è®©çº¿ç¨‹ç­‰å¾…ï¼Œä½¿ç”¨Objectä¸­çš„`notify()`æ–¹æ³•å”¤é†’çº¿ç¨‹

- `wait()`å’Œ`notify()`æ–¹æ³•ä¸å¯ä»¥è„±ç¦»`Synchronized`å†…éƒ¨æ‰§è¡Œ
- å…ˆæ‰§è¡Œnotifyåwaitå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºæ— æ³•æ‰§è¡Œï¼Œæ— æ³•å”¤é†’

2.ä½¿ç”¨JUCåŒ…ä¸­`Condition`çš„`await()`æ–¹æ³•è®©çº¿ç¨‹ç­‰å¾…ï¼Œä½¿ç”¨`signal()`æ–¹æ³•å”¤é†’çº¿ç¨‹

- å’Œç¬¬ 1 ç§æ–¹å¼ä¸€æ ·

- çº¿ç¨‹å…ˆè¦è·å¾—å¹¶æŒæœ‰é”ï¼Œå¿…é¡»åœ¨é”å—(s ynchronizedæˆ–lock)ä¸­
- å¿…é¡»è¦**å…ˆç­‰å¾…åå”¤é†’**ï¼Œçº¿ç¨‹æ‰èƒ½è¢«å”¤é†’

### LockSupportç±»ä¸­çš„parkç­‰å¾…å’Œunparkå”¤é†’

1ï¼‰æ¦‚è¿°

LockSupportæ˜¯ç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚

LockSupportç±»ä½¿ç”¨äº†ä¸€ç§åä¸ºPermit(è®¸å¯ï¼‰çš„æ¦‚å¿µæ¥åšåˆ°**é˜»å¡å’Œå”¤é†’çº¿ç¨‹çš„åŠŸèƒ½**ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè®¸å¯(permit),permitåªæœ‰ä¸¤ä¸ªå€¼1å’Œ0ï¼Œé»˜è®¤æ˜¯é›¶ã€‚

**å¯ä»¥æŠŠè®¸å¯çœ‹æˆæ˜¯ä¸€ç§(0,1)ä¿¡å·é‡(Semaphoreï¼‰ï¼Œä½†ä¸Semaphoreä¸åŒçš„æ˜¯ï¼Œè®¸å¯çš„ç´¯åŠ ä¸Šé™æ˜¯1ã€‚**

2ï¼‰ä¸»è¦æ–¹æ³•

```java
// åº•å±‚å®ç°æ˜¯UNSAFE.park()
// permité»˜è®¤æ˜¯0ï¼Œæ‰€ä»¥ä¸€å¼€å§‹ è°ƒç”¨park()æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šé˜»å¡ï¼Œç›´åˆ°åˆ«çš„çº¿ç¨‹å°†å½“å‰çº¿ç¨‹çš„permitè®¾ç½®ä¸º1æ—¶ï¼Œparkæ–¹æ³•ä¼šè¢«å”¤é†’ï¼Œç„¶åä¼šå°†permitå†æ¬¡è®¾ç½®ä¸º0å¹¶è¿”å›ã€‚
LockSupport.park(Object blocker) 
// åº•å±‚å®ç°æ˜¯UNSAFE.unpark(Thread thread)  
// è°ƒç”¨unpark(thread)æ–¹æ³•åï¼Œå°±ä¼šå°†threadçº¿ç¨‹çš„è®¸å¯permitè®¾ç½®æˆ1ï¼ˆæ³¨æ„å¤šæ¬¡è°ƒç”¨unparkæ–¹æ³•ï¼Œä¸ä¼šç´¯åŠ ï¼Œpermitå€¼è¿˜æ˜¯1ï¼‰ä¼š è‡ªåŠ¨å”¤é†’threadçº¿ç¨‹ï¼Œå³ä¹‹å‰é˜»å¡ä¸­çš„LockSuppot.park()æ–¹æ³•ä¼šç«‹å³è¿”å›ã€‚
LockSupport.unpark(Thread thread)
```

3ï¼‰ä»£ç 

```java
// âš ï¸ ä¹‹å‰é”™è¯¯çš„å…ˆå”¤é†’åç­‰å¾…ï¼ŒLockSupportç…§æ ·æ”¯æŒ
public class LockSupportDemo {
    
    public static void main(String[] args) {
        Thread a = new Thread(() -> {
            try {TimeUnit.SECONDS.sleep(3);} catch (InterruptedException e) {e.printStackTrace();}
            System.out.println(Thread.currentThread().getName()+"\t---come in");
            LockSupport.park(); // è¢«é˜»å¡...ç­‰å¾…é€šçŸ¥ç­‰å¾…æ”¾è¡Œï¼Œä»–è¦é€šè¿‡çš„è¯éœ€è¦è®¸å¯è¯
            System.out.println(Thread.currentThread().getName()+"\t---è¢«å”¤é†’");
        }, "a");
        a.start();
      
        Thread b = new Thread(() -> {
            LockSupport.unpark(a); // ç»™çº¿ç¨‹aå‘æ”¾è®¸å¯è¯
            System.out.println(Thread.currentThread().getName()+"\t---å·²é€šçŸ¥");
        }, "b");
        b.start();
    }
}
```

4ï¼‰é‡ç‚¹è¯´æ˜ ğŸ¤”

1. **LockSupportæ˜¯ç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­**

   LockSupportæ˜¯ä¸€ä¸ªçº¿ç¨‹é˜»å¡å·¥å…·ç±»ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•ï¼Œå¯ä»¥è®©çº¿ç¨‹åœ¨ä»»æ„ä½ç½®é˜»å¡ï¼Œé˜»å¡ä¹‹åä¹Ÿæœ‰å¯¹åº”çš„å”¤é†’æ–¹æ³•ã€‚å½’æ ¹ç»“åº•ï¼Œ**LockSupportè°ƒç”¨çš„Unsafeä¸­çš„nativeä»£ç ã€‚**

2. **LockSupportæä¾›park()å’Œunpark()æ–¹æ³•å®ç°é˜»å¡çº¿ç¨‹å’Œè§£é™¤çº¿ç¨‹é˜»å¡çš„è¿‡ç¨‹**

   LockSupportå’Œæ¯ä¸ªä½¿ç”¨å®ƒçš„çº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè®¸å¯(permit)å…³è”ã€‚permitç›¸å½“äº1ï¼Œ0çš„å¼€å…³ï¼Œé»˜è®¤æ˜¯0ï¼Œè°ƒç”¨ä¸€æ¬¡unparkå°±åŠ 1å˜æˆ1ï¼Œè°ƒç”¨ä¸€æ¬¡parkä¼šæ¶ˆè´¹permitï¼Œä¹Ÿå°±æ˜¯å°†1å˜æˆ0ï¼ŒåŒæ—¶parkç«‹å³è¿”å›ã€‚

   å¦‚å†æ¬¡è°ƒç”¨parkä¼šå˜æˆé˜»å¡(å› ä¸ºpermitä¸ºé›¶äº†ä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œä¸€ç›´åˆ°permitå˜ä¸º1)ï¼Œè¿™æ—¶è°ƒç”¨unparkä¼šæŠŠpermitç½®ä¸º1ã€‚

   **æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„permit, permitæœ€å¤šåªæœ‰ä¸€ä¸ªï¼Œé‡å¤è°ƒç”¨unparkä¹Ÿä¸ä¼šç§¯ç´¯å‡­è¯ã€‚** 

3. **å½¢è±¡çš„ç†è§£**

   çº¿ç¨‹é˜»å¡éœ€è¦æ¶ˆè€—å‡­è¯(permit)ï¼Œ**è¿™ä¸ªå‡­è¯æœ€å¤šåªæœ‰1ä¸ªã€‚**

   å½“è°ƒç”¨parkæ–¹æ³•æ—¶ï¼š

   - å¦‚æœæœ‰å‡­è¯ï¼Œåˆ™ä¼šç›´æ¥æ¶ˆè€—æ‰è¿™ä¸ªå‡­è¯ç„¶åæ­£å¸¸é€€å‡º;
   - å¦‚æœæ— å‡­è¯ï¼Œå°±å¿…é¡»é˜»å¡ç­‰å¾…å‡­è¯å¯ç”¨;

   è€Œunparkåˆ™ç›¸åï¼Œå®ƒä¼šå¢åŠ ä¸€ä¸ªå‡­è¯ï¼Œä½†å‡­è¯æœ€å¤šåªèƒ½æœ‰1ä¸ªï¼Œç´¯åŠ æ— æ•ˆã€‚

5ï¼‰é¢è¯•é¢˜

**ä¸ºä»€ä¹ˆå¯ä»¥å…ˆå”¤é†’çº¿ç¨‹åé˜»å¡çº¿ç¨‹?**

ANSWERï¼šå› ä¸ºunparkè·å¾—äº†ä¸€ä¸ªå‡­è¯ï¼Œä¹‹åå†è°ƒç”¨parkæ–¹æ³•ï¼Œå°±å¯ä»¥åæ­£è¨€é¡ºçš„å‡­è¯æ¶ˆè´¹ï¼Œæ•…ä¸ä¼šé˜»å¡ã€‚

**ä¸ºä»€ä¹ˆå”¤é†’ä¸¤æ¬¡åé˜»å¡ä¸¤æ¬¡ï¼Œä½†æœ€ç»ˆç»“æœè¿˜ä¼šé˜»å¡çº¿ç¨‹?**

ANSWERï¼šå› ä¸ºå‡­è¯çš„æ•°é‡æœ€å¤šä¸º1ï¼Œè¿ç»­è°ƒç”¨ä¸¤æ¬¡unparkå’Œè°ƒç”¨ä¸€æ¬¡unparkæ•ˆæœä¸€æ ·ï¼Œåªä¼šå¢åŠ ä¸€ä¸ªå‡­è¯;è€Œè°ƒç”¨ä¸¤æ¬¡parkå´éœ€è¦æ¶ˆè´¹ä¸¤ä¸ªå‡­è¯ï¼Œè¯ä¸å¤Ÿï¼Œä¸èƒ½æ”¾è¡Œã€‚



## LockSupportå®ç°è‡ªæ—‹é”

```java
public class SpinLock {
    // é”çŠ¶æ€
    volatile int status=0;
    // é˜»å¡çº¿ç¨‹é˜Ÿåˆ—
    Queue<Thread> parkQueue = new LinkedBlockingQueue<>();

    public void mylock() {
        // è‡ªæ—‹è·å–é”
        while (!compareAndSet(0,1)) { // æ¯”è¾ƒäº¤æ¢åŸå­æ“ä½œï¼šå½“å‰ä¸º0åˆ™ä¸1äº¤æ¢ï¼›å½“å‰ä¸º1åˆ™äº¤æ¢å¤±è´¥
            park();
        }
      lock()
      // ä¸šåŠ¡ä»£ç    
      ...
      // è§£é”
      unlock()
    }

    public void myUnlock() {
        // CASè§£é”
        status = 0;
        lock_notify();
    }
    
    public void park() {
      	// æŠŠå½“å‰çº¿ç¨‹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—
        parkQueue.add(Thread.currentThread());
        // å°†å½“å‰çº¿ç¨‹é‡Šæ”¾CPU é˜»å¡
        LockSupport.park(Thread.currentThread());
    }
    
    public void lock_notify() {
        // å¾—åˆ°è¦å”¤é†’çš„çº¿ç¨‹ å¤´éƒ¨çº¿ç¨‹
      	Thread t = parkQueue.header();
      	// å”¤é†’ç­‰å¾…çº¿ç¨‹
      	unpack(t);
    }
}
```



# AbstractQueuedSynchronizerä¹‹AQS

> [ä»ReentrantLockçš„å®ç°çœ‹AQSçš„åŸç†](http://www.silince.cn/2020/09/03/ä»ReentrantLockçš„å®ç°çœ‹AQSçš„åŸç†/)

AbstractQueuedSynchronizeræ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶å®ƒåŒæ­¥å™¨ç»„ä»¶çš„**é‡é‡çº§åŸºç¡€æ¡†æ¶åŠæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³**ï¼Œ é€šè¿‡å†…ç½®çš„**FIFOé˜Ÿ**åˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡**ä¸€ä¸ªintç±»å˜é‡è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€**

![image-20201230221813687](/assets/imgs/image-20201230221813687.png)

CLH: Craigã€Landin and Hagerstené˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œ**AQSä¸­çš„é˜Ÿåˆ—æ˜¯CLHå˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—FIFO**ã€‚

## AQSä¸ºä»€ä¹ˆæ˜¯JUCå†…å®¹ä¸­æœ€é‡è¦çš„åŸºçŸ³

å’ŒAQSæœ‰å…³çš„ç±»ï¼š

- ReentrantLock
- CountDownLatch
- ReentrantReadWriteLock
- Semaphore

è¿›ä¸€æ­¥ç†è§£é”å’ŒåŒæ­¥å™¨çš„å…³ç³»ï¼š

- é”ï¼Œé¢å‘é”çš„**ä½¿ç”¨è€…**ï¼šå®šä¹‰äº†ç¨‹åºå‘˜å’Œé”äº¤äº’çš„ä½¿ç”¨å±‚APIï¼Œéšè—äº†å®ç°ç»†èŠ‚ï¼Œä½ è°ƒç”¨å³å¯ã€‚
- åŒæ­¥å™¨ï¼Œé¢å‘é”çš„**å®ç°è€…**ï¼šæ¯”å¦‚Javaå¹¶å‘å¤§ç¥Dougleeï¼Œæå‡ºç»Ÿä¸€è§„èŒƒå¹¶ç®€åŒ–äº†é”çš„å®ç°ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€é˜»å¡çº¿ç¨‹æ’é˜Ÿå’Œé€šçŸ¥ã€å”¤é†’æœºåˆ¶ç­‰ã€‚

## èƒ½å¹²å˜›

**åŠ é”ä¼šå¯¼è‡´é˜»å¡ï¼šæœ‰é˜»å¡å°±éœ€è¦æ’é˜Ÿï¼Œå®ç°æ’é˜Ÿå¿…ç„¶éœ€è¦æœ‰æŸç§å½¢å¼çš„é˜Ÿåˆ—æ¥è¿›è¡Œç®¡ç†**

æŠ¢åˆ°èµ„æºçš„çº¿ç¨‹ç›´æ¥ä½¿ç”¨åŠç†ä¸šåŠ¡ï¼ŒæŠ¢å ä¸åˆ°èµ„æºçš„çº¿ç¨‹çš„å¿…ç„¶æ¶‰åŠä¸€ç§**æ’é˜Ÿç­‰å€™æœºåˆ¶**ï¼ŒæŠ¢å èµ„æºå¤±è´¥çš„çº¿ç¨‹ç»§ç»­å»ç­‰å¾…(ç±»ä¼¼åŠç†çª—å£éƒ½æ»¡äº†ï¼Œæš‚æ—¶æ²¡æœ‰å—ç†çª—å£çš„é¡¾å®¢åªèƒ½å»**å€™å®¢åŒºæ’é˜Ÿç­‰å€™**)ï¼Œä»ç„¶ä¿ç•™è·å–é”çš„å¯èƒ½ä¸”è·å–é”æµç¨‹ä»åœ¨ç»§ç»­(å€™å®¢åŒºçš„é¡¾å®¢ä¹Ÿåœ¨ç­‰ç€å«å·ï¼Œè½®åˆ°äº†å†å»å—ç†çª—å£åŠç†ä¸šåŠ¡ï¼‰ã€‚

æ—¢ç„¶è¯´åˆ°äº†**æ’é˜Ÿç­‰å€™æœºåˆ¶**ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢? 

å¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œ**å°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…**ã€‚è¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯CLHé˜Ÿåˆ—çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯AQSçš„æŠ½è±¡è¡¨ç°ã€‚å®ƒå°†è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆé˜Ÿåˆ—çš„ç»“ç‚¹(**Node**) ï¼Œé€šè¿‡CASã€è‡ªæ—‹ä»¥åŠ`LockSuport.park()`çš„æ–¹å¼ï¼Œç»´æŠ¤stateå˜é‡çš„çŠ¶æ€ï¼Œä½¿å¹¶å‘è¾¾åˆ°åŒæ­¥çš„æ•ˆæœã€‚

## AQSåˆæ­¥

### å®˜ç½‘è§£é‡Š

![image-20210101221640837](/assets/imgs/image-20210101221640837.png)

æœ‰é˜»å¡å°±éœ€è¦æ’é˜Ÿï¼Œå®ç°æ’é˜Ÿå¿…ç„¶éœ€è¦é˜Ÿåˆ—ã€‚

AQSä½¿ç”¨ä¸€ä¸ªvolatileçš„intç±»å‹çš„æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„ FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çš„æ’é˜Ÿå·¥ä½œå°†æ¯æ¡è¦å»æŠ¢å èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªNodeèŠ‚ç‚¹æ¥å®ç°é”çš„åˆ†é…ï¼Œé€šè¿‡CASå®Œæˆå¯¹Stateå€¼çš„ä¿®æ”¹ã€‚

![image-20210101221859513](/assets/imgs/image-20210101221859513.png)



### AQSå†…éƒ¨ä½“ç³»æ¶æ„

![image-20210101222408408](/assets/imgs/image-20210101222408408.png)

AQSè‡ªèº«ï¼š

1ï¼‰AQSçš„intå˜é‡

- AQSçš„åŒæ­¥çŠ¶æ€Stateæˆå‘˜å˜é‡
- ç±»ä¼¼äºé“¶è¡ŒåŠç†ä¸šåŠ¡çš„å—ç†çª—å£çŠ¶æ€ï¼š
  - é›¶å°±æ˜¯æ²¡äººï¼Œè‡ªç”±çŠ¶æ€å¯ä»¥åŠç†
  - å¤§äºç­‰äº1ï¼Œæœ‰äººå ç”¨çª—å£ï¼Œéœ€è¦ç­‰å¾… 

2ï¼‰AQSçš„CLHé˜Ÿåˆ—

- CLHé˜Ÿåˆ—ï¼ˆä¸‰ä¸ªå¤§ç‰›çš„åå­—ç»„æˆï¼‰ï¼Œä¸ºä¸€ä¸ªåŒå‘é˜Ÿåˆ—
- ç±»ä¼¼äºé“¶è¡Œä¾¯å®¢åŒºçš„ç­‰å¾…é¡¾å®¢

![image-20210101222806940](/assets/imgs/image-20210101222806940.png)

3ï¼‰å°æ€»ç»“

- **æœ‰é˜»å¡å°±éœ€è¦æ’é˜Ÿï¼Œå®ç°æ’é˜Ÿå¿…ç„¶éœ€è¦é˜Ÿåˆ—**
- **AQSå°±å¯ä»¥çœ‹ä½œæ˜¯ï¼šstateå˜é‡+CLHåŒç«¯Nodeé˜Ÿåˆ—**

å†…éƒ¨ç±»Nodeï¼ˆNodeç±»åœ¨AQSç±»å†…éƒ¨ï¼‰ï¼š

1ï¼‰Nodeçš„intå˜é‡

- Nodeçš„ç­‰å¾…çŠ¶æ€waitStateæˆå‘˜å˜é‡
- è¯´äººè¯
  - ç­‰å€™åŒºå…¶å®ƒé¡¾å®¢(å…¶å®ƒçº¿ç¨‹)çš„ç­‰å¾…çŠ¶æ€
  - é˜Ÿåˆ—ä¸­æ¯ä¸ªæ’é˜Ÿçš„ä¸ªä½“å°±æ˜¯ä¸€ä¸ªNode.

2ï¼‰Nodeæ­¤ç±»çš„è®²è§£

- å†…éƒ¨ç»“æ„

![image-20210101223510639](/assets/imgs/image-20210101223510639.png)

- å±æ€§è¯´æ˜

![image-20210101223236203](/assets/imgs/image-20210101223236203.png)

![image-20210101223312149](/assets/imgs/image-20210101223312149.png)

## AQSåŒæ­¥é˜Ÿåˆ—çš„åŸºæœ¬ç»“æ„

![image-20210101223349077](/assets/imgs/image-20210101223349077.png)

# ä»ReentrantLockå¼€å§‹è§£è¯»AQS

Lockæ¥å£çš„å®ç°ç±»ï¼ŒåŸºæœ¬éƒ½æ˜¯é€šè¿‡ã€èšåˆã€‘äº†ä¸€ä¸ªã€é˜Ÿåˆ—åŒæ­¥å™¨ã€‘çš„å­ç±»å®Œæˆçº¿ç¨‹è®¿é—®æ§åˆ¶çš„ã€‚

## 1ï¼‰ReentrantLockåŸç†

![image-20210102202308862](/assets/imgs/image-20210102202308862.png)

## 2ï¼‰ä»æœ€ç®€å•çš„lockæ–¹æ³•å¼€å§‹çœ‹çœ‹å…¬å¹³å’Œéå…¬å¹³

é€šè¿‡ReentrantLockçš„æºç æ¥è®²è§£å…¬å¹³é”å’Œéå…¬å¹³é”  

å¯ä»¥æ˜æ˜¾çœ‹å‡ºå…¬å¹³é”ä¸éå…¬å¹³é”çš„`lock()`æ–¹æ³•å”¯ä¸€çš„åŒºåˆ«å°±åœ¨äºå…¬å¹³é”åœ¨è·å–åŒæ­¥çŠ¶æ€æ—¶å¤šäº†ä¸€ä¸ªé™åˆ¶æ¡ä»¶:

- `hasQueuedPredecessors()` æ˜¯å…¬å¹³é”åŠ é”æ—¶åˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨æœ‰æ•ˆèŠ‚ç‚¹çš„æ–¹æ³•

![image-20210102202516446](/assets/imgs/image-20210102202516446.png)

## 3ï¼‰éå…¬å¹³é”èµ°èµ·ï¼Œæ–¹æ³•`lock()`

å¯¹æ¯”å…¬å¹³é”å’Œéå…¬å¹³é”çš„tryAcquire()æ–¹æ³•çš„å®ç°ä»£ç ï¼Œå…¶å®å·®åˆ«å°±åœ¨äº**éå…¬å¹³é”è·å–é”æ—¶æ¯”å…¬å¹³é”ä¸­å°‘äº†ä¸€ä¸ªåˆ¤æ–­`ï¼hasQueuedPredecessors()`**

`hasQueuedPredecessors()`ä¸­åˆ¤æ–­äº†æ˜¯å¦éœ€è¦æ’é˜Ÿï¼Œå¯¼è‡´å…¬å¹³é”å’Œéå…¬å¹³é”çš„å·®å¼‚å¦‚ä¸‹:

- **å…¬å¹³é”**:å…¬å¹³é”è®²ç©¶å…ˆæ¥å…ˆåˆ°ï¼Œçº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœè¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼›
- **éå…¬å¹³é”**:ä¸ç®¡æ˜¯å¦æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœå¯ä»¥è·å–é”ï¼Œåˆ™ç«‹åˆ»å æœ‰é”å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´é˜Ÿåˆ—çš„ç¬¬ä¸€ ä¸ªæ’é˜Ÿçº¿ç¨‹åœ¨`unpark()`ï¼Œä¹‹åè¿˜æ˜¯éœ€è¦ç«äº‰é”ï¼ˆå­˜åœ¨çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼‰

![image-20210102212048083](/assets/imgs/image-20210102212048083-1057561.png)

![image-20210102212226208](/assets/imgs/image-20210102212226208.png)

## 4ï¼‰AQSæºç æ·±åº¦åˆ†æèµ°èµ·

### ä¸šåŠ¡é€»è¾‘

æœ¬æ¬¡è®²è§£æˆ‘ä»¬èµ°æœ€å¸¸ç”¨çš„ï¼Œlock/unlockä½œä¸ºæ¡ˆä¾‹çªç ´å£

æˆ‘ç›¸ä¿¡ä½ åº”è¯¥çœ‹è¿‡æºç äº†ï¼Œé‚£ä¹ˆAQSé‡Œé¢æœ‰ä¸ªå˜é‡å«Stateï¼Œå®ƒçš„å€¼æœ‰å‡ ç§ï¼Ÿ3ä¸ªçŠ¶æ€ï¼šæ²¡å ç”¨æ˜¯0ï¼Œå ç”¨äº†æ˜¯1ï¼Œå¤§äº1æ˜¯å¯é‡å…¥é”ã€‚

å¦‚æœABä¸¤ä¸ªçº¿ç¨‹è¿›æ¥äº†ä»¥åï¼Œè¯·é—®è¿™ä¸ªæ€»å…±æœ‰å¤šå°‘ä¸ªNodeèŠ‚ç‚¹ï¼Ÿç­”æ¡ˆæ˜¯3ä¸ª,å…¶ä¸­é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ˜¯å‚€å„¡èŠ‚ç‚¹(å“¨å…µèŠ‚ç‚¹)

ä¸šåŠ¡å›¾ï¼š

![image-20210102220540651](/assets/imgs/image-20210102220540651.png)

ä»£ç :

```java
public class AQSDemo {
    public static void main(String[] args) {
        ReentrantLock lock=new ReentrantLock();
        // å¸¦å…¥ä¸€ä¸ªé“¶è¡ŒåŠç†ä¸šåŠ¡çš„æ¡ˆä¾‹æ¥æ¨¡æ‹ŸAQSå¦‚ä½•è¿›è¡Œçº¿ç¨‹çš„ç®¡ç†å’Œé€šçŸ¥å”¤é†’æœºåˆ¶
        // 3ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿ3ä¸ªé“¶è¡Œç½‘ç‚¹ï¼Œå—ç†çª—å£åŠç†ä¸šåŠ¡çš„é¡¾å®¢

        // Aé¡¾å®¢å°±æ˜¯ç¬¬ä¸€ä¸ªé¡¾å®¢ï¼Œæ­¤æ—¶å—ç†çª—å£çš„æ²¡æœ‰ä»»ä½•äººï¼ŒAå¯ä»¥ç›´æ¥å»åŠç†
        new Thread(() -> {
            // method
            lock.lock();
            try {
                System.out.println("---Thread A come in---");
                try {
                    TimeUnit.MINUTES.sleep(20);} catch (InterruptedException e) {e.printStackTrace();}
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                lock.unlock();
            }
        }, "A").start();

        // ç¬¬äºŒä¸ªé¡¾å®¢Bï¼Œç¬¬äºŒä¸ªçº¿ç¨‹---> ç”±äºå—ç†ä¸šåŠ¡çš„çª—å£åªæœ‰ä¸€ä¸ª(åªèƒ½ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”)ï¼Œæ­¤æ—¶Båªèƒ½ç­‰å¾…
        // è¿›å…¥å€™å®¢åŒº
        new Thread(() -> {
            // method
            lock.lock();
            try {
                System.out.println("---Thread B come in---");
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                lock.unlock();
            }
        }, "B").start();

        // ç¬¬äºŒä¸ªé¡¾å®¢Cï¼Œç¬¬äºŒä¸ªçº¿ç¨‹---> ç”±äºå—ç†ä¸šåŠ¡çš„çª—å£åªæœ‰ä¸€ä¸ª(åªèƒ½ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”)ï¼Œæ­¤æ—¶Cåªèƒ½ç­‰å¾…
        // è¿›å…¥å€™å®¢åŒº
        new Thread(() -> {
            // method
            lock.lock();
            try {
                System.out.println("---Thread C come in---");
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                lock.unlock();
            }
        }, "C").start();
    }
}
```



### lock()æ–¹æ³•

![image-20210102214153923](/assets/imgs/image-20210102214153923.png)

### acquire()æ–¹æ³•

æºç å’Œ3å¤§æµç¨‹èµ°å‘ï¼š

![image-20210102220848619](/assets/imgs/image-20210102220848619.png)

![image-20210102221123211](/assets/imgs/image-20210102221123211.png)

#### tryAcquire(arg)

æœ¬æ¬¡èµ°éå…¬å¹³é”æ–¹å‘

![image-20210102221247406](/assets/imgs/image-20210102221247406.png)

**nonfairTryAcquire(acquires)ï¼š**

- return false(ç»§ç»­æ¨è¿›æ¡ä»¶ï¼Œèµ°ä¸‹ä¸€æ­¥æ–¹æ³•addWaiter)
- return true(ç»“æŸ)

![image-20210102221350257](/assets/imgs/image-20210102221350257.png)

---

#### addWaiter(Node mode)

åŒå‘é“¾è¡¨ä¸­ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºè™šèŠ‚ç‚¹(ä¹Ÿå«å“¨å…µèŠ‚ç‚¹)ï¼Œå…¶å®å¹¶ä¸å­˜å‚¨ä»»ä½•ä¿¡æ¯ï¼Œåªæ˜¯å ä½ã€‚ çœŸæ­£çš„ç¬¬ä¸€ä¸ªæœ‰æ•°æ®çš„èŠ‚ç‚¹ï¼Œæ˜¯ä»ç¬¬äºŒä¸ªèŠ‚ç‚¹å¼€å§‹çš„ã€‚

![image-20210102221632665](/assets/imgs/image-20210102221632665.png)

**enq(node)ï¼š**

![image-20210102221722321](/assets/imgs/image-20210102221722321.png)

Bã€Cçº¿ç¨‹éƒ½æ’å¥½é˜Ÿäº†æ•ˆæœå›¾å¦‚ä¸‹ï¼š

![image-20210102220540651](/assets/imgs/image-2021010s2220540651.png)

---

#### acquireQueued(addWaiter(Node.EXCLUSIVE), arg)

1ï¼‰acquireQueued()

(ä¼šè°ƒç”¨å¦‚ä¸‹æ–¹æ³•ï¼šshouldParkAterFailedAcquireå’ŒparkAndCheckInterrupt | setHead(node) )

2ï¼‰shouldParkAfterFailedAcquire()

å¦‚æœå‰é©±èŠ‚ç‚¹çš„waitStatusæ˜¯SIGNALçŠ¶æ€ï¼Œå³shouldParkAfterFailedAcquireæ–¹æ³•ä¼šè¿”å›trueç¨‹åºä¼šç»§ç»­å‘ä¸‹æ‰§è¡ŒparkAndCheckInterruptæ–¹æ³•ï¼Œç”¨äºå°†å½“å‰çº¿ç¨‹æŒ‚èµ·

![image-20210102222624234](/assets/imgs/image-20210102222624234.png)

3ï¼‰parkAndCheckInterrupt()

![image-20210102222638535](/assets/imgs/image-20210102222638535.png)

4ï¼‰å½“æˆ‘ä»¬æ‰§è¡Œä¸‹å›¾ä¸­çš„â‘¢è¡¨ç¤ºçº¿ç¨‹Bæˆ–è€…Cå·²ç»è·å–äº†permit(è®¸å¯è¯)äº†

![image-20210102222658869](/assets/imgs/image-20210102222658869.png)

5ï¼‰setHead( )

ä»£ç æ‰§è¡Œå®Œæ¯•å,ä¼šå‡ºç°å¦‚ä¸‹å›¾æ‰€ç¤º

![image-20210102222721269](/assets/imgs/image-20210102222721269.png)

![image-20210102222742038](/assets/imgs/image-20210102222742038.png)

### unlock( )è·å–permit

1ï¼‰release | tryRelease | unparkSuccessor(h)

![image-20210102224107432](/assets/imgs/image-20210102224107432.png)

2ï¼‰tryRelease()

![image-20210102224115659](/assets/imgs/image-20210102224115659.png)

3ï¼‰unparkSuccessor( )

![image-20210102224128752](/assets/imgs/image-20210102224128752.png)

## æºç æ€»ç»“

![AQSæµç¨‹å›¾](/assets/imgs/AQSæµç¨‹å›¾-9728031.png)





# AQSçš„è€ƒç‚¹

æˆ‘ç›¸ä¿¡ä½ åº”è¯¥çœ‹è¿‡æºç äº†ï¼Œé‚£ä¹ˆAQSé‡Œé¢æœ‰ä¸ªå˜é‡å«Stateï¼Œå®ƒçš„å€¼æœ‰å‡ ç§ï¼Ÿ

ANSWERï¼š3ä¸ªçŠ¶æ€ï¼šæ²¡å ç”¨æ˜¯0ï¼Œå ç”¨äº†æ˜¯1ï¼Œå¤§äº1æ˜¯å¯é‡å…¥é”

å¦‚æœABä¸¤ä¸ªçº¿ç¨‹è¿›æ¥äº†ä»¥åï¼Œè¯·é—®è¿™ä¸ªæ€»å…±æœ‰å¤šå°‘ä¸ªNodeèŠ‚ç‚¹ï¼Ÿ

ANSWERï¼š3ä¸ª