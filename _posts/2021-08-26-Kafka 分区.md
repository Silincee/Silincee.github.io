---
layout: post
title: "Kafka åˆ†åŒº"
date: 2021-08-26 11:23:16 +0800--
categories: [Java, ]
tags: [æ¶ˆæ¯é˜Ÿåˆ—, Kafka,]  

---

# Eventsã€Streamsã€Topics

åœ¨æ·±å…¥ Partition ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹å‡ ä¸ªæ›´é«˜å±‚æ¬¡çš„æ¦‚å¿µï¼Œä»¥åŠå®ƒä»¬ä¸ Partition çš„è”ç³»ã€‚

Eventï¼ˆäº‹ä»¶ï¼‰ä»£è¡¨è¿‡å»å‘ç”Ÿçš„ä¸€ä¸ªäº‹å®ã€‚ç®€å•ç†è§£å°±æ˜¯ä¸€æ¡æ¶ˆæ¯ã€ä¸€æ¡è®°å½•ã€‚å¦å¤–Event æ˜¯ä¸å¯å˜çš„ï¼Œä½†æ˜¯å¾ˆæ´»è·ƒï¼Œç»å¸¸ä»ä¸€ä¸ªåœ°æ–¹æµå‘å¦ä¸€ä¸ªåœ°æ–¹ã€‚

Stream äº‹ä»¶æµè¡¨ç¤ºè¿åŠ¨ä¸­çš„ç›¸å…³äº‹ä»¶ã€‚å½“ä¸€ä¸ªäº‹ä»¶æµè¿›å…¥ Kafka ä¹‹åï¼Œå®ƒå°±æˆä¸ºäº†ä¸€ä¸ª Topic ä¸»é¢˜ã€‚

æ‰€ä»¥ï¼ŒTopic å°±æ˜¯å…·ä½“çš„äº‹ä»¶æµï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ä¸ª Topic å°±æ˜¯ä¸€ä¸ªé™æ­¢çš„ Stream(Topic æŠŠç›¸å…³çš„ Event ç»„ç»‡åœ¨ä¸€èµ·ï¼Œå¹¶ä¸”ä¿å­˜).

![image-20210826152814678](/assets/imgs/image-20210826152814678.png)

# Partition 

Partitionï¼ˆåˆ†åŒºï¼‰æ˜¯ Kafka çš„æ ¸å¿ƒè§’è‰²ï¼Œå¯¹äº Kafka çš„å­˜å‚¨ç»“æ„ã€æ¶ˆæ¯çš„ç”Ÿäº§æ¶ˆè´¹æ–¹å¼éƒ½è‡³å…³é‡è¦ã€‚

- Kafka ä¸­ Topic è¢«åˆ†æˆå¤šä¸ª Partition åˆ†åŒºã€‚

- Topic æ˜¯ä¸€ä¸ª**é€»è¾‘æ¦‚å¿µ**ï¼ŒPartition æ˜¯æœ€å°çš„**å­˜å‚¨å•å…ƒ**ï¼ŒæŒæ¡ç€ä¸€ä¸ª Topic çš„éƒ¨åˆ†æ•°æ®ã€‚

- **æ¯ä¸ª Partition éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„ log æ–‡ä»¶ï¼Œæ¯æ¡è®°å½•éƒ½ä»¥è¿½åŠ çš„å½¢å¼å†™å…¥ã€‚**

![image-20210826153532442](/assets/imgs/image-20210826153532442.png)



## åç§»é‡å’Œæ¶ˆæ¯çš„é¡ºåº

Partition ä¸­çš„æ¯æ¡è®°å½•éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„åºå·ï¼Œç§°ä¸º **Offset**ï¼ˆåç§»é‡ï¼‰ã€‚

Offset æ˜¯ä¸€ä¸ªé€’å¢çš„ã€ä¸å¯å˜çš„æ•°å­—ï¼Œç”± Kafka è‡ªåŠ¨ç»´æŠ¤ã€‚

å½“ä¸€æ¡è®°å½•å†™å…¥ Partition çš„æ—¶å€™ï¼Œå®ƒå°±è¢«è¿½åŠ åˆ° log æ–‡ä»¶çš„æœ«å°¾ï¼Œå¹¶è¢«åˆ†é…ä¸€ä¸ªåºå·ï¼Œä½œä¸º Offsetã€‚

![image-20210826153702490](/assets/imgs/image-20210826153702490.png)

å¦‚ä¸Šå›¾ï¼Œè¿™ä¸ª Topic æœ‰ 3 ä¸ª Partition åˆ†åŒºï¼Œå‘ Topic å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯è¢«å†™å…¥æŸä¸€ä¸ª Partitionï¼Œå¹¶èµ‹äºˆ Offsetã€‚

æ¶ˆæ¯çš„é¡ºåºæ€§éœ€è¦æ³¨æ„ï¼Œä¸€ä¸ª Topic å¦‚æœæœ‰å¤šä¸ª Partition çš„è¯ï¼Œé‚£ä¹ˆä» Topic è¿™ä¸ªå±‚é¢æ¥çœ‹ï¼Œæ¶ˆæ¯æ˜¯æ— åºçš„ã€‚

ä½†å•ç‹¬çœ‹ Partition çš„è¯ï¼ŒPartition å†…éƒ¨æ¶ˆæ¯æ˜¯æœ‰åºçš„ã€‚

**ğŸ¤” æ‰€ä»¥ï¼Œä¸€ä¸ª Partition å†…éƒ¨æ¶ˆæ¯æœ‰åºï¼Œä¸€ä¸ª Topic è·¨ Partition æ˜¯æ— åºçš„ã€‚å¦‚æœå¼ºåˆ¶è¦æ±‚ Topic æ•´ä½“æœ‰åºï¼Œå°±åªèƒ½è®© Topic åªæœ‰ä¸€ä¸ª Partitionã€‚**



## åˆ†åŒºçš„ä¼˜åŠ¿

> Partition ä¸º Kafka æä¾›äº†æ‰©å±•èƒ½åŠ›

ä¸€ä¸ª Kafka é›†ç¾¤ç”±å¤šä¸ª Brokerï¼ˆå°±æ˜¯ Serverï¼‰ æ„æˆï¼Œæ¯ä¸ª Broker ä¸­å«æœ‰é›†ç¾¤çš„éƒ¨åˆ†æ•°æ®ã€‚Kafka æŠŠ Topic çš„å¤šä¸ª Partition åˆ†å¸ƒåœ¨å¤šä¸ª Broker ä¸­ã€‚è¿™æ ·ä¼šæœ‰å¤šç§å¥½å¤„ï¼š

- **æŠŠ Partition åˆ†æ•£å¼€ä¹‹åï¼ŒTopic å°±å¯ä»¥æ°´å¹³æ‰©å±• ã€‚**å¦‚æœæŠŠ Topic çš„æ‰€æœ‰ Partition éƒ½æ”¾åœ¨ä¸€ä¸ª Broker ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ª Topic çš„å¯æ‰©å±•æ€§å°±å¤§å¤§é™ä½äº†ï¼Œä¼šå—é™äºè¿™ä¸ª Broker çš„ IO èƒ½åŠ›ã€‚
- **ä¸€ä¸ª Topic å¯ä»¥è¢«å¤šä¸ª Consumer å¹¶è¡Œæ¶ˆè´¹ã€‚**å¦‚æœ Topic çš„æ‰€æœ‰ Partition éƒ½åœ¨ä¸€ä¸ª Brokerï¼Œé‚£ä¹ˆæ”¯æŒçš„ Consumer æ•°é‡å°±æœ‰é™ï¼Œè€Œåˆ†æ•£ä¹‹åï¼Œå¯ä»¥æ”¯æŒæ›´å¤šçš„ Consumerã€‚
- ä¸€ä¸ª Consumer å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ï¼ŒPartition åˆ†å¸ƒåœ¨å¤šä¸ª Broker çš„è¯ï¼ŒConsumer çš„å¤šä¸ªå®ä¾‹å°±å¯ä»¥è¿æ¥ä¸åŒçš„ Brokerï¼Œå¤§å¤§æå‡äº†æ¶ˆæ¯å¤„ç†èƒ½åŠ›ã€‚å¯ä»¥è®©ä¸€ä¸ª Consumer å®ä¾‹è´Ÿè´£ä¸€ä¸ª Partitionï¼Œè¿™æ ·æ¶ˆæ¯å¤„ç†æ—¢æ¸…æ™°åˆé«˜æ•ˆã€‚

![image-20210826155454065](/assets/imgs/image-20210826155454065.png)

> Partition ä¸º Kafka æä¾›äº†æ•°æ®å†—ä½™

- Kafka ä¸ºä¸€ä¸ª Partition ç”Ÿæˆå¤šä¸ªå‰¯æœ¬(Replication)ï¼Œå¹¶ä¸”æŠŠå®ƒä»¬åˆ†æ•£åœ¨ä¸åŒçš„ Brokerã€‚
- å¦‚æœä¸€ä¸ª Broker æ•…éšœäº†ï¼ŒConsumer å¯ä»¥åœ¨å…¶ä»– Broker ä¸Šæ‰¾åˆ° Partition çš„å‰¯æœ¬ï¼Œç»§ç»­è·å–æ¶ˆæ¯ã€‚



## Partition çš„å†™å…¥æ–¹å¼

> 1ã€ä½¿ç”¨ Partition Key å†™å…¥ç‰¹å®š Partition

Producer å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ª **Partition Key**ï¼Œè¿™æ ·å°±å¯ä»¥å†™å…¥ç‰¹å®š Partition äº†ã€‚

- Partition Key å¯ä»¥ä½¿ç”¨ä»»æ„å€¼ï¼Œä¾‹å¦‚è®¾å¤‡IDã€User IDã€‚
- Partition Key ä¼šä¼ é€’ç»™ä¸€ä¸ª Hash å‡½æ•°ï¼Œç”±è®¡ç®—ç»“æœå†³å®šå†™å…¥å“ªä¸ª Partitionã€‚
- å› æ­¤æœ‰ç›¸åŒ **Partition Key** çš„æ¶ˆæ¯ï¼Œä¼šè¢«æ”¾åˆ°ç›¸åŒçš„ Partitionã€‚

ä¾‹å¦‚ä½¿ç”¨ User ID ä½œä¸º Partition Keyï¼Œé‚£ä¹ˆæ­¤ ID çš„æ¶ˆæ¯å°±éƒ½åœ¨åŒä¸€ä¸ª Partitionï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ­¤ç±»æ¶ˆæ¯çš„æœ‰åºæ€§ã€‚

è¿™ç§æ–¹å¼éœ€è¦æ³¨æ„ Partition çƒ­ç‚¹é—®é¢˜ã€‚

ä¾‹å¦‚ä½¿ç”¨ User ID ä½œä¸º Partition Keyï¼Œå¦‚æœæŸä¸€ä¸ª User äº§ç”Ÿçš„æ¶ˆæ¯ç‰¹åˆ«å¤šï¼Œæ˜¯ä¸€ä¸ªå¤´éƒ¨æ´»è·ƒç”¨æˆ·ï¼Œé‚£ä¹ˆæ­¤ç”¨æˆ·çš„æ¶ˆæ¯éƒ½è¿›å…¥åŒä¸€ä¸ª Partition å°±ä¼šäº§ç”Ÿçƒ­ç‚¹é—®é¢˜ï¼Œå¯¼è‡´æŸä¸ª Partition æå…¶ç¹å¿™ã€‚

![image-20210826160708467](/assets/imgs/image-20210826160708467.png)

> 2ã€ç”± kafka å†³å®š

å¦‚æœæ²¡æœ‰ä½¿ç”¨ Partition Keyï¼ŒKafka å°±ä¼šä½¿ç”¨è½®è¯¢çš„æ–¹å¼æ¥å†³å®šå†™å…¥å“ªä¸ª Partitionã€‚

**è¿™æ ·ï¼Œæ¶ˆæ¯ä¼šå‡åŒ€åœ°å†™å…¥å„ä¸ª Partitionï¼Œä¹Ÿå°±æ— æ³•ä¿è¯æ¶ˆæ¯çš„æœ‰åºæ€§ã€‚**

> 3ã€è‡ªå®šä¹‰è§„åˆ™

Kafka æ”¯æŒè‡ªå®šä¹‰è§„åˆ™ï¼Œä¸€ä¸ª Producer å¯ä»¥ä½¿ç”¨è‡ªå·±çš„åˆ†åŒºæŒ‡å®šè§„åˆ™ã€‚



## Partition çš„è¯»å–æ–¹å¼

Kafka ä¸åƒæ™®é€šæ¶ˆæ¯é˜Ÿåˆ—å…·æœ‰å‘å¸ƒ/è®¢é˜…åŠŸèƒ½ï¼ŒKafka ä¸ä¼šå‘ Consumer æ¨é€æ¶ˆæ¯ã€‚**Consumer å¿…é¡»è‡ªå·±ä» Topic çš„ Partition æ‹‰å–æ¶ˆæ¯ã€‚**ä¸€ä¸ª Consumer è¿æ¥åˆ°ä¸€ä¸ª Broker çš„ Partitionï¼Œä»ä¸­ä¾æ¬¡è¯»å–æ¶ˆæ¯ã€‚

æ¶ˆæ¯çš„ Offset å°±æ˜¯ Consumer çš„æ¸¸æ ‡ï¼Œæ ¹æ® Offset æ¥è®°å½•æ¶ˆæ¯çš„æ¶ˆè´¹æƒ…å†µã€‚è¯»å®Œä¸€æ¡æ¶ˆæ¯ä¹‹åï¼ŒConsumer ä¼šæ¨è¿›åˆ° Partition ä¸­çš„ä¸‹ä¸€ä¸ª Offsetï¼Œç»§ç»­è¯»å–æ¶ˆæ¯ã€‚**Offset çš„æ¨è¿›å’Œè®°å½•éƒ½æ˜¯ Consumer çš„è´£ä»»ï¼ŒKafka æ˜¯ä¸ç®¡çš„ã€‚**

![image-20210826161534345](/assets/imgs/image-20210826161534345.png)

Kafka ä¸­æœ‰ä¸€ä¸ª Consumer Groupï¼ˆæ¶ˆè´¹ç»„ï¼‰çš„æ¦‚å¿µï¼Œå¤šä¸ª Consumer ç»„å›¢å»æ¶ˆè´¹ä¸€ä¸ª Topicã€‚åŒç»„çš„ Consumer æœ‰ç›¸åŒçš„ Group IDã€‚**Consumer Group æœºåˆ¶ä¼šä¿éšœä¸€æ¡æ¶ˆæ¯åªè¢«ç»„å†…å”¯ä¸€ä¸€ä¸ª Consumer æ¶ˆè´¹ï¼Œä¸ä¼šé‡å¤æ¶ˆè´¹ã€‚**æ¶ˆè´¹ç»„è¿™ç§æ–¹å¼å¯ä»¥è®©å¤šä¸ª Partition å¹¶è¡Œæ¶ˆè´¹ï¼Œå¤§å¤§æé«˜äº†æ¶ˆæ¯çš„æ¶ˆè´¹èƒ½åŠ›ï¼Œ**æœ€å¤§å¹¶è¡Œåº¦ä¸º Topic çš„ Partition æ•°é‡**ã€‚

ä¾‹å¦‚ä¸€ä¸ª Topic æœ‰ 3 ä¸ª Partitionï¼Œä½ æœ‰ 4 ä¸ª Consumer è´Ÿè´£è¿™ä¸ª Topicï¼Œä¹Ÿåªä¼šæœ‰ Consumer å·¥ä½œï¼Œå¦ä¸€ä¸ªä½œä¸ºåè¡¥é˜Ÿå‘˜ï¼Œå½“æŸä¸ª Consumer æ•…éšœäº†ï¼Œå®ƒå†è¡¥ä¸Šå»ï¼Œæ˜¯ä¸€ç§å¾ˆå¥½çš„å®¹é”™æœºåˆ¶ã€‚

![image-20210826162233690](/assets/imgs/image-20210826162233690.png)



# å‚è€ƒ

- [Understanding Kafka Topic Partitions](https://medium.com/event-driven-utopia/understanding-kafka-topic-partitions-ae40f80552e8)