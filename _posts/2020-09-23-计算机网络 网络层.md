---
layout: post
title:  "计算机网络 网络层"
date:   2020-09-23 12:38:06 +0800--
categories: [计算机网络]
tags: [计算机网络, ]  

---

# 网络层

> 书籍：计算机网络自顶向下. TCP/IP详解

## 一些基本知识

### 网络中继系统

网络互相连接起来 要使用一些中间设备。中间设备又称为中间系统或中继(relay)系统。

- 物理层中继系统:转发器(repeater)
- 数据链路层中继系统:网桥或桥接器(bridge)
- 网络层中继系统:路由器(router)
-  网桥和路由器的混合物:桥路器(brouter)
-  网络层以上的中继系统:网关(gateway)

### IP地址与硬件地址

![image-20200923221045257](/Users/silince/Develop/博客/blog_to_git/assets/imgs/image-20200923221045257.png)

### 单播、广播、组播

单播

单播在发送者和每一接收者之间实现点对点网络连接。如果一台发送者同时给多个接收者传输相同的数据，也必须相应的复制多份的相同数据包。如果有大量主机希望获得数据包的同一份拷贝时，将导致发送者负担沉重、延迟长、网络拥塞，为保证一定的服务质量需增加硬件和带宽。

单播优点：

- 服务器及时响应客户机的请求

- 服务器针对每个客户不同的请求发送不同的数据，容易实现个性化服务。

单播缺点：

- 服务器针对每个客户机发送数据流，服务器流量=客户机数量客户机流量，在客户数量大、每个客户机流量大的流媒体应用中服务器不堪重负。

- 现有的网络带宽是金字塔结构，城际省际主干带宽仅仅相当于其所有用户带宽之和的5%。如果全部使用单播协议，将造成网络主干不堪重负。现在的P2P应用就已经使主干经常阻塞。而将主干扩展20倍几乎是不可能。

广播

广播是指在IP子网内广播数据包，所有在子网内部的主机都将受到这些数据包。广播意味着网络向子网每一个主机都投递一份数据包，不论这些主机是否乐于接收该数据包。所以广播的使用范围非常小，只在本地子网内有效，通过路由器和交换机网络设备控制广播传输。

***无论是何种广播，它第二层目的MAC地址都是FF-FF-FF-FF-FF-FF，这样交换机也就可以往外flood广播包.区别于多播的MAC帧头是01005A+subnetid***

广播的优点：

- 网络设备简单，维护简单，布网成本低廉
- 由于服务器不用向每个客户机单独发送数据，所以服务器流量负载极低。

广播缺点：

- 无法针对每个客户的要求和时间及时提供个性化服务
- 网络允许服务器提供数据的带宽有限，客户端的最大带宽=服务总带宽。
- 广播禁止允许在Internet宽带网上传输。

组播

组播在发送者和每一接收者之间实现点对点网络连接。如果一台发送者同时给多个的接收者传输相同的数据，也只需复制一份的相同数据包。它提高了数据传送效率，减少了骨干网络出现拥塞的可能性。

组播的优点：

- 需要相同数据流的客户端加入相同的组共享一条数据流，节省了服务器的负载。具备广播所具备的优点。
- 由于组播协议是根据接受者的需要对数据流进行复制转发，所以服务端的服务总带宽不受客户接入带宽的限制。IP协议允许有亿6千多万个组播，所以其提供的服务可以非常丰富。
- 此协议和单播协议一样允许在Internet宽带网上传输。

组播的缺点： 

- 与单播协议相比没有纠错机制，发生丢包错包后难以弥补，但可以通过一定的容错机制和QOS加以弥补。 
- 现行网络虽然都支持组播的传输，但在客户认证、QOS等方面还需要完善，这些缺点在理论上都有成熟的解决方案，只是需要逐步推广应用到现存网络当中。



### **计算机A与计算机B的通信过程**

- 交换机基于数据帧的MAC地址转发数据帧，路由器基于数据包的IP地址转发数据包
- 数据包在传输过程不变，过网络设备数据帧要用***新的物理层地址重新封装***
- ***MAC地址决定了数据帧下一跳哪个设备接受，而IP地址决定了数据包的起点和终点***

![image-20200923221133143](/Users/silince/Develop/博客/blog_to_git/assets/imgs/image-20200923221133143.png)

### 网络层4个协议之间层次

![image-20200923182714918](/assets/imgs/image-20200923182714918.png)



## ARP/RARP协议 (地址解析和逆地址解析)

### 地址解析协议 ARP

- 不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。
- ***每一个主机都设有一个 ARP 高速缓存(ARP cache)，***里面有所在的局域网上的各主机和路由器 的 IP 地址到硬件地址的映射表。
- ***当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。***如有，就可查出其对应的硬件地址， 再将此硬件地址写入 MAC 帧，然后通过局域网将 该 MAC 帧发往此硬件地址。

![image-20200923224510579](/Users/silince/Develop/博客/blog_to_git/assets/imgs/image-20200923224510579.png)

![image-20200923224728805](/Users/silince/Develop/博客/blog_to_git/assets/imgs/image-20200923224728805.png)



***使用ARP的四种典型情况：***

- 发送方是主机，要把IP数据报发送到本网络的另一个主机，此时用ARP找到目标主机的MAC地址；
- 发送方是主机，要把IP数据报发送到另一个网络的另一个主机，此时用ARP找到本网络上一个路由器的MAC地址，剩下的工作由路由器进行；
- 发送方是路由器，要把IP数据报发送到本网络的另一个主机，此时用ARP找到目标主机的MAC地址；
- 发送方是路由器，要把IP数据报发送到另一个网络的另一个主机，此时用ARP找到本网络上一个路由器的MAC地址，剩下的工作由路由器进行；

#### ARP协议的作用

- 将IP地址通过广播(本网段，不通过路由器)，目标MAC地址是FF-FF-FF-FF-FF-FF，解析目标IP地址的MAC地址。
- ARP是解决同一个局域网上的主机或路由器的IP地址和MAC地址的映射关系。如果所找的主机和原主机不在同一个局域网上，那么就要通过ARP找一个位于本局域网上的某个路由器的MAC地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。
- 从IP地址到MAC地址的解析是自动进行的，主机的用户对这种地址解析过程是不知情的。
- 只要主机或路由器要和本网络上的另一个已知IP地址的主机或路由器进行通信，ARP协议就会自动地将该IP地址解析为链路层所需要的MAC地址。

#### ARP的报文格式

![image-20200923225702122](/Users/silince/Develop/博客/blog_to_git/assets/imgs/image-20200923225702122.png)

硬件类型：表示硬件地址的类型，值为1表示以太网地址

协议类型：表示要映射的协议地址类型。它的值为0x0800表示IP地址类型

硬件地址长度和协议地址长度以字节为单位，对于以太网上的IP地址的ARP请求或应答来说，他们的值分别为6和4；

操作类型（op）:1表示ARP请求，2表示ARP应答

发送端MAC地址：发送方设备的硬件地址；

发送端IP地址：发送方设备的IP地址；

目标MAC地址：接收方设备的硬件地址。

目标IP地址：接收方设备的IP地址。

#### ARP地址解析过程

**主机A和B在同一个网段，主机A要向主机B发送信息。如图1-2所示，具体的地址解析过程如下：**

1. 主机A首先查看自己的ARP缓存表，确定其中是否包含有主机B对应的ARP表项。如果找到了对应的MAC地址，则主机A直接利用ARP表中的MAC地址，对IP数据包进行帧封装，并将数据包发送给主机B。
2. 如果主机A在ARP表中找不到对应的MAC地址，则将缓存该数据报文，主机会在局域网内发MAC地址广播，MAC帧的源MAC为自己，目的MAC为ff-ff-ff-ff-ff-ff***(在以太网首部中)***。***ARP请求报文中的发送端IP地址和发送端MAC地址为主机A的IP地址和MAC地址，目标IP地址和目标MAC地址为主机B的IP地址和空（全为0）的MAC地址。***由于ARP请求报文以广播方式发送，该网段上的所有主机都可以接收到该请求，但只有被请求的主机（即主机B）会对该请求进行处理。
3. 主机B比较自己的IP地址和ARP请求报文中的目标IP地址，当两者相同时进行如下处理：将ARP请求报文中的发送端（即主机A）的IP地址和MAC地址存入自己的ARP表中。之后以单播方式发送ARP响应报文给主机A，其中包含了自己的MAC地址。
4. 主机A收到ARP响应报文后，将主机B的MAC地址加入到自己的ARP表中以用于后续报文的转发，同时将IP数据包进行封装后发送出去。

![image-20200923230203386](/Users/silince/Develop/博客/blog_to_git/assets/imgs/image-20200923230203386.png)

**当主机A和主机B不在同一网段时:**

主机A就会先向网关发出ARP请求，ARP请求报文中的目标IP地址为网关的IP地址。当主机A从收到的响应报文中获得网关的MAC地址后，将报文封装并发给网关。如果网关没有主机B的ARP表项，网关会广播ARP请求，目标IP地址为主机B的IP地址，当网关从收到的响应报文中获得主机B的MAC地址后，就可以将报文发给主机B；如果网关已经有主机B的ARP表项，网关直接把报文发给主机B。



#### ARP缓存/ARP欺骗

- 为了减少网络上的通信量，主机 A 在发送 其 ARP 请求分组时，就将自己的 IP 地址 到硬件地址的映射写入 ARP 请求分组。
- 当主机 B 收到 A 的 ARP 请求分组时，就 将主机 A 的这一地址映射写入主机 B 自己 的 ARP 高速缓存中。这对主机 B 以后向 A 发送数据报时就更方便了。



#### 应当注意的问题

- ARP 是解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。
- 如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局 域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组 转发给下一个网络。剩下的工作就由下一个网络来做。
- 从IP地址到硬件地址的解析是自动进行的， 主机的用户对这种地址解析过程是不知道的。
- 只要主机或路由器要和本网络上的另一个已 知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所 需要的硬件地址。

### 逆地址解析协议 RARP

- 逆地址解析协议 RARP 使只知道自己硬件地址的主机能够知道其 IP 地址。
- 这种主机往往是无盘工作站。 因此 RARP 协议目前已很少使用。



## IP协议







- IP协议

  - 掌握IP首部格式：如16位分片标识、DF不分片标志、MF更多分片标志、13位片偏移、8位生存时间TTL、16位的首部检验和等等。
  - 掌握IP分片
  - 掌握IP选路

- 掌握ICMP协议

  - 报文格式
  - 报文的两大分类：查询+差错（2种查询报文+5种差错报文）

  


