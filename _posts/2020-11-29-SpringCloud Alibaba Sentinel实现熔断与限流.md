---
layout: post
title: "SpringCloud Alibaba Sentinelå®ç°ç†”æ–­ä¸é™æµ"
date: 2020-11-29 11:18:16 +0800--
categories: [Java, åˆ†å¸ƒå¼]
tags: [Java, åˆ†å¸ƒå¼, SpringCloud]  

---

# æ¦‚è¿°

> [å®˜ç½‘](https://github.com/alibaba/Sentinel)	[ä¸­æ–‡å®˜ç½‘](https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D)	[æ–‡æ¡£](https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel)	[ä¸‹è½½åœ°å€](https://github.com/alibaba/Sentinel/releases)

éšç€å¾®æœåŠ¡çš„æµè¡Œï¼ŒæœåŠ¡å’ŒæœåŠ¡ä¹‹é—´çš„ç¨³å®šæ€§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚Sentinel ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚

Sentinel å…·æœ‰ä»¥ä¸‹ç‰¹å¾:

- **ä¸°å¯Œçš„åº”ç”¨åœºæ™¯**ï¼šSentinel æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯ï¼Œä¾‹å¦‚ç§’æ€ï¼ˆå³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´ï¼‰ã€æ¶ˆæ¯å‰Šå³°å¡«è°·ã€é›†ç¾¤æµé‡æ§åˆ¶ã€å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚
- **å®Œå¤‡çš„å®æ—¶ç›‘æ§**ï¼šSentinel åŒæ—¶æä¾›å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚æ‚¨å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®ï¼Œç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µã€‚
- **å¹¿æ³›çš„å¼€æºç”Ÿæ€**ï¼šSentinel æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶/åº“çš„æ•´åˆæ¨¡å—ï¼Œä¾‹å¦‚ä¸ Spring Cloudã€Dubboã€gRPC çš„æ•´åˆã€‚æ‚¨åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿›è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿåœ°æ¥å…¥ Sentinelã€‚
- **å®Œå–„çš„ SPI æ‰©å±•ç‚¹**ï¼šSentinel æä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„ SPI æ‰©å±•æ¥å£ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•æ¥å£æ¥å¿«é€Ÿåœ°å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ã€é€‚é…åŠ¨æ€æ•°æ®æºç­‰ã€‚

![image-20201129121458418](/assets/imgs/image-20201129121458418.png)

ä¸Hystrixçš„åŒºåˆ«ï¼š

![image-20201129120929766](/assets/imgs/image-20201129120929766.png)

# å®‰è£…Sentinelæ§åˆ¶å°

sentinelæ°›å›´ä¸¤ä¸ªç»„æˆï¼š

- æ ¸å¿ƒåº“ï¼ˆJavaå®¢æˆ·ç«¯ï¼‰ä¸ä¾èµ–ä»»ä½•æ¡†æ¶/åº“ï¼Œèƒ½å¤Ÿè¿è¡Œäºæ‰€æœ‰Javaè¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶å¯¹Dubbo/Spring Cloudç­‰æ¡†æ¶ä¹Ÿæœ‰è¾ƒå¥½çš„æ”¯æŒã€‚
- æ§åˆ¶å°ï¼ˆDashboardï¼‰ åŸºäºSpring Bootå¼€å‘ï¼Œæ‰“åŒ…åå¯ä»¥ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦é¢å¤–çš„Tomcatç­‰åº”ç”¨å®¹å™¨ã€‚

å®‰è£…æ­¥éª¤ï¼š

- æ‰§è¡Œå‘½ä»¤ `java -jar sentinel-dashboard-1.7.0.jar `
- è®¿é—®sentinelç®¡ç†ç•Œé¢ http://localhost:8080 ï¼Œç™»å½•è´¦å·å¯†ç å‡ä¸ºsentinel



# åˆå§‹åŒ–æ¼”ç¤ºå·¥ç¨‹

1.å¯åŠ¨Nacos8848æˆåŠŸ http://localhost:8848/nacos/#/login

2.æ–°å»ºModule [cloudalibaba-sentinel-service8401](https://github.com/Silincee/springcloud2020/tree/main/cloudalibaba-sentinel-service8401)

3.å¯åŠ¨Sentinel8080

4.å¯åŠ¨8401å¾®æœåŠ¡æŸ¥çœ‹sentienlæ§åˆ¶å°

- Sentinelé‡‡ç”¨æ‡’åŠ è½½æœºåˆ¶ï¼Œéœ€è¦å…ˆæ‰§è¡Œä¸€æ¬¡è®¿é—®
- http://localhost:8401/testA  / http://localhost:8401/testB

![image-20201129124233657](/assets/imgs/image-20201129124233657.png)



# æµæ§è§„åˆ™

## åŸºæœ¬ä»‹ç»

- èµ„æºå:å”¯ä¸€åç§°ï¼Œé»˜è®¤è¯·æ±‚è·¯å¾„
- é’ˆå¯¹æ¥æº: Sentineå¯ä»¥é’ˆå¯¹è°ƒç”¨è€…è¿›è¡Œé™æµï¼Œå¡«å†™å¾®æœåŠ¡åï¼Œé»˜è®¤default ï¼ˆä¸åŒºåˆ†æ¥æºï¼‰
- é˜ˆå€¼ç±»å‹/å•æœºé˜ˆå€¼:
  - QPS ï¼ˆæ¯ç§’é’Ÿçš„è¯·æ±‚æ•°é‡ï¼‰ :å½“è°ƒç”¨è¯¥apiçš„QPSè¾¾åˆ°é˜ˆå€¼çš„æ—¶å€™ï¼Œè¿›è¡Œé™æµ
  - çº¿ç¨‹æ•°:å½“è°ƒç”¨è¯¥apiçš„çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼çš„æ—¶å€™ï¼Œè¿›è¡Œé™æµ
- æ˜¯å¦é›†ç¾¤:ä¸éœ€è¦é›†ç¾¤
- æµæ§æ¨¡å¼: 
  - ç›´æ¥: apiè¾¾åˆ°é™æµæ¡ä»¶æ—¶ï¼Œç›´æ¥é™æµ
  - å…³è”:å½“å…³è”çš„èµ„æºè¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œå°±é™æµè‡ªå·±
  - é“¾è·¯:åªè®°å½•æŒ‡å®šé“¾è·¯ä¸Šçš„æµé‡ï¼ˆæŒ‡å®šèµ„æºä»å…¥å£èµ„æºè¿›æ¥çš„æµé‡ï¼Œå¦‚æœè¾¾åˆ°é˜ˆå€¼ï¼Œå°±è¿›è¡Œé™æµï¼‰ ã€apiçº§åˆ«çš„é’ˆå¯¹æ¥æºã€‘
- æµæ§æ•ˆæœ:
  - å¿«é€Ÿå¤±è´¥:ç›´æ¥å¤±è´¥ï¼ŒæŠ›å¼‚å¸¸
  - Warm Up:æ ¹æ®codeFactor ï¼ˆå†·åŠ è½½å› å­ï¼Œé»˜è®¤3ï¼‰çš„å€¼ï¼Œä»é˜ˆå€¼/codeFactorï¼Œ ç»è¿‡é¢„çƒ­æ—¶é•¿ï¼Œè¾¾åˆ°è®¾ç½®çš„QPSé˜ˆå€¼
  - æ’é˜Ÿç­‰å¾…ï¼šå‡é€Ÿæ´¾å¯¹ï¼Œè®©è¯·æ±‚ä»¥å‡é€Ÿçš„é€Ÿåº¦é€šè¿‡ï¼Œé˜ˆå€¼ç±»å‹å¿…é¡»è®¾ç½®ä¸ºQPSï¼Œå¦åˆ™æ— æ•ˆ

![image-20201129124530532](/assets/imgs/image-20201129124530532.png)

## æµæ§æ¨¡å¼

### ç›´æ¥ï¼ˆé»˜è®¤ï¼‰

ç›´æ¥ --->`QPS>1`å¿«é€Ÿå¤±è´¥é…ç½®ï¼š

![WX20201129-130423](/assets/imgs/WX20201129-130423.png)

è¡¨ç¤º1ç§’é’Ÿå†…æŸ¥è¯¢1æ¬¡å°±æ˜¯0Kï¼Œè‹¥è¶…è¿‡æ¬¡æ•°1ï¼Œå°±ç›´æ¥ ---> å¿«é€Ÿå¤±è´¥ï¼ŒæŠ¥é»˜è®¤é”™è¯¯ã€‚

- QPSæŒ‡çš„æ˜¯æŒ¡åœ¨å¤–éƒ¨ä¸è®©è¿›æ¥
- çº¿ç¨‹æ•°æŒ‡çš„æ˜¯è¿›æ¥ä¹‹åæœ€å¤šåªèƒ½æœ‰ é˜ˆå€¼nä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œå¤šçš„å°±å¿«é€Ÿå¤±è´¥

![image-20201129130524104](/assets/imgs/image-20201129130524104.png)

![image-20201129132557985](/assets/imgs/image-20201129132557985.png)



ç»“æœï¼š

![image-20201129130620804](/assets/imgs/image-20201129130620804.png)

ç›´æ¥è°ƒç”¨é»˜è®¤æŠ¥é”™ä¿¡æ¯ï¼ŒæŠ€æœ¯æ–¹é¢OK butï¼Œæ˜¯å¦åº”è¯¥æœ‰æˆ‘ä»¬è‡ªå·±çš„åç»­å¤„ç†ï¼Ÿ

- ***æ˜¯å¦æœ‰ç±»ä¼¼äºfallbackçš„å…œåº•æ–¹æ³•ï¼Ÿ***



### å…³è”

- å½“å…³è”çš„èµ„æºè¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œå°±é™æµè‡ªå·±
- å½“ä¸Aå…³è”çš„èµ„æºBè¾¾åˆ°é˜ˆå€¼åï¼Œå°±é™æµè‡ªå·±
- å³Bæƒ¹äº‹ï¼ŒAæŒ‚äº†

1.é…ç½®/testA

é…ç½®æ•ˆæœï¼šå½“å…³è”èµ„æº/testBçš„qpsé˜€å€¼è¶…è¿‡1æ—¶ï¼Œå°±é™æµ/testAçš„Restè®¿é—®åœ°å€ï¼Œå½“å…³è”èµ„æºåˆ°é˜ˆå€¼åé™åˆ¶é…ç½®å¥½çš„èµ„æºå

![image-20201129133142982](/assets/imgs/image-20201129133142982.png)

2.postmanæ¨¡æ‹Ÿå¹¶å‘å¯†é›†è®¿é—®testB

20ä¸ªçº¿ç¨‹æ¯éš”é—´éš”0.3sè®¿é—®ä¸€æ¬¡ /testB

![image-20201129135415786](/assets/imgs/image-20201129135415786.png)



### é“¾è·¯

åªè®°å½•æŒ‡å®šé“¾è·¯ä¸Šçš„æµé‡ï¼ˆæŒ‡å®šèµ„æºä»å…¥å£èµ„æºè¿›æ¥çš„æµé‡ï¼Œå¦‚æœè¾¾åˆ°é˜ˆå€¼ï¼Œå°±è¿›è¡Œé™æµï¼‰ ***[apiçº§åˆ«çš„é’ˆå¯¹æ¥æº]***



## æµæ§æ•ˆæœ

### å¿«é€Ÿå¤±è´¥ï¼ˆé»˜è®¤çš„æµæ§å¤„ç†ï¼‰

ç›´æ¥å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ `Blocked by Sentinel (flow limiting)`

æºç ï¼šcom.alibaba.csp.sentinel.slots.block.flow.controller.DefaultController

### [é¢„çƒ­](https://github.com/alibaba/Sentinel/wiki/é™æµ---å†·å¯åŠ¨)

å½“æµé‡çªç„¶å¢å¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šå¸Œæœ›ç³»ç»Ÿä»ç©ºé—²çŠ¶æ€åˆ°ç¹å¿™çŠ¶æ€çš„åˆ‡æ¢çš„æ—¶é—´é•¿ä¸€äº›ã€‚å³å¦‚æœç³»ç»Ÿåœ¨æ­¤ä¹‹å‰é•¿æœŸå¤„äºç©ºé—²çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å¸Œæœ›å¤„ç†è¯·æ±‚çš„æ•°é‡æ˜¯ç¼“æ­¥çš„å¢å¤šï¼Œç»è¿‡é¢„æœŸçš„æ—¶é—´ä»¥åï¼Œåˆ°è¾¾ç³»ç»Ÿå¤„ç†è¯·æ±‚ä¸ªæ•°çš„æœ€å¤§å€¼ã€‚Warm Upï¼ˆå†·å¯åŠ¨ï¼Œé¢„çƒ­ï¼‰æ¨¡å¼å°±æ˜¯ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„çš„ã€‚

Warm Up ï¼ˆ `RuleConstant.CONTROL_BEHAVIOR_WARM_UP` ï¼‰æ–¹å¼ï¼Œå³é¢„çƒ­/å†·å¯åŠ¨æ–¹å¼ã€‚å½“ç³»ç»Ÿé•¿æœŸå¤„äºä½æ°´ä½çš„æƒ…å†µä¸‹ï¼Œå½“æµé‡çªç„¶å¢åŠ æ—¶ï¼Œç›´æ¥æŠŠç³»ç»Ÿæ‹‰å‡åˆ°é«˜æ°´ä½å¯èƒ½ç¬é—´æŠŠç³»ç»Ÿå‹å®ã€‚é€š5è¿‡â€œå†·å¯åŠ¨"ï¼Œè®©é€šè¿‡çš„æµé‡ç¼“æ…¢å¢åŠ ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…é€æ¸å¢åŠ åˆ°é˜ˆå€¼ä¸Šé™ï¼Œç»™å†·ç³»ç»Ÿä¸€ä¸ªé¢„çƒ­çš„æ—¶é—´ï¼Œ é¿å…å†·ç³»ç»Ÿè¢«å‹å®ã€‚

***åº”ç”¨åœºæ™¯ï¼šç§’æ€ç³»ç»Ÿåœ¨å¼€å¯çš„ç¬é—´ï¼Œä¼šæœ‰å¾ˆå¤šæµé‡ä¸Šæ¥ï¼Œå¾ˆæœ‰å¯èƒ½æŠŠç³»ç»Ÿæ‰“æ­»ï¼Œé¢„çƒ­æ–¹å¼å°±æ˜¯æŠŠä¸ºäº†ä¿æŠ¤ç³»ç»Ÿï¼Œå¯æ…¢æ…¢çš„æŠŠæµé‡æ”¾è¿›æ¥ï¼Œæ…¢æ…¢çš„æŠŠé˜€å€¼å¢é•¿åˆ°è®¾ç½®çš„é˜€å€¼ã€‚***

**å…¬å¼ï¼šé˜ˆå€¼é™¤ä»¥coldFactorï¼ˆé»˜è®¤å€¼ä¸º3ï¼‰ï¼Œç»è¿‡é¢„çƒ­æ—¶é•¿åæ‰ä¼šè¾¾åˆ°é˜ˆå€¼ã€‚**

**é»˜è®¤coldFactorä¸º3ï¼Œå³è¯·æ±‚QPSä»`threshold/3`å¼€å§‹ï¼Œç»é¢„çƒ­æ—¶é•¿é€æ¸å‡è‡³è®¾å®šçš„QPSé˜ˆå€¼ã€‚**

![image-20201129144751921](/assets/imgs/image-20201129144751921.png)

æºç ï¼š

![image-20201129154253425](/assets/imgs/image-20201129154253425.png)

Warmupé…ç½®æ¡ˆä¾‹ï¼š

é˜€å€¼ä¸º10 + é¢„çƒ­æ—¶é•¿è®¾ç½®5ç§’ã€‚

ç³»ç»Ÿåˆå§‹åŒ–çš„é˜€å€¼ä¸º10 / 3çº¦ç­‰äº3ï¼Œå³é˜€å€¼åˆšå¼€å§‹ä¸º3ï¼›ç„¶åè¿‡äº†5ç§’åé˜€å€¼æ‰æ…¢æ…¢å‡é«˜æ¢å¤åˆ°10

![image-20201129155032695](/assets/imgs/image-20201129155032695.png)



### æ’é˜Ÿç­‰å¾…

åŒ€é€Ÿæ’é˜Ÿï¼Œè®©è¯·æ±‚ä»¥å‡åŒ€çš„é€Ÿåº¦é€šè¿‡ï¼Œé˜€å€¼ç±»å‹å¿…é¡»è®¾æˆQPSï¼Œå¦åˆ™æ— æ•ˆã€‚**ï¼ˆåªå…è®¸QPSï¼‰**

è¿™ç§æ–¹å¼ä¸»è¦ç”¨äºå¤„ç†é—´éš”æ€§çªå‘çš„æµé‡ï¼Œä¾‹å¦‚æ¶ˆæ¯é˜Ÿåˆ—ã€‚æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼Œ åœ¨æŸä¸€ç§’æœ‰å¤§é‡çš„è¯·æ±‚åˆ°æ¥ï¼Œè€Œæ¥ä¸‹æ¥çš„å‡ ç§’åˆ™å¤„äºç©ºé—²çŠ¶æ€ï¼Œæˆ‘ä»¬å¸Œç›ç³»ç»Ÿèƒ½å¤Ÿåœ¨æ¥ä¸‹æ¥çš„ç©ºé—²æœŸé—´é€æ¸å¤„ç†è¿™äº›è¯·æ±‚ï¼Œè€Œä¸æ˜¯åœ¨ç¬¬ä¸€ç§’ç›´æ¥æ‹’ç»å¤šä½™çš„è¯·æ±‚ã€‚

![image-20201129160516692](/assets/imgs/image-20201129160516692.png)

è®¾ç½®å«ä¹‰: /testAæ¯ç§’1æ¬¡è¯·æ±‚ï¼Œè¶…è¿‡çš„è¯å°±æ’é˜Ÿç­‰å¾…ï¼Œç­‰å¾…çš„è¶…æ—¶æ—¶é—´ä¸º20000æ¯«ç§’ã€‚

![image-20201129155440886](/assets/imgs/image-20201129155440886.png)

# é™çº§è§„åˆ™

å®˜ç½‘ï¼š[https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7](https://github.com/alibaba/Sentinel/wiki/ç†”æ–­é™çº§)

## æ¦‚è¿°

Sentinelç†”æ–­é™çº§ä¼šåœ¨è°ƒç”¨é“¾è·¯ä¸­æŸä¸ªèµ„æºå‡ºç°ä¸ç¨³å®šçŠ¶æ€æ—¶ï¼ˆä¾‹å¦‚è°ƒç”¨è¶…æ—¶æˆ–å¼‚å¸¸æ¯”ä¾‹å‡é«˜ï¼‰ï¼Œ å¯¹è¿™ä¸ªèµ„æºçš„è°ƒç”¨è¿›è¡Œé™åˆ¶ï¼Œè®©è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œé¿å…å½±å“åˆ°å…¶å®ƒçš„èµ„æºè€Œå¯¼è‡´çº§è”é”™è¯¯ã€‚

å½“èµ„æºè¢«é™çº§åï¼Œåœ¨æ¥ä¸‹æ¥çš„é™çº§æ—¶é—´çª—å£ä¹‹å†…ï¼Œå¯¹è¯¥èµ„æºçš„è°ƒç”¨éƒ½è‡ªåŠ¨ç†”æ–­ï¼ˆé»˜è®¤è¡Œä¸ºæ˜¯æŠ›å‡ºDegradeExceptionï¼‰ã€‚



### ç†”æ–­ç­–ç•¥

***RT ï¼ˆå¹³å‡å“åº”æ—¶é—´ï¼Œç§’çº§ï¼‰***

- å¹³å‡å“åº”æ—¶é—´**è¶…å‡ºé˜ˆå€¼**ä¸”**åœ¨æ—¶é—´çª—å†…é€šè¿‡çš„è¯·æ±‚ >=5**ï¼Œä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³åè§¦å‘é™çº§
- çª—å£æœŸè¿‡åå…³é—­æ–­è·¯å™¨
- RTæœ€å¤§4900 ï¼ˆæ›´å¤§çš„éœ€è¦é€šè¿‡ `-Dcsp.sentinel.statistic.max.rt= XXXX`æ‰èƒ½ç”Ÿæ•ˆï¼‰

***å¼‚å¸¸æ¯”ä¾‹ï¼ˆç§’çº§ï¼‰***

- QPS >= 5ä¸”å¼‚å¸¸æ¯”ä¾‹ï¼ˆç§’çº§ç»Ÿè®¡ï¼‰è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè§¦å‘é™çº§ï¼›æ—¶é—´çª—ç»“æŸåï¼Œå…³é—­é™çº§

***å¼‚å¸¸æ•°ï¼ˆåˆ†é’Ÿçº§ï¼‰***

- å¼‚å¸¸æ•°ï¼ˆåˆ†é’Ÿç»Ÿè®¡ï¼‰è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè§¦å‘é™çº§ï¼›æ—¶é—´çª—å£ç»“æŸåï¼Œå…³é—­é™çº§

![image-20201129161329132](/assets/imgs/image-20201129161329132.png)



## é™çº§ç­–ç•¥å®æˆ˜

### RT

æ…¢è°ƒç”¨æ¯”ä¾‹ (`SLOW_REQUEST_RATIO`)ï¼šé€‰æ‹©ä»¥æ…¢è°ƒç”¨æ¯”ä¾‹ä½œä¸ºé˜ˆå€¼ï¼Œéœ€è¦è®¾ç½®å…è®¸çš„æ…¢è°ƒç”¨ RTï¼ˆå³æœ€å¤§çš„å“åº”æ—¶é—´ï¼‰ï¼Œè¯·æ±‚çš„å“åº”æ—¶é—´å¤§äºè¯¥å€¼åˆ™ç»Ÿè®¡ä¸ºæ…¢è°ƒç”¨ã€‚å½“å•ä½ç»Ÿè®¡æ—¶é•¿ï¼ˆ`statIntervalMs`ï¼‰å†…è¯·æ±‚æ•°ç›®å¤§äºè®¾ç½®çš„æœ€å°è¯·æ±‚æ•°ç›®ï¼Œå¹¶ä¸”æ…¢è°ƒç”¨çš„æ¯”ä¾‹å¤§äºé˜ˆå€¼ï¼Œåˆ™æ¥ä¸‹æ¥çš„ç†”æ–­æ—¶é•¿å†…è¯·æ±‚ä¼šè‡ªåŠ¨è¢«ç†”æ–­ã€‚ç»è¿‡ç†”æ–­æ—¶é•¿åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼ˆHALF-OPEN çŠ¶æ€ï¼‰ï¼Œè‹¥æ¥ä¸‹æ¥çš„ä¸€ä¸ªè¯·æ±‚å“åº”æ—¶é—´å°äºè®¾ç½®çš„æ…¢è°ƒç”¨ RT åˆ™ç»“æŸç†”æ–­ï¼Œè‹¥å¤§äºè®¾ç½®çš„æ…¢è°ƒç”¨ RT åˆ™ä¼šå†æ¬¡è¢«ç†”æ–­ã€‚

![image-20201129162355620](/assets/imgs/image-20201129162355620.png)

é…ç½®ï¼š200mså†…å®Œæˆä¸äº†å°±è§¦å‘ç†”æ–­ï¼Œç»è¿‡ç†”æ–­æ—¶é•¿`1s`åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼ˆHALF-OPEN çŠ¶æ€ï¼‰ï¼Œè‹¥æ¥ä¸‹æ¥çš„ä¸€ä¸ªè¯·æ±‚å“åº”æ—¶é—´å°äºè®¾ç½®çš„æ…¢è°ƒç”¨ RT åˆ™ç»“æŸç†”æ–­ï¼Œè‹¥å¤§äºè®¾ç½®çš„æ…¢è°ƒç”¨ RT åˆ™ä¼šå†æ¬¡è¢«ç†”æ–­ã€‚

![image-20201129162616608](/assets/imgs/image-20201129162616608.png)

JMeteræµ‹è¯•ï¼š1ç§’å†…æ‰“å…¥10ä¸ªçº¿ç¨‹

![image-20201129163844506](/assets/imgs/image-20201129163844506.png)

æ°¸è¿œä¸€ç§’é’Ÿæ‰“è¿›æ¥10ä¸ªçº¿ç¨‹ï¼ˆå¤§äº5ä¸ªäº†ï¼‰è°ƒç”¨testDï¼Œæˆ‘ä»¬å¸Œæœ›200æ¯«ç§’å¤„ç†å®Œæœ¬æ¬¡ä»»åŠ¡ï¼Œ

å¦‚æœè¶…è¿‡200æ¯«ç§’è¿˜æ²¡å¤„ç†å®Œï¼Œåœ¨æœªæ¥1ç§’é’Ÿçš„æ—¶é—´çª—å£å†…ï¼Œæ–­è·¯å™¨æ‰“å¼€ï¼ˆä¿é™©ä¸è·³é—¸ï¼‰å¾®æœåŠ¡ä¸å¯ç”¨ï¼Œä¿é™©ä¸è·³é—¸æ–­ç”µäº†åç»­æˆ‘åœæ­¢jmeterï¼Œæ²¡æœ‰è¿™ä¹ˆå¤§çš„è®¿é—®é‡äº†ï¼Œæ–­è·¯å™¨å…³é—­ï¼ˆä¿é™©ä¸æ¢å¤ï¼‰ï¼Œå¾®æœåŠ¡æ¢å¤OK



### å¼‚å¸¸æ¯”ä¾‹

å¼‚å¸¸æ¯”ä¾‹ (`ERROR_RATIO`)ï¼šå½“å•ä½ç»Ÿè®¡æ—¶é•¿ï¼ˆ`statIntervalMs`ï¼‰å†…è¯·æ±‚æ•°ç›®å¤§äºè®¾ç½®çš„æœ€å°è¯·æ±‚æ•°ç›®ï¼Œå¹¶ä¸”å¼‚å¸¸çš„æ¯”ä¾‹å¤§äºé˜ˆå€¼ï¼Œåˆ™æ¥ä¸‹æ¥çš„ç†”æ–­æ—¶é•¿å†…è¯·æ±‚ä¼šè‡ªåŠ¨è¢«ç†”æ–­ã€‚ç»è¿‡ç†”æ–­æ—¶é•¿åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼ˆHALF-OPEN çŠ¶æ€ï¼‰ï¼Œè‹¥æ¥ä¸‹æ¥çš„ä¸€ä¸ªè¯·æ±‚æˆåŠŸå®Œæˆï¼ˆæ²¡æœ‰é”™è¯¯ï¼‰åˆ™ç»“æŸç†”æ–­ï¼Œå¦åˆ™ä¼šå†æ¬¡è¢«ç†”æ–­ã€‚å¼‚å¸¸æ¯”ç‡çš„é˜ˆå€¼èŒƒå›´æ˜¯ `[0.0, 1.0]`ï¼Œä»£è¡¨ 0% - 100%ã€‚

![image-20201129164101131](/assets/imgs/image-20201129164101131.png)

é…ç½®ï¼šè¯·æ±‚ä¸­çš„å¼‚å¸¸æ€»æ•°å¤§äº20%æ—¶å€™ï¼Œè§¦å‘ç†”æ–­ï¼Œæ—¶é—´çª—å£ä¸º3ç§’ã€‚

![image-20201129170158836](/assets/imgs/image-20201129170158836.png)

æŒ‰ç…§ä¸Šè¿°é…ç½®ï¼Œå•ç‹¬è®¿é—®ä¸€æ¬¡ï¼Œå¿…ç„¶æ¥ä¸€ æ¬¡æŠ¥é”™ä¸€æ¬¡ï¼ˆint age = 10/0ï¼‰ï¼Œ è°ƒä¸€æ¬¡é”™ä¸€æ¬¡ï¼›

å¼€å¯jmeteråï¼Œç›´æ¥é«˜å¹¶å‘å‘é€è¯·æ±‚ï¼Œå¤šæ¬¡è°ƒç”¨è¾¾åˆ°æˆ‘ä»¬çš„é…ç½®æ¡ä»¶äº†ã€‚æ–­è·¯å™¨å¼€å¯ï¼ˆä¿é™©ä¸è·³é—¸ï¼‰ï¼Œå¾®æœåŠ¡ä¸å¯ç”¨äº†ï¼Œä¸å†æŠ¥é”™errorè€Œæ˜¯æœåŠ¡é™çº§äº†ã€‚



### å¼‚å¸¸æ•°

å¼‚å¸¸æ•° (`ERROR_COUNT`)ï¼šå½“å•ä½ç»Ÿè®¡æ—¶é•¿å†…çš„å¼‚å¸¸æ•°ç›®è¶…è¿‡é˜ˆå€¼ä¹‹åä¼šè‡ªåŠ¨è¿›è¡Œç†”æ–­ã€‚ç»è¿‡ç†”æ–­æ—¶é•¿åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼ˆHALF-OPEN çŠ¶æ€ï¼‰ï¼Œè‹¥æ¥ä¸‹æ¥çš„ä¸€ä¸ªè¯·æ±‚æˆåŠŸå®Œæˆï¼ˆæ²¡æœ‰é”™è¯¯ï¼‰åˆ™ç»“æŸç†”æ–­ï¼Œå¦åˆ™ä¼šå†æ¬¡è¢«ç†”æ–­ã€‚

âš ï¸ ***æ—¶é—´çª—å£ä¸€å®šè¦å¤§äºç­‰äº60ç§’ï¼Œå¼‚å¸¸æ˜¯æŒ‰åˆ†é’Ÿç»Ÿè®¡çš„ã€‚***

![image-20201129175239777](/assets/imgs/image-20201129175239777.png)

# [çƒ­ç‚¹keyé™æµ](https://github.com/alibaba/Sentinel/wiki/çƒ­ç‚¹å‚æ•°é™æµ)

## åŸºæœ¬ä»‹ç»

ä½•ä¸ºçƒ­ç‚¹ï¼Ÿçƒ­ç‚¹å³ç»å¸¸è®¿é—®çš„æ•°æ®ã€‚å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¸Œæœ›ç»Ÿè®¡æŸä¸ªçƒ­ç‚¹æ•°æ®ä¸­è®¿é—®é¢‘æ¬¡æœ€é«˜çš„ Top K æ•°æ®ï¼Œå¹¶å¯¹å…¶è®¿é—®è¿›è¡Œé™åˆ¶ã€‚æ¯”å¦‚ï¼š

- å•†å“ ID ä¸ºå‚æ•°ï¼Œç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…æœ€å¸¸è´­ä¹°çš„å•†å“ ID å¹¶è¿›è¡Œé™åˆ¶
- ç”¨æˆ· ID ä¸ºå‚æ•°ï¼Œé’ˆå¯¹ä¸€æ®µæ—¶é—´å†…é¢‘ç¹è®¿é—®çš„ç”¨æˆ· ID è¿›è¡Œé™åˆ¶

çƒ­ç‚¹å‚æ•°é™æµä¼šç»Ÿè®¡ä¼ å…¥å‚æ•°ä¸­çš„çƒ­ç‚¹å‚æ•°ï¼Œå¹¶æ ¹æ®é…ç½®çš„é™æµé˜ˆå€¼ä¸æ¨¡å¼ï¼Œå¯¹åŒ…å«çƒ­ç‚¹å‚æ•°çš„èµ„æºè°ƒç”¨è¿›è¡Œé™æµã€‚çƒ­ç‚¹å‚æ•°é™æµå¯ä»¥çœ‹åšæ˜¯ä¸€ç§ç‰¹æ®Šçš„æµé‡æ§åˆ¶ï¼Œä»…å¯¹åŒ…å«çƒ­ç‚¹å‚æ•°çš„èµ„æºè°ƒç”¨ç”Ÿæ•ˆã€‚

![image-20201129184421585](/assets/imgs/image-20201129184421585.png)

Sentinel åˆ©ç”¨ LRU ç­–ç•¥ç»Ÿè®¡æœ€è¿‘æœ€å¸¸è®¿é—®çš„çƒ­ç‚¹å‚æ•°ï¼Œç»“åˆä»¤ç‰Œæ¡¶ç®—æ³•æ¥è¿›è¡Œå‚æ•°çº§åˆ«çš„æµæ§ã€‚çƒ­ç‚¹å‚æ•°é™æµæ”¯æŒé›†ç¾¤æ¨¡å¼ã€‚



## æ‰¿ä¸Šå¯ä¸‹å¤ä¹ start

å…œåº•æ–¹æ³•

åˆ†ä¸ºç³»ç»Ÿé»˜è®¤å’Œå®¢æˆ·è‡ªå®šä¹‰ï¼Œä¸¤ç§ï¼š

ä¹‹å‰çš„caseï¼Œé™æµå‡ºé—®é¢˜åï¼Œéƒ½æ˜¯ç”¨sentinelç³»ç»Ÿé»˜è®¤çš„æç¤º: Blocked by Sentinel ï¼ˆflow limitingï¼‰

æˆ‘ä»¬èƒ½ä¸èƒ½è‡ªå®šï¼Ÿç±»ä¼¼hystrixï¼ŒæŸä¸ªæ–¹æ³•å‡ºé—®é¢˜äº†ï¼Œå°±æ‰¾å¯¹åº”çš„å…œåº•é™çº§æ–¹æ³•ï¼Ÿ

ç»“è®º.

ä»HystrixCommandåˆ°@SentnelResourceã€‚



## ä»£ç é…ç½®ä¸æµ‹è¯•

1.FlowLimitControllerä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•

```java
@GetMapping("/testHotKey")
@SentinelResource(value = "testHotKey",blockHandler = "deal_testHotKey") // valueå¯ä¸ºå”¯ä¸€çš„ä»»æ„å€¼
public String testHotKey(@RequestParam(value = "p1",required = false) String p1,
                         @RequestParam(value = "p2",required = false) String p2){
  return "-------testHotKey";
}

public String deal_testHotKey(String p1, String p2, BlockException exception){
  return "----deal_testHotKey,ğŸ˜ˆ"; //sentinelç³»ç»Ÿé»˜è®¤çš„æç¤º: Blocked by Sentinel ï¼ˆflow limitingï¼‰
}
```

2.æ–°å¢çƒ­ç‚¹è§„åˆ™

æ–¹æ³•testHostKeyé‡Œé¢ç¬¬0ä¸ªå‚æ•°`p1`åªè¦QPSè¶…è¿‡æ¯ç§’1æ¬¡ï¼Œé©¬ä¸Šé™çº§å¤„ç†`deal_testHotKey()`ã€‚

![image-20201129191336955](/assets/imgs/image-20201129191336955.png)

3.æµ‹è¯•ç»“æœ

![image-20201129191716190](/assets/imgs/image-20201129191716190.png)

## å‚æ•°ä¾‹å¤–é¡¹

ä¸Šè¿°æ¡ˆä¾‹æ¼”ç¤ºäº†ç¬¬ä¸€ä¸ªå‚æ•°p1,å½“QPSè¶…è¿‡1ç§’1æ¬¡ç‚¹å‡»åé©¬ä¸Šè¢«é™æµ

1.ç‰¹æ®Šæƒ…å†µ

- æ™®é€š è¶…è¿‡1ç§’é’Ÿä¸€ä¸ªåï¼Œè¾¾åˆ°é˜ˆå€¼1åé©¬ä¸Šè¢«é™æµ
- æˆ‘ä»¬æœŸæœ›p1å‚æ•°å½“å®ƒæ˜¯æŸä¸ªç‰¹æ®Šå€¼æ—¶ï¼Œå®ƒçš„é™æµå€¼å’Œå¹³æ—¶ä¸ä¸€æ ·
- ç‰¹ä¾‹ï¼šå‡å¦‚å½“p1çš„å€¼ç­‰äº5æ—¶ï¼Œå®ƒçš„é˜ˆå€¼å¯ä»¥è¾¾åˆ°200

2.é…ç½®ï¼Œæ·»åŠ æŒ‰é’®ä¸èƒ½å¿˜

å‰ææ¡ä»¶ï¼šçƒ­ç‚¹å‚æ•°çš„æ³¨æ„ç‚¹ï¼Œå‚æ•°å¿…é¡»æ˜¯åŸºæœ¬ç±»å‹æˆ–è€…String

âš ï¸ ***è¿è¡Œæ—¶çš„å¼‚å¸¸ä¸ä¼šè¿›è¡Œå…œåº•ï¼Œä»ç„¶ä¼šæŠ¥é”™ã€‚***

![image-20201129193232237](/assets/imgs/image-20201129193232237.png)

## æ³¨æ„äº‹é¡¹

`@SentinelResource`å¤„ç†çš„æ˜¯Sent inelæ§åˆ¶å°é…ç½®çš„è¿è§„æƒ…å†µï¼Œæœ‰blockHandleræ–¹æ³•é… ç½®çš„å…œåº•å¤„ç†ï¼›

**RuntimeException(å¦‚int age = 10/0ï¼‰**ï¼Œè¿™ä¸ªæ˜¯javaè¿è¡Œæ—¶æŠ¥å‡ºçš„è¿è¡Œæ—¶å¼‚å¸¸RunTimeExceptionï¼Œ @SentinelResourceä¸ç®¡

***æ€»ç»“: `@SentinelResource`ä¸»ç®¡é…ç½®å‡ºé”™ï¼Œè¿è¡Œå‡ºé”™è¯¥èµ°å¼‚å¸¸èµ°å¼‚å¸¸***



# [ç³»ç»Ÿè§„åˆ™](https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81)

Sentinel ç³»ç»Ÿè‡ªé€‚åº”é™æµä»æ•´ä½“ç»´åº¦å¯¹**åº”ç”¨å…¥å£æµé‡è¿›è¡Œæ§åˆ¶**ï¼Œç»“åˆåº”ç”¨çš„ Loadã€CPU ä½¿ç”¨ç‡ã€æ€»ä½“å¹³å‡ RTã€å…¥å£ QPS å’Œå¹¶å‘çº¿ç¨‹æ•°ç­‰å‡ ä¸ªç»´åº¦çš„ç›‘æ§æŒ‡æ ‡ï¼Œé€šè¿‡è‡ªé€‚åº”çš„æµæ§ç­–ç•¥ï¼Œè®©ç³»ç»Ÿçš„å…¥å£æµé‡å’Œç³»ç»Ÿçš„è´Ÿè½½è¾¾åˆ°ä¸€ä¸ªå¹³è¡¡ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½è·‘åœ¨æœ€å¤§ååé‡çš„åŒæ—¶ä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§ã€‚

**ç³»ç»Ÿä¿æŠ¤è§„åˆ™**æ˜¯ä»åº”ç”¨çº§åˆ«çš„å…¥å£æµé‡è¿›è¡Œæ§åˆ¶ï¼Œä»å•å°æœºå™¨çš„ loadã€CPU ä½¿ç”¨ç‡ã€å¹³å‡ RTã€å…¥å£ QPS å’Œå¹¶å‘çº¿ç¨‹æ•°ç­‰å‡ ä¸ªç»´åº¦ç›‘æ§åº”ç”¨æŒ‡æ ‡ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½è·‘åœ¨æœ€å¤§ååé‡çš„åŒæ—¶ä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§ã€‚

ç³»ç»Ÿä¿æŠ¤è§„åˆ™æ˜¯åº”ç”¨æ•´ä½“ç»´åº¦çš„ï¼Œè€Œä¸æ˜¯èµ„æºç»´åº¦çš„ï¼Œå¹¶ä¸”**ä»…å¯¹å…¥å£æµé‡ç”Ÿæ•ˆ**ã€‚å…¥å£æµé‡æŒ‡çš„æ˜¯è¿›å…¥åº”ç”¨çš„æµé‡ï¼ˆ`EntryType.IN`ï¼‰ï¼Œæ¯”å¦‚ Web æœåŠ¡æˆ– Dubbo æœåŠ¡ç«¯æ¥æ”¶çš„è¯·æ±‚ï¼Œéƒ½å±äºå…¥å£æµé‡ã€‚

ç³»ç»Ÿè§„åˆ™æ”¯æŒä»¥ä¸‹çš„æ¨¡å¼ï¼š

- **Load è‡ªé€‚åº”**ï¼ˆä»…å¯¹ Linux/Unix-like æœºå™¨ç”Ÿæ•ˆï¼‰ï¼šç³»ç»Ÿçš„ load1 ä½œä¸ºå¯å‘æŒ‡æ ‡ï¼Œè¿›è¡Œè‡ªé€‚åº”ç³»ç»Ÿä¿æŠ¤ã€‚å½“ç³»ç»Ÿ load1 è¶…è¿‡è®¾å®šçš„å¯å‘å€¼ï¼Œä¸”ç³»ç»Ÿå½“å‰çš„å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡ä¼°ç®—çš„ç³»ç»Ÿå®¹é‡æ—¶æ‰ä¼šè§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼ˆBBR é˜¶æ®µï¼‰ã€‚ç³»ç»Ÿå®¹é‡ç”±ç³»ç»Ÿçš„ `maxQps * minRt` ä¼°ç®—å¾—å‡ºã€‚è®¾å®šå‚è€ƒå€¼ä¸€èˆ¬æ˜¯ `CPU cores * 2.5`ã€‚
- **CPU usage**ï¼ˆ1.5.0+ ç‰ˆæœ¬ï¼‰ï¼šå½“ç³»ç»Ÿ CPU ä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼ˆå–å€¼èŒƒå›´ 0.0-1.0ï¼‰ï¼Œæ¯”è¾ƒçµæ•ã€‚
- **å¹³å‡ RT**ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹³å‡ RT è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚
- **å¹¶å‘çº¿ç¨‹æ•°**ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹¶å‘çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚
- **å…¥å£ QPS**ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„ QPS è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚



# @SentinelResource

## æŒ‰èµ„æºåç§°é™æµ + åç»­å¤„ç†

1.å¯åŠ¨Nacoså’ŒSentinelæˆåŠŸ

2.æ‰“å¼€Module [cloudalibaba-sentinel-service8401](https://github.com/Silincee/springcloud2020/tree/main/cloudalibaba-sentinel-service8401)

- YML

```yml
server:
  port: 8401

spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #NacosæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€
    sentinel:
      transport:
        dashboard: localhost:8080 #é…ç½®Sentinel dashboardåœ°å€
        port: 8719 # é»˜è®¤8719ç«¯å£ï¼ŒåŠ å…¥è¢«å ç”¨ä¼šä»8719å¼€å§‹ä¾æ¬¡+1æ‰«æï¼Œç›´è‡³æ‰¾åˆ°ä¸ºè¢«å ç”¨é¥¿çš„ç«¯å£

management:
  endpoints:
    web:
      exposure:
        include: '*'
```

- ä¸šåŠ¡ç±»RateLimitController

```java
public class RateLimitController {

    @GetMapping("/byResource")
    @SentinelResource(value = "byResource",blockHandler = "handleException")
    public CommonResult byResource(){
        return new CommonResult(200,"æŒ‰èµ„æºåç§°é™æµæµ‹è¯•ok",new Payment(2020L,"serial001"));
    }

    public CommonResult handleException(BlockException exception){
        return new CommonResult(444,exception.getClass().getCanonicalName()+"\t æœåŠ¡ä¸å¯ç”¨");
    }
}
```

3.é…ç½®æµæ§è§„åˆ™

è¡¨ç¤º1ç§’é’Ÿå†…æŸ¥è¯¢æ¬¡æ•°å¤§äº1ï¼Œå°±è·‘åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„å¤„æµï¼Œé™æµ

![image-20201129201329196](/assets/imgs/image-20201129201329196.png)

4.æµ‹è¯• http://localhost:8401/byResource

- 1ç§’é’Ÿç‚¹å‡»1ä¸‹ï¼ŒOK
- è¶…è¿‡ä¸Šè¿°é—®é¢˜ï¼Œç–¯ç‹‚ç‚¹å‡»ï¼Œè¿”å›äº†è‡ªå·±å®šä¹‰çš„é™æµå¤„ç†ä¿¡æ¯ï¼Œé™æµå‘é€

## é¢å¤–é—®é¢˜

æ­¤æ—¶å…³é—­å¾®æœåŠ¡8401çœ‹çœ‹,Sentinelæ§åˆ¶å°ï¼Œæµæ§è§„åˆ™æ¶ˆå¤±äº†ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ

ä¸´æ—¶/æŒä¹…ï¼Ÿ



## æŒ‰ç…§Urlåœ°å€é™æµ + åç»­å¤„ç†

é€šè¿‡è®¿é—®çš„URLæ¥é™æµï¼Œä¼šè¿”å›Sentinelè‡ªå¸¦é»˜è®¤çš„é™æµå¤„ç†ä¿¡æ¯

- ä¸šåŠ¡ç±»RateLimitController, `/byUrl`æ— å…œåº•æ–¹æ³•ï¼Œå°†ä¼šé‡‡ç”¨ç³»ç»Ÿé»˜è®¤çš„ã€‚

```java
@RestController
public class RateLimitController {

    @GetMapping("/byResource")
    @SentinelResource(value = "byResource",blockHandler = "handleException")
    public CommonResult byResource(){
        return new CommonResult(200,"æŒ‰èµ„æºåç§°é™æµæµ‹è¯•ok",new Payment(2020L,"serial001"));
    }

    public CommonResult handleException(BlockException exception){
        return new CommonResult(444,exception.getClass().getCanonicalName()+"\t æœåŠ¡ä¸å¯ç”¨");
    }

    @GetMapping("/rateLimit/byUrl")
    @SentinelResource(value = "byUrl")
    public CommonResult byUrl(){
        return new CommonResult(200,"æŒ‰urlé™æµæµ‹è¯•ok",new Payment(2020L,"serial002"));
    }
}
```

- Sentinelæ§åˆ¶å°é…ç½®

![image-20201129202324589](/assets/imgs/image-20201129202324589.png)

- æµ‹è¯•ç»“æœï¼Œä¼šè¿”å›sentielè‡ªå¸¦çš„æœåŠ¡é™æµç»“æœ

![image-20201129202437317](/assets/imgs/image-20201129202437317.png)

## ä¸Šé¢å…œåº•æ–¹æ³•é¢ä¸´çš„é—®é¢˜

- ç³»ç»Ÿé»˜è®¤çš„ï¼Œæ²¡æœ‰ä½“ç°æˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡è¦æ±‚ã€‚
- ä¾ç…§ç°æœ‰æ¡ä»¶ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„å¤„ç†æ–¹æ³•åˆå’Œä¸šåŠ¡ä»£ç è€¦åˆåœ¨ä¸€å—ï¼Œä¸ç›´è§‚ã€‚
- æ¯ä¸ªä¸šåŠ¡æ–¹æ³•éƒ½æ·»åŠ ä¸€ä¸ªå…œåº•çš„ï¼Œé‚£ä»£ç è†¨èƒ€åŠ å‰§ã€‚
- å…¨å±€ç»Ÿä¸€ çš„å¤„ç†æ–¹æ³•æ²¡æœ‰ä½“ç°ã€‚



## å®¢æˆ·è‡ªå®šä¹‰é™æµå¤„ç†é€»è¾‘

1.åˆ›å»ºcustomerBlockHandlerç±»ç”¨äºè‡ªå®šä¹‰é™æµå¤„ç†é€»è¾‘

2.è‡ªå®šä¹‰é™æµå¤„ç†ç±» CustomerBlockHandler

```java
public class CustomerBlockHandler {

    public static CommonResult handlerException(BlockException exception){
        return new CommonResult(4444,"æŒ‰å®¢æˆ·è‡ªå®šä¹‰ï¼Œglobal handlerException---1");
    }

    public static CommonResult handlerException2(BlockException exception){
        return new CommonResult(4444,"æŒ‰å®¢æˆ·è‡ªå®šä¹‰ï¼Œglobal handlerException---2");
    }
}
```

3.RateLimitController

```java
@GetMapping("/rateLimit/customerBlockHandler")
@SentinelResource(value = "customerBlockHandler",
                  blockHandlerClass = CustomerBlockHandler.class,
                  blockHandler = "handlerException2")
public CommonResult customerBlockHandler(){
  return new CommonResult(200,"æŒ‰å®¢æˆ·è‡ªå®šä¹‰",new Payment(2020L,"serial003"));
}
```

4.å¯åŠ¨å¾®æœåŠ¡åå…ˆè°ƒç”¨ä¸€æ¬¡ http://localhost:8401/rateLimit/customerBlockHandler

5.Sentinelæ§åˆ¶å°é…ç½®

![image-20201129203833705](/assets/imgs/image-20201129203833705.png)

6.æµ‹è¯•ç»“æœ

![image-20201129203818937](/assets/imgs/image-20201129203818937.png)

7.è§£é‡Šè¯´æ˜

![image-20201129203931854](/assets/imgs/image-20201129203931854.png)



## [æ›´å¤šæ³¨è§£å±æ€§è¯´æ˜](https://github.com/alibaba/Sentinel/wiki/æ³¨è§£æ”¯æŒ)

Sentinelä¸»è¦æœ‰ä¸‰ä¸ªæ ¸å¿ƒAPI(äº†è§£ï¼Œä¸€èˆ¬ä¸ä¼šç”¨ä»£ç å½¢å¼é…ç½®):

- SphUå®šä¹‰èµ„æº
- Tracerå®šä¹‰ç»Ÿè®¡
- ContextUtilå®šä¹‰äº†ä¸Šä¸‹æ–‡



# æœåŠ¡ç†”æ–­åŠŸèƒ½

1.sentinelæ•´åˆribbon+openFeign+fallback

2.å¯åŠ¨nacoså’Œsentinel

## 3.Ribbonç³»åˆ—

- æä¾›è€…9003/9004
  - æ–°å»º[cloudalibaba-provider-payment9003](https://github.com/Silincee/springcloud2020/tree/main/cloudalibaba-provider-payment9003)/[9004](https://github.com/Silincee/springcloud2020/tree/main/cloudalibaba-provider-payment9004)
  - æµ‹è¯•åœ°å€ http://localhost:9003/paymentSQL/1

- æ¶ˆè´¹è€…84

  - æ–°å»º[cloudalibaba-consumer-nacos-order84](https://github.com/Silincee/springcloud2020/tree/main/cloudalibaba-consumer-nacos-order84/src/main/java/cn/silince/springcloud/alibaba)

  - ä¸šåŠ¡ç±»ApplicationContextConfig

  - ä¸šåŠ¡ç±»CircleBreakerControllerçš„å…¨éƒ¨æºç 

    1ï¼‰ä¿®æ”¹åè¯·é‡å¯å¾®æœåŠ¡ã€‚çƒ­éƒ¨ç½²å¯¹javaä»£ç çº§ç”Ÿæ•ˆåŠæ—¶ï¼Œå¯¹@SentinelResourceæ³¨è§£å†…å±æ€§ï¼Œæœ‰æ—¶æ•ˆæœä¸å¥½

    2ï¼‰ç›®çš„ï¼šfallbackç®¡è¿è¡Œå¼‚å¸¸ / blockHandlerç®¡é…ç½®è¿è§„

    3ï¼‰æµ‹è¯•åœ°å€ http://localhost:84/consumer/fallback/1 è½®è®­è®¿é—®ok

    4ï¼‰æ²¡æœ‰ä»»ä½•é…ç½® ç»™å®¢æˆ·erroré¡µé¢ï¼Œä¸å‹å¥½  http://localhost:84/consumer/fallback/4

    5ï¼‰åªé…ç½®fallbackã€‚åªè´Ÿè´£ä¸šåŠ¡å¼‚å¸¸

    6ï¼‰åªé…ç½®blockHandlerã€‚åªè´Ÿè´£sentinelæ§åˆ¶å°é…ç½®è¿è§„

    7ï¼‰fallbackå’ŒblockHandleréƒ½é…ç½®ã€‚***è‹¥blockHandlerå’Œfallbackéƒ½è¿›è¡Œäº†é…ç½®ï¼Œåˆ™è¢«é™æµé™çº§ä¸”æŠ›å‡ºBlockExceptionæ—¶åªä¼šè¿›å…¥blockHandlerå¤„ç†é€»è¾‘ã€‚***

    8ï¼‰å¼‚å¸¸å¿½ç•¥å±æ€§`exceptionsToIgnore`  

    ![image-20201129214848313](/assets/imgs/image-20201129214848313.png) 

```java
@RequestMapping("/consumer/fallback/{id}")
//@SentinelResource(value = "fallback") //æ²¡æœ‰é…ç½®
//@SentinelResource(value = "fallback",fallback = "handlerFallback") //fallbackåªè´Ÿè´£ä¸šåŠ¡å¼‚å¸¸
//@SentinelResource(value = "fallback",blockHandler = "blockHandler") //blockHandleråªè´Ÿè´£sentinelæ§åˆ¶å°é…ç½®è¿è§„
@SentinelResource(value = "fallback",fallback = "handlerFallback",blockHandler = "blockHandler",exceptionsToIgnore = {IllegalArgumentException.class})
public CommonResult<Payment> fallback(@PathVariable Long id)
{
  CommonResult<Payment> result = restTemplate.getForObject(SERVICE_URL + "/paymentSQL/"+id, CommonResult.class,id);

  if (id == 4) {
    throw new IllegalArgumentException ("IllegalArgumentException,éæ³•å‚æ•°å¼‚å¸¸....");
  }else if (result.getData() == null) {
    throw new NullPointerException ("NullPointerException,è¯¥IDæ²¡æœ‰å¯¹åº”è®°å½•,ç©ºæŒ‡é’ˆå¼‚å¸¸");
  }

  return result;
}
//æœ¬ä¾‹æ˜¯fallback
public CommonResult handlerFallback(@PathVariable  Long id,Throwable e) {
  Payment payment = new Payment(id,"null");
  return new CommonResult<>(444,"å…œåº•å¼‚å¸¸handlerFallback,exceptionå†…å®¹  "+e.getMessage(),payment);
}
//æœ¬ä¾‹æ˜¯blockHandler
public CommonResult blockHandler(@PathVariable  Long id,BlockException blockException) {
  Payment payment = new Payment(id,"null");
  return new CommonResult<>(445,"blockHandler-sentinelé™æµ,æ— æ­¤æµæ°´: blockException  "+blockException.getMessage(),payment);
}
```



![image-20201129210045034](/assets/imgs/image-20201129210045034.png)

## 4.Feignç³»åˆ—

1ï¼‰ä¿®æ”¹84æ¨¡å—ã€‚84æ¶ˆè´¹è€…è°ƒç”¨æä¾›è€…9003ï¼ŒFeigné€æ¸ä¸€èˆ¬æ˜¯æ¶ˆè´¹ä¾§

- POM å¼•å…¥

```xml
<!--SpringCloud openfeign -->
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

- YML

```yml
# æ¿€æ´»Sentinelå¯¹Feignçš„æ”¯æŒ
feign:
  sentinel:
    enabled: true
```

- ä¸»å¯åŠ¨ æ·»åŠ @EnableFeignClientså¯åŠ¨Feignçš„åŠŸèƒ½
- ä¸šåŠ¡ç±»
  - [å¸¦@FeignClientæ³¨è§£çš„ä¸šåŠ¡æ¥å£](https://github.com/Silincee/springcloud2020/blob/main/cloudalibaba-consumer-nacos-order84/src/main/java/cn/silince/springcloud/alibaba/service/PaymentService.java) fallback = PaymentFallbackService.class
  - [PaymentFallbackServiceå®ç°ç±»](https://github.com/Silincee/springcloud2020/blob/main/cloudalibaba-consumer-nacos-order84/src/main/java/cn/silince/springcloud/alibaba/service/PaymentFallbackService.java)
  - [Controller](https://github.com/Silincee/springcloud2020/blob/main/cloudalibaba-consumer-nacos-order84/src/main/java/cn/silince/springcloud/alibaba/controller/CircleBreakerController.java)

2ï¼‰æµ‹è¯•

- http://localhost:84/consumer/paymentSQL/1
- æµ‹è¯•84è°ƒç”¨9003ï¼Œ**æ­¤æ—¶æ•…æ„å…³é—­9003å¾®æœåŠ¡æä¾›è€…**ï¼Œçœ‹84æ¶ˆè´¹ä¾§è‡ªåŠ¨é™çº§ï¼Œä¸ä¼šè¢«è€—æ­»



## ç†”æ–­æ¡†æ¶æ¯”è¾ƒ

|                | Sentinel                                                   | Hystrix               | resilience4j                     |
| -------------- | ---------------------------------------------------------- | --------------------- | -------------------------------- |
| éš”ç¦»ç­–ç•¥       | ä¿¡å·é‡éš”ç¦»(å¹¶å‘ç°çº¿ç¨‹æ•°é™æµ)                               | çº¿ç¨‹æ± éš”ç¦»/ä¿¡å·é‡éš”ç¦» | ä¿¡å·é‡éš”ç¦»                       |
| ç†”æ–­é™çº§ç­–ç•¥   | åŸºäºå“åº”æ—¶é—´ã€å¼‚å¸¸æ¯”ç‡ã€å¼‚å¸¸æ•°                             | åŸºäºå¼‚å¸¸æ¯”ç‡          | åŸºäºå¼‚å¸¸æ¯”ç‡ã€å“åº”æ—¶é—´           |
| å®æ—¶ç»Ÿè®¡å®ç°   | æ»‘åŠ¨çª—å£(LeapArray)                                        | æ»‘åŠ¨çª—å£(RxJava)      | Ring Bit Buffer                  |
| åŠ¨æ€è§„åˆ™é…ç½®   | æ”¯æŒå¤šç§æ•°æ®æº                                             | æ”¯æŒå¤šç§æ•°æ®æº        | æœ‰é™æ”¯æŒ                         |
| æ‰©å±•æ€§         | å¤šä¸ªæ‰©å±•ç‚¹                                                 | æ’ä»¶çš„å½¢å¼            | æ¥å£çš„å½¢å¼                       |
| åŸºäºæ³¨è§£çš„æ”¯æŒ | æ”¯æŒ                                                       | æ”¯æŒ                  | æ”¯æŒ                             |
| é™æµ           | åŸºäºQPSã€æ”¯æŒåŸºäºè°ƒç”¨å…³ç³»çš„é™æµ                            | æœ‰é™çš„æ”¯æŒ            | Rate Limiter                     |
| æµé‡æ•´å½¢       | æ”¯æŒé¢„çƒ­æ¨¡å¼ã€åŒ€é€Ÿå™¨æ¨¡å¼ã€é¢„çƒ­æ’é˜Ÿæ¨¡å¼                     | ä¸æ”¯æŒ                | ç®€å•çš„Rate Limiteræ¨¡å¼           |
| ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ | æ”¯æŒ                                                       | ä¸æ”¯æŒ                | ä¸æ”¯æŒ                           |
| æ§åˆ¶å°         | æä¾›å¼€ç®±å³ç”¨çš„æ§åˆ¶å°ï¼Œå¯é…ç½®è§„åˆ™ã€æŸ¥çœ‹ç§’çº§ç›‘æ§ã€æœºå™¨å‘ç°ç­‰ | ç®€å•çš„ç›‘æ§æŸ¥çœ‹        | ä¸æä¾›æ§åˆ¶å°ï¼Œå¯å¯¹æ¥å…¶ä»–ç›‘æ§ç³»ç»Ÿ |





# è§„åˆ™æŒä¹…åŒ–

ä¸€æ—¦æˆ‘ä»¬é‡å¯åº”ç”¨ï¼Œsentinelè§„åˆ™å°†æ¶ˆå¤±ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦å°†é…ç½®è§„åˆ™è¿›è¡ŒæŒä¹…åŒ–ã€‚

å°†é™æµé…ç½®è§„åˆ™æŒä¹…åŒ–è¿›Nacosä¿å­˜ï¼Œåªè¦åˆ·æ–°8401æŸä¸ªreståœ°å€ï¼Œ sentinelæ§åˆ¶å°çš„æµæ§è§„åˆ™å°±èƒ½çœ‹åˆ°ï¼Œåªè¦Nacosé‡Œé¢çš„é…ç½®ä¸åˆ é™¤ï¼Œé’ˆå¯¹8401ä¸Šçš„sentinelæµæ§è§„åˆ™æŒç»­æœ‰æ•ˆã€‚

1.ä¿®æ”¹cloudalibaba-sentinel-service8401

2.POM

```xml
<!--SpringCloud ailibaba sentinel-datasource-nacos åç»­åšæŒä¹…åŒ–ç”¨åˆ°-->
<dependency>
  <groupId>com.alibaba.csp</groupId>
  <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

3.YML

```yml
spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #NacosæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€
    sentinel:
      transport:
        dashboard: localhost:8080 #é…ç½®Sentinel dashboardåœ°å€
        port: 8719 # é»˜è®¤8719ç«¯å£ï¼ŒåŠ å…¥è¢«å ç”¨ä¼šä»8719å¼€å§‹ä¾æ¬¡+1æ‰«æï¼Œç›´è‡³æ‰¾åˆ°ä¸ºè¢«å ç”¨é¥¿çš„ç«¯å£
      datasource: # æ·»åŠ Nacosæ•°æ®æºé…ç½®
        ds1:
          nacos:
            server-addr: localhost:8848
            dataId: cloudalibaba-sentinel-service
            groupId: DEFAULT_GROUP
            data-type: json
            rule-type: flow
```

4.æ·»åŠ Nacosä¸šåŠ¡è§„åˆ™é…ç½®

- resource : èµ„æºåç§°ï¼› 
- limitApp:æ¥æºåº”ç”¨ï¼›
- grade:é˜ˆå€¼ç±»å‹ï¼Œ0è¡¨ç¤ºçº¿ç¨‹æ•°ï¼Œ1è¡¨ç¤ºQPSï¼›
- count:å•æœºé˜ˆå€¼ï¼›
- strategy:æµæ§æ¨¡å¼ï¼Œ0è¡¨ç¤ºç›´æ¥ï¼Œ1è¡¨ç¤ºå…³è”ï¼Œ2è¡¨ç¤ºé“¾è·¯ï¼›
- controlBehavior:æµæ§æ•ˆæœï¼Œ0è¡¨ç¤ºå¿«é€Ÿå¤±è´¥ï¼Œ1è¡¨ç¤ºWarm Upï¼Œ 2è¡¨ç¤ºæ’é˜Ÿç­‰å¾…ï¼›
- clusterMode:æ˜¯å¦é›†ç¾¤ã€‚

![image-20201129223334063](/assets/imgs/image-20201129223334063.png)

5.å¯åŠ¨8401ååˆ·æ–°sentinelå‘ç°ä¸šåŠ¡è§„åˆ™æœ‰äº†

![image-20201129223506981](/assets/imgs/image-20201129223506981.png)

6.å¿«é€Ÿè®¿é—®æµ‹è¯•æ¥å£

7.åœæ­¢8401å†çœ‹sentinel

8.é‡æ–°å¯åŠ¨8401å†çœ‹sentinel

- ä¹ä¸€çœ‹è¿˜æ˜¯æ²¡æœ‰ï¼Œç¨ç­‰ä¸€ä¼šå„¿
- å¤šæ¬¡è°ƒç”¨ http://localhost:8401/rateLimit/byUrl
- é‡æ–°é…ç½®å‡ºç°äº†ï¼ŒæŒä¹…åŒ–éªŒè¯é€šè¿‡