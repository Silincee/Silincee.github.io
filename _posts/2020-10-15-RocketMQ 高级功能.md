---
layout: post
title:  "RocketMQ é«˜çº§åŠŸèƒ½"
date:   2020-10-15 17:04:06 +0800--
categories: [Java, åˆ†å¸ƒå¼]
tags: [Java, æ¶ˆæ¯é˜Ÿåˆ—]  

---

# é«˜çº§åŠŸèƒ½

## æ¶ˆæ¯å­˜å‚¨

åˆ†å¸ƒå¼é˜Ÿåˆ—å› ä¸ºæœ‰é«˜å¯é æ€§çš„è¦æ±‚ï¼Œæ‰€ä»¥æ•°æ®è¦è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ã€‚

![](/assets/imgs/æ¶ˆæ¯å­˜å‚¨æ–¹å¼.png)

1. æ¶ˆæ¯ç”Ÿæˆè€…å‘é€æ¶ˆæ¯
2. **MQæ”¶åˆ°æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–ï¼Œåœ¨å­˜å‚¨ä¸­æ–°å¢ä¸€æ¡è®°å½•**
3. è¿”å›ACKç»™ç”Ÿäº§è€…
4. MQ push æ¶ˆæ¯ç»™å¯¹åº”çš„æ¶ˆè´¹è€…ï¼Œç„¶åç­‰å¾…æ¶ˆè´¹è€…è¿”å›ACK
5. å¦‚æœæ¶ˆæ¯æ¶ˆè´¹è€…åœ¨æŒ‡å®šæ—¶é—´å†…æˆåŠŸè¿”å›ackï¼Œé‚£ä¹ˆMQè®¤ä¸ºæ¶ˆæ¯æ¶ˆè´¹æˆåŠŸï¼Œåœ¨å­˜å‚¨ä¸­åˆ é™¤æ¶ˆæ¯ï¼Œå³æ‰§è¡Œç¬¬6æ­¥ï¼›å¦‚æœMQåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ACKï¼Œåˆ™è®¤ä¸ºæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ï¼Œä¼šå°è¯•é‡æ–°pushæ¶ˆæ¯,é‡å¤æ‰§è¡Œ4ã€5ã€6æ­¥éª¤
6. MQåˆ é™¤æ¶ˆæ¯

### å­˜å‚¨ä»‹è´¨

* å…³ç³»å‹æ•°æ®åº“DB

Apacheä¸‹å¼€æºçš„å¦å¤–ä¸€æ¬¾MQâ€”ActiveMQï¼ˆé»˜è®¤é‡‡ç”¨çš„KahaDBåšæ¶ˆæ¯å­˜å‚¨ï¼‰å¯é€‰ç”¨JDBCçš„æ–¹å¼æ¥åšæ¶ˆæ¯æŒä¹…åŒ–ï¼Œé€šè¿‡ç®€å•çš„xmlé…ç½®ä¿¡æ¯å³å¯å®ç°JDBCæ¶ˆæ¯å­˜å‚¨ã€‚ç”±äºï¼Œæ™®é€šå…³ç³»å‹æ•°æ®åº“ï¼ˆå¦‚Mysqlï¼‰åœ¨å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§åˆ«çš„æƒ…å†µä¸‹ï¼Œå…¶IOè¯»å†™æ€§èƒ½å¾€å¾€ä¼šå‡ºç°ç“¶é¢ˆã€‚åœ¨å¯é æ€§æ–¹é¢ï¼Œè¯¥ç§æ–¹æ¡ˆéå¸¸ä¾èµ–DBï¼Œå¦‚æœä¸€æ—¦DBå‡ºç°æ•…éšœï¼Œåˆ™MQçš„æ¶ˆæ¯å°±æ— æ³•è½ç›˜å­˜å‚¨ä¼šå¯¼è‡´çº¿ä¸Šæ•…éšœ

![](/assets/imgs/MySQL.png)

- æ–‡ä»¶ç³»ç»Ÿ

  **ç›®å‰ä¸šç•Œè¾ƒä¸ºå¸¸ç”¨çš„å‡ æ¬¾äº§å“ï¼ˆRocketMQ/Kafka/RabbitMQï¼‰å‡é‡‡ç”¨çš„æ˜¯æ¶ˆæ¯åˆ·ç›˜è‡³æ‰€éƒ¨ç½²è™šæ‹Ÿæœº/ç‰©ç†æœºçš„æ–‡ä»¶ç³»ç»Ÿæ¥åšæŒä¹…åŒ–ï¼ˆåˆ·ç›˜ä¸€èˆ¬å¯ä»¥åˆ†ä¸ºå¼‚æ­¥åˆ·ç›˜å’ŒåŒæ­¥åˆ·ç›˜ä¸¤ç§æ¨¡å¼ï¼‰ã€‚**æ¶ˆæ¯åˆ·ç›˜ä¸ºæ¶ˆæ¯å­˜å‚¨æä¾›äº†ä¸€ç§é«˜æ•ˆç‡ã€é«˜å¯é æ€§å’Œé«˜æ€§èƒ½çš„æ•°æ®æŒä¹…åŒ–æ–¹å¼ã€‚é™¤ééƒ¨ç½²MQæœºå™¨æœ¬èº«æˆ–æ˜¯æœ¬åœ°ç£ç›˜æŒ‚äº†ï¼Œå¦åˆ™ä¸€èˆ¬æ˜¯ä¸ä¼šå‡ºç°æ— æ³•æŒä¹…åŒ–çš„æ•…éšœé—®é¢˜ã€‚

  ![](/assets/imgs/ç£ç›˜.png)


###æ€§èƒ½å¯¹æ¯”

**æ–‡ä»¶ç³»ç»Ÿ>å…³ç³»å‹æ•°æ®åº“DB**

### æ¶ˆæ¯çš„å­˜å‚¨å’Œå‘é€

#### æ¶ˆæ¯å­˜å‚¨

ç£ç›˜å¦‚æœä½¿ç”¨å¾—å½“ï¼Œç£ç›˜çš„é€Ÿåº¦å®Œå…¨å¯ä»¥åŒ¹é…ä¸Šç½‘ç»œ çš„æ•°æ®ä¼ è¾“é€Ÿåº¦ã€‚ç›®å‰çš„é«˜æ€§èƒ½ç£ç›˜ï¼Œé¡ºåºå†™é€Ÿåº¦å¯ä»¥è¾¾åˆ°600MB/sï¼Œ è¶…è¿‡äº†ä¸€èˆ¬ç½‘å¡çš„ä¼ è¾“é€Ÿåº¦ã€‚ä½†æ˜¯ç£ç›˜éšæœºå†™çš„é€Ÿåº¦åªæœ‰å¤§æ¦‚100KB/sï¼Œå’Œé¡ºåºå†™çš„æ€§èƒ½ç›¸å·®6000å€ï¼å› ä¸ºæœ‰å¦‚æ­¤å·¨å¤§çš„é€Ÿåº¦å·®åˆ«ï¼Œå¥½çš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿä¼šæ¯”æ™®é€šçš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿé€Ÿåº¦å¿«å¤šä¸ªæ•°é‡çº§ã€‚RocketMQçš„æ¶ˆæ¯ç”¨é¡ºåºå†™,ä¿è¯äº†æ¶ˆæ¯å­˜å‚¨çš„é€Ÿåº¦ã€‚

####æ¶ˆæ¯å‘é€

Linuxæ“ä½œç³»ç»Ÿåˆ†ä¸ºã€ç”¨æˆ·æ€ã€‘å’Œã€å†…æ ¸æ€ã€‘ï¼Œæ–‡ä»¶æ“ä½œã€ç½‘ç»œæ“ä½œéœ€è¦æ¶‰åŠè¿™ä¸¤ç§å½¢æ€çš„åˆ‡æ¢ï¼Œå…ä¸äº†è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚

ä¸€å°æœåŠ¡å™¨ æŠŠæœ¬æœºç£ç›˜æ–‡ä»¶çš„å†…å®¹å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š

1ï¼‰readï¼›è¯»å–æœ¬åœ°æ–‡ä»¶å†…å®¹ï¼› 

2ï¼‰writeï¼›å°†è¯»å–çš„å†…å®¹é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ã€‚

*è¿™ä¸¤ä¸ªçœ‹ä¼¼ç®€å•çš„æ“ä½œï¼Œå®é™…è¿›è¡Œäº†**4 æ¬¡æ•°æ®å¤åˆ¶ï¼Œåˆ†åˆ«æ˜¯ï¼š***

1. ***ä»ç£ç›˜å¤åˆ¶æ•°æ®åˆ°å†…æ ¸æ€å†…å­˜ï¼›***
2. ***ä»å†…æ ¸æ€å†…å­˜å¤ åˆ¶åˆ°ç”¨æˆ·æ€å†…å­˜ï¼›***
3. ***ç„¶åä»ç”¨æˆ·æ€ å†…å­˜å¤åˆ¶åˆ°ç½‘ç»œé©±åŠ¨çš„å†…æ ¸æ€å†…å­˜ï¼›***
4. ***æœ€åæ˜¯ä»ç½‘ç»œé©±åŠ¨çš„å†…æ ¸æ€å†…å­˜å¤ åˆ¶åˆ°ç½‘å¡ä¸­è¿›è¡Œä¼ è¾“ã€‚***

![](/assets/imgs/æ–‡ä»¶æ“ä½œå’Œç½‘ç»œæ“ä½œ.png)***â­ï¸é€šè¿‡ä½¿ç”¨mmapçš„æ–¹å¼ï¼Œå¯ä»¥çœå»å‘ç”¨æˆ·æ€çš„å†…å­˜å¤åˆ¶ï¼Œæé«˜é€Ÿåº¦ã€‚è¿™ç§æœºåˆ¶åœ¨Javaä¸­æ˜¯é€šè¿‡MappedByteBufferå®ç°çš„***

RocketMQå……åˆ†åˆ©ç”¨äº†ä¸Šè¿°ç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„***â€œé›¶æ‹·è´â€æŠ€æœ¯***ï¼Œæé«˜æ¶ˆæ¯å­˜ç›˜å’Œç½‘ç»œå‘é€çš„é€Ÿåº¦ã€‚

> è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡‡ç”¨MappedByteBufferè¿™ç§å†…å­˜æ˜ å°„çš„æ–¹å¼æœ‰å‡ ä¸ªé™åˆ¶ï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯ä¸€æ¬¡åªèƒ½æ˜ å°„1.5~2G çš„æ–‡ä»¶è‡³ç”¨æˆ·æ€çš„è™šæ‹Ÿå†…å­˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä½•RocketMQé»˜è®¤è®¾ç½®å•ä¸ªCommitLogæ—¥å¿—æ•°æ®æ–‡ä»¶ä¸º1Gçš„åŸå› äº†

### æ¶ˆæ¯å­˜å‚¨ç»“æ„

***RocketMQæ¶ˆæ¯çš„å­˜å‚¨æ˜¯ç”±ConsumeQueueå’ŒCommitLogé…åˆå®Œæˆ çš„ï¼Œæ¶ˆæ¯çœŸæ­£çš„ç‰©ç†å­˜å‚¨æ–‡ä»¶æ˜¯CommitLogï¼ŒConsumeQueueæ˜¯æ¶ˆæ¯çš„é€»è¾‘é˜Ÿåˆ—ï¼Œç±»ä¼¼æ•°æ®åº“çš„ç´¢å¼•æ–‡ä»¶ï¼Œå­˜å‚¨çš„æ˜¯æŒ‡å‘ç‰©ç†å­˜å‚¨çš„åœ°å€ã€‚***æ¯ ä¸ªTopicä¸‹çš„æ¯ä¸ªMessage Queueéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ConsumeQueueæ–‡ä»¶ã€‚

![](/assets/imgs/æ¶ˆæ¯å­˜å‚¨ç»“æ„.png)

* CommitLogï¼šå­˜å‚¨æ¶ˆæ¯çš„å…ƒæ•°æ®
* ConsumerQueueï¼šå­˜å‚¨æ¶ˆæ¯åœ¨CommitLogçš„ç´¢å¼•
* IndexFileï¼šä¸ºäº†æ¶ˆæ¯æŸ¥è¯¢æä¾›äº†ä¸€ç§é€šè¿‡keyæˆ–æ—¶é—´åŒºé—´æ¥æŸ¥è¯¢æ¶ˆæ¯çš„æ–¹æ³•ï¼Œè¿™ç§é€šè¿‡IndexFileæ¥æŸ¥æ‰¾æ¶ˆæ¯çš„æ–¹æ³•ä¸å½±å“å‘é€ä¸æ¶ˆè´¹æ¶ˆæ¯çš„ä¸»æµç¨‹

### åˆ·ç›˜æœºåˆ¶

RocketMQçš„æ¶ˆæ¯æ˜¯å­˜å‚¨åˆ°ç£ç›˜ä¸Šçš„ï¼Œè¿™æ ·æ—¢èƒ½ä¿è¯æ–­ç”µåæ¢å¤ï¼Œ åˆå¯ä»¥è®©å­˜å‚¨çš„æ¶ˆæ¯é‡è¶…å‡ºå†…å­˜çš„é™åˆ¶ã€‚RocketMQä¸ºäº†æé«˜æ€§èƒ½ï¼Œä¼šå°½å¯èƒ½åœ°ä¿è¯ç£ç›˜çš„é¡ºåºå†™ã€‚æ¶ˆæ¯åœ¨é€šè¿‡Producerå†™å…¥RocketMQçš„æ—¶ å€™ï¼Œæœ‰ä¸¤ç§å†™ç£ç›˜æ–¹å¼ï¼Œåˆ†å¸ƒå¼åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ã€‚

![](/assets/imgs/åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜.png)

#### åŒæ­¥åˆ·ç›˜

åœ¨è¿”å›å†™æˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¶ˆæ¯å·²ç»è¢«å†™å…¥ç£ç›˜ã€‚å…·ä½“æµç¨‹æ˜¯ï¼Œæ¶ˆæ¯å†™å…¥å†…å­˜çš„PAGECACHEåï¼Œç«‹åˆ»é€šçŸ¥åˆ·ç›˜çº¿ç¨‹åˆ·ç›˜ï¼Œ ç„¶åç­‰å¾…åˆ·ç›˜å®Œæˆï¼Œåˆ·ç›˜çº¿ç¨‹æ‰§è¡Œå®Œæˆåå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼Œè¿”å›æ¶ˆæ¯å†™ æˆåŠŸçš„çŠ¶æ€ã€‚***ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ã€‚***

#### å¼‚æ­¥åˆ·ç›˜

**åœ¨è¿”å›å†™æˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¶ˆæ¯å¯èƒ½åªæ˜¯è¢«å†™å…¥äº†å†…å­˜çš„PAGECACHEï¼Œå†™æ“ä½œçš„è¿”å›å¿«ï¼Œååé‡å¤§ï¼›å½“å†…å­˜é‡Œçš„æ¶ˆæ¯é‡ç§¯ç´¯åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œç»Ÿä¸€è§¦å‘å†™ç£ç›˜åŠ¨ä½œï¼Œå¿«é€Ÿå†™å…¥ã€‚**

####é…ç½®

**åŒæ­¥åˆ·ç›˜è¿˜æ˜¯å¼‚æ­¥åˆ·ç›˜ï¼Œéƒ½æ˜¯é€šè¿‡Brokeré…ç½®æ–‡ä»¶é‡Œçš„flushDiskType å‚æ•°è®¾ç½®çš„ï¼Œè¿™ä¸ªå‚æ•°è¢«é…ç½®æˆSYNC_FLUSHã€ASYNC_FLUSHä¸­çš„ ä¸€ä¸ªã€‚**

## é«˜å¯ç”¨æ€§æœºåˆ¶

![](/assets/imgs/RocketMQè§’è‰².jpg)

***RocketMQåˆ†å¸ƒå¼é›†ç¾¤æ˜¯é€šè¿‡Masterå’ŒSlaveçš„é…åˆè¾¾åˆ°é«˜å¯ç”¨æ€§çš„ã€‚***

Masterå’ŒSlaveçš„åŒºåˆ«ï¼šåœ¨Brokerçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå‚æ•° brokerIdçš„å€¼ä¸º0è¡¨æ˜è¿™ä¸ªBrokeræ˜¯Masterï¼Œå¤§äº0è¡¨æ˜è¿™ä¸ªBrokeræ˜¯ Slaveï¼ŒåŒæ—¶brokerRoleå‚æ•°ä¹Ÿä¼šè¯´æ˜è¿™ä¸ªBrokeræ˜¯Masterè¿˜æ˜¯Slaveã€‚

Masterè§’è‰²çš„Brokeræ”¯æŒè¯»å’Œå†™ï¼ŒSlaveè§’è‰²çš„Brokerä»…æ”¯æŒè¯»ï¼Œä¹Ÿå°±æ˜¯ Produceråªèƒ½å’ŒMasterè§’è‰²çš„Brokerè¿æ¥å†™å…¥æ¶ˆæ¯ï¼›Consumerå¯ä»¥è¿æ¥ Masterè§’è‰²çš„Brokerï¼Œä¹Ÿå¯ä»¥è¿æ¥Slaveè§’è‰²çš„Brokeræ¥è¯»å–æ¶ˆæ¯ã€‚

### æ¶ˆæ¯æ¶ˆè´¹é«˜å¯ç”¨

åœ¨Consumerçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸éœ€è¦è®¾ç½®æ˜¯ä»Masterè¯»è¿˜æ˜¯ä»Slave è¯»ï¼Œå½“Masterä¸å¯ç”¨æˆ–è€…ç¹å¿™çš„æ—¶å€™ï¼ŒConsumerä¼šè¢«è‡ªåŠ¨åˆ‡æ¢åˆ°ä»Slave è¯»ã€‚æœ‰äº†è‡ªåŠ¨åˆ‡æ¢Consumerè¿™ç§æœºåˆ¶ï¼Œå½“ä¸€ä¸ªMasterè§’è‰²çš„æœºå™¨å‡ºç°æ•…éšœåï¼ŒConsumerä»ç„¶å¯ä»¥ä»Slaveè¯»å–æ¶ˆæ¯ï¼Œä¸å½±å“Consumerç¨‹åºã€‚è¿™å°±è¾¾åˆ°äº†æ¶ˆè´¹ç«¯çš„é«˜å¯ç”¨æ€§ã€‚

### æ¶ˆæ¯å‘é€é«˜å¯ç”¨

åœ¨åˆ›å»ºTopicçš„æ—¶å€™ï¼ŒæŠŠTopicçš„å¤šä¸ªMessage Queueåˆ›å»ºåœ¨å¤šä¸ªBrokerç»„ä¸Šï¼ˆç›¸åŒBrokeråç§°ï¼Œä¸åŒ brokerIdçš„æœºå™¨ç»„æˆä¸€ä¸ªBrokerç»„ï¼‰ï¼Œè¿™æ ·å½“ä¸€ä¸ªBrokerç»„çš„Masterä¸å¯ç”¨åï¼Œå…¶ä»–ç»„çš„Masterä»ç„¶å¯ç”¨ï¼ŒProducerä»ç„¶å¯ä»¥å‘é€æ¶ˆæ¯ã€‚ ***âš ï¸RocketMQç›®å‰è¿˜ä¸æ”¯æŒæŠŠSlaveè‡ªåŠ¨è½¬æˆMasterï¼Œå¦‚æœæœºå™¨èµ„æºä¸è¶³ï¼Œ éœ€è¦æŠŠSlaveè½¬æˆMasterï¼Œåˆ™è¦æ‰‹åŠ¨åœæ­¢Slaveè§’è‰²çš„Brokerï¼Œæ›´æ”¹é…ç½®æ–‡ ä»¶ï¼Œç”¨æ–°çš„é…ç½®æ–‡ä»¶å¯åŠ¨Brokerã€‚***

![](/assets/imgs/æ¶ˆæ¯å‘é€é«˜å¯ç”¨è®¾è®¡.jpg)

### æ¶ˆæ¯ä¸»ä»å¤åˆ¶

å¦‚æœä¸€ä¸ªBrokerç»„æœ‰Masterå’ŒSlaveï¼Œæ¶ˆæ¯éœ€è¦ä»Masterå¤åˆ¶åˆ°Slave ä¸Šï¼Œæœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§å¤åˆ¶æ–¹å¼ã€‚

####åŒæ­¥å¤åˆ¶

**åŒæ­¥å¤åˆ¶æ–¹å¼æ˜¯ç­‰Masterå’ŒSlaveå‡å†™æˆåŠŸåæ‰åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ï¼›**

åœ¨åŒæ­¥å¤åˆ¶æ–¹å¼ä¸‹ï¼Œå¦‚æœMasterå‡ºæ•…éšœï¼Œ Slaveä¸Šæœ‰å…¨éƒ¨çš„å¤‡ä»½æ•°æ®ï¼Œå®¹æ˜“æ¢å¤ï¼Œä½†æ˜¯åŒæ­¥å¤åˆ¶ä¼šå¢å¤§æ•°æ®å†™å…¥ å»¶è¿Ÿï¼Œé™ä½ç³»ç»Ÿååé‡ã€‚

####å¼‚æ­¥å¤åˆ¶ 

**å¼‚æ­¥å¤åˆ¶æ–¹å¼æ˜¯åªè¦Masterå†™æˆåŠŸ å³å¯åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ã€‚**

åœ¨å¼‚æ­¥å¤åˆ¶æ–¹å¼ä¸‹ï¼Œç³»ç»Ÿæ‹¥æœ‰è¾ƒä½çš„å»¶è¿Ÿå’Œè¾ƒé«˜çš„ååé‡ï¼Œä½†æ˜¯å¦‚æœMasterå‡ºäº†æ•…éšœï¼Œæœ‰äº›æ•°æ®å› ä¸ºæ²¡æœ‰è¢«å†™ å…¥Slaveï¼Œæœ‰å¯èƒ½ä¼šä¸¢å¤±ï¼›

####é…ç½®

åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶æ˜¯é€šè¿‡Brokeré…ç½®æ–‡ä»¶é‡Œçš„brokerRoleå‚æ•°è¿›è¡Œè®¾ç½®çš„ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥è¢«è®¾ç½®æˆASYNC_MASTERã€ SYNC_MASTERã€SLAVEä¸‰ä¸ªå€¼ä¸­çš„ä¸€ä¸ªã€‚

####æ€»ç»“

![](/assets/imgs/å¤åˆ¶åˆ·ç›˜.png)

å®é™…åº”ç”¨ä¸­è¦ç»“åˆä¸šåŠ¡åœºæ™¯ï¼Œåˆç†è®¾ç½®åˆ·ç›˜æ–¹å¼å’Œä¸»ä»å¤åˆ¶æ–¹å¼ï¼Œ å°¤å…¶æ˜¯SYNC_FLUSHæ–¹å¼ï¼Œç”±äºé¢‘ç¹åœ°è§¦å‘ç£ç›˜å†™åŠ¨ä½œï¼Œä¼šæ˜æ˜¾é™ä½ æ€§èƒ½ã€‚***é€šå¸¸æƒ…å†µä¸‹ï¼Œåº”è¯¥æŠŠMasterå’ŒSlaveé…ç½®æˆASYNC_FLUSHçš„åˆ·ç›˜ æ–¹å¼ï¼Œä¸»ä»ä¹‹é—´é…ç½®æˆSYNC_MASTERçš„å¤åˆ¶æ–¹å¼ï¼Œè¿™æ ·å³ä½¿æœ‰ä¸€å° æœºå™¨å‡ºæ•…éšœï¼Œä»ç„¶èƒ½ä¿è¯æ•°æ®ä¸ä¸¢ï¼Œæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚***

## è´Ÿè½½å‡è¡¡

### Producerè´Ÿè½½å‡è¡¡

Producerç«¯ï¼Œæ¯ä¸ªå®ä¾‹åœ¨å‘æ¶ˆæ¯çš„æ—¶å€™ï¼Œé»˜è®¤ä¼šè½®è¯¢æ‰€æœ‰çš„message queueå‘é€ï¼Œä»¥è¾¾åˆ°è®©æ¶ˆæ¯å¹³å‡è½åœ¨ä¸åŒçš„queueä¸Šã€‚è€Œç”±äºqueueå¯ä»¥æ•£è½åœ¨ä¸åŒçš„brokerï¼Œæ‰€ä»¥æ¶ˆæ¯å°±å‘é€åˆ°ä¸åŒçš„brokerä¸‹ï¼Œå¦‚ä¸‹å›¾ï¼š

![](/assets/imgs/producerè´Ÿè½½å‡è¡¡.png)

å›¾ä¸­ç®­å¤´çº¿æ¡ä¸Šçš„æ ‡å·ä»£è¡¨é¡ºåºï¼Œå‘å¸ƒæ–¹ä¼šæŠŠç¬¬ä¸€æ¡æ¶ˆæ¯å‘é€è‡³ Queue 0ï¼Œç„¶åç¬¬äºŒæ¡æ¶ˆæ¯å‘é€è‡³ Queue 1ï¼Œä»¥æ­¤ç±»æ¨ã€‚

### Consumerè´Ÿè½½å‡è¡¡

#### é›†ç¾¤æ¨¡å¼

åœ¨é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œæ¯æ¡æ¶ˆæ¯åªéœ€è¦æŠ•é€’åˆ°è®¢é˜…è¿™ä¸ªtopicçš„Consumer Groupä¸‹çš„ä¸€ä¸ªå®ä¾‹å³å¯ã€‚RocketMQé‡‡ç”¨ä¸»åŠ¨æ‹‰å–çš„æ–¹å¼æ‹‰å–å¹¶æ¶ˆè´¹æ¶ˆæ¯ï¼Œåœ¨æ‹‰å–çš„æ—¶å€™éœ€è¦æ˜ç¡®æŒ‡å®šæ‹‰å–å“ªä¸€æ¡message queueã€‚

è€Œæ¯å½“å®ä¾‹çš„æ•°é‡æœ‰å˜æ›´ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡æ‰€æœ‰å®ä¾‹çš„è´Ÿè½½å‡è¡¡ï¼Œè¿™æ—¶å€™ä¼šæŒ‰ç…§queueçš„æ•°é‡å’Œå®ä¾‹çš„æ•°é‡å¹³å‡åˆ†é…queueç»™æ¯ä¸ªå®ä¾‹ã€‚

é»˜è®¤çš„åˆ†é…ç®—æ³•æ˜¯AllocateMessageQueueAveragelyï¼Œå¦‚ä¸‹å›¾ï¼š

![](/assets/imgs/consumerè´Ÿè½½å‡è¡¡.png)

***è¿˜æœ‰å¦å¤–ä¸€ç§å¹³å‡çš„ç®—æ³•æ˜¯AllocateMessageQueueAveragelyByCircleï¼Œä¹Ÿæ˜¯å¹³å‡åˆ†æ‘Šæ¯ä¸€æ¡queueï¼Œåªæ˜¯ä»¥ç¯çŠ¶è½®æµåˆ†queueçš„å½¢å¼ï¼Œå¦‚ä¸‹å›¾ï¼š***

![](/assets/imgs/consumerè´Ÿè½½å‡è¡¡2.png)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œqueueéƒ½æ˜¯åªå…è®¸åˆ†é…åªä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ˜¯ç”±äºå¦‚æœå¤šä¸ªå®ä¾‹åŒæ—¶æ¶ˆè´¹ä¸€ä¸ªqueueçš„æ¶ˆæ¯ï¼Œç”±äºæ‹‰å–å“ªäº›æ¶ˆæ¯æ˜¯consumerä¸»åŠ¨æ§åˆ¶çš„ï¼Œé‚£æ ·ä¼šå¯¼è‡´åŒä¸€ä¸ªæ¶ˆæ¯åœ¨ä¸åŒçš„å®ä¾‹ä¸‹è¢«æ¶ˆè´¹å¤šæ¬¡ï¼Œæ‰€ä»¥ç®—æ³•ä¸Šéƒ½æ˜¯ä¸€ä¸ªqueueåªåˆ†ç»™ä¸€ä¸ªconsumerå®ä¾‹ï¼Œä¸€ä¸ªconsumerå®ä¾‹å¯ä»¥å…è®¸åŒæ—¶åˆ†åˆ°ä¸åŒçš„queueã€‚

é€šè¿‡å¢åŠ consumerå®ä¾‹å»åˆ†æ‘Šqueueçš„æ¶ˆè´¹ï¼Œå¯ä»¥èµ·åˆ°æ°´å¹³æ‰©å±•çš„æ¶ˆè´¹èƒ½åŠ›çš„ä½œç”¨ã€‚è€Œæœ‰å®ä¾‹ä¸‹çº¿çš„æ—¶å€™ï¼Œä¼šé‡æ–°è§¦å‘è´Ÿè½½å‡è¡¡ï¼Œè¿™æ—¶å€™åŸæ¥åˆ†é…åˆ°çš„queueå°†åˆ†é…åˆ°å…¶ä»–å®ä¾‹ä¸Šç»§ç»­æ¶ˆè´¹ã€‚

***âš ï¸ ä½†æ˜¯å¦‚æœconsumerå®ä¾‹çš„æ•°é‡æ¯”message queueçš„æ€»æ•°é‡è¿˜å¤šçš„è¯ï¼Œå¤šå‡ºæ¥çš„consumerå®ä¾‹å°†æ— æ³•åˆ†åˆ°queueï¼Œä¹Ÿå°±æ— æ³•æ¶ˆè´¹åˆ°æ¶ˆæ¯ï¼Œä¹Ÿå°±æ— æ³•èµ·åˆ°åˆ†æ‘Šè´Ÿè½½çš„ä½œç”¨äº†ã€‚æ‰€ä»¥éœ€è¦æ§åˆ¶è®©queueçš„æ€»æ•°é‡å¤§äºç­‰äºconsumerçš„æ•°é‡ã€‚***

####å¹¿æ’­æ¨¡å¼

ç”±äºå¹¿æ’­æ¨¡å¼ä¸‹è¦æ±‚ä¸€æ¡æ¶ˆæ¯éœ€è¦æŠ•é€’åˆ°ä¸€ä¸ªæ¶ˆè´¹ç»„ä¸‹é¢æ‰€æœ‰çš„æ¶ˆè´¹è€…å®ä¾‹ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰æ¶ˆæ¯è¢«åˆ†æ‘Šæ¶ˆè´¹çš„è¯´æ³•ã€‚

***åœ¨å®ç°ä¸Šï¼Œå…¶ä¸­ä¸€ä¸ªä¸åŒå°±æ˜¯åœ¨consumeråˆ†é…queueçš„æ—¶å€™ï¼Œæ‰€æœ‰consumeréƒ½åˆ†åˆ°æ‰€æœ‰çš„queueã€‚***

![](/assets/imgs/consumerè´Ÿè½½å‡è¡¡3.png)

## æ¶ˆæ¯é‡è¯•

### é¡ºåºæ¶ˆæ¯çš„é‡è¯•

å¯¹äºé¡ºåºæ¶ˆæ¯ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¼šè‡ªåŠ¨ä¸æ–­è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼ˆæ¯æ¬¡é—´éš”æ—¶é—´ä¸º 1 ç§’ï¼‰ï¼Œè¿™æ—¶ï¼Œåº”ç”¨ä¼šå‡ºç°æ¶ˆæ¯æ¶ˆè´¹è¢«é˜»å¡çš„æƒ…å†µã€‚**å› æ­¤ï¼Œåœ¨ä½¿ç”¨é¡ºåºæ¶ˆæ¯æ—¶ï¼ŒåŠ¡å¿…ä¿è¯åº”ç”¨èƒ½å¤ŸåŠæ—¶ç›‘æ§å¹¶å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æƒ…å†µï¼Œé¿å…é˜»å¡ç°è±¡çš„å‘ç”Ÿã€‚**

### æ— åºæ¶ˆæ¯çš„é‡è¯•

å¯¹äºæ— åºæ¶ˆæ¯ï¼ˆæ™®é€šã€å®šæ—¶ã€å»¶æ—¶ã€äº‹åŠ¡æ¶ˆæ¯ï¼‰ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡è®¾ç½®è¿”å›çŠ¶æ€è¾¾åˆ°æ¶ˆæ¯é‡è¯•çš„ç»“æœã€‚

***æ— åºæ¶ˆæ¯çš„é‡è¯•åªé’ˆå¯¹é›†ç¾¤æ¶ˆè´¹æ–¹å¼ç”Ÿæ•ˆï¼›å¹¿æ’­æ–¹å¼ä¸æä¾›å¤±è´¥é‡è¯•ç‰¹æ€§ï¼Œ***å³æ¶ˆè´¹å¤±è´¥åï¼Œå¤±è´¥æ¶ˆæ¯ä¸å†é‡è¯•ï¼Œç»§ç»­æ¶ˆè´¹æ–°çš„æ¶ˆæ¯ã€‚

#### é‡è¯•æ¬¡æ•°

æ¶ˆæ¯é˜Ÿåˆ— RocketMQ é»˜è®¤å…è®¸æ¯æ¡æ¶ˆæ¯***æœ€å¤šé‡è¯• 16 æ¬¡***ï¼Œæ¯æ¬¡é‡è¯•çš„é—´éš”æ—¶é—´å¦‚ä¸‹ï¼š

| ç¬¬å‡ æ¬¡é‡è¯• | ä¸ä¸Šæ¬¡é‡è¯•çš„é—´éš”æ—¶é—´ | ç¬¬å‡ æ¬¡é‡è¯• | ä¸ä¸Šæ¬¡é‡è¯•çš„é—´éš”æ—¶é—´ |
| :--------: | :------------------: | :--------: | :------------------: |
|     1      |        10 ç§’         |     9      |        7 åˆ†é’Ÿ        |
|     2      |        30 ç§’         |     10     |        8 åˆ†é’Ÿ        |
|     3      |        1 åˆ†é’Ÿ        |     11     |        9 åˆ†é’Ÿ        |
|     4      |        2 åˆ†é’Ÿ        |     12     |       10 åˆ†é’Ÿ        |
|     5      |        3 åˆ†é’Ÿ        |     13     |       20 åˆ†é’Ÿ        |
|     6      |        4 åˆ†é’Ÿ        |     14     |       30 åˆ†é’Ÿ        |
|     7      |        5 åˆ†é’Ÿ        |     15     |        1 å°æ—¶        |
|     8      |        6 åˆ†é’Ÿ        |     16     |        2 å°æ—¶        |

å¦‚æœæ¶ˆæ¯é‡è¯• 16 æ¬¡åä»ç„¶å¤±è´¥ï¼Œæ¶ˆæ¯å°†ä¸å†æŠ•é€’ã€‚å¦‚æœä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°é‡è¯•æ—¶é—´é—´éš”è®¡ç®—ï¼ŒæŸæ¡æ¶ˆæ¯åœ¨ä¸€ç›´æ¶ˆè´¹å¤±è´¥çš„å‰æä¸‹ï¼Œå°†ä¼šåœ¨æ¥ä¸‹æ¥çš„ 4 å°æ—¶ 46 åˆ†é’Ÿä¹‹å†…è¿›è¡Œ 16 æ¬¡é‡è¯•ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´èŒƒå›´æ¶ˆæ¯å°†ä¸å†é‡è¯•æŠ•é€’ã€‚

**âš ï¸ æ³¨æ„ï¼š** ***ä¸€æ¡æ¶ˆæ¯æ— è®ºé‡è¯•å¤šå°‘æ¬¡ï¼Œè¿™äº›é‡è¯•æ¶ˆæ¯çš„ Message ID ä¸ä¼šæ”¹å˜ã€‚***

#### é…ç½®æ–¹å¼

**æ¶ˆè´¹å¤±è´¥åï¼Œé‡è¯•é…ç½®æ–¹å¼**

é›†ç¾¤æ¶ˆè´¹æ–¹å¼ä¸‹ï¼Œæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥åæœŸæœ›æ¶ˆæ¯é‡è¯•ï¼Œéœ€è¦åœ¨æ¶ˆæ¯ç›‘å¬å™¨æ¥å£çš„å®ç°ä¸­æ˜ç¡®è¿›è¡Œé…ç½®ï¼ˆä¸‰ç§æ–¹å¼ä»»é€‰ä¸€ç§ï¼‰ï¼š

- è¿”å› Action.ReconsumeLater ï¼ˆæ¨èï¼‰
- è¿”å› Null
- æŠ›å‡ºå¼‚å¸¸

```java
public class MessageListenerImpl implements MessageListener {
    @Override
    public Action consume(Message message, ConsumeContext context) {
        //å¤„ç†æ¶ˆæ¯
        doConsumeMessage(message);
        //æ–¹å¼1ï¼šè¿”å› Action.ReconsumeLaterï¼Œæ¶ˆæ¯å°†é‡è¯•
        return Action.ReconsumeLater;
        //æ–¹å¼2ï¼šè¿”å› nullï¼Œæ¶ˆæ¯å°†é‡è¯•
        return null;
        //æ–¹å¼3ï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œ æ¶ˆæ¯å°†é‡è¯•
        throw new RuntimeException("Consumer Message exceotion");
    }
}
```

**æ¶ˆè´¹å¤±è´¥åï¼Œä¸é‡è¯•é…ç½®æ–¹å¼**

é›†ç¾¤æ¶ˆè´¹æ–¹å¼ä¸‹ï¼Œæ¶ˆæ¯å¤±è´¥åæœŸæœ›æ¶ˆæ¯ä¸é‡è¯•ï¼Œéœ€è¦æ•è·æ¶ˆè´¹é€»è¾‘ä¸­å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ï¼Œ***æœ€ç»ˆè¿”å› Action.CommitMessageï¼Œæ­¤åè¿™æ¡æ¶ˆæ¯å°†ä¸ä¼šå†é‡è¯•***ã€‚

```java
public class MessageListenerImpl implements MessageListener {
    @Override
    public Action consume(Message message, ConsumeContext context) {
        try {
            doConsumeMessage(message);
        } catch (Throwable e) {
            //æ•è·æ¶ˆè´¹é€»è¾‘ä¸­çš„æ‰€æœ‰å¼‚å¸¸ï¼Œå¹¶è¿”å› Action.CommitMessage;
            return Action.CommitMessage;
        }
        //æ¶ˆæ¯å¤„ç†æ­£å¸¸ï¼Œç›´æ¥è¿”å› Action.CommitMessage;
        return Action.CommitMessage;
    }
}
```

**è‡ªå®šä¹‰æ¶ˆæ¯æœ€å¤§é‡è¯•æ¬¡æ•°**

æ¶ˆæ¯é˜Ÿåˆ— RocketMQ å…è®¸ Consumer å¯åŠ¨çš„æ—¶å€™è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•æ—¶é—´é—´éš”å°†æŒ‰ç…§å¦‚ä¸‹ç­–ç•¥ï¼š

- æœ€å¤§é‡è¯•æ¬¡æ•°å°äºç­‰äº 16 æ¬¡ï¼Œåˆ™é‡è¯•æ—¶é—´é—´éš”åŒä¸Šè¡¨æè¿°ã€‚
- æœ€å¤§é‡è¯•æ¬¡æ•°å¤§äº 16 æ¬¡ï¼Œè¶…è¿‡ 16 æ¬¡çš„é‡è¯•æ—¶é—´é—´éš”å‡ä¸ºæ¯æ¬¡ 2 å°æ—¶ã€‚

```java
Properties properties = new Properties();
//é…ç½®å¯¹åº” Group ID çš„æœ€å¤§æ¶ˆæ¯é‡è¯•æ¬¡æ•°ä¸º 20 æ¬¡
properties.put(PropertyKeyConst.MaxReconsumeTimes,"20");
Consumer consumer =ONSFactory.createConsumer(properties);
```

> æ³¨æ„ï¼š

- æ¶ˆæ¯æœ€å¤§é‡è¯•æ¬¡æ•°çš„è®¾ç½®å¯¹ç›¸åŒ Group ID ä¸‹çš„æ‰€æœ‰ Consumer å®ä¾‹æœ‰æ•ˆã€‚
- ***å¦‚æœåªå¯¹ç›¸åŒ Group ID ä¸‹ä¸¤ä¸ª Consumer å®ä¾‹ä¸­çš„å…¶ä¸­ä¸€ä¸ªè®¾ç½®äº† MaxReconsumeTimesï¼Œé‚£ä¹ˆè¯¥é…ç½®å¯¹ä¸¤ä¸ª Consumer å®ä¾‹å‡ç”Ÿæ•ˆã€‚***
- é…ç½®é‡‡ç”¨è¦†ç›–çš„æ–¹å¼ç”Ÿæ•ˆï¼Œå³***æœ€åå¯åŠ¨çš„ Consumer å®ä¾‹ä¼šè¦†ç›–ä¹‹å‰çš„å¯åŠ¨å®ä¾‹çš„é…ç½®***

**è·å–æ¶ˆæ¯é‡è¯•æ¬¡æ•°**

æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯åï¼Œå¯æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è·å–æ¶ˆæ¯çš„é‡è¯•æ¬¡æ•°ï¼š

```java
public class MessageListenerImpl implements MessageListener {
    @Override
    public Action consume(Message message, ConsumeContext context) {
        //è·å–æ¶ˆæ¯çš„é‡è¯•æ¬¡æ•°
        System.out.println(message.getReconsumeTimes());
        return Action.CommitMessage;
    }
}
```

## æ­»ä¿¡é˜Ÿåˆ—

å½“ä¸€æ¡æ¶ˆæ¯åˆæ¬¡æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¼šè‡ªåŠ¨è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼›è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œè‹¥æ¶ˆè´¹ä¾ç„¶å¤±è´¥ï¼Œåˆ™è¡¨æ˜æ¶ˆè´¹è€…åœ¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ­£ç¡®åœ°æ¶ˆè´¹è¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¸ä¼šç«‹åˆ»å°†æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œæ˜¯å°†å…¶å‘é€åˆ°è¯¥æ¶ˆè´¹è€…å¯¹åº”çš„ç‰¹æ®Šé˜Ÿåˆ—ä¸­ã€‚

åœ¨æ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¸­ï¼Œè¿™ç§æ­£å¸¸æƒ…å†µä¸‹æ— æ³•è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ç§°ä¸ºæ­»ä¿¡æ¶ˆæ¯ï¼ˆDead-Letter Messageï¼‰ï¼Œå­˜å‚¨æ­»ä¿¡æ¶ˆæ¯çš„ç‰¹æ®Šé˜Ÿåˆ—ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead-Letter Queueï¼‰ã€‚

### æ­»ä¿¡ç‰¹æ€§

**æ­»ä¿¡æ¶ˆæ¯å…·æœ‰ä»¥ä¸‹ç‰¹æ€§**

- ä¸ä¼šå†è¢«æ¶ˆè´¹è€…æ­£å¸¸æ¶ˆè´¹ã€‚
- æœ‰æ•ˆæœŸä¸æ­£å¸¸æ¶ˆæ¯ç›¸åŒï¼Œå‡ä¸º 3 å¤©ï¼Œ3 å¤©åä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚å› æ­¤ï¼Œè¯·åœ¨æ­»ä¿¡æ¶ˆæ¯äº§ç”Ÿåçš„ 3 å¤©å†…åŠæ—¶å¤„ç†ã€‚

æ­»ä¿¡é˜Ÿåˆ—å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

- **ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—å¯¹åº”ä¸€ä¸ª Group IDï¼Œ è€Œä¸æ˜¯å¯¹åº”å•ä¸ªæ¶ˆè´¹è€…å®ä¾‹ã€‚**
- å¦‚æœä¸€ä¸ª Group ID æœªäº§ç”Ÿæ­»ä¿¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¸ä¼šä¸ºå…¶åˆ›å»ºç›¸åº”çš„æ­»ä¿¡é˜Ÿåˆ—ã€‚
- **ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—åŒ…å«äº†å¯¹åº” Group ID äº§ç”Ÿçš„æ‰€æœ‰æ­»ä¿¡æ¶ˆæ¯ï¼Œä¸è®ºè¯¥æ¶ˆæ¯å±äºå“ªä¸ª Topicã€‚**

### æŸ¥çœ‹æ­»ä¿¡ä¿¡æ¯

1. åœ¨æ§åˆ¶å°æŸ¥è¯¢å‡ºç°æ­»ä¿¡é˜Ÿåˆ—çš„ä¸»é¢˜ä¿¡æ¯

![](/assets/imgs/æ­»ä¿¡é˜Ÿåˆ—ä¸»é¢˜.png)

2. åœ¨æ¶ˆæ¯ç•Œé¢æ ¹æ®ä¸»é¢˜æŸ¥è¯¢æ­»ä¿¡æ¶ˆæ¯

![](/assets/imgs/æ­»ä¿¡é˜Ÿåˆ—ä¸»é¢˜2.png)

3. é€‰æ‹©é‡æ–°å‘é€æ¶ˆæ¯

ä¸€æ¡æ¶ˆæ¯è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œæ„å‘³ç€æŸäº›å› ç´ å¯¼è‡´æ¶ˆè´¹è€…æ— æ³•æ­£å¸¸æ¶ˆè´¹è¯¥æ¶ˆæ¯ï¼Œå› æ­¤ï¼Œé€šå¸¸éœ€è¦æ‚¨å¯¹å…¶è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚æ’æŸ¥å¯ç–‘å› ç´ å¹¶è§£å†³é—®é¢˜åï¼Œ**å¯ä»¥åœ¨æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æ§åˆ¶å°é‡æ–°å‘é€è¯¥æ¶ˆæ¯ï¼Œè®©æ¶ˆè´¹è€…é‡æ–°æ¶ˆè´¹ä¸€æ¬¡ã€‚**

## æ¶ˆè´¹å¹‚ç­‰ ğŸ¤”

**æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æ¶ˆè´¹è€…åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯ä»¥åï¼Œæœ‰å¿…è¦æ ¹æ®ä¸šåŠ¡ä¸Šçš„å”¯ä¸€ Key å¯¹æ¶ˆæ¯åšå¹‚ç­‰å¤„ç†çš„å¿…è¦æ€§ã€‚**

### æ¶ˆè´¹å¹‚ç­‰çš„å¿…è¦æ€§

åœ¨äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå°¤å…¶åœ¨ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ çš„æ¶ˆæ¯æœ‰å¯èƒ½ä¼šå‡ºç°é‡å¤ï¼Œè¿™ä¸ªé‡å¤ç®€å•å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹æƒ…å†µï¼š

- **å‘é€æ—¶æ¶ˆæ¯é‡å¤**

  å½“ä¸€æ¡æ¶ˆæ¯å·²è¢«æˆåŠŸå‘é€åˆ°æœåŠ¡ç«¯å¹¶å®ŒæˆæŒä¹…åŒ–ï¼Œæ­¤æ—¶å‡ºç°äº†ç½‘ç»œé—ªæ–­æˆ–è€…å®¢æˆ·ç«¯å®•æœºï¼Œå¯¼è‡´æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯åº”ç­”å¤±è´¥ã€‚ å¦‚æœæ­¤æ—¶ç”Ÿäº§è€…æ„è¯†åˆ°æ¶ˆæ¯å‘é€å¤±è´¥å¹¶å°è¯•å†æ¬¡å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åç»­ä¼šæ”¶åˆ°ä¸¤æ¡å†…å®¹ç›¸åŒå¹¶ä¸” Message ID ä¹Ÿç›¸åŒçš„æ¶ˆæ¯ã€‚

- **æŠ•é€’æ—¶æ¶ˆæ¯é‡å¤**

  æ¶ˆæ¯æ¶ˆè´¹çš„åœºæ™¯ä¸‹ï¼Œæ¶ˆæ¯å·²æŠ•é€’åˆ°æ¶ˆè´¹è€…å¹¶å®Œæˆä¸šåŠ¡å¤„ç†ï¼Œå½“å®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯åé¦ˆåº”ç­”çš„æ—¶å€™ç½‘ç»œé—ªæ–­ã€‚ ä¸ºäº†ä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ çš„æœåŠ¡ç«¯å°†åœ¨ç½‘ç»œæ¢å¤åå†æ¬¡å°è¯•æŠ•é€’ä¹‹å‰å·²è¢«å¤„ç†è¿‡çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åç»­ä¼šæ”¶åˆ°ä¸¤æ¡å†…å®¹ç›¸åŒå¹¶ä¸” Message ID ä¹Ÿç›¸åŒçš„æ¶ˆæ¯ã€‚

- **è´Ÿè½½å‡è¡¡æ—¶æ¶ˆæ¯é‡å¤ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºç½‘ç»œæŠ–åŠ¨ã€Broker é‡å¯ä»¥åŠè®¢é˜…æ–¹åº”ç”¨é‡å¯ï¼‰**

  å½“æ¶ˆæ¯é˜Ÿåˆ— RocketMQ çš„ Broker æˆ–å®¢æˆ·ç«¯é‡å¯ã€æ‰©å®¹æˆ–ç¼©å®¹æ—¶ï¼Œä¼šè§¦å‘ Rebalanceï¼Œæ­¤æ—¶æ¶ˆè´¹è€…å¯èƒ½ä¼šæ”¶åˆ°é‡å¤æ¶ˆæ¯ã€‚

### å¤„ç†æ–¹å¼

å› ä¸º Message ID æœ‰å¯èƒ½å‡ºç°å†²çªï¼ˆé‡å¤ï¼‰çš„æƒ…å†µï¼Œæ‰€ä»¥çœŸæ­£å®‰å…¨çš„å¹‚ç­‰å¤„ç†ï¼Œä¸å»ºè®®ä»¥ Message ID ä½œä¸ºå¤„ç†ä¾æ®ã€‚ **æœ€å¥½çš„æ–¹å¼æ˜¯ä»¥ä¸šåŠ¡å”¯ä¸€æ ‡è¯†ä½œä¸ºå¹‚ç­‰å¤„ç†çš„å…³é”®ä¾æ®ï¼Œè€Œä¸šåŠ¡çš„å”¯ä¸€æ ‡è¯†å¯ä»¥é€šè¿‡æ¶ˆæ¯ Key è¿›è¡Œè®¾ç½®ï¼š**

```java
Message message = new Message();
message.setKey("ORDERID_100");
SendResult sendResult = producer.send(message);
```

è®¢é˜…æ–¹æ”¶åˆ°æ¶ˆæ¯æ—¶å¯ä»¥æ ¹æ®æ¶ˆæ¯çš„ Key è¿›è¡Œå¹‚ç­‰å¤„ç†ï¼š

```java
consumer.subscribe("ons_test", "*", new MessageListener() {
    public Action consume(Message message, ConsumeContext context) {
        String key = message.getKey()
        // æ ¹æ®ä¸šåŠ¡å”¯ä¸€æ ‡è¯†çš„ key åšå¹‚ç­‰å¤„ç†
    }
});
```

# æºç åˆ†æ

## ç¯å¢ƒæ­å»º

ä¾èµ–å·¥å…·

- JDK ï¼š1.8+
- Maven
- IntelliJ IDEA

### æºç æ‹‰å–

ä»å®˜æ–¹ä»“åº“ <https://github.com/apache/rocketmq> `clone`æˆ–è€…`download`æºç ã€‚

![](/assets/imgs/æºç 1.png)

**æºç ç›®å½•ç»“æ„ï¼š**

* broker: broker æ¨¡å—ï¼ˆbroke å¯åŠ¨è¿›ç¨‹ï¼‰ 

* client ï¼šæ¶ˆæ¯å®¢æˆ·ç«¯ï¼ŒåŒ…å«æ¶ˆæ¯ç”Ÿäº§è€…ã€æ¶ˆæ¯æ¶ˆè´¹è€…ç›¸å…³ç±» 
* common ï¼šå…¬å…±åŒ… 
* dev ï¼šå¼€å‘è€…ä¿¡æ¯ï¼ˆéæºä»£ç ï¼‰ 
* distribution ï¼šéƒ¨ç½²å®ä¾‹æ–‡ä»¶å¤¹ï¼ˆéæºä»£ç ï¼‰ 
* example: RocketMQ ä¾‹ä»£ç  
* filter ï¼šæ¶ˆæ¯è¿‡æ»¤ç›¸å…³åŸºç¡€ç±»

* filtersrvï¼šæ¶ˆæ¯è¿‡æ»¤æœåŠ¡å™¨å®ç°ç›¸å…³ç±»ï¼ˆFilterå¯åŠ¨è¿›ç¨‹ï¼‰
* logappenderï¼šæ—¥å¿—å®ç°ç›¸å…³ç±»
* namesrvï¼šNameServerå®ç°ç›¸å…³ç±»ï¼ˆNameServerå¯åŠ¨è¿›ç¨‹ï¼‰
* openmessageingï¼šæ¶ˆæ¯å¼€æ”¾æ ‡å‡†
* remotingï¼šè¿œç¨‹é€šä¿¡æ¨¡å—ï¼Œç»™äºˆNetty
* srcutilï¼šæœåŠ¡å·¥å…·ç±»
* storeï¼šæ¶ˆæ¯å­˜å‚¨å®ç°ç›¸å…³ç±»
* styleï¼šcheckstyleç›¸å…³å®ç°
* testï¼šæµ‹è¯•ç›¸å…³ç±»
* toolsï¼šå·¥å…·ç±»ï¼Œç›‘æ§å‘½ä»¤ç›¸å…³å®ç°ç±»

###å¯¼å…¥IDEA

![](/assets/imgs/æºç 2.png)

**æ‰§è¡Œå®‰è£…**

```sh
mvn clean install -Dmaven.test.skip=true
```

### è°ƒè¯•

åˆ›å»º`conf`é…ç½®æ–‡ä»¶å¤¹,ä»`distribution`æ‹·è´`broker.conf`å’Œ`logback_broker.xml`å’Œ`logback_namesrv.xml`

![](/assets/imgs/æºç 6.png)

#### å¯åŠ¨NameServer

* å±•å¼€namesrvæ¨¡å—ï¼Œå³é”®NamesrvStartup.java

![](/assets/imgs/æºç 3.png)

* é…ç½®**ROCKETMQ_HOME**

![](/assets/imgs/æºç 4.png)

![](/assets/imgs/æºç 5.png)

* é‡æ–°å¯åŠ¨

  æ§åˆ¶å°æ‰“å°ç»“æœ

```sh
The Name Server boot success. serializeType=JSON
```

#### å¯åŠ¨Broker

* `broker.conf`é…ç½®æ–‡ä»¶å†…å®¹

```properties
brokerClusterName = DefaultCluster
brokerName = broker-a
brokerId = 0
# namesrvAddråœ°å€
namesrvAddr=127.0.0.1:9876
deleteWhen = 04
fileReservedTime = 48
brokerRole = ASYNC_MASTER
flushDiskType = ASYNC_FLUSH
autoCreateTopicEnable=true

# å­˜å‚¨è·¯å¾„
storePathRootDir=/Users/silince/Develop/å¼€å‘æ–‡æ¡£/RocketMQ/ä»£ç /rocketmq/datarocketmq/dataDir
# commitLogè·¯å¾„
storePathCommitLog=/Users/silince/Develop/å¼€å‘æ–‡æ¡£/RocketMQ/ä»£ç /rocketmq/datarocketmq/dataDir/commitlog
# æ¶ˆæ¯é˜Ÿåˆ—å­˜å‚¨è·¯å¾„
storePathConsumeQueue=/Users/silince/Develop/å¼€å‘æ–‡æ¡£/RocketMQ/ä»£ç /rocketmq/datarocketmq/dataDir/consumequeue
# æ¶ˆæ¯ç´¢å¼•å­˜å‚¨è·¯å¾„
storePathIndex=/Users/silince/Develop/å¼€å‘æ–‡æ¡£/RocketMQ/ä»£ç /rocketmq/datarocketmq/dataDir/index
# checkpointæ–‡ä»¶è·¯å¾„
storeCheckpoint=/Users/silince/Develop/å¼€å‘æ–‡æ¡£/RocketMQ/ä»£ç /rocketmq/datarocketmq/dataDir/checkpoint
# abortæ–‡ä»¶å­˜å‚¨è·¯å¾„
abortFile=/Users/silince/Develop/å¼€å‘æ–‡æ¡£/RocketMQ/ä»£ç /rocketmq/datarocketmq/dataDir/abort
```

* åˆ›å»ºæ•°æ®æ–‡ä»¶å¤¹`dataDir`
* å¯åŠ¨`BrokerStartup`,é…ç½®`broker.conf`å’Œ`ROCKETMQ_HOME`

![](/assets/imgs/æºç 7.png)

![](/assets/imgs/æºç 8.png)

####å‘é€æ¶ˆæ¯

* è¿›å…¥exampleæ¨¡å—çš„`org.apache.rocketmq.example.quickstart`
* æŒ‡å®šNamesrvåœ°å€

```java
DefaultMQProducer producer = new DefaultMQProducer("please_rename_unique_group_name");
producer.setNamesrvAddr("127.0.0.1:9876");
```

* è¿è¡Œ`main`æ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯

#### æ¶ˆè´¹æ¶ˆæ¯

* è¿›å…¥exampleæ¨¡å—çš„`org.apache.rocketmq.example.quickstart`
* æŒ‡å®šNamesrvåœ°å€

```java
DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("please_rename_unique_group_name_4");
consumer.setNamesrvAddr("127.0.0.1:9876");
```

* è¿è¡Œ`main`æ–¹æ³•ï¼Œæ¶ˆè´¹æ¶ˆæ¯

## NameServer

### æ¶æ„è®¾è®¡

æ¶ˆæ¯ä¸­é—´ä»¶çš„è®¾è®¡æ€è·¯ä¸€èˆ¬æ˜¯åŸºäºä¸»é¢˜è®¢é˜…å‘å¸ƒçš„æœºåˆ¶ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰å‘é€æŸä¸€ä¸ªä¸»é¢˜åˆ°æ¶ˆæ¯æœåŠ¡å™¨ï¼Œæ¶ˆæ¯æœåŠ¡å™¨è´Ÿè´£å°†æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨ï¼Œæ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰è®¢é˜…è¯¥å…´è¶£çš„ä¸»é¢˜ï¼Œæ¶ˆæ¯æœåŠ¡å™¨æ ¹æ®è®¢é˜…ä¿¡æ¯ï¼ˆè·¯ç”±ä¿¡æ¯ï¼‰å°†æ¶ˆæ¯æ¨é€åˆ°æ¶ˆè´¹è€…ï¼ˆPushæ¨¡å¼ï¼‰æˆ–è€…æ¶ˆè´¹è€…ä¸»åŠ¨å‘æ¶ˆæ¯æœåŠ¡å™¨æ‹‰å»ï¼ˆPullæ¨¡å¼ï¼‰ï¼Œä»è€Œå®ç°æ¶ˆæ¯ç”Ÿäº§è€…ä¸æ¶ˆæ¯æ¶ˆè´¹è€…è§£è€¦ã€‚ä¸ºäº†é¿å…æ¶ˆæ¯æœåŠ¡å™¨çš„å•ç‚¹æ•…éšœå¯¼è‡´çš„æ•´ä¸ªç³»ç»Ÿç˜«ç—ªï¼Œé€šå¸¸ä¼šéƒ¨ç½²å¤šå°æ¶ˆæ¯æœåŠ¡å™¨å…±åŒæ‰¿æ‹…æ¶ˆæ¯çš„å­˜å‚¨ã€‚é‚£æ¶ˆæ¯ç”Ÿäº§è€…å¦‚ä½•çŸ¥é“æ¶ˆæ¯è¦å‘é€åˆ°å“ªå°æ¶ˆæ¯æœåŠ¡å™¨å‘¢ï¼Ÿå¦‚æœæŸä¸€å°æ¶ˆæ¯æœåŠ¡å™¨å®•æœºäº†ï¼Œé‚£ä¹ˆæ¶ˆæ¯ç”Ÿäº§è€…å¦‚ä½•åœ¨ä¸é‡å¯æœåŠ¡æƒ…å†µä¸‹æ„ŸçŸ¥å‘¢ï¼Ÿ

NameServerå°±æ˜¯ä¸ºäº†è§£å†³ä»¥ä¸Šé—®é¢˜è®¾è®¡çš„ã€‚

![](/assets/imgs/RocketMQè§’è‰².jpg)



Brokeræ¶ˆæ¯æœåŠ¡å™¨åœ¨å¯åŠ¨çš„æ—¶å‘æ‰€æœ‰NameServeræ³¨å†Œï¼Œæ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰åœ¨å‘é€æ¶ˆæ¯æ—¶ä¹‹å‰å…ˆä»NameServerè·å–BrokeræœåŠ¡å™¨åœ°å€åˆ—è¡¨ï¼Œç„¶åæ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•ä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°æœåŠ¡å™¨è¿›è¡Œå‘é€ã€‚***NameServerä¸æ¯å°Brokerä¿æŒé•¿è¿æ¥ï¼Œå¹¶é—´éš”30Sæ£€æµ‹Brokeræ˜¯å¦å­˜æ´»ï¼Œå¦‚æœæ£€æµ‹åˆ°Brokerå®•æœºï¼Œåˆ™ä»è·¯ç”±æ³¨å†Œè¡¨ä¸­åˆ é™¤ã€‚******âš ï¸ä½†æ˜¯è·¯ç”±å˜åŒ–ä¸ä¼šé©¬ä¸Šé€šçŸ¥æ¶ˆæ¯ç”Ÿäº§è€…ã€‚***è¿™æ ·è®¾è®¡çš„ç›®çš„æ˜¯ä¸ºäº†é™ä½NameServerå®ç°çš„å¤æ‚åº¦ï¼Œåœ¨æ¶ˆæ¯å‘é€ç«¯æä¾›å®¹é”™æœºåˆ¶ä¿è¯æ¶ˆæ¯å‘é€çš„å¯ç”¨æ€§ã€‚

NameServeræœ¬èº«çš„é«˜å¯ç”¨æ˜¯é€šè¿‡éƒ¨ç½²å¤šå°NameServeræ¥å®ç°ï¼Œ***ä½†å½¼æ­¤ä¹‹é—´ä¸é€šè®¯ï¼Œä¹Ÿå°±æ˜¯NameServeræœåŠ¡å™¨ä¹‹é—´åœ¨æŸä¸€ä¸ªæ—¶åˆ»çš„æ•°æ®å¹¶ä¸å®Œå…¨ç›¸åŒï¼Œä½†è¿™å¯¹æ¶ˆæ¯å‘é€å¹¶ä¸ä¼šé€ æˆä»»ä½•å½±å“ï¼Œ***è¿™ä¹Ÿæ˜¯NameServerè®¾è®¡çš„ä¸€ä¸ªäº®ç‚¹ï¼Œæ€»ä¹‹ï¼Œ***RocketMQè®¾è®¡è¿½æ±‚ç®€å•é«˜æ•ˆã€‚***

### å¯åŠ¨æµç¨‹

![](/assets/imgs/NameServerå¯åŠ¨æµç¨‹.png)

å¯åŠ¨ç±»ï¼š`org.apache.rocketmq.namesrv.NamesrvStartup`

####æ­¥éª¤ä¸€

 è§£æé…ç½®æ–‡ä»¶ï¼Œå¡«å……NameServerConfigã€NettyServerConfigå±æ€§å€¼ï¼Œå¹¶åˆ›å»ºNamesrvController

***ä»£ç ï¼šNamesrvController#createNamesrvController***

```java
//åˆ›å»ºNamesrvConfig
final NamesrvConfig namesrvConfig = new NamesrvConfig();
//åˆ›å»ºNettyServerConfig
final NettyServerConfig nettyServerConfig = new NettyServerConfig();
//è®¾ç½®å¯åŠ¨ç«¯å£å·
nettyServerConfig.setListenPort(9876);
//è§£æå¯åŠ¨ -cå‚æ•° æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®
if (commandLine.hasOption('c')) {
    String file = commandLine.getOptionValue('c');
    if (file != null) {
        InputStream in = new BufferedInputStream(new FileInputStream(file));
        properties = new Properties();
        properties.load(in);
        MixAll.properties2Object(properties, namesrvConfig);
        MixAll.properties2Object(properties, nettyServerConfig);

        namesrvConfig.setConfigStorePath(file);

        System.out.printf("load config properties file OK, %s%n", file);
        in.close();
    }
}
//è§£æå¯åŠ¨ -på‚æ•° å±æ€§å=å±æ€§å€¼
if (commandLine.hasOption('p')) {
    InternalLogger console = InternalLoggerFactory.getLogger(LoggerName.NAMESRV_CONSOLE_NAME);
    MixAll.printObjectProperties(console, namesrvConfig);
    MixAll.printObjectProperties(console, nettyServerConfig);
    System.exit(0);
}
//å°†å¯åŠ¨å‚æ•°å¡«å……åˆ°namesrvConfig,nettyServerConfig
MixAll.properties2Object(ServerUtil.commandLine2Properties(commandLine), namesrvConfig);

//åˆ›å»ºNameServerController
final NamesrvController controller = new NamesrvController(namesrvConfig, nettyServerConfig);
```

<u>**NamesrvConfigå±æ€§**</u>

```java
private String rocketmqHome = System.getProperty(MixAll.ROCKETMQ_HOME_PROPERTY, System.getenv(MixAll.ROCKETMQ_HOME_ENV));
private String kvConfigPath = System.getProperty("user.home") + File.separator + "namesrv" + File.separator + "kvConfig.json";
private String configStorePath = System.getProperty("user.home") + File.separator + "namesrv" + File.separator + "namesrv.properties";
private String productEnvName = "center";
private boolean clusterTest = false;
private boolean orderMessageEnable = false;
```

**rocketmqHomeï¼š**rocketmqä¸»ç›®å½•

**kvConfigï¼š**NameServerå­˜å‚¨KVé…ç½®å±æ€§çš„æŒä¹…åŒ–è·¯å¾„

**configStorePathï¼š**nameServeré»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„

**orderMessageEnableï¼š**æ˜¯å¦æ”¯æŒé¡ºåºæ¶ˆæ¯

<u>**NettyServerConfigå±æ€§**</u>

```java
private int listenPort = 8888;
private int serverWorkerThreads = 8;
private int serverCallbackExecutorThreads = 0;
private int serverSelectorThreads = 3;
private int serverOnewaySemaphoreValue = 256;
private int serverAsyncSemaphoreValue = 64;
private int serverChannelMaxIdleTimeSeconds = 120;
private int serverSocketSndBufSize = NettySystemConfig.socketSndbufSize;
private int serverSocketRcvBufSize = NettySystemConfig.socketRcvbufSize;
private boolean serverPooledByteBufAllocatorEnable = true;
private boolean useEpollNativeSelector = false;
```

**listenPortï¼š**NameServerç›‘å¬ç«¯å£ï¼Œè¯¥å€¼é»˜è®¤ä¼šè¢«åˆå§‹åŒ–ä¸º9876
**serverWorkerThreadsï¼š**Nettyä¸šåŠ¡çº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°
**serverCallbackExecutorThreadsï¼š**Netty publicä»»åŠ¡çº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°ï¼ŒNettyç½‘ç»œè®¾è®¡ï¼Œæ ¹æ®ä¸šåŠ¡ç±»å‹ä¼šåˆ›å»ºä¸åŒçš„çº¿ç¨‹æ± ï¼Œæ¯”å¦‚å¤„ç†æ¶ˆæ¯å‘é€ã€æ¶ˆæ¯æ¶ˆè´¹ã€å¿ƒè·³æ£€æµ‹ç­‰ã€‚å¦‚æœè¯¥ä¸šåŠ¡ç±»å‹æœªæ³¨å†Œçº¿ç¨‹æ± ï¼Œåˆ™ç”±publicçº¿ç¨‹æ± æ‰§è¡Œã€‚
**serverSelectorThreadsï¼š**IOçº¿ç¨‹æ± ä¸ªæ•°ï¼Œä¸»è¦æ˜¯NameServerã€Brokerç«¯è§£æè¯·æ±‚ã€è¿”å›ç›¸åº”çš„çº¿ç¨‹ä¸ªæ•°ï¼Œè¿™ç±»çº¿ç¨‹ä¸»è¦æ˜¯å¤„ç†ç½‘è·¯è¯·æ±‚çš„ï¼Œè§£æè¯·æ±‚åŒ…ï¼Œç„¶åè½¬å‘åˆ°å„ä¸ªä¸šåŠ¡çº¿ç¨‹æ± å®Œæˆå…·ä½“çš„æ“ä½œï¼Œç„¶åå°†ç»“æœè¿”å›ç»™è°ƒç”¨æ–¹;
**serverOnewaySemaphoreValueï¼š**send onewayæ¶ˆæ¯è¯·æ±‚å¹¶å‘è¯»ï¼ˆBrokerç«¯å‚æ•°ï¼‰;
**serverAsyncSemaphoreValueï¼š**å¼‚æ­¥æ¶ˆæ¯å‘é€æœ€å¤§å¹¶å‘åº¦;
**serverChannelMaxIdleTimeSeconds ï¼š**ç½‘ç»œè¿æ¥æœ€å¤§çš„ç©ºé—²æ—¶é—´ï¼Œé»˜è®¤120sã€‚
**serverSocketSndBufSizeï¼š**ç½‘ç»œsocketå‘é€ç¼“å†²åŒºå¤§å°ã€‚
**serverSocketRcvBufSizeï¼š** ç½‘ç»œæ¥æ”¶ç«¯ç¼“å­˜åŒºå¤§å°ã€‚
**serverPooledByteBufAllocatorEnableï¼š**ByteBufferæ˜¯å¦å¼€å¯ç¼“å­˜;
**useEpollNativeSelectorï¼š**æ˜¯å¦å¯ç”¨Epoll IOæ¨¡å‹ã€‚

#### æ­¥éª¤äºŒ

æ ¹æ®å¯åŠ¨å±æ€§åˆ›å»ºNamesrvControllerå®ä¾‹ï¼Œå¹¶åˆå§‹åŒ–è¯¥å®ä¾‹ã€‚NameServerControllerå®ä¾‹ä¸ºNameServeræ ¸å¿ƒæ§åˆ¶å™¨

***ä»£ç ï¼šNamesrvController#initialize***

```java
public boolean initialize() {
	//åŠ è½½KVé…ç½®
    this.kvConfigManager.load();
	//åˆ›å»ºNettyServerç½‘ç»œå¤„ç†å¯¹è±¡
    this.remotingServer = new NettyRemotingServer(this.nettyServerConfig, this.brokerHousekeepingService);
	//å¼€å¯å®šæ—¶ä»»åŠ¡:æ¯éš”10sæ‰«æä¸€æ¬¡Broker,ç§»é™¤ä¸æ´»è·ƒçš„Broker
    this.remotingExecutor =
        Executors.newFixedThreadPool(nettyServerConfig.getServerWorkerThreads(), new ThreadFactoryImpl("RemotingExecutorThread_"));
    this.registerProcessor();
    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {
        @Override
        public void run() {
            NamesrvController.this.routeInfoManager.scanNotActiveBroker();
        }
    }, 5, 10, TimeUnit.SECONDS);
	//å¼€å¯å®šæ—¶ä»»åŠ¡:æ¯éš”10minæ‰“å°ä¸€æ¬¡KVé…ç½®
	this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {

        @Override
        public void run() {
            NamesrvController.this.kvConfigManager.printAllPeriodically();
        }
    }, 1, 10, TimeUnit.MINUTES);
    return true;
}
```

#### æ­¥éª¤ä¸‰

åœ¨JVMè¿›ç¨‹å…³é—­ä¹‹å‰ï¼Œå…ˆå°†çº¿ç¨‹æ± å…³é—­ï¼ŒåŠæ—¶é‡Šæ”¾èµ„æº

***ä»£ç ï¼šNamesrvStartup#start***

```java
//æ³¨å†ŒJVMé’©å­å‡½æ•°ä»£ç 
Runtime.getRuntime().addShutdownHook(new ShutdownHookThread(log, new Callable<Void>() {
    @Override
    public Void call() throws Exception {
        //é‡Šæ”¾èµ„æº
        controller.shutdown();
        return null;
    }
}));
```

### è·¯ç”±ç®¡ç† ğŸ¤”

NameServerçš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºæ¶ˆæ¯çš„ç”Ÿäº§è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…æä¾›å…³äºä¸»é¢˜Topicçš„è·¯ç”±ä¿¡æ¯ï¼Œé‚£ä¹ˆNameServeréœ€è¦å­˜å‚¨è·¯ç”±çš„åŸºç¡€ä¿¡æ¯ï¼Œè¿˜è¦ç®¡ç†BrokerèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬è·¯ç”±æ³¨å†Œã€è·¯ç”±åˆ é™¤ç­‰ã€‚

#### è·¯ç”±å…ƒä¿¡æ¯

***ä»£ç ï¼šRouteInfoManager***

```java
private final HashMap<String/* topic */, List<QueueData>> topicQueueTable;
private final HashMap<String/* brokerName */, BrokerData> brokerAddrTable;
private final HashMap<String/* clusterName */, Set<String/* brokerName */>> clusterAddrTable;
private final HashMap<String/* brokerAddr */, BrokerLiveInfo> brokerLiveTable;
private final HashMap<String/* brokerAddr */, List<String>/* Filter Server */> filterServerTable;
```

![](/assets/imgs/è·¯ç”±å®ä½“å›¾.png)

**topicQueueTableï¼š**Topicæ¶ˆæ¯é˜Ÿåˆ—è·¯ç”±ä¿¡æ¯ï¼Œæ¶ˆæ¯å‘é€æ—¶æ ¹æ®è·¯ç”±è¡¨è¿›è¡Œè´Ÿè½½å‡è¡¡

**brokerAddrTableï¼š**BrokeråŸºç¡€ä¿¡æ¯ï¼ŒåŒ…æ‹¬brokerNameã€æ‰€å±é›†ç¾¤åç§°ã€ä¸»å¤‡Brokeråœ°å€

**clusterAddrTableï¼š**Brokeré›†ç¾¤ä¿¡æ¯ï¼Œå­˜å‚¨é›†ç¾¤ä¸­æ‰€æœ‰Brokeråç§°

**brokerLiveTableï¼š**BrokerçŠ¶æ€ä¿¡æ¯ï¼ŒNameServeræ¯æ¬¡æ”¶åˆ°å¿ƒè·³åŒ…æ˜¯ä¼šæ›¿æ¢è¯¥ä¿¡æ¯

**filterServerTableï¼š**Brokerä¸Šçš„FilterServeråˆ—è¡¨ï¼Œç”¨äºç±»æ¨¡å¼æ¶ˆæ¯è¿‡æ»¤ã€‚

> RocketMQåŸºäºå®šäºå‘å¸ƒæœºåˆ¶ï¼Œä¸€ä¸ªTopicæ‹¥æœ‰å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸€ä¸ªBrokerä¸ºæ¯ä¸€ä¸ªä¸»é¢˜åˆ›å»º4ä¸ªè¯»é˜Ÿåˆ—å’Œ4ä¸ªå†™é˜Ÿåˆ—ã€‚å¤šä¸ªBrokerç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œé›†ç¾¤ç”±ç›¸åŒçš„å¤šå°Brokerç»„æˆMaster-Slaveæ¶æ„ï¼ŒbrokerIdä¸º0ä»£è¡¨Masterï¼Œå¤§äº0ä¸ºSlaveã€‚BrokerLiveInfoä¸­çš„lastUpdateTimestampå­˜å‚¨ä¸Šæ¬¡æ”¶åˆ°Brokerå¿ƒè·³åŒ…çš„æ—¶é—´ã€‚

![](/assets/imgs/å®ä½“æ•°æ®å®ä¾‹.png)

![](/assets/imgs/å®ä½“æ•°æ®å®ä¾‹2.png)

#### è·¯ç”±æ³¨å†Œ

#####1ï¼‰å‘é€å¿ƒè·³åŒ…

![](/assets/imgs/è·¯ç”±æ³¨å†Œ.png)

RocketMQè·¯ç”±æ³¨å†Œæ˜¯é€šè¿‡Brokerä¸NameServerçš„å¿ƒè·³åŠŸèƒ½å®ç°çš„ã€‚Brokerå¯åŠ¨æ—¶å‘é›†ç¾¤ä¸­æ‰€æœ‰çš„NameServerå‘é€å¿ƒè·³ä¿¡æ¯ï¼Œæ¯éš”30så‘é›†ç¾¤ä¸­æ‰€æœ‰NameServerå‘é€å¿ƒè·³åŒ…ï¼ŒNameServeræ”¶åˆ°å¿ƒè·³åŒ…æ—¶ä¼šæ›´æ–°brokerLiveTableç¼“å­˜ä¸­BrokerLiveInfoçš„lastUpdataTimeStampä¿¡æ¯ï¼Œç„¶åNameServeræ¯éš”10sæ‰«æbrokerLiveTableï¼Œå¦‚æœè¿ç»­120Sæ²¡æœ‰æ”¶åˆ°å¿ƒè·³åŒ…ï¼ŒNameServerå°†ç§»é™¤Brokerçš„è·¯ç”±ä¿¡æ¯åŒæ—¶å…³é—­Socketè¿æ¥ã€‚

***ä»£ç ï¼šBrokerController#start***

```java
//æ³¨å†ŒBrokerä¿¡æ¯
this.registerBrokerAll(true, false, true);
//æ¯éš”30sä¸ŠæŠ¥Brokerä¿¡æ¯åˆ°NameServer
this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {

    @Override
    public void run() {
        try {
            BrokerController.this.registerBrokerAll(true, false, brokerConfig.isForceRegister());
        } catch (Throwable e) {
            log.error("registerBrokerAll Exception", e);
        }
    }
}, 1000 * 10, Math.max(10000, Math.min(brokerConfig.getRegisterNameServerPeriod(), 60000)), 
                                                  TimeUnit.MILLISECONDS);

```

***ä»£ç ï¼šBrokerOuterAPI#registerBrokerAll***

```java
//è·å¾—nameServeråœ°å€ä¿¡æ¯
List<String> nameServerAddressList = this.remotingClient.getNameServerAddressList();
//éå†æ‰€æœ‰nameserveråˆ—è¡¨
if (nameServerAddressList != null && nameServerAddressList.size() > 0) {

    //å°è£…è¯·æ±‚å¤´
    final RegisterBrokerRequestHeader requestHeader = new RegisterBrokerRequestHeader();
    requestHeader.setBrokerAddr(brokerAddr);
    requestHeader.setBrokerId(brokerId);
    requestHeader.setBrokerName(brokerName);
    requestHeader.setClusterName(clusterName);
    requestHeader.setHaServerAddr(haServerAddr);
    requestHeader.setCompressed(compressed);
	//å°è£…è¯·æ±‚ä½“
    RegisterBrokerBody requestBody = new RegisterBrokerBody();
    requestBody.setTopicConfigSerializeWrapper(topicConfigWrapper);
    requestBody.setFilterServerList(filterServerList);
    final byte[] body = requestBody.encode(compressed);
    final int bodyCrc32 = UtilAll.crc32(body);
    requestHeader.setBodyCrc32(bodyCrc32);
    final CountDownLatch countDownLatch = new CountDownLatch(nameServerAddressList.size());
    for (final String namesrvAddr : nameServerAddressList) {
        brokerOuterExecutor.execute(new Runnable() {
            @Override
            public void run() {
                try {
                    //åˆ†åˆ«å‘NameServeræ³¨å†Œ
                    RegisterBrokerResult result = registerBroker(namesrvAddr,oneway, timeoutMills,requestHeader,body);
                    if (result != null) {
                        registerBrokerResultList.add(result);
                    }

                    log.info("register broker[{}]to name server {} OK", brokerId, namesrvAddr);
                } catch (Exception e) {
                    log.warn("registerBroker Exception, {}", namesrvAddr, e);
                } finally {
                    countDownLatch.countDown();
                }
            }
        });
    }

    try {
        countDownLatch.await(timeoutMills, TimeUnit.MILLISECONDS);
    } catch (InterruptedException e) {
    }
}
```

***ä»£ç ï¼šBrokerOutAPI#registerBroker***

```java
if (oneway) {
    try {
        this.remotingClient.invokeOneway(namesrvAddr, request, timeoutMills);
    } catch (RemotingTooMuchRequestException e) {
        // Ignore
    }
    return null;
}
RemotingCommand response = this.remotingClient.invokeSync(namesrvAddr, request, timeoutMills);
```

##### 2ï¼‰å¤„ç†å¿ƒè·³åŒ…

![](/assets/imgs/NameServerå¤„ç†è·¯ç”±æ³¨å†Œ.png)

`org.apache.rocketmq.namesrv.processor.DefaultRequestProcessor`ç½‘è·¯å¤„ç†ç±»è§£æè¯·æ±‚ç±»å‹ï¼Œå¦‚æœè¯·æ±‚ç±»å‹æ˜¯ä¸º***REGISTER_BROKER***ï¼Œåˆ™å°†è¯·æ±‚è½¬å‘åˆ°`RouteInfoManager#regiesterBroker`

***ä»£ç ï¼šDefaultRequestProcessor#processRequest***

```java
//åˆ¤æ–­æ˜¯æ³¨å†ŒBrokerä¿¡æ¯
case RequestCode.REGISTER_BROKER:
	Version brokerVersion = MQVersion.value2Version(request.getVersion());
	if (brokerVersion.ordinal() >= MQVersion.Version.V3_0_11.ordinal()) {
	    return this.registerBrokerWithFilterServer(ctx, request);
	} else {
        //æ³¨å†ŒBrokerä¿¡æ¯
	    return this.registerBroker(ctx, request);
	}
```

***ä»£ç ï¼šDefaultRequestProcessor#registerBroker***

```java
RegisterBrokerResult result = this.namesrvController.getRouteInfoManager().registerBroker(
    requestHeader.getClusterName(),
    requestHeader.getBrokerAddr(),
    requestHeader.getBrokerName(),
    requestHeader.getBrokerId(),
    requestHeader.getHaServerAddr(),
    topicConfigWrapper,
    null,
    ctx.channel()
);
```

***ä»£ç ï¼šRouteInfoManager#registerBroker***

ç»´æŠ¤è·¯ç”±ä¿¡æ¯

```java
//åŠ é”
this.lock.writeLock().lockInterruptibly();
//ç»´æŠ¤clusterAddrTable
Set<String> brokerNames = this.clusterAddrTable.get(clusterName);
if (null == brokerNames) {
    brokerNames = new HashSet<String>();
    this.clusterAddrTable.put(clusterName, brokerNames);
}
brokerNames.add(brokerName);
```

```java
//ç»´æŠ¤brokerAddrTable
BrokerData brokerData = this.brokerAddrTable.get(brokerName);
//ç¬¬ä¸€æ¬¡æ³¨å†Œ,åˆ™åˆ›å»ºbrokerData
if (null == brokerData) {
    registerFirst = true;
    brokerData = new BrokerData(clusterName, brokerName, new HashMap<Long, String>());
    this.brokerAddrTable.put(brokerName, brokerData);
}
//éç¬¬ä¸€æ¬¡æ³¨å†Œ,æ›´æ–°Broker
Map<Long, String> brokerAddrsMap = brokerData.getBrokerAddrs();
Iterator<Entry<Long, String>> it = brokerAddrsMap.entrySet().iterator();
while (it.hasNext()) {
    Entry<Long, String> item = it.next();
    if (null != brokerAddr && brokerAddr.equals(item.getValue()) && brokerId != item.getKey()) {
        it.remove();
    }
}
String oldAddr = brokerData.getBrokerAddrs().put(brokerId, brokerAddr);
registerFirst = registerFirst || (null == oldAddr);
```

```java
//ç»´æŠ¤topicQueueTable
if (null != topicConfigWrapper && MixAll.MASTER_ID == brokerId) {
    if (this.isBrokerTopicConfigChanged(brokerAddr, topicConfigWrapper.getDataVersion()) || 
        registerFirst) {
        ConcurrentMap<String, TopicConfig> tcTable = topicConfigWrapper.getTopicConfigTable();
        if (tcTable != null) {
            for (Map.Entry<String, TopicConfig> entry : tcTable.entrySet()) {
                this.createAndUpdateQueueData(brokerName, entry.getValue());
            }
        }
    }
}
```

***ä»£ç ï¼šRouteInfoManager#createAndUpdateQueueData***

```java
private void createAndUpdateQueueData(final String brokerName, final TopicConfig topicConfig) {
    //åˆ›å»ºQueueData
	QueueData queueData = new QueueData();
	queueData.setBrokerName(brokerName);
	queueData.setWriteQueueNums(topicConfig.getWriteQueueNums());
	queueData.setReadQueueNums(topicConfig.getReadQueueNums());
	queueData.setPerm(topicConfig.getPerm());
	queueData.setTopicSynFlag(topicConfig.getTopicSysFlag());
	//è·å¾—topicQueueTableä¸­é˜Ÿåˆ—é›†åˆ
	List<QueueData> queueDataList = this.topicQueueTable.get(topicConfig.getTopicName());
    //topicQueueTableä¸ºç©º,åˆ™ç›´æ¥æ·»åŠ queueDataåˆ°é˜Ÿåˆ—é›†åˆ
	if (null == queueDataList) {
	    queueDataList = new LinkedList<QueueData>();
	    queueDataList.add(queueData);
	    this.topicQueueTable.put(topicConfig.getTopicName(), queueDataList);
	    log.info("new topic registered, {} {}", topicConfig.getTopicName(), queueData);
	} else {
        //åˆ¤æ–­æ˜¯å¦æ˜¯æ–°çš„é˜Ÿåˆ—
	    boolean addNewOne = true;
	    Iterator<QueueData> it = queueDataList.iterator();
	    while (it.hasNext()) {
	        QueueData qd = it.next();
            //å¦‚æœbrokerNameç›¸åŒ,ä»£è¡¨ä¸æ˜¯æ–°çš„é˜Ÿåˆ—
	        if (qd.getBrokerName().equals(brokerName)) {
	            if (qd.equals(queueData)) {
	                addNewOne = false;
	        } else {
	                    log.info("topic changed, {} OLD: {} NEW: {}", topicConfig.getTopicName(), qd,
	                        queueData);
	                    it.remove();
	                }
	            }
	        }
		//å¦‚æœæ˜¯æ–°çš„é˜Ÿåˆ—,åˆ™æ·»åŠ é˜Ÿåˆ—åˆ°queueDataList
        if (addNewOne) {
            queueDataList.add(queueData);
        }
    }
}
```

```java
//ç»´æŠ¤brokerLiveTable
BrokerLiveInfo prevBrokerLiveInfo = this.brokerLiveTable.put(brokerAddr,new BrokerLiveInfo(
    System.currentTimeMillis(),
    topicConfigWrapper.getDataVersion(),
    channel,
    haServerAddr));
```

```java
//ç»´æŠ¤filterServerList
if (filterServerList != null) {
    if (filterServerList.isEmpty()) {
        this.filterServerTable.remove(brokerAddr);
    } else {
        this.filterServerTable.put(brokerAddr, filterServerList);
    }
}

if (MixAll.MASTER_ID != brokerId) {
    String masterAddr = brokerData.getBrokerAddrs().get(MixAll.MASTER_ID);
    if (masterAddr != null) {
        BrokerLiveInfo brokerLiveInfo = this.brokerLiveTable.get(masterAddr);
        if (brokerLiveInfo != null) {
            result.setHaServerAddr(brokerLiveInfo.getHaServerAddr());
            result.setMasterAddr(masterAddr);
        }
    }
}
```

#### è·¯ç”±åˆ é™¤

```Broker```æ¯éš”30så‘```NameServer```å‘é€ä¸€ä¸ªå¿ƒè·³åŒ…ï¼Œå¿ƒè·³åŒ…åŒ…å«`BrokerId`ï¼Œ`Broker`åœ°å€ï¼Œ`Broker`åç§°ï¼Œ`Broker`æ‰€å±é›†ç¾¤åç§°ã€`Broker`å…³è”çš„`FilterServer`åˆ—è¡¨ã€‚ä½†æ˜¯å¦‚æœ`Broker`å®•æœºï¼Œ`NameServer`æ— æ³•æ”¶åˆ°å¿ƒè·³åŒ…ï¼Œæ­¤æ—¶`NameServer`å¦‚ä½•æ¥å‰”é™¤è¿™äº›å¤±æ•ˆçš„`Broker`å‘¢ï¼Ÿ`NameServer`ä¼šæ¯éš”10sæ‰«æ`brokerLiveTable`çŠ¶æ€è¡¨ï¼Œå¦‚æœ`BrokerLive`çš„**lastUpdateTimestamp**çš„æ—¶é—´æˆ³è·å½“å‰æ—¶é—´è¶…è¿‡120sï¼Œåˆ™è®¤ä¸º`Broker`å¤±æ•ˆï¼Œç§»é™¤è¯¥`Broker`ï¼Œå…³é—­ä¸`Broker`è¿æ¥ï¼ŒåŒæ—¶æ›´æ–°`topicQueueTable`ã€`brokerAddrTable`ã€`brokerLiveTable`ã€`filterServerTable`ã€‚

**RocketMQæœ‰ä¸¤ä¸ªè§¦å‘ç‚¹æ¥åˆ é™¤è·¯ç”±ä¿¡æ¯**ï¼š

* NameServerå®šæœŸæ‰«æbrokerLiveTableæ£€æµ‹ä¸Šæ¬¡å¿ƒè·³åŒ…ä¸å½“å‰ç³»ç»Ÿçš„æ—¶é—´å·®ï¼Œå¦‚æœæ—¶é—´è¶…è¿‡120sï¼Œåˆ™éœ€è¦ç§»é™¤brokerã€‚
* Brokeråœ¨æ­£å¸¸å…³é—­çš„æƒ…å†µä¸‹ï¼Œä¼šæ‰§è¡ŒunregisterBrokeræŒ‡ä»¤

è¿™ä¸¤ç§æ–¹å¼è·¯ç”±åˆ é™¤çš„æ–¹æ³•éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯ä»ç›¸å…³è·¯ç”±è¡¨ä¸­åˆ é™¤ä¸è¯¥brokerç›¸å…³çš„ä¿¡æ¯ã€‚

![](/assets/imgs/è·¯ç”±åˆ é™¤.png)

***ä»£ç ï¼šNamesrvController#initialize***

```java
//æ¯éš”10sæ‰«æä¸€æ¬¡ä¸ºæ´»è·ƒBroker
this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {

    @Override
    public void run() {
        NamesrvController.this.routeInfoManager.scanNotActiveBroker();
    }
}, 5, 10, TimeUnit.SECONDS);
```

***ä»£ç ï¼šRouteInfoManager#scanNotActiveBroker***

```java
public void scanNotActiveBroker() {
    //è·å¾—brokerLiveTable
    Iterator<Entry<String, BrokerLiveInfo>> it = this.brokerLiveTable.entrySet().iterator();
    //éå†brokerLiveTable
    while (it.hasNext()) {
        Entry<String, BrokerLiveInfo> next = it.next();
        long last = next.getValue().getLastUpdateTimestamp();
        //å¦‚æœæ”¶åˆ°å¿ƒè·³åŒ…çš„æ—¶é—´è·å½“æ—¶æ—¶é—´æ˜¯å¦è¶…è¿‡120s
        if ((last + BROKER_CHANNEL_EXPIRED_TIME) < System.currentTimeMillis()) {
            //å…³é—­è¿æ¥
            RemotingUtil.closeChannel(next.getValue().getChannel());
            //ç§»é™¤broker
            it.remove();
            //ç»´æŠ¤è·¯ç”±è¡¨
            this.onChannelDestroy(next.getKey(), next.getValue().getChannel());
        }
    }
}
```

***ä»£ç ï¼šRouteInfoManager#onChannelDestroy***

```java
//ç”³è¯·å†™é”,æ ¹æ®brokerAddressä»brokerLiveTableå’ŒfilterServerTableç§»é™¤
this.lock.writeLock().lockInterruptibly();
this.brokerLiveTable.remove(brokerAddrFound);
this.filterServerTable.remove(brokerAddrFound);
```

```java
//ç»´æŠ¤brokerAddrTable
String brokerNameFound = null;
boolean removeBrokerName = false;
Iterator<Entry<String, BrokerData>> itBrokerAddrTable =this.brokerAddrTable.entrySet().iterator();
//éå†brokerAddrTable
while (itBrokerAddrTable.hasNext() && (null == brokerNameFound)) {
    BrokerData brokerData = itBrokerAddrTable.next().getValue();
    //éå†brokeråœ°å€
    Iterator<Entry<Long, String>> it = brokerData.getBrokerAddrs().entrySet().iterator();
    while (it.hasNext()) {
        Entry<Long, String> entry = it.next();
        Long brokerId = entry.getKey();
        String brokerAddr = entry.getValue();
        //æ ¹æ®brokeråœ°å€ç§»é™¤brokerAddr
        if (brokerAddr.equals(brokerAddrFound)) {
            brokerNameFound = brokerData.getBrokerName();
            it.remove();
            log.info("remove brokerAddr[{}, {}] from brokerAddrTable, because channel destroyed",
                brokerId, brokerAddr);
            break;
        }
    }
	//å¦‚æœå½“å‰ä¸»é¢˜åªåŒ…å«å¾…ç§»é™¤çš„broker,åˆ™ç§»é™¤è¯¥topic
    if (brokerData.getBrokerAddrs().isEmpty()) {
        removeBrokerName = true;
        itBrokerAddrTable.remove();
        log.info("remove brokerName[{}] from brokerAddrTable, because channel destroyed",
            brokerData.getBrokerName());
    }
}
```

```java
//ç»´æŠ¤clusterAddrTable
if (brokerNameFound != null && removeBrokerName) {
    Iterator<Entry<String, Set<String>>> it = this.clusterAddrTable.entrySet().iterator();
    //éå†clusterAddrTable
    while (it.hasNext()) {
        Entry<String, Set<String>> entry = it.next();
        //è·å¾—é›†ç¾¤åç§°
        String clusterName = entry.getKey();
        //è·å¾—é›†ç¾¤ä¸­brokerNameé›†åˆ
        Set<String> brokerNames = entry.getValue();
        //ä»brokerNamesä¸­ç§»é™¤brokerNameFound
        boolean removed = brokerNames.remove(brokerNameFound);
        if (removed) {
            log.info("remove brokerName[{}], clusterName[{}] from clusterAddrTable, because channel destroyed",
                brokerNameFound, clusterName);

            if (brokerNames.isEmpty()) {
                log.info("remove the clusterName[{}] from clusterAddrTable, because channel destroyed and no broker in this cluster",
                    clusterName);
                //å¦‚æœé›†ç¾¤ä¸­ä¸åŒ…å«ä»»ä½•broker,åˆ™ç§»é™¤è¯¥é›†ç¾¤
                it.remove();
            }

            break;
        }
    }
}
```

```java
//ç»´æŠ¤topicQueueTableé˜Ÿåˆ—
if (removeBrokerName) {
    //éå†topicQueueTable
    Iterator<Entry<String, List<QueueData>>> itTopicQueueTable =
        this.topicQueueTable.entrySet().iterator();
    while (itTopicQueueTable.hasNext()) {
        Entry<String, List<QueueData>> entry = itTopicQueueTable.next();
        //ä¸»é¢˜åç§°
        String topic = entry.getKey();
        //é˜Ÿåˆ—é›†åˆ
        List<QueueData> queueDataList = entry.getValue();
		//éå†è¯¥ä¸»é¢˜é˜Ÿåˆ—
        Iterator<QueueData> itQueueData = queueDataList.iterator();
        while (itQueueData.hasNext()) {
            //ä»é˜Ÿåˆ—ä¸­ç§»é™¤ä¸ºæ´»è·ƒbrokerä¿¡æ¯
            QueueData queueData = itQueueData.next();
            if (queueData.getBrokerName().equals(brokerNameFound)) {
                itQueueData.remove();
                log.info("remove topic[{} {}], from topicQueueTable, because channel destroyed",
                    topic, queueData);
            }
        }
		//å¦‚æœè¯¥topicçš„é˜Ÿåˆ—ä¸ºç©º,åˆ™ç§»é™¤è¯¥topic
        if (queueDataList.isEmpty()) {
            itTopicQueueTable.remove();
            log.info("remove topic[{}] all queue, from topicQueueTable, because channel destroyed",
                topic);
        }
    }
}
```

```java
//é‡Šæ”¾å†™é”
finally {
    this.lock.writeLock().unlock();
}
```

#### è·¯ç”±å‘ç°

RocketMQè·¯ç”±å‘ç°æ˜¯éå®æ—¶çš„ï¼Œå½“Topicè·¯ç”±å‡ºç°å˜åŒ–åï¼ŒNameServerä¸ä¼šä¸»åŠ¨æ¨é€ç»™å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯ç”±å®¢æˆ·ç«¯å®šæ—¶æ‹‰å–ä¸»é¢˜æœ€æ–°çš„è·¯ç”±ã€‚

***ä»£ç ï¼šDefaultRequestProcessor#getRouteInfoByTopic***

```java
public RemotingCommand getRouteInfoByTopic(ChannelHandlerContext ctx,
    RemotingCommand request) throws RemotingCommandException {
    final RemotingCommand response = RemotingCommand.createResponseCommand(null);
    final GetRouteInfoRequestHeader requestHeader =
        (GetRouteInfoRequestHeader) request.decodeCommandCustomHeader(GetRouteInfoRequestHeader.class);
	//è°ƒç”¨RouteInfoManagerçš„æ–¹æ³•,ä»è·¯ç”±è¡¨topicQueueTableã€brokerAddrTableã€filterServerTableä¸­åˆ†åˆ«å¡«å……TopicRouteDataçš„List<QueueData>ã€List<BrokerData>ã€filterServer
    TopicRouteData topicRouteData = this.namesrvController.getRouteInfoManager().pickupTopicRouteData(requestHeader.getTopic());
	//å¦‚æœæ‰¾åˆ°ä¸»é¢˜å¯¹åº”ä½ çš„è·¯ç”±ä¿¡æ¯å¹¶ä¸”è¯¥ä¸»é¢˜ä¸ºé¡ºåºæ¶ˆæ¯ï¼Œåˆ™ä»NameServer KVConfigä¸­è·å–å…³äºé¡ºåºæ¶ˆæ¯ç›¸å…³çš„é…ç½®å¡«å……è·¯ç”±ä¿¡æ¯
    if (topicRouteData != null) {
        if (this.namesrvController.getNamesrvConfig().isOrderMessageEnable()) {
            String orderTopicConf =
                this.namesrvController.getKvConfigManager().getKVConfig(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG,
                    requestHeader.getTopic());
            topicRouteData.setOrderTopicConf(orderTopicConf);
        }

        byte[] content = topicRouteData.encode();
        response.setBody(content);
        response.setCode(ResponseCode.SUCCESS);
        response.setRemark(null);
        return response;
    }

    response.setCode(ResponseCode.TOPIC_NOT_EXIST);
    response.setRemark("No topic route info in name server for the topic: " + requestHeader.getTopic()
        + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));
    return response;
}
```

### å°ç»“

![](/assets/imgs/NameServerå°ç»“.png)

## Producer

æ¶ˆæ¯ç”Ÿäº§è€…çš„ä»£ç éƒ½åœ¨clientæ¨¡å—ä¸­ï¼Œç›¸å¯¹äºRocketMQæ¥è®²ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…å°±æ˜¯å®¢æˆ·ç«¯ï¼Œä¹Ÿæ˜¯æ¶ˆæ¯çš„æä¾›è€…ã€‚

![](/assets/imgs/DefaultMQProducerç±»å›¾.png)

###æ–¹æ³•å’Œå±æ€§

####1ï¼‰ä¸»è¦æ–¹æ³•ä»‹ç»

![](/assets/imgs/MQAdmin.png)

* ```java
  //åˆ›å»ºä¸»é¢˜
  void createTopic(final String key, final String newTopic, final int queueNum) throws MQClientException;
  ```

* ```java
  //æ ¹æ®æ—¶é—´æˆ³ä»é˜Ÿåˆ—ä¸­æŸ¥æ‰¾æ¶ˆæ¯åç§»é‡
  long searchOffset(final MessageQueue mq, final long timestamp)
  ```

* ```java
  //æŸ¥æ‰¾æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ€å¤§çš„åç§»é‡
  long maxOffset(final MessageQueue mq) throws MQClientException;
  ```

* ```java
  //æŸ¥æ‰¾æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ€å°çš„åç§»é‡
  long minOffset(final MessageQueue mq) 
  ```

* ```java
  //æ ¹æ®åç§»é‡æŸ¥æ‰¾æ¶ˆæ¯
  MessageExt viewMessage(final String offsetMsgId) throws RemotingException, MQBrokerException,
          InterruptedException, MQClientException;
  ```

* ```java
  //æ ¹æ®æ¡ä»¶æŸ¥æ‰¾æ¶ˆæ¯
  QueryResult queryMessage(final String topic, final String key, final int maxNum, final long begin,
          final long end) throws MQClientException, InterruptedException;
  ```

* ```java
  //æ ¹æ®æ¶ˆæ¯IDå’Œä¸»é¢˜æŸ¥æ‰¾æ¶ˆæ¯
  MessageExt viewMessage(String topic,String msgId) throws RemotingException, MQBrokerException, InterruptedException, MQClientException;
  ```

![](/assets/imgs/MQProducer.png)

* ```java
  //å¯åŠ¨
  void start() throws MQClientException;
  ```

* ```java
  //å…³é—­
  void shutdown();
  ```

* ```java
  //æŸ¥æ‰¾è¯¥ä¸»é¢˜ä¸‹æ‰€æœ‰æ¶ˆæ¯
  List<MessageQueue> fetchPublishMessageQueues(final String topic) throws MQClientException;
  ```

* ```java
  //åŒæ­¥å‘é€æ¶ˆæ¯
  SendResult send(final Message msg) throws MQClientException, RemotingException, MQBrokerException,
          InterruptedException;
  ```

* ```java
  //åŒæ­¥è¶…æ—¶å‘é€æ¶ˆæ¯
  SendResult send(final Message msg, final long timeout) throws MQClientException,
          RemotingException, MQBrokerException, InterruptedException;
  ```

* ```java
  //å¼‚æ­¥å‘é€æ¶ˆæ¯
  void send(final Message msg, final SendCallback sendCallback) throws MQClientException,
          RemotingException, InterruptedException;
  ```

* ```java
  //å¼‚æ­¥è¶…æ—¶å‘é€æ¶ˆæ¯
  void send(final Message msg, final SendCallback sendCallback, final long timeout)
      throws MQClientException, RemotingException, InterruptedException;
  ```

* ```java
  //å‘é€å•å‘æ¶ˆæ¯
  void sendOneway(final Message msg) throws MQClientException, RemotingException,
      InterruptedException;
  ```

* ```java
  //é€‰æ‹©æŒ‡å®šé˜Ÿåˆ—åŒæ­¥å‘é€æ¶ˆæ¯
  SendResult send(final Message msg, final MessageQueue mq) throws MQClientException,
      RemotingException, MQBrokerException, InterruptedException;
  ```

* ```java
  //é€‰æ‹©æŒ‡å®šé˜Ÿåˆ—å¼‚æ­¥å‘é€æ¶ˆæ¯
  void send(final Message msg, final MessageQueue mq, final SendCallback sendCallback)
      throws MQClientException, RemotingException, InterruptedException;
  ```

* ```java
  //é€‰æ‹©æŒ‡å®šé˜Ÿåˆ—å•é¡¹å‘é€æ¶ˆæ¯
  void sendOneway(final Message msg, final MessageQueue mq) throws MQClientException,
      RemotingException, InterruptedException;
  ```

* ```java
  //æ‰¹é‡å‘é€æ¶ˆæ¯
  SendResult send(final Collection<Message> msgs) throws MQClientException, RemotingException, MQBrokerException,InterruptedException;
  ```

####2ï¼‰å±æ€§ä»‹ç»

![](/assets/imgs/DefaultMQProducerå±æ€§.png)

```java
producerGroupï¼šç”Ÿäº§è€…æ‰€å±ç»„
createTopicKeyï¼šé»˜è®¤Topic
defaultTopicQueueNumsï¼šé»˜è®¤ä¸»é¢˜åœ¨æ¯ä¸€ä¸ªBrokeré˜Ÿåˆ—æ•°é‡
sendMsgTimeoutï¼šå‘é€æ¶ˆæ¯é»˜è®¤è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤3s
compressMsgBodyOverHowmuchï¼šæ¶ˆæ¯ä½“è¶…è¿‡è¯¥å€¼åˆ™å¯ç”¨å‹ç¼©ï¼Œé»˜è®¤4k
retryTimesWhenSendFailedï¼šåŒæ­¥æ–¹å¼å‘é€æ¶ˆæ¯é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º2ï¼Œæ€»å…±æ‰§è¡Œ3æ¬¡
retryTimesWhenSendAsyncFailedï¼šå¼‚æ­¥æ–¹æ³•å‘é€æ¶ˆæ¯é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º2
retryAnotherBrokerWhenNotStoreOKï¼šæ¶ˆæ¯é‡è¯•æ—¶é€‰æ‹©å¦å¤–ä¸€ä¸ªBrokeræ—¶ï¼Œæ˜¯å¦ä¸ç­‰å¾…å­˜å‚¨ç»“æœå°±è¿”å›ï¼Œé»˜è®¤ä¸ºfalse
maxMessageSizeï¼šå…è®¸å‘é€çš„æœ€å¤§æ¶ˆæ¯é•¿åº¦ï¼Œé»˜è®¤ä¸º4M
```

### å¯åŠ¨æµç¨‹

![](/assets/imgs/ç”Ÿäº§è€…å¯åŠ¨æµç¨‹.png)

***ä»£ç ï¼šDefaultMQProducerImpl#start***

```java
//æ£€æŸ¥ç”Ÿäº§è€…ç»„æ˜¯å¦æ»¡è¶³è¦æ±‚
this.checkConfig();
//æ›´æ”¹å½“å‰instanceNameä¸ºè¿›ç¨‹ID
if (!this.defaultMQProducer.getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP)) {
    this.defaultMQProducer.changeInstanceNameToPID();
}
//è·å¾—MQå®¢æˆ·ç«¯å®ä¾‹
this.mQClientFactory = MQClientManager.getInstance().getAndCreateMQClientInstance(this.defaultMQProducer, rpcHook);
```

>æ•´ä¸ªJVMä¸­åªå­˜åœ¨ä¸€ä¸ªMQClientManagerå®ä¾‹ï¼Œç»´æŠ¤ä¸€ä¸ªMQClientInstanceç¼“å­˜è¡¨
>
>ConcurrentMap<String/* clientId */, MQClientInstance> factoryTable = new ConcurrentHashMap<String,MQClientInstance>();
>
>åŒä¸€ä¸ªclientIdåªä¼šåˆ›å»ºä¸€ä¸ªMQClientInstanceã€‚
>
>MQClientInstanceå°è£…äº†RocketMQç½‘ç»œå¤„ç†APIï¼Œæ˜¯æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…ä¸NameServerã€Brokeræ‰“äº¤é“çš„ç½‘ç»œé€šé“

***ä»£ç ï¼šMQClientManager#getAndCreateMQClientInstance***

```java
public MQClientInstance getAndCreateMQClientInstance(final ClientConfig clientConfig, 
                                                     RPCHook rpcHook) {
    //æ„å»ºå®¢æˆ·ç«¯ID
    String clientId = clientConfig.buildMQClientId();
    //æ ¹æ®å®¢æˆ·ç«¯IDæˆ–è€…å®¢æˆ·ç«¯å®ä¾‹
    MQClientInstance instance = this.factoryTable.get(clientId);
    //å®ä¾‹å¦‚æœä¸ºç©ºå°±åˆ›å»ºæ–°çš„å®ä¾‹,å¹¶æ·»åŠ åˆ°å®ä¾‹è¡¨ä¸­
    if (null == instance) {
        instance =
            new MQClientInstance(clientConfig.cloneClientConfig(),
                this.factoryIndexGenerator.getAndIncrement(), clientId, rpcHook);
        MQClientInstance prev = this.factoryTable.putIfAbsent(clientId, instance);
        if (prev != null) {
            instance = prev;
            log.warn("Returned Previous MQClientInstance for clientId:[{}]", clientId);
        } else {
            log.info("Created new MQClientInstance for clientId:[{}]", clientId);
        }
    }

    return instance;
}
```

***ä»£ç ï¼šDefaultMQProducerImpl#start***

```java
//æ³¨å†Œå½“å‰ç”Ÿäº§è€…åˆ°åˆ°MQClientInstanceç®¡ç†ä¸­,æ–¹ä¾¿åç»­è°ƒç”¨ç½‘è·¯è¯·æ±‚
boolean registerOK = mQClientFactory.registerProducer(this.defaultMQProducer.getProducerGroup(), this);
if (!registerOK) {
    this.serviceState = ServiceState.CREATE_JUST;
    throw new MQClientException("The producer group[" + this.defaultMQProducer.getProducerGroup()
        + "] has been created before, specify another name please." + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),
        null);
}
//å¯åŠ¨ç”Ÿäº§è€…
if (startFactory) {
    mQClientFactory.start();
}
```

### æ¶ˆæ¯å‘é€

![](/assets/imgs/æ¶ˆæ¯å‘é€.png)

***ä»£ç ï¼šDefaultMQProducerImpl#send(Message msg)***

```java
//å‘é€æ¶ˆæ¯
public SendResult send(Message msg) {
    return send(msg, this.defaultMQProducer.getSendMsgTimeout());
}
```

***ä»£ç ï¼šDefaultMQProducerImpl#send(Message msg,long timeout)***

```java
//å‘é€æ¶ˆæ¯,é»˜è®¤è¶…æ—¶æ—¶é—´ä¸º3s
public SendResult send(Message msg,long timeout){
    return this.sendDefaultImpl(msg, CommunicationMode.SYNC, null, timeout);
}
```

***ä»£ç ï¼šDefaultMQProducerImpl#sendDefaultImpl***

```java
//æ ¡éªŒæ¶ˆæ¯
Validators.checkMessage(msg, this.defaultMQProducer);
```

####1ï¼‰éªŒè¯æ¶ˆæ¯

***ä»£ç ï¼šValidators#checkMessage***

```java
public static void checkMessage(Message msg, DefaultMQProducer defaultMQProducer)
    throws MQClientException {
    //åˆ¤æ–­æ˜¯å¦ä¸ºç©º
    if (null == msg) {
        throw new MQClientException(ResponseCode.MESSAGE_ILLEGAL, "the message is null");
    }
    // æ ¡éªŒä¸»é¢˜
    Validators.checkTopic(msg.getTopic());
		
    // æ ¡éªŒæ¶ˆæ¯ä½“
    if (null == msg.getBody()) {
        throw new MQClientException(ResponseCode.MESSAGE_ILLEGAL, "the message body is null");
    }

    if (0 == msg.getBody().length) {
        throw new MQClientException(ResponseCode.MESSAGE_ILLEGAL, "the message body length is zero");
    }

    if (msg.getBody().length > defaultMQProducer.getMaxMessageSize()) {
        throw new MQClientException(ResponseCode.MESSAGE_ILLEGAL,
            "the message body size over max value, MAX: " + defaultMQProducer.getMaxMessageSize());
    }
}
```

####2ï¼‰æŸ¥æ‰¾è·¯ç”±

***ä»£ç ï¼šDefaultMQProducerImpl#tryToFindTopicPublishInfo***

```java
private TopicPublishInfo tryToFindTopicPublishInfo(final String topic) {
    //ä»ç¼“å­˜ä¸­è·å¾—ä¸»é¢˜çš„è·¯ç”±ä¿¡æ¯
    TopicPublishInfo topicPublishInfo = this.topicPublishInfoTable.get(topic);
    //è·¯ç”±ä¿¡æ¯ä¸ºç©º,åˆ™ä»NameServerè·å–è·¯ç”±
    if (null == topicPublishInfo || !topicPublishInfo.ok()) {
        this.topicPublishInfoTable.putIfAbsent(topic, new TopicPublishInfo());
        this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);
        topicPublishInfo = this.topicPublishInfoTable.get(topic);
    }

    if (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) {
        return topicPublishInfo;
    } else {
        //å¦‚æœæœªæ‰¾åˆ°å½“å‰ä¸»é¢˜çš„è·¯ç”±ä¿¡æ¯,åˆ™ç”¨é»˜è®¤ä¸»é¢˜ç»§ç»­æŸ¥æ‰¾
        this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, true, this.defaultMQProducer);
        topicPublishInfo = this.topicPublishInfoTable.get(topic);
        return topicPublishInfo;
    }
}
```

![](/assets/imgs/Topicè·¯ç”±ä¿¡æ¯.png)

***ä»£ç ï¼šTopicPublishInfo***

```java
public class TopicPublishInfo {
    private boolean orderTopic = false;	//æ˜¯å¦æ˜¯é¡ºåºæ¶ˆæ¯
    private boolean haveTopicRouterInfo = false; 
    private List<MessageQueue> messageQueueList = new ArrayList<MessageQueue>();	//è¯¥ä¸»é¢˜æ¶ˆæ¯é˜Ÿåˆ—
    private volatile ThreadLocalIndex sendWhichQueue = new ThreadLocalIndex();//æ¯é€‰æ‹©ä¸€æ¬¡æ¶ˆæ¯é˜Ÿåˆ—,è¯¥å€¼+1
    private TopicRouteData topicRouteData;//å…³è”Topicè·¯ç”±å…ƒä¿¡æ¯
}
```

***ä»£ç ï¼šMQClientInstance#updateTopicRouteInfoFromNameServer***

```java
TopicRouteData topicRouteData;
//ä½¿ç”¨é»˜è®¤ä¸»é¢˜ä»NameServerè·å–è·¯ç”±ä¿¡æ¯
if (isDefault && defaultMQProducer != null) {
    topicRouteData = this.mQClientAPIImpl.getDefaultTopicRouteInfoFromNameServer(defaultMQProducer.getCreateTopicKey(),
        1000 * 3);
    if (topicRouteData != null) {
        for (QueueData data : topicRouteData.getQueueDatas()) {
            int queueNums = Math.min(defaultMQProducer.getDefaultTopicQueueNums(), data.getReadQueueNums());
            data.setReadQueueNums(queueNums);
            data.setWriteQueueNums(queueNums);
        }
    }
} else {
    //ä½¿ç”¨æŒ‡å®šä¸»é¢˜ä»NameServerè·å–è·¯ç”±ä¿¡æ¯
    topicRouteData = this.mQClientAPIImpl.getTopicRouteInfoFromNameServer(topic, 1000 * 3);
}
```

***ä»£ç ï¼šMQClientInstance#updateTopicRouteInfoFromNameServer***

```java
//åˆ¤æ–­è·¯ç”±æ˜¯å¦éœ€è¦æ›´æ”¹
TopicRouteData old = this.topicRouteTable.get(topic);
boolean changed = topicRouteDataIsChange(old, topicRouteData);
if (!changed) {
    changed = this.isNeedUpdateTopicRouteInfo(topic);
} else {
    log.info("the topic[{}] route info changed, old[{}] ,new[{}]", topic, old, topicRouteData);
}
```

***ä»£ç ï¼šMQClientInstance#updateTopicRouteInfoFromNameServer***

```java
if (changed) {
    //å°†topicRouteDataè½¬æ¢ä¸ºå‘å¸ƒé˜Ÿåˆ—
    TopicPublishInfo publishInfo = topicRouteData2TopicPublishInfo(topic, topicRouteData);
    publishInfo.setHaveTopicRouterInfo(true);
    //éå†ç”Ÿäº§
    Iterator<Entry<String, MQProducerInner>> it = this.producerTable.entrySet().iterator();
    while (it.hasNext()) {
        Entry<String, MQProducerInner> entry = it.next();
        MQProducerInner impl = entry.getValue();
        if (impl != null) {
            //ç”Ÿäº§è€…ä¸ä¸ºç©ºæ—¶,æ›´æ–°publishInfoä¿¡æ¯
            impl.updateTopicPublishInfo(topic, publishInfo);
        }
    }
}
```

***ä»£ç ï¼šMQClientInstance#topicRouteData2TopicPublishInfo***

```java
public static TopicPublishInfo topicRouteData2TopicPublishInfo(final String topic, final TopicRouteData route) {
    	//åˆ›å»ºTopicPublishInfoå¯¹è±¡
        TopicPublishInfo info = new TopicPublishInfo();
    	//å…³è”topicRoute
        info.setTopicRouteData(route);
    	//é¡ºåºæ¶ˆæ¯,æ›´æ–°TopicPublishInfo
        if (route.getOrderTopicConf() != null && route.getOrderTopicConf().length() > 0) {
            String[] brokers = route.getOrderTopicConf().split(";");
            for (String broker : brokers) {
                String[] item = broker.split(":");
                int nums = Integer.parseInt(item[1]);
                for (int i = 0; i < nums; i++) {
                    MessageQueue mq = new MessageQueue(topic, item[0], i);
                    info.getMessageQueueList().add(mq);
                }
            }

            info.setOrderTopic(true);
        } else {
            //éé¡ºåºæ¶ˆæ¯æ›´æ–°TopicPublishInfo
            List<QueueData> qds = route.getQueueDatas();
            Collections.sort(qds);
            //éå†topicé˜Ÿåˆ—ä¿¡æ¯
            for (QueueData qd : qds) {
                //æ˜¯å¦æ˜¯å†™é˜Ÿåˆ—
                if (PermName.isWriteable(qd.getPerm())) {
                    BrokerData brokerData = null;
                    //éå†å†™é˜Ÿåˆ—Broker
                    for (BrokerData bd : route.getBrokerDatas()) {
                        //æ ¹æ®åç§°è·å¾—è¯»é˜Ÿåˆ—å¯¹åº”çš„Broker
                        if (bd.getBrokerName().equals(qd.getBrokerName())) {
                        brokerData = bd;
                        break;
                    }
                }

                if (null == brokerData) {
                    continue;
                }

                if (!brokerData.getBrokerAddrs().containsKey(MixAll.MASTER_ID)) {
                    continue;
                }
				//å°è£…TopicPublishInfoå†™é˜Ÿåˆ—
                for (int i = 0; i < qd.getWriteQueueNums(); i++) {
                    MessageQueue mq = new MessageQueue(topic, qd.getBrokerName(), i);
                    info.getMessageQueueList().add(mq);
                }
            }
        }

        info.setOrderTopic(false);
    }
	//è¿”å›TopicPublishInfoå¯¹è±¡
    return info;
}
```

#### 3ï¼‰é€‰æ‹©é˜Ÿåˆ—

* é»˜è®¤ä¸å¯ç”¨Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶

***ä»£ç ï¼šTopicPublishInfo#selectOneMessageQueue(lastBrokerName)***

```java
public MessageQueue selectOneMessageQueue(final String lastBrokerName) {
    //ç¬¬ä¸€æ¬¡é€‰æ‹©é˜Ÿåˆ—
    if (lastBrokerName == null) {
        return selectOneMessageQueue();
    } else {
        //sendWhichQueue
        int index = this.sendWhichQueue.getAndIncrement();
        //éå†æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ
        for (int i = 0; i < this.messageQueueList.size(); i++) {
            //sendWhichQueueè‡ªå¢åå–æ¨¡
            int pos = Math.abs(index++) % this.messageQueueList.size();
            if (pos < 0)
                pos = 0;
            //è§„é¿ä¸Šæ¬¡Brokeré˜Ÿåˆ—
            MessageQueue mq = this.messageQueueList.get(pos);
            if (!mq.getBrokerName().equals(lastBrokerName)) {
                return mq;
            }
        }
        //å¦‚æœä»¥ä¸Šæƒ…å†µéƒ½ä¸æ»¡è¶³,è¿”å›sendWhichQueueå–æ¨¡åçš„é˜Ÿåˆ—
        return selectOneMessageQueue();
    }
}
```

***ä»£ç ï¼šTopicPublishInfo#selectOneMessageQueue()***

```java
//ç¬¬ä¸€æ¬¡é€‰æ‹©é˜Ÿåˆ—
public MessageQueue selectOneMessageQueue() {
    //sendWhichQueueè‡ªå¢
    int index = this.sendWhichQueue.getAndIncrement();
    //å¯¹é˜Ÿåˆ—å¤§å°å–æ¨¡
    int pos = Math.abs(index) % this.messageQueueList.size();
    if (pos < 0)
        pos = 0;
    //è¿”å›å¯¹åº”çš„é˜Ÿåˆ—
    return this.messageQueueList.get(pos);
}
```

* å¯ç”¨Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶

```java
public MessageQueue selectOneMessageQueue(final TopicPublishInfo tpInfo, final String lastBrokerName) {
    //Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶
    if (this.sendLatencyFaultEnable) {
        try {
            //å¯¹sendWhichQueueè‡ªå¢
            int index = tpInfo.getSendWhichQueue().getAndIncrement();
            //å¯¹æ¶ˆæ¯é˜Ÿåˆ—è½®è¯¢è·å–ä¸€ä¸ªé˜Ÿåˆ—
            for (int i = 0; i < tpInfo.getMessageQueueList().size(); i++) {
                int pos = Math.abs(index++) % tpInfo.getMessageQueueList().size();
                if (pos < 0)
                    pos = 0;
                MessageQueue mq = tpInfo.getMessageQueueList().get(pos);
                //éªŒè¯è¯¥é˜Ÿåˆ—æ˜¯å¦å¯ç”¨
                if (latencyFaultTolerance.isAvailable(mq.getBrokerName())) {
                    //å¯ç”¨
                    if (null == lastBrokerName || mq.getBrokerName().equals(lastBrokerName))
                        return mq;
                }
            }
			//ä»è§„é¿çš„Brokerä¸­é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„Broker
            final String notBestBroker = latencyFaultTolerance.pickOneAtLeast();
            //è·å¾—Brokerçš„å†™é˜Ÿåˆ—é›†åˆ
            int writeQueueNums = tpInfo.getQueueIdByBroker(notBestBroker);
            if (writeQueueNums > 0) {
                //è·å¾—ä¸€ä¸ªé˜Ÿåˆ—,æŒ‡å®šbrokerå’Œé˜Ÿåˆ—IDå¹¶è¿”å›
                final MessageQueue mq = tpInfo.selectOneMessageQueue();
                if (notBestBroker != null) {
                    mq.setBrokerName(notBestBroker);
                    mq.setQueueId(tpInfo.getSendWhichQueue().getAndIncrement() % writeQueueNums);
                }
                return mq;
            } else {
                latencyFaultTolerance.remove(notBestBroker);
            }
        } catch (Exception e) {
            log.error("Error occurred when selecting message queue", e);
        }

        return tpInfo.selectOneMessageQueue();
    }

    return tpInfo.selectOneMessageQueue(lastBrokerName);
}
```

![](/assets/imgs/Brokeræ•…éšœå»¶è¿Ÿæœºåˆ¶æ ¸å¿ƒç±».png)

* å»¶è¿Ÿæœºåˆ¶æ¥å£è§„èŒƒ

```java
public interface LatencyFaultTolerance<T> {
    //æ›´æ–°å¤±è´¥æ¡ç›®
    void updateFaultItem(final T name, final long currentLatency, final long notAvailableDuration);
	//åˆ¤æ–­Brokeræ˜¯å¦å¯ç”¨
    boolean isAvailable(final T name);
	//ç§»é™¤Faultæ¡ç›®
    void remove(final T name);
	//å°è¯•ä»è§„é¿çš„Brokerä¸­é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„Broker
    T pickOneAtLeast();
}
```

* FaultItemï¼šå¤±è´¥æ¡ç›®

```java
class FaultItem implements Comparable<FaultItem> {
    //æ¡ç›®å”¯ä¸€é”®,è¿™é‡Œä¸ºbrokerName
    private final String name;
    //æœ¬æ¬¡æ¶ˆæ¯å‘é€å»¶è¿Ÿ
    private volatile long currentLatency;
    //æ•…éšœè§„é¿å¼€å§‹æ—¶é—´
    private volatile long startTimestamp;
}
```

* æ¶ˆæ¯å¤±è´¥ç­–ç•¥

```java
public class MQFaultStrategy {
   //æ ¹æ®currentLatencyæœ¬åœ°æ¶ˆæ¯å‘é€å»¶è¿Ÿ,ä»latencyMaxå°¾éƒ¨å‘å‰æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”currentLatencyå°çš„ç´¢å¼•,å¦‚æœæ²¡æœ‰æ‰¾åˆ°,è¿”å›0
	private long[] latencyMax = {50L, 100L, 550L, 1000L, 2000L, 3000L, 15000L};
    //æ ¹æ®è¿™ä¸ªç´¢å¼•ä»notAvailableDurationå–å‡ºå¯¹åº”çš„æ—¶é—´,åœ¨è¯¥æ—¶é•¿å†…,Brokerè®¾ç½®ä¸ºä¸å¯ç”¨
	private long[] notAvailableDuration = {0L, 0L, 30000L, 60000L, 120000L, 180000L, 600000L};
}
```

<u>***åŸç†åˆ†æ***</u>

***ä»£ç ï¼šDefaultMQProducerImpl#sendDefaultImpl***

```java
sendResult = this.sendKernelImpl(msg, 
                                 mq, 
                                 communicationMode, 
                                 sendCallback, 
                                 topicPublishInfo, 
                                 timeout - costTime);
endTimestamp = System.currentTimeMillis();
this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false);
```

å¦‚æœä¸Šè¿°å‘é€è¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨`DefaultMQProducerImpl#updateFaultItem`

```java
public void updateFaultItem(final String brokerName, final long currentLatency, boolean isolation) {
    //å‚æ•°ä¸€ï¼šbrokeråç§°
    //å‚æ•°äºŒ:æœ¬æ¬¡æ¶ˆæ¯å‘é€å»¶è¿Ÿæ—¶é—´
    //å‚æ•°ä¸‰:æ˜¯å¦éš”ç¦»
    this.mqFaultStrategy.updateFaultItem(brokerName, currentLatency, isolation);
}
```

***ä»£ç ï¼šMQFaultStrategy#updateFaultItem***

```java
public void updateFaultItem(final String brokerName, final long currentLatency, boolean isolation) {
    if (this.sendLatencyFaultEnable) {
        //è®¡ç®—brokerè§„é¿çš„æ—¶é•¿
        long duration = computeNotAvailableDuration(isolation ? 30000 : currentLatency);
        //æ›´æ–°è¯¥FaultItemè§„é¿æ—¶é•¿
        this.latencyFaultTolerance.updateFaultItem(brokerName, currentLatency, duration);
    }
}
```

***ä»£ç ï¼šMQFaultStrategy#computeNotAvailableDuration***

```java
private long computeNotAvailableDuration(final long currentLatency) {
    //éå†latencyMax
    for (int i = latencyMax.length - 1; i >= 0; i--) {
        //æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”currentLatencyçš„latencyMaxå€¼
        if (currentLatency >= latencyMax[i])
            return this.notAvailableDuration[i];
    }
    //æ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å›0
    return 0;
}
```

***ä»£ç ï¼šLatencyFaultToleranceImpl#updateFaultItem***

```java
public void updateFaultItem(final String name, final long currentLatency, final long notAvailableDuration) {
    //è·å¾—åŸFaultItem
    FaultItem old = this.faultItemTable.get(name);
    //ä¸ºç©ºæ–°å»ºfaultItemå¯¹è±¡,è®¾ç½®è§„é¿æ—¶é•¿å’Œå¼€å§‹æ—¶é—´
    if (null == old) {
        final FaultItem faultItem = new FaultItem(name);
        faultItem.setCurrentLatency(currentLatency);
        faultItem.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);

        old = this.faultItemTable.putIfAbsent(name, faultItem);
        if (old != null) {
            old.setCurrentLatency(currentLatency);
            old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);
        }
    } else {
        //æ›´æ–°è§„é¿æ—¶é•¿å’Œå¼€å§‹æ—¶é—´
        old.setCurrentLatency(currentLatency);
        old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);
    }
}
```

####4ï¼‰å‘é€æ¶ˆæ¯

æ¶ˆæ¯å‘é€APIæ ¸å¿ƒå…¥å£***DefaultMQProducerImpl#sendKernelImpl***

```java
private SendResult sendKernelImpl(
    final Message msg,	//å¾…å‘é€æ¶ˆæ¯
    final MessageQueue mq,	//æ¶ˆæ¯å‘é€é˜Ÿåˆ—
    final CommunicationMode communicationMode,		//æ¶ˆæ¯å‘é€å†…æ¨¡å¼
    final SendCallback sendCallback,	pp	//å¼‚æ­¥æ¶ˆæ¯å›è°ƒå‡½æ•°
    final TopicPublishInfo topicPublishInfo,	//ä¸»é¢˜è·¯ç”±ä¿¡æ¯
    final long timeout	//è¶…æ—¶æ—¶é—´
    )
```

***ä»£ç ï¼šDefaultMQProducerImpl#sendKernelImpl***

```java
//è·å¾—brokerç½‘ç»œåœ°å€ä¿¡æ¯
String brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());
if (null == brokerAddr) {
    //æ²¡æœ‰æ‰¾åˆ°ä»NameServeræ›´æ–°brokerç½‘ç»œåœ°å€ä¿¡æ¯
    tryToFindTopicPublishInfo(mq.getTopic());
    brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());
}
```

```java
//ä¸ºæ¶ˆæ¯åˆ†ç±»å”¯ä¸€ID
if (!(msg instanceof MessageBatch)) {
    MessageClientIDSetter.setUniqID(msg);
}

boolean topicWithNamespace = false;
if (null != this.mQClientFactory.getClientConfig().getNamespace()) {
    msg.setInstanceId(this.mQClientFactory.getClientConfig().getNamespace());
    topicWithNamespace = true;
}
//æ¶ˆæ¯å¤§å°è¶…è¿‡4K,å¯ç”¨æ¶ˆæ¯å‹ç¼©
int sysFlag = 0;
boolean msgBodyCompressed = false;
if (this.tryToCompressMessage(msg)) {
    sysFlag |= MessageSysFlag.COMPRESSED_FLAG;
    msgBodyCompressed = true;
}
//å¦‚æœæ˜¯äº‹åŠ¡æ¶ˆæ¯,è®¾ç½®æ¶ˆæ¯æ ‡è®°MessageSysFlag.TRANSACTION_PREPARED_TYPE
final String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);
if (tranMsg != null && Boolean.parseBoolean(tranMsg)) {
    sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;
}
```

```java
//å¦‚æœæ³¨å†Œäº†æ¶ˆæ¯å‘é€é’©å­å‡½æ•°,åœ¨æ‰§è¡Œæ¶ˆæ¯å‘é€å‰çš„å¢å¼ºé€»è¾‘
if (this.hasSendMessageHook()) {
    context = new SendMessageContext();
    context.setProducer(this);
    context.setProducerGroup(this.defaultMQProducer.getProducerGroup());
    context.setCommunicationMode(communicationMode);
    context.setBornHost(this.defaultMQProducer.getClientIP());
    context.setBrokerAddr(brokerAddr);
    context.setMessage(msg);
    context.setMq(mq);
    context.setNamespace(this.defaultMQProducer.getNamespace());
    String isTrans = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);
    if (isTrans != null && isTrans.equals("true")) {
        context.setMsgType(MessageType.Trans_Msg_Half);
    }

    if (msg.getProperty("__STARTDELIVERTIME") != null || msg.getProperty(MessageConst.PROPERTY_DELAY_TIME_LEVEL) != null) {
        context.setMsgType(MessageType.Delay_Msg);
    }
    this.executeSendMessageHookBefore(context);
}
```

***ä»£ç ï¼šSendMessageHook***

```java
public interface SendMessageHook {
    String hookName();

    void sendMessageBefore(final SendMessageContext context);

    void sendMessageAfter(final SendMessageContext context);
}
```

***ä»£ç ï¼šDefaultMQProducerImpl#sendKernelImpl***

```java
//æ„å»ºæ¶ˆæ¯å‘é€è¯·æ±‚åŒ…
SendMessageRequestHeader requestHeader = new SendMessageRequestHeader();
//ç”Ÿäº§è€…ç»„
requestHeader.setProducerGroup(this.defaultMQProducer.getProducerGroup());
//ä¸»é¢˜
requestHeader.setTopic(msg.getTopic());
//é»˜è®¤åˆ›å»ºä¸»é¢˜Key
requestHeader.setDefaultTopic(this.defaultMQProducer.getCreateTopicKey());
//è¯¥ä¸»é¢˜åœ¨å•ä¸ªBrokeré»˜è®¤é˜Ÿåˆ—æ ‘
requestHeader.setDefaultTopicQueueNums(this.defaultMQProducer.getDefaultTopicQueueNums());
//é˜Ÿåˆ—ID
requestHeader.setQueueId(mq.getQueueId());
//æ¶ˆæ¯ç³»ç»Ÿæ ‡è®°
requestHeader.setSysFlag(sysFlag);
//æ¶ˆæ¯å‘é€æ—¶é—´
requestHeader.setBornTimestamp(System.currentTimeMillis());
//æ¶ˆæ¯æ ‡è®°
requestHeader.setFlag(msg.getFlag());
//æ¶ˆæ¯æ‰©å±•ä¿¡æ¯
requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));
//æ¶ˆæ¯é‡è¯•æ¬¡æ•°
requestHeader.setReconsumeTimes(0);
requestHeader.setUnitMode(this.isUnitMode());
//æ˜¯å¦æ˜¯æ‰¹é‡æ¶ˆæ¯ç­‰
requestHeader.setBatch(msg instanceof MessageBatch);
if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
    String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);
    if (reconsumeTimes != null) {
        requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));
        MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);
    }

    String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);
    if (maxReconsumeTimes != null) {
        requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));
        MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_MAX_RECONSUME_TIMES);
    }
}
```

```java
case ASYNC:		//å¼‚æ­¥å‘é€
    Message tmpMessage = msg;
    boolean messageCloned = false;
    if (msgBodyCompressed) {
        //If msg body was compressed, msgbody should be reset using prevBody.
        //Clone new message using commpressed message body and recover origin massage.
        //Fix bug:https://github.com/apache/rocketmq-externals/issues/66
        tmpMessage = MessageAccessor.cloneMessage(msg);
        messageCloned = true;
        msg.setBody(prevBody);
    }

    if (topicWithNamespace) {
        if (!messageCloned) {
            tmpMessage = MessageAccessor.cloneMessage(msg);
            messageCloned = true;
        }
        msg.setTopic(NamespaceUtil.withoutNamespace(msg.getTopic(), 
                                                    this.defaultMQProducer.getNamespace()));
    }

		long costTimeAsync = System.currentTimeMillis() - beginStartTime;
		if (timeout < costTimeAsync) {
		    throw new RemotingTooMuchRequestException("sendKernelImpl call timeout");
		}
		sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage(
        			brokerAddr,
        			mq.getBrokerName(),
        			tmpMessage,
        			requestHeader,
        			timeout - costTimeAsync,
        			communicationMode,
        			sendCallback,
        			topicPublishInfo,
        			this.mQClientFactory,
        			this.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(),
        			context,
        			this);
    	break;
case ONEWAY:
case SYNC:		//åŒæ­¥å‘é€
    long costTimeSync = System.currentTimeMillis() - beginStartTime;
        if (timeout < costTimeSync) {
            throw new RemotingTooMuchRequestException("sendKernelImpl call timeout");
        }
        sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage(
            brokerAddr,
            mq.getBrokerName(),
            msg,
            requestHeader,
            timeout - costTimeSync,
            communicationMode,
            context,
            this);
        break;
    default:
        assert false;
        break;
}
```

```java
//å¦‚æœæ³¨å†Œäº†é’©å­å‡½æ•°,åˆ™å‘é€å®Œæ¯•åæ‰§è¡Œé’©å­å‡½æ•°
if (this.hasSendMessageHook()) {
    context.setSendResult(sendResult);
    this.executeSendMessageHookAfter(context);
}
```

### æ‰¹é‡æ¶ˆæ¯å‘é€

![](/assets/imgs/å‘é€æ‰¹é‡æ¶ˆæ¯.png)

æ‰¹é‡æ¶ˆæ¯å‘é€æ˜¯å°†åŒä¸€ä¸ªä¸»é¢˜çš„å¤šæ¡æ¶ˆæ¯ä¸€èµ·æ‰“åŒ…å‘é€åˆ°æ¶ˆæ¯æœåŠ¡ç«¯ï¼Œå‡å°‘ç½‘ç»œè°ƒç”¨æ¬¡æ•°ï¼Œæé«˜ç½‘ç»œä¼ è¾“æ•ˆç‡ã€‚å½“ç„¶ï¼Œå¹¶ä¸æ˜¯åœ¨åŒä¸€æ‰¹æ¬¡ä¸­å‘é€çš„æ¶ˆæ¯æ•°é‡è¶Šå¤šè¶Šå¥½ï¼Œå…¶åˆ¤æ–­ä¾æ®æ˜¯å•æ¡æ¶ˆæ¯çš„é•¿åº¦ï¼Œå¦‚æœå•æ¡æ¶ˆæ¯å†…å®¹æ¯”è¾ƒé•¿ï¼Œåˆ™æ‰“åŒ…å¤šæ¡æ¶ˆæ¯å‘é€ä¼šå½±å“å…¶ä»–çº¿ç¨‹å‘é€æ¶ˆæ¯çš„å“åº”æ—¶é—´ï¼Œå¹¶ä¸”å•æ‰¹æ¬¡æ¶ˆæ¯æ€»é•¿åº¦ä¸èƒ½è¶…è¿‡DefaultMQProducer#maxMessageSizeã€‚

æ‰¹é‡æ¶ˆæ¯å‘é€è¦è§£å†³çš„é—®é¢˜æ˜¯å¦‚ä½•å°†è¿™äº›æ¶ˆæ¯ç¼–ç ä»¥ä¾¿æœåŠ¡ç«¯èƒ½å¤Ÿæ­£ç¡®è§£ç å‡ºæ¯æ¡æ¶ˆæ¯çš„æ¶ˆæ¯å†…å®¹ã€‚

***ä»£ç ï¼šDefaultMQProducer#send***

```java
public SendResult send(Collection<Message> msgs) 
    throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
    //å‹ç¼©æ¶ˆæ¯é›†åˆæˆä¸€æ¡æ¶ˆæ¯,ç„¶åå‘é€å‡ºå»
    return this.defaultMQProducerImpl.send(batch(msgs));
}
```

***ä»£ç ï¼šDefaultMQProducer#batch***

```java
private MessageBatch batch(Collection<Message> msgs) throws MQClientException {
    MessageBatch msgBatch;
    try {
        //å°†é›†åˆæ¶ˆæ¯å°è£…åˆ°MessageBatch
        msgBatch = MessageBatch.generateFromList(msgs);
        //éå†æ¶ˆæ¯é›†åˆ,æ£€æŸ¥æ¶ˆæ¯åˆæ³•æ€§,è®¾ç½®æ¶ˆæ¯ID,è®¾ç½®Topic
        for (Message message : msgBatch) {
            Validators.checkMessage(message, this);
            MessageClientIDSetter.setUniqID(message);
            message.setTopic(withNamespace(message.getTopic()));
        }
        //å‹ç¼©æ¶ˆæ¯,è®¾ç½®æ¶ˆæ¯body
        msgBatch.setBody(msgBatch.encode());
    } catch (Exception e) {
        throw new MQClientException("Failed to initiate the MessageBatch", e);
    }
    //è®¾ç½®msgBatchçš„topic
    msgBatch.setTopic(withNamespace(msgBatch.getTopic()));
    return msgBatch;
}
```

## æ¶ˆæ¯å­˜å‚¨

###æ¶ˆæ¯å­˜å‚¨æ ¸å¿ƒç±»

![](/assets/imgs/DefaultMessageStore.png)

```java
private final MessageStoreConfig messageStoreConfig;	//æ¶ˆæ¯é…ç½®å±æ€§
private final CommitLog commitLog;		//CommitLogæ–‡ä»¶å­˜å‚¨çš„å®ç°ç±»
private final ConcurrentMap<String/* topic */, ConcurrentMap<Integer/* queueId */, ConsumeQueue>> consumeQueueTable;	//æ¶ˆæ¯é˜Ÿåˆ—å­˜å‚¨ç¼“å­˜è¡¨,æŒ‰ç…§æ¶ˆæ¯ä¸»é¢˜åˆ†ç»„
private final FlushConsumeQueueService flushConsumeQueueService;	//æ¶ˆæ¯é˜Ÿåˆ—æ–‡ä»¶åˆ·ç›˜çº¿ç¨‹
private final CleanCommitLogService cleanCommitLogService;	//æ¸…é™¤CommitLogæ–‡ä»¶æœåŠ¡
private final CleanConsumeQueueService cleanConsumeQueueService;	//æ¸…é™¤ConsumerQueueé˜Ÿåˆ—æ–‡ä»¶æœåŠ¡
private final IndexService indexService;	//ç´¢å¼•å®ç°ç±»
private final AllocateMappedFileService allocateMappedFileService;	//MappedFileåˆ†é…æœåŠ¡
private final ReputMessageService reputMessageService;//CommitLogæ¶ˆæ¯åˆ†å‘,æ ¹æ®CommitLogæ–‡ä»¶æ„å»ºConsumerQueueã€IndexFileæ–‡ä»¶
private final HAService haService;	//å­˜å‚¨HAæœºåˆ¶
private final ScheduleMessageService scheduleMessageService;	//æ¶ˆæ¯æœåŠ¡è°ƒåº¦çº¿ç¨‹
private final StoreStatsService storeStatsService;	//æ¶ˆæ¯å­˜å‚¨æœåŠ¡
private final TransientStorePool transientStorePool;	//æ¶ˆæ¯å †å¤–å†…å­˜ç¼“å­˜
private final BrokerStatsManager brokerStatsManager;	//BrokerçŠ¶æ€ç®¡ç†å™¨
private final MessageArrivingListener messageArrivingListener;	//æ¶ˆæ¯æ‹‰å–é•¿è½®è¯¢æ¨¡å¼æ¶ˆæ¯è¾¾åˆ°ç›‘å¬å™¨
private final BrokerConfig brokerConfig;	//Brokeré…ç½®ç±»
private StoreCheckpoint storeCheckpoint;	//æ–‡ä»¶åˆ·ç›˜ç›‘æµ‹ç‚¹
private final LinkedList<CommitLogDispatcher> dispatcherList;	//CommitLogæ–‡ä»¶è½¬å‘è¯·æ±‚
```

### æ¶ˆæ¯å­˜å‚¨æµç¨‹

![](/assets/imgs/æ¶ˆæ¯å­˜å‚¨æµç¨‹.png)

***æ¶ˆæ¯å­˜å‚¨å…¥å£ï¼šDefaultMessageStore#putMessage***

```java
//åˆ¤æ–­Brokerè§’è‰²å¦‚æœæ˜¯ä»èŠ‚ç‚¹,åˆ™æ— éœ€å†™å…¥
if (BrokerRole.SLAVE == this.messageStoreConfig.getBrokerRole()) {
        long value = this.printTimes.getAndIncrement();
        if ((value % 50000) == 0) {
            log.warn("message store is slave mode, so putMessage is forbidden ");
        }

    return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);
}

//åˆ¤æ–­å½“å‰å†™å…¥çŠ¶æ€å¦‚æœæ˜¯æ­£åœ¨å†™å…¥,åˆ™ä¸èƒ½ç»§ç»­
if (!this.runningFlags.isWriteable()) {
        long value = this.printTimes.getAndIncrement();
    	return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);
} else {
    this.printTimes.set(0);
}
//åˆ¤æ–­æ¶ˆæ¯ä¸»é¢˜é•¿åº¦æ˜¯å¦è¶…è¿‡æœ€å¤§é™åˆ¶
if (msg.getTopic().length() > Byte.MAX_VALUE) {
    log.warn("putMessage message topic length too long " + msg.getTopic().length());
    return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, null);
}
//åˆ¤æ–­æ¶ˆæ¯å±æ€§é•¿åº¦æ˜¯å¦è¶…è¿‡é™åˆ¶
if (msg.getPropertiesString() != null && msg.getPropertiesString().length() > Short.MAX_VALUE) {
    log.warn("putMessage message properties length too long " + msg.getPropertiesString().length());
    return new PutMessageResult(PutMessageStatus.PROPERTIES_SIZE_EXCEEDED, null);
}
//åˆ¤æ–­ç³»ç»ŸPageCacheç¼“å­˜å»æ˜¯å¦å ç”¨
if (this.isOSPageCacheBusy()) {
    return new PutMessageResult(PutMessageStatus.OS_PAGECACHE_BUSY, null);
}

//å°†æ¶ˆæ¯å†™å…¥CommitLogæ–‡ä»¶
PutMessageResult result = this.commitLog.putMessage(msg);
```

***ä»£ç ï¼šCommitLog#putMessage***

```java
//è®°å½•æ¶ˆæ¯å­˜å‚¨æ—¶é—´
msg.setStoreTimestamp(beginLockTimestamp);

//åˆ¤æ–­å¦‚æœmappedFileå¦‚æœä¸ºç©ºæˆ–è€…å·²æ»¡,åˆ›å»ºæ–°çš„mappedFileæ–‡ä»¶
if (null == mappedFile || mappedFile.isFull()) {
    mappedFile = this.mappedFileQueue.getLastMappedFile(0); 
}
//å¦‚æœåˆ›å»ºå¤±è´¥,ç›´æ¥è¿”å›
if (null == mappedFile) {
    log.error("create mapped file1 error, topic: " + msg.getTopic() + " clientAddr: " + msg.getBornHostString());
    beginTimeInLock = 0;
    return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, null);
}

//å†™å…¥æ¶ˆæ¯åˆ°mappedFileä¸­
result = mappedFile.appendMessage(msg, this.appendMessageCallback);
```

***ä»£ç ï¼šMappedFile#appendMessagesInner***

```java
//è·å¾—æ–‡ä»¶çš„å†™å…¥æŒ‡é’ˆ
int currentPos = this.wrotePosition.get();

//å¦‚æœæŒ‡é’ˆå¤§äºæ–‡ä»¶å¤§å°åˆ™ç›´æ¥è¿”å›
if (currentPos < this.fileSize) {
    //é€šè¿‡writeBuffer.slice()åˆ›å»ºä¸€ä¸ªä¸MappedFileå…±äº«çš„å†…å­˜åŒº,å¹¶è®¾ç½®positionä¸ºå½“å‰æŒ‡é’ˆ
    ByteBuffer byteBuffer = writeBuffer != null ? writeBuffer.slice() : this.mappedByteBuffer.slice();
    byteBuffer.position(currentPos);
    AppendMessageResult result = null;
    if (messageExt instanceof MessageExtBrokerInner) {
       	//é€šè¿‡å›è°ƒæ–¹æ³•å†™å…¥
        result = cb.doAppend(this.getFileFromOffset(), byteBuffer, this.fileSize - currentPos, (MessageExtBrokerInner) messageExt);
    } else if (messageExt instanceof MessageExtBatch) {
        result = cb.doAppend(this.getFileFromOffset(), byteBuffer, this.fileSize - currentPos, (MessageExtBatch) messageExt);
    } else {
        return new AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);
    }
    this.wrotePosition.addAndGet(result.getWroteBytes());
    this.storeTimestamp = result.getStoreTimestamp();
    return result;
}
```

***ä»£ç ï¼šCommitLog#doAppend***

```java
//æ–‡ä»¶å†™å…¥ä½ç½®
long wroteOffset = fileFromOffset + byteBuffer.position();
//è®¾ç½®æ¶ˆæ¯ID
this.resetByteBuffer(hostHolder, 8);
String msgId = MessageDecoder.createMessageId(this.msgIdMemory, msgInner.getStoreHostBytes(hostHolder), wroteOffset);

//è·å¾—è¯¥æ¶ˆæ¯åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„åç§»é‡
keyBuilder.setLength(0);
keyBuilder.append(msgInner.getTopic());
keyBuilder.append('-');
keyBuilder.append(msgInner.getQueueId());
String key = keyBuilder.toString();
Long queueOffset = CommitLog.this.topicQueueTable.get(key);
if (null == queueOffset) {
    queueOffset = 0L;
    CommitLog.this.topicQueueTable.put(key, queueOffset);
}

//è·å¾—æ¶ˆæ¯å±æ€§é•¿åº¦
final byte[] propertiesData =msgInner.getPropertiesString() == null ? null : msgInner.getPropertiesString().getBytes(MessageDecoder.CHARSET_UTF8);

final int propertiesLength = propertiesData == null ? 0 : propertiesData.length;

if (propertiesLength > Short.MAX_VALUE) {
    log.warn("putMessage message properties length too long. length={}", propertiesData.length);
    return new AppendMessageResult(AppendMessageStatus.PROPERTIES_SIZE_EXCEEDED);
}

//è·å¾—æ¶ˆæ¯ä¸»é¢˜å¤§å°
final byte[] topicData = msgInner.getTopic().getBytes(MessageDecoder.CHARSET_UTF8);
final int topicLength = topicData.length;

//è·å¾—æ¶ˆæ¯ä½“å¤§å°
final int bodyLength = msgInner.getBody() == null ? 0 : msgInner.getBody().length;
//è®¡ç®—æ¶ˆæ¯æ€»é•¿åº¦
final int msgLen = calMsgLength(bodyLength, topicLength, propertiesLength);
```

***ä»£ç ï¼šCommitLog#calMsgLength***

```java
protected static int calMsgLength(int bodyLength, int topicLength, int propertiesLength) {
    final int msgLen = 4 //TOTALSIZE
        + 4 //MAGICCODE  
        + 4 //BODYCRC
        + 4 //QUEUEID
        + 4 //FLAG
        + 8 //QUEUEOFFSET
        + 8 //PHYSICALOFFSET
        + 4 //SYSFLAG
        + 8 //BORNTIMESTAMP
        + 8 //BORNHOST
        + 8 //STORETIMESTAMP
        + 8 //STOREHOSTADDRESS
        + 4 //RECONSUMETIMES
        + 8 //Prepared Transaction Offset
        + 4 + (bodyLength > 0 ? bodyLength : 0) //BODY
        + 1 + topicLength //TOPIC
        + 2 + (propertiesLength > 0 ? propertiesLength : 0) //propertiesLength
        + 0;
    return msgLen;
}
```

***ä»£ç ï¼šCommitLog#doAppend***

```java
//æ¶ˆæ¯é•¿åº¦ä¸èƒ½è¶…è¿‡4M
if (msgLen > this.maxMessageSize) {
    CommitLog.log.warn("message size exceeded, msg total size: " + msgLen + ", msg body size: " + bodyLength
        + ", maxMessageSize: " + this.maxMessageSize);
    return new AppendMessageResult(AppendMessageStatus.MESSAGE_SIZE_EXCEEDED);
}

//æ¶ˆæ¯æ˜¯å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å­˜å‚¨ç©ºé—´åˆ™æ–°åˆ›å»ºCommitLogæ–‡ä»¶
if ((msgLen + END_FILE_MIN_BLANK_LENGTH) > maxBlank) {
    this.resetByteBuffer(this.msgStoreItemMemory, maxBlank);
    // 1 TOTALSIZE
    this.msgStoreItemMemory.putInt(maxBlank);
    // 2 MAGICCODE
    this.msgStoreItemMemory.putInt(CommitLog.BLANK_MAGIC_CODE);
    // 3 The remaining space may be any value
    // Here the length of the specially set maxBlank
    final long beginTimeMills = CommitLog.this.defaultMessageStore.now();
    byteBuffer.put(this.msgStoreItemMemory.array(), 0, maxBlank);
    return new AppendMessageResult(AppendMessageStatus.END_OF_FILE, wroteOffset, maxBlank, msgId, msgInner.getStoreTimestamp(),
        queueOffset, CommitLog.this.defaultMessageStore.now() - beginTimeMills);
}

//å°†æ¶ˆæ¯å­˜å‚¨åˆ°ByteBufferä¸­,è¿”å›AppendMessageResult
final long beginTimeMills = CommitLog.this.defaultMessageStore.now();
// Write messages to the queue buffer
byteBuffer.put(this.msgStoreItemMemory.array(), 0, msgLen);
AppendMessageResult result = new AppendMessageResult(AppendMessageStatus.PUT_OK, wroteOffset, 
                                                     msgLen, msgId,msgInner.getStoreTimestamp(), 
                                                     queueOffset, 
                                                     CommitLog.this.defaultMessageStore.now() 
                                                     -beginTimeMills);
switch (tranType) {
    case MessageSysFlag.TRANSACTION_PREPARED_TYPE:
    case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:
        break;
    case MessageSysFlag.TRANSACTION_NOT_TYPE:
    case MessageSysFlag.TRANSACTION_COMMIT_TYPE:
        //æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—åç§»é‡
        CommitLog.this.topicQueueTable.put(key, ++queueOffset);
        break;
    default:
        break;
}
```

***ä»£ç ï¼šCommitLog#putMessage***

```java
//é‡Šæ”¾é”
putMessageLock.unlock();
//åˆ·ç›˜
handleDiskFlush(result, putMessageResult, msg);
//æ‰§è¡ŒHAä¸»ä»åŒæ­¥
handleHA(result, putMessageResult, msg);
```

### å­˜å‚¨æ–‡ä»¶

![](/assets/imgs/å­˜å‚¨æ–‡ä»¶.png)

- commitLogï¼šæ¶ˆæ¯å­˜å‚¨ç›®å½•
- configï¼šè¿è¡ŒæœŸé—´ä¸€äº›é…ç½®ä¿¡æ¯
- consumerqueueï¼šæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—å­˜å‚¨ç›®å½•
- indexï¼šæ¶ˆæ¯ç´¢å¼•æ–‡ä»¶å­˜å‚¨ç›®å½•
- abortï¼šå¦‚æœå­˜åœ¨æ”¹æ–‡ä»¶å¯¿å‘½Brokeréæ­£å¸¸å…³é—­
- checkpointï¼šæ–‡ä»¶æ£€æŸ¥ç‚¹ï¼Œå­˜å‚¨CommitLogæ–‡ä»¶æœ€åä¸€æ¬¡åˆ·ç›˜æ—¶é—´æˆ³ã€consumerquueueæœ€åä¸€æ¬¡åˆ·ç›˜æ—¶é—´ï¼Œindexç´¢å¼•æ–‡ä»¶æœ€åä¸€æ¬¡åˆ·ç›˜æ—¶é—´æˆ³ã€‚

### å­˜å‚¨æ–‡ä»¶å†…å­˜æ˜ å°„

RocketMQé€šè¿‡ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶æé«˜IOè®¿é—®æ€§èƒ½ï¼Œæ— è®ºæ˜¯CommitLogã€ConsumerQueueè¿˜æ˜¯IndexFileï¼Œå•ä¸ªæ–‡ä»¶éƒ½è¢«è®¾è®¡ä¸ºå›ºå®šé•¿åº¦ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶å†™æ»¡ä»¥åå†åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œæ–‡ä»¶åå°±ä¸ºè¯¥æ–‡ä»¶ç¬¬ä¸€æ¡æ¶ˆæ¯å¯¹åº”çš„å…¨å±€ç‰©ç†åç§»é‡ã€‚

####1ï¼‰MappedFileQueue

![](/assets/imgs/MappedFileQueue.png)

```java
String storePath;	//å­˜å‚¨ç›®å½•
int mappedFileSize;	// å•ä¸ªæ–‡ä»¶å¤§å°
CopyOnWriteArrayList<MappedFile> mappedFiles;	//MappedFileæ–‡ä»¶é›†åˆ
AllocateMappedFileService allocateMappedFileService;	//åˆ›å»ºMapFileæœåŠ¡ç±»
long flushedWhere = 0;		//å½“å‰åˆ·ç›˜æŒ‡é’ˆ
long committedWhere = 0;	//å½“å‰æ•°æ®æäº¤æŒ‡é’ˆ,å†…å­˜ä¸­ByteBufferå½“å‰çš„å†™æŒ‡é’ˆ,è¯¥å€¼å¤§äºç­‰äºflushWhere
```

* æ ¹æ®å­˜å‚¨æ—¶é—´æŸ¥è¯¢MappedFile

```java
public MappedFile getMappedFileByTime(final long timestamp) {
    Object[] mfs = this.copyMappedFiles(0);
	
    if (null == mfs)
        return null;
	//éå†MappedFileæ–‡ä»¶æ•°ç»„
    for (int i = 0; i < mfs.length; i++) {
        MappedFile mappedFile = (MappedFile) mfs[i];
        //MappedFileæ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´å¤§äºæŒ‡å®šæ—¶é—´æˆ³åˆ™è¿”å›è¯¥æ–‡ä»¶
        if (mappedFile.getLastModifiedTimestamp() >= timestamp) {
            return mappedFile;
        }
    }

    return (MappedFile) mfs[mfs.length - 1];
}
```

* æ ¹æ®æ¶ˆæ¯åç§»é‡offsetæŸ¥æ‰¾MappedFile

```java
public MappedFile findMappedFileByOffset(final long offset, final boolean returnFirstOnNotFound) {
    try {
        //è·å¾—ç¬¬ä¸€ä¸ªMappedFileæ–‡ä»¶
        MappedFile firstMappedFile = this.getFirstMappedFile();
        //è·å¾—æœ€åä¸€ä¸ªMappedFileæ–‡ä»¶
        MappedFile lastMappedFile = this.getLastMappedFile();
        //ç¬¬ä¸€ä¸ªæ–‡ä»¶å’Œæœ€åä¸€ä¸ªæ–‡ä»¶å‡ä¸ä¸ºç©º,åˆ™è¿›è¡Œå¤„ç†
        if (firstMappedFile != null && lastMappedFile != null) {
            if (offset < firstMappedFile.getFileFromOffset() || 
                offset >= lastMappedFile.getFileFromOffset() + this.mappedFileSize) {
            } else {
                //è·å¾—æ–‡ä»¶ç´¢å¼•
                int index = (int) ((offset / this.mappedFileSize) 
                                   - (firstMappedFile.getFileFromOffset() / this.mappedFileSize));
                MappedFile targetFile = null;
                try {
                    //æ ¹æ®ç´¢å¼•è¿”å›ç›®æ ‡æ–‡ä»¶
                    targetFile = this.mappedFiles.get(index);
                } catch (Exception ignored) {
                }

                if (targetFile != null && offset >= targetFile.getFileFromOffset()
                    && offset < targetFile.getFileFromOffset() + this.mappedFileSize) {
                    return targetFile;
                }

                for (MappedFile tmpMappedFile : this.mappedFiles) {
                    if (offset >= tmpMappedFile.getFileFromOffset()
                        && offset < tmpMappedFile.getFileFromOffset() + this.mappedFileSize) {
                        return tmpMappedFile;
                    }
                }
            }

            if (returnFirstOnNotFound) {
                return firstMappedFile;
            }
        }
    } catch (Exception e) {
        log.error("findMappedFileByOffset Exception", e);
    }

    return null;
}
```

* è·å–å­˜å‚¨æ–‡ä»¶æœ€å°åç§»é‡

```java
public long getMinOffset() {

    if (!this.mappedFiles.isEmpty()) {
        try {
            return this.mappedFiles.get(0).getFileFromOffset();
        } catch (IndexOutOfBoundsException e) {
            //continue;
        } catch (Exception e) {
            log.error("getMinOffset has exception.", e);
        }
    }
    return -1;
}
```

* è·å–å­˜å‚¨æ–‡ä»¶æœ€å¤§åç§»é‡

```java
public long getMaxOffset() {
    MappedFile mappedFile = getLastMappedFile();
    if (mappedFile != null) {
        return mappedFile.getFileFromOffset() + mappedFile.getReadPosition();
    }
    return 0;
}
```

* è¿”å›å­˜å‚¨æ–‡ä»¶å½“å‰å†™æŒ‡é’ˆ

```java
public long getMaxWrotePosition() {
    MappedFile mappedFile = getLastMappedFile();
    if (mappedFile != null) {
        return mappedFile.getFileFromOffset() + mappedFile.getWrotePosition();
    }
    return 0;
}
```

####2ï¼‰MappedFile

![](/assets/imgs/MappedFile.png)

```java
int OS_PAGE_SIZE = 1024 * 4;		//æ“ä½œç³»ç»Ÿæ¯é¡µå¤§å°,é»˜è®¤4K
AtomicLong TOTAL_MAPPED_VIRTUAL_MEMORY = new AtomicLong(0);	//å½“å‰JVMå®ä¾‹ä¸­MappedFileè™šæ‹Ÿå†…å­˜
AtomicInteger TOTAL_MAPPED_FILES = new AtomicInteger(0);	//å½“å‰JVMå®ä¾‹ä¸­MappedFileå¯¹è±¡ä¸ªæ•°
AtomicInteger wrotePosition = new AtomicInteger(0);	//å½“å‰æ–‡ä»¶çš„å†™æŒ‡é’ˆ
AtomicInteger committedPosition = new AtomicInteger(0);	//å½“å‰æ–‡ä»¶çš„æäº¤æŒ‡é’ˆ
AtomicInteger flushedPosition = new AtomicInteger(0);	//åˆ·å†™åˆ°ç£ç›˜æŒ‡é’ˆ
int fileSize;	//æ–‡ä»¶å¤§å°
FileChannel fileChannel;	//æ–‡ä»¶é€šé“	
ByteBuffer writeBuffer = null;	//å †å¤–å†…å­˜ByteBuffer
TransientStorePool transientStorePool = null;	//å †å¤–å†…å­˜æ± 
String fileName;	//æ–‡ä»¶åç§°
long fileFromOffset;	//è¯¥æ–‡ä»¶çš„å¤„ç†åç§»é‡
File file;	//ç‰©ç†æ–‡ä»¶
MappedByteBuffer mappedByteBuffer;	//ç‰©ç†æ–‡ä»¶å¯¹åº”çš„å†…å­˜æ˜ å°„Buffer
volatile long storeTimestamp = 0;	//æ–‡ä»¶æœ€åä¸€æ¬¡å†…å®¹å†™å…¥æ—¶é—´
boolean firstCreateInQueue = false;	//æ˜¯å¦æ˜¯MappedFileQueueé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ–‡ä»¶
```

***MappedFileåˆå§‹åŒ–***

* æœªå¼€å¯`transientStorePoolEnable`ã€‚`transientStorePoolEnable=true`ä¸º`true`è¡¨ç¤ºæ•°æ®å…ˆå­˜å‚¨åˆ°å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡`Commit`çº¿ç¨‹å°†æ•°æ®æäº¤åˆ°å†…å­˜æ˜ å°„Bufferä¸­ï¼Œå†é€šè¿‡`Flush`çº¿ç¨‹å°†å†…å­˜æ˜ å°„`Buffer`ä¸­æ•°æ®æŒä¹…åŒ–ç£ç›˜ã€‚

```java
private void init(final String fileName, final int fileSize) throws IOException {
    this.fileName = fileName;
    this.fileSize = fileSize;
    this.file = new File(fileName);
    this.fileFromOffset = Long.parseLong(this.file.getName());
    boolean ok = false;
	
    ensureDirOK(this.file.getParent());

    try {
        this.fileChannel = new RandomAccessFile(this.file, "rw").getChannel();
        this.mappedByteBuffer = this.fileChannel.map(MapMode.READ_WRITE, 0, fileSize);
        TOTAL_MAPPED_VIRTUAL_MEMORY.addAndGet(fileSize);
        TOTAL_MAPPED_FILES.incrementAndGet();
        ok = true;
    } catch (FileNotFoundException e) {
        log.error("create file channel " + this.fileName + " Failed. ", e);
        throw e;
    } catch (IOException e) {
        log.error("map file " + this.fileName + " Failed. ", e);
        throw e;
    } finally {
        if (!ok && this.fileChannel != null) {
            this.fileChannel.close();
        }
    }
}
```

å¼€å¯`transientStorePoolEnable`

```java
public void init(final String fileName, final int fileSize,
    final TransientStorePool transientStorePool) throws IOException {
    init(fileName, fileSize);
    this.writeBuffer = transientStorePool.borrowBuffer();	//åˆå§‹åŒ–writeBuffer
    this.transientStorePool = transientStorePool;
}
```

***MappedFileæäº¤***

æäº¤æ•°æ®åˆ°FileChannelï¼ŒcommitLeastPagesä¸ºæœ¬æ¬¡æäº¤æœ€å°çš„é¡µæ•°ï¼Œå¦‚æœå¾…æäº¤æ•°æ®ä¸æ»¡commitLeastPagesï¼Œåˆ™ä¸æ‰§è¡Œæœ¬æ¬¡æäº¤æ“ä½œã€‚å¦‚æœwriteBufferå¦‚æœä¸ºç©ºï¼Œç›´æ¥è¿”å›writePositionæŒ‡é’ˆï¼Œæ— éœ€æ‰§è¡Œcommitæ“ä½œï¼Œè¡¨åcommitæ“ä½œä¸»ä½“æ˜¯writeBufferã€‚

```java
public int commit(final int commitLeastPages) {
    if (writeBuffer == null) {
        //no need to commit data to file channel, so just regard wrotePosition as committedPosition.
        return this.wrotePosition.get();
    }
    //åˆ¤æ–­æ˜¯å¦æ»¡è¶³æäº¤æ¡ä»¶
    if (this.isAbleToCommit(commitLeastPages)) {
        if (this.hold()) {
            commit0(commitLeastPages);
            this.release();
        } else {
            log.warn("in commit, hold failed, commit offset = " + this.committedPosition.get());
        }
    }

    // æ‰€æœ‰æ•°æ®æäº¤å,æ¸…ç©ºç¼“å†²åŒº
    if (writeBuffer != null && this.transientStorePool != null && this.fileSize == this.committedPosition.get()) {
        this.transientStorePool.returnBuffer(writeBuffer);
        this.writeBuffer = null;
    }

    return this.committedPosition.get();
}
```

***MappedFile#isAbleToCommit***

åˆ¤æ–­æ˜¯å¦æ‰§è¡Œcommitæ“ä½œï¼Œå¦‚æœæ–‡ä»¶å·²æ»¡è¿”å›trueï¼›å¦‚æœcommitLeastpageså¤§äº0ï¼Œåˆ™æ¯”è¾ƒwritePositionä¸ä¸Šä¸€æ¬¡æäº¤çš„æŒ‡é’ˆcommitPositionçš„å·®å€¼ï¼Œé™¤ä»¥OS_PAGE_SIZEå¾—åˆ°å½“å‰è„é¡µçš„æ•°é‡ï¼Œå¦‚æœå¤§äºcommitLeastPagesåˆ™è¿”å›trueï¼Œå¦‚æœcommitLeastpageså°äº0è¡¨ç¤ºåªè¦å­˜åœ¨è„é¡µå°±æäº¤ã€‚

```java
protected boolean isAbleToCommit(final int commitLeastPages) {
    //å·²ç»åˆ·ç›˜æŒ‡é’ˆ
    int flush = this.committedPosition.get();
    //æ–‡ä»¶å†™æŒ‡é’ˆ
    int write = this.wrotePosition.get();
	//å†™æ»¡åˆ·ç›˜
    if (this.isFull()) {
        return true;
    }

    if (commitLeastPages > 0) {
        //æ–‡ä»¶å†…å®¹è¾¾åˆ°commitLeastPagesé¡µæ•°,åˆ™åˆ·ç›˜
        return ((write / OS_PAGE_SIZE) - (flush / OS_PAGE_SIZE)) >= commitLeastPages;
    }

    return write > flush;
}
```

***MappedFile#commit0***

å…·ä½“æäº¤çš„å®ç°ï¼Œé¦–å…ˆåˆ›å»ºWriteBufferåŒºå…±äº«ç¼“å­˜åŒºï¼Œç„¶åå°†æ–°åˆ›å»ºçš„positionå›é€€åˆ°ä¸Šä¸€æ¬¡æäº¤çš„ä½ç½®ï¼ˆcommitPositionï¼‰ï¼Œè®¾ç½®limitä¸ºwrotePositionï¼ˆå½“å‰æœ€å¤§æœ‰æ•ˆæ•°æ®æŒ‡é’ˆï¼‰ï¼Œç„¶åæŠŠcommitPositionåˆ°wrotePositionçš„æ•°æ®å†™å…¥åˆ°FileChannelä¸­ï¼Œç„¶åæ›´æ–°committedPositionæŒ‡é’ˆä¸ºwrotePositionã€‚commitçš„ä½œç”¨å°±æ˜¯å°†MappedFileçš„writeBufferä¸­æ•°æ®æäº¤åˆ°æ–‡ä»¶é€šé“FileChannelä¸­ã€‚

```java
protected void commit0(final int commitLeastPages) {
    //å†™æŒ‡é’ˆ
    int writePos = this.wrotePosition.get();
    //ä¸Šæ¬¡æäº¤æŒ‡é’ˆ
    int lastCommittedPosition = this.committedPosition.get();

    if (writePos - this.committedPosition.get() > 0) {
        try {
            //å¤åˆ¶å…±äº«å†…å­˜åŒºåŸŸ
            ByteBuffer byteBuffer = writeBuffer.slice();
            //è®¾ç½®æäº¤ä½ç½®æ˜¯ä¸Šæ¬¡æäº¤ä½ç½®
            byteBuffer.position(lastCommittedPosition);
            //æœ€å¤§æäº¤æ•°é‡
            byteBuffer.limit(writePos);
            //è®¾ç½®fileChannelä½ç½®ä¸ºä¸Šæ¬¡æäº¤ä½ç½®
            this.fileChannel.position(lastCommittedPosition);
            //å°†lastCommittedPositionåˆ°writePosçš„æ•°æ®å¤åˆ¶åˆ°FileChannelä¸­
            this.fileChannel.write(byteBuffer);
            //é‡ç½®æäº¤ä½ç½®
            this.committedPosition.set(writePos);
        } catch (Throwable e) {
            log.error("Error occurred when commit data to FileChannel.", e);
        }
    }
}
```

***MappedFile#flush***

åˆ·å†™ç£ç›˜ï¼Œç›´æ¥è°ƒç”¨MappedByteBufferæˆ–fileChannelçš„forceæ–¹æ³•å°†å†…å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆflushedPositionåº”è¯¥ç­‰äºMappedByteBufferä¸­çš„å†™æŒ‡é’ˆï¼›å¦‚æœwriteBufferä¸ä¸ºç©ºï¼Œåˆ™flushPositionåº”è¯¥ç­‰äºä¸Šä¸€æ¬¡çš„commitæŒ‡é’ˆï¼›å› ä¸ºä¸Šä¸€æ¬¡æäº¤çš„æ•°æ®å°±æ˜¯è¿›å…¥åˆ°MappedByteBufferä¸­çš„æ•°æ®ï¼›å¦‚æœwriteBufferä¸ºç©ºï¼Œæ•°æ®æ—¶ç›´æ¥è¿›å…¥åˆ°MappedByteBufferï¼ŒwrotePositionä»£è¡¨çš„æ˜¯MappedByteBufferä¸­çš„æŒ‡é’ˆï¼Œæ•…è®¾ç½®flushPositionä¸ºwrotePositionã€‚

![](/assets/imgs/flush.jpg)

```java
public int flush(final int flushLeastPages) {
    //æ•°æ®è¾¾åˆ°åˆ·ç›˜æ¡ä»¶
    if (this.isAbleToFlush(flushLeastPages)) {
        //åŠ é”ï¼ŒåŒæ­¥åˆ·ç›˜
        if (this.hold()) {
            //è·å¾—è¯»æŒ‡é’ˆ
            int value = getReadPosition();
            try {
                //æ•°æ®ä»writeBufferæäº¤æ•°æ®åˆ°fileChannelå†åˆ·æ–°åˆ°ç£ç›˜
                if (writeBuffer != null || this.fileChannel.position() != 0) {
                    this.fileChannel.force(false);
                } else {
                    //ä»mmapåˆ·æ–°æ•°æ®åˆ°ç£ç›˜
                    this.mappedByteBuffer.force();
                }
            } catch (Throwable e) {
                log.error("Error occurred when force data to disk.", e);
            }
			//æ›´æ–°åˆ·ç›˜ä½ç½®
            this.flushedPosition.set(value);
            this.release();
        } else {
            log.warn("in flush, hold failed, flush offset = " + this.flushedPosition.get());
            this.flushedPosition.set(getReadPosition());
        }
    }
    return this.getFlushedPosition();
}
```

***MappedFile#getReadPosition***

è·å–å½“å‰æ–‡ä»¶æœ€å¤§å¯è¯»æŒ‡é’ˆã€‚å¦‚æœwriteBufferä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰çš„å†™æŒ‡é’ˆï¼›å¦‚æœwriteBufferä¸ä¸ºç©ºï¼Œåˆ™è¿”å›ä¸Šä¸€æ¬¡æäº¤çš„æŒ‡é’ˆã€‚åœ¨MappedFileè®¾ç½®ä¸­,åªæœ‰æäº¤äº†çš„æ•°æ®ï¼ˆå†™å…¥åˆ°MappedByteBufferæˆ–FileChannelä¸­çš„æ•°æ®ï¼‰æ‰æ˜¯å®‰å…¨çš„æ•°æ®

```java
public int getReadPosition() {
    //å¦‚æœwriteBufferä¸ºç©º,åˆ·ç›˜çš„ä½ç½®å°±æ˜¯åº”è¯¥ç­‰äºä¸Šæ¬¡commitçš„ä½ç½®,å¦‚æœä¸ºç©ºåˆ™ä¸ºmmapçš„å†™æŒ‡é’ˆ
    return this.writeBuffer == null ? this.wrotePosition.get() : this.committedPosition.get();
}
```

***MappedFile#selectMappedBuffer***

æŸ¥æ‰¾posåˆ°å½“å‰æœ€å¤§å¯è¯»ä¹‹é—´çš„æ•°æ®ï¼Œç”±äºåœ¨æ•´ä¸ªå†™å…¥æœŸé—´éƒ½æœªæ›¾æ”¹MappedByteBufferçš„æŒ‡é’ˆï¼Œå¦‚æœmappedByteBuffer.slice()æ–¹æ³•è¿”å›çš„å…±äº«ç¼“å­˜åŒºç©ºé—´ä¸ºæ•´ä¸ªMappedFileï¼Œç„¶åé€šè¿‡è®¾ç½®ByteBufferçš„positionä¸ºå¾…æŸ¥æ‰¾çš„å€¼ï¼Œè¯»å–å­—èŠ‚é•¿åº¦å½“å‰å¯è¯»æœ€å¤§é•¿åº¦ï¼Œæœ€ç»ˆè¿”å›çš„ByteBufferçš„limitä¸ºsizeã€‚æ•´ä¸ªå…±äº«ç¼“å­˜åŒºçš„å®¹é‡ä¸ºï¼ˆMappedFile#fileSize-posï¼‰ã€‚æ•…åœ¨æ“ä½œSelectMappedBufferResultä¸èƒ½å¯¹åŒ…å«åœ¨é‡Œé¢çš„ByteBufferè°ƒç”¨filpæ–¹æ³•ã€‚

```java
public SelectMappedBufferResult selectMappedBuffer(int pos) {
    //è·å¾—æœ€å¤§å¯è¯»æŒ‡é’ˆ
    int readPosition = getReadPosition();
    //poså°äºæœ€å¤§å¯è¯»æŒ‡é’ˆ,å¹¶ä¸”å¤§äº0
    if (pos < readPosition && pos >= 0) {
        if (this.hold()) {
            //å¤åˆ¶mappedByteBufferè¯»å…±äº«åŒº
            ByteBuffer byteBuffer = this.mappedByteBuffer.slice();
            //è®¾ç½®è¯»æŒ‡é’ˆä½ç½®
            byteBuffer.position(pos);
            //è·å¾—å¯è¯»èŒƒå›´
            int size = readPosition - pos;
            //è®¾ç½®æœ€å¤§åˆ»åº¦èŒƒå›´
            ByteBuffer byteBufferNew = byteBuffer.slice();
            byteBufferNew.limit(size);
            return new SelectMappedBufferResult(this.fileFromOffset + pos, byteBufferNew, size, this);
        }
    }

    return null;
}
```

***MappedFile#shutdown***

MappedFileæ–‡ä»¶é”€æ¯çš„å®ç°æ–¹æ³•ä¸ºpublic boolean destory(long intervalForcibly)ï¼ŒintervalForciblyè¡¨ç¤ºæ‹’ç»è¢«é”€æ¯çš„æœ€å¤§å­˜æ´»æ—¶é—´ã€‚

```java
public void shutdown(final long intervalForcibly) {
    if (this.available) {
        //å…³é—­MapedFile
        this.available = false;
        //è®¾ç½®å½“å‰å…³é—­æ—¶é—´æˆ³
        this.firstShutdownTimestamp = System.currentTimeMillis();
        //é‡Šæ”¾èµ„æº
        this.release();
    } else if (this.getRefCount() > 0) {
        if ((System.currentTimeMillis() - this.firstShutdownTimestamp) >= intervalForcibly) {
            this.refCount.set(-1000 - this.getRefCount());
            this.release();
        }
    }
}
```

#### 3ï¼‰TransientStorePool

çŸ­æš‚çš„å­˜å‚¨æ± ã€‚RocketMQå•ç‹¬åˆ›å»ºä¸€ä¸ªMappedByteBufferå†…å­˜ç¼“å­˜æ± ï¼Œç”¨æ¥ä¸´æ—¶å­˜å‚¨æ•°æ®ï¼Œæ•°æ®å…ˆå†™å…¥è¯¥å†…å­˜æ˜ å°„ä¸­ï¼Œç„¶åç”±commitçº¿ç¨‹å®šæ—¶å°†æ•°æ®ä»è¯¥å†…å­˜å¤åˆ¶åˆ°ä¸ç›®æ ‡ç‰©ç†æ–‡ä»¶å¯¹åº”çš„å†…å­˜æ˜ å°„ä¸­ã€‚RocketMQå¼•å…¥è¯¥æœºåˆ¶ä¸»è¦çš„åŸå› æ˜¯æä¾›ä¸€ç§å†…å­˜é”å®šï¼Œå°†å½“å‰å †å¤–å†…å­˜ä¸€ç›´é”å®šåœ¨å†…å­˜ä¸­ï¼Œé¿å…è¢«è¿›ç¨‹å°†å†…å­˜äº¤æ¢åˆ°ç£ç›˜ã€‚

![](/assets/imgs/TransientStorePool.png)

```java
private final int poolSize;		//availableBuffersä¸ªæ•°
private final int fileSize;		//æ¯éš”ByteBufferå¤§å°
private final Deque<ByteBuffer> availableBuffers;	//ByteBufferå®¹å™¨ã€‚åŒç«¯é˜Ÿåˆ—
```

***åˆå§‹åŒ–***

```java
public void init() {
    //åˆ›å»ºpoolSizeä¸ªå †å¤–å†…å­˜
    for (int i = 0; i < poolSize; i++) {
        ByteBuffer byteBuffer = ByteBuffer.allocateDirect(fileSize);
        final long address = ((DirectBuffer) byteBuffer).address();
        Pointer pointer = new Pointer(address);
        //ä½¿ç”¨com.sun.jna.Libraryç±»åº“å°†è¯¥æ‰¹å†…å­˜é”å®š,é¿å…è¢«ç½®æ¢åˆ°äº¤æ¢åŒº,æé«˜å­˜å‚¨æ€§èƒ½
        LibC.INSTANCE.mlock(pointer, new NativeLong(fileSize));

        availableBuffers.offer(byteBuffer);
    }
}
```

### å®æ—¶æ›´æ–°æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ä¸ç´¢å¼•æ–‡ä»¶

æ¶ˆæ¯æ¶ˆè´¹é˜Ÿæ–‡ä»¶ã€æ¶ˆæ¯å±æ€§ç´¢å¼•æ–‡ä»¶éƒ½æ˜¯åŸºäºCommitLogæ–‡ä»¶æ„å»ºçš„ï¼Œå½“æ¶ˆæ¯ç”Ÿäº§è€…æäº¤çš„æ¶ˆæ¯å­˜å‚¨åœ¨CommitLogæ–‡ä»¶ä¸­ï¼ŒConsumerQueueã€IndexFileéœ€è¦åŠæ—¶æ›´æ–°ï¼Œå¦åˆ™æ¶ˆæ¯æ— æ³•åŠæ—¶è¢«æ¶ˆè´¹ï¼Œæ ¹æ®æ¶ˆæ¯å±æ€§æŸ¥æ‰¾æ¶ˆæ¯ä¹Ÿä¼šå‡ºç°è¾ƒå¤§å»¶è¿Ÿã€‚RocketMQé€šè¿‡å¼€å¯ä¸€ä¸ªçº¿ç¨‹ReputMessageServiceæ¥å‡†å®æ—¶è½¬å‘CommitLogæ–‡ä»¶æ›´æ–°äº‹ä»¶ï¼Œç›¸åº”çš„ä»»åŠ¡å¤„ç†å™¨æ ¹æ®è½¬å‘çš„æ¶ˆæ¯åŠæ—¶æ›´æ–°ConsumerQueueã€IndexFileæ–‡ä»¶ã€‚

![](/assets/imgs/æ¶ˆæ¯å­˜å‚¨ç»“æ„.png)

![](/assets/imgs/æ„å»ºæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—å’Œç´¢å¼•æ–‡ä»¶.png)

***ä»£ç ï¼šDefaultMessageStoreï¼šstart***

```java
//è®¾ç½®CommitLogå†…å­˜ä¸­æœ€å¤§åç§»é‡
this.reputMessageService.setReputFromOffset(maxPhysicalPosInLogicQueue);
//å¯åŠ¨
this.reputMessageService.start();
```

***ä»£ç ï¼šDefaultMessageStoreï¼šrun***

```java
public void run() {
    DefaultMessageStore.log.info(this.getServiceName() + " service started");
	//æ¯éš”1æ¯«ç§’å°±ç»§ç»­å°è¯•æ¨é€æ¶ˆæ¯åˆ°æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—å’Œç´¢å¼•æ–‡ä»¶
    while (!this.isStopped()) {
        try {
            Thread.sleep(1);
            this.doReput();
        } catch (Exception e) {
            DefaultMessageStore.log.warn(this.getServiceName() + " service has exception. ", e);
        }
    }

    DefaultMessageStore.log.info(this.getServiceName() + " service end");
}
```

***ä»£ç ï¼šDefaultMessageStoreï¼šdeReput***

```java
//ä»resultä¸­å¾ªç¯éå†æ¶ˆæ¯,ä¸€æ¬¡è¯»ä¸€æ¡,åˆ›å»ºDispatherRequestå¯¹è±¡ã€‚
for (int readSize = 0; readSize < result.getSize() && doNext; ) {
	DispatchRequest dispatchRequest =                               DefaultMessageStore.this.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), false, false);
	int size = dispatchRequest.getBufferSize() == -1 ? dispatchRequest.getMsgSize() : dispatchRequest.getBufferSize();

	if (dispatchRequest.isSuccess()) {
	    if (size > 0) {
	        DefaultMessageStore.this.doDispatch(dispatchRequest);
	    }
    }
}
```

***DispatchRequest***

![](/assets/imgs/DispatchRequest.png)

```java
String topic; //æ¶ˆæ¯ä¸»é¢˜åç§°
int queueId;  //æ¶ˆæ¯é˜Ÿåˆ—ID
long commitLogOffset;	//æ¶ˆæ¯ç‰©ç†åç§»é‡
int msgSize;	//æ¶ˆæ¯é•¿åº¦
long tagsCode;	//æ¶ˆæ¯è¿‡æ»¤tag hashCode
long storeTimestamp;	//æ¶ˆæ¯å­˜å‚¨æ—¶é—´æˆ³
long consumeQueueOffset;	//æ¶ˆæ¯é˜Ÿåˆ—åç§»é‡
String keys;	//æ¶ˆæ¯ç´¢å¼•key
boolean success;	//æ˜¯å¦æˆåŠŸè§£æåˆ°å®Œæ•´çš„æ¶ˆæ¯
String uniqKey;	//æ¶ˆæ¯å”¯ä¸€é”®
int sysFlag;	//æ¶ˆæ¯ç³»ç»Ÿæ ‡è®°
long preparedTransactionOffset;	//æ¶ˆæ¯é¢„å¤„ç†äº‹åŠ¡åç§»é‡
Map<String, String> propertiesMap;	//æ¶ˆæ¯å±æ€§
byte[] bitMap;	//ä½å›¾
```

#### 1ï¼‰è½¬å‘åˆ°ConsumerQueue

![](/assets/imgs/æ¶ˆæ¯åˆ†å‘åˆ°æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—.png)

```java
class CommitLogDispatcherBuildConsumeQueue implements CommitLogDispatcher {
    @Override
    public void dispatch(DispatchRequest request) {
        final int tranType = MessageSysFlag.getTransactionValue(request.getSysFlag());
        switch (tranType) {
            case MessageSysFlag.TRANSACTION_NOT_TYPE:
            case MessageSysFlag.TRANSACTION_COMMIT_TYPE:
                //æ¶ˆæ¯åˆ†å‘
                DefaultMessageStore.this.putMessagePositionInfo(request);
                break;
            case MessageSysFlag.TRANSACTION_PREPARED_TYPE:
            case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:
                break;
        }
    }
}
```

***ä»£ç ï¼šDefaultMessageStore#putMessagePositionInfo***

```java
public void putMessagePositionInfo(DispatchRequest dispatchRequest) {
    //è·å¾—æ¶ˆè´¹é˜Ÿåˆ—
    ConsumeQueue cq = this.findConsumeQueue(dispatchRequest.getTopic(), dispatchRequest.getQueueId());
    //æ¶ˆè´¹é˜Ÿåˆ—åˆ†å‘æ¶ˆæ¯
    cq.putMessagePositionInfoWrapper(dispatchRequest);
}
```

***ä»£ç ï¼šDefaultMessageStore#putMessagePositionInfo***

```java
//ä¾æ¬¡å°†æ¶ˆæ¯åç§»é‡ã€æ¶ˆæ¯é•¿åº¦ã€tagå†™å…¥åˆ°ByteBufferä¸­
this.byteBufferIndex.flip();
this.byteBufferIndex.limit(CQ_STORE_UNIT_SIZE);
this.byteBufferIndex.putLong(offset);
this.byteBufferIndex.putInt(size);
this.byteBufferIndex.putLong(tagsCode);
//è·å¾—å†…å­˜æ˜ å°„æ–‡ä»¶
MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile(expectLogicOffset);
if (mappedFile != null) {
    //å°†æ¶ˆæ¯è¿½åŠ åˆ°å†…å­˜æ˜ å°„æ–‡ä»¶,å¼‚æ­¥è¾“ç›˜
    return mappedFile.appendMessage(this.byteBufferIndex.array());
}
```

#### 2ï¼‰è½¬å‘åˆ°Index

![](/assets/imgs/æ¶ˆæ¯åˆ†å‘åˆ°ç´¢å¼•æ–‡ä»¶.png)

```java
class CommitLogDispatcherBuildIndex implements CommitLogDispatcher {

    @Override
    public void dispatch(DispatchRequest request) {
        if (DefaultMessageStore.this.messageStoreConfig.isMessageIndexEnable()) {
            DefaultMessageStore.this.indexService.buildIndex(request);
        }
    }
}
```

***ä»£ç ï¼šDefaultMessageStore#buildIndex***

```java
public void buildIndex(DispatchRequest req) {
    //è·å¾—ç´¢å¼•æ–‡ä»¶
    IndexFile indexFile = retryGetAndCreateIndexFile();
    if (indexFile != null) {
        //è·å¾—æ–‡ä»¶æœ€å¤§ç‰©ç†åç§»é‡
        long endPhyOffset = indexFile.getEndPhyOffset();
        DispatchRequest msg = req;
        String topic = msg.getTopic();
        String keys = msg.getKeys();
        //å¦‚æœè¯¥æ¶ˆæ¯çš„ç‰©ç†åç§»é‡å°äºç´¢å¼•æ–‡ä»¶ä¸­çš„æœ€å¤§ç‰©ç†åç§»é‡,åˆ™è¯´æ˜æ˜¯é‡å¤æ•°æ®,å¿½ç•¥æœ¬æ¬¡ç´¢å¼•æ„å»º
        if (msg.getCommitLogOffset() < endPhyOffset) {
            return;
        }

        final int tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());
        switch (tranType) {
            case MessageSysFlag.TRANSACTION_NOT_TYPE:
            case MessageSysFlag.TRANSACTION_PREPARED_TYPE:
            case MessageSysFlag.TRANSACTION_COMMIT_TYPE:
                break;
            case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:
                return;
        }
		
        //å¦‚æœæ¶ˆæ¯IDä¸ä¸ºç©º,åˆ™æ·»åŠ åˆ°Hashç´¢å¼•ä¸­
        if (req.getUniqKey() != null) {
            indexFile = putKey(indexFile, msg, buildKey(topic, req.getUniqKey()));
            if (indexFile == null) {
                return;
            }
        }
		//æ„å»ºç´¢å¼•key,RocketMQæ”¯æŒä¸ºåŒä¸€ä¸ªæ¶ˆæ¯å»ºç«‹å¤šä¸ªç´¢å¼•,å¤šä¸ªç´¢å¼•é”®ç©ºæ ¼éš”å¼€.
        if (keys != null && keys.length() > 0) {
            String[] keyset = keys.split(MessageConst.KEY_SEPARATOR);
            for (int i = 0; i < keyset.length; i++) {
                String key = keyset[i];
                if (key.length() > 0) {
                    indexFile = putKey(indexFile, msg, buildKey(topic, key));
                    if (indexFile == null) {

                        return;
                    }
                }
            }
        }
    } else {
        log.error("build index error, stop building index");
    }
}
```

### æ¶ˆæ¯é˜Ÿåˆ—å’Œç´¢å¼•æ–‡ä»¶æ¢å¤

ç”±äºRocketMQå­˜å‚¨é¦–å…ˆå°†æ¶ˆæ¯å…¨é‡å­˜å‚¨åœ¨CommitLogæ–‡ä»¶ä¸­ï¼Œç„¶åå¼‚æ­¥ç”Ÿæˆè½¬å‘ä»»åŠ¡æ›´æ–°ConsumerQueueå’ŒIndexæ–‡ä»¶ã€‚å¦‚æœæ¶ˆæ¯æˆåŠŸå­˜å‚¨åˆ°CommitLogæ–‡ä»¶ä¸­ï¼Œè½¬å‘ä»»åŠ¡æœªæˆåŠŸæ‰§è¡Œï¼Œæ­¤æ—¶æ¶ˆæ¯æœåŠ¡å™¨Brokerç”±äºæŸä¸ªæ„¿æ„å®•æœºï¼Œå¯¼è‡´CommitLogã€ConsumerQueueã€IndexFileæ–‡ä»¶æ•°æ®ä¸ä¸€è‡´ã€‚å¦‚æœä¸åŠ ä»¥äººå·¥ä¿®å¤çš„è¯ï¼Œä¼šæœ‰ä¸€éƒ¨åˆ†æ¶ˆæ¯å³ä¾¿åœ¨CommitLogä¸­æ–‡ä»¶ä¸­å­˜åœ¨ï¼Œä½†ç”±äºæ²¡æœ‰è½¬å‘åˆ°ConsumerQueueï¼Œè¿™éƒ¨åˆ†æ¶ˆæ¯å°†æ°¸è¿œå¤å‘è¢«æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚

![](/assets/imgs/æ–‡ä»¶æ¢å¤æ€»ä½“æµç¨‹.png)

####1ï¼‰å­˜å‚¨æ–‡ä»¶åŠ è½½

***ä»£ç ï¼šDefaultMessageStore#load***

åˆ¤æ–­ä¸Šä¸€æ¬¡æ˜¯å¦å¼‚å¸¸é€€å‡ºã€‚å®ç°æœºåˆ¶æ˜¯Brokeråœ¨å¯åŠ¨æ—¶åˆ›å»ºabortæ–‡ä»¶ï¼Œåœ¨é€€å‡ºæ—¶é€šè¿‡JVMé’©å­å‡½æ•°åˆ é™¤abortæ–‡ä»¶ã€‚å¦‚æœä¸‹æ¬¡å¯åŠ¨æ—¶å­˜åœ¨abortæ–‡ä»¶ã€‚è¯´æ˜Brokeræ—¶å¼‚å¸¸é€€å‡ºçš„ï¼ŒCommitLogä¸ConsumerQueueæ•°æ®æœ‰å¯èƒ½ä¸ä¸€è‡´ï¼Œéœ€è¦è¿›è¡Œä¿®å¤ã€‚

```java
//åˆ¤æ–­ä¸´æ—¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
boolean lastExitOK = !this.isTempFileExist();
//æ ¹æ®ä¸´æ—¶æ–‡ä»¶åˆ¤æ–­å½“å‰Brokeræ˜¯å¦å¼‚å¸¸é€€å‡º
private boolean isTempFileExist() {
    String fileName = StorePathConfigHelper
        .getAbortFile(this.messageStoreConfig.getStorePathRootDir());
    File file = new File(fileName);
    return file.exists();
}
```

***ä»£ç ï¼šDefaultMessageStore#load***

```java
//åŠ è½½å»¶æ—¶é˜Ÿåˆ—
if (null != scheduleMessageService) {
    result = result && this.scheduleMessageService.load();
}

// åŠ è½½CommitLogæ–‡ä»¶
result = result && this.commitLog.load();

// åŠ è½½æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶
result = result && this.loadConsumeQueue();

if (result) {
	//åŠ è½½å­˜å‚¨ç›‘æµ‹ç‚¹,ç›‘æµ‹ç‚¹ä¸»è¦è®°å½•CommitLogæ–‡ä»¶ã€ConsumerQueueæ–‡ä»¶ã€Indexç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜ç‚¹
    this.storeCheckpoint =new StoreCheckpoint(StorePathConfigHelper.getStoreCheckpoint(this.messageStoreConfig.getStorePathRootDir()));
	//åŠ è½½indexæ–‡ä»¶
    this.indexService.load(lastExitOK);
	//æ ¹æ®Brokeræ˜¯å¦å¼‚å¸¸é€€å‡º,æ‰§è¡Œä¸åŒçš„æ¢å¤ç­–ç•¥
    this.recover(lastExitOK);
}
```

***ä»£ç ï¼šMappedFileQueue#load***

åŠ è½½CommitLogåˆ°æ˜ å°„æ–‡ä»¶

```java
//æŒ‡å‘CommitLogæ–‡ä»¶ç›®å½•
File dir = new File(this.storePath);
//è·å¾—æ–‡ä»¶æ•°ç»„
File[] files = dir.listFiles();
if (files != null) {
    // æ–‡ä»¶æ’åº
    Arrays.sort(files);
    //éå†æ–‡ä»¶
    for (File file : files) {
		//å¦‚æœæ–‡ä»¶å¤§å°å’Œé…ç½®æ–‡ä»¶ä¸ä¸€è‡´,é€€å‡º
        if (file.length() != this.mappedFileSize) {
            
            return false;
        }

        try {
            //åˆ›å»ºæ˜ å°„æ–‡ä»¶
            MappedFile mappedFile = new MappedFile(file.getPath(), mappedFileSize);
            mappedFile.setWrotePosition(this.mappedFileSize);
            mappedFile.setFlushedPosition(this.mappedFileSize);
            mappedFile.setCommittedPosition(this.mappedFileSize);
            //å°†æ˜ å°„æ–‡ä»¶æ·»åŠ åˆ°é˜Ÿåˆ—
            this.mappedFiles.add(mappedFile);
            log.info("load " + file.getPath() + " OK");
        } catch (IOException e) {
            log.error("load file " + file + " error", e);
            return false;
        }
    }
}

return true;
```

***ä»£ç ï¼šDefaultMessageStore#loadConsumeQueue***

åŠ è½½æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—

```java
//æ‰§è¡Œæ¶ˆè´¹é˜Ÿåˆ—ç›®å½•
File dirLogic = new File(StorePathConfigHelper.getStorePathConsumeQueue(this.messageStoreConfig.getStorePathRootDir()));
//éå†æ¶ˆè´¹é˜Ÿåˆ—ç›®å½•
File[] fileTopicList = dirLogic.listFiles();
if (fileTopicList != null) {

    for (File fileTopic : fileTopicList) {
        //è·å¾—å­ç›®å½•åç§°,å³topicåç§°
        String topic = fileTopic.getName();
		//éå†å­ç›®å½•ä¸‹çš„æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶
        File[] fileQueueIdList = fileTopic.listFiles();
        if (fileQueueIdList != null) {
            //éå†æ–‡ä»¶
            for (File fileQueueId : fileQueueIdList) {
                //æ–‡ä»¶åç§°å³é˜Ÿåˆ—ID
                int queueId;
                try {
                    queueId = Integer.parseInt(fileQueueId.getName());
                } catch (NumberFormatException e) {
                    continue;
                }
                //åˆ›å»ºæ¶ˆè´¹é˜Ÿåˆ—å¹¶åŠ è½½åˆ°å†…å­˜
                ConsumeQueue logic = new ConsumeQueue(
                    topic,
                    queueId,
                    StorePathConfigHelper.getStorePathConsumeQueue(this.messageStoreConfig.getStorePathRootDir()),
            this.getMessageStoreConfig().getMapedFileSizeConsumeQueue(),
                    this);
                this.putConsumeQueue(topic, queueId, logic);
                if (!logic.load()) {
                    return false;
                }
            }
        }
    }
}

log.info("load logics queue all over, OK");

return true;
```

***ä»£ç ï¼šIndexService#load***

åŠ è½½ç´¢å¼•æ–‡ä»¶

```java
public boolean load(final boolean lastExitOK) {
    //ç´¢å¼•æ–‡ä»¶ç›®å½•
    File dir = new File(this.storePath);
    //éå†ç´¢å¼•æ–‡ä»¶
    File[] files = dir.listFiles();
    if (files != null) {
        //æ–‡ä»¶æ’åº
        Arrays.sort(files);
        //éå†æ–‡ä»¶
        for (File file : files) {
            try {
                //åŠ è½½ç´¢å¼•æ–‡ä»¶
                IndexFile f = new IndexFile(file.getPath(), this.hashSlotNum, this.indexNum, 0, 0);
                f.load();

                if (!lastExitOK) {
                    //ç´¢å¼•æ–‡ä»¶ä¸Šæ¬¡çš„åˆ·ç›˜æ—¶é—´å°äºè¯¥ç´¢å¼•æ–‡ä»¶çš„æ¶ˆæ¯æ—¶é—´æˆ³,è¯¥æ–‡ä»¶å°†ç«‹å³åˆ é™¤
                    if (f.getEndTimestamp() > this.defaultMessageStore.getStoreCheckpoint()
                        .getIndexMsgTimestamp()) {
                        f.destroy(0);
                        continue;
                    }
                }
				//å°†ç´¢å¼•æ–‡ä»¶æ·»åŠ åˆ°é˜Ÿåˆ—
                log.info("load index file OK, " + f.getFileName());
                this.indexFileList.add(f);
            } catch (IOException e) {
                log.error("load file {} error", file, e);
                return false;
            } catch (NumberFormatException e) {
                log.error("load file {} error", file, e);
            }
        }
    }

    return true;
}
```

***ä»£ç ï¼šDefaultMessageStore#recover***

æ–‡ä»¶æ¢å¤ï¼Œæ ¹æ®Brokeræ˜¯å¦æ­£å¸¸é€€å‡ºæ‰§è¡Œä¸åŒçš„æ¢å¤ç­–ç•¥

```java
private void recover(final boolean lastExitOK) {
    //è·å¾—æœ€å¤§çš„ç‰©ç†ä¾¿å®œæ¶ˆè´¹é˜Ÿåˆ—
    long maxPhyOffsetOfConsumeQueue = this.recoverConsumeQueue();

    if (lastExitOK) {
        //æ­£å¸¸æ¢å¤
        this.commitLog.recoverNormally(maxPhyOffsetOfConsumeQueue);
    } else {
        //å¼‚å¸¸æ¢å¤
        this.commitLog.recoverAbnormally(maxPhyOffsetOfConsumeQueue);
    }
	//åœ¨CommitLogä¸­ä¿å­˜æ¯ä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—å½“å‰çš„å­˜å‚¨é€»è¾‘åç§»é‡
    this.recoverTopicQueueTable();
}
```

***ä»£ç ï¼šDefaultMessageStore#recoverTopicQueueTable***

æ¢å¤ConsumerQueueåï¼Œå°†åœ¨CommitLogå®ä¾‹ä¸­ä¿å­˜æ¯éš”æ¶ˆæ¯é˜Ÿåˆ—å½“å‰çš„å­˜å‚¨é€»è¾‘åç§»é‡ï¼Œè¿™ä¹Ÿæ˜¯æ¶ˆæ¯ä¸­ä¸ä»…å­˜å‚¨ä¸»é¢˜ã€æ¶ˆæ¯é˜Ÿåˆ—IDã€è¿˜å­˜å‚¨äº†æ¶ˆæ¯é˜Ÿåˆ—çš„å…³é”®æ‰€åœ¨ã€‚

```java
public void recoverTopicQueueTable() {
    HashMap<String/* topic-queueid */, Long/* offset */> table = new HashMap<String, Long>(1024);
    //CommitLogæœ€å°åç§»é‡
    long minPhyOffset = this.commitLog.getMinOffset();
    //éå†æ¶ˆè´¹é˜Ÿåˆ—,å°†æ¶ˆè´¹é˜Ÿåˆ—ä¿å­˜åœ¨CommitLogä¸­
    for (ConcurrentMap<Integer, ConsumeQueue> maps : this.consumeQueueTable.values()) {
        for (ConsumeQueue logic : maps.values()) {
            String key = logic.getTopic() + "-" + logic.getQueueId();
            table.put(key, logic.getMaxOffsetInQueue());
            logic.correctMinOffset(minPhyOffset);
        }
    }
    this.commitLog.setTopicQueueTable(table);
}
```

####2ï¼‰æ­£å¸¸æ¢å¤

***ä»£ç ï¼šCommitLog#recoverNormally***

```java
public void recoverNormally(long maxPhyOffsetOfConsumeQueue) {
	
    final List<MappedFile> mappedFiles = this.mappedFileQueue.getMappedFiles();
    if (!mappedFiles.isEmpty()) {
         //Brokeræ­£å¸¸åœæ­¢å†é‡å¯æ—¶,ä»å€’æ•°ç¬¬ä¸‰ä¸ªå¼€å§‹æ¢å¤,å¦‚æœä¸è¶³3ä¸ªæ–‡ä»¶,åˆ™ä»ç¬¬ä¸€ä¸ªæ–‡ä»¶å¼€å§‹æ¢å¤ã€‚
        int index = mappedFiles.size() - 3;
        if (index < 0)
            index = 0;
        MappedFile mappedFile = mappedFiles.get(index);
        ByteBuffer byteBuffer = mappedFile.sliceByteBuffer();
        long processOffset = mappedFile.getFileFromOffset();
        //ä»£è¡¨å½“å‰å·²æ ¡éªŒé€šè¿‡çš„offset
        long mappedFileOffset = 0;
        while (true) {
            //æŸ¥æ‰¾æ¶ˆæ¯
            DispatchRequest dispatchRequest = this.checkMessageAndReturnSize(byteBuffer, checkCRCOnRecover);
            //æ¶ˆæ¯é•¿åº¦
            int size = dispatchRequest.getMsgSize();
           	//æŸ¥æ‰¾ç»“æœä¸ºtrue,å¹¶ä¸”æ¶ˆæ¯é•¿åº¦å¤§äº0,è¡¨ç¤ºæ¶ˆæ¯æ­£ç¡®.mappedFileOffsetå‘å‰ç§»åŠ¨æœ¬æ¶ˆæ¯é•¿åº¦
            if (dispatchRequest.isSuccess() && size > 0) {
                mappedFileOffset += size;
            }
			//å¦‚æœæŸ¥æ‰¾ç»“æœä¸ºtrueä¸”æ¶ˆæ¯é•¿åº¦ç­‰äº0,è¡¨ç¤ºå·²åˆ°è¯¥æ–‡ä»¶æœ«å°¾,å¦‚æœè¿˜æœ‰ä¸‹ä¸€ä¸ªæ–‡ä»¶,åˆ™é‡ç½®processOffsetå’ŒMappedFileOffseté‡å¤æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ–‡ä»¶,å¦åˆ™è·³å‡ºå¾ªç¯ã€‚
            else if (dispatchRequest.isSuccess() && size == 0) {
              index++;
              if (index >= mappedFiles.size()) {
                  // Current branch can not happen
                  break;
              } else {
                  //å–å‡ºæ¯ä¸ªæ–‡ä»¶
                  mappedFile = mappedFiles.get(index);
                  byteBuffer = mappedFile.sliceByteBuffer();
                  processOffset = mappedFile.getFileFromOffset();
                  mappedFileOffset = 0;
                  
          		}
            }
            // æŸ¥æ‰¾ç»“æœä¸ºfalseï¼Œè¡¨æ˜è¯¥æ–‡ä»¶æœªå¡«æ»¡æ‰€æœ‰æ¶ˆæ¯ï¼Œè·³å‡ºå¾ªç¯ï¼Œç»“æŸå¾ªç¯
            else if (!dispatchRequest.isSuccess()) {
                log.info("recover physics file end, " + mappedFile.getFileName());
                break;
            }
        }
		//æ›´æ–°MappedFileQueueçš„flushedWhereå’ŒcommittedWhereæŒ‡é’ˆ
        processOffset += mappedFileOffset;
        this.mappedFileQueue.setFlushedWhere(processOffset);
        this.mappedFileQueue.setCommittedWhere(processOffset);
        //åˆ é™¤offsetä¹‹åçš„æ‰€æœ‰æ–‡ä»¶
        this.mappedFileQueue.truncateDirtyFiles(processOffset);

        
        if (maxPhyOffsetOfConsumeQueue >= processOffset) {
            this.defaultMessageStore.truncateDirtyLogicFiles(processOffset);
        }
    } else {
        this.mappedFileQueue.setFlushedWhere(0);
        this.mappedFileQueue.setCommittedWhere(0);
        this.defaultMessageStore.destroyLogics();
    }
}
```

***ä»£ç ï¼šMappedFileQueue#truncateDirtyFiles***

```java
public void truncateDirtyFiles(long offset) {
    List<MappedFile> willRemoveFiles = new ArrayList<MappedFile>();
	//éå†ç›®å½•ä¸‹æ–‡ä»¶
    for (MappedFile file : this.mappedFiles) {
        //æ–‡ä»¶å°¾éƒ¨çš„åç§»é‡
        long fileTailOffset = file.getFileFromOffset() + this.mappedFileSize;
        //æ–‡ä»¶å°¾éƒ¨çš„åç§»é‡å¤§äºoffset
        if (fileTailOffset > offset) {
            //offsetå¤§äºæ–‡ä»¶çš„èµ·å§‹åç§»é‡
            if (offset >= file.getFileFromOffset()) {
                //æ›´æ–°wrotePositionã€committedPositionã€flushedPosistion
                file.setWrotePosition((int) (offset % this.mappedFileSize));
                file.setCommittedPosition((int) (offset % this.mappedFileSize));
                file.setFlushedPosition((int) (offset % this.mappedFileSize));
            } else {
                //offsetå°äºæ–‡ä»¶çš„èµ·å§‹åç§»é‡,è¯´æ˜è¯¥æ–‡ä»¶æ˜¯æœ‰æ•ˆæ–‡ä»¶åé¢åˆ›å»ºçš„,é‡Šæ”¾mappedFileå ç”¨å†…å­˜,åˆ é™¤æ–‡ä»¶
                file.destroy(1000);
                willRemoveFiles.add(file);
            }
        }
    }

    this.deleteExpiredFile(willRemoveFiles);
}
```

####3ï¼‰å¼‚å¸¸æ¢å¤

Brokerå¼‚å¸¸åœæ­¢æ–‡ä»¶æ¢å¤çš„å®ç°ä¸ºCommitLog#recoverAbnormallyã€‚å¼‚å¸¸æ–‡ä»¶æ¢å¤æ­¥éª¤ä¸æ­£å¸¸åœæ­¢æ–‡ä»¶æ¢å¤æµç¨‹åŸºæœ¬ç›¸åŒï¼Œå…¶ä¸»è¦å·®åˆ«æœ‰ä¸¤ä¸ªã€‚é¦–å…ˆï¼Œæ­£å¸¸åœæ­¢é»˜è®¤ä»å€’æ•°ç¬¬ä¸‰ä¸ªæ–‡ä»¶å¼€å§‹è¿›è¡Œæ¢å¤ï¼Œè€Œå¼‚å¸¸åœæ­¢åˆ™éœ€è¦ä»æœ€åä¸€ä¸ªæ–‡ä»¶å¾€å‰èµ°ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¶ˆæ¯å­˜å‚¨æ­£å¸¸çš„æ–‡ä»¶ã€‚å…¶æ¬¡ï¼Œå¦‚æœCommitLogç›®å½•æ²¡æœ‰æ¶ˆæ¯æ–‡ä»¶ï¼Œå¦‚æœæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ç›®å½•ä¸‹å­˜åœ¨æ–‡ä»¶ï¼Œåˆ™éœ€è¦é”€æ¯ã€‚

***ä»£ç ï¼šCommitLog#recoverAbnormally***

```java
if (!mappedFiles.isEmpty()) {
    // Looking beginning to recover from which file
    int index = mappedFiles.size() - 1;
    MappedFile mappedFile = null;
    for (; index >= 0; index--) {
        mappedFile = mappedFiles.get(index);
        //åˆ¤æ–­æ¶ˆæ¯æ–‡ä»¶æ˜¯å¦æ˜¯ä¸€ä¸ªæ­£ç¡®çš„æ–‡ä»¶
        if (this.isMappedFileMatchedRecover(mappedFile)) {
            log.info("recover from this mapped file " + mappedFile.getFileName());
            break;
        }
    }
	//æ ¹æ®ç´¢å¼•å–å‡ºmappedFileæ–‡ä»¶
    if (index < 0) {
        index = 0;
        mappedFile = mappedFiles.get(index);
    }
    //...éªŒè¯æ¶ˆæ¯çš„åˆæ³•æ€§,å¹¶å°†æ¶ˆæ¯è½¬å‘åˆ°æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—å’Œç´¢å¼•æ–‡ä»¶
       
}else{
    //æœªæ‰¾åˆ°mappedFile,é‡ç½®flushWhereã€committedWhereéƒ½ä¸º0ï¼Œé”€æ¯æ¶ˆæ¯é˜Ÿåˆ—æ–‡ä»¶
    this.mappedFileQueue.setFlushedWhere(0);
    this.mappedFileQueue.setCommittedWhere(0);
    this.defaultMessageStore.destroyLogics();
}
```

### åˆ·ç›˜æœºåˆ¶

RocketMQçš„å­˜å‚¨æ˜¯åŸºäºJDK NIOçš„å†…å­˜æ˜ å°„æœºåˆ¶ï¼ˆMappedByteBufferï¼‰çš„ï¼Œæ¶ˆæ¯å­˜å‚¨é¦–å…ˆå°†æ¶ˆæ¯è¿½åŠ åˆ°å†…å­˜ï¼Œå†æ ¹æ®é…ç½®çš„åˆ·ç›˜ç­–ç•¥åœ¨ä¸åŒæ—¶é—´è¿›è¡Œåˆ·å†™ç£ç›˜ã€‚

#### åŒæ­¥åˆ·ç›˜

æ¶ˆæ¯è¿½åŠ åˆ°å†…å­˜åï¼Œç«‹å³å°†æ•°æ®åˆ·å†™åˆ°ç£ç›˜æ–‡ä»¶

![](/assets/imgs/åŒæ­¥åˆ·ç›˜æµç¨‹.png)

***ä»£ç ï¼šCommitLog#handleDiskFlush***

```java
//åˆ·ç›˜æœåŠ¡
final GroupCommitService service = (GroupCommitService) this.flushCommitLogService;
if (messageExt.isWaitStoreMsgOK()) {
    //å°è£…åˆ·ç›˜è¯·æ±‚
    GroupCommitRequest request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());
    //æäº¤åˆ·ç›˜è¯·æ±‚
    service.putRequest(request);
    //çº¿ç¨‹é˜»å¡5ç§’ï¼Œç­‰å¾…åˆ·ç›˜ç»“æŸ
    boolean flushOK = request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());
    if (!flushOK) {
        putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_DISK_TIMEOUT);
    }
```

***GroupCommitRequest***

![](/assets/imgs/GroupCommitRequest.png)

```java
long nextOffset;	//åˆ·ç›˜ç‚¹åç§»é‡
CountDownLatch countDownLatch = new CountDownLatch(1);	//å€’è®¡æ ‘é”å­˜å™¨
volatile boolean flushOK = false;	//åˆ·ç›˜ç»“æœ;é»˜è®¤ä¸ºfalse
```

***ä»£ç ï¼šGroupCommitService#run***

```java
public void run() {
    CommitLog.log.info(this.getServiceName() + " service started");

    while (!this.isStopped()) {
        try {
            //çº¿ç¨‹ç­‰å¾…10ms
            this.waitForRunning(10);
            //æ‰§è¡Œæäº¤
            this.doCommit();
        } catch (Exception e) {
            CommitLog.log.warn(this.getServiceName() + " service has exception. ", e);
        }
    }
	...
}
```

***ä»£ç ï¼šGroupCommitService#doCommit***

```java
private void doCommit() {
    //åŠ é”
    synchronized (this.requestsRead) {
        if (!this.requestsRead.isEmpty()) {
            //éå†requestsRead
            for (GroupCommitRequest req : this.requestsRead) {
                // There may be a message in the next file, so a maximum of
                // two times the flush
                boolean flushOK = false;
                for (int i = 0; i < 2 && !flushOK; i++) {
                    flushOK = CommitLog.this.mappedFileQueue.getFlushedWhere() >= req.getNextOffset();
					//åˆ·ç›˜
                    if (!flushOK) {
                        CommitLog.this.mappedFileQueue.flush(0);
                    }
                }
				//å”¤é†’å‘é€æ¶ˆæ¯å®¢æˆ·ç«¯
                req.wakeupCustomer(flushOK);
            }
			
            //æ›´æ–°åˆ·ç›˜ç›‘æµ‹ç‚¹
            long storeTimestamp = CommitLog.this.mappedFileQueue.getStoreTimestamp();
            if (storeTimestamp > 0) {               CommitLog.this.defaultMessageStore.getStoreCheckpoint().setPhysicMsgTimestamp(storeTimestamp);
            }
			
            this.requestsRead.clear();
        } else {
            // Because of individual messages is set to not sync flush, it
            // will come to this process
            CommitLog.this.mappedFileQueue.flush(0);
        }
    }
}
```

#### å¼‚æ­¥åˆ·ç›˜

åœ¨æ¶ˆæ¯è¿½åŠ åˆ°å†…å­˜åï¼Œç«‹å³è¿”å›ç»™æ¶ˆæ¯å‘é€ç«¯ã€‚å¦‚æœå¼€å¯transientStorePoolEnableï¼ŒRocketMQä¼šå•ç‹¬ç”³è¯·ä¸€ä¸ªä¸ç›®æ ‡ç‰©ç†æ–‡ä»¶ï¼ˆcommitLogï¼‰åŒæ ·å¤§å°çš„å †å¤–å†…å­˜ï¼Œè¯¥å †å¤–å†…å­˜å°†ä½¿ç”¨å†…å­˜é”å®šï¼Œç¡®ä¿ä¸ä¼šè¢«ç½®æ¢åˆ°è™šæ‹Ÿå†…å­˜ä¸­å»ï¼Œæ¶ˆæ¯é¦–å…ˆè¿½åŠ åˆ°å †å¤–å†…å­˜ï¼Œç„¶åæäº¤åˆ°ç‰©ç†æ–‡ä»¶çš„å†…å­˜æ˜ å°„ä¸­ï¼Œç„¶ååˆ·å†™åˆ°ç£ç›˜ã€‚å¦‚æœæœªå¼€å¯transientStorePoolEnableï¼Œæ¶ˆæ¯ç›´æ¥è¿½åŠ åˆ°ç‰©ç†æ–‡ä»¶ç›´æ¥æ˜ å°„æ–‡ä»¶ä¸­ï¼Œç„¶ååˆ·å†™åˆ°ç£ç›˜ä¸­ã€‚

![](/assets/imgs/å¼‚æ­¥åˆ·ç›˜æµç¨‹.png)

å¼€å¯transientStorePoolEnableåå¼‚æ­¥åˆ·ç›˜æ­¥éª¤:

1. å°†æ¶ˆæ¯ç›´æ¥è¿½åŠ åˆ°ByteBufferï¼ˆå †å¤–å†…å­˜ï¼‰
2. CommitRealTimeServiceçº¿ç¨‹æ¯éš”200mså°†ByteBufferæ–°è¿½åŠ å†…å®¹æäº¤åˆ°MappedByteBufferä¸­
3. MappedByteBufferåœ¨å†…å­˜ä¸­è¿½åŠ æäº¤çš„å†…å®¹ï¼ŒwrotePositionæŒ‡é’ˆå‘åç§»åŠ¨
4. commitæ“ä½œæˆåŠŸè¿”å›ï¼Œå°†committedPositionä½ç½®æ¢å¤
5. FlushRealTimeServiceçº¿ç¨‹é»˜è®¤æ¯500mså°†MappedByteBufferä¸­æ–°è¿½åŠ çš„å†…å­˜åˆ·å†™åˆ°ç£ç›˜

***ä»£ç ï¼šCommitLog$CommitRealTimeService#run***

æäº¤çº¿ç¨‹å·¥ä½œæœºåˆ¶

```java
//é—´éš”æ—¶é—´,é»˜è®¤200ms
int interval = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getCommitIntervalCommitLog();

//ä¸€æ¬¡æäº¤çš„è‡³å°‘é¡µæ•°
int commitDataLeastPages = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getCommitCommitLogLeastPages();

//ä¸¤æ¬¡çœŸå®æäº¤çš„æœ€å¤§é—´éš”,é»˜è®¤200ms
int commitDataThoroughInterval =
CommitLog.this.defaultMessageStore.getMessageStoreConfig().getCommitCommitLogThoroughInterval();

//ä¸Šæ¬¡æäº¤é—´éš”è¶…è¿‡commitDataThoroughInterval,åˆ™å¿½ç•¥æäº¤commitDataThoroughIntervalå‚æ•°,ç›´æ¥æäº¤
long begin = System.currentTimeMillis();
if (begin >= (this.lastCommitTimestamp + commitDataThoroughInterval)) {
    this.lastCommitTimestamp = begin;
    commitDataLeastPages = 0;
}

//æ‰§è¡Œæäº¤æ“ä½œ,å°†å¾…æäº¤æ•°æ®æäº¤åˆ°ç‰©ç†æ–‡ä»¶çš„å†…å­˜æ˜ å°„åŒº
boolean result = CommitLog.this.mappedFileQueue.commit(commitDataLeastPages);
long end = System.currentTimeMillis();
if (!result) {
    this.lastCommitTimestamp = end; // result = false means some data committed.
    //now wake up flush thread.
    //å”¤é†’åˆ·ç›˜çº¿ç¨‹
    flushCommitLogService.wakeup();
}

if (end - begin > 500) {
    log.info("Commit data to file costs {} ms", end - begin);
}
this.waitForRunning(interval);
```

***ä»£ç ï¼šCommitLog$FlushRealTimeService#run***

åˆ·ç›˜çº¿ç¨‹å·¥ä½œæœºåˆ¶

```java
//è¡¨ç¤ºawaitæ–¹æ³•ç­‰å¾…,é»˜è®¤false
boolean flushCommitLogTimed = CommitLog.this.defaultMessageStore.getMessageStoreConfig().isFlushCommitLogTimed();
//çº¿ç¨‹æ‰§è¡Œæ—¶é—´é—´éš”
int interval = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushIntervalCommitLog();
//ä¸€æ¬¡åˆ·å†™ä»»åŠ¡è‡³å°‘åŒ…å«é¡µæ•°
int flushPhysicQueueLeastPages = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushCommitLogLeastPages();
//ä¸¤æ¬¡çœŸå®åˆ·å†™ä»»åŠ¡æœ€å¤§é—´éš”
int flushPhysicQueueThoroughInterval =
CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushCommitLogThoroughInterval();
...
//è·ç¦»ä¸Šæ¬¡æäº¤é—´éš”è¶…è¿‡flushPhysicQueueThoroughInterval,åˆ™æœ¬æ¬¡åˆ·ç›˜ä»»åŠ¡å°†å¿½ç•¥flushPhysicQueueLeastPages,ç›´æ¥æäº¤
long currentTimeMillis = System.currentTimeMillis();
if (currentTimeMillis >= (this.lastFlushTimestamp + flushPhysicQueueThoroughInterval)) {
    this.lastFlushTimestamp = currentTimeMillis;
    flushPhysicQueueLeastPages = 0;
    printFlushProgress = (printTimes++ % 10) == 0;
}
...
//æ‰§è¡Œä¸€æ¬¡åˆ·ç›˜å‰,å…ˆç­‰å¾…æŒ‡å®šæ—¶é—´é—´éš”
if (flushCommitLogTimed) {
    Thread.sleep(interval);
} else {
    this.waitForRunning(interval);
}
...
long begin = System.currentTimeMillis();
//åˆ·å†™ç£ç›˜
CommitLog.this.mappedFileQueue.flush(flushPhysicQueueLeastPages);
long storeTimestamp = CommitLog.this.mappedFileQueue.getStoreTimestamp();
if (storeTimestamp > 0) {
//æ›´æ–°å­˜å‚¨ç›‘æµ‹ç‚¹æ–‡ä»¶çš„æ—¶é—´æˆ³
CommitLog.this.defaultMessageStore.getStoreCheckpoint().setPhysicMsgTimestamp(storeTimestamp);

```

### è¿‡æœŸæ–‡ä»¶åˆ é™¤æœºåˆ¶

ç”±äºRocketMQæ“ä½œCommitLogã€ConsumerQueueæ–‡ä»¶æ˜¯åŸºäºå†…å­˜æ˜ å°„æœºåˆ¶å¹¶åœ¨å¯åŠ¨çš„æ—¶å€™å›åŠ è½½CommitLogã€ConsumerQueueç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œä¸ºäº†é¿å…å†…å­˜ä¸ç£ç›˜çš„æµªè´¹ï¼Œä¸å¯èƒ½å°†æ¶ˆæ¯æ°¸ä¹…å­˜å‚¨åœ¨æ¶ˆæ¯æœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥è¦å¼•å…¥ä¸€ç§æœºåˆ¶æ¥åˆ é™¤å·²è¿‡æœŸçš„æ–‡ä»¶ã€‚RocketMQé¡ºåºå†™CommitLogã€ConsumerQueueæ–‡ä»¶ï¼Œæ‰€æœ‰å†™æ“ä½œå…¨éƒ¨è½åœ¨æœ€åä¸€ä¸ªCommitLogæˆ–è€…ConsumerQueueæ–‡ä»¶ä¸Šï¼Œä¹‹å‰çš„æ–‡ä»¶åœ¨ä¸‹ä¸€ä¸ªæ–‡ä»¶åˆ›å»ºåå°†ä¸ä¼šå†è¢«æ›´æ–°ã€‚RocketMQæ¸…é™¤è¿‡æœŸæ–‡ä»¶çš„æ–¹æ³•æ—¶ï¼šå¦‚æœå½“å‰æ–‡ä»¶åœ¨åœ¨ä¸€å®šæ—¶é—´é—´éš”å†…æ²¡æœ‰å†æ¬¡è¢«æ¶ˆè´¹ï¼Œåˆ™è®¤ä¸ºæ˜¯è¿‡æœŸæ–‡ä»¶ï¼Œå¯ä»¥è¢«åˆ é™¤ï¼ŒRocketMQä¸ä¼šå…³æ³¨è¿™ä¸ªæ–‡ä»¶ä¸Šçš„æ¶ˆæ¯æ˜¯å¦å…¨éƒ¨è¢«æ¶ˆè´¹ã€‚é»˜è®¤æ¯ä¸ªæ–‡ä»¶çš„è¿‡æœŸæ—¶é—´ä¸º72å°æ—¶ï¼Œé€šè¿‡åœ¨Brokeré…ç½®æ–‡ä»¶ä¸­è®¾ç½®fileReservedTimeæ¥æ”¹å˜è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºå°æ—¶ã€‚

***ä»£ç ï¼šDefaultMessageStore#addScheduleTask***

```java
private void addScheduleTask() {
	//æ¯éš”10sè°ƒåº¦ä¸€æ¬¡æ¸…é™¤æ–‡ä»¶
    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {
        @Override
        public void run() {
            DefaultMessageStore.this.cleanFilesPeriodically();
        }
    }, 1000 * 60, this.messageStoreConfig.getCleanResourceInterval(), TimeUnit.MILLISECONDS);
	...
}
```

***ä»£ç ï¼šDefaultMessageStore#cleanFilesPeriodically***

```java
private void cleanFilesPeriodically() {
    //æ¸…é™¤å­˜å‚¨æ–‡ä»¶
    this.cleanCommitLogService.run();
    //æ¸…é™¤æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶
    this.cleanConsumeQueueService.run();
}
```

***ä»£ç ï¼šDefaultMessageStore#deleteExpiredFiles***

```java
private void deleteExpiredFiles() {
    //åˆ é™¤çš„æ•°é‡
    int deleteCount = 0;
    //æ–‡ä»¶ä¿ç•™çš„æ—¶é—´
    long fileReservedTime = DefaultMessageStore.this.getMessageStoreConfig().getFileReservedTime();
    //åˆ é™¤ç‰©ç†æ–‡ä»¶çš„é—´éš”
    int deletePhysicFilesInterval = DefaultMessageStore.this.getMessageStoreConfig().getDeleteCommitLogFilesInterval();
    //çº¿ç¨‹è¢«å ç”¨,ç¬¬ä¸€æ¬¡æ‹’ç»åˆ é™¤åèƒ½ä¿ç•™çš„æœ€å¤§æ—¶é—´,è¶…è¿‡è¯¥æ—¶é—´,æ–‡ä»¶å°†è¢«å¼ºåˆ¶åˆ é™¤
    int destroyMapedFileIntervalForcibly = DefaultMessageStore.this.getMessageStoreConfig().getDestroyMapedFileIntervalForcibly();

boolean timeup = this.isTimeToDelete();
boolean spacefull = this.isSpaceToDelete();
boolean manualDelete = this.manualDeleteFileSeveralTimes > 0;
if (timeup || spacefull || manualDelete) {
	...æ‰§è¡Œåˆ é™¤é€»è¾‘
}else{
    ...æ— ä½œä¸º
}
```

åˆ é™¤æ–‡ä»¶æ“ä½œçš„æ¡ä»¶

1. æŒ‡å®šåˆ é™¤æ–‡ä»¶çš„æ—¶é—´ç‚¹ï¼ŒRocketMQé€šè¿‡deleteWhenè®¾ç½®ä¸€å¤©çš„å›ºå®šæ—¶é—´æ‰§è¡Œä¸€æ¬¡åˆ é™¤è¿‡æœŸæ–‡ä»¶æ“ä½œï¼Œé»˜è®¤4ç‚¹
2. ç£ç›˜ç©ºé—´å¦‚æœä¸å……è¶³ï¼Œåˆ é™¤è¿‡æœŸæ–‡ä»¶
3. é¢„ç•™ï¼Œæ‰‹å·¥è§¦å‘ã€‚

***ä»£ç ï¼šCleanCommitLogService#isSpaceToDelete***

å½“ç£ç›˜ç©ºé—´ä¸è¶³æ—¶æ‰§è¡Œåˆ é™¤è¿‡æœŸæ–‡ä»¶

```java
private boolean isSpaceToDelete() {
    //ç£ç›˜åˆ†åŒºçš„æœ€å¤§ä½¿ç”¨é‡
    double ratio = DefaultMessageStore.this.getMessageStoreConfig().getDiskMaxUsedSpaceRatio() / 100.0;
	//æ˜¯å¦éœ€è¦ç«‹å³æ‰§è¡Œåˆ é™¤è¿‡æœŸæ–‡ä»¶æ“ä½œ
    cleanImmediately = false;

    {
        String storePathPhysic = DefaultMessageStore.this.getMessageStoreConfig().getStorePathCommitLog();
        //å½“å‰CommitLogç›®å½•æ‰€åœ¨çš„ç£ç›˜åˆ†åŒºçš„ç£ç›˜ä½¿ç”¨ç‡
        double physicRatio = UtilAll.getDiskPartitionSpaceUsedPercent(storePathPhysic);
        //diskSpaceWarningLevelRatio:ç£ç›˜ä½¿ç”¨ç‡è­¦å‘Šé˜ˆå€¼,é»˜è®¤0.90
        if (physicRatio > diskSpaceWarningLevelRatio) {
            boolean diskok = DefaultMessageStore.this.runningFlags.getAndMakeDiskFull();
            if (diskok) {
                DefaultMessageStore.log.error("physic disk maybe full soon " + physicRatio + ", so mark disk full");
            }
			//diskSpaceCleanForciblyRatio:å¼ºåˆ¶æ¸…é™¤é˜ˆå€¼,é»˜è®¤0.85
            cleanImmediately = true;
        } else if (physicRatio > diskSpaceCleanForciblyRatio) {
            cleanImmediately = true;
        } else {
            boolean diskok = DefaultMessageStore.this.runningFlags.getAndMakeDiskOK();
            if (!diskok) {
            DefaultMessageStore.log.info("physic disk space OK " + physicRatio + ", so mark disk ok");
        }
    }

    if (physicRatio < 0 || physicRatio > ratio) {
        DefaultMessageStore.log.info("physic disk maybe full soon, so reclaim space, " + physicRatio);
        return true;
    }
}
```

***ä»£ç ï¼šMappedFileQueue#deleteExpiredFileByTime***

æ‰§è¡Œæ–‡ä»¶é”€æ¯å’Œåˆ é™¤

```java
for (int i = 0; i < mfsLength; i++) {
    //éå†æ¯éš”æ–‡ä»¶
    MappedFile mappedFile = (MappedFile) mfs[i];
    //è®¡ç®—æ–‡ä»¶å­˜æ´»æ—¶é—´
    long liveMaxTimestamp = mappedFile.getLastModifiedTimestamp() + expiredTime;
    //å¦‚æœè¶…è¿‡72å°æ—¶,æ‰§è¡Œæ–‡ä»¶åˆ é™¤
    if (System.currentTimeMillis() >= liveMaxTimestamp || cleanImmediately) {
        if (mappedFile.destroy(intervalForcibly)) {
            files.add(mappedFile);
            deleteCount++;

            if (files.size() >= DELETE_FILES_BATCH_MAX) {
                break;
            }

            if (deleteFilesInterval > 0 && (i + 1) < mfsLength) {
                try {
                    Thread.sleep(deleteFilesInterval);
                } catch (InterruptedException e) {
                }
            }
        } else {
            break;
        }
    } else {
        //avoid deleting files in the middle
        break;
    }
}
```

### å°ç»“

RocketMQçš„å­˜å‚¨æ–‡ä»¶åŒ…æ‹¬æ¶ˆæ¯æ–‡ä»¶ï¼ˆCommitlogï¼‰ã€æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ï¼ˆConsumerQueueï¼‰ã€Hashç´¢å¼•æ–‡ä»¶ï¼ˆIndexFileï¼‰ã€ç›‘æµ‹ç‚¹æ–‡ä»¶ï¼ˆcheckPointï¼‰ã€abortï¼ˆå…³é—­å¼‚å¸¸æ–‡ä»¶ï¼‰ã€‚å•ä¸ªæ¶ˆæ¯å­˜å‚¨æ–‡ä»¶ã€æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ã€Hashç´¢å¼•æ–‡ä»¶é•¿åº¦å›ºå®šä»¥ä¾¿ä½¿ç”¨å†…å­˜æ˜ å°„æœºåˆ¶è¿›è¡Œæ–‡ä»¶çš„è¯»å†™æ“ä½œã€‚RocketMQç»„ç»‡æ–‡ä»¶ä»¥æ–‡ä»¶çš„èµ·å§‹åç§»é‡æ¥å‘½ä»¤æ–‡ä»¶ï¼Œè¿™æ ·æ ¹æ®åç§»é‡èƒ½å¿«é€Ÿå®šä½åˆ°çœŸå®çš„ç‰©ç†æ–‡ä»¶ã€‚RocketMQåŸºäºå†…å­˜æ˜ å°„æ–‡ä»¶æœºåˆ¶æä¾›äº†åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ä¸¤ç§æœºåˆ¶ï¼Œå¼‚æ­¥åˆ·ç›˜æ˜¯æŒ‡åœ¨æ¶ˆæ¯å­˜å‚¨æ—¶å…ˆè¿½åŠ åˆ°å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œç„¶åå¯åŠ¨ä¸“é—¨çš„åˆ·ç›˜çº¿ç¨‹å®šæ—¶å°†å†…å­˜ä¸­çš„æ–‡ä»¶æ•°æ®åˆ·å†™åˆ°ç£ç›˜ã€‚

CommitLogï¼Œæ¶ˆæ¯å­˜å‚¨æ–‡ä»¶ï¼ŒRocketMQä¸ºäº†ä¿è¯æ¶ˆæ¯å‘é€çš„é«˜ååé‡ï¼Œé‡‡ç”¨å•ä¸€æ–‡ä»¶å­˜å‚¨æ‰€æœ‰ä¸»é¢˜æ¶ˆæ¯ï¼Œä¿è¯æ¶ˆæ¯å­˜å‚¨æ˜¯å®Œå…¨çš„é¡ºåºå†™ï¼Œä½†è¿™æ ·ç»™æ–‡ä»¶è¯»å–å¸¦æ¥äº†ä¸ä¾¿ï¼Œä¸ºæ­¤RocketMQä¸ºäº†æ–¹ä¾¿æ¶ˆæ¯æ¶ˆè´¹æ„å»ºäº†æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ï¼ŒåŸºäºä¸»é¢˜ä¸é˜Ÿåˆ—è¿›è¡Œç»„ç»‡ï¼ŒåŒæ—¶RocketMQä¸ºæ¶ˆæ¯å®ç°äº†Hashç´¢å¼•ï¼Œå¯ä»¥ä¸ºæ¶ˆæ¯è®¾ç½®ç´¢å¼•é”®ï¼Œæ ¹æ®æ‰€ä»¥èƒ½å¤Ÿå¿«é€Ÿä»CommitLogæ–‡ä»¶ä¸­æ£€ç´¢æ¶ˆæ¯ã€‚

å½“æ¶ˆæ¯è¾¾åˆ°CommitLogåï¼Œä¼šé€šè¿‡ReputMessageServiceçº¿ç¨‹æ¥è¿‘å®æ—¶åœ°å°†æ¶ˆæ¯è½¬å‘ç»™æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸ç´¢å¼•æ–‡ä»¶ã€‚ä¸ºäº†å®‰å…¨èµ·è§ï¼ŒRocketMQå¼•å…¥abortæ–‡ä»¶ï¼Œè®°å½•Brokerçš„åœæœºæ˜¯å¦æ˜¯æ­£å¸¸å…³é—­è¿˜æ˜¯å¼‚å¸¸å…³é—­ï¼Œåœ¨é‡å¯Brokeræ—¶ä¸ºäº†ä¿è¯CommitLogæ–‡ä»¶ï¼Œæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸Hashç´¢å¼•æ–‡ä»¶çš„æ­£ç¡®æ€§ï¼Œåˆ†åˆ«é‡‡ç”¨ä¸åŒç­–ç•¥æ¥æ¢å¤æ–‡ä»¶ã€‚

RocketMQä¸ä¼šæ°¸ä¹…å­˜å‚¨æ¶ˆæ¯æ–‡ä»¶ã€æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ï¼Œè€Œæ˜¯å¯åŠ¨æ–‡ä»¶è¿‡æœŸæœºåˆ¶å¹¶åœ¨ç£ç›˜ç©ºé—´ä¸è¶³æˆ–è€…é»˜è®¤å‡Œæ™¨4ç‚¹åˆ é™¤è¿‡æœŸæ–‡ä»¶ï¼Œæ–‡ä»¶ä¿å­˜72å°æ—¶å¹¶ä¸”åœ¨åˆ é™¤æ–‡ä»¶æ—¶å¹¶ä¸ä¼šåˆ¤æ–­è¯¥æ¶ˆæ¯æ–‡ä»¶ä¸Šçš„æ¶ˆæ¯æ˜¯å¦è¢«æ¶ˆè´¹ã€‚

## Consumer

### æ¶ˆæ¯æ¶ˆè´¹æ¦‚è¿°

æ¶ˆæ¯æ¶ˆè´¹ä»¥ç»„çš„æ¨¡å¼å¼€å±•ï¼Œä¸€ä¸ªæ¶ˆè´¹ç»„å†…å¯ä»¥åŒ…å«å¤šä¸ªæ¶ˆè´¹è€…ï¼Œæ¯ä¸€ä¸ªæ¶ˆè´¹è€…ç»„å¯è®¢é˜…å¤šä¸ªä¸»é¢˜ï¼Œæ¶ˆè´¹ç»„ä¹‹é—´æœ‰ffå¼å’Œå¹¿æ’­æ¨¡å¼ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ã€‚é›†ç¾¤æ¨¡å¼ï¼Œä¸»é¢˜ä¸‹çš„åŒä¸€æ¡æ¶ˆæ¯åªå…è®¸è¢«å…¶ä¸­ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚å¹¿æ’­æ¨¡å¼ï¼Œä¸»é¢˜ä¸‹çš„åŒä¸€æ¡æ¶ˆæ¯ï¼Œå°†è¢«é›†ç¾¤å†…çš„æ‰€æœ‰æ¶ˆè´¹è€…æ¶ˆè´¹ä¸€æ¬¡ã€‚æ¶ˆæ¯æœåŠ¡å™¨ä¸æ¶ˆè´¹è€…ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’ä¹Ÿæœ‰ä¸¤ç§æ¨¡å¼ï¼šæ¨æ¨¡å¼ã€æ‹‰æ¨¡å¼ã€‚æ‰€è°“çš„æ‹‰æ¨¡å¼ï¼Œæ˜¯æ¶ˆè´¹ç«¯ä¸»åŠ¨æ‹‰èµ·æ‹‰æ¶ˆæ¯è¯·æ±‚ï¼Œè€Œæ¨æ¨¡å¼æ˜¯æ¶ˆæ¯è¾¾åˆ°æ¶ˆæ¯æœåŠ¡å™¨åï¼Œæ¨é€ç»™æ¶ˆæ¯æ¶ˆè´¹è€…ã€‚RocketMQæ¶ˆæ¯æ¨æ¨¡å¼çš„å®ç°åŸºäºæ‹‰æ¨¡å¼ï¼Œåœ¨æ‹‰æ¨¡å¼ä¸ŠåŒ…è£…ä¸€å±‚ï¼Œä¸€ä¸ªæ‹‰å–ä»»åŠ¡å®Œæˆåå¼€å§‹ä¸‹ä¸€ä¸ªæ‹‰å–ä»»åŠ¡ã€‚

é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å¦‚ä½•å¯¹æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè´Ÿè½½å‘¢ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½æœºåˆ¶éµå¾ªä¸€ä¸ªé€šç”¨æ€æƒ³ï¼šä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—åŒä¸€ä¸ªæ—¶é—´åªå…è®¸è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚

RocketMQæ”¯æŒå±€éƒ¨é¡ºåºæ¶ˆæ¯æ¶ˆè´¹ï¼Œä¹Ÿå°±æ˜¯ä¿è¯åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯é¡ºåºæ¶ˆè´¹ã€‚ä¸æ”¯æŒæ¶ˆæ¯å…¨å±€é¡ºåºæ¶ˆè´¹ï¼Œå¦‚æœè¦å®ç°æŸä¸€ä¸ªä¸»é¢˜çš„å…¨å±€é¡ºåºæ¶ˆè´¹ï¼Œå¯ä»¥å°†è¯¥ä¸»é¢˜çš„é˜Ÿåˆ—æ•°è®¾ç½®ä¸º1ï¼Œç‰ºç‰²é«˜å¯ç”¨æ€§ã€‚

###æ¶ˆæ¯æ¶ˆè´¹åˆæ¢

**<u>æ¶ˆæ¯æ¨é€æ¨¡å¼</u>**

![](/assets/imgs/æ¶ˆæ¯æ¨é€.png)

**<u>æ¶ˆæ¯æ¶ˆè´¹é‡è¦æ–¹æ³•</u>**

```java
void sendMessageBack(final MessageExt msg, final int delayLevel, final String brokerName)ï¼šå‘é€æ¶ˆæ¯ç¡®è®¤
Set<MessageQueue> fetchSubscribeMessageQueues(final String topic) :è·å–æ¶ˆè´¹è€…å¯¹ä¸»é¢˜åˆ†é…äº†é‚£äº›æ¶ˆæ¯é˜Ÿåˆ—
void registerMessageListener(final MessageListenerConcurrently messageListener)ï¼šæ³¨å†Œå¹¶å‘äº‹ä»¶ç›‘å¬å™¨
void registerMessageListener(final MessageListenerOrderly messageListener)ï¼šæ³¨å†Œé¡ºåºæ¶ˆæ¯äº‹ä»¶ç›‘å¬å™¨
void subscribe(final String topic, final String subExpression)ï¼šåŸºäºä¸»é¢˜è®¢é˜…æ¶ˆæ¯ï¼Œæ¶ˆæ¯è¿‡æ»¤ä½¿ç”¨è¡¨è¾¾å¼
void subscribe(final String topic, final String fullClassName,final String filterClassSource)ï¼šåŸºäºä¸»é¢˜è®¢é˜…æ¶ˆæ¯ï¼Œæ¶ˆæ¯è¿‡æ»¤ä½¿ç”¨ç±»æ¨¡å¼
void subscribe(final String topic, final MessageSelector selector) ï¼šè®¢é˜…æ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šé˜Ÿåˆ—é€‰æ‹©å™¨
void unsubscribe(final String topic)ï¼šå–æ¶ˆæ¶ˆæ¯è®¢é˜…
```

**<u>DefaultMQPushConsumer</u>**

![](/assets/imgs/DefaultMQPushConsumer.png)

```java
//æ¶ˆè´¹è€…ç»„
private String consumerGroup;	
//æ¶ˆæ¯æ¶ˆè´¹æ¨¡å¼
private MessageModel messageModel = MessageModel.CLUSTERING;	
//æŒ‡å®šæ¶ˆè´¹å¼€å§‹åç§»é‡ï¼ˆæœ€å¤§åç§»é‡ã€æœ€å°åç§»é‡ã€å¯åŠ¨æ—¶é—´æˆ³ï¼‰å¼€å§‹æ¶ˆè´¹
private ConsumeFromWhere consumeFromWhere = ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET;
//é›†ç¾¤æ¨¡å¼ä¸‹çš„æ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½ç­–ç•¥
private AllocateMessageQueueStrategy allocateMessageQueueStrategy;
//è®¢é˜…ä¿¡æ¯
private Map<String /* topic */, String /* sub expression */> subscription = new HashMap<String, String>();
//æ¶ˆæ¯ä¸šåŠ¡ç›‘å¬å™¨
private MessageListener messageListener;
//æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦å­˜å‚¨å™¨
private OffsetStore offsetStore;
//æ¶ˆè´¹è€…æœ€å°çº¿ç¨‹æ•°é‡
private int consumeThreadMin = 20;
//æ¶ˆè´¹è€…æœ€å¤§çº¿ç¨‹æ•°é‡
private int consumeThreadMax = 20;
//å¹¶å‘æ¶ˆæ¯æ¶ˆè´¹æ—¶å¤„ç†é˜Ÿåˆ—æœ€å¤§è·¨åº¦
private int consumeConcurrentlyMaxSpan = 2000;
//æ¯1000æ¬¡æµæ§åæ‰“å°æµæ§æ—¥å¿—
private int pullThresholdForQueue = 1000;
//æ¨æ¨¡å¼ä¸‹ä»»åŠ¡é—´éš”æ—¶é—´
private long pullInterval = 0;
//æ¨æ¨¡å¼ä¸‹ä»»åŠ¡æ‹‰å–çš„æ¡æ•°,é»˜è®¤32æ¡
private int pullBatchSize = 32;
//æ¯æ¬¡ä¼ å…¥MessageListener#consumerMessageä¸­æ¶ˆæ¯çš„æ•°é‡
private int consumeMessageBatchMaxSize = 1;
//æ˜¯å¦æ¯æ¬¡æ‹‰å–æ¶ˆæ¯éƒ½è®¢é˜…æ¶ˆæ¯
private boolean postSubscriptionWhenPull = false;
//æ¶ˆæ¯é‡è¯•æ¬¡æ•°,-1ä»£è¡¨16æ¬¡
private int maxReconsumeTimes = -1;
//æ¶ˆæ¯æ¶ˆè´¹è¶…æ—¶æ—¶é—´
private long consumeTimeout = 15;
```

### æ¶ˆè´¹è€…å¯åŠ¨æµç¨‹

![](/assets/imgs/æ¶ˆæ¯æ¶ˆè´¹å¯åŠ¨æµç¨‹.png)

***ä»£ç ï¼šDefaultMQPushConsumerImpl#start***

```java
public synchronized void start() throws MQClientException {
    switch (this.serviceState) {
        case CREATE_JUST:
            
                this.defaultMQPushConsumer.getMessageModel(), this.defaultMQPushConsumer.isUnitMode());
            this.serviceState = ServiceState.START_FAILED;
			//æ£€æŸ¥æ¶ˆæ¯è€…æ˜¯å¦åˆæ³•
            this.checkConfig();
			//æ„å»ºä¸»é¢˜è®¢é˜…ä¿¡æ¯
            this.copySubscription();
			//è®¾ç½®æ¶ˆè´¹è€…å®¢æˆ·ç«¯å®ä¾‹åç§°ä¸ºè¿›ç¨‹ID
            if (this.defaultMQPushConsumer.getMessageModel() == MessageModel.CLUSTERING) {
                this.defaultMQPushConsumer.changeInstanceNameToPID();
            }
			//åˆ›å»ºMQClientå®ä¾‹
            this.mQClientFactory = MQClientManager.getInstance().getAndCreateMQClientInstance(this.defaultMQPushConsumer, this.rpcHook);
			//æ„å»ºrebalanceImpl
            this.rebalanceImpl.setConsumerGroup(this.defaultMQPushConsumer.getConsumerGroup());
            this.rebalanceImpl.setMessageModel(this.defaultMQPushConsumer.getMessageModel());
            this.rebalanceImpl.setAllocateMessageQueueStrategy(this.defaultMQPushConsumer.getAllocateMessageQueueStrategy());
            this.rebalanceImpl.setmQClientFactory(this.mQClientFactor
            this.pullAPIWrapper = new PullAPIWrapper(
                mQClientFactory,
                this.defaultMQPushConsumer.getConsumerGroup(), isUnitMode());
            this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookLis
            if (this.defaultMQPushConsumer.getOffsetStore() != null) {
                this.offsetStore = this.defaultMQPushConsumer.getOffsetStore();
            } else {
           		switch (this.defaultMQPushConsumer.getMessageModel()) {
               
           	    case BROADCASTING:	 //æ¶ˆæ¯æ¶ˆè´¹å¹¿æ’­æ¨¡å¼,å°†æ¶ˆè´¹è¿›åº¦ä¿å­˜åœ¨æœ¬åœ°
           	        this.offsetStore = new LocalFileOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());
           	            break;
           	        case CLUSTERING:	//æ¶ˆæ¯æ¶ˆè´¹é›†ç¾¤æ¨¡å¼,å°†æ¶ˆè´¹è¿›åº¦ä¿å­˜åœ¨è¿œç«¯Broker
           	            this.offsetStore = new RemoteBrokerOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());
           	            break;
           	        default:
           	            break;
           	    }
           	    this.defaultMQPushConsumer.setOffsetStore(this.offsetStore);
           	}
            this.offsetStore.load
            //åˆ›å»ºé¡ºåºæ¶ˆæ¯æ¶ˆè´¹æœåŠ¡
            if (this.getMessageListenerInner() instanceof MessageListenerOrderly) {
                this.consumeOrderly = true;
                this.consumeMessageService =
                    new ConsumeMessageOrderlyService(this, (MessageListenerOrderly) this.getMessageListenerInner());
                //åˆ›å»ºå¹¶å‘æ¶ˆæ¯æ¶ˆè´¹æœåŠ¡
            } else if (this.getMessageListenerInner() instanceof MessageListenerConcurrently) {
                this.consumeOrderly = false;
                this.consumeMessageService =
                    new ConsumeMessageConcurrentlyService(this, (MessageListenerConcurrently) this.getMessageListenerInner());
            }
            //æ¶ˆæ¯æ¶ˆè´¹æœåŠ¡å¯åŠ¨
            this.consumeMessageService.start();
            //æ³¨å†Œæ¶ˆè´¹è€…å®ä¾‹
            boolean registerOK = mQClientFactory.registerConsumer(this.defaultMQPushConsumer.getConsumerGroup(), this);
            
            if (!registerOK) {
                this.serviceState = ServiceState.CREATE_JUST;
                this.consumeMessageService.shutdown();
                throw new MQClientException("The consumer group[" + this.defaultMQPushConsumer.getConsumerGroup()
                    + "] has been created before, specify another name please." + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),
                    null);
            //å¯åŠ¨æ¶ˆè´¹è€…å®¢æˆ·ç«¯
            mQClientFactory.start();
            log.info("the consumer [{}] start OK.", this.defaultMQPushConsumer.getConsumerGroup());
            this.serviceState = ServiceState.RUNNING;
            break;
            case RUNNING:
            case START_FAILED:
        case SHUTDOWN_ALREADY:
            throw new MQClientException("The PushConsumer service state not OK, maybe started once, "
                + this.serviceState
                + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),
                null);
        default:
            break;
    }

    this.updateTopicSubscribeInfoWhenSubscriptionChanged();
    this.mQClientFactory.checkClientInBroker();
    this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();
    this.mQClientFactory.rebalanceImmediately();
}
```

### æ¶ˆæ¯æ‹‰å–

æ¶ˆæ¯æ¶ˆè´¹æ¨¡å¼æœ‰ä¸¤ç§æ¨¡å¼ï¼šå¹¿æ’­æ¨¡å¼ä¸é›†ç¾¤æ¨¡å¼ã€‚å¹¿æ’­æ¨¡å¼æ¯”è¾ƒç®€å•ï¼Œæ¯ä¸€ä¸ªæ¶ˆè´¹è€…éœ€è¦æ‹‰å–è®¢é˜…ä¸»é¢˜ä¸‹æ‰€æœ‰é˜Ÿåˆ—çš„æ¶ˆæ¯ã€‚æœ¬æ–‡é‡ç‚¹è®²è§£é›†ç¾¤æ¨¡å¼ã€‚åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼ŒåŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„å†…æœ‰å¤šä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…ï¼ŒåŒä¸€ä¸ªä¸»é¢˜å­˜åœ¨å¤šä¸ªæ¶ˆè´¹é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…é€šè¿‡è´Ÿè½½å‡è¡¡çš„æ–¹å¼æ¶ˆè´¹æ¶ˆæ¯ã€‚

æ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡ï¼Œé€šå¸¸çš„ä½œæ³•æ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—åœ¨åŒä¸€ä¸ªæ—¶é—´åªå…è®¸è¢«ä¸€ä¸ªæ¶ˆè´¹æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…å¯ä»¥åŒæ—¶æ¶ˆè´¹å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚

#### PullMessageServiceå®ç°æœºåˆ¶

ä»MQClientInstanceçš„å¯åŠ¨æµç¨‹ä¸­å¯ä»¥çœ‹å‡ºï¼ŒRocketMQä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹PullMessageServiceæ¥è´Ÿè´£æ¶ˆæ¯çš„æ‹‰å–ã€‚

![](/assets/imgs/pullMessageServiceå®ç°æœºåˆ¶.png)

***ä»£ç ï¼šPullMessageService#run***

```java
public void run() {
    log.info(this.getServiceName() + " service started");
	//å¾ªç¯æ‹‰å–æ¶ˆæ¯
    while (!this.isStopped()) {
        try {
            //ä»è¯·æ±‚é˜Ÿåˆ—ä¸­è·å–æ‹‰å–æ¶ˆæ¯è¯·æ±‚
            PullRequest pullRequest = this.pullRequestQueue.take();
            //æ‹‰å–æ¶ˆæ¯
            this.pullMessage(pullRequest);
        } catch (InterruptedException ignored) {
        } catch (Exception e) {
            log.error("Pull Message Service Run Method exception", e);
        }
    }

    log.info(this.getServiceName() + " service end");
}
```

<u>**PullRequest**</u>

![](/assets/imgs/PullRequest.png)

```java
private String consumerGroup;	//æ¶ˆè´¹è€…ç»„
private MessageQueue messageQueue;	//å¾…æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—
private ProcessQueue processQueue;	//æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
private long nextOffset;	//å¾…æ‹‰å–çš„MessageQueueåç§»é‡
private boolean lockedFirst = false;	//æ˜¯å¦è¢«é”å®š
```

***ä»£ç ï¼šPullMessageService#pullMessage***

```java
private void pullMessage(final PullRequest pullRequest) {
    //è·å¾—æ¶ˆè´¹è€…å®ä¾‹
    final MQConsumerInner consumer = this.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());
    if (consumer != null) {
        //å¼ºè½¬ä¸ºæ¨é€æ¨¡å¼æ¶ˆè´¹è€…
        DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;
        //æ¨é€æ¶ˆæ¯
        impl.pullMessage(pullRequest);
    } else {
        log.warn("No matched consumer for the PullRequest {}, drop it", pullRequest);
    }
}
```

####ProcessQueueå®ç°æœºåˆ¶

ProcessQueueæ˜¯MessageQueueåœ¨æ¶ˆè´¹ç«¯çš„é‡ç°ã€å¿«ç…§ã€‚PullMessageServiceä»æ¶ˆæ¯æœåŠ¡å™¨é»˜è®¤æ¯æ¬¡æ‹‰å–32æ¡æ¶ˆæ¯ï¼ŒæŒ‰ç…§æ¶ˆæ¯çš„é˜Ÿåˆ—åç§»é‡é¡ºåºå­˜æ”¾åœ¨ProcessQueueä¸­ï¼ŒPullMessageServiceç„¶åå°†æ¶ˆæ¯æäº¤åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹çº¿ç¨‹æ± ï¼Œæ¶ˆæ¯æˆåŠŸæ¶ˆè´¹åä»ProcessQueueä¸­ç§»é™¤ã€‚

![](/assets/imgs/ProcessQueue.png)

**<u>å±æ€§</u>**

```java
//æ¶ˆæ¯å®¹å™¨
private final TreeMap<Long, MessageExt> msgTreeMap = new TreeMap<Long, MessageExt>();
//è¯»å†™é”
private final ReadWriteLock lockTreeMap = new ReentrantReadWriteLock();
//ProcessQueueæ€»æ¶ˆæ¯æ ‘
private final AtomicLong msgCount = new AtomicLong();
//ProcessQueueé˜Ÿåˆ—æœ€å¤§åç§»é‡
private volatile long queueOffsetMax = 0L;
//å½“å‰ProcessQueueæ˜¯å¦è¢«ä¸¢å¼ƒ
private volatile boolean dropped = false;
//ä¸Šä¸€æ¬¡æ‹‰å–æ—¶é—´æˆ³
private volatile long lastPullTimestamp = System.currentTimeMillis();
//ä¸Šä¸€æ¬¡æ¶ˆè´¹æ—¶é—´æˆ³
private volatile long lastConsumeTimestamp = System.currentTimeMillis();
```

**<u>æ–¹æ³•</u>**

```java
//ç§»é™¤æ¶ˆè´¹è¶…æ—¶æ¶ˆæ¯
public void cleanExpiredMsg(DefaultMQPushConsumer pushConsumer)
//æ·»åŠ æ¶ˆæ¯
public boolean putMessage(final List<MessageExt> msgs)
//è·å–æ¶ˆæ¯æœ€å¤§é—´éš”
public long getMaxSpan()
//ç§»é™¤æ¶ˆæ¯
public long removeMessage(final List<MessageExt> msgs)
//å°†consumingMsgOrderlyTreeMapä¸­æ¶ˆæ¯é‡æ–°æ”¾åœ¨msgTreeMap,å¹¶æ¸…ç©ºconsumingMsgOrderlyTreeMap   
public void rollback() 
//å°†consumingMsgOrderlyTreeMapæ¶ˆæ¯æ¸…é™¤,è¡¨ç¤ºæˆåŠŸå¤„ç†è¯¥æ‰¹æ¶ˆæ¯
public long commit()
//é‡æ–°å¤„ç†è¯¥æ‰¹æ¶ˆæ¯
public void makeMessageToCosumeAgain(List<MessageExt> msgs) 
//ä»processQueueä¸­å–å‡ºbatchSizeæ¡æ¶ˆæ¯
public List<MessageExt> takeMessags(final int batchSize)
```

#### æ¶ˆæ¯æ‹‰å–åŸºæœ¬æµç¨‹

#####1.å®¢æˆ·ç«¯å‘èµ·æ‹‰å–è¯·æ±‚

![](/assets/imgs/æ¶ˆæ¯æ‹‰å–åŸºæœ¬æµç¨‹.png)

***ä»£ç ï¼šDefaultMQPushConsumerImpl#pullMessage***

```java
public void pullMessage(final PullRequest pullRequest) {
    //ä»pullRequestè·å¾—ProcessQueue
    final ProcessQueue processQueue = pullRequest.getProcessQueue();
    //å¦‚æœå¤„ç†é˜Ÿåˆ—è¢«ä¸¢å¼ƒ,ç›´æ¥è¿”å›
    if (processQueue.isDropped()) {
        log.info("the pull request[{}] is dropped.", pullRequest.toString());
        return;
    }
	//å¦‚æœå¤„ç†é˜Ÿåˆ—æœªè¢«ä¸¢å¼ƒ,æ›´æ–°æ—¶é—´æˆ³
    pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());

    try {
        this.makeSureStateOK();
    } catch (MQClientException e) {
        log.warn("pullMessage exception, consumer state not ok", e);
        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);
        return;
    }
	//å¦‚æœå¤„ç†é˜Ÿåˆ—è¢«æŒ‚èµ·,å»¶è¿Ÿ1såå†æ‰§è¡Œ
    if (this.isPause()) {
        log.warn("consumer was paused, execute pull request later. instanceName={}, group={}", this.defaultMQPushConsumer.getInstanceName(), this.defaultMQPushConsumer.getConsumerGroup());
        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);
        return;
    }
	//è·å¾—æœ€å¤§å¾…å¤„ç†æ¶ˆæ¯æ•°é‡
	long cachedMessageCount = processQueue.getMsgCount().get();
    //è·å¾—æœ€å¤§å¾…å¤„ç†æ¶ˆæ¯å¤§å°
	long cachedMessageSizeInMiB = processQueue.getMsgSize().get() / (1024 * 1024);
	//ä»æ•°é‡è¿›è¡Œæµæ§
	if (cachedMessageCount > this.defaultMQPushConsumer.getPullThresholdForQueue()) {
	    this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);
	    if ((queueFlowControlTimes++ % 1000) == 0) {
	        log.warn(
	            "the cached message count exceeds the threshold {}, so do flow control, minOffset={}, maxOffset={}, count={}, size={} MiB, pullRequest={}, flowControlTimes={}",
	            this.defaultMQPushConsumer.getPullThresholdForQueue(), processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), cachedMessageCount, cachedMessageSizeInMiB, pullRequest, queueFlowControlTimes);
	    }
	    return;
	}
	//ä»æ¶ˆæ¯å¤§å°è¿›è¡Œæµæ§
	if (cachedMessageSizeInMiB > this.defaultMQPushConsumer.getPullThresholdSizeForQueue()) {
	    this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);
	    if ((queueFlowControlTimes++ % 1000) == 0) {
	        log.warn(
	            "the cached message size exceeds the threshold {} MiB, so do flow control, minOffset={}, maxOffset={}, count={}, size={} MiB, pullRequest={}, flowControlTimes={}",
	            this.defaultMQPushConsumer.getPullThresholdSizeForQueue(), processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), cachedMessageCount, cachedMessageSizeInMiB, pullRequest, queueFlowControlTimes);
	    }
	    return;
    }
    	//è·å¾—è®¢é˜…ä¿¡æ¯
		 final SubscriptionData subscriptionData = this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());
    	if (null == subscriptionData) {
    	    this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);
    	    log.warn("find the consumer's subscription failed, {}", pullRequest);
    	    return;
		//ä¸æœåŠ¡ç«¯äº¤äº’,è·å–æ¶ˆæ¯
	    this.pullAPIWrapper.pullKernelImpl(
	    pullRequest.getMessageQueue(),
	    subExpression,
	    subscriptionData.getExpressionType(),
	    subscriptionData.getSubVersion(),
	    pullRequest.getNextOffset(),
	    this.defaultMQPushConsumer.getPullBatchSize(),
	    sysFlag,
	    commitOffsetValue,
	    BROKER_SUSPEND_MAX_TIME_MILLIS,
	    CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND,
	    CommunicationMode.ASYNC,
	    pullCallback
	);
            
}
```

#####2.æ¶ˆæ¯æœåŠ¡ç«¯Brokerç»„è£…æ¶ˆæ¯

![](/assets/imgs/æ¶ˆæ¯æœåŠ¡ç«¯Brokerç»„è£…æ¶ˆæ¯.png)

***ä»£ç ï¼šPullMessageProcessor#processRequest***

```java
//æ„å»ºæ¶ˆæ¯è¿‡æ»¤å™¨
MessageFilter messageFilter;
if (this.brokerController.getBrokerConfig().isFilterSupportRetry()) {
    messageFilter = new ExpressionForRetryMessageFilter(subscriptionData, consumerFilterData,
        this.brokerController.getConsumerFilterManager());
} else {
    messageFilter = new ExpressionMessageFilter(subscriptionData, consumerFilterData,
        this.brokerController.getConsumerFilterManager());
}
//è°ƒç”¨MessageStore.getMessageæŸ¥æ‰¾æ¶ˆæ¯
final GetMessageResult getMessageResult =
    this.brokerController.getMessageStore().getMessage(
    				requestHeader.getConsumerGroup(), //æ¶ˆè´¹ç»„åç§°								
    				requestHeader.getTopic(),	//ä¸»é¢˜åç§°
        			requestHeader.getQueueId(), //é˜Ÿåˆ—ID
    				requestHeader.getQueueOffset(), 	//å¾…æ‹‰å–åç§»é‡
    				requestHeader.getMaxMsgNums(), 	//æœ€å¤§æ‹‰å–æ¶ˆæ¯æ¡æ•°
    				messageFilter	//æ¶ˆæ¯è¿‡æ»¤å™¨
    		);
```

***ä»£ç ï¼šDefaultMessageStore#getMessage***

```java
GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;
long nextBeginOffset = offset;	//æŸ¥æ‰¾ä¸‹ä¸€æ¬¡é˜Ÿåˆ—åç§»é‡
long minOffset = 0;		//å½“å‰æ¶ˆæ¯é˜Ÿåˆ—æœ€å°åç§»é‡
long maxOffset = 0;		//å½“å‰æ¶ˆæ¯é˜Ÿåˆ—æœ€å¤§åç§»é‡
GetMessageResult getResult = new GetMessageResult();
final long maxOffsetPy = this.commitLog.getMaxOffset();	//å½“å‰commitLogæœ€å¤§åç§»é‡
//æ ¹æ®ä¸»é¢˜åç§°å’Œé˜Ÿåˆ—ç¼–å·è·å–æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—
ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId);

...
minOffset = consumeQueue.getMinOffsetInQueue();
maxOffset = consumeQueue.getMaxOffsetInQueue();
//æ¶ˆæ¯åç§»é‡å¼‚å¸¸æƒ…å†µæ ¡å¯¹ä¸‹ä¸€æ¬¡æ‹‰å–åç§»é‡
if (maxOffset == 0) {	//è¡¨ç¤ºå½“å‰æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯
    status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;
    nextBeginOffset = nextOffsetCorrection(offset, 0);
} else if (offset < minOffset) {	//å¾…æ‹‰å–æ¶ˆæ¯çš„åç§»é‡å°äºé˜Ÿåˆ—çš„å…¶å®åç§»é‡
    status = GetMessageStatus.OFFSET_TOO_SMALL;
    nextBeginOffset = nextOffsetCorrection(offset, minOffset);
} else if (offset == maxOffset) {	//å¾…æ‹‰å–åç§»é‡ä¸ºé˜Ÿåˆ—æœ€å¤§åç§»é‡
    status = GetMessageStatus.OFFSET_OVERFLOW_ONE;
    nextBeginOffset = nextOffsetCorrection(offset, offset);
} else if (offset > maxOffset) {	//åç§»é‡è¶Šç•Œ
    status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;
    if (0 == minOffset) {
        nextBeginOffset = nextOffsetCorrection(offset, minOffset);
    } else {
        nextBeginOffset = nextOffsetCorrection(offset, maxOffset);
    }
}
...
//æ ¹æ®åç§»é‡ä»CommitLogä¸­æ‹‰å–32æ¡æ¶ˆæ¯
SelectMappedBufferResult selectResult = this.commitLog.getMessage(offsetPy, sizePy);
```

***ä»£ç ï¼šPullMessageProcessor#processRequest***

```java
//æ ¹æ®æ‹‰å–ç»“æœå¡«å……responseHeader
response.setRemark(getMessageResult.getStatus().name());
responseHeader.setNextBeginOffset(getMessageResult.getNextBeginOffset());
responseHeader.setMinOffset(getMessageResult.getMinOffset());
responseHeader.setMaxOffset(getMessageResult.getMaxOffset());

//åˆ¤æ–­å¦‚æœå­˜åœ¨ä¸»ä»åŒæ­¥æ…¢,è®¾ç½®ä¸‹ä¸€æ¬¡æ‹‰å–ä»»åŠ¡çš„IDä¸ºä¸»èŠ‚ç‚¹
switch (this.brokerController.getMessageStoreConfig().getBrokerRole()) {
    case ASYNC_MASTER:
    case SYNC_MASTER:
        break;
    case SLAVE:
        if (!this.brokerController.getBrokerConfig().isSlaveReadEnable()) {
            response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);
            responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);
        }
        break;
}
...
//GetMessageResultä¸Responseçš„Codeè½¬æ¢
switch (getMessageResult.getStatus()) {
    case FOUND:			//æˆåŠŸ
        response.setCode(ResponseCode.SUCCESS);
        break;
    case MESSAGE_WAS_REMOVING:	//æ¶ˆæ¯å­˜æ”¾åœ¨ä¸‹ä¸€ä¸ªcommitLogä¸­
        response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);	//æ¶ˆæ¯é‡è¯•
        break;
    case NO_MATCHED_LOGIC_QUEUE:	//æœªæ‰¾åˆ°é˜Ÿåˆ—
    case NO_MESSAGE_IN_QUEUE:	//é˜Ÿåˆ—ä¸­æœªåŒ…å«æ¶ˆæ¯
        if (0 != requestHeader.getQueueOffset()) {
            response.setCode(ResponseCode.PULL_OFFSET_MOVED);
            requestHeader.getQueueOffset(),
            getMessageResult.getNextBeginOffset(),
            requestHeader.getTopic(),
            requestHeader.getQueueId(),
            requestHeader.getConsumerGroup()
            );
        } else {
            response.setCode(ResponseCode.PULL_NOT_FOUND);
        }
        break;
    case NO_MATCHED_MESSAGE:	//æœªæ‰¾åˆ°æ¶ˆæ¯
        response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);
        break;
    case OFFSET_FOUND_NULL:	//æ¶ˆæ¯ç‰©ç†åç§»é‡ä¸ºç©º
        response.setCode(ResponseCode.PULL_NOT_FOUND);
        break;
    case OFFSET_OVERFLOW_BADLY:	//offsetè¶Šç•Œ
        response.setCode(ResponseCode.PULL_OFFSET_MOVED);
        // XXX: warn and notify me
        log.info("the request offset: {} over flow badly, broker max offset: {}, consumer: {}",
                requestHeader.getQueueOffset(), getMessageResult.getMaxOffset(), channel.remoteAddress());
        break;
    case OFFSET_OVERFLOW_ONE:	//offsetåœ¨é˜Ÿåˆ—ä¸­æœªæ‰¾åˆ°
        response.setCode(ResponseCode.PULL_NOT_FOUND);
        break;
    case OFFSET_TOO_SMALL:	//offsetæœªåœ¨é˜Ÿåˆ—ä¸­
        response.setCode(ResponseCode.PULL_OFFSET_MOVED);
        requestHeader.getConsumerGroup(), 
        requestHeader.getTopic(), 
        requestHeader.getQueueOffset(),
        getMessageResult.getMinOffset(), channel.remoteAddress());
        break;
    default:
        assert false;
        break;
}
...
//å¦‚æœCommitLogæ ‡è®°å¯ç”¨,å¹¶ä¸”å½“å‰Brokerä¸ºä¸»èŠ‚ç‚¹,åˆ™æ›´æ–°æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦
boolean storeOffsetEnable = brokerAllowSuspend;
storeOffsetEnable = storeOffsetEnable && hasCommitOffsetFlag;
storeOffsetEnable = storeOffsetEnable
    && this.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE;
if (storeOffsetEnable) {
    this.brokerController.getConsumerOffsetManager().commitOffset(RemotingHelper.parseChannelRemoteAddr(channel),
        requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId(), requestHeader.getCommitOffset());
}
```

#####3.æ¶ˆæ¯æ‹‰å–å®¢æˆ·ç«¯å¤„ç†æ¶ˆæ¯

![](/assets/imgs/æ¶ˆæ¯æ‹‰å–å®¢æˆ·ç«¯å¤„ç†æ¶ˆæ¯.png)

***ä»£ç ï¼šMQClientAPIImpl#processPullResponse***

```java
private PullResult processPullResponse(
    final RemotingCommand response) throws MQBrokerException, RemotingCommandException {
    PullStatus pullStatus = PullStatus.NO_NEW_MSG;
   	//åˆ¤æ–­å“åº”ç»“æœ
    switch (response.getCode()) {
        case ResponseCode.SUCCESS:
            pullStatus = PullStatus.FOUND;
            break;
        case ResponseCode.PULL_NOT_FOUND:
            pullStatus = PullStatus.NO_NEW_MSG;
            break;
        case ResponseCode.PULL_RETRY_IMMEDIATELY:
            pullStatus = PullStatus.NO_MATCHED_MSG;
            break;
        case ResponseCode.PULL_OFFSET_MOVED:
            pullStatus = PullStatus.OFFSET_ILLEGAL;
            break;

        default:
            throw new MQBrokerException(response.getCode(), response.getRemark());
    }
	//è§£ç å“åº”å¤´
    PullMessageResponseHeader responseHeader =
        (PullMessageResponseHeader) response.decodeCommandCustomHeader(PullMessageResponseHeader.class);
	//å°è£…PullResultExtè¿”å›
    return new PullResultExt(pullStatus, responseHeader.getNextBeginOffset(), responseHeader.getMinOffset(),
        responseHeader.getMaxOffset(), null, responseHeader.getSuggestWhichBrokerId(), response.getBody());
}
```

<u>**PullResultç±»**</u>

```java
private final PullStatus pullStatus;	//æ‹‰å–ç»“æœ
private final long nextBeginOffset;	//ä¸‹æ¬¡æ‹‰å–åç§»é‡
private final long minOffset;	//æ¶ˆæ¯é˜Ÿåˆ—æœ€å°åç§»é‡
private final long maxOffset;	//æ¶ˆæ¯é˜Ÿåˆ—æœ€å¤§åç§»é‡
private List<MessageExt> msgFoundList;	//æ‹‰å–çš„æ¶ˆæ¯åˆ—è¡¨
```

![](/assets/imgs/PullStatus.png)

***ä»£ç ï¼šDefaultMQPushConsumerImpl$PullCallback#OnSuccess***

```java
//å°†æ‹‰å–åˆ°çš„æ¶ˆæ¯å­˜å…¥processQueue
boolean dispatchToConsume = processQueue.putMessage(pullResult.getMsgFoundList());
//å°†processQueueæäº¤åˆ°consumeMessageServiceä¸­ä¾›æ¶ˆè´¹è€…æ¶ˆè´¹
DefaultMQPushConsumerImpl.this.consumeMessageService.submitConsumeRequest(
    pullResult.getMsgFoundList(),
    processQueue,
    pullRequest.getMessageQueue(),
    dispatchToConsume);
//å¦‚æœpullIntervalå¤§äº0,åˆ™ç­‰å¾…pullIntervalæ¯«ç§’åå°†pullRequestå¯¹è±¡æ”¾å…¥åˆ°PullMessageServiceä¸­çš„pullRequestQueueé˜Ÿåˆ—ä¸­
if (DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval() > 0) {
    DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest,
        DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval());
} else {
    DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);
}
```

##### 4.æ¶ˆæ¯æ‹‰å–æ€»ç»“

![](/assets/imgs/æ¶ˆæ¯æ‹‰å–æµç¨‹æ€»ç»“.png)

#### æ¶ˆæ¯æ‹‰å–é•¿è½®è¯¢æœºåˆ¶åˆ†æ

RocketMQæœªçœŸæ­£å®ç°æ¶ˆæ¯æ¨æ¨¡å¼ï¼Œè€Œæ˜¯æ¶ˆè´¹è€…ä¸»åŠ¨å‘æ¶ˆæ¯æœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯ï¼ŒRocketMQæ¨æ¨¡å¼æ˜¯å¾ªç¯å‘æ¶ˆæ¯æœåŠ¡ç«¯å‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚ï¼Œå¦‚æœæ¶ˆæ¯æ¶ˆè´¹è€…å‘RocketMQæ‹‰å–æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯æœªåˆ°è¾¾æ¶ˆè´¹é˜Ÿåˆ—æ—¶ï¼Œå¦‚æœä¸å¯ç”¨é•¿è½®è¯¢æœºåˆ¶ï¼Œåˆ™ä¼šåœ¨æœåŠ¡ç«¯ç­‰å¾…shortPollingTimeMillsæ—¶é—´åï¼ˆæŒ‚èµ·ï¼‰å†å»åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å·²ç»åˆ°è¾¾æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚æœæ¶ˆæ¯ä»æœªåˆ°è¾¾åˆ™æç¤ºæ‹‰å–æ¶ˆæ¯å®¢æˆ·ç«¯PULLâ€”NOTâ€”FOUNDï¼ˆæ¶ˆæ¯ä¸å­˜åœ¨ï¼‰ï¼›å¦‚æœå¼€å¯é•¿è½®è¯¢æ¨¡å¼ï¼ŒRocketMQä¸€æ–¹é¢ä¼šæ¯éš”5sè½®è¯¢æ£€æŸ¥ä¸€æ¬¡æ¶ˆæ¯æ˜¯å¦å¯è¾¾ï¼ŒåŒæ—¶ä¸€æœ‰æ¶ˆæ¯è¾¾åˆ°åç«‹é©¬é€šçŸ¥æŒ‚èµ·çº¿ç¨‹å†æ¬¡éªŒè¯æ¶ˆæ¯æ˜¯å¦æ˜¯è‡ªå·±æ„Ÿå…´è¶£çš„æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯åˆ™ä»CommitLogæ–‡ä»¶ä¸­æå–æ¶ˆæ¯è¿”å›ç»™æ¶ˆæ¯æ‹‰å–å®¢æˆ·ç«¯ï¼Œå¦åˆ™ç›´åˆ°æŒ‚èµ·è¶…æ—¶ï¼Œè¶…æ—¶æ—¶é—´ç”±æ¶ˆæ¯æ‹‰å–æ–¹åœ¨æ¶ˆæ¯æ‹‰å–æ˜¯å°è£…åœ¨è¯·æ±‚å‚æ•°ä¸­ï¼ŒPUSHæ¨¡å¼ä¸º15sï¼ŒPULLæ¨¡å¼é€šè¿‡DefaultMQPullConsumer#setBrokerSuspendMaxTimeMillisè®¾ç½®ã€‚RocketMQé€šè¿‡åœ¨Brokerå®¢æˆ·ç«¯é…ç½®longPollingEnableä¸ºtrueæ¥å¼€å¯é•¿è½®è¯¢æ¨¡å¼ã€‚

***ä»£ç ï¼šPullMessageProcessor#processRequest***

```java
//å½“æ²¡æœ‰æ‹‰å–åˆ°æ¶ˆæ¯æ—¶ï¼Œé€šè¿‡é•¿è½®è¯¢æ–¹å¼ç»§ç»­æ‹‰å–æ¶ˆæ¯
case ResponseCode.PULL_NOT_FOUND:
    if (brokerAllowSuspend && hasSuspendFlag) {
        long pollingTimeMills = suspendTimeoutMillisLong;
        if (!this.brokerController.getBrokerConfig().isLongPollingEnable()) {
            pollingTimeMills = this.brokerController.getBrokerConfig().getShortPollingTimeMills();
        }

        String topic = requestHeader.getTopic();
        long offset = requestHeader.getQueueOffset();
        int queueId = requestHeader.getQueueId();
        //æ„å»ºæ‹‰å–è¯·æ±‚å¯¹è±¡
        PullRequest pullRequest = new PullRequest(request, channel, pollingTimeMills,
            this.brokerController.getMessageStore().now(), offset, subscriptionData, messageFilter);
        //å¤„ç†æ‹‰å–è¯·æ±‚
        this.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);
        response = null;
        break;
    }
```

**<u>PullRequestHoldServiceæ–¹å¼å®ç°é•¿è½®è¯¢</u>**

***ä»£ç ï¼šPullRequestHoldService#suspendPullRequest***

```java
//å°†æ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼Œæ”¾ç½®åœ¨ManyPullRequesté›†åˆä¸­
public void suspendPullRequest(final String topic, final int queueId, final PullRequest pullRequest) {
    String key = this.buildKey(topic, queueId);
    ManyPullRequest mpr = this.pullRequestTable.get(key);
    if (null == mpr) {
        mpr = new ManyPullRequest();
        ManyPullRequest prev = this.pullRequestTable.putIfAbsent(key, mpr);
        if (prev != null) {
            mpr = prev;
        }
    }

    mpr.addPullRequest(pullRequest);
}
```

***ä»£ç ï¼šPullRequestHoldService#run***

```java
public void run() {
    log.info("{} service started", this.getServiceName());
    while (!this.isStopped()) {
        try {
            //å¦‚æœå¼€å¯é•¿è½®è¯¢æ¯éš”5ç§’åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾
            if (this.brokerController.getBrokerConfig().isLongPollingEnable()) {
                this.waitForRunning(5 * 1000);
            } else {
                //æ²¡æœ‰å¼€å¯é•¿è½®è¯¢,æ¯éš”1så†æ¬¡å°è¯•
              this.waitForRunning(this.brokerController.getBrokerConfig().getShortPollingTimeMills());
            }

            long beginLockTimestamp = this.systemClock.now();
            this.checkHoldRequest();
            long costTime = this.systemClock.now() - beginLockTimestamp;
            if (costTime > 5 * 1000) {
                log.info("[NOTIFYME] check hold request cost {} ms.", costTime);
            }
        } catch (Throwable e) {
            log.warn(this.getServiceName() + " service has exception. ", e);
        }
    }

    log.info("{} service end", this.getServiceName());
}
```

***ä»£ç ï¼šPullRequestHoldService#checkHoldRequest***

```java
//éå†æ‹‰å–ä»»åŠ¡
private void checkHoldRequest() {
    for (String key : this.pullRequestTable.keySet()) {
        String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR);
        if (2 == kArray.length) {
            String topic = kArray[0];
            int queueId = Integer.parseInt(kArray[1]);
            //è·å¾—æ¶ˆæ¯åç§»é‡
            final long offset = this.brokerController.getMessageStore().getMaxOffsetInQueue(topic, queueId);
            try {
                //é€šçŸ¥æœ‰æ¶ˆæ¯è¾¾åˆ°
                this.notifyMessageArriving(topic, queueId, offset);
            } catch (Throwable e) {
                log.error("check hold request failed. topic={}, queueId={}", topic, queueId, e);
            }
        }
    }
}
```

***ä»£ç ï¼šPullRequestHoldService#notifyMessageArriving***

```java
//å¦‚æœæ‹‰å–æ¶ˆæ¯åç§»å¤§äºè¯·æ±‚åç§»é‡,å¦‚æœæ¶ˆæ¯åŒ¹é…è°ƒç”¨executeRequestWhenWakeupå¤„ç†æ¶ˆæ¯
if (newestOffset > request.getPullFromThisOffset()) {
    boolean match = request.getMessageFilter().isMatchedByConsumeQueue(tagsCode,
        new ConsumeQueueExt.CqExtUnit(tagsCode, msgStoreTime, filterBitMap));
    // match by bit map, need eval again when properties is not null.
    if (match && properties != null) {
        match = request.getMessageFilter().isMatchedByCommitLog(null, properties);
    }

    if (match) {
        try {
            this.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),
                request.getRequestCommand());
        } catch (Throwable e) {
            log.error("execute request when wakeup failed.", e);
        }
        continue;
    }
}
//å¦‚æœè¿‡æœŸæ—¶é—´è¶…æ—¶,åˆ™ä¸ç»§ç»­ç­‰å¾…å°†ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯æ¶ˆæ¯æœªæ‰¾åˆ°
if (System.currentTimeMillis() >= (request.getSuspendTimestamp() + request.getTimeoutMillis())) {
    try {
        this.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),
            request.getRequestCommand());
    } catch (Throwable e) {
        log.error("execute request when wakeup failed.", e);
    }
    continue;
}
```

å¦‚æœå¼€å¯äº†é•¿è½®è¯¢æœºåˆ¶ï¼ŒPullRequestHoldServiceä¼šæ¯éš”5sè¢«å”¤é†’å»å°è¯•æ£€æµ‹æ˜¯å¦æœ‰æ–°çš„æ¶ˆæ¯çš„åˆ°æ¥æ‰ç»™å®¢æˆ·ç«¯å“åº”ï¼Œæˆ–è€…ç›´åˆ°è¶…æ—¶æ‰ç»™å®¢æˆ·ç«¯è¿›è¡Œå“åº”ï¼Œæ¶ˆæ¯å®æ—¶æ€§æ¯”è¾ƒå·®ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒRocketMQå¼•å…¥å¦å¤–ä¸€ç§æœºåˆ¶ï¼šå½“æ¶ˆæ¯åˆ°è¾¾æ—¶å”¤é†’æŒ‚èµ·çº¿ç¨‹è§¦å‘ä¸€æ¬¡æ£€æŸ¥ã€‚

**<u>DefaultMessageStore$ReputMessageServiceæœºåˆ¶</u>**

***ä»£ç ï¼šDefaultMessageStore#start***

```java
//é•¿è½®è¯¢å…¥å£
this.reputMessageService.setReputFromOffset(maxPhysicalPosInLogicQueue);
this.reputMessageService.start();
```

***ä»£ç ï¼šDefaultMessageStore$ReputMessageService#run***

```java
public void run() {
    DefaultMessageStore.log.info(this.getServiceName() + " service started");

    while (!this.isStopped()) {
        try {
            Thread.sleep(1);
            //é•¿è½®è¯¢æ ¸å¿ƒé€»è¾‘ä»£ç å…¥å£
            this.doReput();
        } catch (Exception e) {
            DefaultMessageStore.log.warn(this.getServiceName() + " service has exception. ", e);
        }
    }

    DefaultMessageStore.log.info(this.getServiceName() + " service end");
}
```

***ä»£ç ï¼šDefaultMessageStore$ReputMessageService#deReput***

```java
//å½“æ–°æ¶ˆæ¯è¾¾åˆ°æ˜¯,è¿›è¡Œé€šçŸ¥ç›‘å¬å™¨è¿›è¡Œå¤„ç†
if (BrokerRole.SLAVE != DefaultMessageStore.this.getMessageStoreConfig().getBrokerRole()
    && DefaultMessageStore.this.brokerConfig.isLongPollingEnable()) {
    DefaultMessageStore.this.messageArrivingListener.arriving(dispatchRequest.getTopic(),
        dispatchRequest.getQueueId(), dispatchRequest.getConsumeQueueOffset() + 1,
        dispatchRequest.getTagsCode(), dispatchRequest.getStoreTimestamp(),
        dispatchRequest.getBitMap(), dispatchRequest.getPropertiesMap());
}
```

***ä»£ç ï¼šNotifyMessageArrivingListener#arriving***

```java
public void arriving(String topic, int queueId, long logicOffset, long tagsCode,
    long msgStoreTime, byte[] filterBitMap, Map<String, String> properties) {
    this.pullRequestHoldService.notifyMessageArriving(topic, queueId, logicOffset, tagsCode,
        msgStoreTime, filterBitMap, properties);
}
```

### æ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½ä¸é‡æ–°åˆ†å¸ƒæœºåˆ¶

RocketMQæ¶ˆæ¯é˜Ÿåˆ—é‡æ–°åˆ†é…æ˜¯ç”±RebalanceServiceçº¿ç¨‹æ¥å®ç°ã€‚ä¸€ä¸ªMQClientInstanceæŒæœ‰ä¸€ä¸ªRebalanceServiceå®ç°ï¼Œå¹¶éšç€MQClientInstanceçš„å¯åŠ¨è€Œå¯åŠ¨ã€‚

***ä»£ç ï¼šRebalanceService#run***

```java
public void run() {
    log.info(this.getServiceName() + " service started");
	//RebalanceServiceçº¿ç¨‹é»˜è®¤æ¯éš”20sæ‰§è¡Œä¸€æ¬¡mqClientFactory.doRebalanceæ–¹æ³•
    while (!this.isStopped()) {
        this.waitForRunning(waitInterval);
        this.mqClientFactory.doRebalance();
    }

    log.info(this.getServiceName() + " service end");
}
```

***ä»£ç ï¼šMQClientInstance#doRebalance***

```java
public void doRebalance() {
    //MQClientInstanceéå†ä»¥æ³¨å†Œçš„æ¶ˆè´¹è€…,å¯¹æ¶ˆè´¹è€…æ‰§è¡ŒdoRebalance()æ–¹æ³•
    for (Map.Entry<String, MQConsumerInner> entry : this.consumerTable.entrySet()) {
        MQConsumerInner impl = entry.getValue();
        if (impl != null) {
            try {
                impl.doRebalance();
            } catch (Throwable e) {
                log.error("doRebalance exception", e);
            }
        }
    }
}
```

***ä»£ç ï¼šRebalanceImpl#doRebalance***

```java
//éå†è®¢é˜…æ¶ˆæ¯å¯¹æ¯ä¸ªä¸»é¢˜çš„è®¢é˜…çš„é˜Ÿåˆ—è¿›è¡Œé‡æ–°è´Ÿè½½
public void doRebalance(final boolean isOrder) {
    Map<String, SubscriptionData> subTable = this.getSubscriptionInner();
    if (subTable != null) {
        for (final Map.Entry<String, SubscriptionData> entry : subTable.entrySet()) {
            final String topic = entry.getKey();
            try {
                this.rebalanceByTopic(topic, isOrder);
            } catch (Throwable e) {
                if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {
                    log.warn("rebalanceByTopic Exception", e);
                }
            }
        }
    }

    this.truncateMessageQueueNotMyTopic();
}
```

***ä»£ç ï¼šRebalanceImpl#rebalanceByTopic***

```java
//ä»ä¸»é¢˜è®¢é˜…æ¶ˆæ¯ç¼“å­˜è¡¨ä¸­è·å–ä¸»é¢˜çš„é˜Ÿåˆ—ä¿¡æ¯
Set<MessageQueue> mqSet = this.topicSubscribeInfoTable.get(topic);
//æŸ¥æ‰¾è¯¥ä¸»é¢˜è®¢é˜…ç»„æ‰€æœ‰çš„æ¶ˆè´¹è€…ID
List<String> cidAll = this.mQClientFactory.findConsumerIdList(topic, consumerGroup);

//ç»™æ¶ˆè´¹è€…é‡æ–°åˆ†é…é˜Ÿåˆ—
if (mqSet != null && cidAll != null) {
    List<MessageQueue> mqAll = new ArrayList<MessageQueue>();
    mqAll.addAll(mqSet);

    Collections.sort(mqAll);
    Collections.sort(cidAll);

    AllocateMessageQueueStrategy strategy = this.allocateMessageQueueStrategy;

    List<MessageQueue> allocateResult = null;
    try {
        allocateResult = strategy.allocate(
            this.consumerGroup,
            this.mQClientFactory.getClientId(),
            mqAll,
            cidAll);
    } catch (Throwable e) {
        log.error("AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName={}", strategy.getName(),
            e);
        return;
    }
```

RocketMQé»˜è®¤æä¾›5ä¸­è´Ÿè½½å‡è¡¡åˆ†é…ç®—æ³•

```java
AllocateMessageQueueAveragely:å¹³å‡åˆ†é…
ä¸¾ä¾‹:8ä¸ªé˜Ÿåˆ—q1,q2,q3,q4,q5,a6,q7,q8,æ¶ˆè´¹è€…3ä¸ª:c1,c2,c3
åˆ†é…å¦‚ä¸‹:
c1:q1,q2,q3
c2:q4,q5,a6
c3:q7,q8
AllocateMessageQueueAveragelyByCircle:å¹³å‡è½®è¯¢åˆ†é…
ä¸¾ä¾‹:8ä¸ªé˜Ÿåˆ—q1,q2,q3,q4,q5,a6,q7,q8,æ¶ˆè´¹è€…3ä¸ª:c1,c2,c3
åˆ†é…å¦‚ä¸‹:
c1:q1,q4,q7
c2:q2,q5,a8
c3:q3,q6
```

æ³¨æ„ï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†é…éµå¾ªä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥åˆ†é…åˆ°å¤šä¸ªé˜Ÿåˆ—ï¼Œä½†åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—åªä¼šåˆ†é…ç»™ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œæ•…å¦‚æœå‡ºç°æ¶ˆè´¹è€…ä¸ªæ•°å¤§äºæ¶ˆæ¯é˜Ÿåˆ—æ•°é‡ï¼Œåˆ™æœ‰äº›æ¶ˆè´¹è€…æ— æ³•æ¶ˆè´¹æ¶ˆæ¯ã€‚

### æ¶ˆæ¯æ¶ˆè´¹è¿‡ç¨‹

PullMessageServiceè´Ÿè´£å¯¹æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œä»è¿œç«¯æœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯åå°†æ¶ˆæ¯å­˜å‚¨ProcessQueueæ¶ˆæ¯é˜Ÿåˆ—å¤„ç†é˜Ÿåˆ—ä¸­ï¼Œç„¶åè°ƒç”¨ConsumeMessageService#submitConsumeRequestæ–¹æ³•è¿›è¡Œæ¶ˆæ¯æ¶ˆè´¹ï¼Œä½¿ç”¨çº¿ç¨‹æ± æ¥æ¶ˆè´¹æ¶ˆæ¯ï¼Œç¡®ä¿äº†æ¶ˆæ¯æ‹‰å–ä¸æ¶ˆæ¯æ¶ˆè´¹çš„è§£è€¦ã€‚ConsumeMessageServiceæ”¯æŒé¡ºåºæ¶ˆæ¯å’Œå¹¶å‘æ¶ˆæ¯ï¼Œæ ¸å¿ƒç±»å›¾å¦‚ä¸‹ï¼š

![](/assets/imgs/ConsumeMessageService.png)

**<u>å¹¶å‘æ¶ˆæ¯æ¶ˆè´¹</u>**

***ä»£ç ï¼šConsumeMessageConcurrentlyService#submitConsumeRequest***

```java
//æ¶ˆæ¯æ‰¹æ¬¡å•æ¬¡
final int consumeBatchSize = this.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();
//msgs.size()é»˜è®¤æœ€å¤šä¸º32æ¡ã€‚
//å¦‚æœmsgs.size()å°äºconsumeBatchSize,åˆ™ç›´æ¥å°†æ‹‰å–åˆ°çš„æ¶ˆæ¯æ”¾å…¥åˆ°consumeRequest,ç„¶åå°†consumeRequestæäº¤åˆ°æ¶ˆè´¹è€…çº¿ç¨‹æ± ä¸­
if (msgs.size() <= consumeBatchSize) {
    ConsumeRequest consumeRequest = new ConsumeRequest(msgs, processQueue, messageQueue);
    try {
        this.consumeExecutor.submit(consumeRequest);
    } catch (RejectedExecutionException e) {
        this.submitConsumeRequestLater(consumeRequest);
    }
}else{	//å¦‚æœæ‹‰å–çš„æ¶ˆæ¯æ¡æ•°å¤§äºconsumeBatchSize,åˆ™å¯¹æ‹‰å–æ¶ˆæ¯è¿›è¡Œåˆ†é¡µ
       for (int total = 0; total < msgs.size(); ) {
   		    List<MessageExt> msgThis = new ArrayList<MessageExt>(consumeBatchSize);
   		    for (int i = 0; i < consumeBatchSize; i++, total++) {
   		        if (total < msgs.size()) {
   		            msgThis.add(msgs.get(total));
   		        } else {
   		            break;
   		        }
   		
   		    ConsumeRequest consumeRequest = new ConsumeRequest(msgThis, processQueue, messageQueue);
   		    try {
   		        this.consumeExecutor.submit(consumeRequest);
   		    } catch (RejectedExecutionException e) {
   		        for (; total < msgs.size(); total++) {
   		            msgThis.add(msgs.get(total));
   		 
   		        this.submitConsumeRequestLater(consumeRequest);
   		    }
   		}
}
```

***ä»£ç ï¼šConsumeMessageConcurrentlyService$ConsumeRequest#run***

```java
//æ£€æŸ¥processQueueçš„dropped,å¦‚æœä¸ºtrue,åˆ™åœæ­¢è¯¥é˜Ÿåˆ—æ¶ˆè´¹ã€‚
if (this.processQueue.isDropped()) {
    log.info("the message queue not be able to consume, because it's dropped. group={} {}", ConsumeMessageConcurrentlyService.this.consumerGroup, this.messageQueue);
    return;
}

...
//æ‰§è¡Œæ¶ˆæ¯å¤„ç†çš„é’©å­å‡½æ•°
if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {
    consumeMessageContext = new ConsumeMessageContext();
    consumeMessageContext.setNamespace(defaultMQPushConsumer.getNamespace());
    consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());
    consumeMessageContext.setProps(new HashMap<String, String>());
    consumeMessageContext.setMq(messageQueue);
    consumeMessageContext.setMsgList(msgs);
    consumeMessageContext.setSuccess(false);
    ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);
}
...
//è°ƒç”¨åº”ç”¨ç¨‹åºæ¶ˆæ¯ç›‘å¬å™¨çš„consumeMessageæ–¹æ³•,è¿›å…¥åˆ°å…·ä½“çš„æ¶ˆæ¯æ¶ˆè´¹ä¸šåŠ¡å¤„ç†é€»è¾‘
status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);

//æ‰§è¡Œæ¶ˆæ¯å¤„ç†åçš„é’©å­å‡½æ•°
if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {
    consumeMessageContext.setStatus(status.toString());
    consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);
    ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);
}
```

### å®šæ—¶æ¶ˆæ¯æœºåˆ¶

å®šæ—¶æ¶ˆæ¯æ˜¯æ¶ˆæ¯å‘é€åˆ°Brokeråï¼Œå¹¶ä¸ç«‹å³è¢«æ¶ˆè´¹è€…æ¶ˆè´¹è€Œæ˜¯è¦ç­‰åˆ°ç‰¹å®šçš„æ—¶é—´åæ‰èƒ½è¢«æ¶ˆè´¹ï¼ŒRocketMQå¹¶ä¸æ”¯æŒä»»æ„çš„æ—¶é—´ç²¾åº¦ï¼Œå¦‚æœè¦æ”¯æŒä»»æ„æ—¶é—´ç²¾åº¦å®šæ—¶è°ƒåº¦ï¼Œä¸å¯é¿å…åœ°éœ€è¦åœ¨Brokerå±‚åšæ¶ˆæ¯æ’åºï¼Œå†åŠ ä¸ŠæŒä¹…åŒ–æ–¹é¢çš„è€ƒé‡ï¼Œå°†ä¸å¯é¿å…çš„å¸¦æ¥å·¨å¤§çš„æ€§èƒ½æ¶ˆè€—ï¼Œæ‰€ä»¥RocketMQåªæ”¯æŒç‰¹å®šçº§åˆ«çš„å»¶è¿Ÿæ¶ˆæ¯ã€‚æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«åœ¨Brokerç«¯é€šè¿‡messageDelayLevelé…ç½®ï¼Œé»˜è®¤ä¸ºâ€œ1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2hâ€ï¼ŒdelayLevel=1è¡¨ç¤ºå»¶è¿Ÿæ¶ˆæ¯1s,delayLevel=2è¡¨ç¤ºå»¶è¿Ÿ5s,ä¾æ¬¡ç±»æ¨ã€‚

RocketMQå®šæ—¶æ¶ˆæ¯å®ç°ç±»ä¸ºScheduleMessageServiceï¼Œè¯¥ç±»åœ¨DefaultMessageStoreä¸­åˆ›å»ºã€‚é€šè¿‡åœ¨DefaultMessageStoreä¸­è°ƒç”¨loadæ–¹æ³•åŠ è½½è¯¥ç±»å¹¶è°ƒç”¨startæ–¹æ³•å¯åŠ¨ã€‚

***ä»£ç ï¼šScheduleMessageService#load***

```java
//åŠ è½½å»¶è¿Ÿæ¶ˆæ¯æ¶ˆè´¹è¿›åº¦çš„åŠ è½½ä¸delayLevelTableçš„æ„é€ ã€‚å»¶è¿Ÿæ¶ˆæ¯çš„è¿›åº¦é»˜è®¤å­˜å‚¨è·¯å¾„ä¸º/store/config/delayOffset.json
public boolean load() {
    boolean result = super.load();
    result = result && this.parseDelayLevel();
    return result;
}
```

***ä»£ç ï¼šScheduleMessageService#start***

```java
//éå†å»¶è¿Ÿé˜Ÿåˆ—åˆ›å»ºå®šæ—¶ä»»åŠ¡,éå†å»¶è¿Ÿçº§åˆ«ï¼Œæ ¹æ®å»¶è¿Ÿçº§åˆ«levelä»offsetTableä¸­è·å–æ¶ˆè´¹é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨0
for (Map.Entry<Integer, Long> entry : this.delayLevelTable.entrySet()) {
    Integer level = entry.getKey();
    Long timeDelay = entry.getValue();
    Long offset = this.offsetTable.get(level);
    if (null == offset) {
        offset = 0L;
    }

    if (timeDelay != null) {
        this.timer.schedule(new DeliverDelayedMessageTimerTask(level, offset), FIRST_DELAY_TIME);
    }
}

//æ¯éš”10sæŒä¹…åŒ–ä¸€æ¬¡å»¶è¿Ÿé˜Ÿåˆ—çš„æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦
this.timer.scheduleAtFixedRate(new TimerTask() {

    @Override
    public void run() {
        try {
            if (started.get()) ScheduleMessageService.this.persist();
        } catch (Throwable e) {
            log.error("scheduleAtFixedRate flush exception", e);
        }
    }
}, 10000, this.defaultMessageStore.getMessageStoreConfig().getFlushDelayOffsetInterval());

```

**<u>è°ƒåº¦æœºåˆ¶</u>**

ScheduleMessageServiceçš„startæ–¹æ³•å¯åŠ¨åï¼Œä¼šä¸ºæ¯ä¸€ä¸ªå»¶è¿Ÿçº§åˆ«åˆ›å»ºä¸€ä¸ªè°ƒåº¦ä»»åŠ¡ï¼Œæ¯ä¸€ä¸ªå»¶è¿Ÿçº§åˆ«å¯¹åº”SCHEDULE_TOPIC_XXXXä¸»é¢˜ä¸‹çš„ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ã€‚å®šæ—¶è°ƒåº¦ä»»åŠ¡çš„å®ç°ç±»ä¸ºDeliverDelayedMessageTimerTaskï¼Œæ ¸å¿ƒå®ç°æ–¹æ³•ä¸ºexecuteOnTimeup

***ä»£ç ï¼šScheduleMessageService$DeliverDelayedMessageTimerTask#executeOnTimeup***

```java
//æ ¹æ®é˜Ÿåˆ—IDä¸å»¶è¿Ÿä¸»é¢˜æŸ¥æ‰¾æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—
ConsumeQueue cq =
    ScheduleMessageService.this.defaultMessageStore.findConsumeQueue(SCHEDULE_TOPIC,
        delayLevel2QueueId(delayLevel));
...
//æ ¹æ®åç§»é‡ä»æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ä¸­è·å–å½“å‰é˜Ÿåˆ—ä¸­æ‰€æœ‰æœ‰æ•ˆçš„æ¶ˆæ¯
SelectMappedBufferResult bufferCQ = cq.getIndexBuffer(this.offset);

...
//éå†ConsumeQueue,è§£ææ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆæ¯
for (; i < bufferCQ.getSize(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE) {
    long offsetPy = bufferCQ.getByteBuffer().getLong();
    int sizePy = bufferCQ.getByteBuffer().getInt();
    long tagsCode = bufferCQ.getByteBuffer().getLong();

    if (cq.isExtAddr(tagsCode)) {
        if (cq.getExt(tagsCode, cqExtUnit)) {
            tagsCode = cqExtUnit.getTagsCode();
        } else {
            //can't find ext content.So re compute tags code.
            log.error("[BUG] can't find consume queue extend file content!addr={}, offsetPy={}, sizePy={}",
                tagsCode, offsetPy, sizePy);
            long msgStoreTime = defaultMessageStore.getCommitLog().pickupStoreTimestamp(offsetPy, sizePy);
            tagsCode = computeDeliverTimestamp(delayLevel, msgStoreTime);
        }
    }

    long now = System.currentTimeMillis();
    long deliverTimestamp = this.correctDeliverTimestamp(now, tagsCode);
    
    ...
    //æ ¹æ®æ¶ˆæ¯åç§»é‡ä¸æ¶ˆæ¯å¤§å°,ä»CommitLogä¸­æŸ¥æ‰¾æ¶ˆæ¯.
  	MessageExt msgExt =
   ScheduleMessageService.this.defaultMessageStore.lookMessageByOffset(
       offsetPy, sizePy);
} 
```

### é¡ºåºæ¶ˆæ¯

é¡ºåºæ¶ˆæ¯å®ç°ç±»æ˜¯org.apache.rocketmq.client.impl.consumer.ConsumeMessageOrderlyService

***ä»£ç ï¼šConsumeMessageOrderlyService#start***

```java
public void start() {
    //å¦‚æœæ¶ˆæ¯æ¨¡å¼ä¸ºé›†ç¾¤æ¨¡å¼ï¼Œå¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œé»˜è®¤æ¯éš”20sæ‰§è¡Œä¸€æ¬¡é”å®šåˆ†é…ç»™è‡ªå·±çš„æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—
    if (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())) {
        this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {
            @Override
            public void run() {
                ConsumeMessageOrderlyService.this.lockMQPeriodically();
            }
        }, 1000 * 1, ProcessQueue.REBALANCE_LOCK_INTERVAL, TimeUnit.MILLISECONDS);
    }
}
```

***ä»£ç ï¼šConsumeMessageOrderlyService#submitConsumeRequest***

```java
//æ„å»ºæ¶ˆæ¯ä»»åŠ¡,å¹¶æäº¤æ¶ˆè´¹çº¿ç¨‹æ± ä¸­
public void submitConsumeRequest(
    final List<MessageExt> msgs,
    final ProcessQueue processQueue,
    final MessageQueue messageQueue,
    final boolean dispathToConsume) {
    if (dispathToConsume) {
        ConsumeRequest consumeRequest = new ConsumeRequest(processQueue, messageQueue);
        this.consumeExecutor.submit(consumeRequest);
    }
}
```

***ä»£ç ï¼šConsumeMessageOrderlyService$ConsumeRequest#run***

```java
//å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸ºä¸¢å¼ƒ,åˆ™åœæ­¢æœ¬æ¬¡æ¶ˆè´¹ä»»åŠ¡
if (this.processQueue.isDropped()) {
    log.warn("run, the message queue not be able to consume, because it's dropped. {}", this.messageQueue);
    return;
}
//ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªå¯¹è±¡ã€‚ç„¶åæ¶ˆè´¹æ¶ˆæ¯æ—¶å…ˆç”³è¯·ç‹¬å objLocké”ã€‚é¡ºåºæ¶ˆæ¯ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—åŒä¸€æ—¶åˆ»åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹çº¿ç¨‹æ± å¤„ç†
final Object objLock = messageQueueLock.fetchLockObject(this.messageQueue);
synchronized (objLock) {
	...
}
```

### å°ç»“

RocketMQæ¶ˆæ¯æ¶ˆè´¹æ–¹å¼åˆ†åˆ«ä¸ºé›†ç¾¤æ¨¡å¼ã€å¹¿æ’­æ¨¡å¼ã€‚

æ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½ç”±RebalanceServiceçº¿ç¨‹é»˜è®¤æ¯éš”20sè¿›è¡Œä¸€æ¬¡æ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½ï¼Œæ ¹æ®å½“å‰æ¶ˆè´¹è€…ç»„å†…æ¶ˆè´¹è€…ä¸ªæ•°ä¸ä¸»é¢˜é˜Ÿåˆ—æ•°é‡æŒ‰ç…§æŸä¸€ç§è´Ÿè½½ç®—æ³•è¿›è¡Œé˜Ÿåˆ—åˆ†é…ï¼Œåˆ†é…åŸåˆ™ä¸ºåŒä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥åˆ†é…å¤šä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼ŒåŒä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—åŒä¸€ä¸ªæ—¶é—´åªä¼šåˆ†é…ç»™ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚

æ¶ˆæ¯æ‹‰å–ç”±PullMessageServiceçº¿ç¨‹æ ¹æ®RebalanceServiceçº¿ç¨‹åˆ›å»ºçš„æ‹‰å–ä»»åŠ¡è¿›è¡Œæ‹‰å–ï¼Œé»˜è®¤æ¯æ¬¡æ‹‰å–32æ¡æ¶ˆæ¯ï¼Œæäº¤ç»™æ¶ˆè´¹è€…æ¶ˆè´¹çº¿ç¨‹åç»§ç»­ä¸‹ä¸€æ¬¡æ¶ˆæ¯æ‹‰å–ã€‚å¦‚æœæ¶ˆæ¯æ¶ˆè´¹è¿‡æ…¢äº§ç”Ÿæ¶ˆæ¯å †ç§¯ä¼šè§¦å‘æ¶ˆæ¯æ¶ˆè´¹æ‹‰å–æµæ§ã€‚ 

å¹¶å‘æ¶ˆæ¯æ¶ˆè´¹æŒ‡æ¶ˆè´¹çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯ä»¥å¹¶å‘å¯¹åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼Œæ¶ˆè´¹æˆåŠŸåï¼Œå–å‡ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ€å°çš„æ¶ˆæ¯åç§»é‡ä½œä¸ºæ¶ˆæ¯æ¶ˆè´¹è¿›åº¦åç§»é‡å­˜å‚¨åœ¨äºæ¶ˆæ¯æ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶ä¸­ï¼Œé›†ç¾¤æ¨¡å¼æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦å­˜å‚¨åœ¨Brokerï¼ˆæ¶ˆæ¯æœåŠ¡å™¨ï¼‰ï¼Œå¹¿æ’­æ¨¡å¼æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦å­˜å‚¨åœ¨æ¶ˆè´¹è€…ç«¯ã€‚

RocketMQä¸æ”¯æŒä»»æ„ç²¾åº¦çš„å®šæ—¶è°ƒåº¦æ¶ˆæ¯ï¼Œåªæ”¯æŒè‡ªå®šä¹‰çš„æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«ï¼Œä¾‹å¦‚1sã€2sã€5sç­‰ï¼Œå¯é€šè¿‡åœ¨brokeré…ç½®æ–‡ä»¶ä¸­è®¾ç½®messageDelayLevelã€‚

é¡ºåºæ¶ˆæ¯ä¸€èˆ¬ä½¿ç”¨é›†ç¾¤æ¨¡å¼ï¼Œæ˜¯æŒ‡å¯¹æ¶ˆæ¯æ¶ˆè´¹è€…å†…çš„çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯¹æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—åªèƒ½ä¸²è¡Œæ¶ˆè´¹ã€‚å¹¶å¹¶å‘æ¶ˆæ¯æ¶ˆè´¹æœ€æœ¬è´¨çš„åŒºåˆ«æ˜¯æ¶ˆæ¯æ¶ˆè´¹æ—¶å¿…é¡»æˆåŠŸé”å®šæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œåœ¨Brokerç«¯ä¼šå­˜å‚¨æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—çš„é”å ç”¨æƒ…å†µã€‚