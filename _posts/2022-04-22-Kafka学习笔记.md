---
layout: post
title:  "Kafkaå­¦ä¹ ç¬”è®°"
date:   2022-04-22 12:19:06 +0800--
categories: [Kafka]
tags: [Kafka, ]  
---

# Kafkaæ¦‚è¿°

Kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯é˜Ÿåˆ—(Message Queue)ï¼Œä¸»è¦åº”ç”¨äºå¤§æ•°æ®å®æ—¶å¤„ç†é¢†åŸŸã€‚



## æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¨¡å¼

### ç‚¹å¯¹ç‚¹æ¨¡å¼

**ä¸€å¯¹ä¸€ï¼Œæ¶ˆè´¹è€…ä¸»åŠ¨æ‹‰å–æ•°æ®ï¼Œæ¶ˆæ¯æ”¶åˆ°åæ¶ˆæ¯æ¸…é™¤ã€‚**æ¶ˆæ¯ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯å‘é€åˆ° Queue ä¸­ï¼Œç„¶åæ¶ˆæ¯æ¶ˆè´¹è€…ä» Queue ä¸­å–å‡ºå¹¶ä¸”æ¶ˆè´¹æ¶ˆæ¯ã€‚æ¶ˆæ¯è¢«æ¶ˆè´¹ä»¥åï¼ŒQueue ä¸­ä¸å†æœ‰å­˜å‚¨ï¼Œæ‰€ä»¥æ¶ˆæ¯æ¶ˆè´¹è€…ä¸å¯èƒ½æ¶ˆè´¹åˆ°å·²ç»è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚ Queue æ”¯æŒå­˜åœ¨å¤šä¸ªæ¶ˆè´¹è€…ï¼Œä½†æ˜¯å¯¹ä¸€ä¸ªæ¶ˆæ¯è€Œè¨€ï¼Œåªä¼šæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ã€‚

![image-20220425222529896](/assets/imgs/image-20220425222529896.png)

### å‘å¸ƒ/è®¢é˜…æ¨¡å¼

**ä¸€å¯¹å¤šï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ä¹‹åä¸ä¼šæ¸…é™¤æ¶ˆæ¯ã€‚**æ¶ˆæ¯ç”Ÿäº§è€…(å‘å¸ƒ)å°†æ¶ˆæ¯å‘å¸ƒåˆ° topic ä¸­ï¼ŒåŒæ—¶æœ‰å¤šä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…(è®¢é˜…)æ¶ˆè´¹è¯¥æ¶ˆæ¯ã€‚å’Œç‚¹å¯¹ç‚¹æ–¹å¼ä¸åŒï¼Œå‘å¸ƒåˆ° topic çš„æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰è®¢é˜…è€…æ¶ˆè´¹ã€‚è¯¥æ¨¡å¼å…·ä½“å¯åˆ†ä¸ºæ‹‰å’Œæ¨ä¸¤ç§æ–¹å¼ï¼š

- é˜Ÿåˆ—ä¸»åŠ¨æ¨é€ï¼šå„ä¸ªæ¶ˆè´¹è€…å¤„ç†çš„é€Ÿç‡ä¸åŒï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¶ˆè´¹è€…èµ„æºæµªè´¹æˆ–ä¸è¶³ã€‚
- æ¶ˆè´¹è€…ä¸»åŠ¨æ‹‰å–ï¼šé•¿è½®è¯¢

![image-20220425222547643](/assets/imgs/image-20220425222547643.png)

## Kafka åŸºç¡€æ¶æ„

![image-20220426141607627](/assets/imgs/image-20220426141607627.png)

- **Producer**:æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯å‘ Kafka broker å‘æ¶ˆæ¯çš„å®¢æˆ·ç«¯
- **Consumer**:æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå‘ Kafka broker å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯
- **Consumer Group**(**CG**):æ¶ˆè´¹è€…ç»„ï¼Œç”±å¤šä¸ªconsumerç»„æˆã€‚æ¶ˆè´¹è€…ç»„å†…æ¯ä¸ªæ¶ˆè´¹è€…è´Ÿè´£æ¶ˆè´¹ä¸åŒåˆ†åŒºçš„æ•°æ®ï¼Œä¸€ä¸ªåˆ†åŒºåªèƒ½ç”±ä¸€ä¸ªç»„å†…æ¶ˆè´¹è€…æ¶ˆè´¹;æ¶ˆè´¹è€…ç»„ä¹‹é—´äº’ä¸ å½±å“ã€‚æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½å±äºæŸä¸ªæ¶ˆè´¹è€…ç»„ï¼Œå³æ¶ˆè´¹è€…ç»„æ˜¯é€»è¾‘ä¸Šçš„ä¸€ä¸ªè®¢é˜…è€…ã€‚
- **Broker**:ä¸€å° Kafka æœåŠ¡å™¨å°±æ˜¯ä¸€ä¸ª brokerã€‚ä¸€ä¸ªé›†ç¾¤ç”±å¤šä¸ª broker ç»„æˆã€‚ä¸€ä¸ª broker å¯ä»¥å®¹çº³å¤šä¸ª topicã€‚
- **Topic**:å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é¢å‘çš„éƒ½æ˜¯ä¸€ä¸ª **topic**ã€‚
- **Partition**:ä¸ºäº†å®ç°æ‰©å±•æ€§ï¼Œä¸€ä¸ªéå¸¸å¤§çš„ topic å¯ä»¥åˆ†å¸ƒåˆ°å¤šä¸ª broker(å³æœ åŠ¡å™¨)ä¸Šï¼Œä¸€ä¸ª **topic** å¯ä»¥åˆ†ä¸ºå¤šä¸ª **partition**ï¼Œæ¯ä¸ª partition æ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ã€‚
- **Replica**:å‰¯æœ¬ã€‚ä¸€ä¸ª topic çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰è‹¥å¹²ä¸ªå‰¯æœ¬ï¼Œä¸€ä¸ª **Leader** å’Œè‹¥å¹²ä¸ª **Follower**ã€‚
- **Leader**:æ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬çš„â€œä¸»â€ï¼Œç”Ÿäº§è€…å‘é€æ•°æ®çš„å¯¹è±¡ï¼Œä»¥åŠæ¶ˆè´¹è€…æ¶ˆè´¹æ•° æ®çš„å¯¹è±¡éƒ½æ˜¯ Leaderã€‚
- **Follower**:æ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬ä¸­çš„â€œä»â€ï¼Œå®æ—¶ä» Leader ä¸­åŒæ­¥æ•°æ®ï¼Œä¿æŒå’Œ Leader æ•°æ®çš„åŒæ­¥ã€‚Leader å‘ç”Ÿæ•…éšœæ—¶ï¼ŒæŸä¸ª Follower ä¼šæˆä¸ºæ–°çš„ Leaderã€‚

# Kafkaå¿«é€Ÿå…¥é—¨

## å•æœºéƒ¨ç½²

1ï¼‰è§£å‹å®‰è£…åŒ…

```shell
tar -zxvf kafka_2.12-3.0.0.tgz -C /opt/module/
```

2ï¼‰åˆ›å»ºlogsæ—¥å¿—æ–‡ä»¶å¤¹

```shell
mkdir ~/Application/kafka_2.12-3.0.0/logs
```

3ï¼‰ä¿®æ”¹é…ç½®æ–‡ä»¶

```shell
vim kafka_2.12-3.0.0/config/server.properties
```

```shell
#broker çš„å…¨å±€å”¯ä¸€ç¼–å·ï¼Œä¸èƒ½é‡å¤ broker.id=0
#åˆ é™¤ topic åŠŸèƒ½ä½¿èƒ½
delete.topic.enable=true
#å¤„ç†ç½‘ç»œè¯·æ±‚çš„çº¿ç¨‹æ•°é‡ 
num.network.threads=3
#ç”¨æ¥å¤„ç†ç£ç›˜ IO çš„ç°æˆæ•°é‡ 
num.io.threads=8 
#å‘é€å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å° 
socket.send.buffer.bytes=102400 
#æ¥æ”¶å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å° 
socket.receive.buffer.bytes=102400 
#è¯·æ±‚å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å° 
socket.request.max.bytes=104857600 
#kafka è¿è¡Œæ•°æ®å’Œæ—¥å¿—å­˜æ”¾çš„è·¯å¾„ 
log.dirs=~/Application/kafka_2.12-3.0.0/logs
#topic åœ¨å½“å‰ broker ä¸Šçš„åˆ†åŒºä¸ªæ•° 
num.partitions=1
#ç”¨æ¥æ¢å¤å’Œæ¸…ç† data ä¸‹æ•°æ®çš„çº¿ç¨‹æ•°é‡ 
num.recovery.threads.per.data.dir=1 
#segment æ–‡ä»¶ä¿ç•™çš„æœ€é•¿æ—¶é—´ï¼Œè¶…æ—¶å°†è¢«åˆ é™¤ 
log.retention.hours=168
#é…ç½®è¿æ¥ Zookeeper é›†ç¾¤åœ°å€ 
zookeeper.connect=localhost:2181/kafka
```

4ï¼‰ä¾æ¬¡å¯åŠ¨zookeeperå’Œkafka(Kafkaä¼šæŒ‰ç…§é»˜è®¤ï¼Œåœ¨**9092**ç«¯å£ä¸Šè¿è¡Œï¼Œå¹¶è¿æ¥zookeeperçš„é»˜è®¤ç«¯å£ï¼š2182)

```shell
cd ~/Applications/ZooKeeper
bin/zkServer.sh start
~/Application/kafka_2.12-3.0.0
sh bin/kafka-server-start.sh  -daemon  config/server.properties # -daemon åå°å¯åŠ¨kafka
```

å¦‚kafkaå¯åŠ¨æŠ¥é”™ï¼šåœ¨ server.properties æ‰¾åˆ°  log.dirs é…ç½®çš„è·¯å¾„ã€‚å°†è¯¥è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ é™¤ï¼Œæˆ–è€…ç¼–è¾‘meta.propertiesæ–‡ä»¶ä¿®æ”¹é‡Œé¢çš„cluster.idå³å¯ã€‚

```java
ERROR Fatal error during KafkaServer startup. Prepare to shutdown (kafka.server.KafkaServer)
kafka.common.InconsistentClusterIdException: The Cluster ID kVSgfurUQFGGpHMTBqBPiw doesn't match stored clusterId Some(0Qftv9yBTAmf2iDPSlIk7g) in meta.properties. The broker is trying to join the wrong cluster. Configured zookeeper.connect may be wrong.
    at kafka.server.KafkaServer.startup(KafkaServer.scala:220)
    at kafka.server.KafkaServerStartable.startup(KafkaServerStartable.scala:44)
    at kafka.Kafka$.main(Kafka.scala:84)
    at kafka.Kafka.main(Kafka.scala)
```





## ä¸»é¢˜å‘½ä»¤è¡Œæ“ä½œ

1ï¼‰æŸ¥çœ‹æ“ä½œä¸»é¢˜å‘½ä»¤å‚æ•°

```shell
bin/kafka-topics.sh
```

![image-20220426130141201](/assets/imgs/image-20220426130141201.png)

2ï¼‰æŸ¥çœ‹å½“å‰æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰ topic

```shell
bin/kafka-topics.sh --bootstrap-server localhost:9092 --list
```

3ï¼‰åˆ›å»º first topic

```shell
# --topic å®šä¹‰topicå --replication-factor å®šä¹‰å‰¯æœ¬æ•° --partitions å®šä¹‰åˆ†åŒºæ•°
bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --partitions 1 --replication-factor 3 --topic first
```

4ï¼‰æŸ¥çœ‹ first ä¸»é¢˜çš„è¯¦æƒ…

```shell
bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic first
```

5ï¼‰ä¿®æ”¹åˆ†åŒºæ•°(æ³¨æ„:åˆ†åŒºæ•°åªèƒ½å¢åŠ ï¼Œä¸èƒ½å‡å°‘)

```shell
bin/kafka-topics.sh --bootstrap-server localhost:9092 --alter --topic first --partitions 3
```

6ï¼‰åˆ é™¤ topic

```shell
bin/kafka-topics.sh --bootstrap-server localhost:9092 --delete --topic first
```

  

## ç”Ÿäº§è€…å‘½ä»¤è¡Œæ“ä½œ

1ï¼‰æŸ¥çœ‹æ“ä½œç”Ÿäº§è€…å‘½ä»¤å‚æ•°

```shell
bin/kafka-console-producer.sh
```

![image-20220426140913384](/Users/silince/Develop/åšå®¢/blog_to_git/assets/imgs/image-20220426140913384.png)

2ï¼‰å‘é€æ¶ˆæ¯

```shell
bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic first
>hello world
```



## æ¶ˆè´¹è€…å‘½ä»¤è¡Œæ“ä½œ

1ï¼‰æŸ¥çœ‹æ“ä½œæ¶ˆè´¹è€…å‘½ä»¤å‚æ•°

| å‚æ•°                                             | æè¿°                                 |
| ------------------------------------------------ | ------------------------------------ |
| --bootstrap-server <String: server toconnect to> | è¿æ¥çš„ Kafka Broker ä¸»æœºåç§°å’Œç«¯å£å· |
| --topic <String: topic>                          | æ“ä½œçš„ topic åç§°                    |
| --from-beginning                                 | ä»å¤´å¼€å§‹æ¶ˆè´¹                         |
| --group <String: consumer group id>              | æŒ‡å®šæ¶ˆè´¹è€…ç»„åç§°                     |

2ï¼‰æ¶ˆè´¹æ¶ˆæ¯

```shell
# æ¶ˆè´¹ first ä¸»é¢˜ä¸­çš„æ•°æ®
bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic first
# æŠŠä¸»é¢˜ä¸­æ‰€æœ‰çš„æ•°æ®éƒ½è¯»å–å‡ºæ¥(åŒ…æ‹¬å†å²æ•°æ®)
bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --from-beginning --topic first
```





# Kafkaç”Ÿäº§è€…

## ç”Ÿäº§è€…æ¶ˆæ¯å‘é€æµç¨‹

### å‘é€åŸç†

åœ¨æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°äº†ä¸¤ä¸ªçº¿ç¨‹ï¼š**main** çº¿ç¨‹å’Œ **Sender** çº¿ç¨‹ã€‚åœ¨ main çº¿ç¨‹ ä¸­åˆ›å»ºäº†ä¸€ä¸ªåŒç«¯é˜Ÿåˆ— **RecordAccumulator**ã€‚main çº¿ç¨‹é€šè¿‡åˆ†åŒºå™¨å°†æ¶ˆæ¯å‘é€ç»™ RecordAccumulatorï¼Œ Sender çº¿ç¨‹ä¸æ–­ä» RecordAccumulator ä¸­æ‹‰å–æ¶ˆæ¯å‘é€åˆ° Kafka Brokerã€‚

![image-20220426144944892](/assets/imgs/image-20220426144944892.png)

- **batch.size**ï¼šåªæœ‰æ•°æ®ç§¯ç´¯åˆ°batch.sizeä¹‹åï¼Œsenderæ‰ä¼šå‘é€æ•°æ®ï¼Œé»˜è®¤16k 
- **linger.ms**ï¼šå¦‚æœæ•°æ®è¿Ÿè¿Ÿæœªè¾¾åˆ°batch.size,senderç­‰å¾…linger.msè®¾ç½®çš„æ—¶é—´ã€‚åˆ°äº†ä¹‹åå°±ä¼šå‘é€æ•°æ®ï¼Œå•ä½msï¼Œé»˜è®¤å€¼æ˜¯0msï¼Œè¡¨ç¤ºæ²¡æœ‰å»¶è¿Ÿã€‚

åº”ç­”acksï¼š

- 0ï¼šç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ•°æ®ï¼Œä¸éœ€è¦ç­‰æ•°æ®è½ç›˜åº”ç­”ã€‚
- 1ï¼šç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ•°æ®ï¼ŒLeader æ”¶åˆ°æ•°æ®ååº”ç­”ã€‚
- -1(all)ï¼šç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ•°æ®ï¼ŒLeader å’Œ ISR é˜Ÿåˆ— é‡Œé¢çš„æ‰€æœ‰èŠ‚ç‚¹æ”¶é½æ•°æ®ååº”ç­”ã€‚-1å’Œ all ç­‰ä»·ã€‚



### ç”Ÿäº§è€…é‡è¦å‚æ•°åˆ—è¡¨

| å‚æ•°åç§°                              | æè¿°                                                         |
| ------------------------------------- | ------------------------------------------------------------ |
| bootstrap.servers                     | ç”Ÿäº§è€…è¿æ¥é›†ç¾¤æ‰€éœ€çš„ broker åœ°å€æ¸…å•ã€‚ä¾‹å¦‚ hadoop102:9092,hadoop103:9092,hadoop104:9092ï¼Œå¯ä»¥è®¾ç½® 1 ä¸ªæˆ–è€…å¤šä¸ªï¼Œä¸­é—´ç”¨é€—å·éš”å¼€ã€‚æ³¨æ„è¿™é‡Œå¹¶ééœ€è¦æ‰€æœ‰çš„ broker åœ°å€ï¼Œå› ä¸ºç”Ÿäº§è€…ä»ç»™å®šçš„ broker é‡ŒæŸ¥æ‰¾åˆ°å…¶ä»– broker ä¿¡æ¯ã€‚ |
| key.serializer å’Œ value.serializer    | æŒ‡å®šå‘é€æ¶ˆæ¯çš„ key å’Œ value çš„åºåˆ—åŒ–ç±»å‹ã€‚ä¸€å®šè¦å†™ å…¨ç±»åã€‚  |
| buffer.memory                         | RecordAccumulator ç¼“å†²åŒºæ€»å¤§å°ï¼Œé»˜è®¤ 32mã€‚                   |
| batch.size                            | ç¼“å†²åŒºä¸€æ‰¹æ•°æ®æœ€å¤§å€¼ï¼Œé»˜è®¤ 16kã€‚é€‚å½“å¢åŠ è¯¥å€¼ï¼Œå¯ ä»¥æé«˜ååé‡ï¼Œä½†æ˜¯å¦‚æœè¯¥å€¼è®¾ç½®å¤ªå¤§ï¼Œä¼šå¯¼è‡´æ•°æ® ä¼ è¾“å»¶è¿Ÿå¢åŠ ã€‚ |
| linger.ms                             | å¦‚æœæ•°æ®è¿Ÿè¿Ÿæœªè¾¾åˆ° batch.sizeï¼Œsender ç­‰å¾… linger.time ä¹‹åå°±ä¼šå‘é€æ•°æ®ã€‚å•ä½ msï¼Œé»˜è®¤å€¼æ˜¯ 0msï¼Œè¡¨ç¤ºæ²¡ æœ‰å»¶è¿Ÿã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®è¯¥å€¼å¤§å°ä¸º 5-100ms ä¹‹é—´ã€‚ |
| acks                                  | 0ï¼šç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ•°æ®ï¼Œä¸éœ€è¦ç­‰æ•°æ®è½ç›˜åº”ç­”ã€‚ 1ï¼šç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ•°æ®ï¼ŒLeader æ”¶åˆ°æ•°æ®ååº”ç­”ã€‚ -1(all)ï¼šç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ•°æ®ï¼ŒLeader å’Œ ISR é˜Ÿåˆ— é‡Œé¢çš„æ‰€æœ‰èŠ‚ç‚¹æ”¶é½æ•°æ®ååº”ç­”ã€‚-1å’Œ all ç­‰ä»·ã€‚ |
| max.in.flight.requests.per.connection | å…è®¸æœ€å¤šæ²¡æœ‰è¿”å› ack çš„æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 5ï¼Œå¼€å¯å¹‚ç­‰æ€§ è¦ä¿è¯è¯¥å€¼æ˜¯ 1-5 çš„æ•°å­—ã€‚ |
| retries                               | å½“æ¶ˆæ¯å‘é€å‡ºç°é”™è¯¯çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šé‡å‘æ¶ˆæ¯ã€‚retries è¡¨ç¤ºé‡è¯•æ¬¡æ•°ã€‚é»˜è®¤æ˜¯ int æœ€å¤§å€¼ï¼Œ2147483647ã€‚ å¦‚æœè®¾ç½®äº†é‡è¯•ï¼Œè¿˜æƒ³ä¿è¯æ¶ˆæ¯çš„æœ‰åºæ€§ï¼Œéœ€è¦è®¾ç½® MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION=1 å¦åˆ™åœ¨é‡è¯•æ­¤å¤±è´¥æ¶ˆæ¯çš„æ—¶å€™ï¼Œå…¶ä»–çš„æ¶ˆæ¯å¯èƒ½å‘é€æˆåŠŸäº†ã€‚ |
| retry.backoff.ms                      | ä¸¤æ¬¡é‡è¯•ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤æ˜¯ 100msã€‚                       |
| enable.idempotence                    | æ˜¯å¦å¼€å¯å¹‚ç­‰æ€§ï¼Œé»˜è®¤ trueï¼Œå¼€å¯å¹‚ç­‰æ€§ã€‚                      |
| compression.type                      | ç”Ÿäº§è€…å‘é€çš„æ‰€æœ‰æ•°æ®çš„å‹ç¼©æ–¹å¼ã€‚é»˜è®¤æ˜¯ noneï¼Œä¹Ÿ å°±æ˜¯ä¸å‹ç¼©ã€‚ æ”¯æŒå‹ç¼©ç±»å‹:noneã€gzipã€snappyã€lz4 å’Œ zstdã€‚ |



## å¼‚æ­¥å‘é€ **API**

### æ™®é€šå¼‚æ­¥å‘é€

> éœ€æ±‚:åˆ›å»º Kafka ç”Ÿäº§è€…ï¼Œé‡‡ç”¨**å¼‚æ­¥**çš„æ–¹å¼(å¤–éƒ¨æ•°æ®æ— é¡»ç­‰åˆ°å½“å‰batchè¢«RecordAccumulatorå¤„ç†å®Œåå†è½½å…¥)å‘é€åˆ° Kafka Broker

1ï¼‰åˆ›å»ºå·¥ç¨‹ï¼Œå¯¼å…¥ä¾èµ–

```html
<dependency>
  <groupId>org.springframework.kafka</groupId>
  <artifactId>spring-kafka-test</artifactId>
  <scope>test</scope>
</dependency>
```



2ï¼‰ç¼–å†™ä¸å¸¦å›è°ƒå‡½æ•°çš„ API ä»£ç 

```java
/**
 * kafka ç”Ÿäº§è€…
 *
 * @author zhongye
 * @since 2022.04.26
 */
public class CustomProducer {
  public static void main(String[] args) {
    // 0 é…ç½®
    Properties properties = new Properties();
    // è¿æ¥é›†ç¾¤ bootstrap.servers
    properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,"localhost:9092");
    // æŒ‡å®šå¯¹åº”çš„keyå’Œvalueçš„åºåˆ—åŒ–ç±»å‹ key.serializer
    properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
    properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());

    // 1 åˆ›å»ºkafkaç”Ÿäº§è€…å¯¹è±¡
    KafkaProducer<String, String> kafkaProducer = new KafkaProducer<>(properties);

    // 2 å‘é€æ•°æ®
    for (int i = 0; i < 5; i++) {
      kafkaProducer.send(new ProducerRecord<>("first","silince"+i));
    }

    // 3 å…³é—­èµ„æº
    kafkaProducer.close();
  }
}
```

### å¸¦å›è°ƒå‡½æ•°çš„å¼‚æ­¥å‘é€

å›è°ƒå‡½æ•°ä¼šåœ¨ producer æ”¶åˆ° ack æ—¶è°ƒç”¨ï¼Œä¸ºå¼‚æ­¥è°ƒç”¨ï¼Œè¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯å…ƒæ•°æ®ä¿¡æ¯(RecordMetadata)å’Œå¼‚å¸¸ä¿¡æ¯(Exception)ï¼Œå¦‚æœ Exception ä¸º nullï¼Œè¯´æ˜æ¶ˆæ¯å‘é€æˆåŠŸï¼Œå¦‚æœ Exception ä¸ä¸º nullï¼Œè¯´æ˜æ¶ˆæ¯å‘é€å¤±è´¥ã€‚

âš ï¸ï¼šæ¶ˆæ¯å‘é€å¤±è´¥ä¼šè‡ªåŠ¨é‡è¯•ï¼Œä¸éœ€è¦æˆ‘ä»¬åœ¨å›è°ƒå‡½æ•°ä¸­æ‰‹åŠ¨é‡è¯•ã€‚

```java
kafkaProducer.send(new ProducerRecord<>("first", "silince" + i), new Callback() {
  @Override
  public void onCompletion(RecordMetadata recordMetadata, Exception e) {
    if (e==null){
      System.out.println("ä¸»é¢˜: "+recordMetadata.topic()+" åˆ†åŒº: "+recordMetadata.partition());
    }
  }
```



## åŒæ­¥å‘é€ **API**

åŒæ­¥å‘é€(å½“å‰batchå…¨éƒ¨æ­£å¸¸ackä¹‹åå†è½½å…¥ä¸‹ä¸€æ‰¹å¤–éƒ¨æ•°æ®)åªéœ€åœ¨å¼‚æ­¥å‘é€çš„åŸºç¡€ä¸Šï¼Œå†è°ƒç”¨ä¸€ä¸‹ get()æ–¹æ³•å³å¯ã€‚

```java
/**
 * kafka ç”Ÿäº§è€…
 *
 * @author zhongye
 * @since 2022.04.26
 */
public class CustomProducer {
  public static void main(String[] args) throws Exception {
    // 0 é…ç½®
    Properties properties = new Properties();
    // è¿æ¥é›†ç¾¤ bootstrap.servers
    properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,"localhost:9092");
    // æŒ‡å®šå¯¹åº”çš„keyå’Œvalueçš„åºåˆ—åŒ–ç±»å‹ key.serializer
    properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
    properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());

    // 1 åˆ›å»ºkafkaç”Ÿäº§è€…å¯¹è±¡
    KafkaProducer<String, String> kafkaProducer = new KafkaProducer<>(properties);

    // 2 å‘é€æ•°æ®
    for (int i = 0; i < 5; i++) {
      kafkaProducer.send(new ProducerRecord<>("first", "silince" + i)).get();
    }

    // 3 å…³é—­èµ„æº
    kafkaProducer.close();
  }
}
```



## åˆ†åŒºç­–ç•¥

> [Kafka åˆ†åŒº](http://www.silince.cn/2021/08/26/Kafka-%E5%88%86%E5%8C%BA/)



## ç”Ÿäº§ç»éªŒ

### å¦‚ä½•æé«˜ååé‡

- batch.sizeï¼šæ‰¹æ¬¡å¤§å°, é»˜è®¤16k 
- linger.msï¼šç­‰å¾…æ—¶é—´,ä¿®æ”¹ä¸º5-100ms(å¤ªå¤§çš„è¯ä¼šå¯¼è‡´ä¸‹ä¸€æ‰¹æ•°æ®çš„å»¶è¿Ÿè¿‡é«˜)
- compression.typeï¼šå‹ç¼©snappy
- RecordAccumulatorï¼šç¼“å†²åŒºå¤§å°,ä¿®æ”¹ä¸º64m

```java
// 1. åˆ›å»º kafka ç”Ÿäº§è€…çš„é…ç½®å¯¹è±¡
Properties properties = new Properties();
// 2. ç»™ kafka é…ç½®å¯¹è±¡æ·»åŠ é…ç½®ä¿¡æ¯:bootstrap.servers
properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
// key,value åºåˆ—åŒ–(å¿…é¡»):key.serializerï¼Œvalue.serializer
properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
// batch.size:æ‰¹æ¬¡å¤§å°ï¼Œé»˜è®¤16K 
properties.put(ProducerConfig.BATCH_SIZE_CONFIG, 16384);
// linger.ms:ç­‰å¾…æ—¶é—´ï¼Œé»˜è®¤ 0 
properties.put(ProducerConfig.LINGER_MS_CONFIG, 1);
// RecordAccumulator:ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤ 32M:buffer.memory 
properties.put(ProducerConfig.BUFFER_MEMORY_CONFIG,33554432);
// compression.type:å‹ç¼©ï¼Œé»˜è®¤ noneï¼Œå¯é…ç½®å€¼ gzipã€snappyã€ lz4 å’Œ zstd
properties.put(ProducerConfig.COMPRESSION_TYPE_CONFIG,"snappy");
```



### æ•°æ®å¯é æ€§

1ï¼‰ACKSåº”ç­”çº§åˆ«

- 0:ç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ•°æ®ï¼Œä¸éœ€è¦ç­‰æ•°æ®è½ç›˜åº”ç­”(å¯é æ€§å·®ï¼Œæ•ˆç‡é«˜)

  ![image-20220428143600531](/Users/silince/Develop/åšå®¢/blog_to_git/assets/imgs/image-20220428143600531.png)

- 1:ç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ•°æ®ï¼Œ**Leader**æ”¶åˆ°æ•°æ®ååº”ç­”(å¯é æ€§ä¸­ç­‰ï¼Œæ•ˆç‡ä¸­ç­‰)

  ![image-20220428143612384](/Users/silince/Develop/åšå®¢/blog_to_git/assets/imgs/image-20220428143612384.png)

- -1(all):ç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ•°æ®ï¼Œ**Leader**å’Œ**ISR**é˜Ÿåˆ—é‡Œé¢ çš„æ‰€æœ‰èŠ‚ç‚¹æ”¶é½æ•°æ®ååº”ç­”(**å¯é æ€§é«˜ï¼Œæ•ˆç‡ä½;åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œacks=0å¾ˆå°‘ä½¿ç”¨;acks=1ï¼Œä¸€èˆ¬ç”¨äºä¼ è¾“æ™®é€šæ—¥å¿—ï¼Œå…è®¸ä¸¢ä¸ªåˆ«æ•°æ®;acks=-1ï¼Œä¸€èˆ¬ç”¨äºä¼ è¾“å’Œé’±ç›¸å…³çš„æ•°æ®ï¼Œ å¯¹å¯é æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯**)

  ![image-20220428143629255](/Users/silince/Develop/åšå®¢/blog_to_git/assets/imgs/image-20220428143629255.png)

> ğŸ¤” å½“acks=-1æ—¶ï¼ŒLeaderæ”¶åˆ°æ•°æ®ï¼Œæ‰€æœ‰Followeréƒ½å¼€å§‹åŒæ­¥æ•°æ®ï¼Œ ä½†æœ‰ä¸€ä¸ªFollowerï¼Œå› ä¸ºæŸç§æ•…éšœï¼Œè¿Ÿè¿Ÿä¸èƒ½ä¸Leaderè¿›è¡Œ åŒæ­¥ï¼Œé‚£è¿™ä¸ªé—®é¢˜æ€ä¹ˆè§£å†³å‘¢?

**Leaderç»´æŠ¤äº†ä¸€ä¸ªåŠ¨æ€çš„in-sync replica set(ISR)ï¼Œæ„ä¸ºå’Œ Leaderä¿æŒåŒæ­¥çš„Follower+Leaderé›†åˆ(leader:0ï¼Œisr:0,1,2)ã€‚**

**å¦‚æœFolloweré•¿æ—¶é—´æœªå‘Leaderå‘é€é€šä¿¡è¯·æ±‚æˆ–åŒæ­¥æ•°æ®ï¼Œåˆ™è¯¥Followerå°†è¢«è¸¢å‡ºISRã€‚è¯¥æ—¶é—´é˜ˆå€¼ç”±replica.lag.time.max.mså‚æ•°è®¾å®šï¼Œé»˜è®¤30sã€‚ä¾‹å¦‚2è¶…æ—¶ï¼Œè¿™ISRå˜ä¸º(leader:0, isr:0,1)ã€‚è¿™æ ·å°±ä¸ç”¨ç­‰é•¿æœŸè”ç³»ä¸ä¸Šæˆ–è€…å·²ç»æ•…éšœçš„èŠ‚ç‚¹ã€‚**

**æ•°æ®å¯é æ€§åˆ†æ:**å¦‚æœåˆ†åŒºå‰¯æœ¬è®¾ç½®ä¸º1ä¸ªï¼Œæˆ–è€…ISRé‡Œåº”ç­”çš„æœ€å°å‰¯æœ¬æ•°é‡ ( min.insync.replicas é»˜è®¤ä¸º1)è®¾ç½®ä¸º1ï¼Œå’Œack=1çš„æ•ˆæœæ˜¯ä¸€ æ ·çš„ï¼Œä»ç„¶æœ‰ä¸¢æ•°çš„é£é™©(leader:0ï¼Œisr:0)ã€‚

å› æ­¤==**æ•°æ®å®Œå…¨å¯é æ¡ä»¶ = ACKçº§åˆ«è®¾ç½®ä¸º-1 + åˆ†åŒºå‰¯æœ¬å¤§äºç­‰äº2 + ISRé‡Œåº”ç­”çš„æœ€å°å‰¯æœ¬æ•°é‡å¤§äºç­‰äº**2==



2ï¼‰ä»£ç é…ç½®

```java
// 0 é…ç½®
Properties properties = new Properties();
// è¿æ¥é›†ç¾¤ bootstrap.servers
properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,"localhost:9092");
// æŒ‡å®šå¯¹åº”çš„keyå’Œvalueçš„åºåˆ—åŒ–ç±»å‹ key.serializer
properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());

// acks + é‡è¯•æ¬¡æ•°
properties.put(ProducerConfig.ACKS_CONFIG,"1");
properties.put(ProducerConfig.RETRIES_CONFIG,3);
```





### æ•°æ®é‡å¤

acks: **-1**(**all**):ç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ•°æ®ï¼Œ**Leader**å’Œ**ISR**é˜Ÿåˆ—é‡Œé¢çš„æ‰€æœ‰èŠ‚ç‚¹æ”¶é½æ•°æ®ååº”ç­”ã€‚å¦‚æœLeaderåŒæ­¥æ•°æ®ä¹‹åï¼Œæ²¡æ¥å¾—åŠç¡®è®¤ackå°±æŒ‚æ‰äº†ï¼Œåˆ™æ–°é€‰ä¸¾çš„Leaderåˆ™ä¼šåˆæ”¶åˆ°ä¸€ä»½é‡å¤æ•°æ®ã€‚

![image-20220428153413825](/Users/silince/Develop/åšå®¢/blog_to_git/assets/imgs/image-20220428153413825.png)

1ï¼‰æ•°æ®ä¼ é€’è¯­ä¹‰

- è‡³å°‘ä¸€æ¬¡(**At Least Once**)=ACKçº§åˆ«è®¾ç½®ä¸º-1**+**åˆ†åŒºå‰¯æœ¬å¤§äºç­‰äº2**+**ISRé‡Œåº”ç­”çš„æœ€å°å‰¯æœ¬æ•°é‡å¤§äºç­‰äº2 ã€‚å¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸é‡å¤; 
- æœ€å¤šä¸€æ¬¡(**At Most Once**)**=**ACKçº§åˆ«è®¾ç½®ä¸º0ã€‚å¯ä»¥ä¿è¯æ•°æ®ä¸é‡å¤ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚

- ç²¾ç¡®ä¸€æ¬¡(**Exactly Once**):å¯¹äºä¸€äº›éå¸¸é‡è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å’Œé’±ç›¸å…³çš„æ•°æ®ï¼Œè¦æ±‚æ•°æ®æ—¢ä¸èƒ½é‡å¤ä¹Ÿä¸ä¸¢å¤±ã€‚ 

Kafka 0.11ç‰ˆæœ¬ä»¥åï¼Œå¼•å…¥äº†ä¸€é¡¹é‡å¤§ç‰¹æ€§:å¹‚ç­‰æ€§å’Œäº‹åŠ¡ã€‚



2ï¼‰å¹‚ç­‰æ€§

å¹‚ç­‰æ€§å°±æ˜¯æŒ‡Producerä¸è®ºå‘Brokerå‘é€å¤šå°‘æ¬¡é‡å¤æ•°æ®ï¼ŒBrokerç«¯éƒ½åªä¼šæŒä¹…åŒ–ä¸€æ¡ï¼Œä¿è¯äº†ä¸é‡å¤ã€‚ ç²¾ç¡®ä¸€æ¬¡(**Exactly Once**) **=** å¹‚ç­‰æ€§ **+** è‡³å°‘ä¸€æ¬¡( **ack=-1 +** åˆ†åŒºå‰¯æœ¬æ•°**>=2 + ISR**æœ€å°å‰¯æœ¬æ•°é‡**>=2**) ã€‚

é‡å¤æ•°æ®çš„åˆ¤æ–­æ ‡å‡†:å…·æœ‰<PID, Partition, SeqNumber>ç›¸åŒä¸»é”®çš„æ¶ˆæ¯æäº¤æ—¶ï¼ŒBrokeråªä¼šæŒä¹…åŒ–ä¸€æ¡ã€‚å…¶ ä¸­PIDæ˜¯Kafkaæ¯æ¬¡é‡å¯éƒ½ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„;Partition è¡¨ç¤ºåˆ†åŒºå·;Sequence Numberæ˜¯å•è°ƒè‡ªå¢çš„ã€‚

æ‰€ä»¥å¹‚ç­‰æ€§åªèƒ½ä¿è¯çš„æ˜¯åœ¨å•åˆ†åŒºå•ä¼šè¯å†…ä¸é‡å¤ã€‚
