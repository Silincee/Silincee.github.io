---
layout: post
title: "AOPçš„æ‰§è¡Œé¡ºåº"
date: 2021-05-06 11:21:16 +0800--
categories: [Java]
tags: [Spring, AOP,]  
---

# å‰è¨€

ä¹‹å‰é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°AOPçš„æ‰§è¡Œé¡ºåºï¼Œå½“æ—¶æ»¡è„‘å­éƒ½æ˜¯Spring4å’ŒSpring5çš„æ‰§è¡Œé¡ºåºå·®åˆ«ï¼Œå¯¹äºåµŒå¥—çš„å¤šä¸ªåˆ‡é¢çš„æ‰§è¡Œé¡ºåºå®Œå…¨ä¸çŸ¥ï¼Œä¸€å‰¯ä¸å¤§èªæ˜çš„æ ·å­ğŸ˜ã€‚ç‰¹æ­¤å¥½å¥½æ¢³ç†ä¸€ä¸‹è¿™æ–¹é¢çš„çŸ¥è¯†ï¼Œä¸»è¦æ¢è®¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. å•ä¸ªåˆ‡é¢ä¸­æ ¸å¿ƒæ–¹æ³•æ‰§è¡Œé¡ºåºï¼Ÿ
2. å¤šä¸ªåˆ‡é¢ä¸­æ–¹æ³•çš„æ‰§è¡Œé¡ºåºï¼Ÿ
3. å¦‚ä½•æ§åˆ¶å¤šä¸ªåˆ‡é¢çš„æ‰§è¡Œé¡ºåºï¼Ÿ
4. AOPåµŒå¥—è°ƒç”¨ä¸ºä»€ä¹ˆä¼šå¯¼è‡´å¤±æ•ˆï¼Ÿ

é¢è¯•çš„é—®é¢˜ï¼šä¸‹å›¾ä¸­çš„Xã€Yç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½é…ç½®äº†AOPçš„å‰ç½®é€šçŸ¥å’Œåç½®é€šçŸ¥ï¼Œè¯·é—®ç°åœ¨è°ƒç”¨æ–¹æ³•aï¼Œæ±‚é€šçŸ¥çš„æ‰“å°é¡ºåºã€‚

```java
class X{
  @Autowired
  Y y;
  
  public void a(){
    y.b();
  }
}

class Y{
  public void b(){
    this.c();
  }
  
  public void c(){
    // do something
  }
}
```

é¦–å…ˆå›é¡¾ä¸€ä¸‹AOPçš„é€šçŸ¥ç±»å‹ï¼š

- @Beforeï¼šå‰ç½®é€šçŸ¥: ç›®æ ‡æ–¹æ³•ä¹‹å‰æ‰§è¡Œ
- @AfterReturningï¼šè¿”å›åé€šçŸ¥: æ‰§è¡Œæ–¹æ³•ç»“æŸå‰æ‰§è¡Œ(å¼‚å¸¸ä¸æ‰§è¡Œ)
- @Afterï¼šåç½®é€šçŸ¥: ç›®æ ‡æ–¹æ³•ä¹‹åæ‰§è¡Œï¼ˆå§‹ç»ˆæ‰§è¡Œï¼‰
- @AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥: å‡ºç°å¼‚å¸¸æ—¶å€™æ‰§è¡Œ
- @Aroundï¼šç¯ç»•é€šçŸ¥: ç¯ç»•ç›®æ ‡æ–¹æ³•æ‰§è¡Œ



# å¤šä¸ªAOPçš„æ‰§è¡Œé¡ºåº

## å•ä¸ªåˆ‡é¢ä¸­æ ¸å¿ƒæ–¹æ³•æ‰§è¡Œé¡ºåº

é€šè¿‡ä»¥ä¸‹ä»£ç æ¥éªŒè¯å•ä¸ªåˆ‡é¢ä¸­æ ¸å¿ƒæ–¹æ³•æ‰§è¡Œé¡ºåº(æŸ¥é˜…äº†è®¸å¤šèµ„æ–™ï¼Œå„ä¸ªç‰ˆæœ¬ä¹‹é—´å˜åŒ–å¥½å¤šå•ŠğŸ˜­ï¼Œåœ¨æ­¤è®°å½•çš„æ˜¯Spring Boot 2.3.4.RELEASE)ï¼š

```java
/**
 * æ‰€æœ‰è¯·æ±‚çš„åˆ‡é¢
 */
@Aspect
@Component
public class RequestAspect {

  @Pointcut("@annotation(org.springframework.web.bind.annotation.GetMapping)")
  public void pointCut() {
  }

  /**
     * å½“å®šä¹‰ä¸€ä¸ªAroundå¢å¼ºå¤„ç†æ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå½¢å‚å¿…é¡»æ˜¯ProceedJoinPointç±»å‹ï¼ˆè‡³å°‘å«æœ‰ä¸€ä¸ªå½¢å‚ï¼‰ï¼Œåœ¨å¢å¼ºå¤„ç†æ–¹æ³•ä½“å†…ï¼Œè°ƒç”¨ProceedingJoinPointå‚æ•°çš„procedd()æ–¹æ³•æ‰ä¼šæ‰§è¡Œç›®æ ‡æ–¹æ³•â€”â€”è¿™å°±æ˜¯Aroundå¢å¼ºå¤„ç†å¯ä»¥å®Œå…¨æ§åˆ¶æ–¹æ³•çš„æ‰§è¡Œæ—¶æœºã€å¦‚ä½•æ‰§è¡Œçš„å…³é”®ï¼›å¦‚æœç¨‹åºæ²¡æœ‰è°ƒç”¨ProceedingJoinPointå‚æ•°çš„proceed()æ–¹æ³•ï¼Œåˆ™ç›®æ ‡æ–¹æ³•ä¸ä¼šè¢«æ‰§è¡Œã€‚ä¸‹é¢å®šä¹‰ä¸€ä¸ªAroundå¢å¼ºå¤„ç†ã€‚
     */
  @Around("pointCut()")
  public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
    System.out.println("R1-around-start");
    //æ­¤å¤„å¿…é¡»å°†ç»“æœè·å–åè¿”å›æ‰ä¼šæ­£å¸¸å¯¹ä»£ç è¿›è¡Œæ‰§è¡Œ
    Object obj = joinPoint.proceed();
    System.out.println("R1-around-end");
    return Convert.toStr(obj) + "123";
  }

  @Before("pointCut()")
  public void before(JoinPoint joinPoint) {
    System.out.println("R1-before");
  }

  /**
     * Afterå¢å¼ºå¤„ç†ä¸ç®¡ç›®æ ‡æ–¹æ³•å¦‚ä½•ç»“æŸï¼ˆåŒ…æ‹¬æˆåŠŸå®Œæˆå’Œé‡åˆ°å¼‚å¸¸ä¸­æ­¢ä¸¤ç§æƒ…å†µï¼‰ï¼Œå®ƒéƒ½ä¼šè¢«ç»‡å…¥ã€‚
     */
  @After("pointCut()")
  public void after(JoinPoint joinPoint) {
    System.out.println("R1-after");
  }

  @AfterReturning("pointCut()")
  public void afterReturing(JoinPoint point) {
    System.out.println("R1-afterReturing");
    //return returnValue;
  }

  /**
     * æ€ä¹ˆè·å–æ˜¯å“ªä¸€ç±»å¼‚å¸¸ï¼Ÿ
     */
  @AfterThrowing("pointCut()ut()")
  public void afterThrowing(JoinPoint joinPoint) {
    System.out.println("R1-afterThrowing");
  }
}
```

æ‰§è¡Œç»“æœï¼š

```java
// æ­£å¸¸æƒ…å†µä¸‹
R1-around-start
R1-before
method invoke // è°ƒç”¨çš„è¢«åˆ‡çš„æ–¹æ³•çš„è¾“å‡ºç»“æœã€‚
R1-afterReturing
R1-after
R1-around-end
// å¼‚å¸¸æƒ…å†µä¸‹
R1-around-start
R1-before
method invoke 
R1-afterThrowing
R1-after
```

psï¼šSpring boot 2.3.4.RELEASE ç‰ˆæœ¬ä½¿ç”¨çš„AOPæ˜¯spring-aop-5.2.9.RELEASEï¼ŒAOPçš„é€šçŸ¥é¡ºåºä¸Spring boot 2.1.1.RELEASE ä¸ä¸€æ ·ã€‚ä¸»è¦æ³¨æ„å‡ ç‚¹ï¼š

- å¦‚æœæ­£å¸¸æ‰§è¡Œçš„è¯ï¼Œé‚£å°±æ˜¯ä»¥AOPå¼€å§‹ï¼Œä»¥AOPæ”¶å°¾ï¼Œ@Afteråœ¨@AfterReturnä¹‹åï¼Œå¯ä»¥ç†è§£ä¸º@Afteråœ¨finalä¸­ï¼Œ@AfterReturnæ˜¯è¿”å›å€¼ã€‚
- å¦‚æœæ‰§è¡Œè¿‡ç¨‹å‡ºç°å¼‚å¸¸çš„è¯ï¼Œè¿æ¥ç‚¹åå°±å˜ä¸º@AfterThrowingï¼Œç„¶åç´§è·Ÿ@After(å¯ä»¥ç†è§£ä¸ºfinalå—ä¸­ä¸€å®šæ‰§è¡Œã€‚)

![image-20210509174111790](/assets/imgs/image-20210509174111790-0553301.png)





## å¦‚ä½•æ§åˆ¶å¤šä¸ªAOP åˆ‡é¢çš„æ‰§è¡Œé¡ºåº

### æ³¨è§£ï¼ˆæ¨èï¼‰

`@Order(value)`å…¶ä¸­valueçš„å€¼è¶Šå°ï¼Œæ‰§è¡Œé¡ºåºè¶Šé å‰ã€‚

```java
@Order(100)
@Aspect
@Component
public class RequestAspect {}
```





### å®ç°æ¥å£

å®ç°æ¥å£`org.springframework.core.Ordered` ç§çš„`getOrder()`æ–¹æ³•ã€‚ä¹Ÿæ˜¯valueå€¼è¶Šå°ï¼Œæ‰§è¡Œé¡ºåºè¶Šé å‰ã€‚

```java
@Aspect
@Component
public class RequestAspect implements Ordered {
  
  @Override
  public int getOrder() {
    return 0;
  }
}
```





## åŒä¸€ä¸ªæ–¹æ³•çš„å¤šä¸ªåˆ‡é¢ä¸­æ–¹æ³•çš„æ‰§è¡Œé¡ºåº

è¿˜æ˜¯ç”¨ä»£ç æ¥éªŒè¯ï¼Œåˆ‡é¢1ï¼š

```java
@Order(1)
@Aspect
@Component
public class RequestAspect1 {

    @Pointcut("@annotation(org.springframework.web.bind.annotation.GetMapping)")
    public void pointCut() {
    }

    @Around("pointCut()")
    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
        System.out.println("R1-around-start");
        Object obj = joinPoint.proceed();
        System.out.println("R1-around-end");
        return Convert.toStr(obj) + "123";
    }

    @Before("pointCut()")
    public void before(JoinPoint joinPoint) {
        System.out.println("R1-before");
    }


    @After("pointCut()")
    public void after(JoinPoint joinPoint) {
        System.out.println("R1-after");
    }

    @AfterReturning("pointCut()")
    public void afterReturing(JoinPoint point) {
        System.out.println("R1-afterReturing");
        //return returnValue;
    }

    @AfterThrowing("pointCut()")
    public void afterThrowing(JoinPoint joinPoint) {
        System.out.println("R1-afterThrowing");
    }
}
```

åˆ‡é¢2:

```java
@Order(100)
@Aspect
@Component
public class RequestAspect2  {

    @Pointcut("@annotation(org.springframework.web.bind.annotation.GetMapping)")
    public void pointCut() {
    }

    @Around("pointCut()")
    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
        System.out.println("R2-around-start");
        Object obj = joinPoint.proceed();
        System.out.println("R2-around-end");
        return Convert.toStr(obj) + "123";
    }

    @Before("pointCut()")
    public void before(JoinPoint joinPoint) {
        System.out.println("R2-before");
    }

    @After("pointCut()")
    public void after(JoinPoint joinPoint) {
        System.out.println("R2-after");
    }

    @AfterReturning("pointCut()")
    public void afterReturing(JoinPoint point) {
        System.out.println("R2-afterReturing");
    }

    @AfterThrowing("pointCut()")
    public void afterThrowing(JoinPoint joinPoint) {
        System.out.println("R2-afterThrowing");
    }
}
```

æ‰§è¡Œç»“æœï¼š

```java
R1-around-start
R1-before
R2-around-start
R2-before
method invoke
R2-afterReturing
R2-after
R2-around-end
R1-afterReturing
R1-after
R1-around-end
```

ä»ä¸Šé¢çš„æµ‹è¯•æˆ‘ä»¬çœ‹åˆ°ï¼Œç¡®å®æ˜¯orderè¶Šå°è¶Šæ˜¯æœ€å…ˆæ‰§è¡Œï¼Œä½†æ›´é‡è¦çš„æ˜¯æœ€å…ˆæ‰§è¡Œçš„æœ€åç»“æŸã€‚

è¿™ä¸ªä¸éš¾ç†è§£ï¼ŒSpring AOPå°±æ˜¯é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œä»€ä¹ˆæ˜¯åˆ‡é¢ï¼Œç”»ä¸€ä¸ªå›¾æ¥ç†è§£ä¸‹ï¼š

![image-20210509194544505](/assets/imgs/image-20210509194544505.png)

ç”±æ­¤å¾—å‡ºï¼šspring aopå°±æ˜¯ä¸€ä¸ªåŒå¿ƒåœ†ï¼Œè¦æ‰§è¡Œçš„æ–¹æ³•ä¸ºåœ†å¿ƒï¼Œæœ€å¤–å±‚çš„orderæœ€å°ã€‚ä»æœ€å¤–å±‚æŒ‰ç…§AOP1ã€AOP2çš„é¡ºåºä¾æ¬¡æ‰§è¡ŒAroundæ–¹æ³•ï¼ŒBeforeæ–¹æ³•ã€‚ç„¶åæ‰§è¡Œmethodæ–¹æ³•ï¼Œæœ€åæŒ‰ç…§AOP2ã€AOP1çš„é¡ºåºä¾æ¬¡æ‰§è¡ŒAfterReturnã€Afterã€Aroundæ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´å¯¹å¤šä¸ªAOPæ¥è¯´ï¼Œå…ˆbeforeçš„ï¼Œä¸€å®šåafterã€‚**R1æ‰§è¡Œ`Around`å’Œ`Before`çš„æ—¶å€™æŠŠR2å½“æˆä¸€ä¸ªæ•´ä½“è¿›è¡Œï¼Œå½“R2æ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šæ‰§è¡ŒR1åç»­çš„ã€‚**





# AOPåµŒå¥—è°ƒç”¨

## AOPå¤±æ•ˆäº†ï¼Ÿ

**Spring AOPåŒä¸€ä¸ªå¯¹è±¡å†…éƒ¨åµŒå¥—è°ƒç”¨èƒ½ç”Ÿæ•ˆå—ï¼Ÿ**

å¦‚ä¸‹ï¼Œæ–¹æ³•helloå†…éƒ¨è°ƒç”¨æ–¹æ³•goodbyeï¼ŒåŒæ—¶ï¼Œæ–¹æ³•helloå’Œgoodbyeéƒ½åšäº†å¢å¼ºã€‚

```java
public class AOPInvalidDemo {
  public void hello() {
    System.out.println("Hello,IOC");
    goodbye();
  }
  public void goodbye() {
    System.out.println("Goodbye");
  }
}
```

```java
@Pointcut("execution(public * io.github.silince.spring.core.aop.example.IOCServiceImpl.hello(..))")
public void testAOP1(){
}

@Around("testAOP1()")
public Object around(ProceedingJoinPoint p){
  System.out.println("around before testAOP1...");
  Object o = null;
  try {
    o = p.proceed();
  } catch (Throwable e) {
    e.printStackTrace();
  }
  System.out.println("around after testAOP1...");
  return o;
}
```

```java
@Pointcut("execution(public * io.github.silince.spring.core.aop.example.IOCServiceImpl.goodbye(..))")
public void testAOP2(){
}

@Around("testAOP2()")
public void around(ProceedingJoinPoint p){
  System.out.println("around before testAOP2...");
  Object o = null;
  try {
    p.proceed();
  } catch (Throwable e) {
    e.printStackTrace();
  }
  System.out.println("around after testAOP2...");
  return o;
}
```

è°ƒç”¨helloæ–¹æ³•æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ

åªæœ‰helloæ–¹æ³•è¢«å¢å¼ºäº†ï¼Œgoodbyeæ–¹æ³•ç›´æ¥è¢«è°ƒç”¨ï¼Œå¹¶æ²¡æœ‰è¢«å¢å¼ºã€‚è¾“å‡ºå¦‚ä¸‹ï¼š

```java
around before testAOP1...
Hello,IOC
Goodbye
around after testAOP1...
```



## ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ

è¿™ç§ç»“æœçš„å‡ºç°ï¼Œå½’æ ¹ç»“åº•æ˜¯ç”±Spring AOPçš„å®ç°æœºåˆ¶é€ æˆçš„ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒSpring AOPé‡‡ç”¨ä»£ç†æ¨¡å¼å®ç°AOPï¼Œå…·ä½“çš„æ¨ªåˆ‡é€»è¾‘ä¼šè¢«æ·»åŠ åˆ°åŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ä¸­ï¼Œåªè¦è°ƒç”¨çš„æ˜¯ç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ä¸Šçš„æ–¹æ³•ï¼Œé€šå¸¸å°±å¯ä»¥ä¿è¯ç›®æ ‡å¯¹è±¡ä¸Šçš„æ–¹æ³•å¯ä»¥è¢«æ‹¦æˆªã€‚å°±åƒAOPInvalidDemoä¸­çš„`hello()`æ–¹æ³•æ‰§è¡Œä¸€æ ·ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ä»£ç†å¯¹è±¡ä¸Šçš„`hello()`æ—¶ï¼Œç›®æ ‡å¯¹è±¡çš„`hello()`å°±ä¼šè¢«æˆåŠŸæ‹¦æˆªã€‚

åœ¨ä»£ç†å¯¹è±¡æ–¹æ³•ä¸­ï¼Œä¸ç®¡å¦‚ä½•æ·»åŠ æ¨ªåˆ‡é€»è¾‘ï¼Œä¹Ÿä¸ç®¡æ·»åŠ å¤šå°‘æ¨ªåˆ‡é€»è¾‘ï¼Œæœ‰ä¸€ç‚¹æ˜¯ç¡®å®šçš„ã€‚é‚£å°±æ˜¯ï¼Œ**ç»ˆå½’éœ€è¦è°ƒç”¨ç›®æ ‡å¯¹è±¡ä¸Šçš„åŒä¸€æ–¹æ³•æ¥æ‰§è¡Œæœ€åˆæ‰€å®šä¹‰çš„æ–¹æ³•é€»è¾‘ã€‚**

**å¦‚æœç›®æ ‡å¯¹è±¡ä¸­åŸå§‹æ–¹æ³•è°ƒç”¨ä¾èµ–äºå…¶ä»–å¯¹è±¡ï¼Œé‚£æ²¡é—®é¢˜ï¼Œ**æˆ‘ä»¬å¯ä»¥ä¸ºç›®æ ‡å¯¹è±¡æ³¨å…¥æ‰€ä¾èµ–å¯¹è±¡çš„ä»£ç†ï¼Œå¹¶ä¸”å¯ä»¥ä¿è¯ç›¸åº”Joinpointè¢«æ‹¦æˆªå¹¶ç»‡å…¥æ¨ªåˆ‡é€»è¾‘ã€‚**è€Œä¸€æ—¦ç›®æ ‡å¯¹è±¡ä¸­çš„åŸå§‹æ–¹æ³•è°ƒç”¨ç›´æ¥è°ƒç”¨è‡ªèº«æ–¹æ³•çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¾èµ–äºè‡ªèº«æ‰€å®šä¹‰çš„å…¶ä»–æ–¹æ³•çš„æ—¶å€™ï¼Œé—®é¢˜å°±æ¥äº†ï¼Œçœ‹ä¸‹é¢çš„å›¾ä¼šæ›´æ¸…æ¥š:**

![img](/assets/imgs/1335887-20200608162233208-753663558.png)

ğŸ¤” åœ¨ä»£ç†å¯¹è±¡çš„method1æ–¹æ³•æ‰§è¡Œç»å†äº†å±‚å±‚æ‹¦æˆªå™¨ä¹‹åï¼Œæœ€ç»ˆä¼šå°†è°ƒç”¨è½¬å‘ç›®æ ‡å¯¹è±¡ä¸Šçš„method1ï¼Œä¹‹åçš„è°ƒç”¨æµç¨‹å…¨éƒ¨æ˜¯èµ°åœ¨TargetObjectä¹‹ä¸Šï¼Œå½“method1è°ƒç”¨method2æ—¶ï¼Œå®ƒè°ƒç”¨çš„æ˜¯TargetObjectä¸Šçš„method2ï¼Œè€Œä¸æ˜¯ProxyObjectä¸Šçš„method2ã€‚è¦çŸ¥é“ï¼Œé’ˆå¯¹method2çš„æ¨ªåˆ‡é€»è¾‘ï¼Œåªç»‡å…¥åˆ°äº†ProxyObjectä¸Šçš„method2æ–¹æ³•ä¸­ï¼Œæ‰€ä»¥ï¼Œåœ¨method1ä¸­æ‰€è°ƒç”¨çš„method2æ²¡æœ‰èƒ½å¤Ÿè¢«æˆåŠŸæ‹¦æˆªã€‚



## è§£å†³æ–¹æ¡ˆ

å½“ç›®æ ‡å¯¹è±¡ä¾èµ–äºå…¶ä»–å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸ºç›®æ ‡æ³¨å…¥ä¾èµ–å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œæ¥è§£å†³ç›¸åº”çš„æ‹¦æˆªé—®é¢˜ã€‚**é‚£ä¹ˆï¼Œå½“ç›®æ ‡å¯¹è±¡ä¾èµ–äºè‡ªèº«æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°è¯•å°†ç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡å…¬å¼€ç»™å®ƒï¼Œåªè¦è®©ç›®æ ‡å¯¹è±¡è°ƒç”¨è‡ªèº«ä»£ç†å¯¹è±¡ä¸Šçš„ç›¸åº”æ–¹æ³•ï¼Œå°±å¯ä»¥è§£å†³å†…éƒ¨è°ƒç”¨çš„æ–¹æ³•æ²¡æœ‰è¢«æ‹¦æˆªçš„é—®é¢˜ã€‚**

Spring AOPæä¾›äº†AopContext æ¥å…¬å¼€å½“å‰ç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œæˆ‘ä»¬åªè¦åœ¨ç›®æ ‡å¯¹è±¡ä¸­ä½¿ç”¨`AopContext.currentProxy()`å°±å¯ä»¥å–å¾—å½“å‰ç›®æ ‡å¯¹è±¡æ‰€å¯¹åº”çš„ä»£ç†å¯¹è±¡ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬é‡æ„ç›®æ ‡å¯¹è±¡ï¼Œè®©å®ƒç›´æ¥è°ƒç”¨å®ƒçš„ä»£ç†å¯¹è±¡çš„ç›¸åº”æ–¹æ³•ï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼š

```java
public class AOPInvalidDemo {
  public void hello() {
    System.out.println("Hello,IOC");
    ((AOPInvalidDemo)AopContext.currentProxy()).goodbye();
  }
  public void goodbye() {
    System.out.println("Goodbye");
  }
}
```

è¦ä½¿`AopContext.currentProxy()`ç”Ÿæ•ˆï¼Œæˆ‘ä»¬åœ¨ç”Ÿæˆç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡æ—¶ï¼Œéœ€è¦è®¾ç½®`expose-proxy`ä¸ºtrueï¼Œå…·ä½“å¦‚ä¸‹è®¾ç½®ï¼š

```java
@EnableAspectJAutoProxy(proxyTargteClass = true, exposeProxy = true)
```

è¿™ç§æ–¹å¼æ˜¯å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç›®æ ‡å¯¹è±¡éƒ½ç›´æ¥ç»‘å®šåˆ°äº†Spring AOPçš„å…·ä½“APIä¸Šäº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è€ƒè™‘èƒ½å¤Ÿé€šè¿‡å…¶ä»–æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ—¢ç„¶æˆ‘ä»¬çŸ¥é“èƒ½å¤Ÿé€šè¿‡`AopContext.currentProxy()`å–å¾—å½“å‰ç›®æ ‡å¯¹è±¡å¯¹åº”çš„ä»£ç†å¯¹è±¡ï¼Œé‚£å®Œå…¨å¯ä»¥åœ¨ç›®æ ‡å¯¹è±¡ä¸­å£°æ˜å¯¹å…¶ä»£ç†å¯¹è±¡çš„ä¾èµ–ï¼Œé€šè¿‡IOCå®¹å™¨æ¥å¸®åŠ©æˆ‘ä»¬æ³¨å…¥è¿™ä¸ªä»£ç†å¯¹è±¡ã€‚æ³¨å…¥æ–¹å¼å¯ä»¥æœ‰å¤šç§ï¼š

- å¯ä»¥åœ¨ç›®æ ‡å¯¹è±¡ä¸­å£°æ˜ä¸€ä¸ªå®ä¾‹å˜é‡ä½œä¸ºå…¶ä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼Œç„¶åç”±æ„é€ æ–¹æ³•æ³¨å…¥æˆ–è€…setteræ–¹æ³•æ³¨å…¥å°†AopContext.currentProxy()å–å¾—çš„Objectæ³¨å…¥ç»™è¿™ä¸ªå£°æ˜çš„å®ä¾‹å˜é‡ï¼›
- åœ¨ç›®æ ‡å¯¹è±¡ä¸­å£°æ˜ä¸€ä¸ªgetteræ–¹æ³•ï¼Œå¦‚getThis()ï¼Œç„¶åé€šè¿‡Springçš„IoCå®¹å™¨çš„æ–¹æ³•æ³¨å…¥æˆ–è€…æ–¹æ³•æ›¿æ¢ï¼Œå°†è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘æ›¿æ¢ä¸ºreturn AopContext.currentProxy()ã€‚è¿™æ ·ï¼Œåœ¨è°ƒç”¨è‡ªèº«æ–¹æ³•çš„æ—¶å€™ï¼Œç›´æ¥é€šè¿‡getThis().goodbye()å°±å¯ä»¥äº†ï¼›
- å£°æ˜ä¸€ä¸ªWrapperç±»ï¼Œå¹¶ä¸”è®©ç›®æ ‡å¯¹è±¡ä¾èµ–äºè¿™ä¸ªç±»ã€‚åœ¨Wrapperç±»ä¸­ç›´æ¥å£°æ˜ä¸€ä¸ªgetProxy()æˆ–è€…ç±»ä¼¼çš„æ–¹æ³•ï¼Œå°†return AopContext.currentProxy()ç±»ä¼¼é€»è¾‘æ·»åŠ åˆ°è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œç›®æ ‡å¯¹è±¡åªéœ€è¦getWrapper().getProxy()å°±å¯ä»¥å–å¾—ç›¸åº”çš„ä»£ç†å¯¹è±¡ã€‚Wrapperç±»åˆ†ç¦»äº†ç›®æ ‡å¯¹è±¡ä¸Spring APIçš„ç›´æ¥è€¦åˆã€‚è‡³äºè®©è¿™ä¸ªWrapperä»¥Utilç±»å‡ºç°ï¼Œè¿˜æ˜¯åœ¨ç›®æ ‡å¯¹è±¡ä¸­ç›´æ¥æ„é€ ï¼Œæˆ–è€…ä¾èµ–æ³¨å…¥åˆ°ç›®æ ‡å¯¹è±¡ï¼Œéƒ½å¯ä»¥ï¼›
- ä¸ºç±»ä¼¼çš„ç›®æ ‡å¯¹è±¡å£°æ˜ç»Ÿä¸€çš„æ¥å£å®šä¹‰ï¼Œç„¶åé€šè¿‡BeanPostProcessorå¤„ç†è¿™äº›æ¥å£å®ç°ç±»ï¼Œå°†å®ç°ç±»çš„æŸä¸ªå–å¾—å½“å‰å¯¹è±¡çš„ä»£ç†å¯¹è±¡çš„æ–¹æ³•é€»è¾‘è¦†ç›–æ‰ã€‚è¿™ä¸ªä¸æ–¹æ³•æ›¿æ¢æ‰€ä½¿ç”¨çš„åŸç†ä¸€æ ·ï¼Œåªä¸è¿‡å¯ä»¥å€ŸåŠ©Springçš„IoCå®¹å™¨è¿›è¡Œæ‰¹é‡å¤„ç†è€Œå·²ã€‚

å®é™…ä¸Šï¼Œè¿™ç§æƒ…å†µçš„å‡ºç°ä»…ä»…æ˜¯å› ä¸ºSpring AOPé‡‡ç”¨çš„æ˜¯ä»£ç†æœºåˆ¶å®ç°ã€‚å¦‚æœåƒAspectJé‚£æ ·ï¼Œç›´æ¥å°†æ¨ªåˆ‡é€»è¾‘ç»‡å…¥ç›®æ ‡å¯¹è±¡ï¼Œé‚£ä¹ˆä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡å®é™…ä¸Šå°±åˆä¸ºä¸€ä½“äº†ï¼Œè°ƒç”¨ä¹Ÿä¸ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚

## å†æ¬¡æŒ‘æˆ˜è¿™é“é¢è¯•é¢˜ï¼

æ ¹æ®ä¸Šä¸€èŠ‚çš„æè¿°ï¼Œæœ‰è¿™ä¹ˆä¸€ä¸ªç»“è®ºï¼šSpring AOPåŒä¸€ä¸ªå¯¹è±¡å†…éƒ¨åµŒå¥—è°ƒç”¨ä¼šå¯¼è‡´å†…éƒ¨æ–¹æ³•æ— æ³•è¢«æ‹¦æˆªï¼Œå¯¼è‡´AOPå¤±æ•ˆã€‚

ç°åœ¨é¦–å…ˆè°ƒç”¨çš„æ˜¯`a()`æ–¹æ³•ï¼Œç”Ÿæˆçš„æ˜¯è°ƒç”¨`a()`æ–¹æ³•å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œä¸å®¹å™¨ä¸­çš„yä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚æ‰€ä»¥`y.b()`æ–¹æ³•å¯ä»¥æ­£å¸¸è¢«æ‹¦æˆªåˆ°ï¼Œå¹¶ç”Ÿæˆyçš„ä»£ç†å¯¹è±¡ã€‚ä½†æ˜¯æ‰§è¡Œ`b()`æ–¹æ³•çš„è¿˜æ˜¯è¢«ä»£ç†å¯¹è±¡yæœ¬èº«ï¼Œä¹Ÿå°±æ˜¯thisï¼Œå› æ­¤è°ƒç”¨çš„`c()`æ–¹æ³•æ˜¯ä¸ä¼šè¢«æ‹¦æˆªåˆ°çš„ã€‚

å‘€å˜å‘€å˜dazeï¼Œå› æ­¤è¿™é“é¢˜çš„ç­”æ¡ˆå°±æ˜¯ï¼

- method a start --> method b start ---> method b end --> method a end

```java
// é¢è¯•çš„é—®é¢˜ï¼šä¸‹å›¾ä¸­çš„Xã€Yç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½é…ç½®äº†AOPçš„å‰ç½®é€šçŸ¥å’Œåç½®é€šçŸ¥ï¼Œè¯·é—®ç°åœ¨è°ƒç”¨æ–¹æ³•aï¼Œæ±‚é€šçŸ¥çš„æ‰“å°é¡ºåºã€‚
class X{
  @Autowired
  Y y;

  public void a(){
    y.b();
  }
}

class Y{
  public void b(){
    this.c();
  }

  public void c(){
    // do something
  }
}
```







å‚è€ƒï¼š

[ä½ çœŸçš„ç¡®å®šSpring AOPçš„æ‰§è¡Œé¡ºåºå—](https://zhuanlan.zhihu.com/p/266111498)

[Spring AOP åµŒå¥—ä»£ç† - ç”¨BeanPostProcessorå®ç°](https://www.jianshu.com/p/1211f855df1c)

[Spring AOPå­¦ä¹ ç¬”è®°05ï¼šAOPå¤±æ•ˆçš„ç½ªå› ](https://bbs.huaweicloud.com/blogs/180669)

