---
layout: post
title:  "Redisçš„äº‹åŠ¡ä¸é›†ç¾¤"
date:   2019-12-29 14:20:06 +0800--
categories: [æ•°æ®åº“]
tags: [redis, Java, ]  
---

# Redisäº‹åŠ¡ä¸é›†ç¾¤

## Redisçš„äº‹åŠ¡

âš ï¸ **Rediséƒ¨åˆ†æ”¯æŒäº‹åŠ¡**

### æ˜¯ä»€ä¹ˆï¼Ÿ

å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œæœ¬è´¨æ˜¯ä¸€ç»„å‘½ä»¤çš„é›†åˆã€‚ä¸€ä¸ªäº‹ç‰©ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«åºåˆ—åŒ–ï¼Œ***æŒ‰é¡ºåºçš„ä¸²è¡Œæ‰§è¡Œè€Œä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ’å…¥ï¼Œä¸è®¸åŠ å¡ã€‚***

### èƒ½å¹²å˜›ï¼Ÿ

***ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œä¸€æ¬¡æ€§çš„ï¼Œé¡ºåºçš„ï¼Œæ’ä»–çš„æ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤ã€‚***

### å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤            | æè¿°                                                         |
| --------------- | ------------------------------------------------------------ |
| multi           | æ ‡è®°ä¸€ä¸ªäº‹åŠ¡çš„å¼€å§‹                                           |
| exec            | æ‰§è¡Œæ‰€æœ‰äº‹åŠ¡å—å†…çš„å‘½ä»¤                                       |
| discard         | å–æ¶ˆäº‹åŠ¡ï¼Œæ”¾å¼ƒæ‰§è¡Œäº‹åŠ¡å—å†…çš„æ‰€æœ‰å‘½ä»¤                         |
| watch key [key] | ç›‘è§†ä¸€ä¸ª(æˆ–å¤šä¸ª) key ï¼Œå¦‚æœåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰è¿™ä¸ª(æˆ–è¿™äº›) key è¢«å…¶ä»–å‘½ä»¤æ‰€æ”¹åŠ¨ï¼Œé‚£ä¹ˆäº‹åŠ¡å°†è¢«æ‰“æ–­ã€‚ |
| unwatch         | å–æ¶ˆwatchå‘½ä»¤å¯¹æ‰€æœ‰ key çš„ç›‘è§†ã€‚                             |



### æ€ä¹ˆç©ï¼Ÿ

1. **æ­£å¸¸æ‰§è¡Œ**

   ![](/assets/imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzY2ODgz,size_16,color_FFFFFF,t_70-20200826213412755.png)

2. **æ”¾å¼ƒäº‹åŠ¡**

   ![](/assets/imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzY2ODgz,size_16,color_FFFFFF,t_70-20200826213415458.png)

3. **å…¨ä½“è¿å(ä¾¿è¡£æ—¶ç›´æ¥æŠ¥é”™)**

   ![](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20200329153701009.png)

4. **å†¤å¤´å€ºä¸»ï¼ˆè¿è¡Œæ—¶æŠ¥é”™ï¼‰** éƒ¨åˆ†åŸå­æ€§ï¼Œæ‰€ä»¥**Rediséƒ¨åˆ†æ”¯æŒäº‹åŠ¡**ã€‚

![](/assets/imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzY2ODgz,size_16,color_FFFFFF,t_70-20200826213414502.png)



### [ä¹è§‚é”å’Œæ‚²è§‚é”](http://www.silince.cn/2020/08/24/Mysqlæ•°æ®åº“é«˜çº§-é”æœºåˆ¶/)



### Watchç›‘æ§ ğŸ¤”

***watchæŒ‡ä»¤ï¼Œç±»ä¼¼ä¹è§‚é”ï¼Œå¦‚æœkeyçš„å€¼å·²ç»è¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆæ•´ä¸ªäº‹åŠ¡é˜Ÿåˆ—éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼ŒåŒæ—¶è¿”å›ä¸€ä¸ªNullmulti-bulkåº”ç­”ä»¥é€šçŸ¥è°ƒç”¨è€…äº‹åŠ¡æ‰§è¡Œå¤±è´¥ã€‚***

æ³¨æ„ï¼š**ä¸€æ—¦æ‰§è¡Œäº†execæˆ–è€…discardï¼Œä¹‹å‰åŠ çš„æ‰€æœ‰ç›‘æ§é”éƒ½ä¼šè¢«å–æ¶ˆæ‰äº†ã€‚**

ä¾‹å­ï¼š

- åˆå§‹åŒ–ä¿¡ç”¨å¡çš„å¯ç”¨ä½™é¢å’Œæ¬ é¢

  ![](/assets/imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzY2ODgz,size_16,color_FFFFFF,t_70-20200826213416663.png)

- æ— åŠ å¡ç¯¡æ”¹ï¼Œå…ˆç›‘æ§å†å¼€å¯multiï¼Œä¿è¯ä¸¤ç¬”é‡‘é¢å˜åŠ¨åœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…

  ![](/assets/imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzY2ODgz,size_16,color_FFFFFF,t_70-20200826213420504.png)

- æœ‰åŠ å¡ç¯¡æ”¹ï¼Œå½“watchçš„keyè¢«ä¿®æ”¹ï¼Œåé¢çš„é‚£ä¸ªäº‹åŠ¡å…¨éƒ¨æ‰§è¡Œå¤±è´¥

  ![](/assets/imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzY2ODgz,size_16,color_FFFFFF,t_70-20200826213416575.png)

- unwatchï¼Œå–æ¶ˆwatchå‘½ä»¤å¯¹æ‰€æœ‰ key çš„ç›‘è§†ã€‚

  ![](/assets/imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzY2ODgz,size_16,color_FFFFFF,t_70-20200826213418713.png)

- ä¸€æ—¦æ‰§è¡Œäº†execä¹‹å‰åŠ çš„ç›‘æ§é”éƒ½ä¼šè¢«å–æ¶ˆ

#### **å°ç»“ï¼š**

é€šè¿‡WATCHå‘½ä»¤åœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰ç›‘æ§äº†å¤šä¸ªKeysï¼Œå¦‚æœåœ¨WATCHä¹‹åæœ‰ä»»ä½•Keyçš„å€¼å‘ç”Ÿäº†å˜åŒ–ï¼ŒEXECå‘½ä»¤æ‰§è¡Œçš„é£Ÿç‰©éƒ½å°†è¢«æ”¾å¼ƒï¼ŒåŒæ—¶è¿”å›Nullmulti-bulk åº”ç­”ä»¥é€šçŸ¥è°ƒç”¨è€…äº‹åŠ¡æ‰§è¡Œå¤±è´¥ã€‚



### äº‹åŠ¡çš„3é˜¶æ®µ

***å¼€å¯:ä»¥multiå¼€å¯äº‹åŠ¡***

***å…¥é˜Ÿ:å°†å¤šä¸ªå‘½ä»¤å…¥é˜Ÿåˆ°äº‹åŠ¡ä¸­,æ¥åˆ°è¿™äº›å‘½ä»¤ä¸ä¼šç«‹åˆ»æ‰§è¡Œ,è€Œæ˜¯æ”¾åˆ°ç­‰å¾…æ‰§è¡Œçš„äº‹åŠ¡é˜Ÿåˆ—é‡Œé¢***

***æ‰§è¡Œï¼šæœ‰execå‘½ä»¤è§¦å‘äº‹åŠ¡***

```mermaid
graph LR 
kai((å¼€å¯))==>ru((å…¥é˜Ÿ))
ru==>zhi((æ‰§è¡Œ))
```

### äº‹åŠ¡çš„3ç‰¹æ€§

***å•ç‹¬çš„éš”ç¦»æ“ä½œï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåºåˆ—åŒ–ï¼ŒæŒ‰é¡ºåºçš„æ‰§è¡Œã€‚äº‹åŠ¡åœ¨ç­‰å¾…æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¥çš„ç±³å‘½ä»¤è¯·æ±‚æ‰“æ–­***

***æ²¡æœ‰éš”ç¦»çº§åˆ«çš„æ¦‚å¿µï¼šé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤æ²¡æœ‰æäº¤execä¹‹å‰éƒ½æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„***

***ä¸ä¿è¯åŸå­æ€§ï¼šredisä¸­å¦‚æœä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶åçš„å‘½ä»¤ä»ç„¶ä¼šè¢«æ‰§è¡Œï¼Œæ²¡æœ‰å›æ»šï¼›éƒ¨åˆ†æ”¯æŒäº‹åŠ¡ã€‚***



## Redisçš„å‘å¸ƒè®¢é˜…(ä¸€èˆ¬ä¸ç”¨)

<h4><a id="_228"></a>å‘å¸ƒè®¢é˜…</h4>
<p>Redis å‘å¸ƒè®¢é˜…(pub/sub)æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ï¼šå‘é€è€…(pub)å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€…(sub)æ¥æ”¶æ¶ˆæ¯ã€‚</p>
<p>Redis å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ã€‚</p>
<p>ä¸‹å›¾å±•ç¤ºäº†é¢‘é“ channel1 ï¼Œ ä»¥åŠè®¢é˜…è¿™ä¸ªé¢‘é“çš„ä¸‰ä¸ªå®¢æˆ·ç«¯ â€”â€” client2 ã€ client5 å’Œ client1 ä¹‹é—´çš„å…³ç³»ï¼š<br>
<img src="/assets/imgs/image-20200827203719486.png" alt=""><br/><br/>
å½“æœ‰æ–°æ¶ˆæ¯é€šè¿‡ PUBLISH å‘½ä»¤å‘é€ç»™é¢‘é“ channel1 æ—¶ï¼Œ è¿™ä¸ªæ¶ˆæ¯å°±ä¼šè¢«å‘é€ç»™è®¢é˜…å®ƒçš„ä¸‰ä¸ªå®¢æˆ·ç«¯ï¼š<br/>
<img src="/assets/imgs/image-20200827203801396.png" alt=""><br/><br/><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em><strong>å‘½ä»¤</strong></em></p>
<ul>
<li>subscribe channel [channelâ€¦]ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“çš„ä¿¡æ¯</li>
<li>psubscribe pattern [patternâ€¦]ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªç¬¦åˆè§„å®šæ¨¡å¼çš„é¢‘é“</li>
<li>publish channel message ï¼šå°†ä¿¡æ¯å‘é€åˆ°æŒ‡å®šé¢‘é“</li>
<li>unsubscribe [channel[channelâ€¦]]ï¼šé€€è®¢é¢‘é“</li>
<li>punsubscribe [pattern[patternâ€¦]]ï¼šé€€è®¢æ‰€æœ‰ç»™å®šæ¨¡å¼çš„é¢‘é“</li>
</ul>


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em><strong>åº”ç”¨åœºæ™¯</strong></em>

<blockquote>
æ„å»ºå®æ—¶çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œæ¯”å¦‚æ™®é€šèŠå¤©ã€ç¾¤èŠç­‰åŠŸèƒ½ã€‚
1ã€åšå®¢ç½‘ç«™è®¢é˜…ï¼Œå½“ä½œè€…å‘å¸ƒå°±å¯ä»¥æ¨é€ç»™ç²‰ä¸
2ã€å¾®ä¿¡å…¬ä¼—å·æ¨¡å¼
</blockquote>




## Redisçš„å¤åˆ¶ï¼ˆMaster/Slaveï¼‰ğŸ¤”

### æ˜¯ä»€ä¹ˆï¼Ÿ

***å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ä¸»ä»å¤åˆ¶ï¼Œä¸»æœºæ•°æ®æ›´æ–°åæ ¹æ®é…ç½®å’Œç­–ç•¥ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°å¤‡æœºçš„master/slaveræœºåˆ¶ï¼ŒMasterä»¥å†™ä¸ºä¸»ï¼ŒSlaveä»¥è¯»ä¸ºä¸»ã€‚***



### èƒ½å¹²å˜›ï¼Ÿ

- ***è¯»å†™åˆ†ç¦»***

- ***å®¹ç¾æ¢å¤***



### æ€ä¹ˆç©ï¼Ÿ

**é…ä»(åº“)ä¸é…ä¸»(åº“)***

ä»åº“é…ç½®ï¼šslaveofä¸»åº“IP ä¸»åº“ç«¯å£

```shell
# é…ç½®ä»åº“
slaveof ä¸»åº“ip ä¸»åº“ç«¯å£
# æŸ¥çœ‹ä¸»ä»ä¿¡æ¯
info replication
```

***æ¯æ¬¡ä¸masteræ–­å¼€åï¼Œéƒ½éœ€è¦é‡æ–°è¿æ¥ï¼Œé™¤éä½ é…ç½®è¿›redis.confæ–‡ä»¶***

ä¿®æ”¹é…ç½®æ–‡ä»¶ç»†èŠ‚æ“ä½œï¼š

1. æ‹·è´å¤šä¸ªredis.confæ–‡ä»¶
2. å¼€å¯daemonize yes
3. pidæ–‡ä»¶åå­—
4. æŒ‡å®šç«¯å£
5. Logæ–‡ä»¶åå­—
6. Dump.rdpåå­—

```shell l
# docker æ–¹å¼æ­å»º
# 79
docker run -p 6379:6379 -v /root/docker/redis/data:/data -v /root/docker/redis/conf/redis.conf:/etc/redis/redis.conf --privileged=true --name myredis -d redis:5.0.7 redis-server /etc/redis/redis.conf
# 80
docker run -p 6380:6379 -v /root/docker/redis/data:/data -v /root/docker/redis/conf/redis.conf:/etc/redis/redis.conf --privileged=true --name myredis80 -d redis:5.0.7 redis-server /etc/redis/redis.conf
# 81
docker run -p 6381:6379 -v /root/docker/redis/data:/data -v /root/docker/redis/conf/redis.conf:/etc/redis/redis.conf --privileged=true --name myredis81 -d redis:5.0.7 redis-server /etc/redis/redis.conf

# âš ï¸ ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å®¹å™¨å†…ç½‘çš„ipåœ°å€ç­‰ä¿¡æ¯  å…ˆè®¾ç½®é…ç½®æ–‡ä»¶ bind 0.0.0.0
docker inspect --format '{{ ã€‚NetworkSettings.IPAddress }}' myredis
```



### å¸¸ç”¨çš„ä¸»ä»æ–¹å¼ ğŸ¤”

####  ä¸€ä¸»äºŒä»†

***å«ä¹‰ï¼šå°±æ˜¯ä¸€ä¸ªMasterä¸¤ä¸ªSlave***

![ä¸€ä»†äºŒä¸»](/assets/imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzY2ODgz,size_16,color_FFFFFF,t_70-20200826213445185.png)

é€šè¿‡`info replication`æŸ¥çœ‹ä¸»ä»ä¿¡æ¯

```shell
# Replication
role:master
connected_slaves:0
master_replid:f6baff9abfda12ca58048cfce4b0e2c1f4683da1
master_replid2:e8fe596d47d9d1d923d56d884b28128b78d2c1e0
master_repl_offset:0
second_repl_offset:1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
```

```shell
# Replication
role:slave
master_host:127.0.0.1
master_port:6379
master_link_status:down
master_last_io_seconds_ago:-1
master_sync_in_progress:0
slave_repl_offset:0
master_link_down_since_seconds:1585217521
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:adbec19afa734e84a333b07ea2f33c43c73fe743
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
```



<span id="zhuyi">æ³¨æ„:</span>

1. ***ç¬¬ä¸€æ¬¡slave1 å’Œslave2åˆ‡å…¥ç‚¹ï¼Œæ˜¯å…¨é‡å¤åˆ¶ï¼Œä¹‹åæ˜¯å¢é‡å¤åˆ¶***

   ![ä¸€ä¸»äºŒä»†](/assets/imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzY2ODgz,size_16,color_FFFFFF,t_70-20200826213421103.png)

2. ***ä¸»æœºå¯ä»¥å†™ï¼Œä½†æ˜¯ä»æœºä¸å¯ä»¥å†™ï¼Œä»æœºåªèƒ½è¯»***

   ![ä»æœºå†™çš„æŠ¥é”™](/assets/imgs/20200326181813787-20200826213421178.png)

3. ***ä¸»æœºshutdowmåä»æœºå¾…æœºçŠ¶æ€ï¼Œç­‰ä¸»æœºå›æ¥åï¼Œä¸»æœºæ–°å¢è®°å½•ä»æœºå¯ä»¥é¡ºåˆ©å¤åˆ¶*** 

4. ***ä»æœºshutdowmåï¼Œæ¯æ¬¡ä¸masteræ–­å¼€ä¹‹åï¼Œéƒ½éœ€è¦é‡æ–°è¿æ¥ï¼Œé™¤éä½ é…ç½®è¿›redis.confæ–‡ä»¶***

5. ***ä»æœºå¤åˆ¶åˆ°çš„æ•°æ®ï¼Œä¼šè¢«æœ¬æœºæŒä¹…åŒ–ã€‚å°±ç®—shutdownæ–­å¼€è¿æ¥ä¾ç„¶ä¼šæœ‰æ•°æ®ã€‚***

6. ***é‡æ–°è¿æ¥æˆ–è€…å˜æ›´masterï¼Œä¼šæ¸…é™¤ä¹‹å‰çš„æ•°æ®ï¼Œé‡æ–°å»ºç«‹æ‹·è´æœ€æ–°çš„æ•°æ®***

    

#### è–ªç«ç›¸ä¼ 

***å«ä¹‰:å°±æ˜¯ä¸Šä¸€ä¸ªSlaveå¯ä»¥æ˜¯ä¸‹ä¸€ä¸ªslaveçš„Masterï¼ŒSlaveåŒæ ·å¯ä»¥æ¥æ”¶å…¶ä»–slavesçš„è¿æ¥å’ŒåŒæ­¥è¯·æ±‚ï¼Œé‚£ä¹ˆè¯¥slaveä½œä¸ºäº†é“¾æ¡ä¸­ä¸‹ä¸€ä¸ªçš„master,å¯ä»¥æœ‰æ•ˆå‡è½»masterçš„å†™å‹åŠ›ã€‚***

![è–ªç«ç›¸ä¼ ](/assets/imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NzY2ODgz,size_16,color_FFFFFF,t_70-20200826213422553.png)

æ³¨æ„äº‹é¡¹å’Œä¸€ä¸»äºŒä»†å·®ä¸å¤š,ä½†æ³¨æ„***è™½ç„¶æœ‰slaveæ˜¯ç›¸å¯¹masterï¼Œä½†æ˜¯ä¾ç„¶æ˜¯slave*** ã€‚

***ä¸­é€”å˜æ›´è½¬å‘ï¼šä¼šæ¸…é™¤ä¹‹å‰çš„æ•°æ®ï¼Œé‡æ–°å»ºç«‹æ‹·è´æœ€æ–°çš„***



####  åå®¢ä¸ºä¸»

```shell    
SLAVEOF no one
```

 ***ä½¿å½“å‰æ•°æ®åº“åœæ­¢ä¸å…¶ä»–æ•°æ®åº“çš„åŒæ­¥ï¼Œè½¬æˆä¸»æ•°æ®åº“***



#### å“¨å…µæ¨¡å¼ï¼ˆsentinelï¼‰

***åå®¢ä¸ºä¸»çš„è‡ªåŠ¨ç‰ˆï¼Œèƒ½å¤Ÿåå°ç›‘æ§Masteråº“æ˜¯å¦æ•…éšœï¼Œå¦‚æœæ•…éšœäº†æ ¹æ®æŠ•ç¥¨æ•°è‡ªåŠ¨å°†slaveåº“è½¬æ¢ä¸ºä¸»åº“ã€‚ä¸€ç»„sentinelèƒ½åŒæ—¶ç›‘æ§å¤šä¸ªMasterã€‚***

ä½¿ç”¨æ­¥éª¤ï¼š

1. åœ¨Masterå¯¹åº”redis.confåŒç›®å½•ä¸‹æ–°å»ºsentinel.confæ–‡ä»¶ï¼Œåå­—ç»å¯¹ä¸èƒ½é”™ï¼›

2. é…ç½®å“¨å…µï¼Œåœ¨sentinel.confæ–‡ä»¶ä¸­å¡«å…¥å†…å®¹(å¯ä»¥é…ç½®å¤šä¸ª)ï¼š

   ```shell
   #è¯´æ˜ï¼šæœ€åä¸€ä¸ªæ•°å­—1ï¼Œè¡¨ç¤ºä¸»æœºæŒ‚æ‰åslaveæŠ•ç¥¨çœ‹è®©è°æ¥æ›¿æˆä¸ºä¸»æœºï¼Œå¾—ç¥¨æ•°å¤šå°‘åæˆä¸ºä¸»æœºã€‚
   sentinel monitor è¢«ç›‘æ§æ•°æ®åº“åå­—ï¼ˆè‡ªå·±èµ·åå­—ï¼‰ ip port 1
   ```

3. å¯åŠ¨å“¨å…µæ¨¡å¼(è·¯å¾„æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚è¿›è¡Œé…ç½®)ï¼š

   ```shell
   redis-sentinel  /myredis/sentinel.conf
   ```



æ³¨æ„ï¼š

1. ***å½“masteræŒ‚æ‰åï¼Œä¼šé€šè¿‡é€‰ç¥¨è¿›è¡Œé€‰å‡ºä¸‹ä¸€ä¸ªmasterã€‚è€Œä¸”åªæœ‰ä½¿ç”¨äº†sentinel.confå¯åŠ¨çš„æ‰èƒ½å¼€å¯é€‰ç¥¨***

2. ***å½“åŸæ¥çš„masteråæ¥åï¼Œå¾ˆä¸å¹¸å˜æˆäº†slaveã€‚***



### å¤åˆ¶åŸç†

1. Slaveå¯åŠ¨æˆåŠŸè¿æ¥åˆ°masteråä¼šå‘é€ä¸€ä¸ªsyncå‘½ä»¤ï¼›

2. Masteræ¥åˆ°å‘½ä»¤å¯åŠ¨åçš„å­˜ç›˜è¿›ç¨‹ï¼ŒåŒæ—¶æ”¶é›†æ‰€æœ‰æ¥æ”¶åˆ°çš„ç”¨äºä¿®æ”¹æ•°æ®é›†å‘½ä»¤ï¼Œåœ¨åå°è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œmasterå°†ä¼ é€æ•´ä¸ªæ•°æ®æ–‡ä»¶åˆ°slaveï¼Œä»¥å®Œæˆä¸€æ¬¡å®Œå…¨åŒæ­¥ï¼›

3. ***å…¨é‡å¤åˆ¶ï¼šè€ŒslaveæœåŠ¡åœ¨æ•°æ®åº“æ–‡ä»¶æ•°æ®åï¼Œå°†å…¶å­˜ç›˜å¹¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼›***

4. ***å¢é‡å¤åˆ¶ï¼šMasterç»§ç»­å°†æ–°çš„æ‰€æœ‰æ”¶é›†åˆ°çš„ä¿®æ”¹å‘½ä»¤ä¾æ¬¡ä¼ ç»™slaveï¼Œå®ŒæˆåŒæ­¥ï¼›***

5. ä½†æ˜¯åªè¦æ˜¯é‡æ–°è¿æ¥masterï¼Œä¸€æ¬¡å®Œå…¨åŒæ­¥ï¼ˆå…¨é‡å¤åˆ¶ï¼‰å°†è¢«è‡ªåŠ¨æ‰§è¡Œã€‚



### å¤åˆ¶çš„ç¼ºç‚¹

â€‹       ***å»¶æ—¶ï¼Œç”±äºæ‰€æœ‰çš„å†™æ“ä½œéƒ½æ˜¯åœ¨Masterä¸Šæ“ä½œï¼Œç„¶ååŒæ­¥æ›´æ–°åˆ°Slaveä¸Šï¼Œæ‰€ä»¥ä»MasteråŒæ­¥åˆ°Slaveæœºå™¨æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œå½“ç³»ç»Ÿå¾ˆç¹å¿™çš„æ—¶å€™ï¼Œå»¶è¿Ÿé—®é¢˜ä¼šæ›´åŠ ä¸¥é‡ï¼ŒSlaveæœºå™¨æ•°é‡çš„å¢åŠ ä¹Ÿä¼šä½¿å¾—è¿™ä¸ªé—®é¢˜æ›´åŠ ä¸¥é‡ã€‚***




### å‘½ä»¤

| å‘½ä»¤                                                         | ä½œç”¨                                             |
| ------------------------------------------------------------ | ------------------------------------------------ |
| slaveof ä¸»åº“ip  ä¸»åº“ç«¯å£                                     | é…ç½®ä»åº“                                         |
| info replication                                             | æŸ¥çœ‹redisä¸»ä»å¤åˆ¶çš„æƒ…å†µ                          |
| slaveof  no one                                              | ä½¿å½“å‰æ•°æ®åº“åœæ­¢ä¸å…¶ä»–æ•°æ®åº“çš„åŒæ­¥ï¼Œè½¬æˆä¸»æ•°æ®åº“ |
| sentinel monitor è¢«ç›‘æ§æ•°æ®åº“åå­—(è‡ªå·±èµ·åå­—) 127.0.0.1 6379 1 | é…ç½®å“¨å…µï¼Œç›‘è§†master                             |
| redis-sentinel  /myredis/sentinel.conf                       | ä»¥å“¨å…µæ¨¡å¼å¯åŠ¨redis                              |





## Redisé›†ç¾¤

å®¹é‡ä¸å¤Ÿï¼Œrediså¦‚ä½•æ‰©å®¹ï¼Ÿ

å¹¶å‘å†™æ“ä½œï¼Œrediså¦‚ä½•åˆ†æ‘Šï¼Ÿ

### ä»€ä¹ˆæ˜¯Redisé›†ç¾¤ï¼Ÿ

Redisé›†ç¾¤å®ç°äº†å¯¹Redisçš„æ°´å¹³æ‰©å®¹ï¼Œå³å¯åŠ¨Nä¸ªredisèŠ‚ç‚¹ï¼Œå°†æ•´ä¸ªæ•°æ®åº“åˆ†å¸ƒå­˜å‚¨åœ¨è¿™Nä¸ªèŠ‚ç‚¹ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨æ€»æ•°æ®çš„1/N

Redisé›†ç¾¤é€šè¿‡åˆ†åŒºï¼ˆpartitionï¼‰æ¥æä¾›ä¸€å®šç¨‹åº¦çš„å¯ç”¨æ€§ï¼ˆavailabilityï¼‰ï¼šå³ä½¿é›†ç¾¤ä¸­æœ‰ä¸€éƒ¨åˆ†èŠ‚ç‚¹å¤±æ•ˆæˆ–è€…æ— æ³•è¿›è¡Œé€šè®¯ï¼Œé›†ç¾¤ä¹Ÿå¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚





### é›†ç¾¤æ­å»º

[æ­å»ºçœ‹è¿™ç¯‡æ–‡ç« ,æœ‰æ•ˆ](http://codekiller.top/2020/03/30/redis-cluster/)

```mermaid
graph LR
yi((å¯¼å…¥å®‰è£…åŒ…))-->er((ä¿®æ”¹é…ç½®æ–‡ä»¶))
er((ä¿®æ”¹é…ç½®æ–‡ä»¶))-->san((åˆ›å»ºåŸºæœ¬é•œåƒ))
san-->si((åˆ›å»ºèŠ‚ç‚¹é•œåƒ))
si-->|å¯åŠ¨6ä¸ªå®¹å™¨|wu((è¿›å…¥ä¸€ä¸ªredis-cli))
wu-->|cluster meet|liu((é›†ç¾¤æ·»åŠ èŠ‚ç‚¹))
liu-->qi((é…ç½®æ§½ç‚¹))
qi-->ba((é…ç½®ä¸»ä»é«˜å¯ç”¨))
```





### é›†ç¾¤å‘½ä»¤

```shell
CLUSTER INFO æ‰“å°é›†ç¾¤çš„ä¿¡æ¯ 
CLUSTER NODES åˆ—å‡ºé›†ç¾¤å½“å‰å·²çŸ¥çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆnodeï¼‰ï¼Œä»¥åŠè¿™äº›èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯ã€‚  

//èŠ‚ç‚¹(node) 
CLUSTER MEET <ip> <port> å°† ip å’Œ port æ‰€æŒ‡å®šçš„èŠ‚ç‚¹æ·»åŠ åˆ°é›†ç¾¤å½“ä¸­ï¼Œè®©å®ƒæˆä¸ºé›†ç¾¤çš„ä¸€ä»½å­ã€‚ 
CLUSTER FORGET <node_id> ä»é›†ç¾¤ä¸­ç§»é™¤ node_id æŒ‡å®šçš„èŠ‚ç‚¹ã€‚ 
CLUSTER REPLICATE <node_id> å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸º node_id æŒ‡å®šçš„èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ã€‚ 
CLUSTER SAVECONFIG å°†èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ä¿å­˜åˆ°ç¡¬ç›˜é‡Œé¢ã€‚  

//æ§½(slot) 
CLUSTER ADDSLOTS <slot> [slot ...] å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ§½ï¼ˆslotï¼‰æŒ‡æ´¾ï¼ˆassignï¼‰ç»™å½“å‰èŠ‚ç‚¹ã€‚ 
CLUSTER DELSLOTS <slot> [slot ...] ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæ§½å¯¹å½“å‰èŠ‚ç‚¹çš„æŒ‡æ´¾ã€‚ 
CLUSTER FLUSHSLOTS ç§»é™¤æŒ‡æ´¾ç»™å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰æ§½ï¼Œè®©å½“å‰èŠ‚ç‚¹å˜æˆä¸€ä¸ªæ²¡æœ‰æŒ‡æ´¾ä»»ä½•æ§½çš„èŠ‚ç‚¹ã€‚ 
CLUSTER SETSLOT <slot> NODE <node_id> å°†æ§½ slot æŒ‡æ´¾ç»™ node_id æŒ‡å®šçš„èŠ‚ç‚¹ï¼Œå¦‚æœæ§½å·²ç»æŒ‡æ´¾ç»™å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå…ˆè®©å¦ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤è¯¥æ§½>ï¼Œç„¶åå†è¿›è¡ŒæŒ‡æ´¾ã€‚ 
CLUSTER SETSLOT <slot> MIGRATING <node_id> å°†æœ¬èŠ‚ç‚¹çš„æ§½ slot è¿ç§»åˆ° node_id æŒ‡å®šçš„èŠ‚ç‚¹ä¸­ã€‚ 
CLUSTER SETSLOT <slot> IMPORTING <node_id> ä» node_id æŒ‡å®šçš„èŠ‚ç‚¹ä¸­å¯¼å…¥æ§½ slot åˆ°æœ¬èŠ‚ç‚¹ã€‚ 
CLUSTER SETSLOT <slot> STABLE å–æ¶ˆå¯¹æ§½ slot çš„å¯¼å…¥ï¼ˆimportï¼‰æˆ–è€…è¿ç§»ï¼ˆmigrateï¼‰ã€‚  

//é”® (key) 
CLUSTER KEYSLOT <key> è®¡ç®—é”® key åº”è¯¥è¢«æ”¾ç½®åœ¨å“ªä¸ªæ§½ä¸Šã€‚ 
CLUSTER COUNTKEYSINSLOT <slot> è¿”å›æ§½ slot ç›®å‰åŒ…å«çš„é”®å€¼å¯¹æ•°é‡ã€‚ 
CLUSTER GETKEYSINSLOT <slot> <count> è¿”å› count ä¸ª slot æ§½ä¸­çš„é”®ã€‚
```



### èŠ‚ç‚¹

1. ä¸€ä¸ªé›†ç¾¤è‡³å°‘è¦æœ‰ä¸‰ä¸ªä¸»èŠ‚ç‚¹ï¼Œå³è¦æœ‰å…­ä¸ªèŠ‚ç‚¹ã€‚

2. åˆ†é…åŸåˆ™å°½é‡ä¿è¯æ¯ä¸ªä¸»æ•°æ®åº“è¿è¡Œåœ¨ä¸åŒçš„ipåœ°å€ï¼Œæ¯ä¸ªä»åº“å’Œä¸»åº“ä¸åœ¨ä¸€ä¸ªipåœ°å€ã€‚

3. å½“ä¸»èŠ‚ç‚¹å´©äº†ï¼Œä»èŠ‚ç‚¹èƒ½è‡ªåŠ¨å‡ä¸ºä¸»èŠ‚ç‚¹ï¼›å½“ä¸»èŠ‚ç‚¹å†æ¬¡æ¢å¤æ—¶ï¼Œä¸»èŠ‚ç‚¹å˜ä¸ºslaveã€‚å‚è€ƒå“¨å…µæ¨¡å¼ã€‚

4. redis.confæœ‰ä¸ªå‚æ•°cluster-require-full-coverage

   ```shell
   #é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†ç¾¤å…¨éƒ¨çš„slotæœ‰èŠ‚ç‚¹è´Ÿè´£ï¼Œé›†ç¾¤çŠ¶æ€æ‰ä¸ºokï¼Œæ‰èƒ½æä¾›æœåŠ¡ã€‚è®¾ç½®ä¸ºnoï¼Œå¯ä»¥åœ¨slotæ²¡æœ‰å…¨éƒ¨åˆ†é…çš„æ—¶å€™æä¾›æœåŠ¡ã€‚ä¸å»ºè®®æ‰“å¼€è¯¥é…ç½®ã€‚
   # cluster-require-full-coverage yes
   ```

   

   



### SLOTS

- ä¸€ä¸ªRedis é›†ç¾¤åŒ…å«16384ä¸ªæ’æ§½(hash slot)ï¼Œ æ•°æ®åº“ä¸­çš„æ¯ä¸ªé”®éƒ½å±äºè¿™16384ä¸ªæ’æ§½çš„å…¶ä¸­ä¸€ä¸ªï¼Œé›†ç¾¤ä½¿ç”¨å…¬å¼CRC1 6(key)% 16384æ¥è®¡ç®—é”®keyå±äºå“ªä¸ªæ§½(å¦‚æœæœ‰ç»„çš„è¯å°±åªç®—ç»„çš„éƒ¨åˆ†)ï¼Œå…¶ä¸­`CRC16(key)`è¯­å¥ç”¨äºè®¡ç®—é”®keyçš„CRC16æ ¡éªŒå’Œã€‚

- é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å¤„ç†ä¸€éƒ¨åˆ†æ’æ§½ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœä¸€ä¸ªé›†ç¾¤å¯ä»¥æœ‰ä¸»èŠ‚ç‚¹ã€‚å…¶ä¸­:
  - èŠ‚ç‚¹Aè´Ÿè´£å¤„ç†0å·è‡³5500å·æ’æ§½
  - èŠ‚ç‚¹Bè´Ÿè´£å¤„ç†5501å·è‡³11000å·æ’æ§½
  - èŠ‚ç‚¹Cè´Ÿè´£å¤„ç†11001å·è‡³16383å·æ’æ§½

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(æ³¨æ„ï¼šæ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„æ’æ§½å…·ä½“æ•°å­—å¯èƒ½ä¸åŒï¼Œå½“ç„¶å¯ä»¥é€šè¿‡ä¸€ä¸ªå°è„šæœ¬æ¥æŒ‡å®š)



**ä¸€ä¸ªç–‘é—®ï¼šä¸ºä»€ä¹ˆæ˜¯16384(2^14)ï¼Œè€Œä¸æ˜¯65535(2^16)å‘¢ï¼Ÿ**

åœ¨redisèŠ‚ç‚¹å‘é€å¿ƒè·³åŒ…æ—¶éœ€è¦æŠŠæ‰€æœ‰çš„æ§½æ”¾åˆ°è¿™ä¸ªå¿ƒè·³åŒ…é‡Œï¼Œä»¥ä¾¿è®©èŠ‚ç‚¹çŸ¥é“å½“å‰é›†ç¾¤ä¿¡æ¯ï¼Œ16384=16kï¼Œåœ¨å‘é€å¿ƒè·³åŒ…æ—¶ä½¿ç”¨charè¿›è¡Œbitmapå‹ç¼©åæ˜¯2kbï¼ˆ16384Ã·8Ã·1024=2kbï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨2kçš„ç©ºé—´åˆ›å»ºäº†16kçš„æ§½æ•°65535=65kï¼Œå‹ç¼©åå°±æ˜¯8kbï¼ˆ65536Ã·8Ã·1024=8kbï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦éœ€è¦8kçš„å¿ƒè·³åŒ…ã€‚



### Redis ClusteråŸç†

1. node1å’Œnode2é¦–å…ˆè¿›è¡Œæ¡æ‰‹meetï¼ŒçŸ¥é“å½¼æ­¤çš„å­˜åœ¨
2. æ¡æ‰‹æˆåŠŸåï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä¼šå®šæœŸå‘é€ping/pongæ¶ˆæ¯ï¼Œäº¤æ¢æ•°æ®ä¿¡æ¯(æ¶ˆæ¯å¤´ï¼Œæ¶ˆæ¯ä½“)
3. æ¶ˆæ¯å¤´é‡Œé¢æœ‰ä¸ªå­—æ®µï¼šunsigned char myslots[CLUSTER_SLOTS/8]ï¼Œæ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªæ§½ï¼Œå¦‚æœè¯¥ä½æ˜¯1ï¼Œä»£è¡¨è¯¥æ§½å±äºè¿™ä¸ªèŠ‚ç‚¹
4. æ¶ˆæ¯ä½“ä¸­ä¼šæºå¸¦ä¸€å®šæ•°é‡çš„å…¶ä»–èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå¤§çº¦å é›†ç¾¤èŠ‚ç‚¹æ€»æ•°é‡çš„ååˆ†ä¹‹ä¸€ï¼Œè‡³å°‘æ˜¯3ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ã€‚èŠ‚ç‚¹æ•°é‡è¶Šå¤šï¼Œæ¶ˆæ¯ä½“å†…å®¹è¶Šå¤§ã€‚
5. æ¯ç§’éƒ½åœ¨å‘é€pingæ¶ˆæ¯ã€‚æ¯ç§’éšæœºé€‰å–5ä¸ªèŠ‚ç‚¹ï¼Œæ‰¾å‡ºæœ€ä¹…æ²¡æœ‰é€šä¿¡çš„èŠ‚ç‚¹å‘é€pingæ¶ˆæ¯ã€‚
6. æ¯100æ¯«ç§’éƒ½ä¼šæ‰«ææœ¬åœ°èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¦‚æœå‘ç°èŠ‚ç‚¹æœ€è¿‘ä¸€æ¬¡æ¥å—pongæ¶ˆæ¯çš„æ—¶é—´å¤§äºcluster-node-timeout/2,åˆ™ç«‹å³å‘é€pingæ¶ˆæ¯

redisé›†ç¾¤çš„ä¸»èŠ‚ç‚¹æ•°é‡åŸºæœ¬ä¸å¯èƒ½è¶…è¿‡1000ä¸ªï¼Œè¶…è¿‡çš„è¯å¯èƒ½ä¼šå¯¼è‡´ç½‘ç»œæ‹¥å µã€‚



### åœ¨é›†ç¾¤ä¸­å½•å…¥å€¼(ç»„çš„æ¦‚å¿µ)

redis-cliå®¢æˆ·ç«¯æä¾›-cå‚æ•°å®ç°è‡ªåŠ¨é‡å®šå‘

```shell
redis-cli -c -p 6379
```

ä¸åœ¨ä¸€ä¸ªslotä¸‹çš„é”®å€¼ï¼Œæ˜¯ä¸èƒ½ä½¿ç”¨mgetï¼Œmsetç­‰å¤šé”®æ“ä½œ

å¯ä»¥é€šè¿‡{}æ¥å®šä¹‰`ç»„çš„æ¦‚å¿µ`ï¼Œä»è€Œä½¿keyä¸­{}å†…ç›¸åŒå†…å®¹çš„é”®å€¼å¯¹æ”¾åˆ°ä¸€ä¸ªslotä¸­å»ã€‚

```shell
set user:{info}:name xxx
set age{info} 12
set {info}email 12345@qq.com
hset user{info} name jiang
hset user{info} age 19
hset user{info} eamil 12345@qq.com

#ç»“æœ
172.17.0.3:6379> keys *
1) "user{info}"
2) "{info}email"
3) "user:{info}:name"
4) "age{info}"
------------------------------------------------------
172.17.0.3:6379> hkeys user{info}
1) "name"
2) "age"
3) "eamil"
```



æ¥æºï¼šhttps://www.codekiller.top/2020/03/30/redis2/