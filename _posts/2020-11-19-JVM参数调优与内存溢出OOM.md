---
layout: post
title:  "JVMå‚æ•°è°ƒä¼˜ä¸å†…å­˜æº¢å‡ºOOM"
date:   2020-11-19 15:31:16 +0800--
categories: [JVM,]
tags: [Java, JVM, é¢è¯•é¢˜, ]  
---

# JVMå‚æ•°è°ƒä¼˜

## å‰è¨€

ä½ è¯´ä½ åšè¿‡JVMè°ƒä¼˜å’Œå‚æ•°é…ç½®ï¼Œè¯·é—®å¦‚ä½•ç›˜ç‚¹æŸ¥çœ‹JVMç³»ç»Ÿé»˜è®¤å€¼

ä½¿ç”¨jpså’Œjinfoè¿›è¡ŒæŸ¥çœ‹

```java
-Xmsï¼šåˆå§‹å †ç©ºé—´
-Xmxï¼šå †æœ€å¤§å€¼
-Xssï¼šæ ˆç©ºé—´
```

-Xms å’Œ -Xmxæœ€å¥½è°ƒæ•´ä¸€è‡´ï¼Œé˜²æ­¢JVMé¢‘ç¹è¿›è¡Œæ”¶é›†å’Œå›æ”¶

## JVMå‚æ•°ç±»å‹ ğŸ¤”

- æ ‡é…å‚æ•°ï¼ˆä»JDK1.0 - Java12éƒ½åœ¨ï¼Œå¾ˆç¨³å®šï¼‰
  - -version
  - -help
  - java -showversion
- Xå‚æ•°ï¼ˆäº†è§£ï¼‰
  - -Xintï¼šè§£é‡Šæ‰§è¡Œ
  - -Xcompï¼šç¬¬ä¸€æ¬¡ä½¿ç”¨å°±ç¼–è¯‘æˆæœ¬åœ°ä»£ç 
  - -Xmixedï¼šæ··åˆæ¨¡å¼
- **XXå‚æ•°ï¼ˆé‡ç‚¹ï¼‰**
  - Booleanç±»å‹
    - å…¬å¼ï¼š`-XX:+ æˆ–è€…-æŸä¸ªå±æ€§`   `+` è¡¨ç¤ºå¼€å¯ï¼Œ`-`è¡¨ç¤ºå…³é—­
    - Caseï¼š`-XX:-PrintGCDetails`ï¼šè¡¨ç¤ºå…³é—­äº†GCè¯¦æƒ…è¾“å‡º
  - key-valueç±»å‹
    - å…¬å¼ï¼š`-XX:å±æ€§key=å±æ€§value`
    - ä¸æ»¡æ„åˆå§‹å€¼ï¼Œå¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤è°ƒæ•´
    - caseï¼šå¦‚ä½•ï¼š`-XX:MetaspaceSize=21807104`ï¼šæŸ¥çœ‹Javaå…ƒç©ºé—´çš„å€¼

## æŸ¥çœ‹è¿è¡Œçš„Javaç¨‹åºï¼ŒJVMå‚æ•°æ˜¯å¦å¼€å¯ï¼Œå…·ä½“å€¼ä¸ºå¤šå°‘ï¼Ÿ

é¦–å…ˆæˆ‘ä»¬è¿è¡Œä¸€ä¸ªHelloGCçš„javaç¨‹åº

```java
public class HelloGC {

    public static void main(String[] args) throws InterruptedException {
        System.out.println("hello GC");
        Thread.sleep(Integer.MAX_VALUE);
    }
}
```

âš ï¸ ç„¶åä½¿ç”¨ä¸‹åˆ—å‘½ä»¤æŸ¥çœ‹å®ƒçš„é»˜è®¤å‚æ•°

```java
jpsï¼šæŸ¥çœ‹javaçš„åå°è¿›ç¨‹
jinfoï¼šæŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„javaç¨‹åº
```

å…·ä½“ä½¿ç”¨ï¼š

```java
jps -l å¾—åˆ°è¿›ç¨‹å·
```

```java
12608 com.moxi.interview.study.GC.HelloGC
15200 sun.tools.jps.Jps
15296 org.jetbrains.idea.maven.server.RemoteMavenServer36
4528
12216 org.jetbrains.jps.cmdline.Launcher
9772 org.jetbrains.kotlin.daemon.KotlinCompileDaemon
```

æŸ¥çœ‹åˆ°HelloGCçš„è¿›ç¨‹å·ä¸ºï¼š12608

æˆ‘ä»¬ä½¿ç”¨jinfo -flag ç„¶åæŸ¥çœ‹æ˜¯å¦å¼€å¯PrintGCDetailsè¿™ä¸ªå‚æ•°

```java
jinfo -flag PrintGCDetails 12608
```

å¾—åˆ°çš„å†…å®¹ä¸º

```java
-XX:-PrintGCDetails
```

ä¸Šé¢æåˆ°äº†ï¼Œ-å·è¡¨ç¤ºå…³é—­ï¼Œå³æ²¡æœ‰å¼€å¯PrintGCDetailsè¿™ä¸ªå‚æ•°

ä¸‹é¢æˆ‘ä»¬éœ€è¦åœ¨å¯åŠ¨HelloGCçš„æ—¶å€™ï¼Œå¢åŠ  PrintGCDetailsè¿™ä¸ªå‚æ•°ï¼Œéœ€è¦åœ¨è¿è¡Œç¨‹åºçš„æ—¶å€™é…ç½®JVMå‚æ•°

![image-20200319122922264](/assets/imgs/image-20200319122922264.png)

ç„¶ååœ¨VM Optionsä¸­åŠ å…¥ä¸‹é¢çš„ä»£ç ï¼Œç°åœ¨+å·è¡¨ç¤ºå¼€å¯

```java
-XX:+PrintGCDetails
```

ç„¶ååœ¨ä½¿ç”¨jinfoæŸ¥çœ‹æˆ‘ä»¬çš„é…ç½®

```java
jps -l
jinfo -flag PrintGCDetails 13540
```

å¾—åˆ°çš„ç»“æœä¸º

```java
-XX:+PrintGCDetails
```

æˆ‘ä»¬çœ‹åˆ°åŸæ¥çš„-å·å˜æˆäº†+å·ï¼Œè¯´æ˜æˆ‘ä»¬é€šè¿‡ VM Optionsé…ç½®çš„JVMå‚æ•°å·²ç»ç”Ÿæ•ˆäº†

***ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤ï¼Œä¼šæŠŠjvmçš„å…¨éƒ¨é»˜è®¤å‚æ•°è¾“å‡º***

```java
jinfo -flags ***
```



## é¢˜å¤–è¯ï¼ˆå‘é¢˜ï¼‰ğŸ¤”

ä¸¤ä¸ªç»å…¸å‚æ•°ï¼š-Xms  å’Œ -Xmxï¼Œè¿™ä¸¤ä¸ªå‚æ•° å¦‚ä½•è§£é‡Š

è¿™ä¸¤ä¸ªå‚æ•°ï¼Œè¿˜æ˜¯å±äºXXå‚æ•°ï¼Œå› ä¸ºå–äº†åˆ«å

- -Xms  ç­‰ä»·äº `-XX:InitialHeapSize`  ï¼šåˆå§‹åŒ–å †å†…å­˜ï¼ˆé»˜è®¤åªä¼šç”¨æœ€å¤§ç‰©ç†å†…å­˜çš„64åˆ†1ï¼‰
- -Xmx ç­‰ä»·äº` -XX:MaxHeapSize`    ï¼šæœ€å¤§å †å†…å­˜ï¼ˆé»˜è®¤åªä¼šç”¨æœ€å¤§ç‰©ç†å†…å­˜çš„4åˆ†1ï¼‰



## æŸ¥çœ‹JVMé»˜è®¤å‚æ•°

- -XX:+PrintFlags**Initial**

  - ä¸»è¦æ˜¯æŸ¥çœ‹**åˆå§‹é»˜è®¤å€¼**
  - å…¬å¼
    - `java -XX:+PrintFlagsInitial -version` é¢å¤–æ‰“å°ç‰ˆæœ¬å·
    - `java -XX:+PrintFlagsInitial`ï¼ˆé‡è¦å‚æ•°ï¼ŒæŸ¥çœ‹å‚æ•°ç›˜ç‚¹å®¶åº•ï¼‰

  ![image-20200320212256284](/assets/imgs/image-20200320212256284.png)

     

- -XX:+PrintFlags**Final**ï¼šä¸»è¦æŸ¥çœ‹ä¿®æ”¹æ›´æ–°

  - `java -XX:+PrintFlagsFinal -version`ä¼šå°†JVMçš„å„ä¸ªç»“æœéƒ½è¿›è¡Œæ‰“å°;å¦‚æœæœ‰ ` :=` è¡¨ç¤ºä¿®æ”¹è¿‡çš„ï¼Œ `=` è¡¨ç¤ºæ²¡æœ‰ä¿®æ”¹è¿‡çš„
  - `java -XX:+printFlagsFinal -Xss128k T(è¿è¡Œçš„javaç±»åå­—)`  **è¿è¡Œjavaå‘½ä»¤çš„åŒæ—¶æ‰“å°å‡ºå‚æ•°**



- +XX:+PrintCommandLineFlags æ‰“å°å‘½ä»¤è¡Œå‚æ•°ï¼Œå¯ä»¥æ–¹ä¾¿çš„æŸ¥çœ‹åƒåœ¾å›æ”¶å™¨

---

## å·¥ä½œä¸­å¸¸ç”¨çš„JVMåŸºæœ¬é…ç½®å‚æ•°

![image-20201214224049789](/assets/imgs/image-20201214224049789.png)

### æŸ¥çœ‹å †å†…å­˜

æŸ¥çœ‹JVMçš„åˆå§‹åŒ–å †å†…å­˜ -Xms å’Œæœ€å¤§å †å†…å­˜ Xmx ï¼ˆå¿…é¡»é…ç½®æˆä¸€æ ·ï¼‰

```java
public class HelloGC {

    public static void main(String[] args) throws InterruptedException {
        // è¿”å›Javaè™šæ‹Ÿæœºä¸­å†…å­˜çš„æ€»é‡
        long totalMemory = Runtime.getRuntime().totalMemory();

        // è¿”å›Javaè™šæ‹Ÿæœºä¸­è¯•å›¾ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡
        long maxMemory = Runtime.getRuntime().maxMemory();

        System.out.println("TOTAL_MEMORY(-Xms) = " + totalMemory + "(å­—èŠ‚)ã€" + (totalMemory / (double)1024 / 1024) + "MB");
        System.out.println("MAX_MEMORY(-Xmx) = " + maxMemory + "(å­—èŠ‚)ã€" + (maxMemory / (double)1024 / 1024) + "MB");

    }
}
```

è¿è¡Œç»“æœä¸ºï¼š

```java
TOTAL_MEMORY(-Xms) = 257425408(å­—èŠ‚)ã€245.5MB
MAX_MEMORY(-Xmx) = 3790077952(å­—èŠ‚)ã€3614.5MB
```

**<u>-Xms åˆå§‹å †å†…å­˜ä¸ºï¼šç‰©ç†å†…å­˜çš„1/64          -Xmx æœ€å¤§å †å†…å­˜ä¸ºï¼šç³»ç»Ÿç‰©ç†å†…å­˜çš„ 1/4</u>**



### æ‰“å°JVMé»˜è®¤å‚æ•°

ä½¿ç”¨ `-XX:+PrintCommandLineFlags` æ‰“å°å‡ºJVMçš„é»˜è®¤çš„ç®€å•åˆå§‹åŒ–å‚æ•°

æ¯”å¦‚æˆ‘çš„æœºå™¨è¾“å‡ºä¸ºï¼š

```java
-XX:InitialHeapSize=266376000 -XX:MaxHeapSize=4262016000 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC 
```

### å…¸å‹è®¾ç½®æ¡ˆä¾‹

```shell
-Xms128m -Xmx4096m -Xss1024K -XX:MetaspaceSize=512m -XX:+PrintCommandLineFlags -XX:+PrintGCDetails -XX:+UseSerialGC
```

 

### ç”Ÿæ´»å¸¸ç”¨è°ƒä¼˜å‚æ•° âš ï¸

- -Xmsï¼šåˆå§‹åŒ–å †å†…å­˜ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/64ï¼Œç­‰ä»·äº -XX:initialHeapSize

- -Xmxï¼šæœ€å¤§å †å†…å­˜ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/4ï¼Œç­‰ä»·äº-XX:MaxHeapSize

- -Xssï¼šè®¾è®¡å•ä¸ªçº¿ç¨‹æ ˆçš„å¤§å°ï¼Œä¸€èˆ¬é»˜è®¤ä¸º512K~1024Kï¼Œç­‰ä»·äº -XX:ThreadStackSize

  - ä½¿ç”¨ jinfo -flag ThreadStackSize   ä¼šå‘ç° -XX:ThreadStackSize = 0
  - è¿™ä¸ªå€¼çš„å¤§å°æ˜¯å–å†³äºå¹³å°çš„
  - **Linux/x64:1024KB**
  - OS Xï¼š1024KB
  - Oracle Solarisï¼š1024KB
  - Windowsï¼šå–å†³äºè™šæ‹Ÿå†…å­˜çš„å¤§å°

- -Xmnï¼šè®¾ç½®å¹´è½»ä»£å¤§å°ï¼ˆä¸€èˆ¬ä¸éœ€è¦è®¾ç½®ï¼‰

- -XX:MetaspaceSizeï¼šè®¾ç½®å…ƒç©ºé—´å¤§å°

  - **å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ï¼Œä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œå› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ã€‚**
  - `-Xms10m -Xmx10m -XX:MetaspaceSize=1024m  -XX:+PrintFlagsFinal`
  - **ä½†æ˜¯é»˜è®¤çš„å…ƒç©ºé—´å¤§å°ï¼šåªæœ‰20å¤šM**
  - **ä¸ºäº†é˜²æ­¢åœ¨é¢‘ç¹çš„å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œè®©å…ƒç©ºé—´å‡ºç°OOMï¼Œå› æ­¤å¯ä»¥æŠŠå…ƒç©ºé—´è®¾ç½®çš„å¤§ä¸€äº›**

  

#### -XX:PrintGCDetails

è¾“å‡ºè¯¦ç»†GCæ”¶é›†æ—¥å¿—ä¿¡æ¯

- GC
- Full GC

GCæ—¥å¿—æ”¶é›†æµç¨‹å›¾

![image-20200322185639902](/assets/imgs/image-20200322185639902.png)

æˆ‘ä»¬ä½¿ç”¨ä¸€æ®µä»£ç ï¼Œåˆ¶é€ å‡ºåƒåœ¾å›æ”¶çš„è¿‡ç¨‹

é¦–å…ˆæˆ‘ä»¬è®¾ç½®ä¸€ä¸‹ç¨‹åºçš„å¯åŠ¨é…ç½®:  è®¾ç½®åˆå§‹å †å†…å­˜ä¸º10Mï¼Œæœ€å¤§å †å†…å­˜ä¸º10M

```java
-Xms10m -Xmx10m -XX:+PrintGCDetails
```

ç„¶åç”¨ä¸‹åˆ—ä»£ç ï¼Œåˆ›å»ºä¸€ä¸ª éå¸¸å¤§ç©ºé—´çš„byteç±»å‹æ•°ç»„

```java
byte [] byteArray = new byte[50 * 1024 * 1024];
```

è¿è¡Œåï¼Œå‘ç°ä¼šå‡ºç°ä¸‹åˆ—é”™è¯¯ï¼Œè¿™å°±æ˜¯OOMï¼šjavaå†…å­˜æº¢å‡ºï¼Œä¹Ÿå°±æ˜¯å †ç©ºé—´ä¸è¶³

```java
Exception in thread "main" java.lang.OutOfMemoryError: Java heap space
	at com.moxi.interview.study.GC.HelloGC.main(HelloGC.java:22)
```

**åŒæ—¶è¿˜æ‰“å°å‡ºäº†GCåƒåœ¾å›æ”¶æ—¶å€™çš„è¯¦æƒ…**

```java
[GC (Allocation Failure) [PSYoungGen: 1972K->504K(2560K)] 1972K->740K(9728K), 0.0156109 secs] [Times: user=0.00 sys=0.00, real=0.03 secs] 
[GC (Allocation Failure) [PSYoungGen: 504K->480K(2560K)] 740K->772K(9728K), 0.0007815 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[Full GC (Allocation Failure) [PSYoungGen: 480K->0K(2560K)] [ParOldGen: 292K->648K(7168K)] 772K->648K(9728K), [Metaspace: 3467K->3467K(1056768K)], 0.0080505 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 0K->0K(2560K)] 648K->648K(9728K), 0.0003035 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[Full GC (Allocation Failure) [PSYoungGen: 0K->0K(2560K)] [ParOldGen: 648K->630K(7168K)] 648K->630K(9728K), [Metaspace: 3467K->3467K(1056768K)], 0.0058502 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
Heap
 PSYoungGen      total 2560K, used 80K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)
  eden space 2048K, 3% used [0x00000000ffd00000,0x00000000ffd143d8,0x00000000fff00000)
  from space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)
  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)
 ParOldGen       total 7168K, used 630K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)
  object space 7168K, 8% used [0x00000000ff600000,0x00000000ff69dbd0,0x00000000ffd00000)
 Metaspace       used 3510K, capacity 4500K, committed 4864K, reserved 1056768K
  class space    used 389K, capacity 392K, committed 512K, reserved 1048576K
```

é—®é¢˜å‘ç”Ÿçš„åŸå› ï¼š

å› ä¸ºä»¬é€šè¿‡ -Xms10m  å’Œ -Xmx10m åªç»™Javaå †æ ˆè®¾ç½®äº†10Mçš„ç©ºé—´ï¼Œä½†æ˜¯åˆ›å»ºäº†50Mçš„å¯¹è±¡ï¼Œå› æ­¤å°±ä¼šå‡ºç°ç©ºé—´ä¸è¶³ï¼Œè€Œå¯¼è‡´å‡ºé”™

åŒæ—¶åœ¨åƒåœ¾æ”¶é›†çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰ä¸¤ä¸ªå¯¹è±¡ï¼šGC å’Œ Full GC

##### GCåƒåœ¾æ”¶é›†

GCåœ¨æ–°ç”ŸåŒº

```java
[GC (Allocation Failure) [PSYoungGen: 1972K->504K(2560K)] 1972K->740K(9728K), 0.0156109 secs] [Times: user=0.00 sys=0.00, real=0.03 secs]
```

GC (Allocation Failure)ï¼šè¡¨ç¤ºåˆ†é…å¤±è´¥ï¼Œé‚£ä¹ˆå°±éœ€è¦è§¦å‘å¹´è½»ä»£ç©ºé—´ä¸­çš„å†…å®¹è¢«å›æ”¶

```java
[PSYoungGen: 1972K->504K(2560K)] 1972K->740K(9728K), 0.0156109 secs]
```

å‚æ•°å¯¹åº”çš„å›¾ä¸ºï¼š

![image-20200323124000865](/assets/imgs/image-20200323124000865.png)

##### Full GCåƒåœ¾å›æ”¶

Full GCå¤§éƒ¨åˆ†å‘ç”Ÿåœ¨å…»è€åŒº

```java
[Full GC (Allocation Failure) [PSYoungGen: 0K->0K(2560K)] [ParOldGen: 648K->630K(7168K)] 648K->630K(9728K), [Metaspace: 3467K->3467K(1056768K)], 0.0058502 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
```



![image-20200323125839653](/assets/imgs/image-20200323125839653.png)

è§„å¾‹ï¼š

```java
[åç§°ï¼š GCå‰å†…å­˜å ç”¨ -> GCåå†…å­˜å ç”¨ (è¯¥åŒºå†…å­˜æ€»å¤§å°)]
```

å½“æˆ‘ä»¬å‡ºç°äº†è€å¹´ä»£éƒ½æ‰›ä¸ä½çš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°OOMå¼‚å¸¸

#### -XX:SurvivorRatio

è°ƒèŠ‚æ–°ç”Ÿä»£ä¸­ eden å’Œ S0ã€S1çš„ç©ºé—´æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º -XX:SuriviorRatio=8ï¼ŒEden:S0:S1 = 8:1:1

åŠ å…¥è®¾ç½®æˆ -XX:SurvivorRatio=4ï¼Œåˆ™ä¸º Eden:S0:S1 = 4:1:1

SurvivorRatioå€¼å°±æ˜¯è®¾ç½®edenåŒºçš„æ¯”ä¾‹å å¤šå°‘ï¼ŒS0å’ŒS1ç›¸åŒ

Javaå †ä»GCçš„è§’åº¦è¿˜å¯ä»¥ç»†åˆ†ä¸ºï¼šæ–°ç”Ÿä»£ï¼ˆEdenåŒºï¼ŒFrom SurvivoråŒºåˆTo SurvivoråŒºï¼‰å’Œè€å¹´ä»£

![image-20200323130442088](/assets/imgs/image-20200323130442088.png)

- edenã€SurvivorFromå¤åˆ¶åˆ°SurvivorToï¼Œå¹´é¾„ + 1

é¦–å…ˆï¼Œå½“EdenåŒºæ»¡çš„æ—¶å€™ä¼šè§¦å‘ç¬¬ä¸€æ¬¡GCï¼ŒæŠŠè¿˜æ´»ç€çš„å¯¹è±¡æ‹·è´åˆ°SurvivorFromå»ï¼Œå½“EdenåŒºå†æ¬¡è§¦å‘GCçš„æ—¶å€™ä¼šæ‰«æEdenåŒºåˆFromåŒºåŸŸï¼Œå¯¹è¿™ä¸¤ä¸ªåŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œç»è¿‡è¿™æ¬¡å›æ”¶åè¿˜å­˜æ´»çš„å¯¹è±¡ï¼Œåˆ™ç›´æ¥å¤åˆ¶åˆ°ToåŒºåŸŸï¼ˆå¦‚æœå¯¹è±¡çš„å¹´é¾„å·²ç»åˆ°è¾¾è€å¹´çš„æ ‡å‡†ï¼Œåˆ™èµ‹å€¼åˆ°è€å¹´ä»£åŒºï¼‰ï¼Œé€šçŸ¥æŠŠè¿™äº›å¯¹è±¡çš„å¹´é¾„ + 1

- æ¸…ç©ºedenã€SurvivorFrom

ç„¶åï¼Œæ¸…ç©ºedenï¼ŒSurvivorFromä¸­çš„å¯¹è±¡ï¼Œä¹Ÿå³å¤åˆ¶ä¹‹åæœ‰äº¤æ¢ï¼Œè°ç©ºè°æ˜¯to

- SurvivorToå’ŒSurvivorFromäº’æ¢

æœ€åï¼ŒSurvivorToå’ŒSurvivorFromäº’æ¢ï¼ŒåŸSurvivorToæˆä¸ºä¸‹ä¸€æ¬¡GCæ—¶çš„SurvivorFromåŒºï¼Œéƒ¨åˆ†å¯¹è±¡ä¼šåœ¨Fromå’ŒToåŒºåŸŸä¸­å¤åˆ¶æ¥å¤åˆ¶å»ï¼Œå¦‚æ­¤äº¤æ¢15æ¬¡ï¼ˆç”±JVMå‚æ•°MaxTenuringThresholdå†³å®šï¼Œè¿™ä¸ªå‚æ•°é»˜è®¤ä¸º15ï¼‰ï¼Œæœ€ç»ˆå¦‚æœè¿˜æ˜¯å­˜æ´»ï¼Œå°±å­˜å…¥è€å¹´ä»£

![image-20200323150946414](/assets/imgs/image-20200323150946414.png)



#### -XX:NewRatioï¼ˆäº†è§£ï¼‰

**é…ç½®å¹´è½»ä»£new å’Œè€å¹´ä»£old åœ¨å †ç»“æ„çš„å æ¯”**

é»˜è®¤ï¼š -XX:NewRatio=2 æ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£2ï¼Œå¹´è½»ä»£å æ•´ä¸ªå †çš„1/3

å‡å¦‚-XX:NewRatio=4ï¼šæ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£å 4ï¼Œå¹´è½»ä»£å æ•´ä¸ªå †çš„1/5ï¼ŒNewRadioå€¼å°±æ˜¯è®¾ç½®è€å¹´ä»£çš„å æ¯”ï¼Œå‰©ä¸‹çš„1ä¸ªæ–°ç”Ÿä»£

æ–°ç”Ÿä»£ç‰¹åˆ«å°ï¼Œä¼šé€ æˆé¢‘ç¹çš„è¿›è¡ŒGCæ”¶é›†



#### -XX:MaxTenuringThreshold

**è®¾ç½®åƒåœ¾æœ€å¤§å¹´é¾„**ï¼ŒSurvivorToå’ŒSurvivorFromäº’æ¢ï¼ŒåŸSurvivorToæˆä¸ºä¸‹ä¸€æ¬¡GCæ—¶çš„SurvivorFromåŒºï¼Œéƒ¨åˆ†å¯¹è±¡ä¼šåœ¨Fromå’ŒToåŒºåŸŸä¸­å¤åˆ¶æ¥å¤åˆ¶å»ï¼Œå¦‚æ­¤äº¤æ¢15æ¬¡ï¼ˆç”±JVMå‚æ•°MaxTenuringThresholdå†³å®šï¼Œè¿™ä¸ªå‚æ•°é»˜è®¤ä¸º15ï¼‰ï¼Œæœ€ç»ˆå¦‚æœè¿˜æ˜¯å­˜æ´»ï¼Œå°±å­˜å…¥è€å¹´ä»£

è¿™é‡Œå°±æ˜¯è°ƒæ•´è¿™ä¸ªæ¬¡æ•°çš„ï¼Œé»˜è®¤æ˜¯15ï¼Œå¹¶ä¸”è®¾ç½®çš„å€¼ åœ¨ 0~15ä¹‹é—´

æŸ¥çœ‹é»˜è®¤è¿›å…¥è€å¹´ä»£å¹´é¾„ï¼š`jinfo -flag MaxTenuringThreshold 17344`

**-XX:MaxTenuringThreshold=0ï¼šè®¾ç½®åƒåœ¾æœ€å¤§å¹´é¾„ã€‚å¦‚æœè®¾ç½®ä¸º0çš„è¯ï¼Œåˆ™å¹´è½»å¯¹è±¡ä¸ç»è¿‡SurvivoråŒºï¼Œç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚å¯¹äºå¹´è€ä»£æ¯”è¾ƒå¤šçš„åº”ç”¨ï¼Œå¯ä»¥æé«˜æ•ˆç‡ã€‚**å¦‚æœå°†æ­¤å€¼è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼Œåˆ™å¹´è½»ä»£å¯¹è±¡ä¼šåœ¨SurvivoråŒºè¿›è¡Œå¤šæ¬¡å¤åˆ¶ï¼Œè¿™æ ·å¯ä»¥å¢åŠ å¯¹è±¡å†å¹´è½»ä»£çš„å­˜æ´»æ—¶é—´ï¼Œå¢åŠ åœ¨å¹´è½»ä»£å³è¢«å›æ”¶çš„æ¦‚å¿µ

---



# Javaå†…å­˜æº¢å‡ºOOM

## ç»å…¸é”™è¯¯

JVMä¸­å¸¸è§çš„ä¸¤ä¸ªé”™è¯¯

StackoverFlowError ï¼šæ ˆæº¢å‡º

OutofMemoryError: java heap spaceï¼šå †æº¢å‡º



é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹çš„é”™è¯¯

- java.lang.StackOverflowError
- java.lang.OutOfMemoryErrorï¼šjava heap space
- java.lang.OutOfMemoryErrorï¼šGC overhead limit exceeeded
- java.lang.OutOfMemoryErrorï¼šDirect buffer memory
- java.lang.OutOfMemoryErrorï¼šunable to create new native thread
- java.lang.OutOfMemoryErrorï¼šMetaspace

## æ¶æ„

OutOfMemoryErrorå’ŒStackOverflowErroræ˜¯å±äºErrorï¼Œä¸æ˜¯Exception

![image-20200324144802828](/assets/imgs/image-20200324144802828-8041888.png)

## StackoverFlowError 

å †æ ˆæº¢å‡ºï¼Œæˆ‘ä»¬æœ‰æœ€ç®€å•çš„ä¸€ä¸ªé€’å½’è°ƒç”¨ï¼Œå°±ä¼šé€ æˆå †æ ˆæº¢å‡ºï¼Œä¹Ÿå°±æ˜¯æ·±åº¦çš„æ–¹æ³•è°ƒç”¨

æ ˆä¸€èˆ¬æ˜¯512Kï¼Œä¸æ–­çš„æ·±åº¦è°ƒç”¨ï¼Œç›´åˆ°æ ˆè¢«æ’‘ç ´

```java
public class StackOverflowErrorDemo {

    public static void main(String[] args) {
        stackOverflowError();
    }
    /**
     * æ ˆä¸€èˆ¬æ˜¯512Kï¼Œä¸æ–­çš„æ·±åº¦è°ƒç”¨ï¼Œç›´åˆ°æ ˆè¢«æ’‘ç ´
     * Exception in thread "main" java.lang.StackOverflowError
     */
    private static void stackOverflowError() {
        stackOverflowError();
    }
}
```

è¿è¡Œç»“æœ

```java
Exception in thread "main" java.lang.StackOverflowError
	at com.moxi.interview.study.oom.StackOverflowErrorDemo.stackOverflowError(StackOverflowErrorDemo.java:17)
```



## OutOfMemoryError

### java heap space

åˆ›å»ºäº†å¾ˆå¤šå¯¹è±¡ï¼Œå¯¼è‡´å †ç©ºé—´ä¸å¤Ÿå­˜å‚¨

```java
/**
 * Javaå †å†…å­˜ä¸è¶³
 */
public class JavaHeapSpaceDemo {
    public static void main(String[] args) {

        // å †ç©ºé—´çš„å¤§å° -Xms10m -Xmx10m
        // åˆ›å»ºä¸€ä¸ª 80Mçš„å­—èŠ‚æ•°ç»„
        byte [] bytes = new byte[80 * 1024 * 1024];
    }
}
```

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª80Mçš„æ•°ç»„ï¼Œä¼šç›´æ¥å‡ºç°Java heap space

```java
Exception in thread "main" java.lang.OutOfMemoryError: Java heap space
```

### GC overhead limit exceeded

**GCå›æ”¶æ—¶é—´è¿‡é•¿æ—¶ä¼šæŠ›å‡ºOutOfMemoryErrorï¼Œè¿‡é•¿çš„å®šä¹‰æ˜¯ï¼Œè¶…è¿‡äº†98%çš„æ—¶é—´ç”¨æ¥åšGCï¼Œå¹¶ä¸”å›æ”¶äº†ä¸åˆ°2%çš„å †å†…å­˜**

è¿ç»­å¤šæ¬¡GCéƒ½åªå›æ”¶äº†ä¸åˆ°2%çš„æç«¯æƒ…å†µä¸‹ï¼Œæ‰ä¼šæŠ›å‡ºã€‚å‡è®¾ä¸æŠ›å‡ºGC overhead limit é”™è¯¯ä¼šé€ æˆä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ

**é‚£å°±æ˜¯GCæ¸…ç†çš„è¿™ç‚¹å†…å­˜å¾ˆå¿«ä¼šå†æ¬¡è¢«å¡«æ»¡ï¼Œè¿«ä½¿GCå†æ¬¡æ‰§è¡Œï¼Œè¿™æ ·å°±å½¢æˆäº†æ¶æ€§å¾ªç¯ï¼ŒCPUçš„ä½¿ç”¨ç‡ä¸€ç›´éƒ½æ˜¯100%ï¼Œè€ŒGCå´æ²¡æœ‰ä»»ä½•æˆæœã€‚**

![image-20200324150646260](/assets/imgs/image-20200324150646260-8041888.png)

ä»£ç æ¼”ç¤ºï¼š

ä¸ºäº†æ›´å¿«çš„è¾¾åˆ°æ•ˆæœï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è®¾ç½®JVMå¯åŠ¨å‚æ•°

```
-Xms10m -Xmx10m -XX:+PrintGCDetails -XX:MaxDirectMemorySize=5m
```

è¿™ä¸ªå¼‚å¸¸å‡ºç°çš„æ­¥éª¤å°±æ˜¯ï¼Œæˆ‘ä»¬ä¸æ–­çš„åƒlistä¸­æ’å…¥Stringå¯¹è±¡ï¼Œç›´åˆ°å¯åŠ¨GCå›æ”¶

```java
/**
 * GC å›æ”¶è¶…æ—¶
 * JVMå‚æ•°é…ç½®: -Xms10m -Xmx10m -XX:+PrintGCDetails -XX:MaxDirectMemorySize=5m
 */
public class GCOverheadLimitDemo {
    public static void main(String[] args) {
        int i = 0;
        List<String> list = new ArrayList<>();
        try {
            while(true) {
                list.add(String.valueOf(++i).intern());
            }
        } catch (Exception e) {
            System.out.println("***************i:" + i);
            e.printStackTrace();
            throw e;
        } finally {

        }

    }
}
```

è¿è¡Œç»“æœ

```java
[Full GC (Ergonomics) [PSYoungGen: 2047K->2047K(2560K)] [ParOldGen: 7106K->7106K(7168K)] 9154K->9154K(9728K), [Metaspace: 3504K->3504K(1056768K)], 0.0311093 secs] [Times: user=0.13 sys=0.00, real=0.03 secs] 
[Full GC (Ergonomics) [PSYoungGen: 2047K->0K(2560K)] [ParOldGen: 7136K->667K(7168K)] 9184K->667K(9728K), [Metaspace: 3540K->3540K(1056768K)], 0.0058093 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
Heap
 PSYoungGen      total 2560K, used 114K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)
  eden space 2048K, 5% used [0x00000000ffd00000,0x00000000ffd1c878,0x00000000fff00000)
  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)
  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)
 ParOldGen       total 7168K, used 667K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)
  object space 7168K, 9% used [0x00000000ff600000,0x00000000ff6a6ff8,0x00000000ffd00000)
 Metaspace       used 3605K, capacity 4540K, committed 4864K, reserved 1056768K
  class space    used 399K, capacity 428K, committed 512K, reserved 1048576K
  
 
Exception in thread "main" java.lang.OutOfMemoryError: GC overhead limit exceeded
	at java.lang.Integer.toString(Integer.java:403)
	at java.lang.String.valueOf(String.java:3099)
	at com.moxi.interview.study.oom.GCOverheadLimitDemo.main(GCOverheadLimitDemo.java:18)
```

æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ° å¤šæ¬¡Full GCï¼Œå¹¶æ²¡æœ‰æ¸…ç†å‡ºç©ºé—´ï¼Œåœ¨å¤šæ¬¡æ‰§è¡ŒGCæ“ä½œåï¼Œå°±æŠ›å‡ºå¼‚å¸¸ GC overhead limit



### Direct buffer memory

**Netty + NIOï¼šè¿™æ˜¯ç”±äºNIOå¼•èµ·çš„**

**å†™NIOç¨‹åºçš„æ—¶å€™ç»å¸¸ä¼šä½¿ç”¨ByteBufferæ¥è¯»å–æˆ–å†™å…¥æ•°æ®ï¼Œè¿™æ˜¯ä¸€ç§åŸºäºé€šé“(Channel) ä¸ ç¼“å†²åŒº(Buffer)çš„I/Oæ–¹å¼ï¼Œå®ƒå¯ä»¥ä½¿ç”¨Native å‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨Javaå †é‡Œé¢çš„DirectByteBufferå¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚è¿™æ ·èƒ½åœ¨ä¸€äº›åœºæ™¯ä¸­æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå› ä¸ºé¿å…äº†åœ¨Javaå †å’ŒNativeå †ä¸­æ¥å›å¤åˆ¶æ•°æ®ã€‚**

ByteBuffer.allocate(capability)ï¼šç¬¬ä¸€ç§æ–¹å¼æ˜¯åˆ†é…JVMå †å†…å­˜ï¼Œå±äºGCç®¡è¾–èŒƒå›´ï¼Œç”±äºéœ€è¦æ‹·è´æ‰€ä»¥é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢

ByteBuffer.allocteDirect(capability)ï¼š**ç¬¬äºŒç§æ–¹å¼æ˜¯åˆ†é…OSæœ¬åœ°å†…å­˜ï¼Œä¸å±äºGCç®¡è¾–èŒƒå›´ï¼Œç”±äºä¸éœ€è¦å†…å­˜çš„æ‹·è´ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å¯¹è¾ƒå¿«**

ä½†å¦‚æœä¸æ–­åˆ†é…æœ¬åœ°å†…å­˜ï¼Œå †å†…å­˜å¾ˆå°‘ä½¿ç”¨ï¼Œé‚£ä¹ˆJVMå°±ä¸éœ€è¦æ‰§è¡ŒGCï¼ŒDirectByteBufferå¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å€™æ€¼å†…å­˜å……è¶³ï¼Œä½†æœ¬åœ°å†…å­˜å¯èƒ½å·²ç»ä½¿ç”¨å…‰äº†ï¼Œå†æ¬¡å°è¯•åˆ†é…æœ¬åœ°å†…å­˜å°±ä¼šå‡ºç°OutOfMemoryErrorï¼Œé‚£ä¹ˆç¨‹åºå°±å¥”æºƒäº†ã€‚

**ä¸€å¥è¯è¯´ï¼šæœ¬åœ°å†…å­˜ä¸è¶³ï¼Œä½†æ˜¯å †å†…å­˜å……è¶³çš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜**

æˆ‘ä»¬ä½¿ç”¨ -XX:MaxDirectMemorySize=5m é…ç½®èƒ½ä½¿ç”¨çš„å †å¤–ç‰©ç†å†…å­˜ä¸º5M

```java
-Xms10m -Xmx10m -XX:+PrintGCDetails -XX:MaxDirectMemorySize=5m
```

ç„¶åæˆ‘ä»¬ç”³è¯·ä¸€ä¸ª6Mçš„ç©ºé—´

```java
// åªè®¾ç½®äº†5Mçš„ç‰©ç†å†…å­˜ä½¿ç”¨ï¼Œä½†æ˜¯å´åˆ†é… 6Mçš„ç©ºé—´
ByteBuffer bb = ByteBuffer.allocateDirect(6 * 1024 * 1024);
```

è¿™ä¸ªæ—¶å€™ï¼Œè¿è¡Œå°±ä¼šå‡ºç°é—®é¢˜äº†

```java
é…ç½®çš„maxDirectMemoryï¼š5.0MB
[GC (System.gc()) [PSYoungGen: 2030K->488K(2560K)] 2030K->796K(9728K), 0.0008326 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[Full GC (System.gc()) [PSYoungGen: 488K->0K(2560K)] [ParOldGen: 308K->712K(7168K)] 796K->712K(9728K), [Metaspace: 3512K->3512K(1056768K)], 0.0052052 secs] [Times: user=0.09 sys=0.00, real=0.00 secs] 
Exception in thread "main" java.lang.OutOfMemoryError: Direct buffer memory
	at java.nio.Bits.reserveMemory(Bits.java:693)
	at java.nio.DirectByteBuffer.<init>(DirectByteBuffer.java:123)
	at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:311)
	at com.moxi.interview.study.oom.DIrectBufferMemoryDemo.main(DIrectBufferMemoryDemo.java:19)
```



### unable to create new native thread

**ä¸èƒ½å¤Ÿåˆ›å»ºæ›´å¤šçš„æ–°çš„çº¿ç¨‹äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åˆ›å»ºçº¿ç¨‹çš„ä¸Šé™è¾¾åˆ°äº†**

åœ¨é«˜å¹¶å‘åœºæ™¯çš„æ—¶å€™ï¼Œä¼šåº”ç”¨åˆ°

é«˜å¹¶å‘è¯·æ±‚æœåŠ¡å™¨æ—¶ï¼Œç»å¸¸ä¼šå‡ºç°å¦‚ä¸‹å¼‚å¸¸`java.lang.OutOfMemoryError:unable to create new native thread`ï¼Œ**å‡†ç¡®è¯´è¯¥native threadå¼‚å¸¸ä¸å¯¹åº”çš„å¹³å°æœ‰å…³**

å¯¼è‡´åŸå› ï¼š

- **åº”ç”¨åˆ›å»ºäº†å¤ªå¤šçº¿ç¨‹ï¼Œä¸€ä¸ªåº”ç”¨è¿›ç¨‹åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¶…è¿‡ç³»ç»Ÿæ‰¿è½½æé™**
- æœåŠ¡å™¨å¹¶ä¸å…è®¸ä½ çš„åº”ç”¨ç¨‹åºåˆ›å»ºè¿™ä¹ˆå¤šçº¿ç¨‹ï¼Œlinuxç³»ç»Ÿé»˜è®¤è¿è¡Œå•ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºçš„çº¿ç¨‹ä¸º1024ä¸ªï¼Œå¦‚æœåº”ç”¨åˆ›å»ºè¶…è¿‡è¿™ä¸ªæ•°é‡ï¼Œå°±ä¼šæŠ¥ `java.lang.OutOfMemoryError:unable to create new native thread`

è§£å†³æ–¹æ³•ï¼š

1. æƒ³åŠæ³•é™ä½ä½ åº”ç”¨ç¨‹åºåˆ›å»ºçº¿ç¨‹çš„æ•°é‡ï¼Œåˆ†æåº”ç”¨æ˜¯å¦çœŸçš„éœ€è¦åˆ›å»ºè¿™ä¹ˆå¤šçº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œæ”¹ä»£ç å°†çº¿ç¨‹æ•°é™åˆ°æœ€ä½
2. å¯¹äºæœ‰çš„åº”ç”¨ï¼Œç¡®å®éœ€è¦åˆ›å»ºå¾ˆå¤šçº¿ç¨‹ï¼Œè¿œè¶…è¿‡linuxç³»ç»Ÿé»˜è®¤1024ä¸ªçº¿ç¨‹é™åˆ¶ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹linuxæœåŠ¡å™¨é…ç½®ï¼Œæ‰©å¤§linuxé»˜è®¤é™åˆ¶

```java
/**
 * æ— æ³•åˆ›å»ºæ›´å¤šçš„çº¿ç¨‹
 */
public class UnableCreateNewThreadDemo {
    public static void main(String[] args) {
        for (int i = 0; ; i++) {
            System.out.println("************** i = " + i);
            new Thread(() -> {
                try {
                    TimeUnit.SECONDS.sleep(Integer.MAX_VALUE);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }, String.valueOf(i)).start();
        }
    }
}
```

è¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šå‡ºç°ä¸‹åˆ—çš„é”™è¯¯ï¼Œçº¿ç¨‹æ•°å¤§æ¦‚åœ¨ 900å¤šä¸ª

```java
Exception in thread "main" java.lang.OutOfMemoryError: unable to cerate new native thread
```

å¦‚ä½•æŸ¥çœ‹çº¿ç¨‹æ•°

```java
ulimit -u
```

æœåŠ¡å™¨çº§åˆ«è°ƒå‚è°ƒä¼˜ï¼š

![image-20201216220615180](/assets/imgs/image-20201216220615180-1054603.png)

### Metaspace

**å…ƒç©ºé—´å†…å­˜ä¸è¶³ï¼ŒMatespaceå…ƒç©ºé—´åº”ç”¨çš„æ˜¯æœ¬åœ°å†…å­˜**

`-XX:MetaspaceSize` çš„åˆå§‹åŒ–å¤§å°ä¸º20M

#### å…ƒç©ºé—´æ˜¯ä»€ä¹ˆ

**å…ƒç©ºé—´å°±æ˜¯æˆ‘ä»¬çš„æ–¹æ³•åŒºï¼Œå­˜æ”¾çš„æ˜¯ç±»æ¨¡æ¿ï¼Œç±»ä¿¡æ¯ï¼Œå¸¸é‡æ± ç­‰**

**Metaspaceæ˜¯æ–¹æ³•åŒºHotSpotä¸­çš„å®ç°ï¼Œå®ƒä¸æŒä¹…ä»£æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šMetaspaceå¹¶ä¸åœ¨è™šæ‹Ÿå†…å­˜ä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œä¹Ÿå³åœ¨java8ä¸­ï¼Œclass metadataï¼ˆthe virtual machines internal presentation of Java classï¼‰ï¼Œè¢«å­˜å‚¨åœ¨å«åšMatespaceçš„native memory**

**æ°¸ä¹…ä»£ï¼ˆjava8åèƒŒå…ƒç©ºé—´Metaspaceå–ä»£äº†ï¼‰å­˜æ”¾äº†ä»¥ä¸‹ä¿¡æ¯ï¼š**

- **è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯**
- **å¸¸é‡æ± **
- **é™æ€å˜é‡**
- **å³æ—¶ç¼–è¯‘åçš„ä»£ç **

æ¨¡æ‹ŸMetaspaceç©ºé—´æº¢å‡ºï¼Œæˆ‘ä»¬ä¸æ–­ç”Ÿæˆç±» å¾€å…ƒç©ºé—´é‡ŒçŒè¾“ï¼Œç±»å æ®çš„ç©ºé—´æ€»ä¼šè¶…è¿‡MetaspaceæŒ‡å®šçš„ç©ºé—´å¤§å°

#### ä»£ç 

åœ¨æ¨¡æ‹Ÿå¼‚å¸¸ç”Ÿæˆæ—¶å€™ï¼Œå› ä¸ºåˆå§‹åŒ–çš„å…ƒç©ºé—´ä¸º20Mï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨JVMå‚æ•°è°ƒæ•´å…ƒç©ºé—´çš„å¤§å°ï¼Œä¸ºäº†æ›´å¥½çš„æ•ˆæœ

```java
-XX:MetaspaceSize=8m -XX:MaxMetaspaceSize=8m
```

ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * å…ƒç©ºé—´æº¢å‡º
 */
public class MetaspaceOutOfMemoryDemo {

    // é™æ€ç±»
    static class OOMTest {

    }

    public static void main(final String[] args) {
        // æ¨¡æ‹Ÿè®¡æ•°å¤šå°‘æ¬¡ä»¥åå‘ç”Ÿå¼‚å¸¸
        int i =0;
        try {
            while (true) {
                i++;
                // ä½¿ç”¨Springçš„åŠ¨æ€å­—èŠ‚ç æŠ€æœ¯
                Enhancer enhancer = new Enhancer();
                enhancer.setSuperclass(OOMTest.class);
                enhancer.setUseCache(false);
                enhancer.setCallback(new MethodInterceptor() {
                    @Override
                    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {
                        return methodProxy.invokeSuper(o, args);
                    }
                });
            }
        } catch (Exception e) {
            System.out.println("å‘ç”Ÿå¼‚å¸¸çš„æ¬¡æ•°:" + i);
            e.printStackTrace();
        } finally {

        }

    }
}
```

ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š

```java
å‘ç”Ÿå¼‚å¸¸çš„æ¬¡æ•°: 201
java.lang.OutOfMemoryError:Metaspace
```

---



# Linuxè¯Šæ–­åŸå› 

## å‘½ä»¤é›†åˆ

### æ•´æœºï¼štopï¼ŒæŸ¥çœ‹æ•´æœºç³»ç»Ÿæ€§èƒ½

![image-20200326162329550](/assets/imgs/image-20200326162329550.png)

ä½¿ç”¨topå‘½ä»¤çš„è¯ï¼Œé‡ç‚¹å…³æ³¨çš„æ˜¯ %CPUã€%MEM ã€load average ä¸‰ä¸ªæŒ‡æ ‡

åœ¨è¿™ä¸ªå‘½ä»¤ä¸‹ï¼ŒæŒ‰1çš„è¯ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªCPUçš„å ç”¨æƒ…å†µ

uptimeï¼šç³»ç»Ÿæ€§èƒ½å‘½ä»¤çš„ç²¾ç®€ç‰ˆ



### CPUï¼švmstat

- æŸ¥çœ‹CPUï¼ˆåŒ…å«ä½†æ˜¯ä¸é™äºï¼‰
- æŸ¥çœ‹é¢å¤–
  - æŸ¥çœ‹æ‰€æœ‰CPUæ ¸ä¿¡æ¯ï¼šmpstat -P ALL 2
  - æ¯ä¸ªè¿›ç¨‹ä½¿ç”¨CPUçš„ç”¨é‡åˆ†è§£ä¿¡æ¯ï¼špidstat -u 1 -p è¿›ç¨‹ç¼–å·



å‘½ä»¤æ ¼å¼ï¼š`vmstat -n 2 3`

![image-20200326162803165](/assets/imgs/image-20200326162803165.png)

ä¸€èˆ¬vmstatå·¥å…·çš„ä½¿ç”¨æ˜¯é€šè¿‡ä¸¤ä¸ªæ•°å­—å‚æ•°æ¥å®Œæˆçš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é‡‡æ ·çš„æ—¶é—´é—´éš”æ•°ï¼ˆå•ä½ç§’ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é‡‡æ ·çš„æ¬¡æ•°

**procs**

â€‹		rï¼š**è¿è¡Œå’Œç­‰å¾…çš„CPUæ—¶é—´ç‰‡çš„è¿›ç¨‹æ•°ï¼ŒåŸåˆ™ä¸Š1æ ¸çš„CPUçš„è¿è¡Œé˜Ÿåˆ—ä¸è¦è¶…è¿‡2ï¼Œæ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œé˜Ÿåˆ—ä¸è¶…è¿‡æ€»æ ¸æ•°çš„2å€ï¼Œå¦åˆ™ä»£è¡¨ç³»ç»Ÿå‹åŠ›è¿‡å¤§ï¼Œæˆ‘ä»¬çœ‹è˜‘è‡åšå®¢æµ‹è¯•æœåŠ¡å™¨ï¼Œèƒ½å‘ç°éƒ½è¶…è¿‡äº†2ï¼Œè¯´æ˜ç°åœ¨å‹åŠ›è¿‡å¤§**

â€‹		bï¼šç­‰å¾…èµ„æºçš„è¿›ç¨‹æ•°ï¼Œæ¯”å¦‚æ­£åœ¨ç­‰å¾…ç£ç›˜I/Oã€ç½‘ç»œI/Oç­‰

**cpu**

â€‹	usï¼šç”¨æˆ·è¿›ç¨‹æ¶ˆè€—CPUæ—¶é—´ç™¾åˆ†æ¯”ï¼Œuså€¼é«˜ï¼Œç”¨æˆ·è¿›ç¨‹æ¶ˆè€—CPUæ—¶é—´å¤šï¼Œå¦‚æœé•¿æœŸå¤§äº50%ï¼Œä¼˜åŒ–ç¨‹åº

â€‹	syï¼šå†…æ ¸è¿›ç¨‹æ¶ˆè€—çš„CPUæ—¶é—´ç™¾åˆ†æ¯”

![image-20200326164521263](/assets/imgs/image-20200326164521263.png)

â€‹	**us + sy å‚è€ƒå€¼ä¸º80%ï¼Œå¦‚æœus + sy å¤§äº80%ï¼Œè¯´æ˜å¯èƒ½å­˜åœ¨CPUä¸è¶³ï¼Œä»ä¸Šé¢çš„å›¾ç‰‡å¯ä»¥çœ‹å‡ºï¼Œus + syè¿˜æ²¡æœ‰è¶…è¿‡ç™¾åˆ†80ï¼Œå› æ­¤è¯´æ˜è˜‘è‡åšå®¢çš„CPUæ¶ˆè€—ä¸æ˜¯å¾ˆé«˜**

â€‹	idï¼šå¤„äºç©ºé—²çš„CPUç™¾åˆ†æ¯”

â€‹	waï¼šç³»ç»Ÿç­‰å¾…IOçš„CPUæ—¶é—´ç™¾åˆ†æ¯”

â€‹	stï¼šæ¥è‡ªäºä¸€ä¸ªè™šæ‹Ÿæœºå·å–çš„CPUæ—¶é—´æ¯”



### å†…å­˜ï¼šfree

- **åº”ç”¨ç¨‹åºå¯ç”¨å†…å­˜æ•°ï¼šfree -m**
  - æŸ¥çœ‹é¢å¤–ï¼š`pidstat -p è¿›ç¨‹å· -r é‡‡æ ·é—´éš”ç§’æ•°`
- åº”ç”¨ç¨‹åºå¯ç”¨å†…å­˜/ç³»ç»Ÿç‰©ç†å†…å­˜ > 70% å†…å­˜å……è¶³
- åº”ç”¨ç¨‹åºå¯ç”¨å†…å­˜/ç³»ç»Ÿç‰©ç†å†…å­˜ < 20% å†…å­˜ä¸è¶³ï¼Œéœ€è¦å¢åŠ å†…å­˜
- 20% <  åº”ç”¨ç¨‹åºå¯ç”¨å†…å­˜/ç³»ç»Ÿç‰©ç†å†…å­˜ < 70%ï¼Œè¡¨ç¤ºå†…å­˜åŸºæœ¬å¤Ÿç”¨



free -hï¼šä»¥äººç±»èƒ½çœ‹æ‡‚çš„æ–¹å¼æŸ¥çœ‹ç‰©ç†å†…å­˜

![image-20200326170217637](/assets/imgs/image-20200326170217637.png)

free -mï¼šä»¥MBä¸ºå•ä½ï¼ŒæŸ¥çœ‹ç‰©ç†å†…å­˜

![image-20200326165815071](/assets/imgs/image-20200326165815071.png)

free -gï¼šä»¥GBä¸ºå•ä½ï¼ŒæŸ¥çœ‹ç‰©ç†å†…å­˜





### ç¡¬ç›˜ï¼šdf

æ ¼å¼ï¼š`df -h  /`  (-hï¼šhumanï¼Œè¡¨ç¤ºä»¥äººç±»èƒ½çœ‹åˆ°çš„æ–¹å¼æ¢ç®—)

![image-20200326170318733](/assets/imgs/image-20200326170318733.png)

- ç¡¬ç›˜IOï¼šiostat

ç³»ç»Ÿæ…¢æœ‰ä¸¤ç§åŸå› å¼•èµ·çš„ï¼Œä¸€ä¸ªæ˜¯CPUé«˜ï¼Œä¸€ä¸ªæ˜¯å¤§é‡IOæ“ä½œ

æ€§èƒ½è¯„ä¼°ï¼Œæ ¼å¼ï¼š`iostat -xdk 2 3`

æŸ¥çœ‹é¢å¤–ï¼š`pidstat -d é‡‡æ ·é—´éš”ç§’æ•° -p è¿›ç¨‹å·`

![image-20200326170522559](/assets/imgs/image-20200326170522559.png)

ç£ç›˜å—è®¾å¤‡åˆ†å¸ƒï¼š

rkB /sï¼šæ¯ç§’è¯»å–æ•°æ®é‡kBï¼›

wkB/sï¼šæ¯ç§’å†™å…¥æ•°æ®é‡kBï¼›

svctm I/Oï¼šè¯·æ±‚çš„å¹³å‡æœåŠ¡æ—¶é—´ï¼Œå•ä½æ¯«ç§’

await I/Oï¼šè¯·æ±‚çš„å¹³å‡ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ¯«ç§’ï¼Œå€¼è¶Šå°ï¼Œæ€§èƒ½è¶Šå¥½

**utilï¼šä¸€ç§’é’Ÿæœ‰ç™¾åˆ†å‡ çš„æ—¶é—´ç”¨äºI/Oæ“ä½œã€‚æ¥è¿‘100%æ—¶ï¼Œè¡¨ç¤ºç£ç›˜å¸¦å®½è·‘æ»¡ï¼Œéœ€è¦ä¼˜åŒ–ç¨‹åºæˆ–è€…å¢åŠ ç£ç›˜ï¼›**

rkB/sï¼ŒwkB/sæ ¹æ®ç³»ç»Ÿåº”ç”¨ä¸åŒä¼šæœ‰ä¸åŒçš„å€¼ï¼Œä½†æœ‰è§„å¾‹éµå¾ªï¼šé•¿æœŸã€è¶…å¤§æ•°æ®è¯»å†™ï¼Œè‚¯å®šä¸æ­£å¸¸ï¼Œéœ€è¦ä¼˜åŒ–ç¨‹åºè¯»å–ã€‚

svctmçš„å€¼ä¸awaitçš„å€¼å¾ˆæ¥è¿‘ï¼Œè¡¨ç¤ºå‡ ä¹æ²¡æœ‰I/Oç­‰å¾…ï¼Œç£ç›˜æ€§èƒ½å¥½ï¼Œå¦‚æœawaitçš„å€¼è¿œé«˜äºsvctmçš„å€¼ï¼Œåˆ™è¡¨ç¤ºI/Oé˜Ÿåˆ—ç­‰å¾…å¤ªé•¿ï¼Œéœ€è¦ä¼˜åŒ–ç¨‹åºæˆ–æ›´æ¢æ›´å¿«ç£ç›˜



### ç½‘ç»œIOï¼šifstat

- é»˜è®¤æœ¬åœ°æ²¡æœ‰ï¼Œä¸‹è½½ifstat

![image-20200326171559406](/assets/imgs/image-20200326171559406.png)





## ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨å˜æ…¢ï¼Œè¯Šæ–­æ€è·¯å’Œæ€§èƒ½è¯„ä¼° â­ï¸

è®°ä¸€æ¬¡å°è±¡æ·±åˆ»çš„æ•…éšœï¼Ÿ

ç»“åˆLinux å’Œ JDKå‘½ä»¤ä¸€èµ·åˆ†æï¼Œæ­¥éª¤å¦‚ä¸‹

- ä½¿ç”¨topå‘½ä»¤æ‰¾å‡ºCPUå æ¯”æœ€é«˜çš„

- ps -ef æˆ–è€… jps è¿›ä¸€æ­¥å®šä½ï¼Œå¾—çŸ¥æ˜¯ä¸€ä¸ªæ€ä¹ˆæ ·çš„åå°ç¨‹åºå‡ºçš„é—®é¢˜

- å®šä½åˆ°å…·ä½“çº¿ç¨‹æˆ–è€…ä»£ç 

  - ps -mp è¿›ç¨‹  -o THREADï¼Œtidï¼Œtime
  - å‚æ•°è§£é‡Š
    - -mï¼šæ˜¾ç¤ºæ‰€æœ‰çš„çº¿ç¨‹
    - -pï¼špidè¿›ç¨‹ä½¿ç”¨CPUçš„æ—¶é—´
    - -oï¼šè¯¥å‚æ•°åæ˜¯ç”¨æˆ·è‡ªå®šä¹‰æ ¼å¼

  ![image-20200326173656164](/assets/imgs/image-20200326173656164.png)

- **å°†éœ€è¦çš„çº¿ç¨‹IDè½¬æ¢ä¸º16è¿›åˆ¶æ ¼å¼ï¼ˆè‹±æ–‡å°å†™æ ¼å¼ï¼‰**

  - printf â€œ%x\nâ€ æœ‰é—®é¢˜çš„çº¿ç¨‹ID

- jstack è¿›ç¨‹ID | grep tidï¼ˆ16è¿›åˆ¶çº¿ç¨‹IDå°å†™è‹±æ–‡ï¼‰ -A60

  ç²¾å‡†å®šä½åˆ°é”™è¯¯çš„åœ°æ–¹

![image-20200326174107444](/assets/imgs/image-20200326174107444.png)